<%
	lastName = (Request.Query.HasProperty("lastname") ? Trim(String(Request.Query.lastname)) : "" );
	userCode = (Request.Query.HasProperty("usercode") ? Trim(String(Request.Query.usercode)) : "" );
	orgCode = (Request.Query.HasProperty("organisation") ? String(Request.Query.organisation) : "" );
	mode = (Request.Query.HasProperty("m") ? String(Request.Query.m) : "");
	question = (Request.Query.HasProperty("question") ? String(Request.Query.question) : "");
	answer = (Request.Query.HasProperty("answer") ? Trim(StrLowerCase(String(Request.Query.answer))) : "");
	stepClient = (Request.Query.HasProperty("stepclient") ? String(Request.Query.stepclient) : "0");
	email = (Request.Query.HasProperty("email") ? Trim(String(Request.Query.email)) : "");

	function checkEmail(email, redirect) {
		var formatEmail = true;
		if (email != "") {
			arrEmail = String(email).split("@");
			alert(email);
			if (ArrayCount(arrEmail)<=1 || ArrayCount(arrEmail)>2) {
				formatEmail = false;
				alert('1');
			} else {
				fio = arrEmail[0];
				var count=0;
				for (var i=0; i<StrCharCount(fio); i++) {
					if (StrRangePos(fio, i, i+1)=="-") {
						if (!(StrRangePos(fio, 0, i) == "sp")) {
							formatEmail = false;
							alert('2');
							break;
						}
					}
					if (StrRangePos(fio, i, i+1)=="_") {
						count++;
						if (count>1) {
							formatEmail = false;
							alert('3');
							break;
						}
					}
				}
			}

			if (!(arrEmail[1]=="nlmk.com")) {
				formatEmail = false;
				alert('4');
			}

			return formatEmail;
		} else {
			if (redirect) {
				Request.Redirect("recovery_password.html?err=not_email&user="+userCode);
				Cancel();
			} else {
				return false;
			}
		}
	}
	
	function send_message(code, attach) {
		status = tools.create_notification(code, attach.DocID);
		Request.Redirect("recovery_password.html?m=email_send&s="+StrRangePos(doc.TopElem.email, 0, 4));
		Cancel();
	}


	//сброс на первую страницу
	if (mode=='reset') {
		Request.Redirect("recovery_password.html");
		Cancel();
	}

	//поиск сотрудника и проверка по количеству найденных
	if (lastName == "" || userCode== "" || orgCode == "") {
		Request.Redirect("recovery_password.html?err=not_data");
		Cancel();
	}

	users = XQuery("for $elem in collaborators where $elem/code='" + orgCode + "/" + userCode + "' return $elem");
	if (ArrayCount(users)>1) {
		Request.Redirect("recovery_password.html?err=many_users");
		Cancel();
	} else if (ArrayCount(users)==0) {
		Request.Redirect("recovery_password.html?err=not_user&user="+userCode);
		Cancel();
	} else {
		//сотрудник найден
		doc = OpenDoc(UrlFromDocID(ArrayFirstElem(users).id));

		//проверка уволен
		if (doc.TopElem.is_dismiss) {
			Request.Redirect("recovery_password.html?err=user_dismiss?user="+userCode+"&org="+orgCode);
			Cancel();
		}

		if (stepClient == "2") {
			if (String(doc.TopElem.custom_elems.ObtainChildByKey("secretQuestion").value).split(":")[0]==question) {
				if (doc.TopElem.custom_elems.ObtainChildByKey("secretAnswer").value==answer) {
					//проверка email на правильный формат
					if (!(checkEmail(doc.TopElem.email, false))) {
						Request.Redirect("recovery_password.html?step=3&user="+userCode+"&org="+orgCode+"&name="+lastName+"&q="+question);
						Cancel();
					} else {
						//отправка сообщения
						if (doc.TopElem.password != "" && !doc.TopElem.change_password && !doc.TopElem.last_data.web_banned) {
							send_message("9_1", doc);
						} else if (doc.TopElem.change_password) {
							send_message("9_2", doc);
						}
					}
				} else {
					Request.Redirect("recovery_password.html?err=bad_answer&user="+userCode);
					Cancel();
				}
			} else {
				Request.Redirect("recovery_password.html?err=bad_question&user="+userCode);
				Cancel();
			}
		}

		if (stepClient=="3") {
			if (!(checkEmail(email, true))) {
				Request.Redirect("recovery_password.html?err=email_bad&email="+email+"&user="+userCode);
				Cancel();
			} else {
				doc.TopElem.email = StrLowerCase(String(email));
				if (doc.TopElem.password=="" && doc.TopElem.change_password==false) {
					doc.TopElem.last_data.change_password = true;
				}
				doc.Save();
				if (doc.TopElem.password != "" && !doc.TopElem.change_password && !doc.TopElem.last_data.web_banned) {
					send_message("9_1", doc);
				} else if (doc.TopElem.change_password) {
					send_message("9_2", doc);
				}
			}
		}

		//проверка ФИО
		arr = String(lastName).split(" ");
		if (ArrayCount(arr)>1) {
			lastName = arr[0];
		}

		//сверка ФИО введенного со значением из БД
		if (StrLowerCase(String(lastName)) == StrLowerCase(String(doc.TopElem.lastname))) {
			if (doc.TopElem.custom_elems.ObtainChildByKey("secretQuestion").value != "" && doc.TopElem.custom_elems.ObtainChildByKey("secretAnswer").value != "") {
				//есть вопрос и ответ
				Request.Redirect("recovery_password.html?step=2&user="+userCode+"&org="+orgCode+"&name="+lastName);
				Cancel();
			} else {
				//нет вопроса и ответа
				Request.Redirect("recovery_password.html?m=not_answer&user="+userCode);
				Cancel();
			}
		} else {
			Request.Redirect("recovery_password.html?err=not_compare&user="+userCode);
			Cancel();
		}
	}
%>