<%
	Server.Execute( "include/user_init.html" );
	question = ( Request.Query.HasProperty( "question" ) ? UrlDecode( Request.Query.question ) : "" );
	answer = ( Request.Query.HasProperty( "answer" ) ? String( Request.Query.answer ) : "" );
	emailCorp = ( Request.Query.HasProperty( "email" ) ? Trim(String( Request.Query.email )) : "" );
	
	codeStruct = {};
	codeStruct["0"]="В каком году Вы окончили школу?";
	codeStruct["1"]="О какой профессии Вы мечтали в детстве?";
	codeStruct["2"]="Какое отчество Вашей матери?";
	codeStruct["3"]="Как имя Вашего лучшего друга детства?";
	codeStruct["4"]="Город, где Вы отдыхали в прошлый раз?";
	
	var errF = false;
	if (emailCorp != "") {
		if ((!StrEnds(emailCorp, "@nlmk.com", true) && !StrEnds(emailCorp, "@uvchm.ru", true)) || !StrContains(emailCorp, "_", true)) {
			errF = true;	
		}
		
		if (errF) {
			Request.Redirect( "secret_word.html?m=2" );
			Cancel();
		}
	}
	
	if (question != "" && answer !="") {
		doc = OpenDoc(UrlFromDocID(curUserID));
		doc.TopElem.custom_elems.ObtainChildByKey("secretQuestion").value = Trim(question) + ":" + codeStruct[question];
		doc.TopElem.custom_elems.ObtainChildByKey("secretAnswer").value = Trim(StrLowerCase(answer));
		if (doc.TopElem.email == "" && emailCorp != "") {
			doc.TopElem.email = StrLowerCase(emailCorp);
		}
		try{
			doc.Save();
			status = true;
		} catch(e) {
			status = false;
			alert("Невозможно обновить данные сотрудника: " + ExtractUserError(e));
		}
		st = '';
		if (status) {
			st = '?m=1'; 
		} 
		Request.Redirect( "secret_word.html"+st);
		Cancel();
		
	} else {
		Request.Redirect( "secret_word.html" );
		Cancel();
	}
%>