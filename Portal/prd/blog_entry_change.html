<%
Server.Execute( "include/sid_access_init.html" );

function HtmlReplace( _str )
{
	_str = StrReplace( _str, '\n', '<br/>' );

	for ( _smile in curLngCommon.forum_smile_types )
		_str = StrReplace( _str, _smile.id, "[img]" + _smile.url + "[/img]" );

	return tools_web.convert_xss( _str );
}

curBlogID = Int( Request.Form.blog_id );
_redirect_str = "view_doc.html?mode=blog&doc_id=" + curDocID + "&object_id=" + curBlogID;

switch ( Request.Form.action )
{
	case "save":
		if ( curObjectDoc == null )
		{
			Response.Redirect( _redirect_str );
			Cancel();
		}
		break;
		
	case "create":
		curObjectDoc = OpenNewDoc( 'x-local://wtv/wtv_blog_entry.xmd' );
		curObject = curObjectDoc.TopElem;
		curObject.person_id = curUserID;
		tools.common_filling( "collaborator", curObject, curUserID );

		tools.submit_subscriptions( curBlogID, null, curUserID );
		curObjectDoc.BindToDb( DefaultDb );
		break;
}

curObject.blog_id = curBlogID;
curObject.name = tools_web.convert_xss( Request.Form.name );
curObject.text_area = HtmlReplace( Request.Form.text_area );
curObject.labels = tools_web.convert_xss( Request.Form.labels );
curObject.allow_comment = Request.Form.HasProperty("allow_comment");

try
{
	tools_web.web_files_process( curObject );
}
catch ( e )
{
	alert( e );
}

curObjectDoc.Save();

Response.Redirect( _redirect_str );
%>