<%
Server.Execute( "include/sid_access_init.html" );

curBlogID = Int( Request.Form.blog_id );
redirect_str = "view_doc.html?mode=blog_entry_comment&doc_id=" + curDocID + "&object_id=" + curObjectID + "&blog_id=" + curBlogID;

try
{
	curBlogDoc = OpenDoc( UrlFromDocID( curBlogID ) ).TopElem;
}
catch(err)
{
	Response.Redirect( redirect_str );
	Cancel();
}

switch( Request.Form.action )
{
	case "create":
		commentDoc = OpenNewDoc( 'x-local://wtv/wtv_blog_entry_comment.xmd' );
		commentDoc.TopElem.blog_entry_id = curObjectID;
		commentDoc.TopElem.message = tools_web.convert_xss( Request.Form.comment_body );

		_type = curBlogDoc.allow_anonymous_comment ? Request.Form.type : 'fullname';
		if ( ! curBlogDoc.allow_anonymous_comment || _type == "fullname" )
		{
			commentDoc.TopElem.person_id = curUserID;
			commentDoc.TopElem.type = "fullname";
			tools.common_filling( 'collaborator', commentDoc.TopElem, curUserID );
		}
		else
		{
			commentDoc.TopElem.type = _type;
			if ( _type == "name" )
				commentDoc.TopElem.name = tools_web.convert_xss( Request.Form.name );
		}
		commentDoc.BindToDb( DefaultDb );
		commentDoc.Save();
		curObjectDoc.TopElem.comment_num++;
		curObjectDoc.Save();
		break;

	case "delete":
		DeleteDoc( UrlFromDocID( Int( Request.Form.comment_id ) ), true );
		
		curObjectDoc.TopElem.comment_num--;
		curObjectDoc.Save();
		break;	
}

Response.Redirect( redirect_str );
%>