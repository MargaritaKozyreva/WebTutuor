<%
	Server.Execute( "include/user_init.html" );
	
	//alert("!! START SAVING !!!");

	docPaResponse = OpenDoc( UrlFromDocID( Int(Request.Form.pa_id) ) )

	curAssessmentAppraiseID = docPaResponse.TopElem.assessment_appraise_id;
	curAssessmentAppraise = OpenDoc( UrlFromDocID( curAssessmentAppraiseID )).TopElem;
	
	/* ---=== IMPERSONATE BLOCK ===--- */	
	try
	{
		Session.ImpersonatePersonID = Int(Session.ImpersonatePersonID);
	}
	catch(_no_trace_)
	{
		Session.ImpersonatePersonID = null;
	}
	arrImpersonates = ArraySelect(curAssessmentAppraise.impersonate_persons, "impersonator_id == " + curUserID + " && face_person_id.HasValue && (from_date.HasValue == false || from_date <= DateNewTime(Date())) && (to_date.HasValue == false || to_date >= DateNewTime(Date()))");
	
	if (Session.ImpersonatePersonID != null && ArrayOptFind(arrImpersonates, "face_person_id == " + Session.ImpersonatePersonID) != undefined)
		_bIsFakePerson = true;
	else
		_bIsFakePerson = false;
	
	if (_bIsFakePerson)
	{
		curPersonID = Session.ImpersonatePersonID;
		curPerson = OpenDoc(UrlFromDocID(curPersonID)).TopElem;
		Session.ImpersonatePersonID = curPersonID;
	}
	else
	{
		curPersonID = curUserID;
		curPerson = curUser;
		Session.ImpersonatePersonID = null;
	}
	
	/* ---=== ================= ===--- */
	
		
	if (global_settings.settings.check_wf_access_assessment)
	{
		curPA = docPaResponse.TopElem;
		IS_HUMAN = !curPA.flag_appraise_department;
		
		_temp_assessment_plan = ArrayFirstElem(XQuery( 'for $assessment_plan in assessment_plans where $assessment_plan/assessment_appraise_id = ' + docPaResponse.TopElem.assessment_appraise_id +(IS_HUMAN ? ' and $assessment_plan/person_id = ' + curPA.person_id : ' and $assessment_plan/department_id = ' + curPA.department_id) + ' return $assessment_plan' ));
		
		if (curAssessmentAppraise.flag_use_plan)
		{
			curAssessmentPlanID = _temp_assessment_plan.id;
			curAssessmentPlan = OpenDoc( UrlFromDocID( curAssessmentPlanID ) ).TopElem;	
		}
		else
		{
			curAssessmentPlanID = docPaResponse.DocID;
			curAssessmentPlan = curPA;
		}
	
		Server.Execute( "view_assessment_access_variables.html" );
		
		if (IS_MODIFY == false)
		{
			Response.Redirect( "view_doc.html" );
			Cancel();
		}
	}
	
	
	
	_count = 0;
		
	
	try
	{
		_aat = curAssessmentAppraise.participants.GetChildByKey(docPaResponse.TopElem.status).assessment_appraise_types.GetChildByKey(Request.Form.assessment_appraise_type);
	
		_appraise_competence = _aat.flag_02;
		_total_formula = _aat.formula;
		_sub_formula = (Trim(_aat.sub_formula) != "" ? _aat.sub_formula : "TOTAL");
	}
	catch(_hui_)
	{
		_appraise_competence = "basic";
		_total_formula = "";
		_sub_formula = "TOTAL";
	}
			
	try
	{
		_count=Int(Request.Form.comp_count);
		isflawed = Request.Form.isflawed;
	}
	catch(_hren_)
	{
		isflawed = "1";
	}
	
	comment = ( Request.Form.HasProperty("comment") ? Request.Form.comment : '');
	
	
	if (Request.Form.HasProperty("workflow_fields_names") && Request.Form.GetProperty("workflow_fields_names") != "")
		workflow_fields_names = String(Request.Form.GetProperty("workflow_fields_names")).split(";");
	else
		workflow_fields_names = Array();
	
		
	for (i = 0; i< _count; i++)
	{
		try
		{
			comp_form = Request.Form.GetProperty("stform_" + i);
			comp_mark = Request.Form.GetProperty("stneedvalue_" + i);
			if (Request.Form.HasProperty("compcomment_" + i))
				compcomment = Request.Form.GetProperty("compcomment_" + i);
			else
				compcomment = "";
			
			if (comp_form == "1")
			{
				comp_id = Int(Request.Form.GetProperty("stid_" + i));
				_competence = docPaResponse.TopElem.competences.GetChildByKey(comp_id);
				try
				{
					teCompetence = OpenDoc(UrlFromDocID( comp_id ) ).TopElem;
				}
				catch(_vata_)
				{
					continue;
				}
				_competence.mark = comp_mark;
				_scale = teCompetence.scales.GetOptChildByKey(comp_mark);
				
				if (_scale != undefined)
				{
					_competence.mark_text = _scale.name;
					if (_scale.percent.HasValue)
						_competence.mark_value = _scale.percent.Value
					else
						_competence.mark_value = _scale.ChildIndex + 1;
				}
				else if (comp_mark == "N")
				{
					_competence.mark_value.Clear();
					_competence.mark_text = tools_web.get_web_str("ass_n_mark");
				}
				else
				{
					_competence.mark_value = OptReal(comp_mark, null);
					_competence.mark_text = _competence.mark_value;
				}
				
				_competence.comment = compcomment;
				
				if (ArrayCount(workflow_fields_names) > 0 && _appraise_competence != "comp_by_ind" && _appraise_competence != "blind_by_ind")
				{
					for (_wf_name in workflow_fields_names)
					{
						if (Request.Form.HasProperty("name_extra_" + _wf_name + "$competence_" + i) && Request.Form.HasProperty("value_extra_" + _wf_name + "$competence_" + i))
						{
													
							_this_wf_info = Request.Form.GetProperty("name_extra_" + _wf_name + "$competence_" + i);
																	
							_this_wf_info_open = String(_this_wf_info).split("$$$$");
							if (String(_this_wf_info_open[0]) != "")
							{
								_cur_wf = _competence.workflow_fields.ObtainChildByKey(_this_wf_info_open[0]);
								_cur_wf.field_group_id = _this_wf_info_open[1];
								_cur_wf.type = _this_wf_info_open[2];
								_cur_wf.title = _this_wf_info_open[3];
								_cur_wf.value = Request.Form.GetProperty("value_extra_" + _wf_name + "$competence_" + i);
							}
						}
					}
				}
				
			}
					
			
			if (comp_form == "0")
			{	
				comp_id = Int(Request.Form.GetProperty("stparentid_" + i));
				_competence = docPaResponse.TopElem.competences.GetChildByKey(comp_id);
				ind_id = Int(Request.Form.GetProperty("stid_" + i));
				_indicator = _competence.indicators.GetChildByKey(ind_id);
				
				try
				{
					teIndicator = OpenDoc(UrlFromDocID( ind_id ) ).TopElem;
				}
				catch(_vata_)
				{
					continue;
				}
				
				_scale = teIndicator.scales.GetOptChildByKey(comp_mark);
				
				if (_scale != undefined)
				{
					_indicator.mark = comp_mark;
					_indicator.mark_text = _scale.name;
					if (_scale.percent.HasValue)
						_indicator.mark_value = _scale.percent.Value
					else
						_indicator.mark_value = _scale.ChildIndex + 1;
				}
				else if (comp_mark == "N")
				{
					_indicator.mark = "N";
					_indicator.mark_value.Clear();
					_indicator.mark_text = tools_web.get_web_str("ass_n_mark");
				}
				else
				{
					_indicator.mark.Clear();
					_indicator.mark_value.Clear();
					_indicator.mark_text.Clear();
				}
				
				_indicator.comment = compcomment;
				
				if (ArrayCount(workflow_fields_names) > 0)
				{
					for (_wf_name in workflow_fields_names)
					if (Request.Form.HasProperty("name_extra_" + _wf_name + "$indicator_" + i) && Request.Form.HasProperty("value_extra_" + _wf_name + "$indicator_" + i))
					{
						_this_wf_info = Request.Form.GetProperty("name_extra_" + _wf_name + "$indicator_" + i);
						
						_this_wf_info_open = String(_this_wf_info).split("$$$$");
						if (String(_this_wf_info_open[0]) != "")
						{
							_cur_wf = _indicator.workflow_fields.ObtainChildByKey(_this_wf_info_open[0]);
							_cur_wf.field_group_id = _this_wf_info_open[1];
							_cur_wf.type = _this_wf_info_open[2];
							_cur_wf.title = _this_wf_info_open[3];
							_cur_wf.value = Request.Form.GetProperty("value_extra_" + _wf_name + "$indicator_" + i);
						}
					}
				}
			}
			
		}
		catch(_zhopa_)
		{
			//alert(_zhopa_)
			continue;
		}
	}	
	
	
	function pass_total_formula(SOURCE, EVAL_COLLECTION, FORMULA, EVAL_DEST)
	{
		TOTAL = 0.0;
		SUM = 0.0;
		COUNT = 0;
		MIN = null;
		MAX = null;
		NA_COUNT = 0;
	
		for (_obj in SOURCE.EvalPath(EVAL_COLLECTION))
		{
			if (_obj.mark == 'N')
			{
				NA_COUNT++;
				continue;
			}
			
			_cur_markk = _obj.mark_value;
			if (_obj.mark_value.HasValue)
				SUM += _cur_markk;
			
			if (_cur_markk != null)
			{
				COUNT++;
				TOTAL = TOTAL + _cur_markk * (OptReal(_obj.weight.Value, 0) / 100.0);
				if (MAX == null || MAX < _cur_markk) MAX = _cur_markk;
				if (MIN == null || MIN > _cur_markk) MIN = _cur_markk;
			}
		}
		
		_res = OptEval(FORMULA);
		//alert("TOTAL = " + TOTAL +	"\n SUM = " + SUM + "\n COUNT = " + COUNT + "\n	MIN = " + MIN + "\nMAX = " + MAX + "\nNA_COUNT = " + NA_COUNT);
		if (_res != undefined)
		for (sDestValField in String(EVAL_DEST).split(";"))
			SOURCE.EvalPath(sDestValField).Value = OptReal(StrReal(_res, 2),null);
	}
	
	if (_appraise_competence == "comp_by_ind" || _appraise_competence == "blind_by_ind")
	{
		for (_comp in docPaResponse.TopElem.competences)
			pass_total_formula(_comp, "indicators", _sub_formula, "mark;mark_value;mark_text");
	}
	
	if (_total_formula != '')
	{
		pass_total_formula(docPaResponse.TopElem, "competences", _total_formula, "overall");
	}
	else
	{
		docPaResponse.TopElem.overall.Clear();
	}
	
	
	if (isflawed =="1")
		docPaResponse.TopElem.is_done = false;
	else
		docPaResponse.TopElem.is_done = true;
	
	
	if (Request.Form.HasProperty("save_comment") && Request.Form.GetProperty("save_comment") == "1")
		docPaResponse.TopElem.comment = comment;
	else
		tools_ass.place_pa_comment( docPaResponse, curPersonID, undefined, comment);
	
	
	qcount = (Request.Form.HasProperty("stq_count") ?  Int(Request.Form.stq_count) : 0);
	for (j = 0; j<qcount; j++)
	{
		try
		{
			q_id = Int(Request.Form.GetProperty("stq_id_" + j));
			teQ = OpenDoc(UrlFromDocID(q_id)).TopElem;
		}
		catch(_zhopa_)
		{
			continue;
		}
		
		if (teQ.type == "3")
		{
			q_mark = "";
			for (_scale in teQ.scales)
				if (Request.Form.GetOptProperty("stq_mark_" + j + "_" + _scale.id, "") == "1")
					q_mark += (q_mark != "" ? ";" : "") + _scale.id;
		}		
		else
			q_mark = Request.Form.GetOptProperty("stq_mark_" + j, "");
		_questions = docPaResponse.TopElem.supplementary_questions.ObtainChildByKey(q_id);
		_questions.supplementary_question_mark = q_mark;
	}
		
		
	_href = 'view_doc.html?mode=assessment_appraise&doc_id=' + Request.Form.doc_id +'&pa_id='+Request.Form.pa_id + '&assessment_appraise_id=' + Request.Form.assessment_appraise_id + '&assessment_appraise_type=' + Request.Form.assessment_appraise_type  +'&f_id='  + Random(0,999999999);
	if (Request.Form.HasProperty("is_post") && Request.Form.GetProperty("is_post") == "1")
	_href = _href + '&is_post=1';
	
	if (Request.Form.HasProperty("custom_post_web_template_id"))
	try
	{
		tools_web.insert_custom_code(Int(Request.Form.GetProperty("custom_post_web_template_id")), null,true,true);
	}
	catch(_oi_)
	{}
	
	docPaResponse.TopElem.flag_is_processed = true;
	docPaResponse.TopElem.appraise_date = Date();
	docPaResponse.Save();
			
	Response.Redirect( _href );
%>