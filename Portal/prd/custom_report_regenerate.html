<%
	Server.Execute( "include/user_init.html" );
	if (Request.Form.GetOptProperty("regenerate") == "1")
	{
		docReportResponse = OpenDoc( UrlFromDocID( Int(Request.Form.object_id) ) );
		tools.fill_field_names(docReportResponse.TopElem.field_names, docReportResponse.TopElem.object_name);
		_N = 0;
		
		_criterions = ArraySelect(docReportResponse.TopElem.criterions, "flag_is_parameter && flag_value_filter == false && flag_active == true");
		iCriterionsCount = ArrayCount(_criterions);
		while (Request.Form.HasProperty("report_parameter_" + _N) && _N < iCriterionsCount)
		{
			_fld_name = Request.Form.GetOptProperty("report_parameter_" + _N, "field_undefined");
			_fld_value = Request.Form.GetOptProperty(_fld_name + "_" + _N);
			_fld_name = _fld_name.slice(6,(0-1));
			_criterion = _criterions[_N];
			if (ArrayFind(_criterion.catalog_chains, "This.field.Value == " + CodeLiteral(_fld_name)) != undefined)
				_criterion.value = _fld_value;
			_N++;
		}
		docReportResponse.TopElem.initiator_person_id = curUserID;
		
		if (docReportResponse.TopElem.integrated_criterion_field.HasValue)
		{
			switch (docReportResponse.TopElem.connect_2_object)
			{
				case "collaborator":
					docReportResponse.TopElem.integrated_criterion_value = curUserID;
					break;
				case "position":
					docReportResponse.TopElem.integrated_criterion_value = curUser.position_id;
					break;
				case "subdivision":
					docReportResponse.TopElem.integrated_criterion_value = curUser.position_parent_id;
					break;
				case "org":
					docReportResponse.TopElem.integrated_criterion_value = curUser.org_id;
					break;
				default:
					docReportResponse.TopElem.integrated_criterion_value.Clear();
					break;
			}
		}
		
		docReportResponse.Save();
		tools.build_report_remote(Request.Form.object_id);
		
		//docReportResponse = OpenDoc( UrlFromDocID( Int(Request.Form.object_id) ) );		
		//docReportResponse.Save();
	
	}		
	_href = "view_doc.html?mode=" + Request.Form.mode + "&doc_id=" + Request.Form.doc_id +"&object_id="+Request.Form.object_id;
	
	if (Request.Form.HasProperty("tabpage"))
		_href = _href + "&tabpage=" + Request.Form.GetProperty("tabpage");
	_suffix = Request.Form.href_suffix;
	if (_suffix != "")
		_href = _href + "&" + _suffix;
	
	Response.Redirect( _href );
%>