<%
	Server.Execute( "include/user_init.html" );

	docPaResponse = OpenDoc( UrlFromDocID( Int(Request.Form.pa_id) ) );

	if (global_settings.settings.check_wf_access_assessment)
	{
		curAssessmentAppraiseID = docPaResponse.TopElem.assessment_appraise_id;
		curAssessmentAppraise = OpenDoc( UrlFromDocID( curAssessmentAppraiseID )).TopElem;
		
		/* ---=== IMPERSONATE BLOCK ===--- */	
		
		Session.ImpersonatePersonID = OptInt(Session.ImpersonatePersonID, null);
		arrImpersonates = ArraySelect(curAssessmentAppraise.impersonate_persons, "impersonator_id == " + curUserID + " && face_person_id.HasValue && (from_date.HasValue == false || from_date <= DateNewTime(Date())) && (to_date.HasValue == false || to_date >= DateNewTime(Date()))");
		
		if (Session.ImpersonatePersonID != null && ArrayOptFind(arrImpersonates, "face_person_id == " + Session.ImpersonatePersonID) != undefined)
			_bIsFakePerson = true;
		else
			_bIsFakePerson = false;
		
		if (_bIsFakePerson)
		{
			curPersonID = Session.ImpersonatePersonID;
			curPerson = OpenDoc(UrlFromDocID(curPersonID)).TopElem;
			Session.ImpersonatePersonID = curPersonID;
		}
		else
		{
			curPersonID = curUserID;
			curPerson = curUser;
			Session.ImpersonatePersonID = null;
		}
		
		/* ---=== ================= ===--- */
		
		curPA = docPaResponse.TopElem;
		IS_HUMAN = !curPA.flag_appraise_department;
		
		if (curAssessmentAppraise.flag_use_plan)
		{
			_temp_assessment_plan = ArrayFirstElem(XQuery( 'for $assessment_plan in assessment_plans where $assessment_plan/assessment_appraise_id = ' + docPaResponse.TopElem.assessment_appraise_id +(IS_HUMAN ? ' and $assessment_plan/person_id = ' + curPA.person_id : ' and $assessment_plan/department_id = ' + curPA.department_id) + ' return $assessment_plan' ));
			
			curAssessmentPlanID = _temp_assessment_plan.id;
			curAssessmentPlan = OpenDoc( UrlFromDocID( curAssessmentPlanID ) ).TopElem;	
		}
		else
		{
			curAssessmentPlanID = docPaResponse.DocID;
			curAssessmentPlan = curPA;
		}
	
		Server.Execute( "view_assessment_access_variables.html" );
		if (IS_MODIFY == false)
		{
			Response.Redirect( "view_doc.html" );
			Cancel();
		}
	}
	
	isflawed = Request.Form.isflawed;
	comment = ( Request.Form.HasProperty("comment") ? Request.Form.comment : "");
		
	
	function processSavedData(sIdPARAM)
	{
		if (sIdPARAM == null) return false;
		sIdPARAM = Trim(StrLowerCase(sIdPARAM));
		var sType = Request.Form.GetOptProperty("elemtype_" + sIdPARAM, null);
		var __iObjPrimaryKey = OptInt(sIdPARAM);
		if (sType != null && __iObjPrimaryKey != undefined)
		{
			sType = Trim(StrLowerCase(sType));
			var __fldSomeElem;
			if (sType == "competence")
				__fldSomeElem = docPaResponse.TopElem.competences.ObtainChildByKey(__iObjPrimaryKey);
			else if (sType == "indicator")
				__fldSomeElem = docPaResponse.TopElem.indicators.ObtainChildByKey(__iObjPrimaryKey);
			else
				__fldSomeElem = docPaResponse.TopElem.plaindevelopments.AddChild();
			
			if (__fldSomeElem.ChildExists("name"))
				__fldSomeElem.name = Request.Form.GetOptProperty("name_" + sIdPARAM, "");
			
			var __i, __iDevMethodID,__iAttrCount = OptInt(Request.Form.GetOptProperty("attrcount_" + sIdPARAM, 0));
			for (__i=0;__i<__iAttrCount;__i++)
			{
				__iDevMethodID = OptInt(Request.Form.GetOptProperty("attr_" + sIdPARAM + __i, null));
				if (__iDevMethodID != undefined)
					__fldSomeElem.development_methods.ObtainChildByKey(__iDevMethodID);
			}
			
			if (__fldSomeElem.ChildExists("education_methods"))
			{
				var __sEduMethID, __iEduMeth;
				for (__sEduMethID in String(Request.Form.GetOptProperty("edumethlist_" + sIdPARAM,"")).split(";"))
				{
					__iEduMeth = OptInt(__sEduMethID);
					if (__iEduMeth != undefined)
						__fldSomeElem.education_methods.ObtainChildByKey(__iEduMeth);
				}
			}
			
			var __fldAimChild, __iAimCounter = OptInt(Request.Form.GetOptProperty("aimcounter" + sIdPARAM,0),0);
			for (__i=0;__i<__iAimCounter;__i++)
			if (Request.Form.HasProperty("aim" +sIdPARAM+ "task" + __i))
			{
				__fldAimChild = __fldSomeElem.aims.AddChild();
				__fldAimChild.task = Request.Form.GetProperty("aim" +sIdPARAM+ "task" + __i);
				__fldAimChild.target_date = Request.Form.GetOptProperty("aim" +sIdPARAM+ "tdate" + __i, null);
				__fldAimChild.value = Request.Form.GetOptProperty("aim" +sIdPARAM+ "value" + __i, null);
				__fldAimChild.comment = Request.Form.GetOptProperty("aim" +sIdPARAM+ "comment" + __i, null);
			}
			
			__fldSomeElem.comment = Request.Form.GetOptProperty("desc_" + sIdPARAM, "")
			
			var __aWfInfo,__wfValue,__fldCurWF,__wfCount = OptInt(Request.Form.GetOptProperty("wf_field_count", 0));
			for (__i=0; __i<__wfCount;__i++)
			{
				__aWfInfo = String(Request.Form.GetOptProperty("wf_field_info_" + __i, "")).split("$$$$");
				if (ArrayCount(__aWfInfo) == 4)
				{
					__wfValue = Request.Form.GetOptProperty("value_extra_" + __aWfInfo[0] + "_" + sIdPARAM);
					if (__wfValue != undefined)
					{
						__fldCurWF = __fldSomeElem.workflow_fields.ObtainChildByKey(__aWfInfo[0]);
						__fldCurWF.field_group_id = __aWfInfo[1];
						__fldCurWF.type = __aWfInfo[2];
						__fldCurWF.title = UrlDecode(__aWfInfo[3]);
						__fldCurWF.value = __wfValue;
					}
				}
			}
			return true;
		}
		return false;
	}
	
	docPaResponse.TopElem.competences.Clear();
	docPaResponse.TopElem.indicators.Clear();
	docPaResponse.TopElem.plaindevelopments.Clear();
	
	for (sSomeID in ArrayUnion(String(Request.Form.GetOptProperty("competence_list","")).split(";"), String(Request.Form.GetOptProperty("indicator_list","")).split(";")))
		processSavedData(sSomeID);
	for (j = 0; j < OptInt(Request.Form.GetOptProperty("simple_elems_count",0),0); j++)
		processSavedData(j);
	
	
	
	if (isflawed =="1")
		docPaResponse.TopElem.is_done = false;
	else
		docPaResponse.TopElem.is_done = true;
	
	docPaResponse.TopElem.comment = comment;
	
	qcount = (Request.Form.HasProperty("stq_count") ?  Int(Request.Form.stq_count) : 0);
	for (j = 0; j<qcount; j++)
	{
		try
		{
			q_id = Int(Request.Form.GetProperty("stq_id_" + j));
			teQ = OpenDoc(UrlFromDocID(q_id)).TopElem;
		}
		catch(_zhopa_)
		{
			continue;
		}
		
		if (teQ.type == "3")
		{
			q_mark = "";
			for (_scale in teQ.scales)
				if (Request.Form.GetOptProperty("stq_mark_" + j + "_" + _scale.id, "") == "1")
					q_mark += (q_mark != "" ? ";" : "") + _scale.id;
		}		
		else
			q_mark = Request.Form.GetOptProperty("stq_mark_" + j, "");
		_questions = docPaResponse.TopElem.supplementary_questions.ObtainChildByKey(q_id);
		_questions.supplementary_question_mark = q_mark;
	}
	
	_href = 'view_doc.html?mode=assessment_appraise&doc_id=' + Request.Form.doc_id +'&pa_id='+Request.Form.pa_id + '&assessment_appraise_id=' + Request.Form.assessment_appraise_id + '&assessment_appraise_type=' + Request.Form.assessment_appraise_type +'&f_id=' + Random(0, 9999999);
	if (Request.Form.HasProperty("is_post") && Request.Form.GetProperty("is_post") == "1")
	_href = _href + '&is_post=1';
	
	if (Request.Form.HasProperty("custom_post_web_template_id"))
	try
	{
		tools_web.insert_custom_code(Int(Request.Form.GetProperty("custom_post_web_template_id")), null,true,true);
	}
	catch(_oi_)
	{}
		
	docPaResponse.TopElem.flag_is_processed = true;
	docPaResponse.TopElem.appraise_date = Date();
	docPaResponse.Save();
	
	Response.Redirect( _href );
%>