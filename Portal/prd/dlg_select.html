<%
Server.Execute( "include/access_init.html" );
Server.Execute( "include/head.html" );

_catalog_name = Request.QueryString.HasProperty( 'catalog_name' ) ? Request.QueryString.catalog_name : '';
filterArray = _catalog_name == '' ? Array() : ArraySelect( lists.view_conditions_schemes, "catalog=='" + _catalog_name + "'&&disp_web" );
%>
<!-- 
	--- В параметрах передается: --
	catalog_name - название каталога (параметр урла)
	view_type - тип отображения
	typein - выбирать элементы с помощью строки поиска
	xquery_qual - дополнительное условие относительно элемента
	title - заголовок
	element_id - идентификатор объекта
	can_be_empty - выбор может быть пустым  true/false
//	fields - поля из каталога для отображения (аргумент диалога)

	elemArray - массив ID объектов (аргумент диалога)
	elemNamesArray - массив DISP-NAME'ов объектов (аргумент диалога)
	selected_object_ids -  строка ID объектов (аргумент диалога)

	
	-- возвращается ---
	element_id - идентификатор объекта
	element_name - название объекта
	handle - true/false - успешность результата
	
	elemArray - массив ID объектов
	elemNamesArray - массив DISP-NAME'ов объектов
	selected_object_ids -  строка ID объектов
 -->

<script type="text/javascript" src="catalog_grid.js"></script>
<script type="text/javascript" src="scripts/browser.js"></script>
<script language="javascript">
//////////////////////////////////////////////////////////////////////////////
dialogArguments.catalog_name = dialogArguments.catalog_name ? dialogArguments.catalog_name : '';
dialogArguments.multi_select = dialogArguments.multi_select == true;
dialogArguments.view_type = dialogArguments.view_type ? dialogArguments.view_type : '';
dialogArguments.typein = dialogArguments.typein == true;
dialogArguments.can_be_empty = dialogArguments.can_be_empty == true;
dialogArguments.title = dialogArguments.title ? dialogArguments.title : '';
dialogArguments.xquery_qual = dialogArguments.xquery_qual ? dialogArguments.xquery_qual : '';
dialogArguments.element_id = dialogArguments.element_id ? dialogArguments.element_id : '';
dialogArguments.selected_object_ids = dialogArguments.selected_object_ids && dialogArguments.selected_object_ids != '' ? dialogArguments.selected_object_ids : null;
dialogArguments.display_object_ids = dialogArguments.display_object_ids && dialogArguments.display_object_ids != '' ? dialogArguments.display_object_ids : null;
dialogArguments.filter_id = dialogArguments.filter_id ? dialogArguments.filter_id : '';
dialogArguments.disp_filter = dialogArguments.disp_filter != false;
dialogArguments.show_all = dialogArguments.show_all == true;
dialogArguments.disp_progress = dialogArguments.disp_progress == true;
dialogArguments.disp_win = dialogArguments.disp_win == true;
dialogArguments.check_access = dialogArguments.check_access == true;
dialogArguments.overflow_num = dialogArguments.overflow_num && dialogArguments.overflow_num > 0 ? dialogArguments.overflow_num : 1000;

var arrayQueryString = document.location.href.slice( document.location.href.indexOf( '?' ) + 1 ).split( '&' );
for( var i=0; i<arrayQueryString.length; i++ )
{
	arrayField = arrayQueryString[ i ].split( '=' );
	if ( arrayField.length == 2 )
	{
		var fieldValue = arrayField[ 1 ];
		switch ( arrayField[ 0 ] )
		{
			case 'catalog_name':
				dialogArguments.catalog_name = fieldValue;
				break;
			case 'multi_select':
				dialogArguments.multi_select = fieldValue == '1';
				break;
			case 'view_type':
				dialogArguments.view_type = fieldValue;
				break;
			case 'typein':
				dialogArguments.typein = fieldValue == '1';
				break;
			case 'can_be_empty':
				dialogArguments.can_be_empty = fieldValue == '1';
				break;
			case 'title':
				dialogArguments.title = unescape( fieldValue );
				break;
			case 'xquery_qual':
				dialogArguments.xquery_qual = unescape( fieldValue );
				break;
			case 'element_id':
				dialogArguments.element_id = fieldValue;
				break;
			case 'selected_object_ids':
				dialogArguments.selected_object_ids = fieldValue;
				break;
			case 'filter_id':
				dialogArguments.filter_id = fieldValue;
				break;
			case 'disp_filter':
				dialogArguments.filter_id = fieldValue != '0';
				break;
			case 'show_all':
				dialogArguments.show_all = fieldValue == '1';
				break;
			case 'disp_progress':
				dialogArguments.disp_progress = fieldValue == '1';
				break;
			case 'disp_win':
				dialogArguments.disp_win = fieldValue == '1';
				break;
			case 'check_access':
				dialogArguments.check_access = fieldValue == '1';
				break;
			case 'overflow_num':
				dialogArguments.overflow_num = fieldValue == '' || fieldValue == '0' ? null : fieldValue;
				break;
		}
	}
}

var curObj = null;
var curObj2 = null;
var clientWidth = 0;
var clientHeight = 0;
var selectDivHeight = 160;
var selectDivHeightMin = 80;
var bodyElem = null;
var parentDiv = null;
//////////////////////////////////////////////////////////////

if ( dialogArguments.title != '' )
	document.title = dialogArguments.title;
else
	document.title = "<%=HtmlEncode(tools.get_web_str("c_select"))%>";
	
dialogArguments.disp_filter = ( dialogArguments.disp_filter ? ( <%=( curUser.access.access_role == 'admin' )%> || dialogArguments.catalog_name != 'collaborator' || dialogArguments.show_all ) : false );

function showSearchText()
{
	curObj.elemArray = new Array();
	curObj.searchText( document.getElementById('typein').value, document.getElementById('filter').value );
	setDivHeight();
}


function getElems()
{
	bodyElem = document.getElementById('body_id');
	parentDiv = document.getElementById('ms_div_1');
}

function setDivHeight(setSelectedHeight)
{
	var newSelectDivHeight = selectDivHeight + ( setSelectedHeight ? setSelectedHeight : 0 );
	var deltaHeight = dialogArguments.multi_select ? newSelectDivHeight + 100 : selectDivHeightMin;
	var styleHeight = bodyElem.clientHeight > deltaHeight ? bodyElem.clientHeight - deltaHeight : 1;
	if ( setSelectedHeight )
	{
		if ( ( setSelectedHeight < 0 && newSelectDivHeight > selectDivHeightMin ) || ( setSelectedHeight > 0 && styleHeight > selectDivHeightMin ) )
			selectDivHeight = newSelectDivHeight;
		else
			return;
			
		curObj2.setParentDivHeight( selectDivHeight );
	}
	else if ( bodyElem.clientWidth != clientWidth )
	{
		curObj.drowHeaderWidth();
		if ( dialogArguments.multi_select )
		{
			curObj2.drowHeaderWidth();
			curObj2.setParentDivHeight( selectDivHeight );
		}
		clientWidth = bodyElem.clientWidth;
	}

	parentDiv.style.height = styleHeight + 'px';
	curObj.setParentDivHeight( parentDiv.clientHeight );
	clientHeight = bodyElem.clientHeight;
}

function processChecked(_flag)
{
	if ( dialogArguments.multi_select )
	{
		dialogArguments.elemArray = curObj2.elemList;
		dialogArguments.elemNamesArray = curObj2.getNamesArrayFromElemList();
		dialogArguments.selected_object_ids = curObj2.getStrFromElemList();
	}
	else
	{
		dialogArguments.element_id = curObj.element_id;
		dialogArguments.element_name = curObj.element_name;
		dialogArguments.elemArray = curObj.elemArray;
		dialogArguments.elemNamesArray = curObj.elemNamesArray;
		dialogArguments.selected_object_ids = curObj.getStrFromElemArray();
	}

	dialogArguments.handle = _flag;
	window.parent.close(); 
}

function addItems()
{
	curObj2.obtainListArray(curObj.elemArray,curObj.elemNamesArray);
	curObj2.setParentDivHeight( selectDivHeight );
	curObj.deselectAllRows();
	checkOk();
}

function delItems()
{
	curObj2.removeSelectedRows();
	checkOk();
}

function delAllItems()
{
	curObj2.removeAllRows();
	checkOk();
}

function checkOk()
{
	if ( ! dialogArguments.can_be_empty )
		document.getElementById("ok").disabled = ( dialogArguments.multi_select ? curObj2.elemList == null || curObj2.elemList.length == 0 : curObj.element_id == '' );
}

function dblClick(_element_id)
{
	curObj.selectSingleRow(_element_id);
	processChecked(true);
}

function dblClickMulti(_element_id)
{
	curObj.setSelectSingleRow(_element_id);
	addItems();
}

function dblClickDel(_element_id)
{
	curObj2.removeRow(_element_id);
	checkOk();
}
</script>
</HEAD>
<BODY id="body_id" onResize="setDivHeight()" onLoad="getElems();setDivHeight()">

<TABLE CELLPADDING="0" CELLSPACING="3" BORDER="0" WIDTH="100%">
	<TR>
		<TD>

		<TABLE width="100%" border="0" cellspacing="0" cellpadding="0" class="activator">
			<TR valign="middle">
				<TD class="activator"><b><%=tools.get_web_str('vkpb_search')%>:</b></TD>
				<TD id="search_td" WIDTH="30%" class="activator">
					<INPUT TYPE="text" ID="typein" NAME="typein" CLASS="inputEdit"  onkeypress="if(event.keyCode==13) showSearchText();" TITLE="<%=XmlAttrEncode( tools.get_web_str('c_search_tip') )%>" STYLE="width:100%"/>
				</TD>
				<TD WIDTH="20" class="activator">
					<INPUT TYPE="button" ID="btnsrch" VALUE="<%=tools.get_web_str('c_search')%>" onClick="showSearchText()" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';">
				</TD>
				<TD id="filter_td" WIDTH="70%" class="activator">
					&nbsp;<b><%=tools.get_web_str('c_filter')%>:</b>
					<select id="filter" name="filter" onChange="showSearchText()">
						<option value=""></option>
<%
		for ( _scheme in filterArray )
		{
%>
						<option value="<%=_scheme.PrimaryKey%>"><%=_scheme.name%></option>
<%
		}
%>
					</select>
<SCRIPT language="JavaScript">
selcur=document.getElementById('filter');
selcur.selectedIndex==-1
for (var i=0;i<selcur.options.length;i++)
    if (selcur.options[i].value==dialogArguments.filter_id)
	{
        selcur.selectedIndex=i;
		break;
    }
</SCRIPT>
				</TD>
			</TR>
		</TABLE>

		</TD>
	</TR>
	<TR>
		<TD>
			<DIV id="ms_div_1" style="overflow:hidden;height:200px;vertical-align:top"></DIV>
		</TD>
	</TR>
	<TR id="selected_buttons" style="vertical-align:top;display:none;width:100%">
		<TD>
	
		<TABLE width="100%" border="0" cellspacing="0" cellpadding="0" style="table-layout: fixed">
			<TR>
				<TD width="100%">
					<nobr>
						<INPUT TYPE="button" VALUE="<%=tools.get_web_str('veb_add')%>" onClick="addItems();" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';"/>
						&nbsp;&nbsp;&nbsp;
						<INPUT TYPE="button" VALUE="<%=tools.get_web_str('c_select_all')%>" onClick="curObj.selectAllRows();" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';"/>
						<INPUT TYPE="button" VALUE="<%=tools.get_web_str('c_deselect_all')%>" onClick="curObj.deselectAllRows();" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';"/>
						&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
						<INPUT TYPE="button" VALUE="<%=XmlAttrEncode( tools.get_web_str('c_delete') )%>" onClick="delItems();" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';"/>
						&nbsp;
						<INPUT TYPE="button" VALUE="<%=tools.get_web_str('c_delete_all')%>" onClick="delAllItems();" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';"/>
					</nobr>
				</TD>
				<TD align="right" width="50">
					<nobr>
						<img src="pics/up.gif" onClick="setDivHeight(40);return false;" onDblClick="setDivHeight(60);return false;"/>&nbsp;
						<img src="pics/down.gif" onClick="setDivHeight(-40);return false;" onDblClick="setDivHeight(-60);return false;"/>
					</nobr>
				</TD>
			</TR>
		</TABLE>
		
		</TD>
	</TR>
	<TR id="selected_grid" style="display:none;width:100%;">
		<TD>
		
		<TABLE width="100%" border="0" cellspacing="0" cellpadding="0" style="table-layout: fixed">
			<TR>
				<TD width="100%">
					<DIV id="ms_div_2" style="overflow:hidden;height:100%;width:100%;vertical-align:top;border:solid 0px;"></DIV>
				</TD>
			</TR>
		</TABLE>
		
		</TD>
	</TR>
	<TR>
		<TD>		

		<table width="100%" border="0" cellspacing="0" cellpadding="0" class="activator">
			<tr>
				<TD ALIGN="CENTER" class="activator">
					<INPUT TYPE="button" ID="ok" VALUE="<%=XmlAttrEncode( tools.get_web_str('c_choose') )%>" onClick="processChecked(true);" CLASS="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';">
					<INPUT TYPE="button" ID="cancel" VALUE="<%=XmlAttrEncode( tools.get_web_str('c_cancel') )%>" onClick="processChecked(false);" CLASS="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';">
				</TD>
			</tr>
		</table>

		</TD>
	</TR>
</TABLE>

<script language="javascript">
<%
if ( _catalog_name == '' )
{
%>
//////////////////////////////////////////////////////
function addOption(oListbox, text, value, isSelected)
{
  var oOption = document.createElement("option");
  oOption.appendChild(document.createTextNode(text));
  oOption.setAttribute("value", value);

  if (isSelected) oOption.selected = true;

  oListbox.appendChild(oOption);
}

arrOptCatalog = new Array(<%=ArrayMerge( lists.view_conditions_schemes, 'CodeLiteral(catalog)', ',' )%>);
arrOptValue = new Array(<%=ArrayMerge( lists.view_conditions_schemes, 'CodeLiteral(id)', ',' )%>);
arrOptText = new Array(<%=ArrayMerge( lists.view_conditions_schemes, 'CodeLiteral(name)', ',' )%>);

selcur=document.getElementById('filter');
if (selcur)
	for ( var i=0; i<arrOptCatalog.length; i++ )
		if ( arrOptCatalog[i] == dialogArguments.catalog_name )
			addOption(selcur,arrOptText[i],arrOptValue[i],arrOptValue[i]==dialogArguments.filter_id);
<%
}
%>
//////////////////////////////////////////////////////
curObj = msGridObject('1',dialogArguments.catalog_name);
curObj.multi_select = dialogArguments.multi_select;
curObj.view_type = dialogArguments.view_type;
curObj.doc_id = "<%=( Request.Query.HasProperty( 'doc_id' ) ? Request.Query.doc_id : '' )%>";
curObj.number = "<%=( Request.Query.HasProperty( 'number' ) ? Request.Query.number : '' )%>";
curObj.disp_link = false;
curObj.disp_check_box = true;
curObj.can_be_empty = dialogArguments.can_be_empty;
curObj.xquery_qual = dialogArguments.xquery_qual;
curObj.show_all = dialogArguments.show_all;
curObj.disp_progress = dialogArguments.disp_progress;
curObj.disp_win = dialogArguments.disp_win;
curObj.check_access = dialogArguments.check_access;
curObj.overflow_num = dialogArguments.overflow_num;
curObj.filter_id = dialogArguments.filter_id;

if ( dialogArguments.display_object_ids != null )
	curObj.setElemListFromStr( dialogArguments.display_object_ids );


//////////////////////////////////////////////////////
if ( dialogArguments.multi_select )
{
	curObj2 = msGridObject('2',dialogArguments.catalog_name);
	curObj2.multi_select = true;
	curObj2.view_type = dialogArguments.view_type;
	curObj.doc_id = "<%=( Request.Query.HasProperty( 'doc_id' ) ? Request.Query.doc_id : '' )%>";
	curObj.number = "<%=( Request.Query.HasProperty( 'number' ) ? Request.Query.number : '' )%>";
	curObj2.disp_link = false;
	curObj2.disp_check_box = true;
	curObj2.rowDblClick = dblClickDel;
	curObj2.disp_progress = dialogArguments.disp_progress;
	curObj2.disp_win = dialogArguments.disp_win;

	if ( dialogArguments.selected_object_ids != null )
		curObj2.setElemListFromStr( dialogArguments.selected_object_ids );
	else if ( dialogArguments.elemArray )
		curObj2.elemList = dialogArguments.elemArray;
	else
		curObj2.elemList = new Array();

	document.getElementById('selected_grid').style.display = 'inline';
	document.getElementById('selected_buttons').style.display = 'inline';
		
	curObj2.loadData();
	curObj2.drowGrid();

	curObj.rowDblClick = dblClickMulti;
//debugger;
}
else
{
	curObj.afterSelectSingleRow = checkOk;
	curObj.rowDblClick = dblClick;
}

if ( ! dialogArguments.disp_filter )
{
	document.getElementById('filter_td').style.display = 'none';
	document.getElementById('search_td').style.width = '100%';
}

if ( ! dialogArguments.typein )
{
	curObj.loadData();
	curObj.drowGrid();
	
	if ( ! dialogArguments.multi_select && dialogArguments.element_id != '' )
		curObj.selectSingleRow( dialogArguments.element_id );
}

checkOk();
</script>

</BODY>
</HTML>