<%
Server.Execute( "include/access_init.html" );
/*alert('<====>');
for (a in Request.Query)
{
	alert(a+"="+Request.Query.GetProperty(a));

}
alert('<====>');*/




ChangeCommand =0
try
{
	ChangeCommand = Int(Request.Query.change_command)
}
catch(ex)
{	
}



if (ChangeCommand ==1)
{
	AllowRichTextEdit=false;
	AllowAnonymousMessage=true;
	
	try
	{
		AllowAnonymousMessage = Int(Request.Query.allow_anonymous_message)==1?true:false
	}
	catch(ex)
	{	
	}
	
	
	try
	{
		AllowRichTextEdit = Int(Request.Query.allow_rich_text_edit)==1?true:false
	}
	catch(ex)
	{	
	}
	
	RespValue=''
	
RespValue=RespValue+'<a id="ans_id"></a>
<table cellspacing="0" cellpadding="0" width="100%" border="0">
	<tr>
		<td class="CL_forum_answer_form_table">
		
		<h4 align=center>'+tools_web.get_web_str( 'vfb_title' )+'</h4>
		<table cellspacing=1 cellpadding=0 width="100%" border=0>
			<tr>
				<td class="CL_forum_form_row" align="right" width="30%"><b>'+tools_web.get_web_str('vfb_subject')+':</b></td>
				<td class="CL_forum_form_row"><input type="text" name="title" id="title_id" class="inputEdit" style="width: 300px" onkeypress="if ( window.event.keyCode == 13 ) return false;"></td>
			</tr>
			<tr>
				<td class="CL_forum_form_row" align="right"><b>'+tools_web.get_web_str('vfb_text')+':</b></td>
				<td class="CL_forum_form_row">'
				
				
				if (AllowRichTextEdit )
				{
					curTinymcePluginsType = 'bbcode';
					RespValue=RespValue+StrReplace(EvalCodePageUrl("view_tinymce.html" ),'<script type="text/javascript" src="scripts/rte/js/tiny_mce.js"></script>','');
				}
				RespValue=RespValue+'
								<textarea id="content_id" name="content" style="width:600px;height:200px" richtext="true"></textarea>
							</td>
						</tr>'
			
				if (!AllowRichTextEdit )
				{
				RespValue=RespValue+'
						<tr>
							<td class="CL_forum_answer_form_table">&nbsp;</td>
							<td class="CL_forum_answer_form_table">
								<input type="button" value=" B " class="inputButton" onmouseover="this.className=\'inputButtonOver\';" onmouseout="this.className=\'inputButton\';" onclick="vReplaceContentText(\'[b]{%s%}[/b]\')" style="font-weight: bold"/>
								<input type="button" value=" I " class="inputButton" onmouseover="this.className=\'inputButtonOver\';" onmouseout="this.className=\'inputButton\';" onclick="vReplaceContentText(\'[i]{%s%}[/i]\')" style="font-style: italic"/>
								<input type="button" value=" U " class="inputButton" onmouseover="this.className=\'inputButtonOver\';" onmouseout="this.className=\'inputButton\';" onclick="vReplaceContentText(\'[u]{%s%}[/u]\')" style="text-decoration: underline"/>
								<input type="button" value=" S " class="inputButton" onmouseover="this.className=\'inputButtonOver\';" onmouseout="this.className=\'inputButton\';" onclick="vReplaceContentText(\'[s]{%s%}[/s]\')" style="text-decoration: line-through"/>
								<input type="button" value=" IMG " class="inputButton" onmouseover="this.className=\'inputButtonOver\';" onmouseout="this.className=\'inputButton\';" onclick="var sLink = prompt(\'Picture url:\', \'\') + \'\'; if (sLink != \'\') vReplaceContentText(\'[img]\'+sLink+\'[/img]\');"/>
								<input type="button" value=" URL " class="inputButton" onmouseover="this.className=\'inputButtonOver\';" onmouseout="this.className=\'inputButton\';" onclick="var sLink = prompt(\'URL:\', \'\') + \'\'; if (sLink != \'\') vReplaceContentText(\'[url]\'+sLink+\'[/url]\');"/>
								<input type="button" value=" Size " class="inputButton" onmouseover="this.className=\'inputButtonOver\';" onmouseout="this.className=\'inputButton\';" onclick="var iSize = parseInt(prompt(\'Size:\', \'\')); if (isNaN(iSize) == false) { if(iSize > 99) iSize = 99; if (iSize <6) iSize = 6; vReplaceContentText(\'[size=\'+iSize+\']{%s%}[/size]\');}"/>
								<input type="button" value=" Color " class="inputButton" onmouseover="this.className=\'inputButtonOver\';" onmouseout="this.className=\'inputButton\';" onclick="var sColor = prompt(\'Color:\', \'\'); if (sColor) { vReplaceContentText(\'[color=\'+sColor+\']{%s%}[/color]\'); }"/>
							</td>
						</tr>'
			
				}	
			if (AllowAnonymousMessage )
			{
				RespValue=RespValue+'
					<tr>
						<td class="CL_forum_form_row" align="right">'+tools_web.get_web_str('vfb_how_show_name')+':</td>
						<td class="CL_forum_form_row">
							<select name="how2show" id="how2show">'
		
				for ( _info_type in curLngCommon.forum_person_info_types )
				{
					RespValue=RespValue+'							
								<option value="'+_info_type.id+'">'+_info_type.name+'</option>'
		
				}
				RespValue=RespValue+'
							</select>
						</td>
					</tr>'
		
			}
			else
			{
				RespValue=RespValue+'<input type="hidden" value="realname" name="how2show" id="how2show"/>'
			}
			RespValue=RespValue+'
			<tr>
				<td class="CL_forum_form_row" align="right">'+tools_web.get_web_str( 'vfb_image' )+':</td>
				<td class="CL_forum_form_row">
					<select name="icon" id="icon_id" onchange="showimage( this ); return false;" class="basic">'
		
					for ( _icon_type in curLngCommon.forum_icon_types )
					{ 
						RespValue=RespValue+'<option value="'+_icon_type.url+'">'+_icon_type.name+'</option>'
					}
					RespValue=RespValue+'</select>
					<img src="'+curLngCommon.forum_icon_types[0].url+'" id="icon" name="icons" width="13" height="11" border=0 hspace=15>
				</td>
			</tr>'
			
			if ( !AllowRichTextEdit )
			{
				RespValue=RespValue+'
					<tr>
						<td class=CL_forum_form_row valign=top align=right>'+tools_web.get_web_str('vfb_smile')+':</td>
						<td class=CL_forum_form_row>'
		
				for ( _smile in curLngCommon.forum_smile_types )
				{ 
		
							RespValue=RespValue+'<img style="CURSOR: pointer" onclick="setContent(getContent()+this.alt)" src="'+_smile.url+'" border="0" alt="'+_smile.id+'"/>'
				}	
					RespValue=RespValue+'</td>
					</tr>'
			}
			RespValue=RespValue+'
				</td>
			</tr>
			<tr>
				<td class=CL_forum_form_row>&nbsp;</td>
				<td class=CL_forum_form_row><input type="button" name="go" value="'+tools_web.get_web_str('vfb_submit2')+'" onclick="check_content();" class="inputButton" onmouseover="this.className=\'inputButtonOver\';" onmouseout="this.className=\'inputButton\';">
				&nbsp;<input type="button" name="Cancel" value="'+tools_web.get_web_str('c_cancel')+'" onclick=" deleteNewRow();" class="inputButton" onmouseover="this.className=\'inputButtonOver\';" onmouseout="this.className=\'inputButton\';"></td>
			</tr>
		</table>
		
		</td>
	</tr>
</table>'
	Response.Write(EncodeCharset(RespValue, 'utf-8' ));
}
else
{
	RemoveEntry =0
	try
	{
		RemoveEntry = Int(Request.Query.remove)
	}
	catch(ex)
	{	
	}
	
	curPage = Request.Form.HasProperty( 'cur_page' ) && Request.Form.cur_page != '' ? Int( Request.Form.cur_page ) : 1;
	viewType = Request.Form.HasProperty( 'view_type' ) ? Request.Form.view_type : '';
	
	
	if (RemoveEntry==1)
	{
		RemoveEntryId = null
		try
		{
			RemoveEntryId = Int(Request.Query.remove_entry_id)
		}
		catch(ex)
		{	
		}
		
		if (RemoveEntryId != null)
		{
							
			_document_comment_entrys = XQuery( 'for $elem in document_comment_entrys where $elem/parent_document_entry_id = ' + RemoveEntryId + ' return $elem' );
			delete_real = true				


			_cur_entry_doc = OpenDoc( UrlFromDocID( RemoveEntryId ) );
			
			if ( ArrayCount( _document_comment_entrys ) != 0 )
			{
				_cur_entry_doc.TopElem.deleted=true;
				_cur_entry_doc.Save();
				delete_real = false
			}
			
			if (delete_real)
			{	
				if ( _cur_entry_doc.document_comment_entry.parent_document_entry_id.HasValue )
				{
					while ( _cur_entry_doc.document_comment_entry.parent_document_entry_id.HasValue )
						_cur_entry_doc = OpenDoc( UrlFromDocID( _cur_entry_doc.document_comment_entry.parent_document_entry_id ) );
							
					_cur_entry_doc.document_comment_entry.child_num = _cur_entry_doc.document_comment_entry.child_num - 1;						
					_cur_entry_doc.Save();
				}
			
				DeleteDoc( UrlFromDocID( RemoveEntryId ) );
			}
	
		}
		
	}
	else
	{
		Server.Execute( "include/sid_access_init.html" );
		
		function HtmlReplace( _str )
		{
			_str = StrReplace( _str, '\n', '<br/>' );
		
			for ( _smile in curLngCommon.forum_smile_types )
				_str = StrReplace( _str, _smile.id, "[img]" + _smile.url + "[/img]" );
		
			return tools_web.convert_xss( _str );
		}
		
		try
		{
			_icon_id = ArrayFind( curLngCommon.forum_icon_types,"url=='"+ Request.Form.icon+"'").id;
		}
		catch ( e )
		{
			alert(e)
			_icon_id = 1;
		}
		
		DocumentID = Int( Request.Form.doc_id );
		try
		{
			teDocument = OpenDoc( UrlFromDocID( DocumentID ) ).TopElem;
			AllowAnonymousMessage=teDocument.attributes.allow_anonymous_message;
		}
		catch(_err_)
		{
			Response.Write("Document " + DocumentID + " is deleted or malfunction. Abort operation.");
			Cancel();
		}
		
		isNewTopic = false;
		
		
		if ( Request.Form.entry_id != "" )
		{
			docCommentEntry = OpenDoc( UrlFromDocID( Int( Request.Form.entry_id ) ) );
		
			// проверяем не была ли закрыта тема перед редактированием
			if ( docCommentEntry.TopElem.deleted.HasValue && docCommentEntry.TopElem.deleted == true ) 
			{
				Server.Execute( "view_access_panel.html" );
				Cancel();
			}
		}
		else
		{
			isNewTopic = true;
			docCommentEntry = OpenNewDoc( 'x-local://wtv/wtv_document_comment_entry.xmd' );
			docCommentEntry.BindToDb( DefaultDb );
			if ( Request.Form.HasProperty( 'parent_document_entry_id' ) && Request.Form.parent_document_entry_id != '' )
			{
				docParentCommentEntryID = Int( Request.Form.parent_document_entry_id );
				docCommentEntry.TopElem.parent_document_entry_id = docParentCommentEntryID;
		
				docParentCommentEntry = OpenDoc( UrlFromDocID( docParentCommentEntryID ) );
				docParentCommentEntry.TopElem.last_create_date = Date();
				docParentCommentEntry.Save();
			}
		}
		
	
		docCommentEntry.TopElem.portal_doc_id = DocumentID;
		docCommentEntry.TopElem.icon_id = _icon_id;
		docCommentEntry.TopElem.name = tools_web.convert_xss( Request.Form.title );
		
		
		// если топик не новый, то при редактировании не нужно перетирать информацию 
		// о создателе или способе отображения
		isEditAuthor = false;
		if ( docCommentEntry.TopElem.user_id.HasValue )
		{
			isEditAuthor = docCommentEntry.TopElem.user_id == curUserID;
		}
		else 
		{
			docCommentEntry.TopElem.user_id = curUserID;
			if ( AllowAnonymousMessage )
				docCommentEntry.TopElem.how2show = Request.Form.how2show;
		}
		
		if ( isEditAuthor ) 
		{
			docCommentEntry.TopElem.person_fullname = curUser.fullname;
			docCommentEntry.TopElem.how2show = Request.Form.how2show;
		}
		
		docCommentEntry.TopElem.text_area = HtmlReplace( Request.Form.content );
		docCommentEntry.TopElem.last_create_date = Date();
				
		docCommentEntry.Save();
		
		
		tools.update_document_comment_entry( docCommentEntry );			
		
	}
	Response.Redirect( 'view_doc.html?mode=document_comment_entry&object_id=' + Request.Form.doc_id + '&doc_id=' + Request.Form.doc_id + '&cur_page=' + curPage + '&view_type=' + viewType );
}

%>