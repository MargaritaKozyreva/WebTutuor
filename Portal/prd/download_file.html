<%
Response.WriteMode = 'single';
docFile = OpenDoc( UrlFromDocID( Int( Request.Query.file_id ) ) );

if(!docFile.TopElem.allow_download)
{
	Server.Execute( "view_access_panel.html" );
	Cancel();
}

if(!docFile.TopElem.allow_unauthorized_download)
	Server.Execute( "include/user_init.html" );

if ( docFile.TopElem.type != 'img' && !docFile.TopElem.allow_unauthorized_download)
{
	try
	{
		curSid = Request.Query.HasProperty("sid") ? Request.Query.sid : "";
	
		if ( ! tools.check_sum_sid( Request.Query.file_id, curSid ) )
			throw '_crack_fuck_';

		if ( ! tools_web.check_access( docFile.TopElem, curUserID, curUser, Session ) )
			throw '_access_fuck_';
	}
	catch ( err )
	{
		Server.Execute( "view_access_panel.html" );
		Cancel();
	}
}

docFile.TopElem.save_data();
if ( docFile.IsChanged )
	docFile.Save();

if ( docFile.TopElem.file_url == '' )
	Cancel();
	
//	data = new Binary;
//	data.LoadFromUrl( docFile.TopElem.file_url );
//	Response.ContentType = "application/binary";
//	Response.WriteBinary( data );

switch ( StrLowerCase( UrlPathSuffix( docFile.TopElem.file_name ) ) )
{
	case '.js':
		Response.ContentType = "application/javascript";
		break;
	case '.ogx':
	case '.ogg':
		Response.ContentType = "application/ogg";
		break;
	case '.pdf':
		Response.ContentType = "application/pdf";
		break;
	case '.xhtml':
	case '.xht':
		Response.ContentType = "application/xhtml+xml";
		break;
	case '.json':
		Response.ContentType = "application/json";
		break;
	case '.zip':
	case '.zipx':
		Response.ContentType = "application/zip";
		break;

	case '.mp3':
		Response.ContentType = "audio/mpeg";
		break;
	case '.oga':
	case '.spx':
		Response.ContentType = "audio/ogg";
		break;
	case '.wma':
		Response.ContentType = "audio/x-ms-wma";
		break;
	case '.ra':
	case '.ram':
		Response.ContentType = "audio/vnd.rn-realaudio";
		break;
	case '.wav':
	case '.wv':
		Response.ContentType = "audio/vnd.wave";
		break;

	case '.gif':
		Response.ContentType = "image/gif";
		break;
	case '.jpg':
	case '.jpeg':
	case '.jpe':
	case '.jif':
	case '.jfif':
	case '.jfi':
		Response.ContentType = "image/jpeg";
		break;
	case '.png':
		Response.ContentType = "image/png";
		break;
	case '.svg':
	case '.svgz':
		Response.ContentType = "image/svg+xml";
		break;
	case '.tiff':
	case '.tif':
		Response.ContentType = "image/tiff";
		break;
	case '.ico':
		Response.ContentType = "image/vnd.microsoft.icon";
		break;

	case '.css':
		Response.ContentType = "text/css";
		break;
	case '.csv':
		Response.ContentType = "text/csv";
		break;
	case '.html':
	case '.htm':
		Response.ContentType = "text/html";
		break;
	case '.txt':
	case '.log':
		Response.ContentType = "text/plain";
		break;
	case '.xml':
		Response.ContentType = "text/xml";
		break;

	case '.mpg':
	case '.mpeg':
	case '.mp1':
	case '.mp2':
	case '.m1v':
	case '.m1a':
	case '.m2a':
	case '.mpa':
	case '.mpv':
		Response.ContentType = "video/mpeg";
		break;
	case '.ogv':
		Response.ContentType = "video/ogg";
		break;
	case '.mov':
	case '.qt':
		Response.ContentType = "video/quicktime";
		break;
	case '.wmv':
		Response.ContentType = "video/x-ms-wmv";
		break;

	case 'odt':
		Response.ContentType = "application/vnd.oasis.opendocument.text";
		break;
	case '.ods':
		Response.ContentType = "application/vnd.oasis.opendocument.spreadsheet";
		break;
	case '.odp':
		Response.ContentType = "application/vnd.oasis.opendocument.presentation";
		break;
	case '.odg':
		Response.ContentType = "application/vnd.oasis.opendocument.graphics";
		break;
	case '.xls':
		Response.ContentType = "application/vnd.ms-excel";
		break;
	case '.ppt':
	case '.pptx':
	case '.pps':
	case '.ppsx':
		Response.ContentType = "application/vnd.ms-powerpoint";
		break;
	case '.doc':
	case '.docx':
		Response.ContentType = "application/msword";
		break;

	case '.swf':
	case '.flv':
	case '.f4v':
		Response.ContentType = "application/x-shockwave-flash";
		break;
	case '.rar':
	case '.rev':
		Response.ContentType = "application/x-rar-compressed";
		break;
	case '.tar':
		Response.ContentType = "application/x-tar";
		break;
}

if ( docFile.TopElem.type != 'img' && docFile.TopElem.type != 'swf' )
	Response.AddHeader( "Content-Disposition", "attachment; filename=" + docFile.TopElem.file_name );

if ( tools.sys_db_type == 'xml' )
{
    Response.HandleStaticFile( docFile.TopElem.file_url );
}
else
{
    Response.Write( LoadUrlData( docFile.TopElem.file_url ) );
}
%>