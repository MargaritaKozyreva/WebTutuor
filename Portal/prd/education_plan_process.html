<%
	Server.Execute( "include/user_init.html" )
	
	if (Request.Query.HasProperty("whattodo"))
		sWhatToDo = Request.Query.GetProperty("whattodo");
	else
		sWhatToDo = null;
	sJSONReturn = "";
	switch(sWhatToDo)
	{
		case "getfield":
			var iEduMethId = OptInt(Request.Form.GetOptProperty("object_id"));
			var sField = Request.Form.GetOptProperty("field", null);
			if (iEduMethId != undefined)
			{
				var catEduMethod = ArrayOptFirstElem(XQuery("for $elem in education_methods where $elem/id = " + iEduMethId + " return $elem"));
				if (catEduMethod != undefined && catEduMethod.ChildExists(sField))
					sJSONReturn = catEduMethod.Child(sField).Value;
			}
		break;
		case "activatecourse":
			try
			{
				var docEduPlan = OpenDoc(UrlFromDocID(Int(Request.Form.education_plan_id)));
				var fldProgramPartElem = docEduPlan.TopElem.programs.GetChildByKey(Int(Request.Form.program_id));
				var activeLearning=tools.activate_course_to_person(docEduPlan.TopElem.person_id, fldProgramPartElem.education_method_id.ForeignElem.course_id, null);
				try
				{
					fldProgramPartElem.active_learning_id =activeLearning.DocID;
				}
				catch(ex)
				{
					fldProgramPartElem.active_learning_id = activeLearning;
				}
			}
			catch(_X_)
			{
				alert(_X_);
				sJSONReturn = "Произошла ошибка";
			}
		break;
		case "save":
			var docEduPlan;
			try
			{
				docEduPlan = OpenDoc(UrlFromDocID(Int(Request.Form.education_plan_id)));
			}
			catch(_X_)
			{
				alert(_X_);
				docEduPlan = null;
				sJSONReturn = "Произошла ошибка";
			}
			if (docEduPlan != null)
			{
				var iProgramID,fldProgramChild,vProgramTempObj, ix = 0;
				var aProgramIdToSave = new Array();
				while (Request.Form.HasProperty("program_" + ix))
				{
					iProgramID = OptInt(Request.Form.GetProperty("program_" + ix));
					if (iProgramID != undefined)
					{
						fldProgramChild = docEduPlan.TopElem.programs.ObtainChildByKey(iProgramID);
						aProgramIdToSave[ArrayCount(aProgramIdToSave)] = iProgramID;
						if (Request.Form.HasProperty("p" + iProgramID + "_name"))
							fldProgramChild.name = UrlDecode(Request.Form.GetProperty("p" + iProgramID + "_name"));
						if (Request.Form.HasProperty("p" + iProgramID + "_type"))
						{
							vProgramTempObj = Request.Form.GetOptProperty("p" + iProgramID + "_type","null");
							if (common.exchange_object_types.GetOptChildByKey(vProgramTempObj) != undefined)
								fldProgramChild.type = vProgramTempObj;
						}
						if (Request.Form.HasProperty("p" + iProgramID + "_education_method_id"))
						{
							vProgramTempObj = OptInt(Request.Form.GetProperty("p" + iProgramID + "_education_method_id"));
							if (vProgramTempObj != undefined)
							{
								vProgramTempObj = ArrayOptFirstElem(XQuery("for $elem in education_methods where $elem/id = " + vProgramTempObj + " return $elem"));
								if (vProgramTempObj != undefined)
								{
									fldProgramChild.education_method_id = vProgramTempObj.PrimaryKey;
								}
							}
						}
						
						if (fldProgramChild.type.Value == "event" && Request.Form.HasProperty("p" + iProgramID + "_object_id"))
						{
							vProgramTempObj = OptInt(Request.Form.GetProperty("p" + iProgramID + "_object_id"));
							if (vProgramTempObj != undefined)
							{
								vProgramTempObj = ArrayOptFirstElem(XQuery("for $elem in events where $elem/id = " + vProgramTempObj + " return $elem"));
								if (vProgramTempObj != undefined)
								{
									fldProgramChild.object_id = vProgramTempObj.PrimaryKey;
									fldProgramChild.object_name = vProgramTempObj.name.Value;
								}
							}
						}
						if (Request.Form.HasProperty("p" + iProgramID + "_request_id"))
						{
							vProgramTempObj = OptInt(Request.Form.GetProperty("p" + iProgramID + "_request_id"));
							if (vProgramTempObj != undefined)
							{
								vProgramTempObj = ArrayOptFirstElem(XQuery("for $elem in requests where $elem/id = " + vProgramTempObj + " return $elem"));
								if (vProgramTempObj != undefined)
									fldProgramChild.request_id = vProgramTempObj.PrimaryKey;
								else
									fldProgramChild.request_id.Clear();
							}
						}
					}
					
					ix++;
				}
				
				docEduPlan.TopElem.programs.DeleteChilds("ArrayOptFind(aProgramIdToSave, 'This == ' + This.id.Value) == undefined");
				
				docEduPlan.Save();
			}
		break;
	}
	Response.Write(EncodeCharset(sJSONReturn,"utf-8"));
	Cancel();
%>