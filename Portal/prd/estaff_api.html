<%
	Response.WriteMode = 'single';
	
	curCommand = String( Request.Form.command ).toLowerCase();

	_response_text = new Binary;
	_response_text.AssignStr( '<?xml version="1.0" encoding="windows-1251"?>' );

//alert('COMMAND='+curCommand);
	switch ( curCommand )
	{
		case 'get_vac_orders':
//alert('get_vac_orders')	
			if ( ! global_settings.settings.recruitment.default_request_type_id.HasValue )
				throw 'default_request_type_id not found';
		
			_response_text.AppendStr( '<vac_orders>' );
			
			for ( _request in XQuery( "for $elem in requests where $elem/request_type_id = " + global_settings.settings.recruitment.default_request_type_id + " and $elem/status_id = 'close' return $elem" ) )
			{
				requestDoc = OpenDoc( UrlFromDocID( _request.id ) ).TopElem;

				_response_text.AppendStr( "<vac_order><eid>" + _request.id.XmlValue + "</eid>" );
				_response_text.AppendStr( "<code>" + requestDoc.code.XmlValue + "</code>" );
				
				_response_text.AppendStr( "<person_eid>" + requestDoc.person_id.XmlValue + "</person_eid>" );
				
				if ( requestDoc.type == 'position' )
				{
					_response_text.AppendStr( "<position_eid>" + requestDoc.object_id.XmlValue  + "</position_eid>" );
					if ( requestDoc.object_id.HasValue )
						try
						{
							positionDoc = OpenDoc( UrlFromDocID( requestDoc.object_id ) ).TopElem;
							_response_text.AppendStr( "<subdivision_eid>" + positionDoc.parent_object_id.XmlValue + "</subdivision_eid>" );
						}
						catch ( gg )
						{
							alert( gg );
						}
				}
				
				_response_text.AppendStr( "<date>" + requestDoc.create_date.XmlValue + "</date>" );
				_response_text.AppendStr( "<req_end_date>" + requestDoc.plan_close_date.XmlValue + "</req_end_date>" );
				_response_text.AppendStr( "<comment>" + requestDoc.comment.XmlValue + "</comment>" );
				
				_response_text.AppendStr( "<name>" + requestDoc.custom_elems.ObtainChildByKey('position_name').value + "</name>" );
				_response_text.AppendStr( "<min_salary>" + requestDoc.custom_elems.ObtainChildByKey('min_salary').value + "</min_salary>" );
				_response_text.AppendStr( "<max_salary>" + requestDoc.custom_elems.ObtainChildByKey('max_salary').value + "</max_salary></vac_order>" );
			}
			
			_response_text.AppendStr( '</vac_orders>' );
			break;
			
		case 'get_persons':
//alert('get_persons')
//alert(Request.Form.eids)			
			_response_text.AppendStr( '<persons>' );
			
			for ( _person in String( Request.Form.eids ).split( ";" ) )
			{
				personDoc = OpenDoc( UrlFromDocID( Int( _person ) ) ).TopElem;					

				_response_text.AppendStr( "<person><eid>" + _person + "</eid>" );
				_response_text.AppendStr( "<code>" + personDoc.code.XmlValue + "</code>" );
				_response_text.AppendStr( "<lastname>" + personDoc.lastname.XmlValue + "</lastname>" );
				_response_text.AppendStr( "<firstname>" + personDoc.firstname.XmlValue + "</firstname>" );
				_response_text.AppendStr( "<middlename>" + personDoc.middlename.XmlValue + "</middlename>" );
				_response_text.AppendStr( "<birth_date>" + personDoc.birth_date.XmlValue + "</birth_date>" );
				
				try
				{
					if ( personDoc.position_id.HasValue )
					{
						positionDoc = OpenDoc( UrlFromDocID( personDoc.position_id ) ).TopElem;
						_response_text.AppendStr( "<subdivision_eid>" + positionDoc.parent_object_id.XmlValue + "</subdivision_eid>" );
						_response_text.AppendStr( "<position_name>" + positionDoc.name.XmlValue  + "</position_name>" );
					}
				}
				catch ( dd )
				{
					alert( dd );
				}
				
				_response_text.AppendStr( "<phone>" + personDoc.phone.XmlValue + "</phone>" );
				_response_text.AppendStr( "<email>" + personDoc.email.XmlValue + "</email></person>" );
			}
			
			_response_text.AppendStr( '</persons>' );
			break;
			
		case 'get_positions':
//alert('get_positions')
//alert(Request.Form.eids)			
			_response_text.AppendStr( '<positions>' );
			
			for ( _position in String( Request.Form.eids ).split( ";" ) )
			{
				positionDoc = OpenDoc( UrlFromDocID( Int( _position ) ) ).TopElem;	
				if ( positionDoc.Name != 'position' )				
					continue;

				_response_text.AppendStr( "<position><eid>" + _position + "</eid>" );
				_response_text.AppendStr( "<code>" + positionDoc.code.XmlValue + "</code>" );
				_response_text.AppendStr( "<name>" + positionDoc.name.XmlValue + "</name></position>" );				
			}
			
			_response_text.AppendStr( '</positions>' );
			break;
			
		case 'get_subdivisions':
//alert('get_subdivisions')
//alert(Request.Form.eids)			
			_response_text.AppendStr( '<subdivisions>' );
			
			for ( _subdivision in String( Request.Form.eids ).split( ";" ) )
			{
				subdivisionDoc = OpenDoc( UrlFromDocID( Int( _subdivision ) ) ).TopElem;					

				_response_text.AppendStr( "<subdivision><eid>" + _subdivision + "</eid>" );
				_response_text.AppendStr( "<code>" + subdivisionDoc.code.XmlValue + "</code>" );
				_response_text.AppendStr( "<name>" + subdivisionDoc.name.XmlValue + "</name>" );
				_response_text.AppendStr( "<disp_name>" + subdivisionDoc.name.XmlValue + "</disp_name></subdivision>" );
			}
			
			_response_text.AppendStr( '</subdivisions>' );
			break;
			
		case 'get_all_assessments':
//alert('get_all_assessments')			
			_response_text.AppendStr( '<assessments>' );
			
			for ( _test in assessments )
			{
				_response_text.AppendStr( '<assessment><eid>0x' + StrHexInt( _test.id, 16 ) + '</eid>' );
				_response_text.AppendStr( '<code>' + _test.code.XmlValue + '</code>' );
				_response_text.AppendStr( '<name>' + _test.title.XmlValue + '</name></assessment>' );
			}
			
			_response_text.AppendStr( '</assessments>' );
			break;
			
		case 'register_collaborator':
//alert('register_collaborator')				
			curPerson = OpenDocFromStr( Request.Form.collaborator_data, 'form=x-local://wtv/wtv_form_portal_person.xmd;ignore-top-elem-name=1' ).TopElem;
			personArray = XQuery( "for $collaborator in collaborators where $collaborator/code = '" + curPerson.eid + "' return $collaborator" );
			
			firstElem = ArrayOptFirstElem( personArray );
			if ( firstElem != undefined )
			{
				docPerson = OpenDoc( UrlFromDocID( firstElem.id ) );
			}
			else
			{
				docPerson = OpenNewDoc( 'x-local://wtv/wtv_collaborator.xmd' );
				docPerson.BindToDb(DefaultDb);
			}
		
			docPerson.TopElem.AssignElem( curPerson );
			docPerson.TopElem.code = curPerson.eid;
			docPerson.TopElem.eid = curPerson.code;
			docPerson.TopElem.is_candidate = true;
			docPerson.Save();
			break;
			
		case 'activate_assessment':
//alert('activate_assessment')			
			curPersonCode = Request.Form.candidate_eid;
			curTestID = Int( Request.Form.assessment_eid );
//alert(curTestID)				
			curPersonID = ArrayFirstElem( XQuery( "for $collaborator in collaborators where $collaborator/code = '" + curPersonCode + "' return $collaborator" ) ).id;
			
			_res = tools.activate_test_to_person( curPersonID, curTestID );
			try
			{
				_test_id = _res.DocID;
				_test_code = _res.TopElem.code;
			}
			catch ( rty )					
			{
				_test_id = _res;
				_test_code = OpenDoc( UrlFromDocID( _test_id ) ).TopElem.code;
			}	
			
			_response_text.AppendStr( '<active_test_learning><eid>0x' + StrHexInt( _test_id, 16 ) + '</eid>' );	
			_response_text.AppendStr( '<code>' + _test_code + '</code><url>enter_by_test_code.html?code=' + _test_code + '</url></active_test_learning>' );	
			break;
			
		case 'get_active_test_learning':
//alert('get_active_test_learning')			
			curLearningID = Int( Request.Form.active_test_learning_eid );
//alert(curLearningID)			
			curLearningArray = XQuery( "for $learning in active_test_learnings where $learning/id = " + curLearningID + " return $learning" );
			if ( ArrayCount( curLearningArray ) == 0 )
				curLearningArray = XQuery( alert("for $learning in test_learnings where $learning/active_test_learning_id = " + curLearningID + " return $learning") );
			
			if ( ArrayCount( curLearningArray ) > 0 )
			{	
				docLearning = OpenDoc( UrlFromDocID( ArrayFirstElem( curLearningArray ).id ) );
			}
			else
			{
				_error = 801;
				throw UserError( 'Object already exists' );
			}
			
			_response_text.AppendStr( '<active_test_learning><eid>0x' + StrHexInt( docLearning.DocID, 16 ) + '</eid>' );	
			_response_text.AppendStr( '<code>' + docLearning.TopElem.code + '</code>' );	
			_response_text.AppendStr( '<score>' + docLearning.TopElem.score + '</score>' );	
			_response_text.AppendStr( '<state_id>' + docLearning.TopElem.state_id + '</state_id>' );	
			_response_text.AppendStr( '<start_usage_date>' + docLearning.TopElem.start_usage_date.XmlValue + '</start_usage_date>' );
			_response_text.AppendStr( '<last_usage_date>' + docLearning.TopElem.last_usage_date.XmlValue + '</last_usage_date></active_test_learning>' );	
			break;
			
			
		case 'get_all_assessments2':
			_response_text.AppendStr( '<assessments>' );

			_assessment_appraises = XQuery( "for $assessment_appraise in assessment_appraises where $assessment_appraise/is_model = false() and $assessment_appraise/web_display = true() and  $assessment_appraise/status = '0' order by $assessment_appraise/name return $assessment_appraise" ) ;
			
			for ( _aa in _assessment_appraises )
			{
				_aaDoc = OpenDoc(UrlFromDocID(_aa.id)).TopElem;
				
				_response_text.AppendStr( '<assessment><eid>0x' + StrHexInt( _aa.id, 16 ) + '</eid>' );
				_response_text.AppendStr( '<code>' + _aaDoc.code.XmlValue + '</code>' );
				_response_text.AppendStr( '<name>' + _aaDoc.name.XmlValue + ' (' + ArrayCount(_aaDoc.auditorys) + '/' + (_aaDoc.max_auditory.HasValue ? _aaDoc.max_auditory : '...') + ')</name></assessment>' );
			}
			
			_response_text.AppendStr( '</assessments>' );
			break;
		
		case 'activate_assessment2':
			curPersonCode = Request.Form.candidate_eid;
			curAssessmentID = Int( Request.Form.assessment_eid );
			curPerson = ArrayFirstElem( XQuery( "for $collaborator in collaborators where $collaborator/code = '" + curPersonCode + "' return $collaborator" ) );
			
			curPersonID = curPerson.id;
			
			try
			{
				_assDoc = OpenDoc(UrlFromDocID(curAssessmentID));
			}
			catch(_ne_ais_)
			{
				_error = 701;
				throw UserError( 'Invalid assessment appraise ID' );
			}
			
			if (_assDoc.TopElem.auditorys.GetOptChildByKey(curPersonID) != undefined)
			{
				_error = 801;
				throw UserError( 'User already included in appraisal' );
			}
			
			_auditory = _assDoc.TopElem.auditorys.ObtainChildByKey(curPersonID);
			_auditory.person_name = curPerson.fullname;
			_auditory.position_name = curPerson.position_name;
			_assDoc.Save();
			
			_response_text.AppendStr( '<pa><state_desc>*Процедура не начата*</state_desc>' );	
			_response_text.AppendStr( '<html>Процедура не начата</html></pa>' );	
			break;
		
		case 'get_pa':
			curPersonCode = Request.Form.candidate_eid;
			curAssessmentID = Int( Request.Form.assessment_eid );
			 curPerson = ArrayFirstElem( XQuery( "for $collaborator in collaborators where $collaborator/code = '" + curPersonCode + "' return $collaborator" ) );
			
			curPersonID = curPerson.id;
			
			
			_pas = XQuery( "for $pa in pas where $pa/person_id = " + curPersonID + " and $pa/assessment_appraise_id = " + curAssessmentID + " and $pa/is_final = true() return $pa" );
			
			
			if (ArrayCount(_pas) == 0)
			{
				_response_text.AppendStr( '<pa><state_desc>*Процедура не начата*</state_desc>' );	
				_response_text.AppendStr( '<html>Процедура не начата</html></pa>' );	
				break;
			}
			else
			{
				TopElem = OpenDoc(UrlFromDocID( ArrayFirstElem(_pas).id )).TopElem;
			}
					
			_print_forms = XQuery("for $print_form in print_forms where $print_form/object_name = 'pa' return $print_form");
			if (ArrayCount(_print_forms) > 0)
			{
				_cur_print_form_card = ArrayOptFind(_print_forms, "code == 'e-staff'");
				if (_cur_print_form_card == undefined)
					_cur_print_form_card = ArrayFirstElem(_print_forms);
				
				try
				{
					_result = tools.process_print_form( _cur_print_form_card.PrimaryKey );
				}
				catch(_hrena_se_)
				{
					_result = "<font color='red'><b>Ошибка при отображении печатной формы " + _cur_print_form_card.name + "</b></font>";
				}
				_response_text.AppendStr( '<pa><state_desc>' + (TopElem.is_done ? 'Заполнена' : 'Не заполнена') + '</state_desc>' );	
				_response_text.AppendStr( XmlStr('html', _result) + '</pa>' );
			
			}
			else
			{
				_response_text.AppendStr( '<pa><state_desc>-</state_desc>' );	
				_response_text.AppendStr( '<html><b>Не найдена печатная форма</b></html></pa>' );
			}
			break;
			
			
		default:
			_error = 701;				
			throw 'unknown command';
	}
//alert(_response_text.GetStr())	
	Response.WriteBinary( _response_text );
%>