<%
//alert( global_settings.Xml )
/*
	//alert( Request.UrlHost )
	curHostName = StrLowerCase( Request.UrlHost );
	curHost = undefined;
	curSite = undefined;
	curSiteID = null;
	if ( ! StrContains( curHostName, ':' ) )
		curHostName += ':80';

	curHost = ArrayOptFirstElem( XQuery( "for $elem in hosts where $elem/host = '" + curHostName + "' return $elem" ) );
	if ( curHost != undefined )
		curHost = OpenDoc( UrlFromDocID( curHost.PrimaryKey ) ).TopElem;
	
	if ( curHost.site_id.HasValue )
	{
		curSiteID = curHost.site_id.Value;
		try
		{
			curSite = OpenDoc( UrlFromDocID( curSiteID ) ).TopElem;
		}
		catch(err)
		{}
	}
*/
		
	Response.WriteMode = 'single';
	
	curCommand = '';
	
	if ( Request.QueryString.HasProperty('method') )
		curCommand = String( Request.QueryString.method );
	if ( Request.Form.HasProperty('method') )
		curCommand = String( Request.Form.method );
	
		
	function getUserByAuthData( _login, _password )
	{
		_user = tools_base.wsf_find_user_by_login( _login, global_settings.settings.portal_auth_type );
		if ( _user == undefined  )
			return 'Ошибка авторизации: неверный логин';
		curUserID = _user.PrimaryKey;
		try
		{
			curUser = OpenDoc( UrlFromDocID( curUserID ) ).TopElem;
		}
		catch(err)
		{
			alert(err)
			return 'Authorization error: ' + err;
		}
		if ( tools.make_password( curUser.password, true ) != tools.make_password( _password, true ) )
		{
			alert( 'Invalid password. File: estaff_api.html' );
			return 'Ошибка авторизации: неверный пароль';
		}

		if ( curUser.access.access_role == "user"  )
			return 'У вас отсутствуют права доступа к данному сайту';
		return _user;
	}
	
	function check_required_field ( _field_array )
	{
		for ( _req_field in _field_array)
			if ( !Request.Form.HasProperty(_req_field) || ( Request.Form.GetProperty(_req_field) == '' ) )
				return _req_field;
		return "";
	}

	_response_text = new Binary;
	_response_text.AssignStr( '<?xml version="1.0" encoding="windows-1251"?>' );


alert("")
alert("-------------------------------------------------------------------------------------------------------")
alert('COMMAND='+curCommand);
for ( _elem in Request.Form )
{
	alert("   " + _elem + " = " + eval("Request.Form." + _elem ))
}
alert("-------------------------------------------------------------------------------------------------------")
alert()

	switch ( curCommand )
	{
		case 'GetTests':
		

			_check_field_result = check_required_field( Array('login', 'password' ) );
			if ( _check_field_result != "" )
			{
				_response_text.AppendStr( '<Envelope><Body><Fault><faultcode>1</faultcode><faultstring>Отстутствует обязательное поле' + _check_field_result +' </faultstring></Fault></Body></Envelope>' );
				break;
			}
			curUser = getUserByAuthData( Request.Form.login, Request.Form.password )	
			try
			{
				curUser.Name;
			}
			catch(err)
			{
				_response_text.AppendStr( '<Envelope><Body><Fault><faultcode>2</faultcode><faultstring>' + curUser +' </faultstring></Fault></Body></Envelope>' );
				break;
			}

			_response_text.AppendStr( '<Envelope><Body><GetTestsResponse><tests>' );
			
				for ( _test in XQuery("for $elem in assessments where $elem/status='publish' return $elem") )
				{
					testDoc = OpenDoc( UrlFromDocID( _test.PrimaryKey ) ).TopElem;
					if ( tools_web.check_access( testDoc, curUser.PrimaryKey )  )	
						_response_text.AppendStr( '<test><id>0x' + StrHexInt( _test.PrimaryKey, 16 ) +'</id><name>' + _test.title + '</name></test>' );
				}
			_response_text.AppendStr( '</tests></GetTestsResponse></Body></Envelope>' );
			break;
		
		case 'AssignTest':
			curUser = getUserByAuthData( Request.Form.login, Request.Form.password )	
			try
			{
				curUser.Name;
			}
			catch(err)
			{
				_response_text.AppendStr( '<Envelope><Body><Fault><faultcode>2</faultcode><faultstring>' + curUser +' </faultstring></Fault></Body></Envelope>' );
				break;
			}
			
			
			curPersonID = Int(Request.Form.person_id);
			curTestID = Int( Request.Form.test_id );
			personDoc = OpenDoc( UrlFromDocID( curPersonID ) ).TopElem;
			assDoc = OpenDoc( UrlFromDocID( curTestID ) ).TopElem;
			try
			{
				curPersonID = personDoc.person_id;
				personDoc = OpenDoc( UrlFromDocID( curPersonID ) ).TopElem;
			}
			catch(err)
			{}
			
			docActiveLearning = null;
			firsActiveLearning = ArrayOptFirstElem( XQuery( 'for $learning in active_test_learnings where $learning/person_id = ' + curPersonID + ' and $learning/assessment_id = ' + curTestID + ' return $learning' ) );
			if ( firsActiveLearning != undefined  )
			{
				docActiveLearning = OpenDoc( UrlFromDocID( firsActiveLearning.id ) );
				learningDoc = docActiveLearning.TopElem;
			}
			/*
			else
			{
				alert("Поиск в завершенных тестах")
				learningArray = XQuery( 'for $elem in test_learnings where $elem/person_id = ' + curPersonID + ' and $elem/assessment_id = ' + curTestID  + ' return $elem' );
				firstLearning = ArrayOptFirstElem( learningArray );
				if ( firstLearning != undefined )
				{
					docActiveLearning = OpenDoc( UrlFromDocID( firstLearning.id ) );
					learningDoc = docActiveLearning.TopElem;
				}
			}
			*/
			if ( docActiveLearning == null )
			{
				docActiveLearning = OpenNewDoc( 'x-local://wtv/wtv_active_test_learning.xmd' );
				docActiveLearning.BindToDb( DefaultDb );
				//_elem_site = docActiveLearning.TopElem.custom_elems.ObtainChildByKey("site_id");
				//_elem_site.value = curSiteID;
				learningDoc = docActiveLearning.TopElem;
				learningDoc.person_id = curPersonID;
				learningDoc.assessment_id = curTestID;
				tools.common_filling( 'collaborator', learningDoc, curPersonID, personDoc );
				tools.common_filling( 'assessment', learningDoc, curTestID, assDoc );
				learningDoc.max_end_date = learningDoc.calc_max_end_date;
				docActiveLearning.Save();
				tools.create_notification( '31', docActiveLearning.DocID );
				tools.create_notification( '33', docActiveLearning.DocID );
				ms_tools.raise_system_event( 'common_activate_test', null, docActiveLearning.DocID, docActiveLearning );
			}
			
			_test_code = learningDoc.code;
			
			_response_text.AppendStr( '<Envelope><Body><AssignTestResponse>' );
			_response_text.AppendStr( '<testing_id>0x' + StrHexInt( docActiveLearning.DocID, 16 ) + '</testing_id>' );	
			_response_text.AppendStr( '<code>' + _test_code + '</code>' );	
			_response_text.AppendStr( '<start_url>enter_by_test_code.html?code=' + _test_code + '</start_url></AssignTestResponse></Body></Envelope>' );	
			break;
			
		case 'AddPerson':
			_check_field_result = check_required_field( Array('lastname', 'firstname', 'login', 'password' ) );
			if ( _check_field_result != "" )
			{
				_response_text.AppendStr( '<Envelope><Body><Fault><faultcode>1</faultcode><faultstring>Отстутствует обязательное поле  ' + _check_field_result +' </faultstring></Fault></Body></Envelope>' );				
				break;
			}
			curUser = getUserByAuthData( Request.Form.login, Request.Form.password )	
			try
			{
				curUser.Name;
			}
			catch(err)
			{
				_response_text.AppendStr( '<Envelope><Body><Fault><faultcode>2</faultcode><faultstring>' + curUser +' </faultstring></Fault></Body></Envelope>' );
				break;
			}
			
			_is_new = true;
			if ( Request.Form.HasProperty("id") && Request.Form.GetProperty("id") != "" )
				try
				{
					docPerson = OpenDoc( UrlFromDocID( Int( Request.Form.GetProperty("id") )) );
					_is_new = false;
				}
				catch(err)
				{
					alert(err)
				}

			if ( _is_new )
			{
				docPerson = OpenNewDoc( 'x-local://wtv/wtv_collaborator.xmd' );
				docPerson.BindToDb( DefaultDb );
			}
			
			personDoc = docPerson.TopElem;
			personDoc.firstname = Request.Form.firstname;
			personDoc.lastname = Request.Form.lastname;
			
			if ( Request.Form.HasProperty("middlename") && Request.Form.GetProperty("middlename") != "" )
				personDoc.middlename = Request.Form.middlename;
				
			if ( Request.Form.HasProperty("code") && Request.Form.GetProperty("code") != "" )
				personDoc.code = Request.Form.code;
				
			if ( Request.Form.HasProperty("birth_date") && Request.Form.GetProperty("birth_date") != "" )
				personDoc.birth_date = Date(Request.Form.birth_date);
				
			if ( Request.Form.HasProperty("mobile_phone") && Request.Form.GetProperty("mobile_phone") != "" )
				personDoc.phone = (Request.Form.mobile_phone);
			
			if ( Request.Form.HasProperty("home_phone") && Request.Form.GetProperty("home_phone") != "" )
				personDoc.phone += (personDoc.phone.HasValue ? ", " : "" ) + Request.Form.home_phone;
				
			if ( Request.Form.HasProperty("email") && Request.Form.GetProperty("email") != "" )
				personDoc.email = (Request.Form.email);
			
			personDoc.is_candidate = true;
			personDoc.org_id = curUser.org_id;
			//personDoc.custom_elems.ObtainChildByKey("site_id").value = curSiteID;
			docPerson.Save();
			
			_response_text.AppendStr( '<Envelope><Body><AddPersonResponse>' );
			_response_text.AppendStr( '<person_id>0x' + StrHexInt( docPerson.DocID, 16 ) + '</person_id>' );	
			_response_text.AppendStr( '</AddPersonResponse></Body></Envelope>' );	
			break;			
			
		case 'GetTestingState':
			_check_field_result = check_required_field( Array( 'login', 'password', 'person_id', 'test_id' ) );
			if ( _check_field_result != "" )
			{
				_response_text.AppendStr( '<Envelope><Body><Fault><faultcode>1</faultcode><faultstring>Отстутствует обязательное поле  ' + _check_field_result +' </faultstring></Fault></Body></Envelope>' );				
				break;
			}
			curUser = getUserByAuthData( Request.Form.login, Request.Form.password )	
			try
			{
				curUser.Name;
			}
			catch(err)
			{
				_response_text.AppendStr( '<Envelope><Body><Fault><faultcode>2</faultcode><faultstring>' + curUser +' </faultstring></Fault></Body></Envelope>' );
				break;
			}
			curPersonID = Request.Form.person_id;
			curTestID = Int( Request.Form.test_id );
			docLearning = null;
			if ( Request.Form.HasProperty("testing_id") && Request.Form.GetProperty("testing_id") != "" )
			{
				curLearningID = Int( Request.Form.testing_id );
				try
				{
					docLearning = OpenDoc( UrlFromDocID( curLearningID ) ).TopElem;
					docLearning.core_lesson;
				}
				catch(err)
				{
					docLearning = null;
					curLearningArray = XQuery( "for $learning in test_learnings where $learning/active_test_learning_id = " + curLearningID + " return $learning" );
					if ( ArrayCount( curLearningArray ) > 0 )
					{	
						try
						{	
							docLearning = OpenDoc( UrlFromDocID( ArrayFirstElem( curLearningArray ).id ) ).TopElem;
							docLearning.core_lesson;
						}
						catch(err)
						{
							docLearning = null;
						}
					}
					
				}
			}
			if ( docLearning == null )
			{
				curLearningArray = XQuery( "for $learning in active_test_learnings where $learning/assessment_id = " + curTestID + " and $learning/person_id=" + curPersonID + " return $learning" );
				if ( ArrayCount( curLearningArray ) == 0 )
					curLearningArray = XQuery( "for $learning in test_learnings where $learning/assessment_id = " + curTestID + " and $learning/person_id=" + curPersonID + " return $learning" );
				
				if ( ArrayCount( curLearningArray ) > 0 )
				{	
					docLearning = OpenDoc( UrlFromDocID( ArrayFirstElem( curLearningArray ).id ) ).TopElem;
				}
				else
				{
					_response_text.AppendStr( '<Envelope><Body><Fault><faultcode>3</faultcode><faultstring>Object not exist</faultstring></Fault></Body></Envelope>' );
					break;
				}
			}
			//alert(docLearning.Xml)
			_response_text.AppendStr( '<Envelope><Body><GetTestingStateResponse>' );
			_response_text.AppendStr( '<score>' + docLearning.score + '</score>' );	
			_response_text.AppendStr( '<max_score>' + docLearning.max_score + '</max_score>' );	
			//!!!!!!!!!!!!!
			_state = "";
			if ( docLearning.state_id == 1 )
				_state = 0;
			if ( docLearning.state_id == 2 || docLearning.state_id == 3 || docLearning.state_id == 4 )
				_state = 1;
			_is_passed = 1;
			if ( docLearning.state_id == 3 )
				_is_passed = 0;
			
			//alert("    _state = " + _state)
			//alert("    _is_passed = " + _is_passed)
			_response_text.AppendStr( '<state_id>' + _state + '</state_id>' );	
			//_response_text.AppendStr( '<state_id>1</state_id>' );	
			_response_text.AppendStr( '<is_passed>' + _is_passed + '</is_passed>' );	
			//_response_text.AppendStr( '<is_passed>1</is_passed>' );	
			
			
			_str = "";
			//получение результатов тестов для ВТБ24 из шкал и строки результата
			try
			{
				for ( _scale in docLearning.scales )
				{
					try
					{
						_str += "<b>" + _scale.name + " - " + _scale.value + " </b><br>"
						_str += String(_scale.value_str).split("^")[1] + "<br><br>";
					}
					catch(err)
					{
						alert("***" + err)
					}
				}
			}
			catch(err)
			{
				alert(err)
			}
			
			try
			{
				//alert( "**** " + docLearning.text_result )
				//alert( "#### " + String( docLearning.text_result ).split("^")[1] )
				_str += String( docLearning.text_result ).split("^")[1] + "<br><br>";
				//alert( "**** " + _str)
			}
			catch(err)
			{
				//alert("***" + err)
			}
			
			try
			{
				_text = tools.report_decrypt( docLearning );
				objs = OpenDocFromStr( _text, 'form=x-local://wtv/wtv_form_basic_annals.xmd' ).TopElem.au.history.objects;
				objs.DeleteChilds( 'objtype != \'qti\' && objtype != \'qtitext\'' );
				for ( _test in objs )
				{

					Ps = Object();
					Ps.title = ms_tools.get_const('7kfe88uk6v') + ( _test.title == '' ? ( _test.ChildIndex + 1 ) : _test.title );
					Ps.lesson_report = docLearning.lesson_report;
					Ps.obj_id = _test.id;
					Ps.assessment_id = curTestID;
					Ps.text = _text;
					Ps.disp_answers = "incorrect_answers,correct_answers";
					Ps.variant = OpenDoc( UrlFromDocID( docLearning.assessment_id ) ).TopElem;

					_source = docLearning;

					if ( _source.lesson_report.HasValue )
						Ps.lesson_report = _text;
					else
					{
						if ( _source.ChildExists( 'qti_text' ) && _source.qti_text.HasValue )
							Ps.lesson_report = tools.get_annals_text( _text, '', _source.qti_text );
						else
						{
							if ( _source.ChildExists( 'course_id' ) )
								path = OpenDoc( UrlFromDocID( _source.course_id ) ).TopElem.GetPartUrl( _source.PrimaryKey, _source.ChildIndex ).url;
							else
								path = OpenDoc( UrlFromDocID( _source.assessment_id ) ).TopElem.publish_url;

							path = UrlParent( UrlAppendPath( 'x-local://wt/web', path ) );
							Ps.lesson_report = tools.get_annals_text( _text, path );
						}
					}

					_str = _str + "<br><br>" + EvalCodePageUrl( 'x-local://templates/test_dlg_report.html' );
				}
			}
			catch(err)
			{
				alert(err);
			}
			_response_text.AppendStr( '<report><data><![CDATA[' + _str + ']]></data>' );
			_response_text.AppendStr( '</report></GetTestingStateResponse></Body></Envelope>' );	
			break;
	
		case 'AddInterview':
			_check_field_result = check_required_field( Array('login', 'password', 'person_id', 'date' ) );
			if ( _check_field_result != "" )
			{
				_response_text.AppendStr( '<Envelope><Body><Fault><faultcode>1</faultcode><faultstring>Отстутствует обязательное поле  ' + _check_field_result +' </faultstring></Fault></Body></Envelope>' );
				break;
			}
			curUser = getUserByAuthData( Request.Form.login, Request.Form.password )	
			try
			{
				curUser.Name;
			}
			catch(err)
			{
				_response_text.AppendStr( '<Envelope><Body><Fault><faultcode>2</faultcode><faultstring>' + curUser +' </faultstring></Fault></Body></Envelope>' );
				break;
			}
			docEvent = null;
			if ( Request.Form.HasProperty('id') && Request.Form.GetProperty('id') != "" )
			{
				try
				{
					docEvent = OpenDoc( UrlFromDocID( Int( Request.Form.GetProperty('id') ) ) );
				}
				catch(err)
				{
					
				}
			}
			else
			{
				//alert("Создание нового документа!")
				docEvent = OpenNewDoc( 'x-local://wtv/wtv_event.xmd' );
				docEvent.BindToDb(DefaultDb);
			}
			try
			{
				docEvent.TopElem.start_date = Date( Request.Form.date );
			}
			catch(err)
			{
				_response_text.AppendStr( '<Envelope><Body><Fault><faultcode>3</faultcode><faultstring>Неверный формат даты </faultstring></Fault></Body></Envelope>' );
				break;
			}
			docEvent.TopElem.type_id = "webinar";
			
			
			try
			{
				personDoc = OpenDoc( UrlFromDocID( Int( Request.Form.person_id ) ) ).TopElem;
			}
			catch(err)
			{
				_response_text.AppendStr( '<Envelope><Body><Fault><faultcode>4</faultcode><faultstring>Неверное содержание поля person_id</faultstring></Fault></Body></Envelope>' );
				break;
			}
			docEvent.TopElem.name = "Онлайн-интервью кандидата " + personDoc.fullname;
			
			
			if(docEvent.TopElem.vclass_host=='' && ArrayCount(global_settings.settings.vclass_hosts) != 0)
			{
				_host = ArrayOptFirstElem(global_settings.settings.vclass_hosts);
				docEvent.TopElem.vclass_host = _host.host;
			}
			
			tools.add_person_to_event( Int( Request.Form.person_id ), docEvent.DocID, personDoc, docEvent );
			tools.add_person_to_event( curUser.PrimaryKey, docEvent.DocID, null, docEvent );
			
			_child = docEvent.TopElem.tutors.ObtainChildByKey( curUser.PrimaryKey );
			tools.common_filling( 'collaborator', _child, curUser.PrimaryKey );
			docEvent.Save();
			tools.create_notification( "estaff_api_003", curUser.id, "", docEvent.DocID );
			tools.create_notification( "estaff_api_003", Int( Request.Form.person_id ), "", docEvent.DocID );
			_response_text.AppendStr( '<Envelope><Body><AddInterviewResponse>' );
			_recruter_url = "http://mylms.ru/vclass/webinar_starter.html?room=" + docEvent.DocID + "&code=" + Int( Request.Form.person_id );
			_candidate_url = "http://mylms.ru/vclass/webinar_starter.html?room=" + docEvent.DocID + "&code=" + curUser.PrimaryKey;
			_response_text.AppendStr( '<interview_id>0x' + StrHexInt( docEvent.DocID, 16 ) + '</interview_id><start_url>' + _candidate_url + '</start_url><url>' + _recruter_url + '</url></AddInterviewResponse></Body></Envelope>' );
			break;
			
			
		case 'GetInterviewState':
			_check_field_result = check_required_field( Array('login', 'password', 'person_id', 'date' ) );
			if ( _check_field_result != "" )
			{
				_response_text.AppendStr( '<Envelope><Body><Fault><faultcode>1</faultcode><faultstring>Отстутствует обязательное поле  ' + _check_field_result +' </faultstring></Fault></Body></Envelope>' );
				break;
			}
			curUser = getUserByAuthData( Request.Form.login, Request.Form.password )	
			try
			{
				curUser.Name;
			}
			catch(err)
			{
				_response_text.AppendStr( '<Envelope><Body><Fault><faultcode>2</faultcode><faultstring>' + curUser +' </faultstring></Fault></Body></Envelope>' );
				break;
			}
			try
			{
				eventDoc = OpenDoc( UrlFromDocID( Int( Request.Form.interview_id ) ) ).TopElem;
			}
			catch(err)
			{
				_response_text.AppendStr( '<Envelope><Body><Fault><faultcode>3</faultcode><faultstring>Неверное содержание поля interview_id</faultstring></Fault></Body></Envelope>' );
				break;
			}
			state_return = "0";
			switch( eventDoc.status_id )
			{
				case "active":
					state_return = "0";
					break;
				case "close":
					state_return = "1";
					break;
				case "cancel":
					state_return = "2";
					break;
				default:
					state_return = "3";
			}
			_response_text.AppendStr( '<Envelope><Body><GetTestingStateResponse><state_id>' + state_return + '</state_id></GetTestingStateResponse></Body></Envelope>' );
			break;	
	
		default:
			_error = 701;				
			throw 'unknown command';
	}
//alert(_response_text.GetStr())	
	Response.WriteBinary( _response_text );
%>=