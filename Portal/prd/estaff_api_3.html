<%
	//alert( Request.UrlHost )
/*	
	curHostName = StrLowerCase( Request.UrlHost );
	curHost = undefined;
	curSite = undefined;
	curSiteID = null;
	if ( ! StrContains( curHostName, ':' ) )
		curHostName += ':80';

	curHost = ArrayOptFirstElem( XQuery( "for $elem in hosts where $elem/host = '" + curHostName + "' return $elem" ) );
	if ( curHost != undefined )
		curHost = OpenDoc( UrlFromDocID( curHost.PrimaryKey ) ).TopElem;
	
	if ( curHost.site_id.HasValue )
	{
		curSiteID = curHost.site_id.Value;
		try
		{
			curSite = OpenDoc( UrlFromDocID( curSiteID ) ).TopElem;
		}
		catch(err)
		{}
	}
*/
		
	Response.WriteMode = 'single';
	
	curCommand = '';
	
	if ( Request.QueryString.HasProperty('method') )
		curCommand = String( Request.QueryString.method );
	if ( Request.Form.HasProperty('method') )
		curCommand = String( Request.Form.method );
	
	function getUserByAuthData( _login, _password )
	{
		_user = tools_base.wsf_find_user_by_login( _login, global_settings.settings.portal_auth_type );
		if ( _user == undefined  )
			return 'Ошибка авторизации: неверный логин';
		curUserID = _user.PrimaryKey;
		try
		{
			curUser = OpenDoc( UrlFromDocID( curUserID ) ).TopElem;
		}
		catch(err)
		{
			alert(err)
			return 'Authorization error: ' + err;
		}
		if ( tools.make_password( curUser.password, true ) != tools.make_password( _password, true ) )
		{
			alert( 'Invalid password. File: estaff_api.html' );
			return 'Ошибка авторизации: неверный пароль';
		}

		if ( curUser.access.access_role == "user" )
			return 'У вас отсутствуют права доступа к данному сайту';
		
		return _user;
	}
	
	function check_required_field ( _field_array )
	{
		for ( _req_field in _field_array)
			if ( !Request.Form.HasProperty(_req_field) || ( Request.Form.GetProperty(_req_field) == '' ) )
				return _req_field;
		return "";
	}

	function get_work_type_id_by_estaff_id ( _estaff_work_type_id )
	{
		if ( _estaff_work_type_id == "1" )
			return 'full_day';
		if ( _estaff_work_type_id == "2" )
			return 'replaceable_schedule';
		if ( _estaff_work_type_id == "3" )
			return 'free_schedule';
		
		return '';
	}
	
	function get_estaff_work_type_id_by_id ( _work_type_id )
	{
		if ( _work_type_id == "full_day" )
			return '1';
		if ( _work_type_id == "replaceable_schedule" )
			return '2';
		if ( _work_type_id == "free_schedule" )
			return '3';
		return '';
	}
	
	function get_educ_type_id_by_estaff_id ( _estaff_educ_type_id )
	{
		if ( _estaff_educ_type_id == "1" )
			return 'secondary';
		if ( _estaff_educ_type_id == "2" )
			return 'specialized_secondary';
		if ( _estaff_educ_type_id == "3" )
			return 'incomplete_higher';
		if ( _estaff_educ_type_id == "4" )
			return 'higher';
		return "";
	}
	
	function get_estaff_educ_type_id_by_id ( _educ_type_id )
	{
		if ( _educ_type_id == "secondary" )
			return '1';
		if ( _educ_type_id == "specialized_secondary" )
			return '2';
		if ( _educ_type_id == "incomplete_higher" )
			return '3';
		if ( _educ_type_id == "higher" )
			return '4';
		return "";
	}
	
	function get_gender_id_by_estaff_id ( _estaff_gender_id )
	{
		if ( _estaff_gender_id == "0" )
			return 'm';
		if ( _estaff_gender_id == "1" )
			return 'w';
		return '';
	}
	
	function get_estaff_gender_id_by_id ( _gender_id )
	{
		if ( _gender_id == "m" )
			return '0';
		if ( _gender_id == "w" )
			return '1';
		return '';
	}
	
	function get_family_status_id_by_estaff_id ( _estaff_family_status_id )
	{
		if ( _estaff_family_status_id == "1" )
			return 'not_married';
		if ( _estaff_family_status_id == "2" )
			return 'married';
		if ( _estaff_family_status_id == "3" )
			return 'divorced';
		return '';
	}
	
	function get_estaff_family_status_id_by_id ( _family_status_id )
	{
		if ( _family_status_id == "not_married" )
			return '1';
		if ( _family_status_id == "married" )
			return '2';
		if ( _family_status_id == "divorced" )
			return '3';
		return '';
	}
	
	_response_text = new Binary;
	_response_text.AssignStr( '<?xml version="1.0" encoding="windows-1251"?>' );

alert("")
alert("-------------------------------------------------------------------------------------------------------")
alert('COMMAND='+curCommand);
for ( _elem in Request.Form )
{
	alert("    " + _elem + " = " + eval("Request.Form." + _elem ))
}
alert("-------------------------------------------------------------------------------------------------------")
alert()

	switch ( curCommand )
	{
		case 'GetProfessions':
			_response_text.AppendStr( '<Envelope><Body><GetProfessionsResponse>' );
			_response_text.AppendStr( '<professions>' );	
			for (_prof_area in lists.professional_areas)
				_response_text.AppendStr( '<profession><id>' + _prof_area.id + '</id><name>' + _prof_area.name + '</name></profession>' );

			_response_text.AppendStr( '</professions>' );
			_response_text.AppendStr( '</GetProfessionsResponse></Body></Envelope>' );
			break;
		
		case 'GetLocations':
			_response_text.AppendStr( '<Envelope><Body><GetLocationsResponse>' );
			_response_text.AppendStr( '<locations>' );
			for (_region in XQuery('for $elem in regions order by $elem/name ascending return $elem'))
			{
				_response_text.AppendStr( '<location><id>0x' + StrHexInt( _region.id, 16 ) + '</id><name>' + _region.name + '</name><parent_object_id>' + _region.parent_object_id + '</parent_object_id></location>' );
			}
			_response_text.AppendStr( '</locations>' );	
			_response_text.AppendStr( '</GetLocationsResponse></Body></Envelope>' );
			break;
		
		case 'AddVacancy':
			_check_field_result = check_required_field( Array('login', 'password', 'position_name', 'profession_id', 'comment' ) );
			if ( _check_field_result != "" )
			{
				_response_text.AppendStr( '<Envelope><Body><Fault><faultcode>1</faultcode><faultstring>Отстутствует обязательное поле  ' + _check_field_result +' </faultstring></Fault></Body></Envelope>' );				
				break;
			}
			if ( ArrayCount( ArraySelect( lists.professional_areas, "id=='" +  Request.Form.profession_id + "'" ) ) == 0 )
			{
				_response_text.AppendStr( '<Envelope><Body><Fault><faultcode>3</faultcode><faultstring>Профессиональной области с кодом ' + Request.Form.profession_id + ' в базе не существует! </faultstring></Fault></Body></Envelope>' );
				break;
			}
			curUser = getUserByAuthData( Request.Form.login, Request.Form.password )	
			try
			{
				curUser.Name;
			}
			catch(err)
			{
				_response_text.AppendStr( '<Envelope><Body><Fault><faultcode>2</faultcode><faultstring>' + curUser +' </faultstring></Fault></Body></Envelope>' );
				break;
			}
			
			_is_new = false;
			if ( Request.Form.HasProperty("id") && Request.Form.GetProperty("id") != '' )
				//редактирование существующей вакансии
				try
				{
					docVacancy = OpenDoc( UrlFromDocID( Int( Request.Form.GetProperty("id") ) ) );
				}
				catch(err)
				{
					_response_text.AppendStr( '<Envelope><Body><Fault><faultcode>4</faultcode><faultstring>Вакансия с ID ' + Request.Form.GetProperty("id") + ' не найдена!</faultstring></Fault></Body></Envelope>' );
					break;
				}
			else
			{
				//создание новой вакансии
				_exist_vac = undefined;
				if ( Request.Form.GetProperty("code") != "" )
					_exist_vac = ArrayOptFirstElem( XQuery("for $elem in vacancys where $elem/source_id='" + Request.Form.GetProperty("code") + "' return $elem") );
				_cur_vacancy_count = ArrayCount( XQuery("for $elem in vacancys return $elem") );
				_max_num = 3;
				try
				{
					_max_num = Int( OpenDoc( UrlFromDocID( curUser.org_id ) ).TopElem.custom_elems.GetChildByKey("vacancy_limit").value);
				}
				catch(err)
				{
					alert(err);
				}
				
				if ( _exist_vac  == undefined )
				{
					if ( _cur_vacancy_count < _max_num )
					{
						docVacancy = OpenNewDoc( 'x-local://wtv/wtv_vacancy.xmd' );
						docVacancy.BindToDb( DefaultDb );
						_is_new = true;
					}
					else
					{
						_response_text.AppendStr( '<Envelope><Body><Fault><faultcode>5</faultcode><faultstring>Вакансия не может быть опубликована, т.к. достигнут лимит на количество вакансий в базе (' + _max_num + ').</faultstring></Fault></Body></Envelope>' );
						break;
					}
						
				}
				else
					docVacancy = OpenDoc( UrlFromDocID( _exist_vac.PrimaryKey ) );
			}
			vacancyDoc = docVacancy.TopElem;
			vacancyDoc.source_id = Request.Form.GetProperty("code");
			vacancyDoc.name = Request.Form.GetProperty("position_name");
			vacancyDoc.profession_area_id = Request.Form.GetProperty("profession_id");
			vacancyDoc.desc = HtmlEncode( Request.Form.GetProperty("comment") );
			vacancyDoc.pub_date = _is_new ? Date() : vacancyDoc.pub_date;
			vacancyDoc.edit_date = Date();
			//vacancyDoc.access.enable_anonymous_access = true;
				
			_err_str = "";
			if ( Request.Form.HasProperty("location_id") && Request.Form.GetProperty("location_id") != '' )
				try
				{
					region_id = UnifySpaces(Request.Form.GetProperty("location_id"));
					_region = ArrayOptFirstElem( XQuery("for $elem in regions where $elem/id=" + region_id + " return $elem") );
					if ( _region == undefined )
						_err_str += " Указанный в поле location_id регион в базе не найден. "
					else
						vacancyDoc.region_id = _region.PrimaryKey;
				}
				catch(err)
				{
					alert(err)
					_err_str += " Неверный формат поля location_id. ";
				}
			
			if ( Request.Form.HasProperty("work_type_id") && Request.Form.GetProperty("work_type_id") != '' )
			{
				work_type_id = Request.Form.GetProperty("work_type_id");
				_employment_type = undefined;
				if ( work_type_id == "1" )
					_employment_type = ArrayOptFind( common.employment_types, "id=='full_day'" );
				if ( work_type_id == "2" )
					_employment_type = ArrayOptFind( common.employment_types, "id=='replaceable_schedule'" );
				if ( work_type_id == "3" )
					_employment_type = ArrayOptFind( common.employment_types, "id=='free_schedule'" );
				if ( _employment_type == undefined )
					_err_str += " Указанный в поле work_type_id тип занятости в базе не найден. "
				else
					vacancyDoc.employment_type_id = _employment_type.PrimaryKey;
			}
			if ( Request.Form.HasProperty("educ_type_id") && Request.Form.GetProperty("educ_type_id") != '' )
			{
				educ_type_id = Request.Form.GetProperty("educ_type_id");
				_educ_type = ArrayOptFind( common.educ_types, "id=='" + educ_type_id + "'" );
				
				_educ_type = undefined;
				if ( educ_type_id == "1" )
					_educ_type = ArrayOptFind( common.educ_types, "id=='secondary'" );
				if ( educ_type_id == "2" )
					_educ_type = ArrayOptFind( common.educ_types, "id=='specialized_secondary'" );
				if ( educ_type_id == "3" )
					_educ_type = ArrayOptFind( common.educ_types, "id=='incomplete_higher'" );
				if ( educ_type_id == "4" )
					_educ_type = ArrayOptFind( common.educ_types, "id=='higher'" );
				
				if ( _educ_type == undefined )
					_err_str += " Указанный в поле educ_type_id тип образования в базе не найден. "
				else
					vacancyDoc.educ_type_id = _educ_type.PrimaryKey;
			}
			if ( Request.Form.HasProperty("salary_currency_id") && Request.Form.GetProperty("salary_currency_id") != '' )
			{
				salary_currency_id = Request.Form.GetProperty("salary_currency_id");
				_salary_currency = ArrayOptFind( lists.currency_types, "id=='" + salary_currency_id + "'" );
				if ( _salary_currency == undefined )
					_err_str += " Указанная в поле salary_currency_id валюта в базе не найден. "
				else
					vacancyDoc.currency_type_id = _salary_currency.PrimaryKey;
			}
			
			_source_field_names = Array( "min_salary", "max_salary", "min_age", "max_age", "min_exp_years", "publish_days");
			_fields_name_in_base = Array( "min_wage", "max_wage", "min_age", "max_age", "min_exp_years", "pub_period");
			i=0-1;
			while ( i++ < ArrayCount(_source_field_names) )
				if ( Request.Form.HasProperty(_source_field_names[i]) && Request.Form.GetProperty(_source_field_names[i]) != '' )
					try
					{
						//alert( _fields_name_in_base[i] )
						vacancyDoc.Child(_fields_name_in_base[i]).Value = Int( Request.Form.GetProperty(_source_field_names[i]) );
					}
					catch(err)
					{
						alert("Ошибка 15452: " + err)
						_err_str += " Неверный формат поля " + _source_field_names[i] + ". ";
					}

			
			_source_field_names = Array( "contacts_fullname", "contacts_phone", "contacts_email", "org_name", "sub_name", "is_closed" );
			_fields_name_in_base = Array( "contact_fullname", "contact_phone", "contact_email", "org_name", "sub_name", "is_closed" );
			i=0-1;
			while ( i++ < ArrayCount(_source_field_names) )
				if ( Request.Form.HasProperty(_source_field_names[i]) && Request.Form.GetProperty(_source_field_names[i]) != '' )
				{
					//alert("%%%%" + Request.Form.GetProperty(_source_field_names[i]))
					vacancyDoc.Child(_fields_name_in_base[i]).Value = Request.Form.GetProperty(_source_field_names[i]);
				}
			
			if (Request.Form.HasProperty("assessments_ids") && Request.Form.GetProperty("assessments_ids") != '')
			{
				ass_ids_array = String(  Request.Form.GetProperty("assessments_ids") ).split(",");
				vacancyDoc.assessments.Clear();
				for ( _ass_id in ass_ids_array )
				{
					try
					{
						assDoc = OpenDoc( UrlFromDocID( Int(_ass_id) ) ).TopElem;
						_ass_child = vacancyDoc.assessments.ObtainChildByKey(Int(_ass_id));
						tools.common_filling( 'assessment', _ass_child, Int(_ass_id), assDoc );
					}
					catch(err)
					{}
				}
			}
			vacancyDoc.collaborator_id = curUser.id;
		
			docVacancy.Save();
			_response_text.AppendStr( '<Envelope><Body><AddVacancyResponse>' );
			_response_text.AppendStr( '<vacancy_id>0x' + StrHexInt( docVacancy.DocID, 16 ) + '</vacancy_id>' );	
			_response_text.AppendStr( '</AddVacancyResponse></Body></Envelope>' );
			break;
		
		case 'DeleteVacancy':
					
			_check_field_result = check_required_field( Array('login', 'password', 'vacancy_id' ) );
			if ( _check_field_result != "" )
			{
				_response_text.AppendStr( '<Envelope><Body><Fault><faultcode>1</faultcode><faultstring>Отстутствует обязательное поле  ' + _check_field_result +' </faultstring></Fault></Body></Envelope>' );				
				break;
			}
			curUser = getUserByAuthData( Request.Form.login, Request.Form.password )	
			try
			{
				curUser.Name;
			}
			catch(err)
			{
				_response_text.AppendStr( '<Envelope><Body><Fault><faultcode>2</faultcode><faultstring>' + curUser +' </faultstring></Fault></Body></Envelope>' );
				break;
			}
			
			try
			{
				DeleteDoc( UrlFromDocID( Int( Request.Form.vacancy_id ) ));
			}
			catch (err)
			{
				_response_text.AppendStr( '<Envelope><Body><Fault><faultcode>3</faultcode><faultstring>Ошибка удаления: ' + err + '</faultstring></Fault></Body></Envelope>' );
				break;
			}
			_response_text.AppendStr( '<Envelope><Body><DeleteVacancyResponse>' );
			_response_text.AppendStr( '</DeleteVacancyResponse></Body></Envelope>' );
			break;
			
		case 'SearchResumes':
			_check_field_result = check_required_field( Array('login', 'password' ) );
			if ( _check_field_result != "" )
			{
				_response_text.AppendStr( '<Envelope><Body><Fault><faultcode>1</faultcode><faultstring>Отстутствует обязательное поле  ' + _check_field_result +' </faultstring></Fault></Body></Envelope>' );				
				break;
			}
			curUser = getUserByAuthData( Request.Form.login, Request.Form.password )	
			try
			{
				curUser.Name;
			}
			catch(err)
			{
				_response_text.AppendStr( '<Envelope><Body><Fault><faultcode>2</faultcode><faultstring>' + curUser +' </faultstring></Fault></Body></Envelope>' );
				break;
			}
			_persons_in_org = XQuery("for elem in collaborators where $elem/org_id=" + curUser.org_id + " return $elem")
			resume_array = QueryCatalogByKeys( 'resumes', 'person_id', _persons_in_org );
			
			if ( Request.Form.HasProperty("keywords") && Request.Form.GetProperty("keywords") != '' )
				temp_resume_array = XQuery( "for $elem in resumes where doc-contains($elem/id, '" + DefaultDb + "', '" + Request.Form.keywords + "') return $elem" );
				
//пересечение массивов

			result_cross_array = Array();
			i = 0;
			for ( _sub_res_elem in temp_resume_array )
			{
				if ( ArrayOptFind( resume_array, 'id==' + _sub_res_elem.id ) != undefined )
				{
					result_cross_array[i] = _sub_res_elem;
					i++;
				}
			}
			resume_array = result_cross_array;
				
			if ( Request.Form.HasProperty("position_name_keywords") && Request.Form.GetProperty("position_name_keywords") != '' )
				resume_array = ArraySelect( resume_array, "StrContains( name , '" + Request.Form.position_name_keywords + "', true)" )

			try
			{
				check_fields = Array( Array( "location_id", "region_id", "Int", "==" ), Array( "min_salary", "min_wage", "Int", ">=" ), Array( "max_salary", "max_wage", "Int", "<=" ), Array( "profession_id", "profession_area_id", "String", "==" ), Array( "work_type_id", "employment_type_id", "get_work_type_id_by_estaff_id", "==" ), Array( "salary_currency_id", "currency_type_id", "String", "==" ), Array( "educ_type_id", "get_educ_type_id_by_estaff_id", "String", "==" ), Array( "min_exp_years", "exp_years", "Real", ">=" ), Array( "gender_id", "sex", "String", "==" )  );
				for ( _field in check_fields )
					if ( Request.Form.HasProperty( _field[0] ) && Request.Form.GetProperty( _field[0] ) != '' )
						resume_array = ArraySelect( resume_array, "" + _field[1] + _field[3] + (_field[2]=="String" ? "'" :  "") +  eval( _field[2] + "(Request.Form." + _field[0] + ")") + (_field[2]=="String" ? "'" :  "") )
				
				if ( Request.Form.HasProperty( "min_date" ) && Request.Form.GetProperty( "min_date" ) != '' )
					resume_array = ArraySelect( resume_array, 'modification_date >= Date( Request.Form.min_date )' );
				
				if ( Request.Form.HasProperty( "min_age" ) && Request.Form.GetProperty( "min_age" ) != '' )
				{
					min_year =  Year( Date() ) - Int(Request.Form.GetProperty( "min_age" ));
					min_date = Date( Day( Date() ) + "." +  Month( Date() ) + "." +  min_year );
					resume_array = ArraySelect( resume_array, 'birth_date < min_date' );
				}
				if ( Request.Form.HasProperty( "max_age" ) && Request.Form.GetProperty( "max_age" ) != '' )
				{
					min_year =  Year( Date() ) - Int(Request.Form.GetProperty( "max_age" ));
					min_date = Date( Day( Date() ) + "." +  Month( Date() ) + "." +  min_year );
					resume_array = ArraySelect( resume_array, 'birth_date > min_date' );
				}
			}
			catch(err)
			{
				alert( "File estaff_api_3.html. " + err )
				_response_text.AppendStr( '<Envelope><Body><Fault><faultcode>3</faultcode><faultstring>Неверный формат данных</faultstring></Fault></Body></Envelope>' );
				break;
			}
			
			source_field_array = Array( "creation_date", "modification_date", "name", "sex", "min_wage", "max_wage", "currency_type_id", "profession_area_id", "region_id", "exp_years" );
			field_name_array = Array( "creation_date", "modification_date", "desired_position_name", "sex", "min_salary", "max_salary", "salary_currency_id", "profession_id", "location_id", "min_exp_years" );
			_response_text.AppendStr( '<Envelope><Body><SearchResumesResponse><resumes>' );
			
					
			for ( _resume in resume_array )
			{
				_response_text.AppendStr( '<resume>' );	
				//_response_text.AppendStr( '<id>0x' + StrHexInt( _resume.id, 16 ) + '</id><date>' + _resume.modification_date + '</date>' );
				_response_text.AppendStr( '<id>0x' + StrHexInt( _resume.person_id, 16 ) + '</id><date>' + _resume.modification_date + '</date>' );
				try
				{
					personDoc = OpenDoc( UrlFromDocID( _resume.person_id ) ).TopElem;
					_response_text.AppendStr( '<lastname>' + personDoc.lastname + '</lastname>' );
					_response_text.AppendStr( '<firstname>' + personDoc.firstname + '</firstname>' );
					_response_text.AppendStr( '<middlename>' + personDoc.middlename + '</middlename>' );
				}
				catch(err)
				{
				}
				resumeDoc = OpenDoc( UrlFromDocID( _resume.id ) ).TopElem;
				_response_text.AppendStr( '<work_type_id>' + get_estaff_work_type_id_by_id(resumeDoc.employment_type_id) + '</work_type_id><educ_type_id>' + get_estaff_educ_type_id_by_id(resumeDoc.educ_type_id) + '</educ_type_id>' );
				_response_text.AppendStr( '<desired_position_name>' + resumeDoc.name + '</desired_position_name>' );
				_response_text.AppendStr( '<salary>' + ( resumeDoc.min_wage.HasValue ? 'от ' + resumeDoc.min_wage : '' ) + ( resumeDoc.max_wage.HasValue ? ' до ' + resumeDoc.max_wage : ''  ) + '</salary>' );
				_response_text.AppendStr( '<salary_currency_id>' + resumeDoc.currency_type_id + '</salary_currency_id>' );
				_response_text.AppendStr( '<exp_years>' + resumeDoc.exp_years + '</exp_years>' );
				_response_text.AppendStr( '<birth_date>' + resumeDoc.birth_date + '</birth_date>' );
				_response_text.AppendStr( '<email>' + resumeDoc.email + '</email>' );
				_response_text.AppendStr( '<phone>' + resumeDoc.phone + '</phone>' );
				_response_text.AppendStr( '<work_phone>' + resumeDoc.work_phone + '</work_phone>' );
				_response_text.AppendStr( '<mobile_phone>' + resumeDoc.mobile_phone + '</mobile_phone>' );
				if ( ArrayCount( resumeDoc.work_experiences ) == 0 )
					_response_text.AppendStr( '<last_job><org_name></org_name><position_name></position_name></last_job>' );
				else
				{
					last_work = ArrayMax( resumeDoc.work_experiences, "start_date" );
					_response_text.AppendStr( '<last_job><org_name>' + last_work.org_name + '</org_name><position_name>' + last_work.position_name + '</position_name></last_job>' );
				}
				i=0-1;
				while ( i++ < ArrayCount( source_field_array ) )
					_response_text.AppendStr( '<' + field_name_array[i] + '>' + _resume.Child( source_field_array[i] ).Value + '</' + field_name_array[i] + '>' );
				
				_response_text.AppendStr( '<html_resume><![CDATA[' + resumeDoc.desc + ']]></html_resume>' );	
				_response_text.AppendStr( '</resume>' );	
			}
			_response_text.AppendStr( '</resumes></SearchResumesResponse></Body></Envelope>' );
			break;
		
		case 'GetResume':
			_check_field_result = check_required_field( Array('login', 'password', 'resume_id' ) );
			if ( _check_field_result != "" )
			{
				_response_text.AppendStr( '<Envelope><Body><Fault><faultcode>1</faultcode><faultstring>Отстутствует обязательное поле  ' + _check_field_result +' </faultstring></Fault></Body></Envelope>' );				
				break;
			}
			curUser = getUserByAuthData( Request.Form.login, Request.Form.password )	
			try
			{
				curUser.Name;
			}
			catch(err)
			{
				_response_text.AppendStr( '<Envelope><Body><Fault><faultcode>2</faultcode><faultstring>' + curUser +' </faultstring></Fault></Body></Envelope>' );
				break;
			}
			
			resumeDoc = null;
			try
			{
				resumeDoc = OpenDoc( UrlFromDocID(Int(Request.Form.resume_id)) ).TopElem;
				resumeDoc.min_wage;
			}
			catch(err)
			{
				alert(err)
				try
				{
					vacancy_responseDoc = OpenDoc( UrlFromDocID(Int(Request.Form.vacancy_response_id)) ).TopElem;
					resumeDoc = OpenDoc( UrlFromDocID( vacancy_responseDoc.resume_id ) ).TopElem;
				}
				catch(err)
				{
					alert(err)
					_response_text.AppendStr( '<Envelope><Body><Fault><faultcode>3</faultcode><faultstring>Резюме с таким ID отсутствует в базе</faultstring></Fault></Body></Envelope>' );
					break;
				}
			}
			
			source_field_array = Array( "doc_info.creation.date", "doc_info.modification.date", "name", "min_wage", "max_wage", "currency_type_id", "profession_area_id", "region_id", "address", "exp_years", "phone", "work_phone", "mobile_phone", "email", "birth_date");
			field_name_array = Array( "creation_date", "modification_date", "desired_position_name", "min_salary", "max_salary", "salary_currency_id", "profession_id", "location_id", "address", "min_exp_years", "home_phone", "work_phone", "mobile_phone", "email", "birth_date"  );
			
			_response_text.AppendStr( '<Envelope><Body><GetResumeResponse><resume>' );
			
			_response_text.AppendStr( '<id>0x' + StrHexInt( Int(Request.Form.resume_id), 16 ) + '</id>' );
			personDoc = null;
			try
			{
				personDoc = OpenDoc( UrlFromDocID( resumeDoc.person_id ) ).TopElem;
				_response_text.AppendStr( '<lastname>' + personDoc.lastname + '</lastname>' );
				_response_text.AppendStr( '<firstname>' + personDoc.firstname + '</firstname>' );
				_response_text.AppendStr( '<middlename>' + personDoc.middlename + '</middlename>' );
			}
			catch(err)
			{
			}
			
			i=0-1;
			while ( i++ < ArrayCount( source_field_array ) )
				_response_text.AppendStr( '<' + field_name_array[i] + '>' + eval("resumeDoc." + source_field_array[i] ) + '</' + field_name_array[i] + '>' );
			
			_response_text.AppendStr( '<marital_status_id>' + get_estaff_family_status_id_by_id(resumeDoc.family_status) + '</marital_status_id>' );
			_response_text.AppendStr( '<gender_id>' + get_estaff_gender_id_by_id(resumeDoc.sex) + '</gender_id>' );
			_response_text.AppendStr( '<profession_name>' + (resumeDoc.profession_area_id.OptForeignElem != undefined ? resumeDoc.profession_area_id.OptForeignElem.name : '' )+ '</profession_name>' );
			_response_text.AppendStr( '<work_type_id>' + get_estaff_work_type_id_by_id(resumeDoc.employment_type_id) + '</work_type_id><educ_type_id>' + get_estaff_educ_type_id_by_id(resumeDoc.educ_type_id) + '</educ_type_id>' );
			
			_response_text.AppendStr( '<prev_jobs>' );
			for ( _job in resumeDoc.work_experiences )
			{
				_response_text.AppendStr( '<prev_job>' );
					_response_text.AppendStr( '<start_date>' + _job.start_date + '</start_date>' );
					_response_text.AppendStr( '<end_date>' + _job.finish_date + '</end_date>' );
					_response_text.AppendStr( '<org_name>' + _job.org_name + '</org_name>' );
					_response_text.AppendStr( '<position_name>' + _job.position_name + '</position_name>' );
					_response_text.AppendStr( '<comment>' + _job.desc + '</comment>' );
				_response_text.AppendStr( '</prev_job>' );
			}
			_response_text.AppendStr( '</prev_jobs>' );
			
			_response_text.AppendStr( '<prev_educations>' );
			for ( _educ in resumeDoc.educations )
			{
				_response_text.AppendStr( '<prev_education>' );
					_response_text.AppendStr( '<start_date></start_date>' );
					_response_text.AppendStr( '<end_date>' + _educ.date + '</end_date>' );
					_response_text.AppendStr( '<org_name>' + _educ.name + '</org_name>' );
					_response_text.AppendStr( '<department_name>' + _educ.specialisation + '</department_name>' );
					_response_text.AppendStr( '<speciality_name>' + _educ.result + '</speciality_name>' );
				_response_text.AppendStr( '</prev_education>' );
			}
			_response_text.AppendStr( '</prev_educations>' );
			_response_text.AppendStr( '<add_info>' + resumeDoc.dominant_skills + '</add_info>' );
			_response_text.AppendStr( '<html_resume><![CDATA[' + resumeDoc.desc + ']]></html_resume>' );	
			_response_text.AppendStr( '</resume></GetResumeResponse></Body></Envelope>' );	
			break;
		
		case 'GetVacancyResponses':
			_check_field_result = check_required_field( Array('login', 'password' ) );
			if ( _check_field_result != "" )
			{
				_response_text.AppendStr( '<Envelope><Body><Fault><faultcode>1</faultcode><faultstring>Отстутствует обязательное поле' + _check_field_result +' </faultstring></Fault></Body></Envelope>' );
				break;
			}
			curUser = getUserByAuthData( Request.Form.login, Request.Form.password )	
			try
			{
				curUser.Name;
			}
			catch(err)
			{
				_response_text.AppendStr( '<Envelope><Body><Fault><faultcode>2</faultcode><faultstring>' + curUser +' </faultstring></Fault></Body></Envelope>' );
				break;
			}
			
			_all_users = "0";
			if ( Request.Form.HasProperty("all_users") && Request.Form.GetProperty("all_users") == "1" )
				_all_users = "1";
			
			_use_full_resumes = true;
			if ( Request.Form.HasProperty("use_full_resumes") && Request.Form.GetProperty("use_full_resumes") == "0" )
				_use_full_resumes = false;
				
			_vacancy_array = XQuery("for $elem in vacancys " + ( _all_users == "0" ? " where $elem/collaborator_id=" + curUser.id : "" ) + " return $elem");
			_vacancy_id_array = ArrayExtract( _vacancy_array, "id" );
			if ( Request.Form.HasProperty("vacancy_id") && Request.Form.GetProperty("vacancy_id") != "" )
			{
				_vacancy_id_array = Array( );
				_vacancy_id_array[0] = Int( Request.Form.GetProperty("vacancy_id") );
			}
			//alert( "КОЛИЧЕСТВО ВАКАНСИЙ =" + ArrayCount( _vacancy_id_array ) )	
			all_responses = QueryCatalogByKeys( 'vacancy_responses', 'vacancy_id', _vacancy_id_array );  
			//alert( "КОЛИЧЕСТВО ОТКЛИКОВ =" + ArrayCount( all_responses ) )
			if ( Request.Form.HasProperty("min_date") && Request.Form.GetProperty("min_date") != "" )
			{
				_min_date = Date( Request.Form.GetProperty("min_date") )
				all_responses = ArraySelect( all_responses, "modification_date >= _min_date" );
			}
			//alert( "КОЛИЧЕСТВО ОТКЛИКОВ =" + ArrayCount( all_responses ) )
			_response_text.AppendStr( '<Envelope><Body><GetVacancyResponsesResponse><use_full_resumes>1</use_full_resumes><responses>' );
			
			response_source_field_array = Array( "vacancy_id", "date", "resume_id" );
			response_field_name_array = Array( "vacancy_id", "date", "resume_id" );
			for ( _response in all_responses )
			{
				resumeDoc = null;
				try
				{
					resumeDoc = OpenDoc( UrlFromDocID( _response.resume_id ) ).TopElem;
				}
				catch(err)
				{
					//alert(err)
					continue;
				}
				responseDoc = OpenDoc( UrlFromDocID( _response.id ) ).TopElem;
				_response_text.AppendStr( '<response>' );
				_response_text.AppendStr( '<id>0x' + StrHexInt( _response.id, 16 ) + '</id>' );
				i=0-1;
				while ( i++ < ArrayCount( response_source_field_array ) )
					_response_text.AppendStr( '<' + response_field_name_array[i] + '>' + responseDoc.Child( response_source_field_array[i] ).Value + '</' + response_field_name_array[i] + '>' );
					
				_response_text.AppendStr( '<letter_text><![CDATA[' + responseDoc.desc + ']]></letter_text>' );	
				_response_text.AppendStr( '<resume>' );
				

				
				
				
					source_field_array = Array( "doc_info.creation.date", "doc_info.modification.date", "name", "min_wage", "max_wage", "currency_type_id", "profession_area_id", "region_id", "address", "exp_years", "phone", "work_phone", "mobile_phone", "email", "birth_date");
					field_name_array = Array( "creation_date", "modification_date", "desired_position_name", "min_salary", "max_salary", "salary_currency_id", "profession_id", "location_id", "address", "min_exp_years", "home_phone", "work_phone", "mobile_phone", "email", "birth_date" );

					
					//_response_text.AppendStr( '<id>0x' + StrHexInt( _response.resume_id, 16 ) + '</id>' );
					_response_text.AppendStr( '<id>0x' + StrHexInt( _response.person_id, 16 ) + '</id>' );
					personDoc = null;
					try
					{
						personDoc = OpenDoc( UrlFromDocID( resumeDoc.person_id ) ).TopElem;
						_response_text.AppendStr( '<lastname>' + personDoc.lastname + '</lastname>' );
						_response_text.AppendStr( '<firstname>' + personDoc.firstname + '</firstname>' );
						_response_text.AppendStr( '<middlename>' + personDoc.middlename + '</middlename>' );
					}
					catch(err)
					{
					}
					
					i=0-1;
					while ( i++ < ArrayCount( source_field_array ) )
						_response_text.AppendStr( '<' + field_name_array[i] + '>' + eval("resumeDoc." + source_field_array[i] ) + '</' + field_name_array[i] + '>' );
					
					_response_text.AppendStr( '<marital_status_id>' + get_estaff_family_status_id_by_id(resumeDoc.family_status) + '</marital_status_id>' );
					_response_text.AppendStr( '<gender_id>' + get_estaff_gender_id_by_id(resumeDoc.sex) + '</gender_id>' );
					_response_text.AppendStr( '<profession_name>' + (resumeDoc.profession_area_id.OptForeignElem != undefined ? resumeDoc.profession_area_id.OptForeignElem.name : '' )+ '</profession_name>' );
					_response_text.AppendStr( '<work_type_id>' + get_estaff_work_type_id_by_id(resumeDoc.employment_type_id) + '</work_type_id><educ_type_id>' + get_estaff_educ_type_id_by_id(resumeDoc.educ_type_id) + '</educ_type_id>' );
					
					if (_use_full_resumes)
					{
						_response_text.AppendStr( '<prev_jobs>' );
						for ( _job in resumeDoc.work_experiences )
						{
							_response_text.AppendStr( '<prev_job>' );
								_response_text.AppendStr( '<start_date>' + _job.start_date + '</start_date>' );
								_response_text.AppendStr( '<end_date>' + _job.finish_date + '</end_date>' );
								_response_text.AppendStr( '<org_name>' + _job.org_name + '</org_name>' );
								_response_text.AppendStr( '<position_name>' + _job.position_name + '</position_name>' );
								_response_text.AppendStr( '<comment>' + _job.desc + '</comment>' );
							_response_text.AppendStr( '</prev_job>' );
						}
						_response_text.AppendStr( '</prev_jobs>' );
						
						_response_text.AppendStr( '<prev_educations>' );
						for ( _educ in resumeDoc.educations )
						{
							_response_text.AppendStr( '<prev_education>' );
								_response_text.AppendStr( '<start_date></start_date>' );
								_response_text.AppendStr( '<end_date>' + _educ.date + '</end_date>' );
								_response_text.AppendStr( '<org_name>' + _educ.name + '</org_name>' );
								_response_text.AppendStr( '<department_name>' + _educ.specialisation + '</department_name>' );
								_response_text.AppendStr( '<speciality_name>' + _educ.result + '</speciality_name>' );
							_response_text.AppendStr( '</prev_education>' );
						}
						_response_text.AppendStr( '</prev_educations>' );
						_response_text.AppendStr( '<html_resume><![CDATA[' + resumeDoc.desc + ']]></html_resume>' );
					}
					_response_text.AppendStr( '<add_info>' + resumeDoc.dominant_skills + '</add_info>' );
									
						
				
				

				_response_text.AppendStr( '</resume>' );
				_response_text.AppendStr( '</response>' );
			}
			_response_text.AppendStr( '</responses></GetVacancyResponsesResponse></Body></Envelope>' );
			break;
		
		case 'ChangeStatusVacancyResponse':
		
			_check_field_result = check_required_field( Array('login', 'password', 'vacancy_response_id', 'status' ) );
			if ( _check_field_result != "" )
			{
				_response_text.AppendStr( '<Envelope><Body><Fault><faultcode>1</faultcode><faultstring>Отстутствует обязательное поле  ' + _check_field_result +' </faultstring></Fault></Body></Envelope>' );
				break;
			}
			curUser = getUserByAuthData( Request.Form.login, Request.Form.password )	
			try
			{
				curUser.Name;
			}
			catch(err)
			{
				_response_text.AppendStr( '<Envelope><Body><Fault><faultcode>2</faultcode><faultstring>' + curUser +' </faultstring></Fault></Body></Envelope>' );
				break;
			}
			
			try
			{
				docVacancyResponse = OpenDoc( UrlFromDocID( Int( Request.Form.vacancy_response_id ) ) );
			}
			catch(err)
			{
				_response_text.AppendStr( '<Envelope><Body><Fault><faultcode>3</faultcode><faultstring>Некорректное значение поля vacancy_response_id</faultstring></Fault></Body></Envelope>' );
				break;
			}
			
			if ( Request.Form.status != "1" && Request.Form.status != "0" )
			{				
				_response_text.AppendStr( '<Envelope><Body><Fault><faultcode>4</faultcode><faultstring>Некорректное значение поля status</faultstring></Fault></Body></Envelope>' );
				break;
			}
			
			if ( Request.Form.status == "1" )
				docVacancyResponse.TopElem.status = "accepted";
			if ( Request.Form.status == "0" )
				docVacancyResponse.TopElem.status = "rejected";
			
			docVacancyResponse.TopElem.employer_answer = ( Request.Form.HasProperty("employer_answer") ? Request.Form.employer_answer : "" )
			tools.create_notification("estaff_api_001", docVacancyResponse.DocID)
			
			docVacancyResponse.Save();
			_response_text.AppendStr( '<Envelope><Body><ChangeStatusVacancyResponseResponse></ChangeStatusVacancyResponseResponse></Body></Envelope>' );
			break;
			
		case 'GetSiteOptions':
			_response_text.AppendStr( '<Envelope><Body><GetSiteOptionsResponse>' );
			_response_text.AppendStr( '			<allow_publish_vacancies>1</allow_publish_vacancies>
			<allow_get_vacancy_responses>1</allow_get_vacancy_responses>
			<allow_search_resumes>1</allow_search_resumes>
			<use_locations>1</use_locations>
			<use_professions>1</use_professions>
			<allow_all_users_actions>1</allow_all_users_actions>
			<allow_full_responses>1</allow_full_responses>
			<allow_reject_responses>1</allow_reject_responses>
			<charset>windows-1251</charset>');
			_response_text.AppendStr( '</GetSiteOptionsResponse></Body></Envelope>' );
			break;
			
		case 'GetVacancies':
			curUser = getUserByAuthData( Request.Form.login, Request.Form.password )	
			try
			{
				curUser.Name;
			}
			catch(err)
			{
				_response_text.AppendStr( '<Envelope><Body><Fault><faultcode>2</faultcode><faultstring>' + curUser +' </faultstring></Fault></Body></Envelope>' );
				break;
			}
		
			_all_users = Request.Form.HasProperty("all_users") ? Request.Form.GetProperty("all_users") : "0";
			_min_date = Request.Form.HasProperty("min_date") ? Request.Form.GetProperty("min_date") : "";
				
			_vacancy_array = XQuery("for $elem in vacancys " + ( _all_users == "0" ? " where $elem/collaborator_id=" + curUser.id : "" ) + " return $elem");
			if ( _min_date != "" )
			{
				_min_date = Date( _min_date );
				_vacancy_array = ArraySelect( _vacancy_array, "modification_date >= _min_date" );
			}

			_response_text.AppendStr( '<Envelope><Body><GetVacanciesResponse><vacancies>' );
			for ( _vac in _vacancy_array )
			{
				try
				{
					vacDoc = OpenDoc( UrlFromDocID( _vac.id ) ).TopElem;
				}
				catch(err)
				{
					alert(err);
					continue;
				}
				_response_text.AppendStr( '<vacancy><id>0x' + StrHexInt( _vac.id , 16 ) + '</id><position_name>' + _vac.name + '</position_name><code>' + _vac.source_id + '</code>' );
				
				_response_text.AppendStr( '<profession_id>' + _vac.profession_area_id + '</profession_id><location_id>' + _vac.region_id + '</location_id>' );
				_response_text.AppendStr( '<min_salary>' + _vac.min_wage + '</min_salary><max_salary>' + _vac.max_wage + '</max_salary><salary_currency_id>' + _vac.currency_type_id + '</salary_currency_id>' );
				_response_text.AppendStr( '<work_type_id>' + get_estaff_work_type_id_by_id(_vac.employment_type_id) + '</work_type_id><educ_type_id>' + get_estaff_educ_type_id_by_id(_vac.educ_type_id) + '</educ_type_id><min_exp_years>' + vacDoc.min_exp_years + '</min_exp_years>' );
				_response_text.AppendStr( '<min_age>' + _vac.min_age + '</min_age><max_age>' + _vac.max_age + '</max_age><comment><![CDATA[' + vacDoc.desc + ']]></comment>' );
				_response_text.AppendStr( '<contact_fullname>' + vacDoc.contact_fullname + '</contact_fullname><contact_phone>' + vacDoc.contact_phone + '</contact_phone><contact_email>' + vacDoc.contact_email + '</contact_email>' );
				_response_text.AppendStr( '<org_name>' + vacDoc.org_name + '</org_name>' );
				_response_text.AppendStr( '<start_date>' + _vac.creation_date + '</start_date>' );
				_response_text.AppendStr( '</vacancy>' );
			}
			_response_text.AppendStr( '</vacancies></GetVacanciesResponse></Body></Envelope>' );
			break;
		
		case 'RejectVacancyResponse':
			curUser = getUserByAuthData( Request.Form.login, Request.Form.password )	
			try
			{
				curUser.Name;
			}
			catch(err)
			{
				_response_text.AppendStr( '<Envelope><Body><Fault><faultcode>2</faultcode><faultstring>' + curUser +' </faultstring></Fault></Body></Envelope>' );
				break;
			}
			
			try
			{
				Request.Form.response_id;
			}
			catch(err)
			{
				_response_text.AppendStr( '<Envelope><Body><Fault><faultcode>3</faultcode><faultstring>Отстутствует поле response_id</faultstring></Fault></Body></Envelope>' );
				break;
			}
			try
			{
				responseDoc = OpenDoc( UrlFromDocID( Int( Request.Form.response_id ) ) );
			}
			catch(err)
			{
				_response_text.AppendStr( '<Envelope><Body><Fault><faultcode>3</faultcode><faultstring>Отклик с ID ' + Request.Form.response_id + 'не найден</faultstring></Fault></Body></Envelope>' );
				break;
			}
			
			responseDoc.TopElem.status = "rejected";
			responseDoc.Save();
			tools.create_notification("estaff_api_001", responseDoc.DocID)
			_response_text.AppendStr( '<Envelope><Body><RejectVacancyResponseResponse></RejectVacancyResponseResponse></Body></Envelope>' );
			break;
		
		default:
			_error = 701;				
			throw 'unknown command';
	}
alert(_response_text.GetStr())	
	Response.WriteBinary( _response_text );
%>