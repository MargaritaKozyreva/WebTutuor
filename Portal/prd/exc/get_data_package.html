<%
Server.Execute( 'server_init.html' );

reportDoc = OpenNewDoc( 'x-local://wtv/wtv_action_report.xmd' );
reportDoc.BindToDb(DefaultDb);
reportDoc.TopElem.create_date = Date();
reportDoc.TopElem.type = 'get_data_package';
reportDoc.TopElem.exchange_server_id = curExchangeServerID;

_report_id = reportDoc.DocID;
_package_id = Random( 1, 4000000000 );
	
reportDoc.TopElem.report_text = Date() + ' Package ID: ' + _package_id + '.\n';
reportDoc.Save();

try
{
	_filename = tools.create_data_package( curExchangeServerID, _report_id, _package_id, tools.get_exchange_date( curExchangeServer.upload, curExchangeServer.last_upload_date ) );
	
	_res_flag = true;
	if ( StrContains( _filename, '#false#' ) )
	{
		_filename = StrReplace( _filename, '#false#', '' );
		_res_flag = false;
	}
	
	bin = new Binary;	
	bin.LoadFromUrl( _filename );
	
	Response.ContentType = "application/binary";	
	Response.AddHeader( "Content-Disposition", "attachment; filename=" + UrlFileName( _filename ) );
	Response.WriteBinary( bin );
	
	curExchangeServer.last_upload_date = Date();
	curExchangeServerDoc.Save();
}
catch ( dd )
{
	tools.add_report( _report_id, dd );
	throw dd;
}

reportDoc = OpenDoc( UrlFromDocID( _report_id ) );
reportDoc.TopElem.report_text += Date() + ' Finish processing.';
reportDoc.TopElem.completed = true;
reportDoc.Save();
%>