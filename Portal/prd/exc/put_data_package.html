<%
Server.Execute( 'server_init.html' );

reportDoc = OpenNewDoc( 'x-local://wtv/wtv_action_report.xmd' );
reportDoc.BindToDb(DefaultDb);
reportDoc.TopElem.create_date = Date();
reportDoc.TopElem.type = 'put_data_package';
reportDoc.TopElem.exchange_server_id = curExchangeServerID;

_report_id = reportDoc.DocID;
_package_id = Random( 1, 4000000000 );

_file_name = 'download_' + curExchangeServer.code + '_' + tools.date_str() + '_' + _package_id + '.zip';
_file_url = 'x-local://download_data/' + _file_name;
	
_report = 'ID package: ' + _package_id + '.\n';
_report += _report + Date() + ' Start loading.\n';
reportDoc.TopElem.report_text = _report;
reportDoc.TopElem.data_file_url = _file_url;

try
{
	PutUrlData( _file_url, Request.Form.data );
	
	reportDoc.TopElem.report_text += Date() + ' Save data: OK.\n';
	reportDoc.Save();
	
	if ( tools.package_process( _file_url, 'objects', curExchangeServer, _report_id, curExchangeServerID ) == null )
		throw 'package process failed';
	
	reportDoc = OpenDoc( UrlFromDocID( _report_id ) );
	reportDoc.TopElem.report_text = reportDoc.TopElem.report_text + Date() + ' Data processing: OK.';
	reportDoc.TopElem.completed = true;
	reportDoc.Save();
	
    if ( common_variables.basics.ChildByKeyExists( curExchangeServerID ) )
    {
        _child = common_variables.basics.GetChildByKey( curExchangeServerID );

        if ( _child.server_version.HasValue )
          curExchangeServer.server_version = _child.server_version;
          
        _child.Delete();
        common_variables.Doc.Save();
    }
	
	curExchangeServer.last_download_date = Date();
	curExchangeServerDoc.Save();
}
catch ( dd )
{
	tools.add_report( _report_id, dd );
	throw dd;
}

%>