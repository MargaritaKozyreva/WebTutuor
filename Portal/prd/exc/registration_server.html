<%
Response.WriteMode = 'single';
try
{
	if ( Request.AuthLogin == '' || Request.AuthPassword == '' )
		throw 'invalid login or password';
}
catch( ehu )
{
	Response.SetWrongAuth();
	Cancel();
}

docReport = OpenNewDoc( 'x-local://wtv/wtv_action_report.xmd' );
docReport.BindToDb(DefaultDb);
docReport.TopElem.create_date = Date();
docReport.TopElem.type = 'registration_server';


_report = Date() + ' Start time.\n';
_report = _report + Date() + ' Current server code: ' + Request.AuthLogin + '.\n';
docReport.TopElem.report_text = _report;

query = XQuery( "for $elem in exchange_servers where $elem/code = " + XQueryLiteral( String( Request.AuthLogin ) ) + " return $elem" );

_resp_text = '';	
if ( ArrayOptFirstElem( query ) != undefined )
	_resp_text = 'ERROR=1\nERROR_TEXT=Exchange server with current code is already exists.\n';

if ( ! Request.Form.HasProperty( 'settings' ) || Trim( Request.Form.settings ) == '' )
	_resp_text = 'ERROR=2\nERROR_TEXT=Exchange server settings is empty.\n';
	
try
{
	settingsDoc = OpenDocFromStr( Request.Form.settings, 'form=x-local://wtv/wtv_exchange_server.xmd' ).TopElem;
}
catch ( ee )
{
	_resp_text = 'ERROR=3\nERROR_TEXT=Exchange server settings is failed.\n';
}

if ( _resp_text != '' )
{
	tools.add_report( docReport.DocID, 'Response: ' + _resp_text + Date() + ' Finish time.', docReport );
	Response.Write( _resp_text );
	Cancel();
}

docExchangeServer = OpenNewDoc( 'x-local://wtv/wtv_exchange_server.xmd' );
exchangeServerDoc = docExchangeServer.TopElem;
exchangeServerDoc.is_active = false;
exchangeServerDoc.code = settingsDoc.code;
exchangeServerDoc.name = settingsDoc.name;
exchangeServerDoc.server_password = settingsDoc.server_password;
exchangeServerDoc.upload.AssignElem( settingsDoc.download );
exchangeServerDoc.download.AssignElem( settingsDoc.upload );
if ( Request.Form.HasProperty( 'server_version' ) )
	exchangeServerDoc.server_version = Request.Form.server_version;
	
if ( Request.Form.HasProperty( 'current_url' ) )
{
	exchangeServerDoc.upload.http_server_url = Request.Form.current_url;
	exchangeServerDoc.download.http_server_url = Request.Form.current_url;
}

docExchangeServer.BindToDb(DefaultDb);
docExchangeServer.Save();

ms_tools.raise_system_event( 'portal_registration_exchange_server', null, docExchangeServer.DocID, docExchangeServer );

_resp_text = 'ERROR=0\n';
docReport.TopElem.completed = true;
tools.add_report( docReport.DocID, 'Response: ' + _resp_text + Date() + ' Finish time.', docReport );
Response.Write( _resp_text );
%>