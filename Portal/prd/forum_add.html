<%
Server.Execute( "include/sid_access_init.html" );

function HtmlReplace( _str )
{
	_str = StrReplace( _str, '\n', '<br/>' );

	for ( _smile in curLngCommon.forum_smile_types )
		_str = StrReplace( _str, _smile.id, "[img]" + _smile.url + "[/img]" );

	return tools_web.convert_xss( _str );
}

try
{
	_icon_id = ArrayOptFindByKey( curLngCommon.forum_icon_types, Request.Form.icon, "url" ).id;
}
catch ( e )
{
	_icon_id = 1;
}

// проверка подлинности пользователя при редактировании 
if ( Request.Form.forum_entry_id > 0 && 
		(
			!tools_web.is_privilege_collaborator( Request.Form.forum_entry_id, curUser, curUserID ) || 
			tools_web.check_forum_entry_access( docParentForumEntry.TopElem, curUser, curUserID )
		)
	) 
{
	Server.Execute( "view_access_panel.html" );
	Cancel();
}

forumID = Int( Request.Form.forum_id );
try
{
	forumDoc = OpenDoc( UrlFromDocID( forumID ) ).TopElem;
}
catch(_err_)
{
	Response.Write("Forum " + forumID + " is deleted or malfunction. Abort operation.");
	Cancel();
}

curMainForumEntryID = Request.Form.HasProperty( "main_forum_entry_id" ) && Request.Form.main_forum_entry_id != "" ? Int( Request.Form.main_forum_entry_id ) : null;
isNewTopic = false;

bIsModerator = tools_web.is_moderator_forum(forumID, curUserID, forumDoc);

curPage = Request.Form.HasProperty( 'cur_page' ) && Request.Form.cur_page != '' ? Int( Request.Form.cur_page ) : 1;
viewType = Request.Form.HasProperty( 'view_type' ) ? Request.Form.view_type : '';


if ( Request.Form.forum_entry_id != "" )
{
	docForumEntry = OpenDoc( UrlFromDocID( Int( Request.Form.forum_entry_id ) ) );

	// проверяем не была ли закрыта тема перед редактированием
	if ( docForumEntry.TopElem.closed.HasValue && docForumEntry.TopElem.closed == true ) 
	{
		Server.Execute( "view_access_panel.html" );
		Cancel();
	}
}
else
{
	isNewTopic = true;
	docForumEntry = OpenNewDoc( 'x-local://wtv/wtv_forum_entry.xmd' );
	docForumEntry.BindToDb( DefaultDb );
	if ( Request.Form.HasProperty( 'parent_forum_entry_id' ) && Request.Form.parent_forum_entry_id != '' )
	{
		docParentForumEntryID = Int( Request.Form.parent_forum_entry_id );
		docForumEntry.TopElem.parent_forum_entry_id = docParentForumEntryID;

		docParentForumEntry = OpenDoc( UrlFromDocID( docParentForumEntryID ) );
		docParentForumEntry.TopElem.last_create_date = Date();
		docParentForumEntry.Save();
	}
}

if ( Request.Form.HasProperty( 'pinned' ) )
  docForumEntry.TopElem.pinned = Request.Form.pinned;

docForumEntry.TopElem.forum_id = forumID;
docForumEntry.TopElem.icon_id = _icon_id;
docForumEntry.TopElem.name = tools_web.convert_xss( Request.Form.title );


// если топик не новый, то при редактировании не нужно перетирать информацию 
// о создателе или способе отображения
isEditAuthor = false;
if ( docForumEntry.TopElem.user_id.HasValue )
{
	isEditAuthor = docForumEntry.TopElem.user_id == curUserID;
}
else 
{
	docForumEntry.TopElem.user_id = curUserID;
	if ( forumDoc.allow_anonymous_message )
		docForumEntry.TopElem.how2show = Request.Form.how2show;
}

if ( isEditAuthor ) 
{
	docForumEntry.TopElem.person_fullname = curUser.fullname;
	docForumEntry.TopElem.how2show = Request.Form.how2show;
}

docForumEntry.TopElem.text_area = HtmlReplace( Request.Form.content );
docForumEntry.TopElem.last_create_date = Date();
docForumEntry.TopElem.remote_ip = Request.RemoteIP;
docForumEntry.TopElem.is_moder_approved = bIsModerator;

try
{
	tools_web.web_files_process( docForumEntry.TopElem );
}
catch ( e )
{
	alert( e );
}

// очистить список привилигированных пользователей и заполнить его заново
// но только для редактирования Темы (не топика)
if ( Request.Form.parent_forum_entry_id == '' && Request.Form.HasProperty( 'selected_object_ids' ) && Request.Form.selected_object_ids != '' ) 
{
	docForumEntry.TopElem.privilege_collaborators.Clear();
	for ( personID in Request.Form.selected_object_ids.split(';') ) 
	{
		if ( personID == "" ) 
			continue;

		personID = Int( personID );
		privPerson = docForumEntry.TopElem.privilege_collaborators.ObtainChildByKey( personID );
		privPerson.person_fullname = privPerson.collaborator_id.ForeignElem.fullname;
	}

	// добавить себя если не нашли в списке, но только если определен список пользователей
	privPerson = docForumEntry.TopElem.privilege_collaborators.ObtainChildByKey( curUserID );
	privPerson.person_fullname = curUser.fullname;
}

docForumEntry.Save();

// перед сохранением, убираем флаг ПРОЧИТАННОСТИ для комбинации (форум/тема) для всех пользователей
// только для создателя Темы/Топика оставляем пометку о ПРОЧТЕНИИ

if ( curMainForumEntryID != null )
{
    readArray = XQuery( 'for $read in forum_theme_read_by_collaborators where $read/forum_theme_id = '+ curMainForumEntryID + ' return $read' );
    for ( read in readArray ) 
	    DeleteDoc( UrlFromDocID( read.id ), ! global_settings.settings.save_deleted_in_trash );
}

readDoc = OpenNewDoc( 'x-local://wtv/wtv_forum_theme_read_by_collaborator.xmd' );
readTop = readDoc.TopElem;
readTop.forum_id = forumID;
// если curMainForumEntryID == 0 значит создаеться новая Тема
readTop.forum_theme_id = ( curMainForumEntryID == null ) ? docForumEntry.DocID : curMainForumEntryID;
readTop.person_id = curUserID;
readDoc.BindToDb( DefaultDb );
readDoc.Save();


if ( isNewTopic )
	try
	{
		for ( _moderator in ArraySelect( forumDoc.moderators, "moderator_id != " + curUserID ) )
			tools.create_notification( "8", docForumEntry.DocID, "", _moderator.moderator_id );
	}
	catch(err)
	{
		alert(err);
	}

/*
_group_array = XQuery( 'for $group in group_collaborators where $group/collaborator_id = ' + curUserID + ' and $group/forum_id = ' + Request.Form.forum_id + ' return $group' );
for ( _group in _group_array )
	if ( _group.tutor_id.HasValue && _group.tutor_id != curUserID )
		tools.create_notification( '8', _group.id );
*/
		
tools.submit_subscriptions( forumID, null, curUserID );
if ( curMainForumEntryID != null )
	tools.submit_subscriptions( curMainForumEntryID, null, curUserID );

tools.update_forum_entry( docForumEntry );

if ( Request.Form.noheader == '1' )
	Response.Redirect( ( Request.Form.forum_entry_id == '' ? 'view_forum_body.html?' : 'view_forum_entry_body.html?entry_id=' + Request.Form.forum_entry_id + '&' ) + 'object_id=' + Request.Form.forum_id + '&noheader=' + '&cur_page=' + curPage );
else 
	Response.Redirect( 'view_doc.html?mode=forums&object_id=' + Request.Form.forum_id + '&entry_id=' + curMainForumEntryID + '&doc_id=' + Request.Form.doc_id + '&cur_page=' + curPage + '&view_type=' + viewType );
%>