<%
Server.Execute( 'include/user_init.html' );
// убедимся что эту страничку пользователь может просматривать
if ( curUser.access.access_role != 'admin' ) 
{
	Server.Execute( "view_access_panel.html" );
	Cancel();
}
if ( Request.Form.HasProperty( 'saved_forum_id' ) ) 
{ // пришел запрос на сохранение форума
	forum = null;

	if ( Request.Form.saved_forum_id == '' ) 
	{
		// нужно создать новый форум
		forum = OpenNewDoc( 'x-local://wtv/wtv_forum.xmd' );
		//tools.common_filling
		forum.TopElem.doc_info.creation.date = Date();
		forum.TopElem.doc_info.creation.user_login = curUser.login;
		forum.TopElem.name = Request.Form.name;
		forum.BindToDb( DefaultDb );
		forum.Save();

		catalog = ArrayFirstElem( curDoc.catalogs );
		newItem = catalog.objects.AddChild();
		newItem.object_id = forum.DocID;
		try
		{
			_cur_doc = OpenDoc( UrlFromDocID( curDocID ) );
			_field = _cur_doc.TopElem.catalogs.GetChildByKey( "forum" );
			_field.objects.ObtainChildByKey( forum.DocID );                 
			_cur_doc.Save();
		}
		catch(x){}
	} 
	else 
	{
		// был отредактирован существующий форум
		forum = OpenDoc( UrlFromDocID( Int( Request.Form.saved_forum_id ) ) );
		forum.TopElem.name = Request.Form.name;
		
	}
	forum.TopElem.moderators.DeleteChilds( true );

	for ( moderator_id in Request.Form.selected_object_ids.split( ';' ) ) 
	{
		if ( Trim( moderator_id ) == '' ) continue;
		moderator = forum.TopElem.moderators.AddChild();
		moderator.moderator_id = moderator_id;
		tools.common_filling( 'collaborator', moderator, moderator_id, OpenDoc( UrlFromDocID( Int( moderator_id ) ) ).TopElem );
	}
	forum.Save();
}
%>
