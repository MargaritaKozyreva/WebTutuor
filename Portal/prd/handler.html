<%
/*
AICC Handler Version 2.5.41 (2011.03.22)
(c) 2005-2011 WebSoft Development
*/

try
{
//alert('start');
_session_id = Int( ArrayFirstElem( String( Request.Query.session_id ).split( '-' ) ) );
connection = ArrayFirstElem( XQuery( 'for $elem in connections where $elem/id = ' + _session_id + ' return $elem' ) );

switch ( connection.state )
{
	case 'deleted':
		Response.Write( "ERROR=3\r\n" );
		Cancel();
		break;

	case 'finished':
		Response.Write( "ERROR=0\r\nERROR_TEXT=Course is completed.\r\n" );
		Cancel();
		break;
}

learningDoc = OpenDoc( UrlFromDocID( connection.active_learning_id ) );
learningType = learningDoc.TopElem.Name == 'active_test_learning' ? 'test' : 'course';
partCode = connection.part_code;

if ( learningType == 'test' )
{
	activePart = learningDoc.TopElem;
	refScore = activePart.cur_score;
	refScoreStr = activePart.cur_score_str;
	refStateId = activePart.cur_state_id;
}
else
{
	activePart = learningDoc.TopElem.parts.GetChildByKey( partCode );
	if ( activePart.type == 'test' )
	{
		learningType = 'test_course';
		refScore = activePart.cur_score;
		refScoreStr = activePart.cur_score_str;
		refStateId = activePart.cur_state_id;
	}
	else
	{
		learningType = 'course';
		refScore = activePart.score;
		refScoreStr = activePart.score_str;
		refStateId = activePart.state_id;
	}
}

try
{

switch ( StrLowerCase( Request.Query.command ) )
{
	case "getparam":
//alert('getparam');
		_write_str = new Binary;
		_write_str.AppendStr( "ERROR=0\r\nAICC_DATA=\r\n[CORE]\r\nTIME=" );
		_write_str.AppendStr( activePart.time.HasValue ? StrInt( activePart.time / 3600000, 2 ) + ":" + StrInt( ( activePart.time % 3600000 ) / 60000, 2 ) + ":" + StrReal( ( activePart.time % 60000 ) / 1000.0, 3 ) : "00:00:00" );
		_write_str.AppendStr( "\r\nSTUDENT_NAME=" );
		_write_str.AppendStr( UrlEncode( EncodeCharset( connection.user_fullname, 'utf-8' ) ) );
		_write_str.AppendStr( "\r\nSTUDENT_ID=" );
		_write_str.AppendStr( connection.user_id );
		_write_str.AppendStr( "\r\nLESSON_LOCATION=" );
		_write_str.AppendStr( activePart.lesson_location );
		_write_str.AppendStr( "\r\nLESSON_STATUS=" );
		_write_str.AppendStr( common.learning_states.GetChildByKey( refStateId.Value ).short_descriptor );
		_write_str.AppendStr( "\r\nSCORE=" );
		_write_str.AppendStr( refScoreStr.Value );
		_write_str.AppendStr( "\r\n[CORE_LESSON]\r\n" );
		if ( activePart.core_lesson.HasValue )
		{
			_write_str.AppendStr( learningDoc.TopElem.no_encoding_core_lesson ? StrSimpleDecrypt( activePart.core_lesson ) : UrlEncode( StrSimpleDecrypt( activePart.core_lesson ) ) );
			_write_str.AppendStr( "\r\n" );
		}

		if ( learningType == 'course' )
		{
			for ( _field in activePart.data_lesson )
				if ( _field.Name != 'objectives_status' && _field.Name != 'evaluation' )
					_write_str.AppendStr( _field );

			if ( activePart.objectives.ChildNum != 0 )
			{
				_write_str.AppendStr( '[OBJECTIVES_STATUS]\r\n' );
				if ( activePart.scoring_type == 'aicc' )
				{
					iCounter = 1;
					for ( flgObjectiveElem in activePart.objectives )
					{
						_write_str.AppendStr( 'j_id.' + iCounter + '=' + flgObjectiveElem.PrimaryKey + '\r\n' );
						if ( flgObjectiveElem.score.HasValue )
							_write_str.AppendStr( 'j_score.' + iCounter + '=' + ( flgObjectiveElem.score.HasValue ? flgObjectiveElem.score : flgObjectiveElem.score.raw + ',' + flgObjectiveElem.score.min + ',' + flgObjectiveElem.score.max + ',' + flgObjectiveElem.score.scaled ) + '\r\n' );
						if ( flgObjectiveElem.status.HasValue )
							_write_str.AppendStr( 'j_status.' + iCounter + '=' + flgObjectiveElem.status + '\r\n' );
						iCounter++;
					}
				}
				else
				{
					_write_str.AppendStr( UrlEncode( activePart.objectives.Xml ) );
				}
			}
			if ( activePart.interactions.ChildNum != 0 )
			{
				_write_str.AppendStr( '[EVALUATION]\r\n' );
				_write_str.AppendStr( UrlEncode( activePart.interactions.Xml ) );
			}
		}
		else
		{
			_write_str.AppendStr( "[EVALUATION]\r\nQTI_FILE=" + ( Request.QueryString.HasProperty( 'qti_dir' ) && Request.QueryString.qti_dir == '1' ? '' : '/' ) + "qti_return.html?atl=" + connection.active_learning_id + "&code=" + partCode + "\r\nPUTTIMER=Q\r\n" );
		}
//alert('end getparam');
//alert(_write_str.GetStr());
		Response.Write( _write_str.GetStr() );
		break;


	case "putparam":
//alert('putparam');
//alert('Request.Query.aicc_data='+Request.Query.aicc_data);
		if ( learningDoc.TopElem.Name == 'learning' || connection.state == 'saved' )
		{
			Response.Write( "ERROR=0\r\n" );
			Cancel();
		}

		if ( learningType == 'course' )
		{
			blockArray = Array('core','core_lesson','core_vendor','comments','evaluation','objectives_status','student_data','student_preferences','student_demographics');
			blockObject = Array();
			blockObjectCount = 0;

			for ( _block in blockArray )
			{
				index = Request.Query.aicc_data.indexOf( '[' + _block + ']' );
				if ( index >= 0 )
				{
					blockObject[ blockObjectCount ] = new Object;
					blockObject[ blockObjectCount ].name = _block;
					blockObject[ blockObjectCount ].index = index;
					blockObjectCount++;
				}
			}
			blockObject = ArraySort( blockObject, 'This.index', '+' );

			for ( i=0; i<blockObjectCount; i++ )
			{
				_cur_name = blockObject[ i ].name;
				if ( i + 1 < blockObjectCount )
					_cur_value = StrRangePos( Request.Query.aicc_data, blockObject[ i ].index, blockObject[ i + 1 ].index );
				else
					_cur_value = StrRightRangePos( Request.Query.aicc_data, blockObject[ i ].index );

				switch ( _cur_name )
				{
					case 'core':
						param = OpenDocFromStr( _cur_value, 'format=win.ini' ).TopElem;
						break;

					case 'core_lesson':
						activePart.core_lesson = StrSimpleEncrypt( Trim( StrRightRangePos( _cur_value, 13 ) ) );
						break;

					case 'objectives_status':
						sObjectivesBlock = Trim( StrRightRangePos( _cur_value, 19 ) );
						if ( sObjectivesBlock == '' )
							break;

						sObjectivesBlock = UrlDecode( sObjectivesBlock );

						if ( StrBegins( sObjectivesBlock , 'j_id', true ) )
						{
							activePart.scoring_type = 'aicc';
							fldObjectiveChild = null;
							for ( fldLineElem in OpenDocFromStr( sObjectivesBlock, 'format=win.ini' ).TopElem )
							{
								arrName = StrRightRangePos( fldLineElem.Name.split( '.' )[ 0 ], 2 );

								switch ( arrName )
								{
									case 'id':
										fldObjectiveChild = activePart.objectives.ObtainChildByKey( fldLineElem );
										break;

									case 'score':
										fldObjectiveChild.score.Value = fldLineElem + ( fldObjectiveChild.score.HasValue ? ';' + fldObjectiveChild.score.Value : '' );
										if ( fldObjectiveChild.score.HasValue )
										{
											iPartCounter = 0;
											for ( sScorePartElem in String( fldLineElem ).split( ',' ) )
											{
												try
												{
													if ( Trim( sScorePartElem ) != '' )
														fldObjectiveChild.score.Child( iPartCounter ).Value = Real( sScorePartElem );
												}
												catch ( err )
												{
												}
												iPartCounter++;
											}
										}
										break;

									default:
										fldObjectiveChild.Child( arrName ).Value = fldLineElem;
										break;
								}
							}
						}
						else
						{
							activePart.scoring_type = 'scorm';
							for ( fldLineElem in OpenDocFromStr( sObjectivesBlock, 'form=x-local://wtv/wtv_form_objectives.xmd' ).TopElem )
							{
								fldObjectiveChild = activePart.objectives.ObtainChildByKey( fldLineElem.PrimaryKey );
								fldObjectiveChild.AssignElem( fldLineElem );
							}
						}
						break;

					case 'evaluation':
						_cur_value = UrlDecode( Trim( StrRightRangePos( _cur_value, 12 ) ) );
						if ( _cur_value != '' && StrBegins( _cur_value , '<interactions>' ) )
						{
							activePart.scoring_type = 'scorm';
							for ( fldLineElem in OpenDocFromStr( _cur_value, 'form=x-local://wtv/wtv_form_interactions.xmd' ).TopElem )
							{
								fldInteractionChild = activePart.interactions.ObtainChildByKey( fldLineElem.PrimaryKey );
								fldInteractionChild.AssignElem( fldLineElem );
							}
						}
						break;

					default:
						activePart.data_lesson.Child( _cur_name ).Value = _cur_value;
						break;
				}
			}
		}
		else
		{
			pos = Request.Query.aicc_data.indexOf( '[CORE_LESSON]\r\n' );
			param = OpenDocFromStr( StrRangePos( Request.Query.aicc_data, 0, pos ), 'format=win.ini' ).TopElem;
			activePart.core_lesson = StrSimpleEncrypt( StrRightRangePos( Request.Query.aicc_data, pos + 15 ) );
		}
//alert(param.Xml)

		refStateId.Value = 1;
		if ( learningType == 'test_course' && activePart.state_id == 0 )
			activePart.state_id = 1;

		activePart.last_usage_date = CurDate;
		if ( ! activePart.start_usage_date.HasValue )
			activePart.start_usage_date = CurDate;

		if ( learningDoc.TopElem.ChildExists( 'last_usage_part_code' ) )
			learningDoc.TopElem.last_usage_part_code = partCode;

		if ( param.core.ChildExists( 'score' ) )
		try
		{
			_score = StrReplace( param.core.score, ' ', '' );
			refScoreStr.Value = _score;
			_score_arr = _score.split( ',' );
			_score_row = _score_arr[0];
			if ( _score_arr[0] == '' && ArrayCount( _score_arr ) >= 4 && _score_arr[3] != '' )
			{
				_score_scaled = Real( _score_arr[3] );
				_score_min = _score_arr[2] == '' ? 0.0 : Real( _score_arr[2] );
				_score_max = _score_arr[1] == '' ? 100.0 : Real( _score_arr[1] );
				_score_row = StrReal( _score_min + ( ( _score_max - _score_min ) * _score_scaled ), 2 );
			}
			if ( _score_row != '' )
				refScore.Value = Real( _score_row );
		}
		catch ( e )
		{
			alert( e );
		}

		if ( param.core.ChildExists( 'lesson_location' ) )
			activePart.lesson_location = param.core.lesson_location;

		if ( param.core.ChildExists( 'time' ) )
		try
		{
			timeArray = Trim( param.core.time );
			if ( timeArray != '' )
			{
				_time = null;
				sTimeType = 'scorm';
				if ( StrBegins( timeArray, 'P' ) )
				{
					_time = 0;
					index = timeArray.indexOf( 'T' );
					lastIndex = index > 0 ? index + 1 : 1;

					index = timeArray.indexOf( 'H', lastIndex );
					if ( index > 0 )
					{
						_time += Real( StrRangePos( timeArray, lastIndex, index ) ) * 3600000;
						lastIndex = index + 1;
					}
					index = timeArray.indexOf( 'M', lastIndex );
					if ( index > 0 )
					{
						_time += Real( StrRangePos( timeArray, lastIndex, index ) ) * 60000;
						lastIndex = index + 1;
					}
					index = timeArray.indexOf( 'S', lastIndex );
					if ( index > 0 )
						_time += Real( StrRangePos( timeArray, lastIndex, index ) ) * 1000;
				}
				else
				{
					sTimeType = 'aicc';
					timeArray = timeArray.split( ':' );
					switch ( ArrayCount( timeArray ) )
					{
						case 3:
							_time = Real( timeArray[0] ) * 3600000 + Real( timeArray[1] ) * 60000 + Real( timeArray[2] ) * 1000;
							break;

						case 2:
							_time = Real( timeArray[0] ) * 60000 + Real( timeArray[1] ) * 1000;
							break;

						case 1:
							_time = Real( timeArray[0] ) * 1000;
							break;
					}
				}
				if ( _time != null )
					activePart.time = sTimeType == 'aicc' && activePart.time.HasValue ? activePart.time + _time : _time;
			}
		}
		catch ( e )
		{
			alert( e );
		}

		st = '';
		try
		{
			st = StrLowerCase( StrLeftRange( Trim( param.core.lesson_status ), 1 ) );
		}
		catch ( e )
		{
		}

		if ( st != '' )
		{
			_state = common.learning_states.GetOptChildByKey( st, 'short_descriptor' );
			if ( _state != undefined )
				refStateId.Value = _state.PrimaryKey.Value;
		}

		if ( learningType == 'test' )
		{
			activePart.score = activePart.cur_score;
			activePart.score_str = activePart.cur_score_str;
			activePart.state_id = activePart.cur_state_id;
		}

		if ( st == 'c' || st == 'f' || st == 'p' )
		{
			sLearningState = '';
			if ( learningType == 'test' || learningType == 'test_course' )
			{
				bAttemptFlag = tools.active_test_learning_finish_attempt( learningDoc.DocID, partCode, null, true, learningDoc );
				sLearningState = 'deleted';

				if ( ! activePart.ChildExists( 'expert_eval' ) || ! activePart.expert_eval )
				{
					if ( ! bAttemptFlag && partCode == '' )
						DeleteDoc( UrlFromDocID( learningDoc.DocID ), ! global_settings.settings.save_deleted_in_trash );
					else
						sLearningState = 'saved';
				}
			}

			if ( learningType != 'test' )
			{
				courseDoc = OpenDoc( UrlFromDocID( connection.course_id ) ).TopElem;
				curCoursePart = courseDoc.parts.GetChildByKey( partCode );

				if ( curCoursePart.set_status_side == 'lms' )
					activePart.state_id = curCoursePart.mastery_score.HasValue ? ( refScore.Value < curCoursePart.mastery_score ? 3 : 4 ) : 2;

				learningDoc.TopElem.view.course_object = courseDoc;
				learningDoc.Save();

				if ( courseDoc.auto_finish )
					if ( learningDoc.TopElem.state_id == 2 || learningDoc.TopElem.state_id == 4 || ( courseDoc.finish_without_mastery_score && learningDoc.TopElem.score >= courseDoc.mastery_score ) )
					{
						tools.active_learning_finish( learningDoc.DocID, learningDoc.TopElem, courseDoc );
						sLearningState = 'finished';
					}
			}

			if ( sLearningState != '' )
				try
				{
					docConnection = OpenDoc( UrlFromDocID( connection.id ) );
					docConnection.TopElem.state = sLearningState;
					docConnection.Save();
				}
				catch ( e )
				{
					alert( e );
				}
		}
		else
		{
			learningDoc.Save();
		}
//alert(learningDoc.TopElem.Xml);
//alert('end putparam')
		Response.Write( "ERROR=0\r\n" );
		break;


	case "exitau":
		Response.Write( "ERROR=0\r\n" );
		break;


	default:
		Response.Write( "ERROR=1\r\n" );
		break;
}

}
catch ( err2 )
{
	if ( ! IsCancelError( err2 ) )
	{
		alert( err2 );
		Response.Write( "ERROR=2\r\n" );
	}
}


}
catch ( err )
{
	if ( ! IsCancelError( err ) )
	{
		alert( err );
		Response.Write( "ERROR=3\r\n" );
	}
}
%>