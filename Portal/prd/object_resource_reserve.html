<%
	Server.Execute( "include/sid_access_init.html" );
	
	try
	{
		startDate = Date( Trim( Request.Form.event_start_date + ' ' + Request.Form.event_start_time ) );
	}
	catch ( err )
	{
		startDate = Date( DateNewTime( Date() ) + ' 09:00' );
	}
	try
	{
		finishDate = Date( Trim( Request.Form.event_finish_date+ ' ' + Request.Form.event_finish_time ) );
	}
	catch ( err )
	{
		finishDate = Date( DateNewTime( Date() ) + ' 18:00' );
	}
	startHour = Hour( startDate );
	finishHour = Hour( finishDate );
	
	curObjectResourceArray = XQuery( "for $elem in event_phases where $elem/object_resource_id = " + curObjectID + " and $elem/finish_date > date( '" + startDate + "' ) and $elem/start_date < date( '" + finishDate + "' ) return $elem" );
	for ( _day in curObjectResourceArray )
		if ( Hour( _day.start_date ) < finishHour && Hour( _day.finish_date ) > startHour )
		{
			Response.Redirect( "view_doc.html?mode=object_resource&object_id=" + curObjectID + "&m=1&doc_id=" + curDocID );
			Cancel();
		}
	
	curEventDoc = OpenNewDoc( 'x-local://wtv/wtv_event.xmd' );
	curEventDoc.WriteDocInfo = false;
	curEvent = curEventDoc.TopElem;
	
	curEvent.name = ( Request.Form.event_name != '' ? Request.Form.event_name : curObject.name );
	curEvent.code = Request.Form.event_code;
	curEvent.type_id = Request.Form.event_type;
	curEvent.place_id = curObject.place_id;
	curEvent.place = curObject.name;
	curEvent.is_public = Request.Form.HasProperty( 'event_is_public' );
	curEvent.is_open = Request.Form.HasProperty( 'event_is_open' );
	curEvent.start_date = startDate;
	curEvent.finish_date = finishDate;
	try
	{
		curEvent.max_person_num = Int( Request.Form.event_person_num );
	}
	catch ( err )
	{
	}
	try
	{
		if ( curEvent.type_id == 'education_method' && Request.Form.event_education_method != '' )
			curEvent.education_method_id = Int( Request.Form.event_education_method );
	}
	catch ( err )
	{
	}
	curEvent.comment = Request.Form.event_desc;
	
	
	_tutor = curEvent.tutors.ObtainChildByKey( curUserID );
	tools.common_filling( 'collaborator', _tutor, curUserID, curUser );
	
	_object_resource = curEvent.object_resources.ObtainChildByKey( curObjectID );

//////////////////////////////////////////////////////////////////////////////////////	
	curEvent.custom_elems.ObtainChildByKey( 'request_initiator' ).value = Request.Query.event_initiator;
	
	
	curEvent.create_event_phases();
	curEvent.filling_event_phases();
	
	
	curEvent.doc_info.creation.date = Date();
	curEvent.doc_info.creation.user_login = curUser.login;
	curEventDoc.BindToDb( DefaultDb );
	curEventDoc.Save();

	
	_ids = XQuery( "for $doc in documents where $doc/code = 'requests' return $doc" );
	_id = ( ArrayCount( _ids ) > 0 ? ArrayFirstElem( _ids ).id : curDocID );

	_redirect_mode = 'requests';
	if ( Request.QueryString.HasProperty( 'redirect_mode' ) )
		_redirect_mode = Request.QueryString.redirect_mode;


	requestTypeArray = XQuery( "for $elem in request_types where $elem/code = 'reserve_object_resourse' return $elem" );
	
	if ( ArrayCount( requestTypeArray ) == 0 )
	{
		Response.Redirect( "view_doc.html?mode=requests&doc_id=" + _id );
		Cancel();
	}

	requestTypeDocID = ArrayFirstElem( requestTypeArray ).id;
	requestTypeDoc = OpenDoc( UrlFromDocID( requestTypeDocID ) ).TopElem;

	requestDoc = OpenNewDoc( 'x-local://wtv/wtv_request.xmd' );
	requestDoc.WriteDocInfo = false;
	requestDoc.TopElem.comment = Request.Form.event_desc;
	tools.common_filling( 'request_type', requestDoc.TopElem, requestTypeDocID, requestTypeDoc );

	requestDoc.TopElem.person_id = curUserID;
	tools.common_filling( 'collaborator', requestDoc.TopElem, curUserID, curUser );


////////////////////////////////////////////////////////////////////////////////////////	
	if ( requestDoc.TopElem.type.HasValue )
	{
		requestDoc.TopElem.object_id = curEventDoc.DocID;
		tools.object_filling( requestDoc.TopElem.type, requestDoc.TopElem, curEventDoc.DocID );
	}
	
	
//////////////////////////////////////////////////////////////////////////////////////	
	requestDoc.TopElem.custom_elems.ObtainChildByKey( 'request_initiator' ).value = Request.Query.event_initiator;
	
	

	if ( ! requestDoc.TopElem.workflow_id.HasValue )
		requestDoc.TopElem.workflow_id = requestTypeDoc.workflow_id;
	

	requestDoc.TopElem.doc_info.creation.date = Date();
	requestDoc.TopElem.doc_info.creation.user_login = curUser.login;
	requestDoc.BindToDb( DefaultDb );
	requestDoc.Save();

//////////////////////////////////////////////////////////////////////////////////////////
	tools.create_notification( 'reserve_object_resource_create', requestDoc.DocID );
	
	Response.Redirect( "view_doc.html?mode=requests&m=1&doc_id=" + _id );
%>