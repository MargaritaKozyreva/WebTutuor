<%
        curObjectID = Int( Request.Form.object_id );
        curDoc = OpenDoc( UrlFromDocID( curObjectID ) );
        curObject = curDoc.TopElem;
        curDocID = Int( Request.Form.doc_id );
        if ( Request.Form.GetProperty( "status" ) != 'cancel'  && curObject.person_id == Int( Request.Form.user_id ) )
        {
            i=1;
            while ( i <= 5 )
            {
                _ref = Request.Form.GetProperty( "file" + i);
                _refstr = Request.Form.GetProperty( "comment" + i);
                try
                {
                    if ( ! _ref.FileName.HasValue )
                    {
                        i++;
                        continue;
                     }
                           
                    if ( curObject.files.ChildNum < i )
                        _file = curObject.files.AddChild();                    
                    else
                    {
                        _file = curObject.files.Child( i-1 );
                        _ofe = _file.file_id.OptForeignElem;
                        if ( _ofe != undefined )
                        {
                            if ( _file.file_id.ForeignElem.use_count <= 0 )
                            {
                                if ( global_settings.settings.delete_unused_resource )
                                    ms_tools.delete_resource( _file.file_id );
                            }
                            else
                            {
                                doc = OpenDoc( UrlFromDocID( _file.file_id ) );
                                doc.TopElem.use_count = doc.TopElem.use_count - 1;
                                doc.Save();
                            }
                        }
                     
                     }
                    doc = OpenNewDoc( 'x-local://wtv/wtv_resource.xmd' );
                    doc.BindToDb( DefaultDb );
                    doc.TopElem.put_str( _ref, _ref.FileName, curObject );
                    _file.file_id = doc.DocID; 
                    doc.TopElem.comment = _refstr;  
                    doc.Save();
                    i++;   
                }
                catch(ee)
                {
                    i++;
                }        
            }
       if ( Request.Form.HasProperty( "desc" ))       
   		    curObject.desc =  Request.Form.GetProperty( "desc" ); 
       }
   if ( Request.Form.HasProperty( "com_general" ))
   {
		if (Request.Form.GetProperty( "com_general" )!='0')
   		curObject.general_mark = Request.Form.GetProperty( "com_general" );
		else
		curObject.general_mark = null;

   }
   if ( Request.Form.HasProperty( "com_generalstr" ))
   {
   		curObject.general_mark = Request.Form.GetProperty( "com_generalstr" );
   }
   if ( Request.Form.HasProperty( "mark_value" + curObjectID ))
   {
   		_mark = ArrayOptFirstElem( ArraySelect( curObject.marks, 'collaborator_id==' + Request.Form.user_id));
        if ( _mark == undefined )
        {
        	_mark = curObject.marks.AddChild();
            _mark.collaborator_id = Request.Form.user_id;
            tools.common_filling( 'collaborator', _mark, _mark.collaborator_id );
        }
        _mark.value =  Request.Form.GetProperty( "mark_value" + curObjectID );
        if ( Request.Form.HasProperty( "mark_desc" + curObjectID ))
            _mark.desc =  Request.Form.GetProperty( "mark_desc" + curObjectID );
   }
   if ( Request.Form.HasProperty( "combo_mark_value" + curObjectID ) && Request.Form.GetProperty( "combo_mark_value" + curObjectID )!='0')
   {
   		_mark = ArrayOptFirstElem( ArraySelect( curObject.marks, 'collaborator_id==' + Request.Form.user_id));
        if ( _mark == undefined )
        {
        	_mark = curObject.marks.AddChild();
            _mark.collaborator_id = Request.Form.user_id;
            tools.common_filling( 'collaborator', _mark, _mark.collaborator_id );
        }
		if (Request.Form.GetProperty( "combo_mark_value" + curObjectID )!='0')
   	        _mark.value =  Request.Form.GetProperty( "combo_mark_value" + curObjectID );
		else
		_mark.value = null;
        if ( Request.Form.HasProperty( "mark_desc" + curObjectID ))
            _mark.desc =  Request.Form.GetProperty( "mark_desc" + curObjectID );
   }
   if ( Request.Form.HasProperty( "vote_value" + curObjectID ))
   {
   		_mark = ArrayOptFirstElem( ArraySelect( curObject.marks, 'collaborator_id==' + Request.Form.user_id));
        if ( _mark == undefined )
        {
        	_mark = curObject.marks.AddChild();
            _mark.collaborator_id = Request.Form.user_id;
            tools.common_filling( 'collaborator', _mark, _mark.collaborator_id );
        }
   	          _mark.value =  Request.Form.GetProperty( "vote_value" + curObjectID );
        if ( Request.Form.HasProperty( "vote_desc" + curObjectID ))
            _mark.desc =  Request.Form.GetProperty( "vote_desc" + curObjectID );
   }
   if ( Request.Form.HasProperty( "combo_vote_value" + curObjectID ) && Request.Form.GetProperty( "combo_vote_value" + curObjectID )!='0')
   {
   		_mark = ArrayOptFirstElem( ArraySelect( curObject.marks, 'collaborator_id==' + Request.Form.user_id));
        if ( _mark == undefined )
        {
        	_mark = curObject.marks.AddChild();
            _mark.collaborator_id = Request.Form.user_id;
            tools.common_filling( 'collaborator', _mark, _mark.collaborator_id );
        }
        _mark.value =  Request.Form.GetProperty( "combo_vote_value" + curObjectID );
		if (Request.Form.GetProperty( "combo_vote_value" + curObjectID )!='0')
   	          _mark.value =  Request.Form.GetProperty( "combo_vote_value" + curObjectID );
		else
		_mark.value = null;
        if ( Request.Form.HasProperty( "vote_desc" + curObjectID ))
        if ( Request.Form.HasProperty( "vote_desc" + curObjectID))
            _mark.desc =  Request.Form.GetProperty( "vote_desc" + curObjectID);
   }
   try
   {
       if ( Request.Form.HasProperty( "rating" ))
       {
            curObject.rating = Real( Request.Form.GetProperty( "rating" ));
       }
   }catch(ee){}
   try
   {
       if ( Request.Form.HasProperty( "place" ))
       {       
            curObject.place = Int( Request.Form.GetProperty( "place" ));
       }
   }catch(ee){}

   		_sum = 0;
		_num = ArrayCount( curObject.marks );
		_num = 0;
		if ( curObject.contest_id.ForeignElem.estimation_id == 'com_general' )
		{
			 curObject.rating =  curObject.general_mark;
		}
		else
		{
			for ( _mark in  curObject.marks )
			{
				if (_mark.value !=null && _mark.value !='')
				{
				_sum = _sum + Real( _mark.value );
				_num++;
				}
			}
			curObject.rating = ( _num > 0 ? ( _sum/_num ) : null );
		}

   curObject.status_id =  Request.Form.GetProperty( "status" );   
   curDoc.Save();

   
	Response.Redirect( "view_doc.html?mode=contest&object_id="+curObject.contest_id+"&doc_id="+curDocID );
%>