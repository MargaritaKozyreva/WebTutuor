<%
	Server.Execute( "include/user_init.html" );

	//alert("!! START SAVING !!!");

	docResponse = OpenDoc( UrlFromDocID( Int(Request.Form.assessment_plan_id) ) );

	count = 0;
	
	curAssessmentAppraiseID = docResponse.TopElem.assessment_appraise_id;
	curAssessmentAppraise = OpenDoc( UrlFromDocID( curAssessmentAppraiseID )).TopElem;
	
	/* ---=== IMPERSONATE BLOCK ===--- */	
	try
	{
		Session.ImpersonatePersonID = Int(Session.ImpersonatePersonID);
	}
	catch(_no_trace_)
	{
		Session.ImpersonatePersonID = null;
	}
	arrImpersonates = ArraySelect(curAssessmentAppraise.impersonate_persons, "impersonator_id == " + curUserID + " && face_person_id.HasValue && (from_date.HasValue == false || from_date <= DateNewTime(Date())) && (to_date.HasValue == false || to_date >= DateNewTime(Date()))");
	
	if (Session.ImpersonatePersonID != null && ArrayOptFind(arrImpersonates, "face_person_id == " + Session.ImpersonatePersonID) != undefined)
		_bIsFakePerson = true;
	else
		_bIsFakePerson = false;
	
	if (_bIsFakePerson)
	{
		curPersonID = Session.ImpersonatePersonID;
		curPerson = OpenDoc(UrlFromDocID(curPersonID)).TopElem;
		Session.ImpersonatePersonID = curPersonID;
	}
	else
	{
		curPersonID = curUserID;
		curPerson = curUser;
		Session.ImpersonatePersonID = null;
	}
	
	/* ---=== ================= ===--- */
		
	if (global_settings.settings.check_wf_access_assessment)
	{
		curAssessmentPlan = docResponse.TopElem;
		Server.Execute( "view_assessment_access_variables.html" );
		if (IS_MODIFY == false)
		{
			Response.Redirect( "view_doc.html" );
			Cancel();
		}
	}
	
    _participant_code = Request.Form.role;
    
	if (Request.Form.HasProperty("comment"))
		comment = Request.Form.comment;
	else
		comment = '';
	
	if (Request.Form.HasProperty("save_comment") && Request.Form.GetProperty("save_comment") == "1")
		docResponse.TopElem.comment = comment;
	else
		tools_ass.place_pa_comment( docResponse, curPersonID, docResponse.TopElem.workflow_state, comment);
	
	isflawed = (Request.Form.isflawed);
	
    _ppp = curAssessmentAppraise.participants.GetOptChildByKey(_participant_code);
    if (_ppp != undefined)
    	_is_custom_expert = _ppp.customize.is_custom_experts;
    else
    	_is_custom_expert = false;
    
	i = 0;
	docResponse.TopElem.experts.DeleteChilds('status == _participant_code');
	while (Request.Form.HasProperty("identifier_" + i))
	{
    	_wannabe_expert = docResponse.TopElem.experts.ObtainChildByKey(Request.Form.GetProperty("identifier_" + i));
		_wannabe_expert.status = _participant_code;
        _wannabe_expert.is_custom = _is_custom_expert;
		i++;
	}	
	
	if (isflawed =="1")
		docResponse.TopElem.is_done = false;
	else
		docResponse.TopElem.is_done = true;
					
	_href = 'view_doc.html?mode=assessment_appraise&doc_id=' + Request.Form.doc_id +'&assessment_plan_id='+docResponse.DocID + '&assessment_appraise_id=' + Request.Form.assessment_appraise_id +'&f_id=' + Random(0, 9999999);
	if (Request.Form.HasProperty("is_post") && Request.Form.GetProperty("is_post") == "1")
	_href = _href + '&is_post=1';
	
	docResponse.Save();
		
	Response.Redirect( _href );
%>