<%
Server.Execute( 'include/user_init.html' );

curUserObj = OpenDoc( UrlFromDocID( curUserID ) );
curUser = curUserObj.TopElem;

if ( Request.Form.HasProperty( 'filename' ) && Request.Form.GetProperty( 'filename' ) != "") {
	_data_ref = Request.Form.GetProperty( 'filename' );
	bytes = StrLen( _data_ref );
	// если размер картинки больше 10  б выдать сообщение об ошибке
	if (bytes >= 10240) {
		avatarError = tools.get_web_str("upi_avatar_too_big");
		
	} else {
	  // определ€ем расширение файла
  	fileName = String(_data_ref.FileName);
	  dots = fileName.split(".")
  	//get the part AFTER the LAST period.
		fileType = dots[dots.length-1];
	  if (fileType!='jpg' && fileType!='jpeg' && fileType!='gif' && fileType!='png') {
  	  avatarError = tools.get_web_str("upi_avatar_wrong_type");
  	} else {
		  localFile = curUserID+'.'+fileType;
		  xLocalFile = 'x-local://wt/web/avatars/'+localFile;
		  PutUrlData( xLocalFile, _data_ref ); 
		  fileSize = UrlFileSize( xLocalFile );

		  curUser.personal_config.avatar_filename = localFile;
  	}
	}
}
if ( Request.QueryString.HasProperty( 'remove_avatar' ) ) 
{
	localFile = curUser.personal_config.avatar_filename;
	xLocalFile = 'x-local://wt/web/avatars/'+localFile;
	DeleteUrl(xLocalFile);
	curUser.personal_config.avatar_filename = "";
	Response.Redirect("view_doc.html?mode=personal_info&doc_id=" + Request.QueryString.GetProperty("doc_id") );
}
if ( Request.Form.HasProperty( 'nick' ) ) 
{
	newNick = Request.Form.nick;
	isNickUniqArray = XQuery('for $user in collaborators where $user/personal_config/nick = "'+newNick+'" and $user/id != '+curUserID+' return $user');
	isNickUniq = (ArrayOptFirstElem(isNickUniqArray) == undefined);
	if (isNickUniq) 
	{
	  curUser.personal_config.nick = Request.Form.nick;
	} else {
		nickError = tools.get_web_str("upi_nick_not_uniq");
	}
}
curUserObj.Save();
%>