<%
curPollID = Int( Request.Form.poll_id );
curPoll = OpenDoc( UrlFromDocID( curPollID ) ).TopElem;	
sViewMode = Request.Form.view_mode;
docPollResult = null;
curDocID = Request.Query.HasProperty( 'doc_id' ) && Request.Query.doc_id != '' ? Int( Request.Query.doc_id ) : null;

if(curPoll.is_anonymous || sViewMode == "CREATE")
{
	docPollResult = OpenNewDoc( 'x-local://wtv/wtv_poll_result.xmd' );
	docPollResult.BindToDb( DefaultDb );
	docPollResult.TopElem.poll_id = curPollID;
}
if ( curPoll.is_anonymous )
{
	curUserID = null;
	docPollResult.TopElem.person_id = 0;
	docPollResult.TopElem.person_fullname = 'Anonymous';
	docPollResult.TopElem.create_date = Date();
}
else
{
	Server.Execute( "include/user_init.html" );
	
	try
	{
		curSid = Request.Query.sid;

		if ( ! tools.check_sum_sid( curPollID, curSid ) )
			throw '_crack_fuck_';
	}
	catch ( ehuu )
	{
		Server.Execute( "view_access_panel.html" );
		Cancel();
	}
	catCurUserResult = undefined;
	if(sViewMode == "CREATE")
	{
		docPollResult.TopElem.person_id = curUserID;
		tools.common_filling( 'collaborator', docPollResult.TopElem, curUserID, curUser );
		docPollResult.TopElem.poll_id = curPollID;
		docPollResult.TopElem.create_date = Date();
	}
	else if(sViewMode == "EDIT" || sViewMode=="DELETE")
	{	 
		catCurUserResult = ArrayOptFirstElem(XQuery( "for $elem in poll_results where $elem/poll_id = " + curPollID + " and $elem/person_id = " + curUserID + " return $elem"));
		if(catCurUserResult != undefined)
		{
			if(sViewMode == "EDIT")
			{
				docPollResult = OpenDoc( UrlFromDocID( catCurUserResult.id ) );
			}
			else
			{
				DeleteDoc( UrlFromDocID( catCurUserResult.id ) );   
				Response.Redirect( "view_doc.html?doc_id=" + curDocID );
				Cancel();
			}
		}
	}
	if ( ( ( curPoll.start_date.HasValue && CurDate < curPoll.start_date ) || ( curPoll.end_date.HasValue && CurDate > curPoll.end_date ) )
		||
		( curPoll.is_one_time && (catCurUserResult != undefined) && (!(curPoll.allow_change && sViewMode == "EDIT"))))
	{
		alert(curPoll.is_one_time && !(curPoll.allow_change && sViewMode == "EDIT"));
		Response.Redirect( "view_doc.html" );
		Cancel();
	}
}


_counter = 0;	
for ( _question in curPoll.questions )
{
	if ( _question.type == 'title' )
		continue;

	_str = '';
	if ( _question.type == 'select' )
	{
		for ( _entry in _question.entries )
			if ( Request.Form.HasProperty( 'q' + _question.id + '_' + _entry.id ) )
			{
				_str += _entry.id + ';';
				_counter++;
			}
	}
	else
	{
		if ( Request.Form.HasProperty( 'q' + _question.id ) )
		{
			_str = Request.Form.GetProperty( 'q' + _question.id );
			_counter++;
		}
	}


	if ( _str != '' )
	{
		_save_question = docPollResult.TopElem.questions.ObtainChildByKey( _question.id );
		_save_question.value =  tools_web.convert_xss( _str );
			
		if (_question.add_comment)
		{
			if (Request.Form.HasProperty("q" + _question.id +"_comment"))
				_save_question.comment = Request.Form.GetProperty("q" + _question.id +"_comment");
		}
		else
			_save_question.comment.Clear();
			
		//docPollResult.TopElem.questions.ObtainChildByKey( _question.id ).value = tools_web.convert_xss( _str );
	}
}
if ( _counter != 0 )
{
	docPollResult.Save();
}

if ( curUserID == null && Request.AuthLogin == '' )
	Response.Redirect( "default.html" );
else
	Response.Redirect( "view_doc.html?doc_id=" + curDocID );
%>