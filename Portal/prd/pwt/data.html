<%
Response.WriteMode = 'single';

//alert('Start data');

if ( ! global_settings.disp_pwt )
{
	Response.Write('ERROR=10');
	Cancel();
}

try
{
	curUserID = ArrayFirstElem( XQuery( "for $elem in collaborators where $elem/lowercase_login = " + XQueryLiteral( StrLowerCase( UrlDecode( Request.Form.login ) ) ) + " return $elem" ) ).id;
	curUser = OpenDoc( UrlFromDocID( curUserID ) ).TopElem;
}
catch ( err )
{
	Response.Write('ERROR=2');
	Cancel();
}

if ( ! Request.Form.HasProperty( 'password' ) || tools.make_password( curUser.password, true ) != tools.make_password( Request.Form.password, false ) )
{
	Response.Write('ERROR=3');
	Cancel();
}

reportDoc = OpenNewDoc( 'x-local://wtv/wtv_action_report.xmd' );
reportDoc.BindToDb( DefaultDb );
reportDoc.TopElem.create_date = Date();
reportDoc.TopElem.type = 'pwt_to_wt';

try
{
	reportDoc.TopElem.report_text = 'User login: ' + Request.Form.login + '.\n';
}
catch ( dd )
{
}
reportDoc.Save();

_report_text = tools.import_pwt_data_xml( Request.Form.data, curUserID, reportDoc.DocID );
Response.Write( _report_text );

Cancel();
%>