<%
Server.Execute( "include/access_init.html" );

_id = ArrayOptFirstElem( XQuery( "for $doc in documents where $doc/code = 'requests' return $doc" ) );
_id = _id == undefined ? curDocID : _id.id;

_redirect_mode = Request.QueryString.HasProperty( 'redirect_mode' ) ? Request.QueryString.redirect_mode : 'requests';

requestTypeID = Int( Request.Form.request_type_id );
requestTypeDoc = OpenDoc( UrlFromDocID( requestTypeID ) ).TopElem;

if ( requestTypeDoc.object_type.HasValue )
	if ( ! global_settings.settings.recruitment.default_request_type_id.HasValue || requestTypeID != global_settings.settings.recruitment.default_request_type_id )
	{
		_object_id = Request.Form.HasProperty( 'object_id' ) && Request.Form.object_id != '' ? Request.Form.object_id : 'null()';
		if ( ArrayOptFirstElem( XQuery( "for $request in requests where $request/person_id = " + curUserID + " and $request/object_id = " + _object_id + " and $request/request_type_id = " + Request.Form.request_type_id + " and $request/status_id = 'active' and $request/is_group = false() return $request" ) ) != undefined 
			||
			ArrayOptFirstElem( XQuery( "for $request in requests where $request/person_id = " + curUserID + " and $request/object_id = " + _object_id + " and $request/request_type_id = " + Request.Form.request_type_id + " and $request/status_id = 'plan' and $request/is_group = false() return $request" ) ) != undefined )
		{
			Response.Redirect( "view_doc.html?mode=" + _redirect_mode + "&m=3&doc_id=" + _id );
			Cancel();
		}
	}

requestDoc = OpenNewDoc( 'x-local://wtv/wtv_request.xmd' );
if ( Request.Query.HasProperty( 'comment' ) )
{
	curComment = tools_web.convert_xss( Request.Query.comment );
	switch ( curHostSettings.default_portal_type )
	{
		case 'sharepoint':
			requestDoc.TopElem.comment = DecodeCharset( curComment, 'utf-8' );
			break;
		default:
			requestDoc.TopElem.comment = curComment;
			break;
	}
}
tools.common_filling( 'request_type', requestDoc.TopElem, requestTypeID, requestTypeDoc );

requestDoc.TopElem.person_id = curUserID;
tools.common_filling( 'collaborator', requestDoc.TopElem, curUserID, curUser );

if ( requestDoc.TopElem.type.HasValue )
{
	requestDoc.TopElem.object_id = curObjectID;
	tools.object_filling( requestDoc.TopElem.type, requestDoc.TopElem, curObjectID, curObject );

	tools.admin_access_copying( "", requestDoc.TopElem,  curObjectID );
}

if ( ! requestDoc.TopElem.workflow_id.HasValue )
	requestDoc.TopElem.workflow_id = requestTypeDoc.workflow_id;

try
{
	tools_web.web_custom_elems_filling( 'request', null, requestDoc.TopElem, Request.Form );
}
catch ( e )
{
	alert( e );
}

if ( requestTypeDoc.is_can_be_group && Request.Form.HasProperty( 'is_group' ) && Request.Form.selected_object_ids != '' )
{
	requestDoc.TopElem.is_group = true;
	
	for ( _pers in Trim( Request.Form.selected_object_ids ).split( ';' ) )
		if ( _pers != '' )
			try
			{
				_child = requestDoc.TopElem.persons.ObtainChildByKey( Int( _pers ) );
				tools.common_filling( 'collaborator', _child, Int( _pers ) );
			}
			catch ( err )
			{
				alert( err );
			}
}
else
{
	requestDoc.TopElem.is_group = false;
}

requestDoc.BindToDb( DefaultDb );
requestDoc.Save();

ms_tools.raise_system_event( 'portal_create_request', null, null, requestDoc );
tools.create_notification( '1', requestDoc.DocID );

Response.Redirect( "view_doc.html?mode=" + _redirect_mode + "&m=1&doc_id=" + _id );
%>