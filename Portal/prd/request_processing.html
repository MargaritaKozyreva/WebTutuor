<%Server.Execute( "include/sid_access_init.html" )%>

<%
	_pay_type = Request.Form.pay_type;

	try
	{
	for ( _org_req in String( Request.Form.pay_text ).split( '|' ) )
	{
		_org_arr = _org_req.split( ':' );
		
		if ( ArrayCount( _org_arr ) < 2 )
			continue;
		
		_amount = 0.;
		for ( _req in _org_arr[1].split( '&' ) )
			try
			{
				docRequest = OpenDoc( UrlFromDocID( Int( _req ) ) );
				_price = OpenDoc( UrlFromDocID( docRequest.TopElem.object_id ) ).TopElem.price;
				
				if ( _price != null )
					_amount = _amount + _price;
				
				if ( _pay_type == 'account' )
				{
					docRequest.TopElem.status_id = 'pay';
					docRequest.Save();
				}
				else
				{
					if ( _price != null )
					{					
						_invoce_id = tools.personal_pay( Int( _org_arr[0] ), Int( _req ) );			
						tools.create_notification( '4', _invoce_id );
					}
				}
			}
			catch ( i )
			{
				alert( i );		
			}
			
		if ( ! ( _amount > 0. ) )
			continue;		
		
		if ( _pay_type == 'account' )
			tools.pay_courses( Int( _org_arr[0] ), _amount, tools.get_web_str('rp_comment') );
					
		if ( Request.Form.group_id != 'non' )
		{
			docGroup = OpenDoc( UrlFromDocID( Int( Request.Form.group_id ) ) );
			docGroup.TopElem.collaborators.ObtainChildByKey( docRequest.TopElem.person_id );
			docGroup.Save();
		}
	}
	}
	catch ( f )
	{
		alert( f );
	}

	
	try
	{
	for ( _org_req in String( Request.Form.start_text ).split( '|' ) )
	{
		_org_arr = _org_req.split( ':' );		
		
		if ( ArrayCount( _org_arr ) < 2 )
			continue;		
				
		for ( _req in _org_arr[1].split( '&' ) )
			try
			{
				docRequest = OpenDoc( UrlFromDocID( Int( _req ) ) );
				
				if ( docRequest.TopElem.status_id != 'pay' )
					continue;
					
				docLearning = OpenNewDoc( 'x-local://wtv/wtv_active_learning.xmd' );
				docLearning.TopElem.AssignElem( docRequest.TopElem );
				docLearning.TopElem.course_id = docRequest.TopElem.object_id;
			
				courseDoc = OpenDoc( UrlFromDocID( docRequest.TopElem.object_id ) ).TopElem;
				docLearning.TopElem.parts.AssignElem( courseDoc.parts );
				tools.common_filling( 'course', docLearning.TopElem, docRequest.TopElem.object_id, courseDoc );
				
				docLearning.BindToDb( DefaultDb );	
				docLearning.Save();
				
				docRequest.TopElem.status_id = 'close';
				docRequest.TopElem.close_date = Date();
				docRequest.Save();
				
				tools.create_notification( '2', Int( _req ) );
			}
			catch ( i )
			{
				alert( i );
			}
	}
	}
	catch ( f )
	{
		alert( f );
	}
	
	
	try
	{
	for ( _org_req in String( Request.Form.ignor_text ).split( '|' ) )
	{
		_org_arr = _org_req.split( ':' );
		
		if ( ArrayCount( _org_arr ) < 2 )
			continue;		
				
		for ( _req in _org_arr[1].split( '&' ) )
			try
			{
				docRequest = OpenDoc( UrlFromDocID( Int( _req ) ) );
				
				if ( docRequest.TopElem.status_id == 'active' )
				{
					docRequest.TopElem.status_id = 'ignore';
					docRequest.Save();
					
					tools.create_notification( '3', Int( _req ) );
				}
			}
			catch ( i )
			{
				alert( i );
			}
	}
	}
	catch ( f )
	{
		alert( f );
	}
	

	Response.Redirect( "view_doc.html?mode=hrm_requests&doc_id=" + Request.Form.doc_id );
%>