<%
	Server.Execute( "include/user_init.html" );

	if (Request.Query.HasProperty("assessment_appraise_id"))
		assessment_appraise_id = Int(Request.Query.assessment_appraise_id);
	else
		assessment_appraise_id = undefined;
		
	if (Request.Query.HasProperty("identifier"))
		identifier = Request.Query.identifier;
	else
		identifier = undefined;
		
	if (Request.Query.HasProperty("objective_name"))
		o_name = Request.Query.objective_name;
	else
		o_name = '???';
		
	if (Request.Query.HasProperty("pa_id"))
		pa_id = Request.Query.pa_id;
	else
		pa_id = null;
		
	if (Request.Query.HasProperty("show_me")) show_me = Request.Query.show_me; else show_me = undefined;
	if (assessment_appraise_id != undefined && Request.Query.HasProperty("post") && Request.Query.post=="1")
	{
		
		/* ---=== IMPERSONATE BLOCK ===--- */
		curAssessmentAppraise = OpenDoc(UrlFromDocID(assessment_appraise_id)).TopElem;
		try
		{
			Session.ImpersonatePersonID = Int(Session.ImpersonatePersonID);
		}
		catch(_no_trace_)
		{
			Session.ImpersonatePersonID = null;
		}
		arrImpersonates = ArraySelect(curAssessmentAppraise.impersonate_persons, "impersonator_id == " + curUserID + " && face_person_id.HasValue && (from_date.HasValue == false || from_date <= DateNewTime(Date())) && (to_date.HasValue == false || to_date >= DateNewTime(Date()))");
		
		if (Session.ImpersonatePersonID != null && ArrayOptFind(arrImpersonates, "face_person_id == " + Session.ImpersonatePersonID) != undefined)
			_bIsFakePerson = true;
		else
			_bIsFakePerson = false;
		
		if (_bIsFakePerson)
		{
			curPersonID = Session.ImpersonatePersonID;
			curPerson = OpenDoc(UrlFromDocID(curPersonID)).TopElem;
			Session.ImpersonatePersonID = curPersonID;
		}
		else
		{
			curPersonID = curUserID;
			curPerson = curUser;
			Session.ImpersonatePersonID = null;
		}
		
		/* ---=== ================= ===--- */
		switch ( show_me )
		{
			case 'translate':		
				
				_i = 0;
				_x=0;
				
				_arr_2_kill = XQuery('for $objective_translate in objective_translates where $objective_translate/assessment_appraise_id = ' + assessment_appraise_id + ' and $objective_translate/translator_person_id = ' + curPersonID + ' and $objective_translate/translator_objective_id = \'' + identifier + '\' return $objective_translate');
				
				for(_victim in _arr_2_kill)
					DeleteDoc( UrlFromDocID( _victim.id ), true )
				
				while (Request.Form.HasProperty("translate$_recepient_" + _i))
				{
					_recepient_person = ArrayOptFirstElem(XQuery("for $elem in collaborators where $elem/id = " + Int(Request.Form.GetProperty("translate$_recepient_" + _i)) + " return $elem"));
					if (_recepient_person == undefined)
					{
						_i++; continue;
					}
	
					docObjectiveTranslate = OpenNewDoc( 'x-local://wtv/wtv_objective_translate.xmd' );
					
					docObjectiveTranslate.TopElem.assessment_appraise_id = assessment_appraise_id;
					
					docObjectiveTranslate.TopElem.translator_person_id = curPersonID;
					docObjectiveTranslate.TopElem.translator_person_fullname = curPerson.fullname;
					docObjectiveTranslate.TopElem.translator_objective_id = identifier;
					docObjectiveTranslate.TopElem.translator_objective_name = o_name;
					
					docObjectiveTranslate.TopElem.recipient_person_id = _recepient_person.PrimaryKey;
					docObjectiveTranslate.TopElem.recipient_person_fullname = _recepient_person.fullname;
					
					docObjectiveTranslate.TopElem.comment = UrlDecode(Request.Form.GetProperty("translate$_comment_" + _i));
					
					if (pa_id != null)
						docObjectiveTranslate.TopElem.translator_pa_id = pa_id;
					
					docObjectiveTranslate.BindToDb(DefaultDb);
					docObjectiveTranslate.Save();
										
					_i++;
					_x++;
				}
				Response.Write('<node translated="'+ _x +'"/>');
			break;
			case 'bind':
				if (Request.Query.HasProperty("translate$_objective") && Request.Query.HasProperty("translate$_person"))
				{
					if (Request.Query.GetProperty("translate$_objective") != "")
					{
						_res = ArrayFirstElem(XQuery(('for $objective_translate in objective_translates where $objective_translate/assessment_appraise_id = ' + assessment_appraise_id + ' and $objective_translate/translator_person_id = ' + Request.Query.GetProperty("translate$_person") + ' and $objective_translate/translator_objective_id = \'' + Request.Query.GetProperty("translate$_objective") + '\' and $objective_translate/recipient_person_id = ' + curPersonID + ' return $objective_translate')));
					
						_transDoc = OpenDoc(UrlFromDocID(_res.id));
						_transDoc.TopElem.recipient_objective_id = identifier;
						_transDoc.TopElem.recipient_objective_name = o_name;
						if (pa_id != null)
							_transDoc.TopElem.recipient_pa_id = pa_id;
						_transDoc.Save();
					}
					else
					{
						_res = XQuery(('for $objective_translate in objective_translates where $objective_translate/assessment_appraise_id = ' + assessment_appraise_id + ' and $objective_translate/recipient_objective_id = \'' + identifier + '\' and $objective_translate/recipient_person_id = ' + curPersonID + ' return $objective_translate'));
						
						if (ArrayCount(_res) > 0)
						{
							_transDoc = OpenDoc(UrlFromDocID(ArrayFirstElem(_res).id));
							_transDoc.TopElem.recipient_objective_id.Clear();
							_transDoc.TopElem.recipient_objective_name.Clear();
							_transDoc.TopElem.recipient_pa_id.Clear();
							_transDoc.Save();
						}
					}
													
				}
				Response.Write('<node translated="1"/>');
			break;
		}

	}
	else
	{				
%>
<objective_translates>
<%
		if (Request.Query.HasProperty("boss_id"))
			boss_id = Int(Request.Query.boss_id);
		else
			boss_id = undefined;
	
		switch ( show_me )
		{
			case 'translated':
				_query = 'for $objective_translate in objective_translates where $objective_translate/assessment_appraise_id = ' + assessment_appraise_id + ' and $objective_translate/translator_person_id = ' + boss_id + ' and $objective_translate/translator_objective_id = \'' + identifier + '\' return $objective_translate';
			
				_objective_translates = XQuery( _query );
			
				for (_objective_translate in _objective_translates)
				{
%>
	<objective_translate id="<%=_objective_translate.translator_objective_id%>" name="<%=_objective_translate.translator_objective_name%>" recepient="<%=_objective_translate.recipient_person_id.ForeignElem.fullname%>" pa_id="<%_objective_translate.recipient_pa_id%>"/>
					
<%
				}
		
			break;
		
		}
%>
</objective_translates>
<%
	}
%>



