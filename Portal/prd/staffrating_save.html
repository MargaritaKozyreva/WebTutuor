<%
	Server.Execute( "include/user_init.html" );
	
	docPaResponse = OpenDoc( UrlFromDocID( Int(Request.Form.pa_id) ) )
	
	curAssessmentAppraiseID = docPaResponse.TopElem.assessment_appraise_id;
	curAssessmentAppraise = OpenDoc( UrlFromDocID( curAssessmentAppraiseID )).TopElem;
	
	/* ---=== IMPERSONATE BLOCK ===--- */	
	try
	{
		Session.ImpersonatePersonID = Int(Session.ImpersonatePersonID);
	}
	catch(_no_trace_)
	{
		Session.ImpersonatePersonID = null;
	}
	arrImpersonates = ArraySelect(curAssessmentAppraise.impersonate_persons, "impersonator_id == " + curUserID + " && face_person_id.HasValue && (from_date.HasValue == false || from_date <= DateNewTime(Date())) && (to_date.HasValue == false || to_date >= DateNewTime(Date()))");
	
	if (Session.ImpersonatePersonID != null && ArrayOptFind(arrImpersonates, "face_person_id == " + Session.ImpersonatePersonID) != undefined)
		_bIsFakePerson = true;
	else
		_bIsFakePerson = false;
	
	if (_bIsFakePerson)
	{
		curPersonID = Session.ImpersonatePersonID;
		curPerson = OpenDoc(UrlFromDocID(curPersonID)).TopElem;
		Session.ImpersonatePersonID = curPersonID;
	}
	else
	{
		curPersonID = curUserID;
		curPerson = curUser;
		Session.ImpersonatePersonID = null;
	}
	
	/* ---=== ================= ===--- */
	
	if (global_settings.settings.check_wf_access_assessment)
	{
		curPA = docPaResponse.TopElem;
		IS_HUMAN = !curPA.flag_appraise_department;
		
		_temp_assessment_plan = ArrayFirstElem(XQuery( 'for $assessment_plan in assessment_plans where $assessment_plan/assessment_appraise_id = ' + docPaResponse.TopElem.assessment_appraise_id +(IS_HUMAN ? ' and $assessment_plan/person_id = ' + curPA.person_id : ' and $assessment_plan/department_id = ' + curPA.department_id) + ' return $assessment_plan' ));
		
		if (curAssessmentAppraise.flag_use_plan)
		{
			curAssessmentPlanID = _temp_assessment_plan.id;
			curAssessmentPlan = OpenDoc( UrlFromDocID( curAssessmentPlanID ) ).TopElem;	
		}
		else
		{
			curAssessmentPlanID = docPaResponse.DocID;
			curAssessmentPlan = curPA;
		}
	
		Server.Execute( "view_assessment_access_variables.html" );
		if (IS_MODIFY == false)
		{
			Response.Redirect( "view_doc.html" );
			Cancel();
		}
	}
	
	
	
	isflawed = Request.Form.isflawed;
	_comment = ( Request.Form.HasProperty("comment") ? Request.Form.comment : '');
		
	if (Request.Form.HasProperty("field_i_types")) field_i_types = String(Request.Form.field_i_types).split("^"); else field_i_types = Array();
		
	if (Request.Form.HasProperty("field_i_ids")) field_i_ids = String(Request.Form.field_i_ids).split("^"); else field_i_ids = Array();
	
	if (Request.Form.HasProperty("field_i_names")) field_i_names = String(Request.Form.field_i_names).split("^"); else field_i_names = Array();
	
	if (Request.Form.HasProperty("field_i_scaletypes")) field_i_scaletypes = String(Request.Form.field_i_scaletypes).split("^"); else field_i_scaletypes = Array();
	
	if (Request.Form.HasProperty("field_i_identifiers")) field_i_identifiers = String(Request.Form.field_i_identifiers).split("^"); else field_i_identifiers = Array();
	
	if (Request.Form.HasProperty("field_i_weights")) field_i_weights = String(Request.Form.field_i_weights).split("^"); else field_i_weights = Array();
	
	if (Request.Form.HasProperty("field_i_plans")) field_i_plans = String(Request.Form.field_i_plans).split("^"); else field_i_plans = Array();
		
	if (Request.Form.HasProperty("field_i_periods")) field_i_periods = String(Request.Form.field_i_periods).split("^"); else field_i_periods = Array();
	
	if (Request.Form.HasProperty("field_i_facts")) field_i_facts = String(Request.Form.field_i_facts).split("^"); else field_i_facts = Array();
	
	if (Request.Form.HasProperty("field_i_marks")) field_i_marks = String(Request.Form.field_i_marks).split("^"); else field_i_marks = Array();
	
	
	if (Request.Form.HasProperty("field_modified_list")) field_modified_list = Request.Form.field_modified_list; else field_modified_list = '';
	
	if (Request.Form.HasProperty("workflow_fields_count") && Request.Form.GetProperty("workflow_fields_count") != "")
		workflow_fields_count = Int(Request.Form.GetProperty("workflow_fields_count"));
	else
		workflow_fields_count = 0;
	
	if (workflow_fields_count > 0)
	{
		wf_info = String(Request.Form.field_i_wfinfo).split("^");
		wf_values = String(Request.Form.field_i_wfvalues).split("^");
	}
	
	
	_objective = undefined;
	
	_ac = ArrayCount(field_i_types);
	
	_overall = null;
	
	docPaResponse.TopElem.objectives.Clear();
		
	if (_ac >= ArrayCount(field_i_identifiers))
		for (_i = 0; _i < _ac; _i++)
		{
			if ( field_i_types[_i] == "1" && field_i_identifiers[_i] != "")
			{
				_objective = docPaResponse.TopElem.objectives.ObtainChildByKey(field_i_identifiers[_i]);
				if (ArrayCount(field_i_names) > _i) _objective.name = field_i_names[_i];
				if (ArrayCount(field_i_weights) > _i && field_i_weights[_i] != "") _objective.weight = Real(field_i_weights[_i]);
				if (ArrayCount(field_i_marks) > _i && Trim(field_i_marks[_i]) != "") _objective.mark = Real(field_i_marks[_i]);
				
				if (_objective.weight.HasValue && _objective.mark.HasValue)
				{
					if (_overall == null) _overall = 0.0;
					_overall = _overall + (_objective.mark * _objective.weight / 100.0);
				}
				
				if (workflow_fields_count > 0 && ArrayCount(wf_info) > _i && String(wf_info[_i]) != "")
				{
					this_wf_info = String(wf_info[_i]).split("&|&");
					this_wf_values = String(wf_values[_i]).split("&|&");
					_z = 0;
					
					for (_this_wf_info in this_wf_info)
					{
						if (_this_wf_info != "")
						{
							_this_wf_info_open = String(_this_wf_info).split("$$$$");
							if (String(_this_wf_info_open[0]) != "")
							{
								_cur_wf = _objective.workflow_fields.ObtainChildByKey(_this_wf_info_open[0]);
								_cur_wf.field_group_id = _this_wf_info_open[1];
								_cur_wf.type = _this_wf_info_open[2];
								_cur_wf.title = _this_wf_info_open[3];
								_cur_wf.is_major = true;
								if (ArrayCount(this_wf_values) > _z)
									_cur_wf.value = this_wf_values[_z];
								else
									_cur_wf.value.Clear();
							}
						}
						_z++;
					}
					
				}
				
				
			}	
			else if (field_i_types[_i] == "0" && _objective != undefined)
			{
				_sub_objective = _objective.subobjectives.AddChild();
				if (ArrayCount(field_i_plans) > _i) _sub_objective.plan = field_i_plans[_i];
				if (ArrayCount(field_i_periods) > _i && field_i_periods[_i] != "") _sub_objective.date = Date(field_i_periods[_i]);
				if (ArrayCount(field_i_facts) > _i) _sub_objective.fact = field_i_facts[_i];
				if (ArrayCount(field_i_marks) > _i && field_i_marks[_i] != "") _sub_objective.mark = Real(field_i_marks[_i]);
				
				if (workflow_fields_count > 0 && ArrayCount(wf_info) > _i && String(wf_info[_i]) != "")
				{
					this_wf_info = String(wf_info[_i]).split("&|&");
					this_wf_values = String(wf_values[_i]).split("&|&");
					_z = 0;
					
					for (_this_wf_info in this_wf_info)
					{
						if (_this_wf_info != "")
						{
							_this_wf_info_open = String(_this_wf_info).split("$$$$");
							if (String(_this_wf_info_open[0]) != "")
							{
								_cur_wf = _sub_objective.workflow_fields.ObtainChildByKey(_this_wf_info_open[0]);
								_cur_wf.field_group_id = _this_wf_info_open[1];
								_cur_wf.type = _this_wf_info_open[2];
								_cur_wf.title = _this_wf_info_open[3];
								_cur_wf.is_major = false;
								if (ArrayCount(this_wf_values) > _z)
									_cur_wf.value = this_wf_values[_z];
								else
									_cur_wf.value.Clear();
							}
						}
						_z++;
					}
					
				}
				
			}
		
		}
	
	docPaResponse.TopElem.overall = _overall;
	
	docPaResponse.TopElem.temp = field_modified_list;
	
	qcount = (Request.Form.HasProperty("stq_count") ?  Int(Request.Form.stq_count) : 0);
	for (j = 0; j<qcount; j++)
	{
		try
		{
			q_id = Int(Request.Form.GetProperty("stq_id_" + j));
			teQ = OpenDoc(UrlFromDocID(q_id)).TopElem;
		}
		catch(_zhopa_)
		{
			continue;
		}
		
		if (teQ.type == "3")
		{
			q_mark = "";
			for (_scale in teQ.scales)
				if (Request.Form.GetOptProperty("stq_mark_" + j + "_" + _scale.id, "") == "1")
					q_mark += (q_mark != "" ? ";" : "") + _scale.id;
		}		
		else
			q_mark = Request.Form.GetOptProperty("stq_mark_" + j, "");
		_questions = docPaResponse.TopElem.supplementary_questions.ObtainChildByKey(q_id);
		_questions.supplementary_question_mark = q_mark;
	}
			
	_href = 'view_doc.html?mode=assessment_appraise&doc_id=' + Request.Form.doc_id +'&pa_id='+Request.Form.pa_id + '&assessment_appraise_id=' + Request.Form.assessment_appraise_id + '&assessment_appraise_type=' + Request.Form.assessment_appraise_type +'&f_id=' + Random(0, 9999999);
	if (Request.Form.HasProperty("is_post") && Request.Form.GetProperty("is_post") == "1")
	_href = _href + '&is_post=1';
	
	if (isflawed =="1")
		docPaResponse.TopElem.is_done = false;
	else
		docPaResponse.TopElem.is_done = true;
	
    if (curAssessmentAppraise.is_basic_comment)
		docPaResponse.TopElem.comment = _comment;
    else
    {
    	if (_comment == '')
        	_comment = null;
        
    	tools_ass.place_pa_comment( docPaResponse, curPersonID, undefined, _comment);
    }
	
	if (Request.Form.HasProperty("custom_post_web_template_id"))
	try
	{
		tools_web.insert_custom_code(Int(Request.Form.GetProperty("custom_post_web_template_id")), null,true,true);
	}
	catch(_oi_)
	{}
	
	docPaResponse.TopElem.flag_is_processed = true;
	docPaResponse.TopElem.appraise_date = Date();
	docPaResponse.Save();
			
	Response.Redirect( _href );
%>