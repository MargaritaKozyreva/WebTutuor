<%
Server.Execute( "include/access_init.html" );

try
{
	curSid = Request.Query.sid;
	if ( ! tools.check_sum_sid( curObjectID, curSid ) )
		throw '_crack_fuck_';
}
catch ( e )
{
	Server.Execute( "view_access_panel.html" );
	Cancel();
}

move_to = Request.Query.GetOptProperty( 'move_to', '' );
_code = Request.Query.GetOptProperty( 'code', '' );
_attempt_flag = Request.Query.GetOptProperty( 'attempt', '0' ) == '1';

_flag = tools.active_test_learning_finish_attempt( curObjectID, _code, null, _attempt_flag, curObjectDoc );

if ( ! curObject.ChildExists( 'expert_eval' ) || ! curObject.expert_eval )
	if ( _code == '' && ( ! _flag || ! _attempt_flag ) )
		DeleteDoc( UrlFromDocID( curObjectID ), ! global_settings.settings.save_deleted_in_trash );

_redirect = "view_doc.html"
try
{
	if ( _code == '' )
	{
		if ( _attempt_flag && _flag )
		{
			_redirect = "view_doc.html?mode=test_learning_proc&doc_id=" + curDocID + '&object_id=' + curObjectID + '&assessment_id=' + Request.Query.assessment_id;
		}
		else
		{
			switch ( move_to )
			{
				case 'test_learning':
				case 'active_test_learning':
					_doc_id = ArrayFirstElem( XQuery( "for $elem in documents where $elem/code = '" + move_to + "' return $elem" ) ).id;	
					_redirect = "view_doc.html?mode=" + move_to + "&doc_id=" + _doc_id;
					break;
			}
		}
	}
	else
	{
		_redirect = "view_doc.html?mode=learning_proc&doc_id=" + curDocID + '&object_id=' + curObjectID + '&course_id=' + curObject.course_id;
	}
}
catch ( e )
{
}
Response.Redirect( _redirect );
Cancel();
%>