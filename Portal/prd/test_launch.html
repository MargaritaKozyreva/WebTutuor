<%
Server.Execute( "include/user_init.html" );

curAssessmentID = Int( Request.Query.assessment_id );
curAssessment = OpenDoc( UrlFromDocID( curAssessmentID ) ).TopElem;

curSid = '';
switch ( curHostSettings.default_portal_type )
{
	case 'sharepoint':
		break;
		
	default:
		curErrorText = '';
		try
		{
			if ( global_settings.settings.check_sid )
			{
				try
				{
					curSid = Request.Query.sid;
				}
				catch ( ee )
				{
					curErrorText = 'SessionID is not init.';
					throw '_sid_fuck_';
				}
			
				if ( ! tools.check_sum_sid( curAssessmentID, curSid ) )
				{
					curErrorText = 'SessionID is not valid.';
					throw '_crack_fuck_';
				}
			}
			
			if ( ! tools_web.check_access( curAssessment, curUserID, curUser, Session ) )
				throw '_access_fuck_';
		}
		catch ( ehuu )
		{
//alert(ehuu);
			Server.Execute( "view_access_panel.html" );
			Cancel();
		}
		break;
}


if ( ! curAssessment.publish_url.HasValue )
{
	Response.Write( tools.get_web_str('tl_error1') );
	Cancel();
}
if ( ! FilePathExists( UrlToFilePath( UrlAppendPath( 'x-local://wt/web', curAssessment.publish_url ) ) ) )
{
	Response.Write( tools.get_web_str('tl_error2') );
	Cancel();
}
//( curUser.location == '' ? 'x-local://wt/web' : curUser.location )


try
{
	curObjectID = Int( Request.Query.object_id );
}
catch ( e )
{
	curObjectID = ArrayFirstElem( XQuery( 'for $active_learning in active_test_learnings where $active_learning/person_id = ' + curUserID + ' and $active_learning/assessment_id = ' + curAssessmentID + ' return $active_learning' ) ).id;
}

curObjectDoc = OpenDoc( UrlFromDocID( curObjectID ) );
curObject = curObjectDoc.TopElem;
if ( curObject.person_id != curUserID )
{
	Response.Redirect( "view_access_panel.html" );
	Cancel();
}

curActivationCode = ( Request.Query.HasProperty( 'activation_code' ) ? Request.Query.activation_code : '' );
if ( curAssessment.activation_code.HasValue && ! curObject.last_usage_date.HasValue && curActivationCode != curAssessment.activation_code )
{
	Response.Redirect( 'view_test_activation_code.html?assessment_id=' + curAssessmentID + '&object_id=' + curObjectID + '&sid=' + curSid + ( curActivationCode != '' && curActivationCode != curAssessment.activation_code ? '&m=1' : '' ) );
	Cancel();
}

saveFlag = false;
if ( ! curObject.start_learning_date.HasValue )
{
	curObject.start_learning_date = Date();
	saveFlag = true;
}

if ( ! curObject.qti_text.HasValue )
{
	if ( curAssessment.external_type.HasValue ) // * BBT *
	{
		if ( ! tools.test_external_type_filling( curObject, curAssessmentID, curAssessment ) )
		{
			Response.Write( 'ERROR of test external type filling.' );
			Cancel();
		}
	}
	else
	{
		_qti_str = qti_tools.qti_return( curAssessmentID, UrlParent( ( StrBegins( curAssessment.publish_url, 'x-local://' ) ? '' : 'x-local://wt/web' ) + curAssessment.publish_url ), curObject );
		
		if( StrEnds( _qti_str, '#failed#' ) )
		{
			Response.Write( _qti_str );
			Cancel();
		}
	}
	saveFlag = true;
}

if ( saveFlag )
	curObjectDoc.Save();

_last_date = DateOffset( Date(), 0-8640 );
connectionsArray = XQuery( 'for $elem in connections where $elem/creation_date < date(\'' + _last_date + '\') return $elem' );
for ( _connection in connectionsArray )
	try
	{
		DeleteDoc( UrlFromDocID( _connection.id ), true );
	}
	catch ( err )
	{
	}
	
docConnection = OpenNewDoc( 'x-local://wtv/wtv_connection.xmd' );
connectionDoc = docConnection.TopElem;
connectionDoc.active_learning_id = curObjectID;
connectionDoc.course_id = curAssessmentID;
connectionDoc.user_id = curUser.code;
connectionDoc.user_fullname = curUser.fullname;
docConnection.BindToDb(DefaultDb);
docConnection.Save();
_session_id = docConnection.DocID;


_tracking_url = tools_web.get_url_protocol( Request.Url ) + Request.UrlHost + "/handler.html";
_url = curAssessment.publish_url;

/*
if ( curUser.location != '' )
	_url = UrlAppendPath( curUser.location, _url );
*/	
	
_url += ( StrContains( _url, "?" ) ? "&" : "?" ) + "aicc_sid=" + _session_id + "&aicc_url=" + UrlEncode( _tracking_url ) 
			+ '&' + qti_tools.get_player_url_param( curAssessmentID, curAssessment );

//alert(_url);
Response.Redirect( _url );
%>