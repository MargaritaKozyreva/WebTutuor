<%
curLearningCode = Request.Query.code;
curCatalogLearning = ArrayFirstElem( XQuery( "for $active_learning in active_test_learnings where $active_learning/code = " + XQueryLiteral( String( curLearningCode ) ) + " return $active_learning" ) );

curUserID = curCatalogLearning.person_id;
curUser = OpenDoc( UrlFromDocID( curUserID ) ).TopElem;

curAssessmentID = curCatalogLearning.assessment_id;
curAssessment = OpenDoc( UrlFromDocID( curAssessmentID ) ).TopElem;


if ( curAssessment.publish_url == '' )
{
	Response.Write( tools.get_web_str('tl_error1') );
	Cancel();
}
if ( ! FilePathExists( UrlToFilePath( UrlAppendPath( 'x-local://wt/web', curAssessment.publish_url ) ) ) )
{
	Response.Write( tools.get_web_str('tl_error2') );
	Cancel();
}

curObjectID = curCatalogLearning.id;
curObjectDoc = OpenDoc( UrlFromDocID( curObjectID ) );
curObject = curObjectDoc.TopElem;

saveFlag = false;
if ( ! curObject.start_learning_date.HasValue )
{
	curObject.start_learning_date = Date();
	saveFlag = true;
}

if ( ! curObject.qti_text.HasValue )
{
	if ( curAssessment.external_type.HasValue ) // * BBT *
	{
		if ( ! tools.test_external_type_filling( curObject, curAssessmentID, curAssessment ) )
		{
			Response.Write( 'ERROR of test external type filling.' );
			Cancel();
		}
	}
	else
	{
	_qti_str = qti_tools.qti_return( curAssessmentID, UrlParent( ( StrBegins( curAssessment.publish_url, 'x-local://' ) ? '' : 'x-local://wt/web' ) + curAssessment.publish_url ) );
	
	if( StrEnds( _qti_str, '#failed#' ) )
	{
		Response.Write( _qti_str );
		Cancel();
	}

		curObject.max_score = qti_tools.max_score_return( _qti_str );
		curObject.qti_text = _qti_str;
	}
	saveFlag = true;
}

if ( saveFlag )
	curObjectDoc.Save();


_last_date = DateOffset( Date(), 0-8640 );
connectionsArray = XQuery( 'for $elem in connections where $elem/creation_date < date(\'' + _last_date + '\') return $elem' );
for ( _connection in connectionsArray )
	try
	{
		DeleteDoc( UrlFromDocID( _connection.id ), true );
	}
	catch ( err )
	{
	}
	
docConnection = OpenNewDoc( 'x-local://wtv/wtv_connection.xmd' );
connectionDoc = docConnection.TopElem;
connectionDoc.active_learning_id = curObjectID;
connectionDoc.course_id = curAssessmentID;
connectionDoc.user_id = curUser.code;
connectionDoc.user_fullname = curUser.fullname;
docConnection.BindToDb(DefaultDb);
docConnection.Save();
_session_id = docConnection.DocID;


_tracking_url = tools_web.get_url_protocol( Request.Url ) + Request.UrlHost + "/handler.html";
_url = curAssessment.publish_url;

/*
if ( curUser.location != '' )
	_url = UrlAppendPath( curUser.location, _url );
*/	
	
_url = _url + ( StrContains( _url, "?" ) ? "&" : "?" ) + "aicc_sid=" + _session_id + "&aicc_url=" + UrlEncode( _tracking_url )
        + '&' + qti_tools.get_player_url_param( curAssessmentID, curAssessment );

//alert(_url);
Response.Redirect( _url );
%>