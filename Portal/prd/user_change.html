<%
	_ajax = Request.Query.HasProperty("ajax") ? Request.Query.GetProperty("ajax") : "";
	_redirect = tools_web.convert_xss( Request.Form.GetOptProperty("redirect", "") );
	
	if ( ! global_settings.settings.allow_self_register && !_ajax && _redirect != "boss_panel")
	{
		Response.Redirect( 'default.html' );
		Cancel();
	}
	errStr = "";
	_lastname = "";
	_firstname = "";
	_middlename = "";
	_position_name = "";
	_login = "";
	_password = "";
	_org_name = "";
	_position_id = null;
	_org_id = null;
	_org_name = '';
	_phone = "";
	_email = "";
	_sex = "";
	_web_banned = global_settings.settings.web_banned_self_register;
	_change_password = false;
	_view = 'self';
	curDocID = null;
	_sub_id = null;
	
	
	if ( Request.Form.HasProperty( 'lastname' ) )
		_lastname = tools_web.convert_xss( Request.Form.lastname );
	if ( Request.Form.HasProperty( 'firstname' ) )
		_firstname = tools_web.convert_xss( Request.Form.firstname );
	if ( Request.Form.HasProperty( 'middlename' ) )
		_middlename = tools_web.convert_xss( Request.Form.middlename );
	
	
	if ( Request.Form.HasProperty( 'view' ) && Request.Form.view != '' )
		_view = tools_web.convert_xss( Request.Form.view );
	
	if ( Request.Form.HasProperty( 'doc_id' ) && Request.Form.doc_id != '' )
		curDocID = Int( Request.Form.doc_id );
	
	if ( Request.Form.HasProperty( 'email' ) )
		_email = tools_web.convert_xss( Request.Form.email );
		
	if ( Request.Form.HasProperty( 'phone' ) )
		_phone = tools_web.convert_xss( Request.Form.phone );
		
	if ( Request.Form.HasProperty( 'sex' ) )
		_sex = tools_web.convert_xss( Request.Form.sex );
		
	if ( _view == 'new' )
		_web_banned = Request.Form.HasProperty( 'web_banned' );
		
	if ( Request.Form.HasProperty( 'change_password' ) )
		_change_password = true;
		
	if ( Request.Form.HasProperty( 'sub_id' ) && Request.Form.sub_id != '' )
		_sub_id = tools_web.convert_xss( Request.Form.sub_id );
		
	if ( _sub_id == null && Request.Form.HasProperty( 'org_id' ) && Request.Form.org_id != '' )
		_org_id = tools_web.convert_xss( Request.Form.org_id );

	
	if ( global_settings.settings.self_register_disp_custom_elems )
	{
		_counter = 0;
		try
		{
			for ( _field in custom_templates.Child( 'collaborator' ).fields )
				try
				{
					if ( ! _field.is_required )
						continue;
					
					_value = eval( 'Request.Form.' + _field.name );
					if ( _field.type != 'bool' && _value == '' )
					{
						errStr = tools.get_web_str('uc_error2');
						break;
					}
				}
				catch ( ee )
				{
				}
				
		}
		catch ( e )
		{
		}
	}
	
	if ( global_settings.settings.self_register_disp_subs )
	{
		if ( _sub_id == "" && _sub_id == null && (Request.Form.HasProperty("sub_free") == false || Request.Form.GetProperty("sub_free") != "1"))
		{
			errStr = tools.get_web_str('uc_error5');
		}
		else if ( Request.Form.position == "" && Request.Form.position_common_id == "" )
		{
			errStr = tools.get_web_str('uc_error6');
		}
		else if ( Request.Form.mode == "1" && Request.Form.subdivision == "" )
		{
			errStr = tools.get_web_str('uc_error7');
		}
	}
	
	if ( ! global_settings.settings.eval_post_registration_script || ! global_settings.settings.script_create_password )
	{
		_password = tools_web.convert_xss( Request.Form.password );
		if ( _password == "" )
		{
			errStr = tools.get_web_str('uc_error2');
		}
		else if ( _password != Request.Form.password2 )
		{
			errStr = tools.get_web_str('uc_error4');
		}
	}
	
	if ( ! global_settings.settings.eval_post_registration_script || ! global_settings.settings.script_create_login )
	{
		_login = tools_web.convert_xss( Request.Form.login );
		if ( _login == "" )
		{
			errStr = tools.get_web_str('uc_error2');
		}
		else
		{
			query = XQuery( "for $user in collaborators where $user/login = " + XQueryLiteral( String( _login ) ) + " return $user" );
			if ( ArrayCount( query ) != 0 )
				errStr = tools.get_web_str('uc_error1');
		}
	}
	
	if ( ( global_settings.settings.email_required && _email == "" ) || _lastname == "" || _firstname == "" )
	{
			errStr = tools.get_web_str('uc_error2');
	}
	
	if ( global_settings.settings.eval_prev_registration_script && Trim( global_settings.settings.prev_registration_script ) != "" )
		eval( global_settings.settings.prev_registration_script );
	

	if ( errStr == '' )
	{
		
		docUser = OpenNewDoc( 'x-local://wtv/wtv_collaborator.xmd' );		
		docUser.TopElem.login = _login;
		docUser.TopElem.password = tools.make_password( _password, false );
		docUser.TopElem.lastname = _lastname;
		docUser.TopElem.firstname = _firstname;
		docUser.TopElem.middlename = _middlename;
		docUser.TopElem.email = _email;
		docUser.TopElem.phone = _phone;
		docUser.TopElem.sex = _sex;
		docUser.TopElem.access.web_banned = _web_banned;
		docUser.TopElem.change_password = _change_password;
		
		try
		{
			docUser.TopElem.birth_date = Date( Request.Form.birth_date );
		}
		catch ( ss )
		{
			try
			{
				docUser.TopElem.birth_date = Date( Int( Request.Form.birth_year ), Int( Request.Form.birth_month ), Int( Request.Form.birth_day ) );
			}
			catch ( ff )
			{
			}
		}
		
		try
		{
			docUser.TopElem.hire_date = Date( Request.Form.hire_date );
		}
		catch ( ss )
		{
			try
			{
				docUser.TopElem.hire_date = Date( Int( Request.Form.hire_year ), Int( Request.Form.hire_month ), Int( Request.Form.hire_day ) );
			}
			catch ( ff )
			{
			}
		}
		
		docUser.BindToDb( DefaultDb );
		docUser.Save();
		
		_position_common_id = null;
		if ( _org_id == null )
		{
			if ( global_settings.settings.self_register_disp_subs )
			{
				if ( Request.Form.sub_id != '' )
				{
					subDoc = OpenDoc( UrlFromDocID( Int( Request.Form.sub_id ) ) );
					if ( subDoc.TopElem.Name == 'org' )
					{
						_org_id = subDoc.DocID;
						_org_name = subDoc.TopElem.disp_name;
					}
					else
					{
						_org_id = subDoc.TopElem.org_id;
						_org_name = subDoc.TopElem.org_id.ForeignElem.disp_name;
						_sub_id = subDoc.DocID;
					}
				}
				
				if ( Request.Form.mode == "1" )
				{
					docSub = OpenNewDoc( 'x-local://wtv/wtv_subdivision.xmd' );
					docSub.BindToDb( DefaultDb );
					docSub.TopElem.name = Request.Form.subdivision;
					docSub.TopElem.parent_object_id = _sub_id;
					docSub.TopElem.org_id = _org_id;
					docSub.Save();
					
					_sub_id = docSub.DocID;
				}
				
				_position_name = tools_web.convert_xss( Request.Form.position );
				if ( global_settings.settings.self_register_use_position_commons )
				{
					if ( Request.Form.position_common_id != '' )
					{
						_position_common_id = Int( Request.Form.position_common_id );
						positionCommonDoc = OpenDoc( UrlFromDocID( _position_common_id ) ).TopElem;
						_position_name = positionCommonDoc.name;
					}
				}
			}
			else
			{
				_org_id = global_settings.settings.self_register_org_id;
				_org_name = _org_id.HasValue ? _org_id.ForeignElem.disp_name : '';
				
				_sub_id = global_settings.settings.self_register_subdivision_id;
				_position_name = global_settings.settings.self_register_position_name;
			}
		}
		else
		{
			_org = ArrayOptFirstElem(XQuery("for $elem in orgs where $elem/id = " + _org_id + " return $elem"));
			if (_org != undefined)
			{
				_org_id = _org.id;
				_org_name = _org.name;
				if (Request.Form.HasProperty("position"))
					_position_name = tools_web.convert_xss( Request.Form.position );
			}
			else
			{
				_org_id = null;
			}
		}
		
		if ( _position_name != "" )
		{
			docPosition = OpenNewDoc( 'x-local://wtv/wtv_position.xmd' );
			docPosition.BindToDb( DefaultDb );
			docPosition.TopElem.name = _position_name;
			docPosition.TopElem.org_id = _org_id;
			docPosition.TopElem.parent_object_id = _sub_id;
			docPosition.TopElem.basic_collaborator_id = docUser.DocID;
			docPosition.TopElem.position_common_id = _position_common_id;
			docPosition.Save();
			_position_id = docPosition.DocID;
		}
		
		if ( global_settings.settings.self_register_disp_custom_elems )
			tools_web.web_custom_elems_filling( 'collaborator', docUser.DocID, docUser.TopElem, Request.Form );
			
		
		docUser.TopElem.org_id = _org_id;
		docUser.TopElem.org_name = _org_name;
		docUser.TopElem.position_id = _position_id;
		docUser.TopElem.position_name = _position_name;
		
		docUser.Save();
		
		try
		{
			groupDoc = OpenDoc( UrlFromDocID( global_settings.settings.self_register_group_id ) );
			_child = groupDoc.TopElem.collaborators.AddChild();
			_child.collaborator_id = docUser.DocID;
			_child.collaborator_fullname = docUser.TopElem.fullname;
			groupDoc.Save();
		}
		catch ( e )
		{
		}
		
		tools.create_notification( '6', docUser.DocID );
		
		if ( global_settings.settings.eval_post_registration_script && Trim( global_settings.settings.post_registration_script ) != "" )
			eval( global_settings.settings.post_registration_script );
		
		if (_ajax == "1")
		{
			Response.Write("1");
		}
		else if ( _view != 'new' && docUser.TopElem.access.web_banned )
		{
%>
<script language="JAVASCRIPT">
	alert( "<%=tools.get_web_str('uc_message1')%>" );
	location.href="default.html";
</script>
<%
			Cancel();			
		}
		else if ( _redirect == "" )
		{
%>
<script language="JAVASCRIPT">
	alert( "<%=tools.get_web_str('uc_message2')%>" );
	location.href="default.html";
</script>
<%	
			Cancel();	
		}
		else
		{
			if (_redirect == "boss_panel")
				_redirect = _redirect + "&flush=1";
%>
<script language="JAVASCRIPT">
	location.href="view_doc.html?mode=<%=_redirect%>&doc_id=<%=curDocID%><%=( _sub_id == null ? '' : '&subdivision_id=' + _sub_id )%>";
</script>
<%
		}
	}

	if ( errStr != "" )
	{
		if (_ajax == "1")
		{
			alert(errStr);
			Response.Write(0);
		}
		else
		{
%>
<script language="JAVASCRIPT">
	alert( "<%=errStr%>" );
	location.href="user_form.html?view=<%=_view%>&doc_id=<%=curDocID%>&sub_id=<%=_sub_id%>&redirect=<%_redirect%>&l=<%=_lastname%>&f=<%=_firstname%>&mid=<%=_middlename%>&p=<%=_position_name%>&log=<%=_login%>&t=<%=_phone%>&e=<%=_email%>";
</script>
<%	
		}
		Cancel();
	}
%>