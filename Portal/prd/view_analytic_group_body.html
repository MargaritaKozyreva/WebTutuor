<br>
	
<%
	try
	{
		_action = Request.Form.action;
	}
	catch ( t )
	{
		_action = '0';
	}	

	try
	{
		_group_id = Request.Form.group_id;
	}
	catch ( t )
	{
		_group_id = '';
	}

	try
	{
		_course_id = Request.Form.course_id;
	}
	catch ( t )
	{
		_course_id = '';
	}

	try
	{
		_test_id = Request.Form.test_id;
	}
	catch ( t )
	{
		_test_id = '';
	}


	try
	{
		_col_id = Request.Form.col_id;
	}
	catch ( t )
	{
		_col_id = '';
	}
	
	try
	{
		_subdivision_id = Request.Form.subdivision_id;
	}
	catch ( t )
	{
		_subdivision_id = '';
	}
	
	try
	{
		_start_date = Request.Form.start_date;
	}
	catch ( t )
	{
		_start_date = '';
	}
	
	try
	{
		_end_date = Request.Form.end_date;
	}
	catch ( t )
	{
		_end_date = '';
	}
	
	try
	{
		_filter = Request.Form.filter_id;
	}
	catch ( t )
	{
		_filter = 'all';
	}
	
	try
	{
		_sort_type = Request.Form.sort_type;
	}
	catch ( t )
	{
		_sort_type = 'coll';
	}	
	
		
	_collaborators = Array();
	_coll_counter = 0;
	
	_positions = Array();
	_pos_counter = 0;
	

%>
	
<script language="JavaScript">
function do_submit()
{
	var re = new RegExp( "[0-9]{2}\.[0-9]{2}\.[0-9]{4}" );
	
	if ( document.stat_form.start_date.value != '' && document.stat_form.start_date.value.match(re) == null )
	{
		alert( "<%=tools.get_web_str('vanb_error1')%>" );
		return;
	}

	if ( document.stat_form.end_date.value != '' && document.stat_form.end_date.value.match(re) == null )
	{
		alert( "<%=tools.get_web_str('vanb_error2')%>" );
		return;
	}
	
	vv=document.stat_form.$multi_groupSelector;
	vvv=vv.options;
	vvs="";
	for (i=0;i<vvv.length;i++) {if (vvv[i].selected) {if (vvs=="") {vvs=vvv[i].value} else {vvs=vvs+"~"+vvv[i].value}}}
	document.stat_form.group_id.value=vvs;

	vv=document.stat_form.$multi_courseSelector;
	vvv=vv.options;
	vvs="";
	for (i=0;i<vvv.length;i++) {if (vvv[i].selected) {if (vvs=="") {vvs=vvv[i].value} else {vvs=vvs+"~"+vvv[i].value}}}
	document.stat_form.course_id.value=vvs;

	vv=document.stat_form.$multi_testSelector;
	vvv=vv.options;
	vvs="";
	for (i=0;i<vvv.length;i++) {if (vvv[i].selected) {if (vvs=="") {vvs=vvv[i].value} else {vvs=vvs+"~"+vvv[i].value}}}
	document.stat_form.test_id.value=vvs;

	document.stat_form.submit();
}
array_group="<%=_group_id%>".split("~");
array_course="<%=_course_id%>".split("~");
array_test="<%=_test_id%>".split("~");

</script>

	
		
	<form action="view_doc.html?mode=analytic_group" name="stat_form" method="POST">
	<input type="HIDDEN" name="doc_id" value="<%=curDocID%>">
	<input type="HIDDEN" name="action" value="1">
	
	    <table width="100%" cellspacing="4" cellpadding="0">
          <tr>
		  	<td>
			
			<table width="100%" cellspacing="0" cellpadding="4" class="tableBorder">

                      <tr> 
                        <td width="160" align="RIGHT"><b><%=tools.get_web_str('c_event')%>:</b></td>
                        <td align="LEFT"><select id="$multi_groupSelector" name="$multi_groupSelector" multiple="1" style="width: 600px; height: 80px;" SIZE="4"> 
                  <%
	_programs = XQuery( "for $education in education_methods order by $education/name return $education" );

	for ( _program in _programs )
	{
%>
                            <option value="<%=_program.id%>"><%=tools_web.get_cur_lng_name( _program.name )%>
<%
	}
%>
                          </select> 
<input type=hidden name=group_id value="">
<script language="JavaScript">
array_group="<%=_group_id%>".split("~");
selcur=document.forms['stat_form'].$multi_groupSelector;
for (i=0;i<selcur.options.length;i++)
	for (k=0;k<array_group.length;k++) {
    if (selcur.options[i].value==array_group[k])
        selcur.options[i].selected=true;}
</script>
					</td>
                      </tr>
		<tr> 
                        <td width="160" align="RIGHT"><b><%=tools.get_web_str('c_course')%>:</b></td>
                        <td align="LEFT"><select id="$multi_courseSelector" name="$multi_courseSelector" multiple="1" style="width: 600px; height: 80px;" SIZE="4">
                  <%
	_courses = XQuery( "for $course in courses order by $course/name return $course" );

	for ( _course in _courses )
	{
%>
                            <option value="<%=_course.id%>"><%=tools_web.get_cur_lng_name( _course.name )%>
<%
	}
%>
                          </select> 
<input type=hidden name=course_id value="">
<script language="JavaScript">
array_course="<%=_course_id%>".split("~");
selcur=document.forms['stat_form'].$multi_courseSelector;
for (i=0;i<selcur.options.length;i++)
	for (k=0;k<array_course.length;k++) {
    if (selcur.options[i].value==array_course[k])
        selcur.options[i].selected=true;}
</script>
					</td>
                      </tr>			  
 <tr> 
                        <td width="160" align="RIGHT"><b><%=tools.get_web_str('c_test')%>:</b></td>
                        <td align="LEFT"><select id="$multi_testSelector" name="$multi_testSelector" multiple="1" style="width: 600px; height: 80px;" SIZE="4">
                  <%
	_tests = XQuery( "for $test in assessments order by $test/title return $test" );

	for ( _test in _tests )
	{
%>
                            <option value="<%=_test.id%>"><%=tools_web.get_cur_lng_name( _test.title )%>
<%
	}
%>
                          </select> 
<input type=hidden name=test_id value="">
<script language="JavaScript">
array_test="<%=_test_id%>".split("~");
selcur=document.forms['stat_form'].$multi_testSelector;
for (i=0;i<selcur.options.length;i++)
	for (k=0;k<array_test.length;k++) {
    if (selcur.options[i].value==array_test[k])
        selcur.options[i].selected=true;}
</script>
					</td>
                      </tr>
  <tr>
					  	<td width="160" align="RIGHT"><b><%=tools.get_web_str('c_filter')%>:</b></td>
						<td align="LEFT"><b><input type="TEXT" name="start_date" value="<%=_start_date%>" size="10" class="inputEdit">&nbsp;=&gt;&nbsp;<input type="TEXT" name="end_date" value="<%=_end_date%>" size="10" class="inputEdit">
						</b>
					  	&nbsp;<b>(dd.mm.yyyy)</b></td>
					  </tr>

                    </table>
<input type="button" value="&gt;&gt;" onclick="do_submit();">
</form>

<script>
function ExcelWin() {
	win = window.open("", "name",'toolbar=no,location=no,status=no,menubar=no,resizable=yes,directories=no,scrollbars=yes,width=800,height=600');
//	win.document.write(document.getElementById("script_").innerHTML);

	body=document.getElementById("rep_body").innerHTML;
	bodyNew="";
	var listArray = body.split("<SCRIPT>");
	for(i=0;i<listArray.length;i++) {
		bodyNew = bodyNew + listArray[i].substring(listArray[i].indexOf("SCRIPT>") + 7, listArray[i].length);
		}
	if (win.document.getElementById('rep_body')) {win.document.getElementById('rep_body').innerHTML="";}
	if (!win.document.getElementById('rep_body')) {win.document.write("<div id='rep_body'>")}
	win.document.write(bodyNew);
	if (!win.document.getElementById('rep_body')) {win.document.write("</div>")}
	}
</script>
<input type="submit" value="<%=tools_web.get_web_str('vagb_open_win')%>" onClick="ExcelWin()">
		</td>
	</tr>

	</table>



<%
	if ( _action == '1' )
	{
%>	
<div id="rep_body">
<script>

function Users() {
	this.users = new Array;
	this.list = new Array;
	this.tests = new Array;
	this.testsCount = new Array;
	this.testsDepCount = new Array;
	this.courses = new Array;
	this.coursesCount = new Array;
	this.coursesDepCount = new Array;
	this.groups = new Array;
	this.groupsCount = new Array;
	this.groupsDepCount = new Array;

	this.deps = new Array;
	this.depsList = new Array;

	this.addUser = AddUserToUsers;
	this.getUser = GetUserFromUsers;
	this.createList = CreateUserList;
	this.sort = SortUser;
	this.viewUsers = ViewUsers;
	}
function User(FIO,UNID,Dep) {
	this.FIO=FIO;
	this.UNID=UNID;
	this.dep=Dep;
	this.groups = new Array;
	this.addGroup = AddGroup;
	this.getGroup = GetGroup;
	this.view = UserView;
	this.updateHour = UpdateUserHour;
	this.tests = new Array;
	this.addTest = AddTest;
	this.courses = new Array;
	this.addCourse = AddCourse;
	}
function Group() {
	this.phases = new Array;
	this.tests = new Array;
	this.addGroupPhase = AddGroupPhaseToGroup;
	this.addGroupTest = AddTest;
	this.view = GroupView;
	}
function GroupPhase() {
	this.view = GroupPhaseView;
	}

function Test() {
	this.view = TestView;
	}
function Course() {
	this.view = TestView;
	}

function AddUserToUsers( user ) {
	if (!this.users[ user.UNID ]) {
		this.users[ user.UNID ] = user;
		}
	}
function GetUserFromUsers( user ) {
	if (this.users[ user ]) {return( this.users[ user ] );} else return(null);
	}
function UserView() {
	document.writeln("<tr bgcolor='white'><td class='tableRowOdd'>" + this.FIO + "</td>");
	for (courseUNID in users.groups) {
		if (this.groups[ courseUNID ]) {
			document.writeln("<td class='tableRowEven' align='center' width='100'>"+this.groups[ courseUNID ].date + "</td>");
			users.groupsDepCount[ courseUNID ] += 1;
			}
		else document.writeln("<td class='tableRowEven'></td>");
		}
	for (courseUNID in users.courses) {
		if (this.courses[ courseUNID ]) {
			document.writeln("<td class='tableRowEven' align='center' width='100'>"+this.courses[ courseUNID ].ScoreDate + "</td>");
			users.coursesDepCount[ courseUNID ] += 1;
			}
		else document.writeln("<td class='tableRowEven'></td>");
		}
	for (testUNID in users.tests) {
		if (this.tests[ testUNID ]) {
			document.writeln("<td class='tableRowEven' align='center' width='100'>"+this.tests[ testUNID ].ScoreDate + "</td>");
			users.testsDepCount[ testUNID ] += 1;
			}
		else document.writeln("<td class='tableRowEven'></td>");
		}

	document.writeln("</tr>");
	}
function UpdateUserHour() {
	for (groupUNID in this.groups) {
		group = this.groups[ groupUNID ];
		hour = (!group.phaseHour) ? group.hour : group.phaseHour;
		if (!this.hour) {this.hour = hour} else {this.hour = this.hour + hour}
		}
	}
function AddGroup( group ) {
	if (!users.groups[ group.courseUNID ]) { users.groups[ group.courseUNID ] = group; users.groupsCount[ group.courseUNID ] = 0;}
	if (!this.groups[ group.courseUNID ]) { this.groups[ group.courseUNID ] = group; users.groupsCount[ group.courseUNID ] += 1;} else { this.groups[ group.courseUNID ].date = this.groups[ group.courseUNID ].date + ", " + group.date; }

	}
function GetGroup( groupUNID ) {
	if (this.groups[ groupUNID ]) {return (this.groups[ groupUNID ]);} else return(null);
	}
function CreateUserList() {
	i=0
	for (userUNID in this.users) {
		user = this.users[userUNID];	
		this.list[i] = new Array;
		this.list[i][0]=user.FIO;
		this.list[i][1]=user.UNID;
		i++;
		}
	}
function SortUser() {
//	this.list=sort(this.list);
	this.list=this.list.sort();
	}


function GroupView(){
	hour = (!this.phaseHour) ? this.hour : this.phaseHour;
//	document.writeln("<tr bgcolor='white'>");
	for(_item in users.groups) 
		if (this.groups) if (this.groups[ _item ]) {
			document.writeln("<td class='tableRowEven'>" + this.course.bold() + "</td>");
			document.writeln("<td class='tableRowEven'>"+this.date.bold() + "</td>");
			}
	for(test in users.tests) {if (this.tests[ test ]) score = this.tests[ test ].score; else score=""; document.writeln("<td class='tableRowEven'>" + score + "</td>"); }
	document.writeln("</tr>");}

function AddGroupPhaseToGroup ( groupPhase ) {
	if (!this.phases[ groupPhase.UNID ]) {
		this.phases[ groupPhase.UNID ] = groupPhase;
		}
	}

function AddTest( Test ) {
	if (!users.tests[ Test.UNID ]) { users.tests[ Test.UNID ] = Test; }
	if (!this.tests[ Test.UNID ]) { this.tests[ Test.UNID ] = Test; } else {this.tests[ Test.UNID ].ScoreDate = this.tests[ Test.UNID ].ScoreDate + ", " + Test.ScoreDate;}
	}

function AddCourse( Course ) {
	if (!users.courses[ Course.UNID ]) { users.courses[ Course.UNID ] = Course; }
	if (!this.courses[ Course.UNID ]) { this.courses[ Course.UNID ] = Course; } else {this.courses[ Course.UNID ].ScoreDate = this.courses[ Course.UNID ].ScoreDate + ", " + Course.ScoreDate;}
	}
function GroupPhaseView(){
	document.writeln("<tr><td width='25' align='center'>"+this.hour+"</td>");
	document.writeln("<td>"+this.date+"</td>");
	document.writeln("<td>&nbsp;&nbsp;&nbsp;" + this.course + "</td>");
	document.writeln("<td align='center'>" + this.mark + "</td></tr>");}

//	document.writeln("&nbsp;&nbsp;&nbsp;" + this.date+" " + this.course + " (" + this.hour +")<BR>");}

function TestView(){
	document.writeln("<tr><td width='25' align='center'><%=tools_web.get_web_str('c_test')%></td>");
	
	document.writeln("<td colspan='2'>"+ " " +this.name+"</td>");

	
	document.writeln("<td align='center'>"+ this.score+"</td></tr>");
	}

function ViewUsers() {
//------ Class Users ------

j=0;
deps = this.deps;
depsList = this.depsList;
for (i =0;i<this.list.length;i++) {
	user = this.users[this.list[i][1]];
	if(!depsList[user.dep]) {
		deps[j] = user.dep;
		depsList[user.dep] = new Array;
		depsList[user.dep]["name"] = user.dep;
		depsList[user.dep]["count"] = user.DepCount;
		depsList[user.dep]["users"] = new Array;
		j++;
		}
	depsList[user.dep]["users"][depsList[user.dep]["users"].length] = user.UNID;

	}
deps.sort();

document.writeln("<table>");
document.writeln("<tr><td class='tableRowOdd'><b><%=tools_web.get_web_str('c_fio')%>/<%=tools_web.get_web_str('c_course')%></b></td>");
for(_item in this.groups) document.writeln("<td class='tableRowOdd'><b>" + this.groups[ _item ].course + "</b></td>");
for(_item in this.courses) document.writeln("<td class='tableRowOdd'><b>" + this.courses[ _item ].name + "</b></td>");
for(_item in this.tests) document.writeln("<td class='tableRowOdd'><b>" + this.tests[ _item ].name + "</b></td>");
document.writeln("</tr>");

for(j in deps) {
	document.writeln("<tr bgcolor='white'><td class='tableRowOdd'><b>" + deps[j] + "</b></td>");
	for(_item in this.groups) {document.writeln("<td class='tableRowOdd'></td>");this.groupsDepCount[ _item ] = 0;}
	for(_item in this.courses) {document.writeln("<td class='tableRowOdd'></td>");this.coursesDepCount[ _item ] = 0;}
	for(_item in this.tests) {document.writeln("<td class='tableRowOdd'></td>");this.testsDepCount[ _item ] = 0;}
	document.writeln("</tr>");

	this.groupsDepCount["total"]=0;
	this.coursesDepCount["total"]=0;
	this.testsDepCount["total"]=0;
	total = 0;
	for (i =0;i<depsList[ deps[j] ]["users"].length;i++) {
		user = this.users[depsList[ deps[j] ]["users"][i]];
		if (user.dep==deps[j]) {
			user.updateHour();
			user.view();
			total += 1;
			for (_item in user.groups) { this.groupsDepCount["total"] += 1; break;}
			for (_item in user.courses) { this.coursesDepCount["total"] += 1; break;}
			for (_item in user.tests) { this.testsDepCount["total"] += 1; break;}
			}
		}
	document.writeln("<tr bgcolor='white'><td class='tableRowOdd' align='right'><%=tools_web.get_web_str('vagb_summary')%>:</td>");
	count=depsList[ deps[j] ]["count"];
	if (count && count!=0) {
		for(_item in this.groups) {document.writeln("<td class='tableRowOdd' align='center'>" + Math.round((this.groupsDepCount[ _item ] / count *100))/100 + "</td>");}
		for(_item in this.courses) {document.writeln("<td class='tableRowOdd' align='center'>" + Math.round((this.coursesDepCount[ _item ] / count *100))/100 + "</td>");}
		for(_item in this.tests) {document.writeln("<td class='tableRowOdd' align='center'>" + Math.round((this.testsDepCount[ _item ] / count *100))/100 + "</td>");}
		}
	else {
		for(_item in this.groups) {document.writeln("<td class='tableRowOdd' align='center'>-</td>");}
		for(_item in this.courses) {document.writeln("<td class='tableRowOdd' align='center'>-</td>");}
		for(_item in this.tests) {document.writeln("<td class='tableRowOdd' align='center'>-</td>");}
		}
	document.writeln("</tr>");

	if (count && count!=0) {
		groupsCount = 0; coursesCount = 0; testsCount = 0;
		for (_item in users.groups) { groupsCount += 1;}
		for (_item in users.courses) { coursesCount += 1;}
		for (_item in users.tests) { testsCount += 1;}

		document.writeln("<tr bgcolor='white'><td class='tableRowOdd' align='right'><%=tools_web.get_web_str('vagb_summary_dir')%>:</td>");
		this.groupsDepCount["total"] = Math.round(this.groupsDepCount["total"]/count*100)/100;
		this.coursesDepCount["total"] = Math.round(this.coursesDepCount["total"]/count*100)/100;
		this.testsDepCount["total"] = Math.round(this.testsDepCount["total"]/count*100)/100;
		document.writeln("<td class='tableRowOdd' align='left' colspan='"+ groupsCount + coursesCount + testsCount + "'><%=tools_web.get_web_str('vagb_face_time')%>: " + this.groupsDepCount["total"] + " <br>");
		document.writeln("<%=tools_web.get_web_str('vagb_dist')%>: " + this.coursesDepCount["total"] + "<br>");
		document.writeln("<%=tools_web.get_web_str('c_testing')%>: " + this.testsDepCount["total"] + "</td>");
		document.writeln("</tr>");

		total = Math.round(total/count*100)/100;
		document.writeln("<tr bgcolor='white'><td class='tableRowOdd' align='right'><%=tools_web.get_web_str('vagb_summary_sub')%>:</td>");
		document.writeln("<td class='tableRowOdd' align='left' colspan='"+ groupsCount + coursesCount + testsCount + "'>" + total + "</td>");
		document.writeln("</tr>");
		} // if (count && count!=0) {
	} // for(j in deps) {
//document.writeln("<tr bgcolor='white'><td class='tableRowOdd'></td>");
//for(_item in this.groups) document.writeln("<td class='tableRowOdd'>" + this.groupsCount[ _item ] + "</td>");
document.writeln("</table>");
}

function CutUserPath( path ) {
	if (path.length==0) {return "";}
	var pathArr=path.split("~");
	pathArr.pop();
	switch (pathArr.length) {
		case 1:
			return pathArr[0];
		case 2: 
			return pathArr[0] + "\\" + pathArr[1];
		default: 
			return pathArr[0] + "\\" + pathArr[1] + "\\" + pathArr[2];
	}
}

users = new Users();

if ("<%=_group_id%>"!="") {
<%
if (_group_id!="") {
alert("groupID=" + _group_id);
	_where_str = " where true() " 
				+ ( _start_date == "" ? "" : " and date( '" + _start_date + "' ) <= $event/start_date " )
				+ ( _end_date == "" ? "" : " and date( '" + _end_date + "' ) >= $event/start_date " );
	_array_group=_group_id.split("~");
	_add_str = "";
	for (_ors in _array_group) 
		{
		if (_add_str=="") 
			{_add_str =  " $event/education_method_id=" + _ors + " "}
		else 
			{_add_str =  _add_str + " or $event/education_method_id=" + _ors + "  "}
		}
	_query = "for $event in ( events ) " + _where_str + " and (" + _add_str + ") return $event";
alert ( "Groupquery="+_query);
_res_array = XQuery( _query);
alert ("N=" + ArrayCount(_res_array));
	for ( _evn in  _res_array ) 
	{
	_query1 = "for $event in ( event_results ) where $event/event_id="+_evn.id+" return $event";
	_evr_array = XQuery( _query1);
	for ( _learn in  _evr_array ) {
try {
	_event_id=_learn.event_id;
	_person_id=_learn.person_id;

	_coursename=HtmlEncode(_learn.event_name);
	_event_date=_learn.event_start_date;
	_person=OpenDoc( UrlFromDocID(_person_id ) ).TopElem;
	_event=OpenDoc( UrlFromDocID(_event_id ) ).TopElem;
	_person_FIO=_learn.person_fullname;
	_vcourse_id=_event.education_method_id;
	DisPath=_person.path_subs;
	_person_path='';          
            	for (_subs in DisPath) {
                 		SubDoc = OpenDoc(UrlFromDocID(_subs.id) ); 
		if (_person_path=='') {_person_path=HtmlEncode(SubDoc.TopElem.name)} else {_person_path=HtmlEncode(SubDoc.TopElem.name)+'~'+_person_path}
	} 
}
catch (a) {}
%>
	for (i=0;i<array_group.length;i++) {
	if ( '<%=_vcourse_id%>'==array_group[i]) {
		user = users.getUser("<%=_person_id%>");
		if( !user ) { 
			var userpath=CutUserPath("<%=_person_path%>");
			user = new User('<%=_person_FIO%>','<%=_person_id%>',userpath);
			user.DepCount =1;
			users.addUser( user );
			}

		group = new Group();
		group.course = "<%=_coursename%>";
		group.courseUNID = '<%=_vcourse_id%>';
		group.UNID =  '<%=_event_id%>';
		group.date =  '<%=StrDate(_event_date,false,false)%>';
		group.hour = 0;
		group.mark = '';
		user.addGroup( group );
	}}
<%	
	}}}
%>
}


if ("<%=_course_id%>"!="") {
<%
if (_course_id!="") {
alert("courseID=" + _course_id);
	_where_str = " where true() " 
				+ ( _start_date == "" ? "" : " and date( '" + _start_date + "' ) <= $event/start_usage_date " )
				+ ( _end_date == "" ? "" : " and date( '" + _end_date + "' ) >= $event/start_usage_date " );
	_array_course=_course_id.split("~");
	_add_str = "";
	for (_ors in _array_course) 
		{
		if (_add_str=="") 
			{_add_str =  " $event/course_id=" + _ors + " "}
		else 
			{_add_str =  _add_str + " or $event/course_id=" + _ors + " "}
		}
	_query = "for $event in ( active_learnings, learnings ) " + _where_str + " and (" + _add_str + ") return $event";
alert ( "query="+_query);
_res_array = XQuery( _query);
alert ("N=" + ArrayCount(_res_array));
	for ( _learn in  _res_array ) 
	{
try { 
	_person_id=_learn.person_id;
	_event_id=_learn.course_id;
	_event_date=_learn.last_usage_date;
	_person=OpenDoc( UrlFromDocID(_person_id ) ).TopElem;
	_event=OpenDoc( UrlFromDocID(_event_id ) ).TopElem;
	_person_FIO=_learn.person_fullname;
	_vcourse_id=_event_id;
	_coursename=HtmlEncode(_event.name);
	_course_score=_learn.score;
	_person_path='';
	DisPath=_person.path_subs;
            	for (_subs in DisPath) {
                 		SubDoc = OpenDoc(UrlFromDocID(_subs.id) ); 
		if (_person_path=='') {_person_path=HtmlEncode(SubDoc.TopElem.name)} else {_person_path=HtmlEncode(SubDoc.TopElem.name)+'~'+_person_path}
	} 
}
catch (a) {}
%>
	for (i=0;i<array_course.length;i++) {
	if ( '<%=_vcourse_id%>'==array_course[i]) {
		user = users.getUser("<%=_person_id%>");
		if( !user ) { 
			var userpath=CutUserPath("<%=_person_path%>");
			user = new User('<%=_person_FIO%>','<%=_person_id%>',userpath);
			user.DepCount =1;
			users.addUser( user );
			}
		if( user ) { 
			myCourse = new Course();
			myCourse.name = "<%=_coursename%>";
			myCourse.UNID =  '<%=_vcourse_id%>';
			myCourse.score =  '<%=_course_score%>';
			myCourse.date =  '<%=StrDate(_event_date,false,false)%>';
			myCourse.ScoreDate = (myCourse.score=="") ? "-/" + myCourse.date : myCourse.score + "/" + myCourse.date;
			myCourse.passed = "";
			myCourse.type = "";
			myCourse.handInput = "";
			if (myCourse.handInput=="1") { myCourse.ScoreDate += " (<%=tools_web.get_web_str('vagb_hand')%>) " }
			user.addCourse( myCourse );
			}
	}}
<%	
	}}
%>
}

if ("<%=_test_id%>"!="") {
<%
if (_test_id!="") {
alert("testID=" + _test_id);
	_where_str = " where true() " 
				+ ( _start_date == "" ? "" : " and date( '" + _start_date + "' ) <= $event/start_usage_date " )
				+ ( _end_date == "" ? "" : " and date( '" + _end_date + "' ) >= $event/start_usage_date " );
_array_group=_test_id.split("~");
	_add_str = "";
	for (_ors in _array_group) 
		{
		if (_add_str=="") 
			{_add_str =  " $event/assessment_id=" + _ors + " "}
		else 
			{_add_str =  _add_str + " or $event/assessment_id=" + _ors + " "}
		}
	_query = "for $event in ( active_test_learnings, test_learnings ) " + _where_str + " and (" + _add_str + ") return $event";
alert ( " Test query="+_query);
_res_array = XQuery( _query);
	for ( _learn in  _res_array ) 
	{
try { 
	_person_id=_learn.person_id;
	_event_id=_learn.assessment_id;
	_event_date=_learn.last_usage_date;
	_person=OpenDoc( UrlFromDocID(_person_id ) ).TopElem;
	_event=OpenDoc( UrlFromDocID(_event_id ) ).TopElem;
	_person_FIO=_learn.person_fullname;
	_vcourse_id=_event_id;
	_coursename=HtmlEncode(_event.title);
	_course_score=_learn.score;
	_person_path='';
	DisPath=_person.path_subs;
            	for (_subs in DisPath) {
                 		SubDoc = OpenDoc(UrlFromDocID(_subs.id) ); 
		if (_person_path=='') {_person_path=HtmlEncode(SubDoc.TopElem.name)} else {_person_path=HtmlEncode(SubDoc.TopElem.name)+'~'+_person_path}
	} 
}
catch (a) {}
%>
	for (i=0;i<array_test.length;i++) {
	if ( '<%=_vcourse_id%>'==array_test[i]) {
		user = users.getUser("<%=_person_id%>");
		if( !user ) { 
			var userpath=CutUserPath("<%=_person_path%>");
			user = new User('<%=_person_FIO%>','<%=_person_id%>',userpath);
			user.DepCount =1;
			users.addUser( user );
			}
		if( user ) { 
			myTest = new Test();
			myTest.name = "<%=_coursename%>";
			myTest.UNID =  '<%=_vcourse_id%>';
			myTest.score = '<%=_course_score%>';
			myTest.date = '<%=StrDate(_event_date,false,false)%>';
			myTest.ScoreDate = (myTest.score=="") ? "-/" + myTest.date : myTest.score + "/" + myTest.date;
			myTest.passed = "";
			myTest.type = "";
			myTest.handInput = "";
			if (myTest.handInput=="1") { myTest.ScoreDate += " (<%=tools_web.get_web_str('vagb_hand')%>) " }
			user.addTest( myTest );
			}
	}}
<%	
	}
	}
%>
}

users.createList();
users.sort();
users.viewUsers();

</script>
	</div>
<%
	}
%>


	
