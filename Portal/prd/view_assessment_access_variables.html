<%
	try
	{
		curPA;
	}
	catch(_che_eto_)
	{
		try
		{
			curPAID;
			curPA = OpenDoc( UrlFromDocID( Int(curPAID) ) ).TopElem;
		}
		catch(_tufta_)
		{
			curPA = undefined;
		}
	}

	if (curPA != undefined)
	{
		try
		{
			_cur_assessment_appraise_type = curAssessmentAppraise.participants.GetChildByKey(curPA.status).assessment_appraise_types.GetChildByKey(curPA.assessment_appraise_type);
			ASSESSMENT_APPRAISE_TYPE = _cur_assessment_appraise_type.PrimaryKey;
		}
		catch(_hui_)
		{
			_cur_assessment_appraise_type = undefined;
			ASSESSMENT_APPRAISE_TYPE = null;
		}
	}
	else
	{
		_cur_assessment_appraise_type = undefined;
		ASSESSMENT_APPRAISE_TYPE = null;
	}

try
{
	curWorkflow;
}
catch(_gde_)
{
	if (curAssessmentAppraise.workflow_id.HasValue)
		curWorkflow = OpenDoc( UrlFromDocID( curAssessmentAppraise.workflow_id ) ).TopElem;
	else
		curWorkflow = undefined;
}

try
{
	IS_HUMAN;
}
catch(_che_za_shit_)
{
	IS_HUMAN = undefined;
}

		_in_time = true;
				
		if (_temp_assessment_plan != undefined && _temp_assessment_plan.start_date.HasValue)
			_dStartDate = _temp_assessment_plan.start_date;
		else if (curAssessmentAppraise.start_date.HasValue)
			_dStartDate = curAssessmentAppraise.start_date;
		else _dStartDate = null;

		if (_temp_assessment_plan != undefined && _temp_assessment_plan.end_date.HasValue)
			_dEndDate = _temp_assessment_plan.end_date;
		else if (curAssessmentAppraise.end_date.HasValue)
			_dEndDate = curAssessmentAppraise.end_date;
		else _dEndDate = null;
		
		if (_dStartDate != null && DateNewTime(_dStartDate) > DateNewTime(Date()))
		{
			_in_time = false;
			Response.Write("<center><font color='red'><b>"+StrReplace(tools_web.get_web_str("ass_procedure_will_be"), "{PARAM1}", DateNewTime(_dStartDate))+"</b></font></center><br/>");
		}
		
		if (_in_time && _dEndDate != null && DateNewTime(_dEndDate) < DateNewTime(Date()))
		{
			_in_time = false;
			Response.Write("<center><font color='red'><b>"+StrReplace(tools_web.get_web_str("ass_procedure_were"), "{PARAM1}", DateNewTime(_dEndDate))+"</b></font></center><br/>");
		}

		if ( curAssessmentPlan.is_workflow_init != false ) 
			PHASE = curAssessmentPlan.workflow_state;
		else 			
			PHASE = curWorkflow.default_state;
		
		_curState = curWorkflow.states.GetOptChildByKey( PHASE );
		
		_use_plan = curAssessmentAppraise.flag_use_plan;
				
		if (curPA != undefined)
		{
			if (IS_HUMAN == undefined)
				IS_HUMAN = !curPA.flag_appraise_department;

			_temp_pas = ArraySort(ArrayUnion( XQuery( "for $pa in pas where " + (IS_HUMAN ? " $pa/person_id = " + curPA.person_id : " $pa/department_id = " + curPA.department_id) + " and $pa/assessment_appraise_id = " + curAssessmentAppraiseID + " and $pa/status = '" + curPA.status + "' and $pa/is_done = false() return $pa" ) , XQuery( "for $pa in development_plans where " + (IS_HUMAN ? " $pa/person_id = " + curPA.person_id : " $pa/department_id = " + curPA.department_id) + " and $pa/assessment_appraise_id = " + curAssessmentAppraiseID + " and $pa/status = '" + curPA.status + "' and $pa/is_done = false() return $pa" ) ), "index", "+");
			
			IS_DONE = true;
			MY_IS_DONE = true;
			
			for (_temp_pa in _temp_pas)
			{
				IS_DONE = false;
				if (_temp_pa.expert_person_id == curPersonID) 
					MY_IS_DONE = false;
			}
			
			if (_use_plan)		
				if (curAssessmentPlan.status == curPA.status && (!curAssessmentPlan.is_done))
				{
					MY_IS_DONE = false;
					IS_DONE = false;
				}
									
			
			PA_IS_DONE = curPA.is_done;
			STATUS = curPA.status;
			
			if (IS_HUMAN)
				COLLABORATOR_USER_ID  = curPA.person_id;
			else
				COLLABORATOR_USER_ID  = curPA.department_id;

				COLLABORATOR_EXPERT_ID  = curPA.expert_person_id;
				
			CUSTOM_EXPERTS = curPA.custom_experts;
			if (curPA.ChildExists("is_ready"))
				IS_READY = curPA.is_ready;
			else
				IS_READY = false;
		}
		else
		{
			if (IS_HUMAN == undefined)
				IS_HUMAN = !curAssessmentPlan.flag_appraise_department;
			
			IS_DONE = curAssessmentPlan.is_done;
			if (curAssessmentPlan.ChildExists("is_ready"))
				IS_READY = curAssessmentPlan.is_ready;
			else
				IS_READY = false;
			
			PA_IS_DONE = undefined;
			
			if (curAssessmentPlan.status.HasValue)
			{
				STATUS = curAssessmentPlan.status;
			}
			else
			{
				STATUS = null;
			}
			
			if (IS_HUMAN)
				COLLABORATOR_USER_ID  = curAssessmentPlan.person_id;
			else
				COLLABORATOR_USER_ID  = curAssessmentPlan.department_id;
		
			if (curAssessmentPlan.boss_id.OptForeignElem != undefined)
				COLLABORATOR_EXPERT_ID = curAssessmentPlan.boss_id;
			else
			{
				COLLABORATOR_EXPERT_ID  = tools.get_user_boss(COLLABORATOR_USER_ID);	
				if (COLLABORATOR_EXPERT_ID != undefined)
					COLLABORATOR_EXPERT_ID = COLLABORATOR_EXPERT_ID.id;
			}
		
			CUSTOM_EXPERTS = curAssessmentPlan.custom_experts;
		}								
			
		curObject = curAssessmentPlan;
				
		_eval_str = curWorkflow.add_conditions.condition_eval_str;
		
		PERIOD = undefined;
		ASSESSMENT_STAGE = undefined;
		ASSESSMENT_STAGE_OBJECT = undefined;
		_pp = undefined;
		
		
		if ( curAssessmentPlan.assessment_appraise_matrix_id.HasValue )
		{
			USE_MATRIX = true;
			_trg = tools_ass.check_access_matrix(curAssessmentPlan.assessment_appraise_matrix_id , COLLABORATOR_USER_ID);
		}
		else
		{
			USE_MATRIX = false;
			_trg = undefined;
		}
		
		if (_trg != undefined)
		{
			ASSESSMENT_STAGE_OBJECT = _trg.stage.ForeignElem;
			if (ASSESSMENT_STAGE_OBJECT != undefined)
				ASSESSMENT_STAGE = ASSESSMENT_STAGE_OBJECT.id;
		}
		
		if ( eval(_eval_str) )
		{
			IS_MODIFY = true;
		}
		else
		{	
			IS_MODIFY = false;
		}
		
		
		
		if (_trg != undefined)
		{
		
			if (IS_MODIFY && _in_time)
			{
				if (_trg.period_id.HasValue)
				{
					assessmentAppraiseMatrix = OpenDoc(UrlFromDocID(curAssessmentPlan.assessment_appraise_matrix_id)).TopElem;
					PERIOD = assessmentAppraiseMatrix.periods.GetOptChildByKey(_trg.period_id);
					
					_pp = curAssessmentPlan.appraised_periods.GetOptChildByKey(PERIOD.period_id);
					
				}
				
				if (_pp != undefined && _pp.is_done )
				{
						_ALLOW_ADD = false;
						_ALLOW_DELETE = false;
						_ALLOW_PLAN_MODIFY = false;
						_ALLOW_MARK_MODIFY = false;
						IS_MODIFY = false;
				}

				else if (ASSESSMENT_STAGE_OBJECT != undefined)
				{
						_ALLOW_ADD = ASSESSMENT_STAGE_OBJECT.access.allow_add;
						_ALLOW_DELETE = ASSESSMENT_STAGE_OBJECT.access.allow_delete;
						_ALLOW_PLAN_MODIFY = ASSESSMENT_STAGE_OBJECT.access.allow_plan_modify;
						_ALLOW_MARK_MODIFY = ASSESSMENT_STAGE_OBJECT.access.allow_mark_modify;
				}
				else
				{
						_ALLOW_ADD = true;
						_ALLOW_DELETE = true;
						_ALLOW_PLAN_MODIFY = true;
						_ALLOW_MARK_MODIFY = true;
						IS_MODIFY = true;
				}
			}
			else
			{
				_ALLOW_ADD = false;
				_ALLOW_DELETE = false;
				_ALLOW_PLAN_MODIFY = false;
				_ALLOW_MARK_MODIFY = false;
			}
		}
		else if (curAssessmentPlan.assessment_appraise_matrix_id.HasValue || _in_time == false)
		{
			_ALLOW_ADD = false;
			_ALLOW_DELETE = false;
			_ALLOW_PLAN_MODIFY = false;
			_ALLOW_MARK_MODIFY = false;
			IS_MODIFY = false;
		} 
		else
		{
			if (_cur_assessment_appraise_type != undefined && _cur_assessment_appraise_type.PrimaryKey == "staffrating")
			{
				_appraise_area = _cur_assessment_appraise_type.flag_04;
			}
			else
				_appraise_area = undefined;
		
			switch(_appraise_area)
			{
				case "plan_modify":
					_ALLOW_ADD = IS_MODIFY;
					_ALLOW_DELETE = IS_MODIFY;
					_ALLOW_PLAN_MODIFY = IS_MODIFY;
					_ALLOW_MARK_MODIFY = false;
					break;
				case "mark_modify":
					_ALLOW_ADD = false;
					_ALLOW_DELETE = false;
					_ALLOW_PLAN_MODIFY = false;
					_ALLOW_MARK_MODIFY = IS_MODIFY;
					break;
				default:
					_ALLOW_ADD = IS_MODIFY;
					_ALLOW_DELETE = IS_MODIFY;
					_ALLOW_PLAN_MODIFY = IS_MODIFY;
					_ALLOW_MARK_MODIFY = IS_MODIFY;
			}
		}

%>	