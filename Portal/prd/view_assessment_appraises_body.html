<%
try
{
	use =Int(Request.Query.GetProperty("proc_type"));
}
catch(_net_)
{
	use = 0;
}
%>
<script language="JavaScript">
<!--
function check(obj_name)
{
  window.location.href='<%="view_doc.html?mode=assessment_appraises&doc_id="+curDocID%>' + '&proc_type=' + obj_name;
}
-->
</script>
<BR>
<TABLE width="100%" cellspacing="0" cellpadding="4" border="0">
<TR>
	<TD>
		<input type="radio" name="proc_type"  onclick="check(this.value)" value="0" <%=( use == 0 ? "checked" : "")%>/><%=tools_web.get_web_str("vaab_selector_all")%>
	</TD>
	<TD>
		<input type="radio" name="proc_type"  onclick="check(this.value)" value="1" <%=( use == 1 ? "checked" : "")%>/><%=tools_web.get_web_str("vaab_selector_planned")%>
	</TD>
	<TD>
		<input type="radio" name="proc_type"  onclick="check(this.value)" value="2" <%=( use == 2 ? "checked" : "")%>/><%=tools_web.get_web_str("vaab_selector_going_on")%>
	</TD>
	<TD>
		<input type="radio" name="proc_type"  onclick="check(this.value)" value="3" <%=( use == 3 ? "checked" : "")%>/><%=tools_web.get_web_str("vaab_selector_overdue")%>
	</TD>
	<TD>
		<input type="radio" name="proc_type"  onclick="check(this.value)" value="4" <%=( use == 4 ? "checked" : "")%>/><%=tools_web.get_web_str("vaab_selector_archive")%>
	</TD>
</TR>
</TABLE>
<br/>
<table width="100%"  border="0" cellspacing="0" cellpadding="3">
	<tr>
		<td class="tableHeaderWithText"><%=tools.get_web_str("vaasb_assessment_appraises")%></td>
	</tr>
	<tr>
		<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="1" height="1" /></td>
	</tr>
<%
counter = 0;
_end_date_time=DateNewTime(Date(),23,59,59);
switch ( use )
{
	case 0:
		   _assessment_appraises = XQuery( "for $assessment_appraise in assessment_appraises where $assessment_appraise/is_model = false() and $assessment_appraise/web_display = true() and  $assessment_appraise/status != '1' order by $assessment_appraise/name return $assessment_appraise" ) ;
		   break;
	 case 1:
		   _assessment_appraises = XQuery( "for $assessment_appraise in assessment_appraises where $assessment_appraise/is_model = false() and $assessment_appraise/web_display = true() and  $assessment_appraise/status != '1'  and $assessment_appraise/start_date>=date('" + _end_date_time +"')order by $assessment_appraise/name return $assessment_appraise" ) ;
		   break;
	 case 2:
	 //current;
		   _assessment_appraises = XQuery( "for $assessment_appraise in assessment_appraises where $assessment_appraise/is_model = false() and $assessment_appraise/web_display = true() and  $assessment_appraise/status != '1' and $assessment_appraise/start_date<=date('" + _end_date_time +"') and $assessment_appraise/end_date>=date('" + _end_date_time +"') order by $assessment_appraise/name return $assessment_appraise" ) ;
		   break;
	case 3:
		   _assessment_appraises = XQuery( "for $assessment_appraise in assessment_appraises where $assessment_appraise/is_model = false() and $assessment_appraise/web_display = true() and  $assessment_appraise/status != '1'  and $assessment_appraise/end_date<=date('" + _end_date_time +"') order by $assessment_appraise/name return $assessment_appraise" ) ;
		   break;
	 case 4:
		   _assessment_appraises = XQuery( "for $assessment_appraise in assessment_appraises where $assessment_appraise/is_model = false() and $assessment_appraise/web_display = true() and  $assessment_appraise/status = '1' order by $assessment_appraise/name return $assessment_appraise" ) ;
		   break;
}

for (_assessment_appraise in _assessment_appraises)
{
	flag_show = 0;
	teAssessmentAppraiseAbridged = OpenDoc(UrlFromDocID(_assessment_appraise.PrimaryKey), "form=").TopElem;
	if (_assessment_appraise.ignore_presence == true || _assessment_appraise.person_id == curUserID)
	{
		flag_show = 1
	}
	else if (ArrayOptFirstElem (ArraySelect(teAssessmentAppraiseAbridged.impersonate_persons, "impersonator_id == " + curUserID + " && face_person_id.HasValue && (from_date.HasValue == false || from_date <= DateNewTime(Date())) && (to_date.HasValue == false || to_date >= DateNewTime(Date()))")) != undefined )
	{
		flag_show = 1
	}
	else if ( ArrayOptFirstElem(  XQuery( "for $pa in pas where $pa/expert_person_id = " + curUserID + "  and $pa/assessment_appraise_id = " + _assessment_appraise.PrimaryKey + " return $pa" )) != undefined || ArrayOptFirstElem( XQuery( "for $pa in development_plans where $pa/expert_person_id = " + curUserID + "  and $pa/assessment_appraise_id = " + _assessment_appraise.PrimaryKey + " return $pa" )) != undefined  )
	{
		flag_show = 1;
	}
	else if ( ArrayOptFirstElem( XQuery( "for $pa in pas where $pa/person_id = " + curUserID + "  and $pa/assessment_appraise_id = " + _assessment_appraise.PrimaryKey + " return $pa" )) != undefined ||  ArrayOptFirstElem(XQuery( "for $pa in development_plans where $pa/person_id = " + curUserID + "  and $pa/assessment_appraise_id = " + _assessment_appraise.PrimaryKey + " return $pa" )  )  != undefined )
	{
		flag_show = 1;
	}
	else
	{
		_curAADoc = OpenDoc(UrlFromDocID(_assessment_appraise.PrimaryKey)).TopElem;

		_custom_experts_participants = ArraySelect(_curAADoc.participants, 'customize.is_custom_experts == true');

		if (_curAADoc.always_check_custom_experts || ArrayCount(_custom_experts_participants) > 0)
		if (ArrayOptFirstElem(  XQuery( 'for $pa in pas where $pa/assessment_appraise_id = ' + _assessment_appraise.PrimaryKey + ' and contains( $pa/custom_experts, "' + curUserID + '") return $pa' )) != undefined || ArrayOptFirstElem( XQuery( 'for $pa in development_plans where $pa/assessment_appraise_id = ' + _assessment_appraise.PrimaryKey + ' and contains( $pa/custom_experts, "' + curUserID + '") return $pa' ) ) !=undefined )
		{
			flag_show = 1;
		}
	}
	if (flag_show == 1)
	{
	_class = counter++ % 2 ? 'tableRowEven' : 'tableRowOdd';
%>

<TR VALIGN="MIDDLE">
	<TD class="<%=_class%>"><a HREF="view_doc.html?mode=assessment_appraise&doc_id=<%=curDocID%>&assessment_appraise_id=<%=_assessment_appraise.id%>"><%=tools_web.get_cur_lng_name(_assessment_appraise.name, curLng.short_id)%></a></TD>
</TR>
<%
	}
}
%>
	<tr>
		<td class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td>
	</tr>
</table>
<br/>
