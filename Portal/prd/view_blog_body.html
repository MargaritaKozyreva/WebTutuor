<%
curQueryStringWithoutSearch = tools_web.get_query_string( true, "key_word;search_text;page;");
curQueryStringWithoutPage = tools_web.get_query_string( true, "page;");

_key_word = Request.Query.HasProperty( 'key_word' ) ? String( Request.Query.key_word ) : '';
_search_text = Request.Query.HasProperty( 'search_text' ) ? String( Request.Query.search_text ) : '';
_mess_max_num = curBlog.num_message_in_list.HasValue ? curBlog.num_message_in_list : 20;
try
{
	_cur_page = Int( Request.Query.page );
}
catch(err)
{
	_cur_page = 1;
}

_is_author = ( curBlog.creator_id == curUserID || ArrayOptFind( curBlog.authors, "person_id==" + curUserID ) != undefined );

week_days = Array(tools.get_web_str('c_monday'),tools.get_web_str('c_tuesday'),tools.get_web_str('c_wednesday'),tools.get_web_str('c_thursday'),tools.get_web_str('c_friday'),tools.get_web_str('c_saturday'),tools.get_web_str('c_sunday'));
year_months = Array(tools.get_web_str('c_january'),tools.get_web_str('c_february'),tools.get_web_str('c_march'),tools.get_web_str('c_april'),tools.get_web_str('c_may'),tools.get_web_str('c_june'),tools.get_web_str('c_july'),tools.get_web_str('c_august'),tools.get_web_str('c_september'),tools.get_web_str('c_october'),tools.get_web_str('c_november'),tools.get_web_str('c_december'));

oRegExp = tools_web.reg_exp_init();
%>

<%Server.Execute( "view_desc.html" )%>
<br>

<table width="100%" border="0" cellspacing="0" cellpadding="3">
	<tr valign="top">
		<td width="75%">
<%
		blog_entry_array = Array();
		if ( _is_author )
		{
%>
		<div align="right"><a href="view_doc.html?mode=blog_entry_create&doc_id=<%=curDocID%>&blog_id=<%=curBlogID%>&action=create"><%=tools.get_web_str('vbb_mess_add')%></a></div>
<%		
		}
		
		if ( _key_word != "" )
		{
			blog_entry_array = ArrayDirect( XQuery(alert("for $elem in blog_entrys where $elem/blog_id=" + curBlogID +  "and contains($elem/labels, " + XQueryLiteral( _key_word ) + ") order by $elem/create_date descending return $elem")) );
%>	
			<hr>
			<%=tools.get_web_str('vbb_mess_by_word')%> "<b><%=HtmlEncode( _key_word )%></b>" (<%=ArrayCount( blog_entry_array )%>). &nbsp; <a href="<%=curQueryStringWithoutSearch%>"><%=tools.get_web_str('vbb_view_all_mess')%></a>
			<hr>
<%			
		}
		
		if ( _search_text != "" )
		{
			blog_entry_array = ArrayDirect( XQuery("for $elem in blog_entrys where $elem/blog_id=" + curBlogID + " and doc-contains($elem/id, 'DefaultDb', " + XQueryLiteral( _search_text ) + ") order by $elem/create_date descending return $elem") );
%>
			<hr>
			<%=tools.get_web_str('c_search_result')%> "<b><%=HtmlEncode( _search_text )%></b>" (<%=ArrayCount( blog_entry_array )%>): &nbsp; <a href="<%=curQueryStringWithoutSearch%>"><%=tools.get_web_str('vbb_view_all_mess')%></a>
			<hr>			
<%
		}
		
%>		
		<table cellspacing=0 cellpadding=0 width="100%" border=0>
<%
		if ( _key_word == "" && _search_text == "" )
			blog_entry_array = ArrayDirect( XQuery("for $elem in blog_entrys where $elem/blog_id=" + curBlogID + " order by $elem/create_date descending return $elem") );
		
		_blog_entry_count = ArrayCount( blog_entry_array );
		
		_start_index = 0;
		_end_index = ( _blog_entry_count > _mess_max_num ? _mess_max_num : _blog_entry_count );
		
		if ( _cur_page != 1 )
		{
			_start_index = _mess_max_num*(_cur_page - 1);
			_end_index = ( _blog_entry_count > _mess_max_num*_cur_page ? _mess_max_num*_cur_page : _blog_entry_count );
		}
		
		cur_date = Date(1980,01,01);
		
		for ( i = _start_index; i < _end_index; i++ )
		{
			_blog_entry = blog_entry_array[i];
			
			cur_author = ArraySelect( curBlog.authors, "person_id==" + curUserID );
			cur_author = ArraySelect( cur_author, "is_full_moderator==true" );
			_is_moderator = ( ArrayCount( cur_author ) != 0 || _blog_entry.person_id == curUserID );
			
			try
			{
				cur_blog_entry_url = UrlFromDocID( _blog_entry.id );
				cur_blog_entry_doc = OpenDoc( cur_blog_entry_url ).TopElem;
			}
			catch(err)
			{
				continue;
			}
			
			if ( DateNewTime( _blog_entry.create_date ) != DateNewTime( cur_date ) )
			{
				cur_date = _blog_entry.create_date;
				cur_week_day = WeekDay( cur_date );
				cur_date_str = week_days[ cur_week_day == 0 ? 6 : cur_week_day - 1 ] + ", " + Day( cur_date ) + " " + year_months[ Month( cur_date ) - 1 ] + " " + Year( cur_date );
%>			
		<tr>
			<td class="calendarHeader"><%=cur_date_str%></td>
		</tr>
<%
			}
%>		
		<tr>
			<td class=CL_forum_topic_name width="100%">&nbsp;<b><span id="CL_topicname_487035211350004"><%=HtmlEncode( cur_blog_entry_doc.name )%></span></b></td>
		</tr>
		<tr>
			<td class=CL_forum_topic_body><div class=CL_forum_topic_content><%=tools_web.convert_bbcode_to_html( tools_web.get_web_desc( cur_blog_entry_doc.text_area, cur_blog_entry_url, 'blog_entry.text_area' ),oRegExp )%></div></td>
		</tr>
		<tr>
			<td class=CL_forum_topic_author>
			<%=tools.get_web_str('vfb_author')%>:&nbsp;<a href="view_doc.html?mode=collaborator&doc_id=<%=curDocID%>&object_id=<%=_blog_entry.person_id%>"><%=_blog_entry.person_fullname%></a>, <%=StrTime( _blog_entry.create_date )%> &nbsp;&nbsp;&nbsp;&nbsp;
<%
			if ( _is_moderator )
				Response.Write('<a href="view_doc.html?mode=blog_entry_change&doc_id=' + curDocID + '&object_id='+ _blog_entry.id + '&action=save&blog_id=' + curBlogID + '">' + tools.get_web_str('c_edit') + '</a>');

			comment_array = XQuery("for $elem in blog_entry_comments where $elem/blog_entry_id = " + _blog_entry.id + " return $elem" );
%>

			&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<a href="view_doc.html?mode=blog_entry_comment&doc_id=<%=curDocID%>&object_id=<%=_blog_entry.id%>&blog_id=<%=curBlogID%>"><%=tools.get_web_str('c_comments')%>: <%=ArrayCount( comment_array )%></a>
			<br>
<%
			if ( _blog_entry.labels.HasValue )
			{
				label_array = String(_blog_entry.labels).split(",");
%>			
				<%=tools.get_web_str('vkpb_tag_name')%>: 
<%
				for ( _label in label_array )
				{
					if ( _label != "" )
					{
%>
					<a href="<%=curQueryStringWithoutSearch%>key_word=<%=Trim(_label)%>"><%=Trim(_label)%></a>&nbsp;
<%
					}
				}
%>				
				<br/>
<%
			}

			if ( cur_blog_entry_doc.files.ChildNum != 0 )
			{
%>
				
				<%=tools.get_web_str('vdb_files')%>:&nbsp;<%=ArrayMerge( cur_blog_entry_doc.files, 'f=PrimaryKey.OptForeignElem, ( f==undefined ? \'error\' : \'<a href="download_file.html?file_id=\' + PrimaryKey + \'&sid=\' + tools.get_sum_sid( PrimaryKey ) + \'">\' + f.name + \'</a>\' )', ', ' )%>
				<br/>
<%
			}
%>
			</td>
		</tr>
		<tr>
			<td>&nbsp;</td>
		</tr>
		
<%
		}
%>		
		</table>
<%
		if ( _blog_entry_count > _mess_max_num )
		{
			_page_count = Real( _blog_entry_count )%Real( _mess_max_num ) != 0 ? Int( Real( _blog_entry_count )/Real( _mess_max_num ) ) + 1 : Int( Real( _blog_entry_count )/Real( _mess_max_num ) );
%>		
			<center>
<%
			if ( _cur_page != 1 )
			{
%>			
				<a href="<%=curQueryStringWithoutPage%>page=<%=_cur_page-1%>">&lt;&lt; <%=tools.get_web_str('vbb_prev')%></a>&nbsp;&nbsp;
<%			
			}
			for( i = 1; i <= _page_count; i++ )
			{
				if ( i == _cur_page )
				{
%>
				<b><%=i%></b>&nbsp;
<%
				}
				else
				{
%>
					<a href="<%=curQueryStringWithoutPage%>page=<%=i%>"><%=i%></a>&nbsp;
<%				
				}
			}
			
			if ( _cur_page != _page_count )
			{
%>			
				&nbsp;&nbsp;<a href="<%=curQueryStringWithoutPage%>page=<%=_cur_page+1%>"><%=tools.get_web_str('vbb_next')%> &gt;&gt;</a>
<%
			}
%>
			</center>
<%
		}
%>		
		</td>

		
<script language="JavaScript">
	function search_click( )
	{
		var _search_text = document.getElementById("search_text_id").value;
		if ( _search_text != "" )
			document.location.href = "<%=curQueryStringWithoutSearch%>search_text=" + _search_text;
		else
			return;
	}
</script>		
		<td width="25%"> 
			<center><b><%=tools.get_web_str('vbbo_authors')%> (<%=ArrayCount( curBlog.authors )%>):</b></center>
			<br>
			<ul type="circle">
<%
			for ( _author in ArraySort( curBlog.authors, "person_fullname", "+" ) )
			{
%>
				<li><a href="view_doc.html?mode=collaborator&doc_id=<%=curDocID%>&object_id=<%=_author.person_id%>"><%=_author.person_fullname%></a></li>
<%				
			}
%>			
			</ul>
			<table border="0" width="100%">
				<tr>
					<td>
						<input type="text" name="search_text" id="search_text_id" value="<%=XmlAttrEncode( _search_text )%>">
					</td>
					<td>
						<input type="button" value="<%=tools.get_web_str('vkpb_search')%>" onclick="search_click();">
					</td>
				</tr>
			</table>
			<br>
<%
			person_subscriptions = XQuery("for $elem in subscriptions where $elem/document_id=" + curBlogID + " and $elem/person_id=" + curUserID + " return $elem");
			if ( ArrayCount( person_subscriptions ) > 0 )
			{
%>
				<a href="view_doc.html?mode=subscriptions&doc_id=<%=curDocID%>"><%=tools.get_web_str('vfb_del_subscript')%></a>
<%
			}
			else
			{
%>
				<a href="view_doc.html?mode=subscriptions&doc_id=<%=curDocID%>"><%=tools.get_web_str('vfb_add_subscript')%></a>
<%			
			}
%>
			<br><br>
			<img src="pics/rss_icon.jpg" width="24px" height="16px"><a href="rss.html?doc_id=<%=curBlogID%>">RSS</a>
		</td>
	</tr>
</table>