<%
curQueryString = tools_web.get_query_string( true, "show_content;");
curQueryStringWithoutPage = tools_web.get_query_string( true, "page;");

try
{
	show_content = ( Request.QueryString.show_content == "1" );
}
catch(err)
{
	show_content = true;
}

_mess_max_num = curBlog.num_message_in_list.HasValue ? curBlog.num_message_in_list : 20;
try
{
	_cur_page = Int( Request.QueryString.page );
}
catch(err)
{
	_cur_page = 1;
}

oRegExp = tools_web.reg_exp_init();
%>

<script language="JavaScript">
	function type_select(_value)
	{
		if ( _value == "name" )
			document.getElementById("name_block").style.display = 'inline';
		else
			document.getElementById("name_block").style.display = 'none';
	}
</script >

	<table width="100%" border="0" cellspacing="0" cellpadding="3">
		<tr valign="top">
			<td width="70%">
				<div align="right"> <a href="view_doc.html?mode=blog&doc_id=<%=curDocID%>&object_id=<%=curBlogID%>"><%=tools.get_web_str('vbecb_return')%></a> </div>
				<table cellspacing=0 cellpadding=0 width="100%" border=0>
					<tr>
						<td class=CL_forum_topic_name><%=HtmlEncode( curObject.name )%></td>
					</tr>
<%
					if ( show_content )
					{
%>
						<tr>
							<td class=CL_forum_topic_body><div class=CL_forum_topic_content><%=tools_web.convert_bbcode_to_html( tools_web.get_web_desc( curObject.text_area, UrlFromDocID( curObjectID ), 'blog_entry.text_area' ), oRegExp )%></div></td>
							
							<br/>
							<%Server.Execute( "view_files.html" )%>
						</tr>
						<tr>
							<td class=CL_forum_topic_author>
							<%=tools.get_web_str('vfb_author')%>:&nbsp;<a href="view_doc.html?mode=collaborator&doc_id=<%=curDocID%>&object_id=<%=curObject.person_id%>"><%=curObject.person_fullname%></a>, <%=curObject.create_date%> &nbsp;
							</td>
						</tr>
<%
					}
%>
				</table>
				<br>
<%
				_blog_entry_comment_array = ArrayDirect( XQuery( "for $elem in blog_entry_comments where $elem/blog_entry_id = " + curObjectID + " order by $elem/create_date ascending return $elem" ) );
				_blog_entry_count = ArrayCount( _blog_entry_comment_array );
%>
<b><%=tools.get_web_str('c_comments')%> (<%=_blog_entry_count%>)</b> &nbsp;&nbsp;
<%
				if ( show_content )
				{
%>
					<a href="<%=curQueryString%>show_content=0"><%=tools.get_web_str('vbecb_hide')%></a>
<%
				}
				else
				{
%>
					<a href="<%=curQueryString%>show_content=1"><%=tools.get_web_str('vbecb_show')%></a>
<%
				}
%>
				<br>
				<br>
			<table width="100%" border="0" cellspacing="0" cellpadding="3">
<%
				_start_index = 0;
				_end_index = ( _blog_entry_count > _mess_max_num ? _mess_max_num : _blog_entry_count );

				if ( _cur_page != 1 )
				{
					_start_index = _mess_max_num*(_cur_page - 1);
					_end_index = ( _blog_entry_count > _mess_max_num*_cur_page ? _mess_max_num*_cur_page : _blog_entry_count );
				}
				cur_author = ArraySelect( curBlog.authors, "person_id==" + curUserID );
				cur_author = ArraySelect( cur_author, "is_full_moderator==true" );
				_is_moderator = ( ArrayCount( cur_author ) != 0 || curObject.person_id == curUserID );
%>

<script language="javascript">
	function delete_item( _comment_id )
	{
		document.forms['comment_change_form'].action.value = "delete";
		document.forms['comment_change_form'].comment_id.value = _comment_id;

		if (window.confirm(<%=CodeLiteral( tools.get_web_str('vbecb_del_confirm') )%>))
			document.all["comment_change_form"].submit();
	}
</script>

<form action="blog_entry_comment_change.html" method="post" name="comment_change_form">
<input type="hidden" name="doc_id" value="<%=curDocID%>">
<input type="hidden" name="sid" value="<%=tools.get_sum_sid( curDocID )%>">
<input type="hidden" name="blog_id" value="<%=curBlogID%>">
<input type="hidden" name="object_id" value="<%=curObjectID%>">
<input type="hidden" name="action" value="">
<input type="hidden" name="comment_id" value="">
<%
				for ( i = _start_index; i < _end_index; i++ )
				{
					_blog_entry_comment = _blog_entry_comment_array[i];
					try
					{
						_blog_entry_commentDoc = OpenDoc( UrlFromDocID( _blog_entry_comment.id ) ).TopElem;
					}
					catch(err)
					{
						continue;
					}
%>

						<tr>
							<td>
								<b>
<%
						if ( _blog_entry_commentDoc.type == "fullname" )
						{
%>
							<a href="view_doc.html?mode=collaborator&doc_id=<%=curDocID%>&object_id=<%=_blog_entry_commentDoc.person_id%>"><%=HtmlEncode( _blog_entry_commentDoc.creator_name )%></a>
<%
						}
						else
						{
%>
							<%=HtmlEncode( _blog_entry_commentDoc.creator_name )%>
<%
						}
%>
								</b>
							</td>
						</tr>
						<tr>
							<td>
								<%=HtmlEncode( _blog_entry_commentDoc.message )%>
							</td>
						</tr>
						<tr>
							<td>
								<%=_blog_entry_commentDoc.create_date%>&nbsp;&nbsp;
<%
							if ( _is_moderator )
							{
%>
								<a href="#"><img src="\pics\Delete_3.gif" alt="" name="delete_comment" id="<%=_blog_entry_comment.id%>" onclick="delete_item(this.id);" border="0"/></a>
<%
							}
%>
							</td>
						</tr>
						<tr>
							<td>&nbsp;</td>
						</tr>
<%
				}
%>
			</form>
					</table>

<%
		if ( _blog_entry_count > _mess_max_num )
		{
			_page_count = Real( _blog_entry_count )%Real( _mess_max_num ) != 0 ? Int( Real( _blog_entry_count )/Real( _mess_max_num ) ) + 1 : Int( Real( _blog_entry_count )/Real( _mess_max_num ) );
%>
			<center>
<%
			if ( _cur_page != 1 )
			{
%>
				<a href="<%=curQueryStringWithoutPage%>page=<%=_cur_page-1%>">&lt;&lt; <%=tools.get_web_str('vbb_prev')%></a>&nbsp;&nbsp;
<%
			}
			for( i = 1; i <= _page_count; i++ )
			{
				if ( i == _cur_page )
				{
%>
				<b><%=i%></b>&nbsp;
<%
				}
				else
				{
%>
					<a href="<%=curQueryStringWithoutPage%>page=<%=i%>"><%=i%></a>&nbsp;
<%
				}
			}

			if ( _cur_page != _page_count )
			{
%>
				&nbsp;&nbsp;<a href="<%=curQueryStringWithoutPage%>page=<%=_cur_page+1%>"><%=tools.get_web_str('vbb_next')%> &gt;&gt;</a>
<%
			}
%>
			</center>
<%
		}
%>
		</td>
<%
if ( curObject.allow_comment )
{
%>
		<td width="30%">
	<form name="add_comment" action="blog_entry_comment_change.html" method="post">
		<input type="hidden" name="object_id" value="<%=curObjectID%>">
		<input type="hidden" name="doc_id" value="<%=curDocID%>">
		<input type="hidden" name="sid" value="<%=tools.get_sum_sid( curDocID )%>">
		<input type="hidden" name="blog_id" value="<%=curBlogID%>">
		<input type="hidden" name="action" value="create">
		<center><b><%=tools.get_web_str('c_comment')%>:</b></center>
		<br>
		<center><textarea cols="30" rows="10" name="comment_body"></textarea></center>
		<br>
<%
		if ( curBlog.allow_anonymous_comment )
		{
%>
		<input type="radio" name="type" value="fullname" onclick="type_select(this.value)" CHECKED> <%=tools.get_web_str('vbecb_show_private')%><br/>
		<input type="radio" name="type" value="name" onclick="type_select(this.value)"> <%=tools.get_web_str('uf_name')%> &nbsp;
		<div id="name_block" style="display: none" align="right">
			<input type="text" name="name">
			<br>
		</div>
		<br>
		<input type="radio" name="type" value="anonymous" onclick="type_select(this.value)"> <%=tools.get_web_str('vfb_how_show_anonymous')%><br>
<%
		}
%>
		<br>
		<center> <input type="submit" value="<%=tools.get_web_str('vcb_submit')%>"> </center>
	</form>
		</td>
<%
}
%>
	</tr>

</table>