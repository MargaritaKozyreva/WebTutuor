<%
	_hide_dismissed = (Request.Query.HasProperty("hide_dismissed") && Request.Query.GetProperty("hide_dismissed") == "1");

	if (!Request.Query.HasProperty("hide_dismissed"))
	{	
		try
		{
			if (Trim(curDoc.wvars.ObtainChildByKey('show_hide_dismissed_by_default').value)!="")
			{
				_hide_dismissed=Int(curDoc.wvars.ObtainChildByKey('show_hide_dismissed_by_default').value)>=1?true:false;
			}
		}
		catch(ex)
		{
		}
	}
%>
<script language="javascript">
	<!--
		function toggle_boss_section(_id)
		{
			var _href = "view_doc.html?mode=<%=curMode%>&doc_id=<%=curDocID%><%=(_hide_dismissed?"&hide_dismissed=1":"&hide_dismissed=0")%>&tab=" + _id;
			window.location.href = _href;
		}
	-->
</script>
	
<style>
	.tab_td {
		border-right: #aaaaaa 1px solid; border-top: #aaaaaa 1px solid; border-left: #aaaaaa 1px solid; border-bottom: #aaaaaa 1px solid; text-align: center; background-color: #EEEEEE;
	}
	.tab_td_sel {
		border-right: #aaaaaa 1px solid; border-top: #aaaaaa 1px solid; border-left: #aaaaaa 1px solid; border-bottom: #aaaaaa 0px solid; text-align: center; font-weight:bold; height:24px;
	}
	.tab_td_empty {
		border-bottom: #aaaaaa 1px solid;
	}
</style>

<%
if (Request.Query.HasProperty("tab"))
	_selectedTab = Int(Request.Query.GetProperty("tab"));
else
	_selectedTab = 0;
%>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
	<tr>
		<td class="tab_td_empty"><img src="pics/1blank.gif" width="10" height="0"/></td>
		
		<td class="<%=(_selectedTab == 0 ? "tab_td_sel" : "tab_td")%>" id="td_0" onclick=""><img src="pics/1blank.gif" width="140" height="0"/><br/><a style="text-decoration:none" href="#" onclick="toggle_boss_section(0)"><%=tools.get_web_str('c_collaborators')%></a></td>
		<td class="tab_td_empty" width="10px">&nbsp;</td>
		
		<td class="<%=(_selectedTab == 1 ? "tab_td_sel" : "tab_td")%>" id="td_1" onclick=""><img src="pics/1blank.gif" width="140" height="0"/><br/><a style="text-decoration:none" href="#" onclick="toggle_boss_section(1)"><%=tools.get_web_str('c_requests')%></a></td>
		<td class="tab_td_empty" width="10px">&nbsp;</td>
		
		<td class="<%=(_selectedTab == 2 ? "tab_td_sel" : "tab_td")%>" id="td_2" onclick=""><img src="pics/1blank.gif" width="140" height="0"/><br/><a style="text-decoration:none" href="#" onclick="toggle_boss_section(2)"><%=tools.get_web_str('c_budget')%></a></td>
		<td class="tab_td_empty" width="10px">&nbsp;</td>
		
		<td class="<%=(_selectedTab == 3 ? "tab_td_sel" : "tab_td")%>" id="td_3" onclick=""><img src="pics/1blank.gif" width="140" height="0"/><br/><a style="text-decoration:none" href="#" onclick="toggle_boss_section(3)"><%=tools.get_web_str('c_reports')%></a></td>
		<td class="tab_td_empty" width="10px">&nbsp;</td>
		
		<td class="tab_td_empty" width="100%">&nbsp;</td>
	</tr>
	</table>
<br/>
<%
	if (_selectedTab == 0)
	{
%>
<script src="scripts\tree\ua000000.js"></script>
<script src="scripts\tree\ftiens40.js"></script>
<script language="javascript">
function daddy_plusplus(_object)
{
	while (_object.parentObj)
	{
		_object.total_sum = parseInt(_object.total_sum) + 1;
		_object = _object.parentObj;
	}
}
function paint_sum(_object)
{	
	if(_object.total_sum)
		_object.desc = _object.desc + "&nbsp;<b>[" + _object.total_sum + "]</b>";
	
	if(_object.children)
	for (var _i = 0; _i < _object.children.length; _i++)
	{
		paint_sum(_object.children[_i]);
	}	
}


USETEXTLINKS = 1;
STARTALLOPEN = 0;
USEFRAMES = 0;
USEICONS = 0;
WRAPTEXT = 1;
PRESERVESTATE = 1;
ICONPATH = "scripts/tree/";

<%

if (Request.Query.HasProperty("flush") && Request.Query.GetProperty("flush") == "1")
{
	Session.tree_cache = undefined;
	Session.users = Array();
}
else
{
	try
	{
		Session.tree_cache;
		Session.users;
	}
	catch(_netu_)
	{
		Session.tree_cache = undefined;
		Session.users = Array();
	}
}

_default_org = null;


if (Session.tree_cache == undefined)
{

_href = "view_doc.html?mode=" + curMode + "&doc_id=" + curDocID + "&all=1&tab=" + _selectedTab + (_hide_dismissed?"&hide_dismissed=1":"&hide_dismissed=0");
_STREAM = "foldersTree = gFld('<b>" + tools.get_web_str("vmpb_all_subordinates") + "</b>', '" + _href + "');\n";

var subs_var = "";
var orgs_var = "";

function add_org(_org, _html)
{
	if (StrContains(orgs_var, _org.id) == false)
	{
		_href = "view_doc.html?mode=" + curMode + "&doc_id=" + curDocID + "&org_id=" + _org.id + "&tab=" + _selectedTab + (_hide_dismissed?"&hide_dismissed=1":"&hide_dismissed=0");
		_STREAM = _STREAM + ('var org' + _org.id +' = insFld(foldersTree, gFld("<img src=\'pics/org.ico\' border=0/>&nbsp;'+HtmlEncode(_org.disp_name) + _html +'", "' + _href + '")); \n');
		_STREAM = _STREAM + ('org' + _org.id + '.total_sum = 0;\n');
		orgs_var = orgs_var + _org.id;
		if (_default_org == null) _default_org = _org.id;
	}
}

function add_sub(_sub, _html, iDepth)
{
	if (StrContains(subs_var, _sub.id) == false)
	{
		_parent_object = _sub.parent_object_id.OptForeignElem;
		if (_parent_object != undefined && iDepth < 10)
		{
			add_sub(_sub.parent_object_id.ForeignElem, "", iDepth+1);
			_parent = 'sub' + _sub.parent_object_id;
		}
		else if (_sub.org_id.HasValue && _sub.org_id.OptForeignElem != undefined)
		{
			add_org(_sub.org_id.ForeignElem, "");
			_parent = 'org' + _sub.org_id;
		}
		else
		{
			_parent = 'foldersTree';
		}
		
		_href = "view_doc.html?mode=" + curMode + "&doc_id=" + curDocID + "&subdivision_id=" +_sub.PrimaryKey + "&tab=" + _selectedTab + (_hide_dismissed?"&hide_dismissed=1":"&hide_dismissed=0");
		
		_STREAM = _STREAM + ('var sub' + _sub.id +' = insFld( ' + _parent + ', gFld("<img src=\'pics/subdivision.ico\' border=0/>&nbsp;'+HtmlEncode(_sub.name)+ _html +'", "' + _href + '")); \n');
		
		_STREAM = _STREAM + ('sub' + _sub.id + '.total_sum = 0;\n');
		
		subs_var = subs_var + _sub.id + ",";
	}
}


function add_position(_position, _html)
{
	_parent_object = _position.parent_object_id.OptForeignElem;
	if (_parent_object != undefined)
	{
		add_sub(_parent_object, "", 0);
		_parent = 'sub' + _position.parent_object_id;
	}
	else if (_position.org_id.HasValue && _position.org_id.OptForeignElem != undefined)
	{
		add_org(_position.org_id.ForeignElem, "");
		_parent = 'org' + _position.org_id;
	}	
	else
	{
		_parent = 'foldersTree';
	}
	
	//_STREAM = _STREAM + ("insDoc( " + _parent + ", gLnk('S', '<b>" + _position.basic_collaborator_fullname + _html + "</b>' , '" + tools_web.get_url_protocol( Request.Url ) + Request.UrlHost + UrlPath( Request.Url ) + "?mode=" + curMode + "&doc_id=" + curDocID + "&person_id=" + _position.basic_collaborator_id + "&tab=" + _selectedTab + (_hide_dismissed?"&hide_dismissed=1":"")+"'));\n");
	_STREAM = _STREAM + ("daddy_plusplus(" + _parent+ ");\n");	
}

_elems_full = Array();

if (curUser.access.access_role != "admin" && curUser.access.access_role != "hr")
{
	_elems_full = tools.get_sub_persons_by_func_manager_id(curUserID);
}
else
{
	_elems_full = collaborators;
}


for (_collab in _elems_full)
{
	if (_hide_dismissed && _collab.is_dismiss) continue;
	_posarr = _collab.position_id.OptForeignElem;
	if (_posarr != undefined)
	{
		add_position(_posarr, "");
	}
}

curGroupArray = XQuery("for $elem in func_managers where $elem/person_id = " + curUserID + " and $elem/catalog = 'group' return $elem");

for (_group_entry in curGroupArray)
{
	try
	{
		groupDoc = OpenDoc(UrlFromDocID(_group_entry.object_id)).TopElem;
	}
	catch(_blya_)
	{
		continue;
	}
		
	_href = "view_doc.html?mode=" + curMode + "&doc_id=" + curDocID + "&group_id=" + _group_entry.object_id + "&tab=" + _selectedTab + (_hide_dismissed?"&hide_dismissed=1":"&hide_dismissed=0");
	_STREAM = _STREAM + ("var group" + _group_entry.object_id + " = insDoc( foldersTree, gLnk('S', '<img src=\"pics/group.ico\" border=0/>&nbsp;" + groupDoc.name + "' , '" + _href + "'));\n");
	_STREAM = _STREAM + "group" + _group_entry.object_id + ".total_sum = " + ArrayCount(groupDoc.collaborators) + ";\n";
}

Session.tree_cache = _STREAM;
Session.users = _elems_full;

}


Response.Write(Session.tree_cache);
%>
paint_sum(foldersTree);

</script>


<table border="0" width="100%" style="height:100%">
<tr>
	<td id="treeArea" width="300px" valign="top">
		<span class="TreeviewSpanArea" style="overflow:auto; width:300px">
			<script>initializeDocument();</script>
		</span>
		<p>
		<input type="checkbox" name="hide_dismissed" value="1" <%=(_hide_dismissed?"checked":"")%> onclick="var _href = '<%=tools_web.get_query_string(true, "hide_dismissed;flush")%>flush=1' + (this.checked ? '&hide_dismissed=1': '&hide_dismissed=0'); window.location.href = _href;"/><%=tools.get_web_str('c_no_disp_dismiss')%>
		</p>
	</td>
	<td valign="top">
	<%
		try
		{
			_god_message = Session.r_msg;
		}
		catch(_god_message_err_)
		{
			_god_message = undefined;
		}
		
		Session.r_msg = undefined;
		
		if (_god_message != undefined)
		{
	%>
		<center style="font-weight: bold"><%=_god_message%></center>
	<%
		}
	%>
	
	<FORM ACTION="operation_process.html" NAME="action_process" METHOD="POST">
	<input type="hidden" name="selected_object_ids" id="selected_object_ids" value=""/>
	<input type="hidden" name="element_ids" id="element_ids"/>
	<input type="hidden" name="element_value" id="element_value"/>
	<input type="hidden" name="href" value="<%=(UrlPath(Request.Url) +"?"+ UrlParam(Request.Url))%>"/>
	<input type="hidden" name="redirect" value="<%=curMode%>"/>
	<input type="hidden" name="mode" value="<%=curMode%>"/>
	<input type="hidden" name="action_id" id="action_id" value=""/>
	<input type="hidden" name="sid" value="<%=tools.get_sum_sid( curDocID )%>">
	
<%
	_spat_id = Array();
	
	if ( Request.QueryString.HasProperty("subdivision_id") )
	{
		positionArray = XQuery( "CatalogHierSubset('subs'," + Request.QueryString.subdivision_id + ")" );
		positionArray = ArraySelect( positionArray, 'basic_collaborator_id.HasValue' );
		curPersonsArray = ArrayExtract( positionArray, 'basic_collaborator_id' );
		curPersonsArray = QueryCatalogByKeys( 'collaborators', 'id', curPersonsArray );
		_structure = OpenDoc(UrlFromDocID(Int(Request.QueryString.GetProperty("subdivision_id")))).TopElem;
		_structure_name = "<img src='pics/subdivision.ico' border='0'/>&nbsp;" + tools.get_web_str("c_subd") + ": " + _structure.name;
		_bz = 0;
		_spat_id[0] = Int(Request.QueryString.GetProperty("subdivision_id"));
		
		_parent_document_object = ArrayOptFirstElem(XQuery("for $sub in subdivisions where $sub/id = "+XQueryLiteral(_structure.parent_object_id)+ " return $sub"));
		while (_parent_document_object != undefined)
		{
			_spat_id[(_bz++)] = _parent_document_object.PrimaryKey;
			_parent_document_object = ArrayOptFirstElem(XQuery("for $sub in subdivisions where $sub/id = "+XQueryLiteral(_parent_document_object.parent_object_id)+ " return $sub"));
		}
		
		if (_structure.org_id)
			_spat_id[(_bz++)] = _structure.org_id;
	}
	else if (Request.QueryString.HasProperty("org_id"))
	{
		curPersonsArray = XQuery("for $elem in collaborators where $elem/org_id = " + Request.QueryString.GetProperty("org_id") + " return $elem");
		_structure_name = "<img src='pics/org.ico' border='0'/>&nbsp;" + tools.get_web_str("c_org") + ": " + OpenDoc(UrlFromDocID(Int(Request.QueryString.GetProperty("org_id")))).TopElem.disp_name;
		_spat_id[0] = Int(Request.QueryString.GetProperty("org_id"));
	}
	else if (Request.QueryString.HasProperty("do") && _default_org!= null && Request.QueryString.GetProperty("do") == "1")
	{
		curPersonsArray = XQuery("for $elem in collaborators where $elem/org_id = " + _default_org + " return $elem");
		_structure_name = "<img src='pics/org.ico' border='0'/>&nbsp;" + tools.get_web_str("c_org") + ": " + OpenDoc(UrlFromDocID(_default_org)).TopElem.name;
		_spat_id[0] = _default_org;
	}
	else if ( Request.QueryString.HasProperty("group_id") )
	{
		groupDoc = OpenDoc(UrlFromDocID(Int(Request.QueryString.GetProperty("group_id")))).TopElem;
		curPersonsArray = ArrayExtract( groupDoc.collaborators, 'collaborator_id' );
		curPersonsArray = QueryCatalogByKeys( 'collaborators', 'id', curPersonsArray );
		_structure_name = "<img src='pics/group.ico' border='0'/>&nbsp;" + tools.get_web_str("c_group") + ": " + groupDoc.name;
		_spat_id[0] = Int(Request.QueryString.GetProperty("group_id"));
	}
	else if ( Request.QueryString.HasProperty("all") && Request.QueryString.GetProperty("all") == "1" )
	{
		curPersonsArray = Session.users;
		_structure_name = tools.get_web_str("vmpb_all_subordinates");
	}
	else
	{
		_structure_name = "-";
		curPersonsArray = Array();
	}
	
	_i_m_in = (ArrayOptFind(curPersonsArray, "id == curUserID") != undefined);
		
	
	//////////////////////////////////
	function and(_specie1, _specie2)
	{
		_specie1 = ArraySort(_specie1, 'PrimaryKey', '+');
		_specie2 = ArraySort(_specie2, 'PrimaryKey', '+');
		
		_hybrid = Array();
		
		_ac1 = ArrayCount(_specie1);
		_ac2 = ArrayCount(_specie2);
		_i=0;
		_j=0;
		_k=0;
	
		while (_i < _ac1 && _j < _ac2)
		{
			if (_specie1[_i].PrimaryKey == _specie2[_j].PrimaryKey)
			{
				_hybrid[_k] = _specie1[_i];
				_i++;
				_j++;
				_k++;
			}
			else if (_specie1[_i].PrimaryKey > _specie2[_j].PrimaryKey)
				_j++;
			else
				_i++;
		}
		
		return _hybrid;
	
	}
	/////////////////////////////////////
	
	if (ArrayOptFirstElem(curPersonsArray) != undefined)
	{
		curPersonsArray = and(curPersonsArray, Session.users)
		if (_hide_dismissed)
			curPersonsArray = ArraySelectByKey(curPersonsArray, false,"is_dismiss");
			
		curView = new Object;
		curView.SetProperty( 'id', 'c_list' );
		curView.SetProperty( 'catalog_name', 'collaborator' );
		curView.SetProperty( 'disp_link', 'true' );
		curView.SetProperty( 'disp_check_box', 'true' );
		curView.SetProperty( 'title', _structure_name );
		curView.SetProperty( 'array', curPersonsArray );

		Server.Execute( "view_catalog_list.html" );
	
		_op_arr = Array();
		
		_a = ArrayExtract(curPersonsArray, "id");
		if (_i_m_in)
			_a[ArrayCount(_a)] = curUser.position_id;
		
		_fmarr = ArrayUnion(QueryCatalogByKeys("func_managers", "object_id", _a));
		
		for (_elem in ArraySelect(_fmarr, "person_id == curUserID"))
		{
			_a = _elem.boss_type_id.OptForeignElem;
			if (_a != undefined)
			{
				_op_arr[ArrayCount(_op_arr)] = _a;
			}
		}
		
		_fmarr = Array();
		_i = 0;
		for(_a in _op_arr)
		{
			if (_i > 0)
			{
				_na = Array();
				for (_j in _fmarr)
					if (StrContains(_a.operations, _j))
					if (_j + "" != "")
						_na[ArrayCount(_na)] = Int(_j);
				_fmarr = _na;
			}
			else
			{
				_fmarr = String(_a.operations).split(";");
				for (_j = 0; _j < ArrayCount(_fmarr); _j++)
				if (_fmarr[_j] + "" != "")
					_fmarr[_j] = Int(_fmarr[_j]);
			}
			if (ArrayCount(_fmarr) == 0)
				break;
			
			_i++;
		}
		
		if (ArrayCount(_spat_id) > 0 )
		{
			_elems = ArraySelect(QueryCatalogByKeys("func_managers", "object_id", _spat_id), "person_id == "+ curUserID);
			
			for (_elem in _elems)
			{
				_a = _elem.boss_type_id.OptForeignElem;
				if (_a != undefined)
				{
					_na = String(_a.operations).split(";");
					for (_j = 0; _j < ArrayCount(_na); _j++)
					if (_na[_j] + "" != "")
						_na[_j] = Int(_na[_j]);
					
					_fmarr = ArraySelectDistinct( ArrayUnion(_fmarr, _na) , "This");
				}
			}
		}
	
		_selectedActions = QueryCatalogByKeys("operations", "id", _fmarr);
		_selectedActions = ArraySelect(_selectedActions, "operation_type == 0");
%>
	<script language="javascript">
	<!--
		function toggle_check_selection(_check)
		{
			_arr = document.all["select_check_box_c_list"];
			if (_arr != undefined)
			if (_arr.length != undefined)
			{
				for (var i = 0; i < _arr.length; i++)
					_arr[i].checked = _check;
			}
			else
				_arr.checked = _check;
		}
		
		function prepare_data(_a_id)
		{
			document.getElementById("action_id").value = _a_id;
			
			return true;
		}
		
		function filling_selected_object_ids()
		{
			return filling_selected_object_idsc_list();
		}
		
		
		<%
			for (_a in _selectedActions)
			{
		%>
			function f_<%=_a.id%>()
			{
				var ELEMENT_IDS = "";
				var ELEMENT_VALUE = "";
				<%=EvalCodePage(tools_web.get_operation_script(_a.id, true))%>
				document.getElementById("element_ids").value = ELEMENT_IDS;
				document.getElementById("element_value").value = ELEMENT_VALUE;
				return true;
			}
		<%
			}
		%>
		
		
	-->
	</script>
	<a href="#" onclick="toggle_check_selection(true); return false;"><%=tools.get_web_str("c_select_all")%></a> &nbsp; <a href="#" onclick="toggle_check_selection(false); return false;"><%=tools.get_web_str("c_deselect_all")%></a>
	<br/><br/>
	<center>
	<%
		_operation_n = 0;
		_group = "";
		for (_action in ArraySort(_selectedActions, "group", "+"))
		{
			if (_operation_n > 0 && _group != _action.group) Response.Write("<hr/>");
	%>
		<input type="submit" id="_a_<%=_action.id%>" onclick="if (prepare_data('<%=_action.id%>')) return f_<%=_action.id%>(); else return false;" value="<%=_action.name%>" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';"/>
	<%
			_group = _action.group + "";
			_operation_n++;
		}
	%>
	</center>
<%
	}
%>
	</form>	
		
	</td>
</tr>
</table>
<%
	}
	
	if (_selectedTab == 1)
	{
		curPostMode = curMode + "&tab=" + _selectedTab;
		dispWorkflowProcessing = true;
		Server.Execute('view_requests_body.html');
	}
	
	if (_selectedTab == 2)
	{
		_displayMode = curMode + "&tab=" + _selectedTab;
		Server.Execute("view_budget_report_body.html");
	}
	
	if (_selectedTab == 3)
	{
		if (Request.QueryString.HasProperty("object_id"))
		{
			curReportID = curObjectID;
			curReportDoc = curObjectDoc;
			curReport = curObject;
			_href_suffix = "tab=" + _selectedTab;
			if (curReport.Name == "custom_report")
			{
				if ( tools_web.check_access( curReport, curUserID, curUser, Session ) )
					Server.Execute("view_custom_report_body.html");
			}
			else if (curReport.Name == "custom_web_template")
			{
				Response.Write(tools_web.insert_custom_code(curReportID, curReportDoc));
			}
		}
		else
		{
%>
		<table width="100%"  border="0" cellspacing="0" cellpadding="3">
			<tr>
				<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="1" height="1" /></td>				
			</tr>
<%
		_crs = XQuery("for $elem in custom_reports where $elem/access_block_type = 'boss_panel' return $elem");
		counter = 0;
		for (_custom_report in _crs)
		{
			_class = counter++ % 2 ? "tableRowEven" : "tableRowOdd";
			%>
				<TR VALIGN="MIDDLE">					
					<TD class="<%=_class%>"><a HREF="view_doc.html?mode=<%=curMode%>&object_id=<%=_custom_report.id%>&doc_id=<%=curDocID%>&tab=<%=_selectedTab%>"><%=_custom_report.name%></a></TD>
				</TR>
			<%
		}
		
		_custom_web_templates = XQuery("for $elem in custom_web_templates where contains($elem/code, 'boss_panel_custom_report') return $elem");
		for (_custom_report in _custom_web_templates)
		if (StrBegins(_custom_report.code.Value, "boss_panel_custom_report"))
		{
			_class = counter++ % 2 ? "tableRowEven" : "tableRowOdd";
			%>
				<TR VALIGN="MIDDLE">					
					<TD class="<%=_class%>"><a HREF="view_doc.html?mode=<%=curMode%>&object_id=<%=_custom_report.id%>&doc_id=<%=curDocID%>&tab=<%=_selectedTab%>"><%=_custom_report.name%></a></TD>
				</TR>
			<%
		}
%>
			<tr>
				<td class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td>
			</tr>
		</table>
<%
		}
	}
%>
	