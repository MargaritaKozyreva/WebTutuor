<%
	_hide_dismissed = (Request.Query.HasProperty("hide_dismissed") && Request.Query.GetProperty("hide_dismissed") == "1");
	bPaging = (Request.Query.GetOptProperty("nopaging", "0") != "1");
	
	if (!Request.Query.HasProperty("hide_dismissed"))
	{	
		try
		{
			if (Trim(curDoc.wvars.ObtainChildByKey('show_hide_dismissed_by_default').value)!="")
			{
				_hide_dismissed=Int(curDoc.wvars.ObtainChildByKey('show_hide_dismissed_by_default').value)>=1?true:false;
			}
		}
		catch(ex)
		{
		}
	}
%>
<script language="javascript">
	<!--
		function toggle_boss_section(_id)
		{
			var _href = "view_doc.html?mode=<%=curMode%>&doc_id=<%=curDocID%><%=(_hide_dismissed?"&hide_dismissed=1":"&hide_dismissed=0")%>&tab=" + _id;
			window.location.href = _href;
		}
	-->
</script>
	
<style>
	.tab_td {
		border-right: #aaaaaa 1px solid; border-top: #aaaaaa 1px solid; border-left: #aaaaaa 1px solid; border-bottom: #aaaaaa 1px solid; text-align: center; background-color: #EEEEEE;
	}
	.tab_td_sel {
		border-right: #aaaaaa 1px solid; border-top: #aaaaaa 1px solid; border-left: #aaaaaa 1px solid; border-bottom: #aaaaaa 0px solid; text-align: center; font-weight:bold; height:24px;
	}
	.tab_td_empty {
		border-bottom: #aaaaaa 1px solid;
	}
</style>

<%
if (Request.Query.HasProperty("tab"))
	_selectedTab = Int(Request.Query.GetProperty("tab"));
else
	_selectedTab = 0;
%>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
	<tr>
		<td class="tab_td_empty"><img src="pics/1blank.gif" width="10" height="0"/></td>
		
		<td class="<%=(_selectedTab == 0 ? "tab_td_sel" : "tab_td")%>" id="td_0" onclick=""><img src="pics/1blank.gif" width="140" height="0"/><br/><a style="text-decoration:none" href="#" onclick="toggle_boss_section(0)"><%=tools.get_web_str("c_collaborators")%></a></td>
		<td class="tab_td_empty" width="10px">&nbsp;</td>
		
		<td class="<%=(_selectedTab == 1 ? "tab_td_sel" : "tab_td")%>" id="td_1" onclick=""><img src="pics/1blank.gif" width="140" height="0"/><br/><a style="text-decoration:none" href="#" onclick="toggle_boss_section(1)"><%=tools.get_web_str("c_requests")%></a></td>
		<td class="tab_td_empty" width="10px">&nbsp;</td>
		
		<td class="<%=(_selectedTab == 2 ? "tab_td_sel" : "tab_td")%>" id="td_2" onclick=""><img src="pics/1blank.gif" width="140" height="0"/><br/><a style="text-decoration:none" href="#" onclick="toggle_boss_section(2)"><%=tools.get_web_str("c_budget")%></a></td>
		<td class="tab_td_empty" width="10px">&nbsp;</td>
		
		<td class="<%=(_selectedTab == 3 ? "tab_td_sel" : "tab_td")%>" id="td_3" onclick=""><img src="pics/1blank.gif" width="140" height="0"/><br/><a style="text-decoration:none" href="#" onclick="toggle_boss_section(3)"><%=tools.get_web_str("c_reports")%></a></td>
		<td class="tab_td_empty" width="10px">&nbsp;</td>
		
		<td class="tab_td_empty" width="100%">&nbsp;</td>
	</tr>
</table>
<br/>

<%
	if (_selectedTab == 0)
	{
%>

<link rel="stylesheet" href="/scripts/jqplugins/treeview/jquery.treeview.css"/>
<script src="/scripts/jqplugins/jquery.cookie.js" type="text/javascript"></script>
<script src="/scripts/jqplugins/treeview/jquery.treeview.js" type="text/javascript"></script>
<style type="text/css">
<!--
span.org
{
	background-image:url(pics/org.ico);
	background-repeat:no-repeat;
	padding-left: 20px;
}
span.subdivision
{
	background-image:url(pics/subdivision.ico);
	background-repeat:no-repeat;
	padding-left: 20px;
}
span.group
{
	background-image:url(pics/group.ico);
	background-repeat:no-repeat;
	padding-left: 20px;
}
-->
</style>
<%
	_sUrlAppend = "?hide_dismissed=" + (_hide_dismissed ? 1:0);
	_sStructureName = "-";
	sCollaboratorBrood = "";
	_sDep_id = "null";
	if (Request.QueryString.HasProperty("subdivision_id"))
	{
		_sDep_id = Request.QueryString.GetProperty("subdivision_id");
		_sUrlAppend += "&subdivision_id=" + Request.QueryString.GetProperty("subdivision_id");
		_structure = OpenDoc(UrlFromDocID(Int(Request.QueryString.GetProperty("subdivision_id")))).TopElem;
		_sStructureName = "<img src='pics/subdivision.ico' border='0'/>&nbsp;" + tools.get_web_str("c_subd") + ": " + _structure.name;
		sCollaboratorBrood = "subdivision";
	}
	else if (Request.QueryString.HasProperty("org_id"))
	{
		_sDep_id = Request.QueryString.GetProperty("org_id");
		_sUrlAppend += "&org_id=" + _sDep_id;
		_sStructureName = "<img src='pics/org.ico' border='0'/>&nbsp;" + tools.get_web_str("c_org") + ": " + OpenDoc(UrlFromDocID(Int(Request.QueryString.GetProperty("org_id")))).TopElem.disp_name;
		sCollaboratorBrood = "org";
	}
	else if (Request.QueryString.HasProperty("group_id"))
	{
		catGroup = ArrayFirstElem(XQuery("sql: select * from dbo.groups where id = " + Request.QueryString.GetProperty("group_id")));
		_sStructureName = "<img src='pics/group.ico' border='0'/>&nbsp;" + tools.get_web_str("c_group") + ": " + catGroup.name;
		_sUrlAppend += "&group_id=" + Request.QueryString.GetProperty("group_id");
		sCollaboratorBrood = "group";
	}
	else if (Request.QueryString.HasProperty("all") && Request.QueryString.GetProperty("all") == "1")
	{
		_sStructureName = tools.get_web_str("vmpb_all_subordinates");
		sCollaboratorBrood = "all";
	}
%>
<script type="text/javascript">
	(function($)
	{
		var _CLASSES = $.fn.Treeview.classes;
		$.fn.applyClasses = function(settings, toggler)
		{
			if (!settings.prerendered)
			{
				this.filter(":has(>ul:hidden)").addClass(_CLASSES.expandable).replaceClass(_CLASSES.last, _CLASSES.lastExpandable);
				this.not(":has(>ul:hidden)").addClass(_CLASSES.collapsable).replaceClass(_CLASSES.last, _CLASSES.lastCollapsable);
				this.prepend("<div class=\"" + _CLASSES.hitarea + "\"/>").find("div." + _CLASSES.hitarea).each(function() {
					var classes = "";
					$.each($(this).parent().attr("class").split(" "), function() {classes += this + "-hitarea ";});
					$(this).addClass(classes);
				});
			}
			this.find("div." + _CLASSES.hitarea).click(toggler);
			$(this.context).find("a.nodeSubClicker").each( function() { $(this).attr('href','<%=tools_web.get_query_string(true, "org_id;subdivision_id;group_id")%>'+ this.type + "_id=" + this.id);});
		}
		
		function load(settings, root, child, container) {
			$(document.createElement("img")).attr("src","pics/ajax-loader-tiny.gif").prependTo(child);
			$.getJSON(settings.url, {root: root}, function(response) {
				function createNode(parent) {
					var current = $("<li/>").attr("id", this.id || "").html("<span>" + this.text + "</span>").appendTo(parent);
					if (this.classes){current.children("span").addClass(this.classes);}
					if (this.expanded){current.addClass("open");}
					if (this.hasChildren || this.children && this.children.length) {
						var branch = $("<ul/>").appendTo(current);
						if (this.hasChildren) {
							current.addClass("hasChildren");
							createNode.call({
								text:"placeholder",
								id:"placeholder",
								children:[]
							}, branch);
						}
						if (this.children && this.children.length) {
							$.each(this.children, createNode, [branch])
						}
					}
				}
				$.each(response, createNode, [child]);
				$(container).treeview({add: child});
				child.children("img").first().remove();
			});
		}
		var proxied = $.fn.treeview;
		$.fn.treeview = function(settings) {
			if (!settings.url) {
				return proxied.apply(this, arguments);
			}
			var container = this;
			load(settings, "source", this, container);
			var userToggle = settings.toggle;
			return proxied.call(this, $.extend({}, settings, {
				collapsed: true,
				toggle: function() {
					var $this = $(this);
					if ($this.hasClass("hasChildren")) {
						var childList = $this.removeClass("hasChildren").find("ul");
						childList.empty();
						load(settings, this.id, childList, container);
					}
					if (userToggle) {
						userToggle.apply(this, arguments);
					}
				}
			}));
		};
		$(document).ready(function(){
			$("ul#fleshtreecore").treeview({
				url: "boss_panel_sql_cs.html<%=_sUrlAppend%>"
			});
		});
	})(jQuery);
</script>
<table border="0" width="100%" style="height:100%">
<tr>
	<td id="treeArea" width="300px" valign="top">
		<span class="TreeviewSpanArea" style="overflow:auto; width:300px">
			<b><a href="<%=tools_web.get_query_string(true, "org_id;subdivision_id;group_id")%>"><%=tools.get_web_str("vmpb_all_subordinates")%></a></b>
			<ul id="fleshtreecore"></ul>
		</span>
		<p>
		<input type="checkbox" name="hide_dismissed" value="1" <%=(_hide_dismissed?"checked":"")%> onclick="var _href = '<%=tools_web.get_query_string(true, "hide_dismissed")%>hide_dismissed=' + (this.checked ? '1': '0'); window.location.href = _href;"/><%=tools.get_web_str("c_no_disp_dismiss")%>
		</p>
	</td>
	<td valign="top">
<%
	external_eval = "";
	tableID = "c_list";
	
	if (bPaging)
	{
		iPagingSize = 50;
		iPageIndex = Request.QueryString.HasProperty( 'page_index' + tableID ) ? Int(Request.QueryString.GetProperty( 'page_index' + tableID )) : 1;
	}
	else
	{
		iPagingSize = 0;
		iPageIndex = 0;
	}
	
	if (sCollaboratorBrood == "group")
	{
		sMySubPeople = "sql: select /*+ALL_ROWS*/ c.* from collaborators as c inner join group_collaborators as gc on c.id = gc.collaborator_id where gc.group_id = "+catGroup.id+" order by c.fullname";
		_selectedActions = XQuery("sql: select * from dbo.operations as o where o.operation_type = 0 and exists (select b.operations from dbo.boss_types as b inner join dbo.func_managers as f on b.id = f.boss_type_id where f.object_id = "+catGroup.id+" and f.person_id = " +curUserID+ " and b.operations like '%' +cast(o.id as varchar(20))+ '%')");
		curPersonsArray = ArraySelectAll(XQuery(sMySubPeople));
	}
	else
	{
sMySubPeople = "sql: exec GetUsersForOrgTree @user_id=" +curUserID+ ",@dep_id=" +_sDep_id+ ",@is_active=" +(_hide_dismissed ? 1:0);
external_eval = "xqueryQual = \"" + sMySubPeople  + "\";
xqueryQual += \",@page_index="+iPageIndex+", @page_size="+iPagingSize+",@is_row_count=1,@is_xml=0\";
xqueryQual += \",@orderby='\" + curSortColumn.order_code + \" \" + ( sortDirect == '+' ? 'asc' : 'desc' ) + \"'\";
xqueryQual += \",@search_str=\" + XQueryLiteral( curSearchText ) + \"\";
curArray = ArraySelectAll(XQuery(xqueryQual));";

		_selectedActions = ArraySelectAll(XQuery("sql: exec GetAvailableOperationsByDepID @user_id=" +curUserID+ ",@dep_id=" +_sDep_id));
	}
	
	//if (ArrayOptFirstElem != undefined)
	{
		try
		{
			_god_message = Session.r_msg;
		}
		catch(_god_message_err_)
		{
			_god_message = undefined;
		}
		
		Session.r_msg = undefined;
		
		if (_god_message != undefined)
		{
%>
	<center style="font-weight: bold"><%=_god_message%></center>
<%
		}
%>
	<form action="operation_process.html" name="action_process" method="POST">
	<input type="hidden" name="selected_object_ids" id="selected_object_ids" value=""/>
	<input type="hidden" name="element_ids" id="element_ids"/>
	<input type="hidden" name="element_value" id="element_value"/>
	<input type="hidden" name="href" value="<%=(UrlPath(Request.Url) +"?"+ UrlParam(Request.Url))%>"/>
	<input type="hidden" name="redirect" value="<%=curMode%>"/>
	<input type="hidden" name="mode" value="<%=curMode%>"/>
	<input type="hidden" name="action_id" id="action_id" value=""/>
	<input type="hidden" name="sid" value="<%=tools.get_sum_sid( curDocID )%>">
<%
		curView = new Object;
		curView.SetProperty("id", tableID);
		curView.SetProperty("catalog_name", "collaborator");
		curView.SetProperty("disp_link", "true");
		curView.SetProperty("disp_filter", "false");
		curView.SetProperty("disp_check_box", "true");
		curView.SetProperty("link_object_field", "id");
		//curView.SetProperty("list_columns", Array("fullname"));
		curView.SetProperty("title", _sStructureName);
		curView.SetProperty("noselect", "1");
		if (bPaging)
		{
			curView.SetProperty("paging_size",iPagingSize);
			curView.SetProperty("external_paging",true);
		}
		if (external_eval != "")
			curView.SetProperty("external_eval", external_eval);
		else
			curView.SetProperty("array", curPersonsArray);

		Server.Execute( "view_catalog_list.html" );

%>
	<script language="javascript">
	<!--
		function toggle_check_selection(_check)
		{
			_arr = document.all["select_check_box_<%=tableID%>"];
			if (_arr != undefined)
			if (_arr.length != undefined)
			{
				for (var i = 0; i < _arr.length; i++)
					_arr[i].checked = _check;
			}
			else
				_arr.checked = _check;
		}
		
		function prepare_data(_a_id)
		{
			document.getElementById("action_id").value = _a_id;
			
			return true;
		}
<%
	if (Trim(tableID) != "")
	{
%>
		function filling_selected_object_ids()
		{
			return filling_selected_object_ids<%=tableID%>();
		}
		
		<%
	}
			for (_a in _selectedActions)
			{
		%>
			function f_<%=_a.id%>()
			{
				var ELEMENT_IDS = "";
				var ELEMENT_VALUE = "";
				<%=EvalCodePage(tools_web.get_operation_script(_a.id, true))%>
				document.getElementById("element_ids").value = ELEMENT_IDS;
				document.getElementById("element_value").value = ELEMENT_VALUE;
				return true;
			}
		<%
			}
		%>
		
		
	-->
	</script>
	<a href="#" onclick="toggle_check_selection(true); return false;"><%=tools.get_web_str("c_select_all")%></a> &nbsp; <a href="#" onclick="toggle_check_selection(false); return false;"><%=tools.get_web_str("c_deselect_all")%></a>
	<br/><br/>
	<center>
	<%
		_operation_n = 0;
		_group = "";
		for (_action in ArraySort(_selectedActions, "group", "+"))
		{
			if (_operation_n > 0 && _group != _action.group) Response.Write("<hr/>");
	%>
		<input type="submit" id="_a_<%=_action.id%>" onclick="if (prepare_data('<%=_action.id%>')) return f_<%=_action.id%>(); else return false;" value="<%=_action.name%>" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';"/>
	<%
			_group = _action.group + "";
			_operation_n++;
		}
	%>
	</center>
	</form>
<%
	}
%>
	</td>
</table>
<%
	}
	
	if (_selectedTab == 1)
	{
		curPostMode = curMode + "&tab=" + _selectedTab;
		dispWorkflowProcessing = true;
		Server.Execute("view_requests_body.html");
	}
	
	if (_selectedTab == 2)
	{
		_displayMode = curMode + "&tab=" + _selectedTab;
		Server.Execute("view_budget_report_body.html");
	}
	
	if (_selectedTab == 3)
	{
		if (Request.QueryString.HasProperty("object_id"))
		{
			curReportID = curObjectID;
			curReportDoc = curObjectDoc;
			curReport = curObject;
			_href_suffix = "tab=" + _selectedTab;
			if (curReport.Name == "custom_report")
			{
				if ( tools_web.check_access( curReport, curUserID, curUser, Session ) )
					Server.Execute("view_custom_report_body.html");
			}
			else if (curReport.Name == "custom_web_template")
			{
				Response.Write(tools_web.insert_custom_code(curReportID, curReportDoc));
			}
		}
		else
		{
%>
		<table width="100%"  border="0" cellspacing="0" cellpadding="3">
			<tr>
				<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="1" height="1" /></td>				
			</tr>
<%
		_crs = XQuery("for $elem in custom_reports where $elem/access_block_type = 'boss_panel' return $elem");
		counter = 0;
		for (_custom_report in _crs)
		{
			_class = counter++ % 2 ? "tableRowEven" : "tableRowOdd";
			%>
				<TR VALIGN="MIDDLE">					
					<TD class="<%=_class%>"><a HREF="view_doc.html?mode=<%=curMode%>&object_id=<%=_custom_report.id%>&doc_id=<%=curDocID%>&tab=<%=_selectedTab%>"><%=_custom_report.name%></a></TD>
				</TR>
			<%
		}
		
		_custom_web_templates = XQuery("for $elem in custom_web_templates where contains($elem/code, 'boss_panel_custom_report') return $elem");
		for (_custom_report in _custom_web_templates)
		if (StrBegins(_custom_report.code.Value, "boss_panel_custom_report"))
		{
			_class = counter++ % 2 ? "tableRowEven" : "tableRowOdd";
			%>
				<TR VALIGN="MIDDLE">					
					<TD class="<%=_class%>"><a HREF="view_doc.html?mode=<%=curMode%>&object_id=<%=_custom_report.id%>&doc_id=<%=curDocID%>&tab=<%=_selectedTab%>"><%=_custom_report.name%></a></TD>
				</TR>
			<%
		}
%>
			<tr>
				<td class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td>
			</tr>
		</table>
<%
		}
	}
%>