<%
	try
	{
		_displayMode = String(_displayMode);
	}
	catch(_aga_)
	{
		_displayMode = curMode;
	}
	
	TopElem = OpenNewDoc( 'x-local://wtv/wtv_view_budget_report.xml' ).TopElem;
	TopElem.budget_period_id = Request.Query.HasProperty( 'select_budget_period' ) && Request.Query.select_budget_period != '' ? Int( Request.Query.select_budget_period ) : null;

	if ( curUser.cost_center_id.HasValue )
		TopElem.cost_centers.ObtainChildByKey( curUser.cost_center_id );

	function get_all_cost_center_ids_by_manager_id( _person_id )
	{
		_manager_array = XQuery( "for $elem in func_managers where $elem/person_id = " + _person_id + " and ( $elem/catalog = 'org' or $elem/catalog = 'position' or $elem/catalog = 'subdivision' ) order by $elem/catalog return $elem" );
		_manager_array = ArraySelectAll(_manager_array); //!!!!!!!!!!!!!! WARNING! 
		_manager_array_num = ArrayCount( _manager_array );
		if ( _manager_array_num == 0 )
			return Array();

		_result_array = Array();
		_index = 0;
		_cur_elem = _manager_array[ 0 ];			
		_sel_array = Array();

		_org_counter = 0;
		_org_array = Array();
		while ( _cur_elem.catalog == 'org' )
		{
			_sel_array = XQuery( 'for $elem in subdivisions where $elem/org_id = ' + _cur_elem.object_id + ' and $elem/cost_center_id != null() return $elem' );
			_result_array = ArrayUnion( _result_array, ArrayExtractKeys( _sel_array, 'cost_center_id' ) );

			_org_array[ _org_counter ] = _cur_elem;
			_org_counter++;

			_index++;
			if ( _index >= _manager_array_num )
				return _result_array;

			_cur_elem = _manager_array[ _index ];
		}

		while ( _cur_elem.catalog == 'position' )
		{
			if ( ArrayOptFindByKey( _org_array, _cur_elem.org_id, 'object_id' ) == undefined )
			{
				if ( _cur_elem.parent_id.HasValue || _cur_elem.org_id.HasValue )
				{
					_sel_array = XQuery( 'CatalogHierSubset(\'subs\',' + ( _cur_elem.parent_id.HasValue ? _cur_elem.parent_id : _cur_elem.org_id ) + ')' );
					_sel_array = ArraySelectByKey( _sel_array, 'subdivision', 'type' );
					_sel_array = ArrayExtract( _sel_array, 'id' );
					if ( _cur_elem.parent_id.HasValue )
						_sel_array[ ArrayCount( _sel_array ) ] = _cur_elem.parent_id.Value;
					_sel_array = QueryCatalogByKeys( 'subdivisions', 'id', _sel_array );
					_sel_array = ArraySelect( _sel_array, 'cost_center_id.HasValue' );
					_result_array = ArrayUnion( _result_array, ArrayExtractKeys( _sel_array, 'cost_center_id' ) );
				}
			}

			_index++;
			if ( _index >= _manager_array_num )
				return _result_array;

			_cur_elem = _manager_array[ _index ];
		}

		while ( _cur_elem.catalog == 'subdivision' )
		{
			if ( ArrayOptFindByKey( _org_array, _cur_elem.org_id, 'object_id' ) == undefined )
			{
				_sel_array = XQuery( 'CatalogHierSubset(\'subs\',' + _cur_elem.object_id + ')' );
				_sel_array = ArraySelectByKey( _sel_array, 'subdivision', 'type' );
				_sel_array = ArrayExtract( _sel_array, 'id' );
				_sel_array = QueryCatalogByKeys( 'subdivisions', 'id', _sel_array );
				_sel_array = ArraySelect( _sel_array, 'cost_center_id.HasValue' );
				_result_array = ArrayUnion( _result_array, ArrayExtractKeys( _sel_array, 'cost_center_id' ) );
			}
			
			_index++;
			if ( _index >= _manager_array_num )
				return _result_array;

			_cur_elem = _manager_array[ _index ];
		}

		return _result_array;
	}
	for ( iCostCenterIDElem in get_all_cost_center_ids_by_manager_id( curUserID ) )
		TopElem.cost_centers.ObtainChildByKey( iCostCenterIDElem );

	if ( TopElem.cost_centers.ChildNum != 0 && TopElem.budget_period_id.HasValue )
			TopElem.calculation();
%>

<%Server.Execute( 'view_text_area.html' )%>
	
<form action="view_doc.html?mode=<%=_displayMode%>" name="budget_report" method="POST">
	<input type="HIDDEN" name="doc_id" value="<%=curDocID%>">
	<input type="HIDDEN" name="action" value="1">
	<input type="HIDDEN" name="budget_period_id" value="">
			
	<b><%=tools.get_web_str("c_budget_period")%>:&nbsp;</b>
	<select name="select_budget_period" width="100">
<%
	for ( _budget_period in  budget_periods )	
	{
%>
		<option value="<%=_budget_period.id%>"><%=_budget_period.name%></option>
<%
	}
%>
	</select>
<script language="JavaScript">
selcur=document.forms['budget_report'].elements['select_budget_period'];
selcur.value=-1;
for (i=0;i<selcur.options.length;i++)
	if (selcur.options[i].value=="<%=TopElem.budget_period_id%>" )
	{
		selcur.selectedIndex=i;
		break;
	}
</script>
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
	<input type="submit" value="<%=tools.get_web_str("vanb_submit")%>" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';">			
<!--
	&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
			
	<input type="button" value="<%=tools.get_web_str("c_export_to_excel")%>" class="inputButton" onClick="var id=window.open('budget_report_print.html?object_id=<%=curUserID%>&budget_period_id=<%=TopElem.budget_period_id%>&doc_id=<%=curDocID%>', 'About','height=700,width=900,toolbar=1,status=1,menubar=1,location=0,resizable=1,scrollbars=1');id.focus();return false;" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';">
-->
	<br/>
	<br/>
<%
	if ( TopElem.budget_period_id.HasValue )
	{
%>
	<table width="100%"  border="0" cellspacing="0" cellpadding="3">
		<tr>
			<td class="tableHeaderWithText"><%=tools.get_web_str("c_cost_center")%>/<%=tools.get_web_str('c_expense_item')%></td>
			<td class="tableHeaderWithText"><%=tools.get_web_str("c_budget")%></td>
			<td class="tableHeaderWithText"><%=tools.get_web_str("vkb_fact")%></td>
			<td class="tableHeaderWithText">%</td>
			<td class="tableHeaderWithText"><%=tools.get_web_str("vbrb_remainder")%></td>
		</tr>
		<tr>
			<td colspan="5" class="tableHeaderNoText"><img src="pics/1blank.gif" width="1" height="1"/></td>
		</tr>
<%
		for( fldCostCenterElem in TopElem.data.cost_centers )
		{
			sColor = fldCostCenterElem.percent > 100.0 ? 'FF0000' : '';
%>
		<tr bgcolor="D3D1D1">
			<td><%=fldCostCenterElem.name%></td>
			<td><%=StrReal( fldCostCenterElem.plan, 2, true )%></td>
			<td><font color="<%=sColor%>"><%=StrReal( fldCostCenterElem.fact, 2, true )%></font></td>
			<td><font color="<%=sColor%>"><%=StrReal( fldCostCenterElem.fact, 2, true )%></font></td>
			<td><font color="<%=sColor%>"><%=StrReal( fldCostCenterElem.delta, 2, true )%></font></td>
		</tr>
<%
			for( fldExpenceItemElem in fldCostCenterElem.cost_centers )
			{
				sColor = fldExpenceItemElem.percent > 100.0 ? 'FF0000' : '';
%>
		<tr>
			<td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<%=fldExpenceItemElem.name%> </td>
			<td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<%=StrReal( fldExpenceItemElem.plan, 2, true )%></td>
			<td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="<%=sColor%>"><%=StrReal( fldExpenceItemElem.fact, 2, true )%></font></td>
			<td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="<%=sColor%>"><%=StrReal( fldExpenceItemElem.fact, 2, true )%></font></td>
			<td>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<font color="<%=sColor%>"><%=StrReal( fldExpenceItemElem.delta, 2, true )%></font></td>
		</tr>
<%	
			}
		}
%>
		<tr>
			<td colspan="5" class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td>
		</tr>
	</table>
<%
	}
%>
</form>