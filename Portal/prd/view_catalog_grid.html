<%
	rndID = Random( 0, 1000 );
%>
<script language="javascript">
//http://localhost/view_doc.html?mode=catalog_grid&catalog='group'

var g_isMSIE = false;
var g_isFireFox = false;
var g_sMSXMLProgID;
var g_sMSXMLHTTPProgID;
var g_nFirst = 1;


CheckBrowserType();
	
if(g_isFireFox) {
	UpdateFireFoxDOM();
} else if(g_isMSIE) {
	DetermineMSXMLProgID();
	DetermineMSXMLHTTPProgID();
}



// CheckBrowserType
function CheckBrowserType()
{
	var sUserAgent = navigator.userAgent.toLowerCase();
	
	if (sUserAgent.indexOf('msie') != -1)
		g_isMSIE = true;
	else if (sUserAgent.indexOf('gecko') != -1)
		g_isFireFox = true;
}

// UpdateFireFoxDOM
function UpdateFireFoxDOM()
{
	// selectNodes
	if (document.implementation.hasFeature("XPath", "3.0"))
	{
		XMLDocument.prototype.selectNodes = 
			function (cXPathString, xNode)
			{
					if (!xNode)
						xNode = this;
						
					var oNSResolver = this.createNSResolver(this.documentElement)
					var aItems = this.evaluate(cXPathString, xNode, oNSResolver, 
						XPathResult.ORDERED_NODE_SNAPSHOT_TYPE, null)
					var aResult = [];
					for (var i = 0; i < aItems.snapshotLength; i++)
						aResult[i] = aItems.snapshotItem(i);

					return aResult;
			}

		Element.prototype.selectNodes = 
			function (cXPathString)
			{
				if (this.ownerDocument.selectNodes)
					return this.ownerDocument.selectNodes(cXPathString, this);
				else
					throw "For XML Elements Only";
			}
	}
	
	// selectSingleNode
	if (document.implementation.hasFeature("XPath", "3.0"))
	{
		// prototyping the XMLDocument
		XMLDocument.prototype.selectSingleNode = 
			function (cXPathString, xNode)
			{
				if (!xNode)
					xNode = this;
					
				var xItems = this.selectNodes(cXPathString, xNode);
				if (xItems.length > 0)
					return xItems[0];
				else
					return null;
			}
		 
		// prototyping the Element
		Element.prototype.selectSingleNode = 
			function (cXPathString)
			{	
				if (this.ownerDocument.selectSingleNode)
					return this.ownerDocument.selectSingleNode(cXPathString, this);
				else
					throw "For XML Elements Only";
			}
	}
	
	// loadXML
	Document.prototype.loadXML = 
	function (sXML)
	{
		var objDOMParser = new DOMParser();
		var objDoc = objDOMParser.parseFromString(sXML, "text/xml");
	}
	
	/*// load
	Document.prototype.load = 
	function (sURL)
	{
		alert("prototype.load");
		var oXmlHttp = CreateXMLHTTP();
		oXmlHttp.open("GET", sURL, false);
		oXmlHttp.send(sSend);
		alert(oXmlHttp.status);
		if (oXmlHttp.status == 200)
		{
			var sResponse = oXmlHttp.responseText;
			this.loadXML(sXML);
			return true;
		}
		return false;
	}*/
		
	// xml
	//Node.prototype.__defineGetter__("xml", _Node_getXML);
	Node.prototype.__defineGetter__("xml", 
	function()
	{
		var oXMLSerializer = new XMLSerializer;
		var sXML = oXMLSerializer.serializeToString(this);
		return sXML;
	});
	
	// text
	Node.prototype.__defineGetter__("text", 
	function()
	{
		var sText = "";
		
		var oText = this.firstChild;
		while (oText != null)
		{
			if (oText.nodeType == 3 || oText.nodeType == 4)
				sText += oText.nodeValue;
				
			oText = oText.nextSibling;
		}
		
		return sText;
	});
	
	/*function _Node_getXML() 
	{
    var objXMLSerializer = new XMLSerializer;
    var strXML = objXMLSerializer.serializeToString(this);
    return strXML;
	}*/
	
	/*Node.prototype.__defineGetter__("xml", 
		function _Node_getXML() 
		{
			var objXMLSerializer = new XMLSerializer;
			var strXML = objXMLSerializer.serializeToString(this);
			return strXML;
		});*/
	
	g_nFirst = 1;
}

// DetermineMSXMLProgID
function DetermineMSXMLProgID()
{
	var oDoc;
	var sProgID;
	for (var i = 6; i >= 3; i--)
	{
		try
		{
			sProgID = "MSXML2.DOMDocument."+ i +".0";
			oDoc = new ActiveXObject(sProgID);
		}
		catch (e)
		{
		}
		if (oDoc != undefined)
		{
			g_sMSXMLProgID = sProgID;
			g_nFirst = (i <= 3 ? 0 : 1);
			break;
		}
	}
}

// DetermineMSXMLHTTPProgID
function DetermineMSXMLHTTPProgID()
{
	var oDoc;
	var sProgID;
	for (var i = 6; i >= 3; i--)
	{
		try
		{
			sProgID = "MSXML2.XMLHTTP."+ i +".0";
			oDoc = new ActiveXObject(sProgID);
		}
		catch (e)
		{
		}
		if (oDoc != undefined)
		{
			g_sMSXMLHTTPProgID = sProgID;
			break;
		}
	}
}

// CreateDOMDocument
function CreateDOMDocument()
{
	var oDoc;
	
	if (g_isMSIE)
	{
		oDoc = new ActiveXObject(g_sMSXMLProgID);
	}
	else if (g_isFireFox)
	{
		oDoc = document.implementation.createDocument("", "doc", null);
	}
	
	return oDoc;
}


function Grid(id, catalog_name, hreference) //constructor 
{ 
  //constant data 
  this.id = id; 
  this.catalog_name = catalog_name;
  this.hreference = hreference;
 
  this.title = "1"; 
  this.disp_link = true;
  this.link_fild_index = 0;
 
  //dynamic data 
  this.xhierarchy = null;
  this.cur_sort_index = 0;
  this.cur_sort_direct = true;
  
  this.headerColumns = null;
  this.headerColumnsLen = 1;
  this.rows = null;
  this.rowsLen = 0;
  
 
  this.isDrow = false;
  this.isLoad = false;
 
  //methods 
  this.loadData = loadData;
  this.drowGrid = drowGrid;
  this.ReadyStateChange = ReadyStateChange;
  this.sortGrid = sortGrid;
  
  
/* 
  this.initialize = initializeFolder 
  this.setState = ReadyStateChange 
  this.addChild = addChild 
  this.addChildren = addChildren
  this.createIndex = createEntryIndex 
  this.escondeBlock = escondeBlock
  this.esconde = escondeFolder 
*/
}

function loadData() 
{
	var link_str = "catalog_list.xml?catalog_name=" + this.catalog_name + "&sort=" + this.cur_sort_index + ( this.cur_sort_direct ? '' : '&descending=' );
	
	if ( window.ActiveXObject )
	{
		this.xhierarchy = CreateDOMDocument();
		this.xhierarchy.async = false;
		//this.xhierarchy.onreadystatechange = this.ReadyStateChange;
		
		this.xhierarchy.load(link_str);
		this.isLoad = true;
	}
	else if ( document.implementation )
	{
		this.xhierarchy = document.implementation.createDocument("","",null);
		this.xhierarchy.async = false;
		
		if ( this.xhierarchy.load(link_str) )
			//ReadyStateChange();
			this.isLoad = true;
		else
			this.isLoad = false;
	}
	else
	{
		this.isLoad = false;
	}
	
	if ( this.isLoad )
	{
		this.headerColumns = null;
		this.headerColumnsLen = 1;
		this.rows = null;
		this.rowsLen = 0;
	}
	
	return this.isLoad;
}

function drowGrid()
{
alert(0)
	var table = document.getElementById("grid_"+this.id);
	
	var _len = table.rows.length;
	for ( var i=0; i<_len; i++ )
		table.deleteRow(0);
	
alert(1)		
	var header_tr = document.createElement("TR");
	header_tr.insertAdjacentElement('beforeEnd',createImgTd("tableHeaderTextLeft"));
	
	this.tableHeaderText = document.createElement("TD");
	this.tableHeaderText.id = "tableHeaderText_" + this.id;
	this.tableHeaderText.width = "100%";
	this.tableHeaderText.className = "tableHeaderText";
	
	this.tableHeaderTextInner = document.createElement("P");
	this.tableHeaderTextInner.id = "tableHeaderTextInner_" + this.id;	
	this.tableHeaderTextInner.className = "tableHeaderTextInner";
	//this.tableHeaderTextInner.innerHTML = this.title;
	
	this.tableHeaderTextInner.appendChild(document.createTextNode(this.title))
	this.tableHeaderText.appendChild(this.tableHeaderTextInner)
	
	//this.tableHeaderText.insertAdjacentElement("afterEnd",this.tableHeaderTextInner);
	header_tr.insertAdjacentElement('beforeEnd',this.tableHeaderText);
	header_tr.insertAdjacentElement('beforeEnd',createImgTd("tableHeaderTextRight"));
	
	if ( this.isLoad )
	{
		if ( this.headerColumns == null )
		{
			this.headerColumns = this.xhierarchy.selectNodes(".//columns/col");
			this.headerColumnsLen = this.headerColumns.length;
		}
			
		var header_with_text_rt = document.createElement("TR");
		//header_with_text_rt.valign = "middle";
		
		header_with_text_rt.insertAdjacentElement('beforeEnd',createImgTd("tableHeaderTextLeft"));
		for ( var i=0; i<this.headerColumnsLen; i++ )
		{
			var header_with_text_td=document.createElement("TD");
			header_with_text_td.className = 'tableHeaderWithText';
			header_with_text_td.innerHTML = '<a href="#" onclick="sortMsGrid(\'' + this.id + '\',' + i + '); return false;">' + this.headerColumns[i].getAttribute("title") + '</a>&nbsp;' + ( i == this.cur_sort_index ? ( this.cur_sort_direct ? '&#9650;' : '&#9660;' ) : '' ); 
			header_with_text_rt.insertAdjacentElement('beforeEnd',header_with_text_td);
		}
		header_with_text_rt.insertAdjacentElement('beforeEnd',createImgTd("tableHeaderTextRight"));
	}



//////	
	var header_no_text_tr = document.createElement("TR");
	header_no_text_tr.insertAdjacentElement('beforeEnd',createImgTd("tableHeaderNoTextLeft"));
	this.tableHeaderNoText = createImgTd("tableHeaderNoText",this.id);
	this.tableHeaderNoText.colSpan = this.headerColumnsLen;
	header_no_text_tr.insertAdjacentElement('beforeEnd',this.tableHeaderNoText);
	header_no_text_tr.insertAdjacentElement('beforeEnd',createImgTd("tableHeaderNoTextRight"));
	
	this.tableHeaderText.colSpan = this.headerColumnsLen;
	
	
	// title
	table.insertAdjacentElement('beforeEnd',header_tr);
	// Text
	if ( this.isLoad )
		table.insertAdjacentElement('beforeEnd',header_with_text_rt);
	// Header no text
	table.insertAdjacentElement('beforeEnd',header_no_text_tr);
	

	if ( this.isLoad )
	{	
		if ( this.rows == null )
		{
			this.rows = this.xhierarchy.selectNodes(".//rows/row");
			this.rowsLen = this.rows.length;
		}
		
		for ( var j=0; j<this.rowsLen; j++ )
		{
			var row_tr = document.createElement("TR");
			row_tr.insertAdjacentElement('beforeEnd',createImgTd( j % 2 ? 'tableRowEvenLeft' : 'tableRowOddLeft' ));
			
			var _columns = this.rows[j].selectNodes("cell");
			for ( var i=0; i<this.headerColumnsLen; i++ )
			{
				var row_td=document.createElement("TD");
				row_td.className = ( j % 2 ? 'tableRowEven' : 'tableRowOdd' );
				
				if ( this.disp_link && i == this.link_fild_index )
					row_td.innerHTML = '<a href="view_doc.html?mode=' + this.catalog_name + '&object_id=' + this.rows[j].getAttribute("id") + '">' + _columns[i].text + '&nbsp;</a>';
				else
					row_td.innerHTML = _columns[i].text;
					
				row_tr.insertAdjacentElement('beforeEnd',row_td);
			}
			
			row_tr.insertAdjacentElement('beforeEnd',createImgTd( j % 2 ? 'tableRowEvenRight' : 'tableRowOddRight' ));
			table.insertAdjacentElement('beforeEnd',row_tr);
		}
	}



	
	var footer_tr = document.createElement("TR");
	footer_tr.insertAdjacentElement('beforeEnd',createImgTd("tableFooterLeft"));
	this.tableFooter = createImgTd("tableFooter",this.id);
	this.tableFooter.colSpan = this.headerColumnsLen;
	footer_tr.insertAdjacentElement('beforeEnd',this.tableFooter);
	footer_tr.insertAdjacentElement('beforeEnd',createImgTd("tableFooterRight"));

	// Footer
	table.insertAdjacentElement('beforeEnd',footer_tr);
	
	
//var aaa = document.getElementById("qwer");	
//debugger;
alert(111)
	this.isDrow = true;
	return true;
}

function sortMsGrid( _id, _index )
{
	var _temp_obj = eval( "ms_grid_" + _id );
	_temp_obj.sortGrid( _index );
}

function sortGrid( _index )
{
	this.cur_sort_index = _index;
	
	if ( _index != this.cur_sort_index )
		this.cur_sort_direct = true;
	else
		this.cur_sort_direct = ! this.cur_sort_direct;
	
	this.loadData();
	this.drowGrid();
}


var temp;

var catalog_name = "collaborator";
var sort_index = 0;
var sort_direct = true;
var disp_link = true;
var link_fild_index = 0;

var xhierarchy;
var cur_id;
var cur_sort_index;


function disp_progress( id, disp )
{
	var prog_div = document.getElementById("progress_"+id);
	var table_div = document.getElementById("recycler_"+id);
	
	if ( disp )
	{
		var rect=getRect(table_div);
		prog_div.style.top = rect.shifty;
		prog_div.style.left = rect.shiftx;
		prog_div.style.zIndex = table_div.zIndex+1;
		prog_div.style.display = "inline";
	}
	else
	{
		prog_div.style.display = "none";
	}
}

function disp_grid( id, sort_i )
{
ms_grid_<%=rndID%> = new Grid('<%=rndID%>','collaborator','');

var aa = ms_grid_<%=rndID%>;

aa.loadData();
aa.drowGrid();

return;

	if ( sort_i == undefined )
		sort_i = sort_index;
	else
		sort_direct = ! sort_direct;

	if ( sort_i != sort_index )
		sort_direct = true;
	
	disp_progress( id, true );	

	var link_str = "catalog_list.xml?catalog_name=" + catalog_name + "&sort=" + sort_i + ( sort_direct ? '' : '&descending=' );
	
	if ( window.ActiveXObject )
	{
		xhierarchy = CreateDOMDocument();
		xhierarchy.async = true;
		xhierarchy.onreadystatechange = ReadyStateChange;
		
		cur_id = id;
		cur_sort_index = sort_i;
		
		xhierarchy.load(link_str);
		return true;
	}
	else if ( document.implementation )
	{
		xhierarchy = document.implementation.createDocument("","",null);
		xhierarchy.async = false;
		
		
			
		cur_id = id;
		cur_sort_index = sort_i;
		
		if ( xhierarchy.load(link_str) )
			ReadyStateChange();
		else
			return false;
			
		return true;
	}
	else
	{
		return false;
	}
	return true;
}


function createImgTd( _class, id )
{
	var temp_td = document.createElement("TD");
	
	if ( _class )
		temp_td.className = _class;
		
	if ( id )
	{
		temp_td.id = _class + '_' + id;
		temp_td.width = '100%';
	}
	
	var temp_img = document.createElement("IMG");
	temp_img.src = "pics/1blank.gif";
	
	temp_td.insertAdjacentElement("afterBegin",temp_img);
	return temp_td;
}


function drow_grid( id, sort_i )
{
	var tb = document.getElementById("recycler_"+id);
	var tht = document.getElementById("tableHeaderText_"+id);
	var thnt = document.getElementById("tableHeaderNoText_"+id);
	var tf = document.getElementById("tableFooter_"+id);
	var htr = document.getElementById("header_tr_"+id);

	
	var _header_columns = xhierarchy.selectNodes(".//columns/column");
	var _header_columns_len = _header_columns.length;

	tht.colSpan = _header_columns_len;
	thnt.colSpan = _header_columns_len;
	tf.colSpan = _header_columns_len;

	var _aa=htr.rows.length;
	for ( var i=0; i<_aa; i++ )
		htr.deleteRow(0);
		
	var trrow = document.createElement("TR");
	trrow.valign="middle";
	
	trrow.insertAdjacentElement('beforeEnd',createImgTd("tableHeaderTextLeft"));
	for ( var i=0; i<_header_columns_len; i++ )
	{
		var tcolx=document.createElement("TD");
		tcolx.className = 'tableHeaderWithText';
		tcolx.innerHTML = '<a href="#" onclick="disp_grid(\'' + id + '\',' + i + '); return false;">' + _header_columns[i].getAttribute("title") + '</a>&nbsp;' + ( i == sort_i ? ( sort_direct ? '&#9650;' : '&#9660;' ) : '' ); 
		var tcolx=trrow.insertAdjacentElement('beforeEnd',tcolx);
	}
	trrow.insertAdjacentElement('beforeEnd',createImgTd("tableHeaderTextRight"));

	
	var header_tr = document.getElementById("header_tr_"+id);
	header_tr.insertAdjacentElement('beforeEnd',trrow);
	
	
	var _aa=tb.rows.length;
	for ( var i=0; i<_aa; i++ )
		tb.deleteRow(0);
		
	_rows = xhierarchy.selectNodes(".//rows/row");
	_rows_len = _rows.length;
	for ( var j=0; j<_rows_len; j++ )
	{
		var trow=document.createElement("TR");
		trow.valign="middle";
		
		trow.insertAdjacentElement('beforeEnd',createImgTd( j % 2 ? 'tableRowEvenLeft' : 'tableRowOddLeft' ));
		
		var _columns = _rows[j].selectNodes("column");
		for ( var i=0; i<_header_columns_len; i++ )
		{
			var tcolx=document.createElement("TD");
			tcolx.className = ( j % 2 ? 'tableRowEven' : 'tableRowOdd' );
			
			if ( disp_link && i == link_fild_index )
				tcolx.innerHTML = '<a href="view_doc.html?mode=' + catalog_name + '&object_id=' + _rows[j].getAttribute("id") + '">' + _columns[i].text + '&nbsp;</a>';
			else
				tcolx.innerHTML = _columns[i].text;
				
			var tcolx=trow.insertAdjacentElement('beforeEnd',tcolx);
		}
		
		trow.insertAdjacentElement('beforeEnd',createImgTd( j % 2 ? 'tableRowEvenRight' : 'tableRowOddRight' ));
		
		tb.insertAdjacentElement('beforeEnd',trow);
	}
	
	sort_index = sort_i;
}

function ReadyStateChange()
{
	if ( !this.xhierarchy.readyState || this.xhierarchy.readyState == 4 );
		//TransformChunk( cur_id, cur_sort_index );
}

function TransformChunk( id, sort_i )
{
	drow_grid( id, sort_i )
	disp_progress( id, false );
}
</script>

<input type="button" onclick="disp_grid('<%=rndID%>');return false" value="START"/>
<br/>
<br/>
<br/>



<table width="100%" class="tableBasic" border="0" cellspacing="0" cellpadding="0" id="qwer">
<tbody id="grid_<%=rndID%>">
</tbody>
</table>







<!--
<table width="100%" class="tableBasic" border="0" cellspacing="0" cellpadding="0" id="grid_<%=rndID%>">
<div style=" position:absolute; display:none;" id="progress_<%=rndID%>"><img src="pics/progress.gif"/></div>
	<tr>
		<td class="tableHeaderTextLeft"><img src="pics/1blank.gif" width="1" height="1"/></td>
		<td class="tableHeaderText" colspan="" width="100%" id="tableHeaderText_<%=rndID%>"><p class="tableHeaderTextInner" id="tableHeaderTextInner_<%=rndID%>">1111</p></td>
		<td class="tableHeaderTextRight"><img src="pics/1blank.gif" width="1" height="1"/></td>
	</tr>
	
	<tbody id="header_tr_<%=rndID%>"></tbody>

	<tr>
		<td class="tableHeaderNoTextLeft"><img src="pics/1blank.gif" width="1" height="1"/></td>
		<td class="tableHeaderNoText" colspan="" id="tableHeaderNoText_<%=rndID%>"><img src="pics/1blank.gif" width="1" height="1"/></td>
		<td class="tableHeaderNoTextRight"><img src="pics/1blank.gif" width="1" height="1"/></td>
	</tr>
	
	<tbody id="recycler_<%=rndID%>"></tbody>
	
	<tr>
		<td class="tableFooterLeft"><img src="pics/1blank.gif" width="1" height="1"/></td>
		<td class="tableFooter" colspan="" id="tableFooter_<%=rndID%>"><img src="pics/1blank.gif" width="1" height="1"/></td>
		<td class="tableFooterRight"><img src="pics/1blank.gif" width="1" height="1"/></td>
	</tr>
</table>
-->