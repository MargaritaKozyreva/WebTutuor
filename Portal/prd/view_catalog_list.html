<%
//curView = new Object;
//curView.SetProperty( "id", "1" );
//curView.SetProperty( "catalog_name", "collaborator" );
//curView.SetProperty( "view_type", "collaborator" );
//curView.SetProperty( "xquery_qual", "$elem/web_banned = true()" );
//curView.SetProperty( "array", ArraySelect( "collaborator", "true" ) );
//curView.SetProperty( "disp_link", "true" );
//curView.SetProperty( "disp_check_box", "true" );
//curView.SetProperty( "link_mode", "person" );
//curView.SetProperty( "link_prop", "&req=1&resp=2" );
//curView.SetProperty( "link_prop", "='&element_id=' + ListElem.id" );
//curView.SetProperty( "link_object_field", "person_id" );
//curView.SetProperty( "title", "Title" );
//curView.SetProperty( "link_field_index", "3" );
//curView.SetProperty( "disp_sort", "false" );
//curView.SetProperty( "sort_index", 4 );
//curView.SetProperty( "sort_direct", "-" );
//curView.SetProperty( "check_access", "false" );
//curView.SetProperty( "col_headers", Array("1","2") );
//curView.SetProperty( "col_cells", Array("1","2") );
//curView.SetProperty( "disp_search", "true" );
//curView.SetProperty( "disp_filter", "true" );
//curView.SetProperty( "list_columns", Array("fullname","login","email") );
//curView.SetProperty( "list_headers", Array("FIO","Login","E-mail") );
//curView.SetProperty( "open_doc", "true" );
//curView.SetProperty( "query_prop_form_dom_element", "input1" );
//curView.SetProperty( "custom_sub_links", Array("[2]'http://www.google.ru/search?q='+ListElem.name", "[3]'javascript:undefined'"));
//curView.SetProperty( "external_eval", "curArray=Array()" );
//curView.SetProperty( "paging_size", 50 );
//curView.SetProperty( "external_paging", true );

catalogBase = curLngCommon.exchange_object_types.GetOptChildByKey( curView.catalog_name );
if ( catalogBase == undefined )
	catalogBase = curLngCommon.linking_views.GetChildByKey( curView.catalog_name );

tableID =					curView.HasProperty( 'id' ) ? curView.id : '';
viewBase = 					view_types.GetChildByKey( curView.HasProperty( 'view_type' ) ? curView.view_type : curView.catalog_name );
xqueryQual =				curView.HasProperty( 'xquery_qual' ) ? curView.xquery_qual : '';
dispLink =					curView.HasProperty( 'disp_link' ) ? curView.disp_link + '' : 'false';
dispCheckBox =				curView.HasProperty( 'disp_check_box' ) ? eval( curView.disp_check_box ) == true : false;
dispCheckBoxVisibility =	curView.HasProperty( "disp_check_box_visibility" ) ? curView.disp_check_box_visibility + "" : true;
title =						curView.HasProperty( 'title' ) ? curView.title : ( catalogBase.web_title.HasValue ? catalogBase.web_title : catalogBase.title );
linkFieldIndex =			curView.HasProperty("link_field_index") ? Int( curView.link_field_index ) : 0;

if (linkFieldIndex < 0)
{
	_fldDispColmn = ArrayOptFind(viewBase.columns, "order_code == " + CodeLiteral(catalogBase.disp_name));
	if (_fldDispColmn != undefined) linkFieldIndex = _fldDispColmn.ChildIndex; else linkFieldIndex = 0;
}

linkMode =					curView.HasProperty( 'link_mode' ) ? curView.link_mode : curView.catalog_name;
linkProp =					curView.HasProperty( 'link_prop' ) ? Trim( curView.link_prop ) : '';
linkPropFlag =				StrBegins( linkProp, '=' );
linkProp =					linkPropFlag ? linkProp.slice( 1 ) : linkProp;
linkPropResult =			linkProp;
linkObjectField =			curView.HasProperty( 'link_object_field' ) ? curView.link_object_field : 'PrimaryKey';
openDocFlag =				curView.HasProperty( 'open_doc' ) ? curView.open_doc == 'true' : false;
dispSort =					curView.HasProperty( 'disp_sort' ) ? curView.disp_sort == 'true' : true;
sortIndex =					Request.QueryString.HasProperty( 'sort' + tableID ) ? Int( Request.QueryString.GetProperty( 'sort' + tableID ) ) : ( curView.HasProperty( 'sort_index' ) ? Int( curView.sort_index ) : linkFieldIndex );
sortDirect = 				Request.QueryString.HasProperty( 'direct' + tableID ) ? ( Request.QueryString.GetProperty( 'direct' + tableID ) == '0' ? '-' : '+' ) : ( curView.HasProperty( 'sort_direct' ) ? curView.sort_direct : '+' );

dispSearch =				curView.HasProperty( 'disp_search' ) ? curView.disp_search == 'true' : true;
dispFilter =				curView.HasProperty( 'disp_filter' ) ? curView.disp_filter == 'true' : true;

checkAccess =				curView.HasProperty( 'check_access' ) ? curView.check_access == 'true' : global_settings.settings.check_access_on_lists;

colHeaders =				curView.HasProperty( 'col_headers' ) ? curView.col_headers : Array();
colCells =					curView.HasProperty( 'col_cells' ) ? curView.col_cells : Array();

listColumns =				curView.HasProperty( 'list_columns' ) ? curView.list_columns : null;
listHeaders =				curView.HasProperty( 'list_headers' ) ? curView.list_headers : null;
listHeadersNum =			listHeaders == null ? 0 : ArrayCount( listHeaders );
queryPropFromDOMElem =		curView.HasProperty("query_prop_form_dom_element") && curView.query_prop_form_dom_element != "" ? curView.query_prop_form_dom_element : null;

iPaging = curView.HasProperty("paging_size") ? Int(curView.GetProperty("paging_size")) : null;
bExternalPaging = curView.HasProperty("external_paging") && curView.GetProperty("external_paging");


iSubLinksCounter = 0;
if (curView.HasProperty("custom_sub_links"))
{
	_aWannaBeLinksTempArray = curView.GetProperty("custom_sub_links");
	if (IsArray(_aWannaBeLinksTempArray))
	{
		subLinkIndex = Array();
		for (_sWannaBeLinkElem in _aWannaBeLinksTempArray)
		{
			_sWannaBeLinkElem = Trim(_sWannaBeLinkElem);
			if (StrBegins(_sWannaBeLinkElem, "["))
			{
				try
				{
					_iWannaBeIndex = Int(_sWannaBeLinkElem.slice(1, _sWannaBeLinkElem.indexOf("]")));
				}
				catch(_sdlf94p3_)
				{continue;}
				
				_oWouldBeLink = new Object;
				_oWouldBeLink.index = _iWannaBeIndex;
				_oWouldBeLink.evalhref = _sWannaBeLinkElem.slice(_sWannaBeLinkElem.indexOf("]") + 1);
				subLinkIndex[iSubLinksCounter] = _oWouldBeLink;
				iSubLinksCounter++;
				
			}
		}
	}
}

//////////////////////////////////////////

curQueryString = dispSort ? tools_web.get_query_string( true, 'sort' + tableID + ';direct' + tableID + ';sel' + tableID + ';search' + tableID + ';filter' + tableID + (queryPropFromDOMElem != null ? ";"+queryPropFromDOMElem:"") + ';page_index' + tableID) : '';

curSearchText = Request.QueryString.HasProperty( 'search' + tableID ) ? UrlDecode( Request.QueryString.GetProperty( 'search' + tableID ) ) : '';
curFilterID = Request.QueryString.HasProperty( 'filter' + tableID ) ? Request.QueryString.GetProperty( 'filter' + tableID ) : '';
curFilter = curFilterID != '' ? ArrayOptFind( lists.view_conditions_schemes, "catalog=='" + curView.catalog_name + "'&&disp_web&&PrimaryKey=='" + curFilterID + "'" ) : undefined;
curSortColumn = viewBase.columns.Child( sortIndex );

curFilterCond = curFilter != undefined ? tools.create_filter_xquery( curFilter.conditions ) : '';

if ( curView.HasProperty( 'external_eval' ) && curView.external_eval != '' )
{
	curArray = Array();
	eval( curView.external_eval );
}
else if ( curView.HasProperty( 'array' ) )
{
	if ( xqueryQual != '' || curFilterCond != '' || curSearchText != '' )
	{
		curArray = XQuery( tools.create_xquery( curView.catalog_name, xqueryQual, curFilterCond, curSearchText ) );
		curArray = ArraySelect( curView.array, "ArrayOptFindByKey(curArray," + linkObjectField + ",'PrimaryKey')!=undefined" );
	}
	else
	{
		curArray = curView.array;
	}
	curArray = ArraySort( curArray, curSortColumn.order_code, sortDirect );
}
else
{
	curArray = XQuery( tools.create_xquery( curView.catalog_name, xqueryQual, curFilterCond, curSearchText, curSortColumn.order, sortDirect ) );
}
bPaging = false;
if (iPaging > 0)
{
	curArray = ArrayDirect(curArray);
	iUpperBound = ArrayCount(curArray);
	if (iUpperBound > 0)
	{
		iPageIndex = Request.QueryString.HasProperty( "page_index" + tableID ) ? Int(Request.QueryString.GetProperty("page_index" + tableID)) : 1;
		
		if (bExternalPaging)
		{
			//// External paging recieves cut array and searches last entry for field "rows_count" ////
			oInfoRow = curArray[iUpperBound-1];
			if (oInfoRow.ChildExists("id") && oInfoRow.id == 0 && oInfoRow.ChildExists("rows_count"))
			{
				curArray = ArrayRange(curArray, 0, iUpperBound-1);
				try{_iRowsCount = Int(oInfoRow.rows_count)} catch(_x_){_iRowsCount = null;}
				if (_iRowsCount != null && iUpperBound < _iRowsCount)
				{
					bPaging = true;
					iPages = _iRowsCount / iPaging + 1;
					if (iPageIndex > iPages) iPageIndex = 1;
				}
			}
		}
		else
		{
			if (iPaging < iUpperBound)
			{
				_iRowsCount = iUpperBound-1;
				iPages = _iRowsCount / iPaging + 1;
				if (iPageIndex > iPages) iPageIndex = 1;
				curArray = ArrayRange(curArray, (iPageIndex-1)*iPaging, iPaging);
				bPaging = true;
				
			}
		}
	}
}


if ( listColumns == null )
{
	columnNum = ArrayCount( viewBase.columns );
	columnArray = viewBase.columns;
}
else
{
	columnNum = 0;
	columnArray = Array();
	for ( _column_name in listColumns )
	{
		columnArray[ columnNum ] = viewBase.columns.GetChildByKey( _column_name, 'order_code' );
		columnNum++;
	}
}
columnNum += ArrayCount( colHeaders ) + ( dispCheckBox ? 1 : 0 );
%>
<script language="javascript">
function get_selected_ids_<%=tableID%>()
{
	var _str = "";
	var personArray = document.getElementsByName("select_check_box_<%=tableID%>");
	for ( var i=0; i<personArray.length; i++ )
		if ( personArray[i].checked )
			_str += personArray[i].id + ";";

	return _str;
}
function do_sort_<%=tableID%>( _href )
{
	var _sQueryString = "<%=curQueryString%>" + _href + "&sel<%=tableID%>=" + get_selected_ids_<%=tableID%>() + "&search<%=tableID%>=<%=UrlEncode( curSearchText )%>";
<%
	if (queryPropFromDOMElem != null)
	{
%>
		var _inputTempProp = $("#<%=queryPropFromDOMElem%>");
		if (_inputTempProp.length > 0)
			_sQueryString += "&" + _inputTempProp.attr("id") + "=" + escape(_inputTempProp.val());
<%
	}
%>
	_sQueryString += "#CLA_<%=tableID%>"
	document.location.href = _sQueryString ;
	return false;
}
function do_search_<%=tableID%>()
{
	var _text = (document.getElementById("search_text_<%=tableID%>") != null) ? document.getElementById("search_text_<%=tableID%>").value : "";
	var _filter_id = (document.getElementById("filter_<%=tableID%>") != null) ? document.getElementById("filter_<%=tableID%>").value : "";
		var _sQueryString = "<%=curQueryString%>filter<%=tableID%>=" + _filter_id + "&search<%=tableID%>=" + escape( _text ) + "&sel<%=tableID%>=" + get_selected_ids_<%=tableID%>() + "&sort<%=tableID%>=<%=sortIndex%>&direct<%=tableID%>=<%=( sortDirect == '+' ? '1' : '0' )%>";
<%
	if (queryPropFromDOMElem != null)
	{
%>
		var _inputTempProp = $("#<%=queryPropFromDOMElem%>");
		if (_inputTempProp.length > 0)
			_sQueryString += "&" + _inputTempProp.attr("id") + "=" + escape(_inputTempProp.val());
<%
	}
%>
		_sQueryString += "#CLA_<%=tableID%>";
	document.location.href = _sQueryString;
	return false;
}

function filling_selected_object_ids<%=tableID%>()
{
	if( ! document.getElementById("selected_object_ids") )
		return 0;

	var _str = get_selected_ids_<%=tableID%>();

	document.getElementById("selected_object_ids").value = _str;
	return String( _str ).split(';').length - 1;
}
function submitenter_<%=tableID%>(myfield,e)
{
	var keycode;
	if (window.event) keycode = window.event.keyCode;
	else if (e) keycode = e.which;
	else return true;

	if (keycode == 13)
	{
	do_search_<%=tableID%>();
	return false;
	}
	else
	return true;
}
</script>
<a href="CLA_<%=tableID%>" id="CLA_<%=tableID%>"></a>
<table id="CLT_<%=tableID%>" width="100%" class="tableBasic" border="0" cellspacing="0" cellpadding="0">
	<tr>
		<td class="tableHeaderTextLeft"><img src="pics/1blank.gif" width="1" height="1"/></td>
		<td class="tableHeaderText" colspan="<%=columnNum%>" width="100%">
			<table width="100%" border="0" cellspacing="0" cellpadding="0">
				<tr>
					<td width="100%"><p class="tableHeaderTextInner"><%=title%></p></td>
<%
	if ( dispFilter )
	{
%>
					<td><select name="filter_<%=tableID%>" id="filter_<%=tableID%>" onchange="do_search_<%=tableID%>()" onChange__="document.set_person_form.submit();" class="inputEdit">
						<option value="">- <%=tools.get_web_str('c_filter')%> -</option>
<%
		for ( _filter in ArraySelect( lists.view_conditions_schemes, "catalog=='" + curView.catalog_name + "'&&disp_web" ) )
		{
%>
						<option value="<%=_filter.PrimaryKey%>"><%=_filter.name%></option>
<%
		}
%>
					</select>&nbsp;&nbsp;&nbsp;&nbsp;</td>
<script language="JavaScript">
selcur=document.getElementById("filter_<%=tableID%>");
selcur.selectedIndex==-1;
for(var i=0;i<selcur.options.length;i++)
	if(selcur.options[i].value=="<%=curFilterID%>")
	{
		selcur.selectedIndex=i;
		break;
	}
</script>
<%
	}

	if ( dispSearch )
	{
%>
					<td><input type="text" id="search_text_<%=tableID%>" width="16" value="<%=curSearchText%>" class="inputEdit" onKeyPress="return submitenter_<%=tableID%>(this,event)"/><img src="pics/icon_search_1.gif" onclick="do_search_<%=tableID%>()"/></td>
<%
	}
%>
				</tr>
			</table>
		</td>
		<td class="tableHeaderTextRight"><img src="pics/1blank.gif" width="1" height="1"/></td>
	</tr>
	<tr>
		<td class="tableHeaderWithTextLeft"><img src="pics/1blank.gif" width="1" height="1" /></td>
<%
	if ( dispCheckBox )
	{
%>
		<td class="tableHeaderWithText" width="30">+</td>
<%
	}
//alert(Request.UrlHost + UrlPath( Request.Url ) )
//alert(Request.Url  )
//alert(UrlPath( Request.Url ) )

	columnIndex = 0;
	for ( _column in columnArray )
	{
%>
		<td class="tableHeaderWithText" width__="<%=StrReplace( _column.width, 'zr', '0' )%>">
<%
		_column_title = ( listHeaders != null && columnIndex < listHeadersNum ? listHeaders[ columnIndex ] : ( _column.web_const.HasValue ? tools.get_web_str( _column.web_const ) : eval( _column.title ) ) );

		if ( dispSort )
		{
			_add = 'sort' + tableID + '=' + _column.ChildIndex + '&direct' + tableID + ( _column.ChildIndex == sortIndex && sortDirect == '+' ? '=0' : '=1' );
%>
			<a href="#" onclick="do_sort_<%=tableID%>('<%=_add%>')"><%=_column_title%></a>
<%
			if ( _column.ChildIndex == sortIndex )
				Response.Write( sortDirect == '+' ? '&nbsp;&#9650;' : '&nbsp;&#9660;' );
		}
		else
		{
			Response.Write( _column_title );
		}
%>
		</td>
<%
		columnIndex++;
	}

	for ( _column in colHeaders )
	{
%>
		<td class="tableHeaderWithText"><%=_column%></td>
<%
	}
%>
		<td class="tableHeaderWithTextRight"><img src="pics/1blank.gif" width="1" height="1" /></td>
	</tr>
	<tr>
		<td class="tableHeaderNoTextLeft"><img src="pics/1blank.gif" width="1" height="1" /></td>
		<td class="tableHeaderNoText" colspan="<%=columnNum%>"><img src="pics/1blank.gif" width="1" height="1" /></td>
		<td class="tableHeaderNoTextRight"><img src="pics/1blank.gif" width="1" height="1" /></td>
	</tr>
<%
	counter = 0;
	for ( ListElem in curArray )
	{
		_cur_link_field = eval( 'ListElem.' + linkObjectField );
		_row_bk_color = viewBase.row_bk_color.HasValue ? StrHexColor( eval( viewBase.row_bk_color ) ) : '';
		_row_bk_color = _row_bk_color != '' ? 'style="background-color:#' + _row_bk_color + '"' : '';

		ListElemDoc = openDocFlag ? OpenDoc( UrlFromDocID ( _cur_link_field ) ).TopElem : null;

		if ( checkAccess )
			try
			{
				if ( tools_web.check_access( ( ListElemDoc == null ? OpenDoc( UrlFromDocID ( _cur_link_field ), 'form=x-local://wtv/wtv_form_doc_access.xmd;ignore-top-elem-name=1' ).TopElem : ListElemDoc ), curUserID, curUser, Session ) == false )
					continue;
			}
			catch(_opa_)
			{
//alert(_opa_)
				continue;
			}

		_class = counter % 2 ? 'tableRowEven' : 'tableRowOdd';
		_classl = counter % 2 ? 'tableRowEvenLeft' : 'tableRowOddLeft';
		_classr = counter % 2 ? 'tableRowEvenRight' : 'tableRowOddRight';
		counter++
%>
	<tr>
		<td class="<%=_classl%>"></td>
<%
		if ( dispCheckBox )
		{
%>
		<td class="<%=_class%>" align="center" <%=_row_bk_color%> width="30px">
<%
			if ( eval( dispCheckBoxVisibility ) )
			{
%>
		<input type="checkbox" id="<%=(ListElem.PrimaryKey != "" ? ListElem.PrimaryKey : ListElem.id)%>" name="select_check_box_<%=tableID%>"/>
<%
			}
			else
			{
				Response.Write("&nbsp;");
			}
%>
		</td>
<%
		}

		for ( _column in columnArray )
		{
			try
			{
				_column_name = tools_web.get_cur_lng_name( _column.web_name.HasValue ? eval( _column.web_name ) : eval( _column.name ) );

				if ( eval( dispLink ) && _column.ChildIndex == linkFieldIndex )
				{
					if ( linkPropFlag )
						try
						{
							linkPropResult = eval( linkProp );
						}
						catch(_tufta_)
						{
							linkPropResult = '';
						}

					_template = "view_doc.html?mode=" + linkMode + "&object_id=" + _cur_link_field + "&doc_id=" + curDocID + linkPropResult;

%>
		<td class="<%=_class%>" <%=_row_bk_color%>><a href="<%=_template%>"><%=_column_name%>&nbsp;</a></td>
<%
				}
				else
				{
					if (iSubLinksCounter > 0)
					{
						_oWouldBeLink = ArrayOptFind(subLinkIndex, "index == " + _column.ChildIndex)
						if (_oWouldBeLink != undefined)
						{
							_template = OptEval(_oWouldBeLink.evalhref);
							if (_template != undefined)
								_column_name = "<a href=\""+_template+"\">"+_column_name+"</a>";
						}
					}
%>
		<td class="<%=_class%>" <%=_row_bk_color%>><%=_column_name%></td>
<%
				}
			}
			catch ( err )
			{
%>
		<td class="<%=_class%>"><font color="#FF0000"><%=err%></font></td>
<%
			}
		}

		for ( _column in colCells )
		{
%>
		<td class="<%=_class%>"><%=eval( _column )%></td>
<%
		}
%>
		<td class="<%=_classr%>"></td>
	</tr>
<%
	}
%>
	<tr>
		<td class="tableFooterLeft"><img src="pics/1blank.gif" width="1" height="1" /></td>
		<td class="tableFooter" colspan="<%=columnNum%>"><img src="pics/1blank.gif" width="1" height="1" /></td>
		<td class="tableFooterRight"><img src="pics/1blank.gif" width="1" height="1" /></td>
	</tr>
</table>
<%
	if(bPaging)
	{
		Response.Write("<center>");
		
		for (iPage =1; iPage<=iPages;iPage++ )
		{
			if (iPageIndex == iPage)
			{
%>
			<b><%=iPage%></b>&nbsp;
<%
			}
			else
			{
%>
			<a href="<%=curQueryString%>page_index<%=tableID%>=<%=iPage%>"><%=iPage%></a>&nbsp;
<%
			}
		}
		Response.Write("</center>");
	}


	if ( Request.QueryString.HasProperty( 'sel' + tableID ) && Request.QueryString.GetProperty( 'sel' + tableID ) != '' )
	{
%>
<script language="javascript">
function fill_check_<%=tableID%>()
{
	var personArray = document.getElementsByName("select_check_box_<%=tableID%>");
	var selArray = String("<%=Request.QueryString.GetProperty( 'sel' + tableID )%>").split(';');
	for ( var i=0; i<selArray.length; i++ )
		if ( selArray[i] != "" )
			for ( var j=0; j<personArray.length; j++ )
				if ( personArray[j].id == selArray[i] )
				{
					personArray[j].checked = true;
					break;
				}
}
fill_check_<%=tableID%>();
</script>
<%
	}
%>