<%
	is_auth_user = true;
	if ( !Session.HasProperty("cur_user_id") || Session.cur_user_id == undefined )
		is_auth_user = false;
		
	try
	{
		_catalogs = curCatalogsDoc.catalogs;
	}
	catch ( e )
	{
		_catalogs = curObjectID == null ? curDoc.catalogs : curObject.catalogs;
	}

	for ( _catalog in _catalogs )
	{
		_common_catalog = curLngCommon.exchange_object_types.GetOptChildByKey( _catalog.type );
		_web_template = "";
		if ( _common_catalog == undefined )
		{
			_common_catalog = ArrayOptFirstElem( XQuery( "for $elem in doc_types where $elem/object_name = '" + _catalog.type + "' return $elem" ) );
			_web_template = "view_doc.html?mode=doc_type&doc_id=" + curDocID + "&object_id=";
		}
		else
			_web_template = ( _common_catalog.web_template.HasValue ? _common_catalog.web_template + ( StrContains( _common_catalog.web_template, '?' ) ? '&' : '?' ) + 'doc_id=' + curDocID + '&object_id=' : '' );
			
		switch( _catalog.type )
		{
			case "forum":
			
				// если пришел запрос на сохранение|удаление формы,
				// сохраняем|удаляем перед выборкой данных	
				if ( is_auth_user && curUser.access.access_role == 'admin' && Request.Form.HasProperty( 'saved_forum_id' ) )
					Server.Execute('forum_save.html');
			
				if ( _catalog.all )
					objectArray = XQuery( 'for $forum in forums order by $forum/name return $forum' );
				else
					objectArray = _catalog.objects;
%>
<table width="100%"  border="0" cellspacing="0" cellpadding="0">
	<tr>
		<td class="tableHeaderTextLeft"><img src="pics/1blank.gif" width="0" height="0" /></td>
		<td class="tableHeaderText" colspan="3"><p class="tableHeaderTextInner"><%=tools_web.get_cur_lng_name( _catalog.title )%></p></td>
<%
		if ( is_auth_user && _catalog.type == 'forum' && curUser.access.access_role == 'admin') 
		{
%>
		<td class="tableHeaderText" align="right">
			<a href="view_doc.html?doc_id=<%=curDocID%>&edit_forum_id="><img src="\pics\Add_1.gif" alt="<%=tools.get_web_str('vdb_forum_add')%>" border="0"/></a>
		</td>
<%
		}
%>
		<td class="tableHeaderTextRight"><img src="pics/1blank.gif" width="0" height="0" /></td>
	</tr>
	<tr>
		<td class="tableHeaderWithTextLeft"><img src="pics/1blank.gif" width="0" height="0" /></td>
		<td class="tableHeaderWithText" width="65%"><%=tools.get_web_str('vfb_subject')%></td>
		<td class="tableHeaderWithText" width="5%"><%=tools.get_web_str('vdb_t_count')%></td>
		<td class="tableHeaderWithText" width="15%"><%=tools.get_web_str('vfb_act')%></td>
		<td class="tableHeaderWithText" width="15%"><%=tools.get_web_str('c_additional')%></td>
		<td class="tableHeaderWithTextRight"><img src="pics/1blank.gif" width="0" height="0" /></td>
	</tr>
	<tr>
		<td class="tableHeaderNoTextLeft"><img src="pics/1blank.gif" width="0" height="0" /></td>
		<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="0" height="0" /></td>
		<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="0" height="0" /></td>
		<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="0" height="0" /></td>
			<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="0" height="0" /></td>
		<td class="tableHeaderNoTextRight"><img src="pics/1blank.gif" width="0" height="0" /></td>
	</tr>					
<%	
			counter = 0;
			for ( _object in objectArray )
			{
				try
				{
					if ( is_auth_user && global_settings.settings.check_access_on_lists && tools_web.check_access( OpenDoc( UrlFromDocID ( _object.PrimaryKey ) ).TopElem, curUserID, curUser, Session ) == false )
						continue;
						
					_class = counter++ % 2 ? 'tableRowEven' : 'tableRowOdd';
					_classl = counter++ % 2 ? 'tableRowEvenLeft' : 'tableRowOddLeft';
					_classr = counter++ % 2 ? 'tableRowEvenRight' : 'tableRowOddRight';
						
					if ( _object.ChildExists( 'name' ) )
						_title = _object.name;
					else
						_title = _object.PrimaryKey.ForeignElem.name;
						
					_forum_entry_array = XQuery( 'for $forum_entry in forum_entrys where $forum_entry/forum_id = ' + _object.PrimaryKey + ' order by $forum_entry/create_date descending return $forum_entry' );
					// узнать прочитан ли форум
					isReadHtml = "";
					if ( is_auth_user )
					{
						unRead = tools_web.is_forum_readed(_object.PrimaryKey, curUserID);
						isReadHtml = (unRead) ? "&nbsp;<img src='pics/new.gif'>" : "";
					}
					
					firstElem = ArrayOptFirstElem( _forum_entry_array );
%>
	<tr>
		<td class="<%=_classl%>"></td>
		<td class="<%=_class%>"><img src="pics/forum.gif" width="13" height="11">&nbsp;<a href="view_doc.html?mode=forums&object_id=<%=_object.PrimaryKey%>&doc_id=<%=curDocID%>"><%=tools_web.get_cur_lng_name( _title )%></a><%=isReadHtml%></td>
		<td class="<%=_class%>" align="CENTER"><%=ArrayCount( _forum_entry_array )%></td>
		<td class="<%=_class%>" align="CENTER"><%=( firstElem != undefined ? StrDate( firstElem.create_date, true, false ) : '-' )%></td>
<%

			_html_close = "";
  		forum = OpenDoc( UrlFromDocID( _object.PrimaryKey ) );  			
			if (forum.TopElem.closed) 
			{
				_html_close = tools.get_web_str('vfb_end_discus')+'<br>';
				_html_edit = "";
 			}
%>
		<td class="<%=_class%>" align="CENTER">
			<%=_html_close%>
		</td>

		<td class="<%=_classr%>">&nbsp;</td>
	</tr>	
<%
				}
				catch ( ee )
				{
					alert( ee );
%>
	<tr>
		<td class="<%=_classl%>"></td>
		<td class="<%=_class%>" colspan="4"><font color="#FF0000"><%=tools.get_web_str('c_deleted')%></font></td>
		<td class="<%=_classr%>"></td>
	</tr>
<%
				}
			}
%>
	<tr>
		<td class="tableFooter" colspan="6"><img src="pics/1blank.gif" width="0" height="0" /></td>
	</tr>
</table>
		<br/>		
<%
			if ( is_auth_user && curUser.access.access_role == 'admin' ) 
				Server.Execute('view_forum_edit.html');
			break;
			
			case "blog":
				if ( _catalog.all )
					objectArray = XQuery( 'for $blog in blogs order by $blog/name return $blog' );
				else
					objectArray = QueryCatalogByKeys( "blogs", "id", ArrayExtract(_catalog.objects, "object_id") );  
%>
<table width="100%"  border="0" cellspacing="0" cellpadding="0">
	<tr>
		<td class="tableHeaderTextLeft"><img src="pics/1blank.gif" width="0" height="0" /></td>
		<td class="tableHeaderText" colspan="4"><p class="tableHeaderTextInner"><%=tools_web.get_cur_lng_name( _catalog.title )%></p></td>
		<td class="tableHeaderTextRight"><img src="pics/1blank.gif" width="0" height="0" /></td>
	</tr>
	<tr>
		<td class="tableHeaderWithTextLeft"><img src="pics/1blank.gif" width="0" height="0" /></td>
		<td class="tableHeaderWithText"><%=tools.get_web_str('c_name')%></td>
		<td class="tableHeaderWithText" width="50"><%=tools.get_web_str('vbb_authors')%></td>
		<td class="tableHeaderWithText" width="50"><%=tools.get_web_str('vbb_messages')%></td>
		<td class="tableHeaderWithText" width="200"><%=tools.get_web_str('vbb_last_message_date')%></td>
		<td class="tableHeaderWithTextRight"><img src="pics/1blank.gif" width="0" height="0" /></td>
	</tr>
	<tr>
		<td class="tableHeaderNoTextLeft"><img src="pics/1blank.gif" width="0" height="0" /></td>
		<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="0" height="0" /></td>
		<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="0" height="0" /></td>
		<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="0" height="0" /></td>
		<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="0" height="0" /></td>
		<td class="tableHeaderNoTextRight"><img src="pics/1blank.gif" width="0" height="0" /></td>
	</tr>					
<%	
			counter = 0;
			for ( _object in objectArray )
			{
				try
				{
					if ( global_settings.settings.check_access_on_lists && tools_web.check_access( OpenDoc( UrlFromDocID ( _object.PrimaryKey ), 'form=x-local://wtv/wtv_form_doc_access.xmd;ignore-top-elem-name=1' ).TopElem, curUserID, curUser, Session ) == false )
						continue;
						
					_class = counter++ % 2 ? 'tableRowEven' : 'tableRowOdd';
					_classl = counter++ % 2 ? 'tableRowEvenLeft' : 'tableRowOddLeft';
					_classr = counter++ % 2 ? 'tableRowEvenRight' : 'tableRowOddRight';
						
					if ( _object.ChildExists( 'name' ) )
						_title = _object.name;
					else
						_title = _object.PrimaryKey.ForeignElem.name;
						
					blog_entry_array = XQuery("for $elem in blog_entrys where $elem/blog_id=" + _object.id + " order by $elem/create_date descending return $elem");
%>
	<tr>
		<td class="<%=_classl%>"></td>
		<td class="<%=_class%>"><img src="pics/forum.gif" width="13" height="11">&nbsp;<a href="view_doc.html?mode=blog&object_id=<%=_object.PrimaryKey%>&doc_id=<%=curDocID%>"><%=tools_web.get_cur_lng_name( _title )%></a></td>
		<td class="<%=_class%>" align="CENTER"><%=_object.authors_num%></td>
		<td class="<%=_class%>" align="CENTER"><%=ArrayCount( blog_entry_array )%></td>
		<td class="<%=_class%>" align="CENTER"><%= ArrayCount( blog_entry_array ) > 0 ? ArrayFirstElem( blog_entry_array ).create_date : ""%></td>
		<td class="<%=_classr%>"></td>
	</tr>	
<%
				}
				catch ( df )
				{
%>
	<tr>
		<td class="<%=_classl%>"></td>
		<td class="<%=_class%>" colspan="4"><font color="#FF0000"><%=tools.get_web_str('c_deleted')%></font></td>
		<td class="<%=_classr%>"></td>
	</tr>
<%
				}
			}
%>
	<tr>
		<td class="tableFooterLeft"><img src="pics/1blank.gif" width="0" height="0" /></td>
		<td class="tableFooter" colspan="4"><img src="pics/1blank.gif" width="0" height="0" /></td>
		<td class="tableFooterRight"><img src="pics/1blank.gif" width="0" height="0" /></td>
	</tr>
</table>
		<br/>		
<%
			break;
			
		default:
		
			if ( _catalog.all )
				objectArray = XQuery( 'for $elem in ' + _catalog.type + 's order by $elem/' + _common_catalog.disp_name + ' return $elem' );
			else
				objectArray = _catalog.objects;
%>
<table width="100%"  border="0" cellspacing="0" cellpadding="0">
	<tr>
		<td class="tableHeaderTextLeft"><img src="pics/1blank.gif" width="0" height="0" /></td>
		<td class="tableHeaderText" <%=( _catalog.all ? '' : 'colspan="2"' )%>><p class="tableHeaderTextInner"><%=tools_web.get_cur_lng_name( _catalog.title )%></p></td>
		<td class="tableHeaderTextRight"><img src="pics/1blank.gif" width="0" height="0" /></td>
	</tr>
	<tr>
		<td class="tableHeaderWithTextLeft"><img src="pics/1blank.gif" width="0" height="0" /></td>
<%
			if ( _catalog.all )
			{
%>
		<td class="tableHeaderWithText" width="100%"><%=tools.get_web_str('c_name')%></td>
<%

			}
			else
			{
%>
		<td class="tableHeaderWithText" width="50%"><%=tools.get_web_str('c_name')%></td>
		<td class="tableHeaderWithText" width="50%"><%=tools.get_web_str('c_desc')%></td>
<%
			}
%>
		<td class="tableHeaderWithTextRight"><img src="pics/1blank.gif" width="0" height="0" /></td>
	</tr>
	<tr>
		<td class="tableHeaderNoTextLeft"><img src="pics/1blank.gif" width="0" height="0" /></td>
		<td class="tableHeaderNoText" <%=( _catalog.all ? '' : 'colspan="2"' )%>><img src="pics/1blank.gif" width="0" height="0" /></td>
		<td class="tableHeaderNoTextRight"><img src="pics/1blank.gif" width="0" height="0" /></td>
	</tr>
<%				
			counter = 0;
			for ( _object in objectArray )
			{				
				_class = counter++ % 2 ? 'tableRowEven' : 'tableRowOdd';
				_classl = counter++ % 2 ? 'tableRowEvenLeft' : 'tableRowOddLeft';		
				_classr = counter++ % 2 ? 'tableRowEvenRight' : 'tableRowOddRight';

				try
				{
					if ( is_auth_user && global_settings.settings.check_access_on_lists && tools_web.check_access( OpenDoc( UrlFromDocID ( _object.PrimaryKey ), 'form=x-local://wtv/wtv_form_doc_access.xmd;ignore-top-elem-name=1' ).TopElem, curUserID, curUser, Session ) == false )
						continue;
						
					_template = ( _web_template == '' ? '#' : _web_template + _object.PrimaryKey );
				
					if ( _object.ChildExists( _common_catalog.disp_name ) )
					{
						_title = _object.Child( _common_catalog.disp_name );
						_comment = ' ';
					}
					else
					{
						_title = _object.PrimaryKey.ForeignElem.Child( _common_catalog.disp_name );
						_comment = _object.comment;
					}
%>
	<tr>
		<td class="<%=_classl%>"></td>
		<td class="<%=_class%>">
		
		<a href="<%=_template%>"><%=tools_web.get_cur_lng_name( _title )%></a>
		
		</td>
<%
					if ( ! _catalog.all )
					{
%>
		<td class="<%=_class%>"><%=_comment%></td>
<%
					}
%>
		<td class="<%=_classr%>"></td>
	</tr>
<%
				}
				catch ( df )
				{
					alert( df );
%>
	<tr>
		<td class="<%=_classl%>"></td>
		<td class="<%=_class%>" <%=( _catalog.all ? '' : 'colspan="2"' )%>><font color="#FF0000"><%=tools.get_web_str('c_deleted')%></font></td>
		<td class="<%=_classr%>"></td>
	</tr>			
<%
				}
			}
%>
	<tr>
		<td class="tableFooterLeft"><img src="pics/1blank.gif" width="0" height="0" /></td>
		<td class="tableFooter" <%=( _catalog.all ? '' : 'colspan="2"' )%>><img src="pics/1blank.gif" width="0" height="0" /></td>
		<td class="tableFooterRight"><img src="pics/1blank.gif" width="0" height="0" /></td>
	</tr>
</table>
<br/>		
<%
		break;
		}
	}
%>