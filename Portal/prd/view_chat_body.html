<%
Server.Execute( "include/access_init.html" );

if ( curObjectID == null ) 
{
	if ( Request.Query.HasProperty( 'chat_id' ) && Request.Query.chat_id != '' )
		curObjectID = Int( Request.Query.chat_id );
	else if ( Request.Query.HasProperty( 'chat_code' ) )
		curObjectID = ArrayFirstElem( XQuery( "for $chat in chats where $chat/code = " + XQueryLiteral( String( Request.Query.chat_code ) ) + " return $chat" ) ).id;

	curObject = OpenDoc( UrlFromDocID( curObjectID ) ).TopElem;	
}
%>
<meta http-equiv="Content-Type" content="text/html; charset=windows-1251" />
<link href="style.css" rel="stylesheet" type="text/css"/>
<script language="JavaScript" src="scripts/tooltip/wz_tooltip_late.js"></script>
<SCRIPT LANGUAGE="JAVASCRIPT">
var reload_timeout = <%=( curObject.reload_timeout == null ? 5000 : curObject.reload_timeout*1000 )%>;
var timeOn = setInterval("putParamXML()", reload_timeout);
var chat_id = '<%=curObjectID%>';
var last_date = '';

function ParseResponse(xmltext) {
	var xmltext = $(xmltext);
	last_date = xmltext.find("c").attr("d");

	$("#users").empty();

	var _box = '';
	xmltext.find("u").each(function(){
<%
		_tip_text = "<b>" + HtmlEncode(tools.get_web_str('c_fio')) + ":</b>&nbsp;' + $(this).attr('n') + '<br/><b>" + HtmlEncode(tools.get_web_str('c_position')) + ":</b>&nbsp;' + $(this).attr('position') + '<br/><b>" + HtmlEncode(tools.get_web_str('c_subd')) + ":</b>&nbsp;' + $(this).attr('sub') + '<br/><b>" + HtmlEncode(tools.get_web_str('c_org')) + ":</b>&nbsp;' + $(this).attr('org') + '";
						
		if ( curObject.name_source == "fullname" )
		{
%>
		_box += '&nbsp;&nbsp;<a href="javascript:;" onmouseover="Tip(\'<%=_tip_text%>\', SHADOW, true, BGCOLOR, \'whitesmoke\');" onClick="putName(this.innerHTML);return false">' + $(this).attr("n") + '</a><br/>';
<%
		}
		else
		{
%>
		_box += '<center><a href="javascript:;" onmouseover="Tip(\'<%=_tip_text%>\', SHADOW, true, BGCOLOR, \'whitesmoke\');" onClick="putName(this.innerHTML);return false" title="' + $(this).attr("n") + '">' + $(this).attr("l") + '</a><br/></center>';
<%
		}
%>

	});
	$("<span/>").html(_box).appendTo("#users");

	var _box = '';
	var chatter_name = '';
	xmltext.find("m").each(function(){
<%
		if (curObject.name_source == "fullname")
		{
%>
		chatter_name = $(this).attr("n");
		if (chatter_name == "")
<%
		}
%>		
			chatter_name = $(this).attr("l");
		
		_box += '<small>[' + $(this).attr("d") + ']</small> ' + '<b><a href="javascript:;" onClick="window.parent.putName(this.innerHTML);return false">' + chatter_name + '</a></b> ' + '<font' + ( $(this).text().indexOf( "<%=curUser.login%>" ) != -1 ? ' color="#ff0000"' : '' ) + '>' + $(this).text() + '</font><br>';
	});
	if ( _box != '' )
		$("#contaner_frame").scrollTop( $("#text_frame").append(_box).outerHeight() );
}

function putParamXML(text) {
	var _text = String(text).replace(/^\s*|\s*$/g,"");
	_text = String(_text).replace(/\</g,"&lt;");
	_text = String(_text).replace(/\&/g,"&amp;");
	_text = String(_text).replace(/\>/g,"&gt;");

	if ( text != undefined && _text == '' )
		return false;
		
	clearInterval(timeOn);
	
	$.ajax({
		type: "POST",
		url: "chat_processing.html",
		data: "chat_id=" + chat_id + "&message_text=" + ( text != undefined ? escape(_text) : "" ) + "&last_date=" + last_date,
		dataType: "xml",
		success: function( xml ) {
			ParseResponse( xml );
			timeOn = setInterval( "putParamXML()", reload_timeout );
		},
		error: function( oXttpRequest, sTextStatus, sErrorThrown ) {
			alert( <%=CodeLiteral( tools.get_web_str('vcb_error') )%> + ': ' + sTextStatus );
		}
	});

	return false; 
}

function putName(name) {
	_box = $("#message_text");
	_box.val( _box.val() + name + ': ' ).focus();
}

putParamXML();
</SCRIPT>	

<table width="100%"  border="0" cellspacing="0" cellpadding="3">
	<tr>
		<td width="150">
		<div id="users" STYLE=" height: 250px; width: 150px; border-width:1px; border-style:solid; overflow-y:auto; overflow-x:auto"/>
		</td>
		<td width="100%">
		<div id="contaner_frame" STYLE=" height: 250px; border-width:1px; border-style:solid; overflow-y:auto; overflow-x:hidden;">
			<div id="text_frame"/>
		</div>
		</td>
	</tr>
	<tr>
		<td colspan="2">
			<FORM NAME="send_form" ID="send_form" onSubmit="putParamXML(this.message_text.value); this.message_text.value=''; this.message_text.focus(); return false;" METHOD="post">
				<INPUT NAME="chat_id" TYPE="HIDDEN" VALUE="<%=curObjectID%>">

				<%=tools.get_web_str('vcb_message_title')%>
				<INPUT NAME="message_text" ID="message_text" TYPE="text" CLASS="inputEdit" STYLE="width: 350px">
				<INPUT NAME="message_submit" TYPE="submit" value="<%=tools.get_web_str('vcb_submit')%>" CLASS="inputButton" STYLE="width:100px" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';">				
			</FORM>
		</td>
	</tr>
</table>
