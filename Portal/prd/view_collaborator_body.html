<%
function check_boss()
{
	try
	{
		_cur_user = curObject;
		if (_cur_user.position_parent_id.HasValue && ArrayOptFirstElem(XQuery("for $elem in func_managers where $elem/person_id = " + curUserID + " and $elem/object_id = " + _cur_user.position_parent_id + " and $elem/is_native = true() return $elem")) != undefined)
		{
			return true;
		}
		else if ( ! curUser.position_id.HasValue )
		{
			return false;
		}

		_cur_position = curUser.position_id.ForeignElem;

		if (!_cur_position.is_boss || (!_cur_position.parent_object_id.HasValue && !_cur_position.org_id.HasValue))
			return false;

		if (_cur_position.org_id.HasValue)
			_xquery = XQuery("for $position in positions where $position/basic_collaborator_id = " + curObjectID + " and $position/parent_object_id = " + (_cur_position.parent_object_id.HasValue ? _cur_position.parent_object_id : "null()") + " and $position/org_id = " + _cur_position.org_id + " return $position");
		else
			_xquery = XQuery("for $position in positions where $position/basic_collaborator_id = " + curObjectID + " and $position/parent_object_id = " + _cur_position.parent_object_id + " return $position");

		return (ArrayOptFirstElem(_xquery) != undefined);
	}
	catch (err1)
	{
		return false;
	}
}


	_fmarr = XQuery("for $elem in func_managers where $elem/object_id = " + curObjectID + " and $elem/person_id = " + curUserID + " return $elem");

	_im_in_groups = XQuery("for $elem in group_collaborators where $elem/collaborator_id = " + curObjectID + " return $elem");

	_my_grops = XQuery("for $elem in func_managers where $elem/person_id = " + curUserID + " and $elem/catalog = 'group' return $elem");
	_my_grops = ArraySelect(_my_grops, "ArrayOptFind(_im_in_groups, 'group_id == ' + object_id) != undefined");
	_fmarr = ArrayUnion(_fmarr, _my_grops);

	_op_arr = Array();
	_spat_id = Array();
	try
	{
		_spat_id[ArrayCount(_spat_id)] = curObject.org_id;
		_parent_document_object = curObject.position_id.ForeignElem.parent_object_id.OptForeignElem;

		my_position = curUser.position_id.OptForeignElem;
		if (my_position != undefined && my_position.is_boss && my_position.parent_object_id.HasValue)
			_boss_of_sub = my_position.parent_object_id;
		else
			_boss_of_sub = null;

		_parent_document_object = ArrayOptFirstElem(XQuery("for $sub in subdivisions where $sub/id = "+XQueryLiteral(_parent_document_object.PrimaryKey)+ " return $sub"));
		while (_parent_document_object != undefined)
		{
			_spat_id[ArrayCount(_spat_id)] = _parent_document_object.PrimaryKey;

			if (_boss_of_sub == _parent_document_object.PrimaryKey)
			{
				_op_arr[ArrayCount(_op_arr)] = ArrayOptFind(boss_types, "is_std == true");
				_boss_of_sub = null;
			}

			_parent_document_object = ArrayOptFirstElem(XQuery("for $sub in subdivisions where $sub/id = "+XQueryLiteral(_parent_document_object.parent_object_id)+ " return $sub"));
		}

	}
	catch(_gop_)
	{}


	for (_elem in _fmarr)
	{
		_a = _elem.boss_type_id.OptForeignElem;
		if (_a != undefined)
		{
			_op_arr[ArrayCount(_op_arr)] = _a;
		}
	}

	/*
	_fmarr = tools.get_user_boss(curObjectID);
	if (_fmarr != undefined && _fmarr.id == curUserID)
	{
		_op_arr[ArrayCount(_op_arr)] = ArrayOptFind(boss_types, "is_std == true");
	}
	*/

	_fmarr = Array();
	_i = 0;
	for(_a in _op_arr)
	{
		if (_a == undefined) continue;
		if (_i > 0)
		{
			_na = Array();
			for (_j in _fmarr)
				if (StrContains(_a.operations, _j))
				if (_j + "" != "")
					_na[ArrayCount(_na)] = Int(_j);
			_fmarr = _na;
		}
		else
		{
			_fmarr = String(_a.operations).split(";");
			for (_j = 0; _j < ArrayCount(_fmarr); _j++)
			if (_fmarr[_j] + "" != "")
				_fmarr[_j] = Int(_fmarr[_j]);
		}
		if (ArrayCount(_fmarr) == 0)
			break;

		_i++;
	}

	if (ArrayCount(_spat_id) > 0 )
	{
		_elems = ArraySelect(QueryCatalogByKeys("func_managers", "object_id", _spat_id), "person_id == "+ curUserID);

		for (_elem in _elems)
		{
			_a = _elem.boss_type_id.OptForeignElem;
			if (_a != undefined)
			{
				_na = String(_a.operations).split(";");
				for (_j = 0; _j < ArrayCount(_na); _j++)
				if (_na[_j] + "" != "")
					_na[_j] = Int(_na[_j]);

				_fmarr = ArraySelectDistinct( ArrayUnion(_fmarr, _na) , "This");
			}
		}
	}


	_selectedActions = QueryCatalogByKeys("operations", "id", _fmarr);

	_selectedPriveleges = ArraySelect(_selectedActions, "operation_type == 1");
	_selectedActions = ArraySelect(_selectedActions, "operation_type == 0");

	editList = undefined;
	_editDesc = false;

	if (ArrayOptFind(_selectedPriveleges, "action == 'edit_person_card'") != undefined)
	{
		IS_MODIFY = true;

		editList = ArrayExtract(OpenDoc(UrlFromDocID(ArrayOptFind(_selectedPriveleges, "action == 'edit_person_card'").id)).TopElem.parameters, "This.name");
		if (ArrayOptFirstElem(editList) == undefined) editList = undefined;
			else
		if (ArrayOptFind(editList, "This == 'desc'") != undefined)
		{
			_editDesc = true;
			editList = ArraySelect(editList, "This != 'desc'")
			//if (ArrayOptFirstElem(editList) == undefined) editList = undefined;
		}
		else
			_editDesc = false;
	}
	else
		IS_MODIFY = false;

	if (ArrayOptFind(_selectedPriveleges, "action == 'show_detailed'") != undefined)
		_show_detailed = true;
	else
		_show_detailed = false;

	if (ArrayOptFind(_selectedPriveleges, "action == 'show_all'") != undefined)
	{
		_show_all = true;
		_show_detailed = true;
	}
	else
		_show_all = false;

	_tabTypes = Array();

	_tabTypes[0] = new Object;
	_tabTypes[0].id = 'common';
	_tabTypes[0].name = tools.get_web_str('c_common');
	_tabTypes[0].show = true;

	_tabTypes[1] = new Object;

	_tabTypes[1].id = 'learning';
	_tabTypes[1].name = tools.get_web_str('c_courses');
	if (_show_all || ArrayOptFind(_selectedPriveleges, "action == 'show_learning'") != undefined)
		_tabTypes[1].show = global_settings.disp_dist;
	else
		_tabTypes[1].show = false;

	_tabTypes[2] = new Object;
	_tabTypes[2].id = 'test_learning';
	_tabTypes[2].name = tools.get_web_str('c_tests');
	if (_show_all || ArrayOptFind(_selectedPriveleges, "action == 'show_learning'") != undefined)
		_tabTypes[2].show = global_settings.disp_test;
	else
		_tabTypes[2].show = false;

	_tabTypes[3] = new Object;
	_tabTypes[3].id = 'event';
	_tabTypes[3].name = tools.get_web_str('c_events');
	if (_show_all || ArrayOptFind(_selectedPriveleges, "action == 'show_event'") != undefined)
		_tabTypes[3].show = global_settings.disp_edu;
	else
		_tabTypes[3].show = false;

	_tabTypes[4] = new Object;
	_tabTypes[4].id = 'education_plan';
	_tabTypes[4].name = tools.get_web_str('c_edu_plans');
	if (_show_all || ArrayOptFind(_selectedPriveleges, "action == 'show_development_plan'") != undefined)
		_tabTypes[4].show = global_settings.disp_edu;
	else
		_tabTypes[4].show = false;

	_tabTypes[5] = new Object;
	_tabTypes[5].id = 'assessment_appraise';
	_tabTypes[5].name = tools.get_web_str('ass_mark');
	if (_show_all || ArrayOptFind(_selectedPriveleges, "action == 'show_assessment_appraise'") != undefined)
		_tabTypes[5].show = global_settings.disp_ass;
	else
		_tabTypes[5].show = false;

	_tabTypes[6] = new Object;
	_tabTypes[6].id = 'desc';
	_tabTypes[6].name = tools.get_web_str('c_desc');
	if (_show_all || curObject.disp_desc || ArrayOptFind(_selectedPriveleges, "action == 'show_desc'") != undefined)
		_tabTypes[6].show = true;
	else
		_tabTypes[6].show = false;

	_tabTypes[7] = new Object;
	_tabTypes[7].id = 'knowledge_part';
	_tabTypes[7].name = tools.get_web_str('vkm_knowledge_map');
	if (_show_all || ArrayOptFind(_selectedPriveleges, "action == 'show_knowledge_part'") != undefined)
		_tabTypes[7].show = global_settings.disp_knowlcntrl;
	else
		_tabTypes[7].show = false;

	_tabTypes[8] = new Object;
	_tabTypes[8].id = 'summary';
	_tabTypes[8].name = tools_web.get_web_str('vcb_summary');
	if (_show_all || ArrayOptFind(_selectedPriveleges, "action == 'show_summary'") != undefined)
		_tabTypes[8].show = true;
	else
		_tabTypes[8].show = false;

	_tabTypes[9] = new Object;
	_tabTypes[9].id = 'change_log';
	_tabTypes[9].name = tools_web.get_web_str('vcb_history');
	if (_show_all || ArrayOptFind(_selectedPriveleges, "action == 'show_change_log'") != undefined)
		_tabTypes[9].show = true;
	else
		_tabTypes[9].show = false;
		
	_tabTypes[10] = new Object;
	_tabTypes[10].id = 'collabor_files';
	_tabTypes[10].name = tools_web.get_web_str('vdb_files');
	if ( curObject.disp_files )
	{
		if (_show_all || ArrayOptFind(_selectedPriveleges, "action == 'show_files'") != undefined)
			_tabTypes[10].show = true;
		else
			_tabTypes[10].show = false;	
	}
	else
	{
		_tabTypes[10].show = false;	
	}


	aVisibleTabs = ArraySelect(_tabTypes, "show == true");
	if (Request.QueryString.HasProperty("tab_id"))
	{
		_selectedTab = ArrayOptFind(aVisibleTabs, "id == '" + Request.QueryString.GetProperty("tab_id") + "'");
		if (_selectedTab == undefined) _selectedTab = ArrayOptFirstElem(aVisibleTabs);
	}
	else
		_selectedTab = ArrayOptFirstElem(aVisibleTabs);
	if (_selectedTab != undefined)
		_selectedTab = _selectedTab.id;
%>

<script src="scripts/calendar/calendar.js"></script>
<script language="JavaScript">
<!--
function toggle_section(_word, srcElem)
{
	if (!srcElem) srcElem = $("div#__tabrowholder td#td_" + _word).get(0);
	var jqCurTable = $(srcElem).parents("table[name='collaborator_header_row_set']");
	if ($("div#__tabrowholder > table").length >1 && $("div#__tabrowholder > table:last").get(0) !== jqCurTable.get(0))
	{
		$("div#__tabrowholder").append(jqCurTable);
		//$(jqCurTable).css( 'zIndex', 100 );
		//$(jqCurTable).find("a").trigger("mouseout");
	}

	var e_div;
	var e_td;
<%
	for (_tt in _tabTypes)
	{
%>
	e_div = document.getElementById("div_<%=_tt.id%>");
	e_td = document.getElementById("td_<%=_tt.id%>");

	if (e_div != undefined && e_td != undefined)
	if (_word == "<%=_tt.id%>")
	{
		e_div.style.display = "inline";
		e_td.className = "tab_td_sel";
		$("#tab_id").val(_word);
	}
	else
	{
		e_div.style.display = "none";
		e_td.className = "tab_td";
	}
<%
	}
%>
}
-->
</script>


<style>
.tab_td {
	border-right: #aaaaaa 1px solid; border-top: #aaaaaa 1px solid; border-left: #aaaaaa 1px solid; border-bottom: #aaaaaa 1px solid; text-align: center; background-color: #EEEEEE; height:24px
}
.tab_td_sel {
	border-right: #aaaaaa 1px solid; border-top: #aaaaaa 1px solid; border-left: #aaaaaa 1px solid; border-bottom: #aaaaaa 0px solid; text-align: center; font-weight:bold; height:28px; background-color: white;
}
.tab_td_empty {
	border-bottom: #aaaaaa 1px solid;
}
</style>
<%
	iContentItemsLength = ArrayCount(aVisibleTabs);
	iTabMaximum = 6;

	iX = 0; iCount=0;
	iBreakCount = 1 + Int(Real(iContentItemsLength) / Real(iTabMaximum));

	iLength = Int(Real(iContentItemsLength) / Real(iBreakCount) + 0.5);
	iIteration = 1;
%>
<div id="__tabrowholder">
<table width="100%" border="0" cellspacing="0" cellpadding="0" name="collaborator_header_row_set" style="margin-top: -3px">
	<tr>
		<td class="tab_td_empty"><img src="pics/1blank.gif" width="<%=(5 + 5*iIteration)%>px" height="0"/></td>
<%
	if (iContentItemsLength > iTabMaximum)
		iWidth = Int(100.0 / Real(iLength));
	else
		iWidth = Int(100.0 / Real(iContentItemsLength));
	if (iWidth > 50) iWidth = 50;

	for (_tt in aVisibleTabs)
	{

%>
		<td class="<%=(_tt.id == _selectedTab ? "tab_td_sel" : "tab_td")%>" id="td_<%=_tt.id%>" onclick="return toggle_section('<%=_tt.id%>', this);" style="width: <%=iWidth%>%"><img src="pics/1blank.gif" height="0"/><br/><a style="text-decoration:none" href="#" onclick_="return toggle_section('<%=_tt.id%>', this);"><%=_tt.name%></a></td>
		<td class="tab_td_empty" width="10px">&nbsp;</td>
<%
		iX++; iCount++;
		if (iContentItemsLength > iTabMaximum && iX % iLength == 0 && iBreakCount - iIteration > 0)
		{
			iLength = Int(Real(iContentItemsLength - iCount) / Real(iBreakCount - iIteration) + 0.5);
			iX = 0;
			iIteration++;
			if (iContentItemsLength - iCount > 0)
				iWidth = Int(100.0 / Real(iLength));
			else
			{
				iWidth = Real(iContentItemsLength - iCount);
				if (iWidth > 0)
					iWidth = Int(100.0 / Real(iContentItemsLength - iCount));
				else
					iWidth = 100;
			}
			if (iWidth > 50) iWidth = 50;
%>
			<td class="tab_td_empty">&nbsp;</td>
			</tr>
			</table>

		<table width="100%" border="0" cellspacing="0" cellpadding="0" style="margin-top: -3px" name="collaborator_header_row_set">
		<tr>
		<td class="tab_td_empty"><img src="pics/1blank.gif" width="<%=(5 + 5*iIteration)%>px" height="0"/></td>
<%
		}
	}
%>
		<td class="tab_td_empty">&nbsp;</td>
	</tr>
</table>
</div>
<br/>

<%
	if ( ArrayOptFind(_tabTypes, "id == 'common' && show == true") != undefined )
	{
		try
		{
			_custom_fields = tools.get_custom_template( "collaborator", curObjectID, curObject ).fields;
		}
		catch ( _e_ )
		{
			_custom_fields = Array();
		}
%>

<div width="100%" id="div_common" style="display: none">


<script language="javascript">
	function what2submit()
	{
		var handler = false;
		try
		{
			var _source_fields = document.all.data_0_source_fields;
			var _destination_fields = document.all.data_0_destination_fields;

			_source_fields.value = "";
			_destination_fields.value = "";

			var o;

			o = document.getElementById("c_lastname");
			if (o != undefined)
			{
				_source_fields.value += "lastname";
				_destination_fields.value += String(o.value).replace(/;/, "");;
			}
			o = document.getElementById("c_firstname");
			if (o != undefined)
			{
				_source_fields.value += ";firstname";
				_destination_fields.value += ";" + String(o.value).replace(/;/, "");
			}
			o = document.getElementById("c_middlename");
			if (o != undefined)
			{
				_source_fields.value += ";middlename";
				_destination_fields.value += ";" + String(o.value).replace(/;/, "");;
			}

			o = document.getElementById("c_position_id");
			if (o != undefined)
			{
				_source_fields.value += ";position_id";
				_destination_fields.value += ";" + o.value;
			}

			o = document.getElementById("c_hire_date");
			if (o != undefined)
			{
				_source_fields.value += ";hire_date";
				_destination_fields.value += ";" + (o != undefined ? o.value : "");
			}

			o = document.getElementById("c_dismiss_date");
			if (o != undefined)
			{
				_source_fields.value += ";dismiss_date";
				_destination_fields.value += ";" + (o != undefined ? o.value : "");
			}

<%
	if (_show_detailed)
	{
%>

			o = document.getElementById("c_dismiss_date");
			if (o != undefined )
			{
				_source_fields.value += ";is_dismiss";
				if (o.value != "")
				{
					_destination_fields.value += ";1";
				}
				else
				{
					_destination_fields.value += ";0";
				}
			}

			o = document.getElementById("c_not_web_banned");
			if (o != undefined)
			{
				_source_fields.value += ";access.web_banned";
				_destination_fields.value += ";" + (o.checked ? "0" : "1");
			}
	<%
		if (curObject.disp_personal_info)
		{
	%>
			o = document.getElementById("c_phone");
			if (o != undefined)
			{
				_source_fields.value += ";phone";
				_destination_fields.value += ";" + String(o.value).replace(/;/, "");
			}

			o = document.getElementById("c_address");
			if (o != undefined)
			{
				_source_fields.value += ";address";
				_destination_fields.value += ";" + String(o.value).replace(/;/, "");
			}

			o = document.getElementById("c_email");
			if (o != undefined)
			{
				_source_fields.value += ";email";
				_destination_fields.value += ";" + String(o.value).replace(/;/, "");
			}

<%
		}
				for (_field in _custom_fields)
				{
					_ce_id = "c_custom_elem_" + _field.name;
%>
					_source_fields.value += ";custom_elems.ObtainChildByKey('<%=_field.name%>').value";
					_destination_fields.value += ";"
					<%
						if (_field.type == 'bool')
						{
					%>
						if (document.getElementById("<%=_ce_id%>") != undefined)
							_destination_fields.value += ( document.getElementById("<%=_ce_id%>").checked ? "true" : "false");
					<%
						}
						else
						{
					%>
							if (document.getElementById("<%=_ce_id%>") != undefined)
								_destination_fields.value += String(document.getElementById("<%=_ce_id%>").value).replace(/;/, "");
					<%
						}
					%>
<%
				}
	}
%>
			handler = true;
		}
		catch(_ebt_)
		{
			window.alert(_ebt_);
		}

		return handler;
	}
</script>


<form name="collaborator_submitter" id="collaborator_submitter" action="document_save.html" method="post" onsubmit="return what2submit();">
		<input type="hidden" name="data_0_id" value="<%=curObjectID%>"/>
		<input type="hidden" name="data_0_source_fields" value=""/>
		<input type="hidden" name="data_0_destination_fields" value=""/>

		<input type="hidden" name="doc_id" value="<%=curDocID%>"/>
		<input type="hidden" name="mode" value="<%=curMode%>"/>
		<input type="hidden" name="parameters" value="object_id=<%=curObjectID%>"/>


<style>
	.wtInfoTable
	{
		border: solid 1px #999999;
		background-color: #EEEEEE;
	}
	.wtInfoTableTD
	{
		padding: 6px;
		vertical-align: top;
	}
	.wtInfoTablePhotoContainer
	{
		padding: 6px;
		background-color: #CCCCCC;
	}
	.wtInfoTablePhoto
	{
		width: 150px;
	}
	.wtInfoTablePhotoActive
	{
		width: 150px;
		cursor: pointer;
	}
	.wtInfoTableForm
	{
		/*width: 450px;*/
	}
	.wtInfoTableFormTD
	{
		background-color: #DDDDDD;
		border-bottom: solid 2px #EEEEEE;
		padding: 3px;
		padding-left: 6px;
		font-family: Tahoma, sans-serif;
		font-size: 12px;
	}
	.wtFullWidth
	{
		width: 100%;
	}
	.wtInfoTableFormTDRight
	{
		background-color: #DDDDDD;
		border-bottom: solid 2px #EEEEEE;
		padding: 3px;
		padding-right: 6px;
		font-family: Tahoma, sans-serif;
		font-size: 12px;
		width: 100%;
	}
	.wtInfoTablePathTD
	{
		padding: 6px;
		padding-top: 3px;
		padding-bottom: 12px;
		font-family: Tahoma, sans-serif;
		font-size: 12px;
	}
	.wtInfoTableInput
	{
		border: solid 1px #999999;
		padding: 3px;
		font-family: Tahoma, sans-serif;
		font-size: 12px;
		width: 100%;
		height: 23px;
	}
	.wtInfoTableDivider
	{
		height: 6px;
		font-size: 6px;
	}
</style>

	<table border="0" cellpadding="0" cellspacing="0" class="wtInfoTable" width="100%">
		<tr>

<%
	iColSpan = 1;
	if (curObject.disp_personal_info)
	{
		iColSpan = 2;
		if (curObject.pict_url.HasValue)
		{
%>
			<td class="wtInfoTableTD"><div class="wtInfoTablePhotoContainer"><img class="wtInfoTablePhotoActive" src="<%=StrReplace(curObject.pict_url, "\\", "/")%>" onclick="window.open('<%=StrReplace(curObject.pict_url, "\\", "/")%>'); return false;"/></div></td>
<%
		}
		else
		{
%>
			<td class="wtInfoTableTD"><div class="wtInfoTablePhotoContainer"><img class="wtInfoTablePhoto" src="pics/nophoto.jpg"/></div></td>
<%
		}
	}
%>
			<td width="100%" class="wtInfoTableTD">

				<table cellspacing="0" cellpadding="0" border="0" class="wtInfoTableForm">
					<tr>
						<td style="font-weight: bold;" align="left" class="wtInfoTableFormTD">
							<%=tools.get_web_str("uf_last_name")%>:
						</td>
						<td class="wtInfoTableFormTDRight wtFullWidth">
							<input type="text" name="c_lastname" id="c_lastname" class="wtInfoTableInput" value="<%=curObject.lastname%>" <%=(IS_MODIFY && (editList == undefined || ArrayOptFind(editList, "This == 'lastname'")!= undefined ) ? "": "readonly")%>/>
						</td>
					</tr>
					<tr>
						<td style="font-weight:bold;" align="left" class="wtInfoTableFormTD">
							<%=tools.get_web_str("uf_name")%>:
						</td>
						<td class="wtInfoTableFormTDRight wtFullWidth">
							<input type="text" class="wtInfoTableInput" name="c_firstname" id="c_firstname" value="<%=curObject.firstname%>" <%=(IS_MODIFY && (editList == undefined || ArrayOptFind(editList, "This == 'firstname'") != undefined)? "": "readonly")%>/>
						</td>
					</tr>
					<tr>
						<td style="font-weight:bold;" align="left" class="wtInfoTableFormTD">
							<%=tools.get_web_str("uf_s_name")%>:
						</td>
						<td class="wtInfoTableFormTDRight wtFullWidth">
							<input type="text" name="c_middlename" id="c_middlename" class="wtInfoTableInput" value="<%=curObject.middlename%>" <%=(IS_MODIFY && (editList == undefined || ArrayOptFind(editList, "This == 'middlename'")!= undefined)? "": "readonly")%>/>
						</td>
					</tr>
<%
if (_show_detailed)
{
	if (curObject.disp_personal_info)
	{
%>
					<tr>
						<td class="wtInfoTableDivider">&nbsp;</td>
						<td class="wtInfoTableDivider">&nbsp;</td>
					</tr>
					<tr>
						<td style="font-weight:bold;" class="wtInfoTableFormTD">
							<%=tools.get_web_str("uf_phone")%>:
						</td>
						<td class="wtInfoTableFormTDRight wtFullWidth">
							<input type="text" name="c_phone" class="wtInfoTableInput" value="<%=curObject.phone%>" <%=(IS_MODIFY && (editList == undefined || ArrayOptFind(editList, "This == 'phone'")!= undefined)? "": "readonly")%>/>
						</td>
					</tr>
					<tr>
						<td style="font-weight:bold;" class="wtInfoTableFormTD">
							<%=tools.get_web_str("uf_address")%>:
						</td>
						<td class="wtInfoTableFormTDRight wtFullWidth">
							<input type="text" name="c_address" class="wtInfoTableInput" value="<%=curObject.address%>" <%=(IS_MODIFY && (editList == undefined || ArrayOptFind(editList, "This == 'address'")!= undefined)? "": "readonly")%>/>
						</td>
					</tr>
					<tr>
						<td style="font-weight:bold;"  class="wtInfoTableFormTD">
							<%=tools.get_web_str("uf_email")%>:
						</td>
						<td class="wtInfoTableFormTDRight wtFullWidth">
							<input type="text" name="c_email" class="wtInfoTableInput" value="<%=HtmlEncode(curObject.email)%>" <%=(IS_MODIFY && (editList == undefined || ArrayOptFind(editList, "This == 'email'")!= undefined)? "": "readonly")%>/>
						</td>
					</tr>
<%
	}
}
%>
				</table>
			</td>
		</tr>
		<tr>
			<td colspan="<%=iColSpan%>" class="wtInfoTableTD">
				<table width="100%" cellspacing="0" cellpadding="0" border="0">
<%
		_out_str = "";
		_position = curObject.position_id.OptForeignElem;
		if (_position != undefined)
		{
			_parent = _position.parent_object_id.OptForeignElem;

			_i = 0;
			while (_parent != undefined && _i < 10)
			{
				_out_str = '&nbsp;<img src="pics/current.gif" border="0"/>&nbsp;<a href="view_doc.html?mode=subdivision&doc_id=' + curDocID + '&object_id=' + _parent.PrimaryKey + '"><img src="pics/subdivision.ico" border="0" align="absmiddle" hspace="3"/>&nbsp;' + _parent.name + '</a>' + _out_str;
				_parent = _parent.parent_object_id.OptForeignElem;
			}

			_parent = _position.org_id.OptForeignElem;

			if (_parent != undefined)
				_out_str =  '<a href="view_doc.html?mode=org&doc_id=' + curDocID + '&object_id=' + _parent.PrimaryKey + '"><img src="pics/org.ico"  border="0" align="absmiddle" hspace="3"/>&nbsp;' + (_parent.name != "" ? _parent.name : _parent.disp_name) + "</a>" + _out_str;

			if (_out_str != "")
			{
%>
					<tr>
						<td colspan="2" class="wtInfoTablePathTD">
							<%=_out_str%>
						</td>
					</tr>
<%
			}
		}
%>
<!--position-->

					<tr>
						<td style="font-weight:bold;" class="wtInfoTableFormTD">
							<nobr><%=tools.get_web_str("uf_main_position")%>:</nobr>
						</td>
						<td class="wtInfoTableFormTDRight wtFullWidth">
							<nobr>
							<input type="text" name="c_position_name" id="c_position_name"  class="wtInfoTableInput" value="<%=curObject.position_name%>" readonly="readonly"/>
<%
if (IS_MODIFY && (editList == undefined || ArrayOptFind(editList, "This == 'position'")!= undefined))
{
%>
							<script language="javascript">
							<!--
								function select_position()
								{
									var pars_pos=new Object();
									var strAttr="status:no;dialogWidth:780px;dialogHeight:550px;help:no;resizable:1";
									xShowModalDialog("dlg_select.html?doc_id=<%=curDocID%>&catalog_name=position&typein=0&multi_select=0&xquery_qual=" + escape("$elem/basic_collaborator_id = null()") + "&rand="+Math.random(), pars_pos, strAttr);

									if ( ! pars_pos.handle ) return false;

									document.getElementById("c_position_id").value = pars_pos.element_id;
									document.getElementById("c_position_name").value = pars_pos.element_name;
								}
							-->
							</script>

							<input type="hidden" name="c_position_id" id="c_position_id" value="<%=curObject.position_id%>"/>
							<input type="button" value="..." class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';" onclick="select_position()" style="width: 25px"/>
<%
}
%>
							</nobr>
						</td>
					</tr>
<%
if (_show_detailed)
{
%>
					<tr>
						<td style="font-weight:bold;" class="wtInfoTableFormTD">
							<nobr><%=tools.get_web_str("c_hire_date")%>:</nobr>
						</td>
						<td class="wtInfoTableFormTDRight wtFullWidth">
							<table border="0" cellpadding="1" cellspacing="0">
							<tr valign="middle">
							<td>
								<input type="text" name="c_hire_date" id="c_hire_date" style="width: 80px"  class="wtInfoTableInput" value="<%=(curObject.hire_date.HasValue ? DateNewTime(curObject.hire_date) : "")%>" readonly/>
							</td>
						<%
							if (IS_MODIFY && (editList == undefined || ArrayOptFind(editList, "This == 'hire_date'")!= undefined))
							{
						%>
							<td valign="middle">
								<a href="#" onclick="var h=0; var offP = this.offsetParent; while(offP.id != 'main_block' && offP.tagName.toUpperCase()!='BODY') {h+=offP.offsetTop; offP = offP.offsetParent;} ; showCalendar(this, document.getElementById('c_hire_date'), 'dd.mm.yyyy','ru',1,null, h+40); return false;"><img src="/scripts/calendar/calendar.gif" width="24" height="22" border="0"/></a>
							</td>
						<%
							}
						%>
							</tr>
							</table>
						</td>
					<tr>
					</tr>
						<td style="font-weight:bold; " class="wtInfoTableFormTD">
							<nobr><%=tools.get_web_str("c_dismiss_date")%>:</nobr>
						</td>
						<td class="wtInfoTableFormTDRight wtFullWidth">
							<table border="0" cellpadding="1" cellspacing="0">
							<tr valign="middle">
							<td>
								<input type="text" style="width: 80px" name="c_dismiss_date" id="c_dismiss_date"  class="wtInfoTableInput" value="<%=(curObject.dismiss_date.HasValue ? DateNewTime(curObject.dismiss_date) : "")%>" readonly/>
							</td>
						<%
							if (IS_MODIFY && (editList == undefined || ArrayOptFind(editList, "This == 'dismiss_date'")!= undefined))
							{
						%>
							<td valign="middle">
								<a href="#" onclick="var h=0; var offP = this.offsetParent; while(offP.id != 'main_block' && offP.tagName.toUpperCase()!='BODY') {h+=offP.offsetTop; offP = offP.offsetParent;} ; showCalendar(this, document.getElementById('c_dismiss_date'), 'dd.mm.yyyy','ru',1,null, h+40); return false;"><img src="/scripts/calendar/calendar.gif" width="24" height="22" border="0"/></a>
							</td>
							<td valign="middle">
							<input type="button" value="x" title="<%=tools.get_web_str("c_clear_field")%>" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';" onclick="document.getElementById('c_dismiss_date').value = '';" style="width: 25px"/>
							</td>
						<%
							}
						%>
							</tr>
							</table>
						</td>
					</tr>
					<tr>
						<td colspan="2" class="wtInfoTableFormTD">
							<input type="checkbox" id="c_not_web_banned" name="c_not_web_banned" <%=(curObject.access.web_banned ? "": "checked")%> <%=(IS_MODIFY && (editList == undefined || ArrayOptFind(editList, "This == 'web_banned'")!= undefined)? "": "disabled")%>/> <%=tools.get_web_str("uf_web_unbann")%>
						</td>
					</tr>
				</table>
			</td>
		</tr>
	</table>
	<br/>
	<table border="0" cellpadding="0" cellspacing="0" class="wtInfoTable" width="100%">
		<tr>
			<td class="wtInfoTableTD">
				<table width="100%" cellspacing="0" cellpadding="0" border="0">
					<script language="javascript">
						<!--
						function checkkey(srcobj, keycode)
						{
							if ((keycode<48 || keycode>57)& keycode!=46) return false;
							if (keycode==46) if(srcobj.value.indexOf('.') >= 0) return false;
							return true;
						}

						function checkkeyInt()
						{
							var srcobj = event.srcElement;
							var keycode=event.keyCode;
							if ((keycode<48 || keycode>57)) return false;
							return true;
						}
						-->
					</script>


					<%
						for (_field in ArraySelect( _custom_fields , "disp_web == true"))
						{
					%>
					<tr>
						<td style="font-weight:bold;" class="wtInfoTableFormTD">
							<nobr><%=_field.title%></nobr>
						</td>
						<td class="wtInfoTableFormTDRight wtFullWidth">
							<%
								_elem = curObject.custom_elems.ObtainChildByKey( _field.name );

								if (IS_MODIFY && (editList == undefined || ArrayOptFind(editList, "This == 'custom_elems'")!= undefined))
								{
									_ce_id = "c_custom_elem_" + _field.name;

									if (_field.type == "string")
									{
										Response.Write("<input type='text' id='"+_ce_id+"' name='"+_ce_id+"' value='" + _elem.value + "'  class='wtInfoTableInput'/>");
									}

									if (_field.type == "date")
									{
										Response.Write('<input type="text" style="width: 70px" id="' + _ce_id + '" name="' + _ce_id + '"  value="' + _elem.value + '"  class="wtInfoTableInput" readonly><a href="#"  tn="' + _ce_id + '" onClick="var h=0; var offP = this.offsetParent; while(offP.id != \'main_block\' && offP.tagName.toUpperCase()!=\'BODY\') {h+=offP.offsetTop; offP = offP.offsetParent;} ; showCalendar(this, document.getElementById(\'' + _ce_id + '\'), \'dd.mm.yyyy\',\'ru\',1, null, h + 40); return false;" id="cal' + _ce_id + '" name="cal' + _ce_id + '"><img src="scripts/calendar/calendar.gif" width="24" height="22" border="0" align="absmiddle" /></a>');
										//Response.Write("<input type='text' id='"+_ce_id+"' name='"+_ce_id+"' value='" + _elem.value + "'  class='wtInfoTableInput'/>");
									}

									if (_field.type == "text")
									{
										Response.Write("<textarea id='" + _ce_id + "' name='" + _ce_id  + "'  class='wtInfoTableInput'>" + _elem.value + "</textarea>");
									}

									if (_field.type == "integer" || _field.type == "real")
									{
										Response.Write("<input type='text' id='"+_ce_id+"' name='"+_ce_id+"' onKeyPress='return checkkey(this,window.event.keyCode);' value='" + _elem.value + "'  class='wtInfoTableInput'/>");
									}

									if (_field.type == "bool")
									{
										Response.Write("<input type='checkbox' id='" + _ce_id + "' name='" + _ce_id  + "' " + (_elem.value == "true" ? "checked" : "") + "/>");
									}

									if (_field.type == "combo")
									{
										Response.Write("<select id='" + _ce_id + "' name='" + _ce_id  + "'>\n");

										for (_entry in _field.entries)
										{
											Response.Write("<option value='" + _entry.value + "' " + (_entry.value == _elem.value ? "selected" : "") + ">" + _entry.value + "</option>\n");
										}
										Response.Write("</select>");
									}
									if (_field.type == "foreign_elem" || _field.type == "file")
									{
										if (_field.type == "file")
											_field.catalog = "resource";
										catFieldValue = undefined;
										if (_elem.value.HasValue)
										try
										{
											catFieldValue = ArrayOptFirstElem(XQuery("for $elem in " + _field.catalog + "s where $elem/id = " + Int(_elem.value) + " return $elem"));
										}
										catch(_X_)
										{
										}
										if (catFieldValue != undefined)
										{
											sDispName = curLngCommon.exchange_object_types.GetChildByKey(catFieldValue.Name).disp_name;
											sDispValue = HtmlEncode(catFieldValue.EvalPath(sDispName));
										}
										else
										{
											sDispName = ""; sDispValue = "";
										}
%>
										<table width="100%">
										<tr>
										<td>
										<input type="text" id="<%=_ce_id%>_disp"  class="wtInfoTableInput" value="<%=sDispValue%>" readonly="readonly"/>
										<input type="hidden" name="<%=_ce_id%>" id="<%=_ce_id%>" value="<%=_elem.value%>"/>
										</td>
										<td width="25">
										<input type="button" value="..." class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';" onclick="
											var pars_pos=new Object();
											pars_pos.check_access = 1;
											var strAttr='status:no;dialogWidth:780px;dialogHeight:550px;help:no;resizable:1';
											xShowModalDialog('dlg_select.html?doc_id=<%=curDocID%>&catalog_name=<%=_field.catalog%>&typein=1&multi_select=0&rand='+Math.random(), pars_pos, strAttr);

											if ( ! pars_pos.handle ) return false;

											document.getElementById('<%=_ce_id%>').value = pars_pos.element_id;
											document.getElementById('<%=_ce_id%>_disp').value = pars_pos.element_name;
										" style="width: 25px"/>
										</td>
										</tr>
										</table>
<%
									}
								}
								else
								{
									if (_field.type == "bool")
									{
										Response.Write("<input type='checkbox' id='" + _ce_id + "' name='" + _ce_id  + "' " + (_elem.value == "true" ? "checked" : "") + " disabled/>");
									}
									else if (_field.type == "foreign_elem" || _field.type == "file")
									{
										catFieldValue = undefined;
										if (_field.type == "file")
											_field.catalog = "resource";
										if (_elem.value.HasValue)
										try
										{
											catFieldValue = ArrayOptFirstElem(XQuery("for $elem in " + _field.catalog + "s where $elem/id = " + Int(_elem.value) + " return $elem"));
										}
										catch(_X_)
										{
										}
										if (catFieldValue != undefined)
										{
											sDispName = curLngCommon.exchange_object_types.GetChildByKey(catFieldValue.Name).disp_name;
											sDispValue = HtmlEncode(catFieldValue.EvalPath(sDispName));
										}
										else
										{
											sDispName = ""; sDispValue = "";
										}
										if (_field.type == "file")
											sDispValue = '<a href="view_doc.html?mode=resource&object_id='+catFieldValue.PrimaryKey+'&doc_id='+curDocID+'">'+sDispValue+'</a>';
										Response.Write(sDispValue);
									}
									else
										Response.Write(_elem.value);
								}
							%>
						</td>
					</tr>
					<%
						}
					%>
<%
}
%>
				</table>
			</td>
		</tr>
	</table>
<%
	if (IS_MODIFY && (editList == undefined || ArrayOptFirstElem(editList) != undefined))
	{
%>
<BR/>
<center><input type="submit" value="<%=tools.get_web_str("c_save")%>" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';" onclick="if (!confirm(<%=CodeLiteral( tools.get_web_str("vcb_mess_confirm") )%>)) return false; return what2submit();"/></center>
<%
	}
%>
</form>

<FORM ACTION="operation_process.html" NAME="action_process" METHOD="POST">
<input type="hidden" name="selected_object_ids" id="selected_object_ids" value="<%=curObjectID%>"/>
<input type="hidden" name="element_ids" id="element_ids"/>
<input type="hidden" name="element_value" id="element_value"/>
<input type="hidden" name="href" value="<%=(UrlPath(Request.Url) +"?"+ UrlParam(Request.Url))%>"/>
<input type="hidden" name="action_id" id="action_id" value=""/>
<input type="hidden" name="sid" value="<%=tools.get_sum_sid( curDocID )%>">
<input type="hidden" name="mode" value="<%=curMode%>"/>

<script language="javascript">
<%
	for (_a in _selectedActions)
	{
%>
function f_<%=_a.id%>()
{
		var ELEMENT_IDS = "";
		var ELEMENT_VALUE = "";
	<%=EvalCodePage(tools_web.get_operation_script(_a.id, true))%>
	document.getElementById("element_ids").value = ELEMENT_IDS;
	document.getElementById("element_value").value = ELEMENT_VALUE;
	return true;
}
<%
	}
%>
function prepare_data(_a_id)
{
	//if ( filling_selected_object_ids() == 0 ) return false;

	document.getElementById("action_id").value = _a_id;

	return true;
}

function filling_selected_object_ids() {return true;}
</script>
<%
		try
		{
			_god_message = Session.r_msg;
		}
		catch(_god_message_err_)
		{
			_god_message = undefined;
		}

		Session.r_msg = undefined;

		if (_god_message != undefined)
		{
%>
		<center style="font-weight: bold"><%=_god_message%></center><br/>
<%
		}
%>
<center>
<%
		for (_action in _selectedActions)
		{
%>
		<input type="submit" id="_a_<%=_action.id%>" onclick="if (prepare_data('<%=_action.id%>')) return f_<%=_action.id%>(); else return false;" value="<%=_action.name%>" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';"/>
<%
		}
%>
</center>

</FORM>
</div>
<%
	}

	if ( ArrayOptFind(_tabTypes, "id == 'learning' && show == true") != undefined )
	{
%>

<div width="100%" id="div_learning" style="display: none">
<%
	curView = new Object;
	curView.SetProperty("id", "active_learning_list");
	curView.SetProperty("catalog_name", "active_learning");
	curView.SetProperty("xquery_qual", "$elem/person_id = " + curObjectID );
	curView.SetProperty("disp_link", "true");
	curView.SetProperty("disp_check_box", "false");
	curView.SetProperty("link_mode", "learning_stat");
	curView.SetProperty("link_prop", "='&course_id='+ListElem.course_id+'&sid='+tools.get_sum_sid(ListElem.id)");
	curView.SetProperty("list_columns",Array("course_id.ForeignElem.name", "start_usage_date", "last_usage_date", "score", "state_id"));
	curView.SetProperty("link_field_index",3);
	curView.SetProperty("query_prop_form_dom_element","tab_id");
	Server.Execute( "view_catalog_list.html" );
	Response.Write("<hr/>");
	curView = new Object;
	curView.SetProperty("id", "learning_list");
	curView.SetProperty("catalog_name", "learning");
	curView.SetProperty("xquery_qual", "$elem/person_id = " + curObjectID );
	curView.SetProperty("disp_link", "true");
	curView.SetProperty("disp_check_box", "false");
	curView.SetProperty("link_mode", "learning_stat");
	curView.SetProperty("link_prop", "='&course_id='+ListElem.course_id+'&sid='+tools.get_sum_sid(ListElem.id)");
	curView.SetProperty("list_columns",Array("course_id.ForeignElem.name", "start_usage_date", "last_usage_date", "score", "state_id"));
	curView.SetProperty("link_field_index",3);
	curView.SetProperty("query_prop_form_dom_element","tab_id");
	Server.Execute( "view_catalog_list.html" );
%>
</div>
<%
	}

	if ( ArrayOptFind(_tabTypes, "id == 'test_learning' && show == true") != undefined )
	{
%>
<div width="100%" id="div_test_learning" style="display: none">
<%
	curView = new Object;
	curView.SetProperty("id", "active_test_learning_list");
	curView.SetProperty("catalog_name", "active_test_learning");
	curView.SetProperty("xquery_qual", "$elem/person_id = " + curObjectID );
	curView.SetProperty("disp_link", "true");
	curView.SetProperty("link_mode", "test_learning_stat");
	curView.SetProperty("link_prop", "='&assessment_id='+ListElem.assessment_id+'&sid='+tools.get_sum_sid(ListElem.id)");
	curView.SetProperty("list_columns",Array("assessment_name", "start_usage_date", "last_usage_date", "score","state_id"));
	curView.SetProperty( "col_headers", Array("-"));
	curView.SetProperty( "col_cells", Array("'<a href=\"view_test_report.html?doc_id="+curDocID+"&object_id='+ListElem.id+'\">&raquo;&raquo;</a>'"));
	curView.SetProperty("link_field_index",3);
	curView.SetProperty("query_prop_form_dom_element","tab_id");
	Server.Execute( "view_catalog_list.html" );
	Response.Write("<hr/>");
	curView = new Object;
	curView.SetProperty("id", "test_learning_list");
	curView.SetProperty("catalog_name", "test_learning");
	curView.SetProperty("xquery_qual", "$elem/person_id = " + curObjectID );
	curView.SetProperty("disp_link", "true");
	curView.SetProperty("link_mode", "test_learning_stat");
	curView.SetProperty("link_prop", "='&assessment_id='+ListElem.assessment_id+'&sid='+tools.get_sum_sid(ListElem.id)");
	curView.SetProperty("list_columns",Array("assessment_name", "person_current_state", "start_usage_date", "last_usage_date", "score","state_id"));
	curView.SetProperty("link_field_index",3);
	curView.SetProperty( "col_headers", Array("-"));
	curView.SetProperty( "col_cells", Array("'<a href=\"view_test_report.html?doc_id="+curDocID+"&object_id='+ListElem.id+'\">&raquo;&raquo;</a>'"));
	curView.SetProperty("query_prop_form_dom_element","tab_id");
	Server.Execute( "view_catalog_list.html" );
	Response.Write("<hr/>");

%>
</div>
<%
	}

	if ( ArrayOptFind(_tabTypes, "id == 'event' && show == true") != undefined )
	{
%>
<div width="100%" id="div_event" style="display: none">
<%
	curView = new Object;
	curView.SetProperty("id", "event_result_list");
	curView.SetProperty("catalog_name", "event_result");
	curView.SetProperty("xquery_qual", "$elem/person_id = " + curObjectID );
	curView.SetProperty("disp_link", "true");
	curView.SetProperty("disp_check_box", "false");
	curView.SetProperty("link_mode", "event");
	curView.SetProperty("link_field_index",3);
	curView.SetProperty("link_object_field", "event_id");
	curView.SetProperty("list_columns",Array("event_name","event_start_date","event_result_type_id","score"));
	curView.SetProperty( "col_headers", Array(tools_web.get_web_str('c_cost'),tools_web.get_web_str('vcb_exist'),tools.get_web_str('c_status')));
	curView.SetProperty( "col_cells", Array("ListElem.expense_sum","'<center>'+ (ListElem.is_assist ? '+':'-') + '</center>'","sometempvar=ListElem.event_id.OptForeignElem,(sometempvar != undefined ? sometempvar.status_id.ForeignElem.name : '')") );
	curView.SetProperty("query_prop_form_dom_element","tab_id");
	Server.Execute( "view_catalog_list.html" );
%>
</div>
<%
	}

	if ( ArrayOptFind(_tabTypes, "id == 'education_plan' && show == true") != undefined )
	{
%>
<div width="100%" id="div_education_plan" style="display: none">
<%
	curView = new Object;
	curView.SetProperty("id", "education_plan_list");
	curView.SetProperty("catalog_name", "education_plan");
	curView.SetProperty("xquery_qual", "$elem/person_id = " + curObjectID );
	curView.SetProperty("disp_link", "true");
	curView.SetProperty("disp_check_box", "false");
	curView.SetProperty("query_prop_form_dom_element","tab_id");
	curView.SetProperty("list_columns",Array("compound_program_id","group_id","state_id","create_date"));
	curView.SetProperty( "col_headers", Array(tools_web.get_web_str('c_name')));
	curView.SetProperty( "col_cells", Array("ListElem.name") );
	curView.SetProperty("link_field_index",4);
	Server.Execute( "view_catalog_list.html" );
%>
</div>
<%
	}

	if ( ArrayOptFind(_tabTypes, "id == 'assessment_appraise' && show == true") != undefined )
	{
%>
<div width="100%" id="div_assessment_appraise" style="display: none">
<table width="100%">
<tr valign="top">
<td width="300px">
<div style=" overflow: auto;" >
	<script src="scripts\tree\ua000000.js"></script>
	<script src="scripts\tree\ftiens40.js"></script>
	<span class="TreeviewSpanArea" style="overflow:auto; width:300px">
	<script language="javascript">
	<!--
		USETEXTLINKS = 1;
		STARTALLOPEN = 0;
		USEFRAMES = 0;
		USEICONS = 0;
		WRAPTEXT = 1;
		PRESERVESTATE = 1;
		ICONPATH = "scripts/tree/";
		var foldersTree = gFld('<b><%=tools_web.get_web_str("vcb_proc")%></b>');
<%
		_aOfCatAssAppraises = Array();
		_aOfStringAssStatuses = Array();
		_xarrPAs = ArrayUnion( XQuery("for $pa in pas where $pa/person_id = " + curObjectID + " and $pa/assessment_appraise_type != null() and $pa/assessment_appraise_id != null() return $pa"), XQuery("for $pa in development_plans where $pa/person_id = " + curObjectID + " and $pa/assessment_appraise_id != null() order by $pa/assessment_appraise_id return $pa"));
		for (_catPA in _xarrPAs)
		{
			_catAssAppraise = ArrayOptFind(_aOfCatAssAppraises, "This.id == " + _catPA.assessment_appraise_id);
			if (_catAssAppraise == undefined)
			{
				_catAssAppraise = _catPA.assessment_appraise_id.OptForeignElem;
				if (_catAssAppraise == undefined) continue;
				_aOfCatAssAppraises[ArrayCount(_aOfCatAssAppraises)] = _catAssAppraise;
				
				if (_catAssAppraise.external_display_options.Value == "hide"|| _catAssAppraise.external_display_options.Value == "hide_mine" && curObjectID == curUserID)
					continue;
				
				Response.Write("var A"+_catPA.assessment_appraise_id+" = insFld(foldersTree, gFld(\""+HtmlEncode(_catAssAppraise != undefined ? _catAssAppraise.name : "???")+"\"));\n");
			}
			else
			{
				if (_catAssAppraise.external_display_options.Value == "hide"|| _catAssAppraise.external_display_options.Value == "hide_mine" && curObjectID == curUserID)
					continue;
			}
			if (ArrayOptFind(_aOfStringAssStatuses, "This == " + CodeLiteral(_catPA.assessment_appraise_id+_catPA.status)) == undefined)
			{
				Response.Write("var ST"+_catPA.assessment_appraise_id+_catPA.status+" = insFld(A"+_catPA.assessment_appraise_id+", gFld(\""+_catPA.status.ForeignElem.name+"\"));\n");
				_aOfStringAssStatuses[ArrayCount(_aOfStringAssStatuses)] = _catPA.assessment_appraise_id+_catPA.status;
			}
			Response.Write("insDoc(ST"+_catPA.assessment_appraise_id+_catPA.status+", gLnk('S', \""+HtmlEncode(_catPA.assessment_appraise_type.ForeignElem.name)+"\", \"javascript:swap_pa_info(\\\\'"+_catPA.id+"\\\\')\"));  \n");
		}
%>
		initializeDocument();
	-->
	</script>
	</span>
	<script language="javascript">
	<!--
	function swap_pa_info(_pa_id_)
	{
		var destination = document.getElementById("pa_internal");
		$.ajax({
			type: "GET",
			url: "pa_html_data.xml",
			data: "pa_id=" + _pa_id_ + "&r=" + Math.random() * 1000000,
			dataType: "xml",
			error: function (response){window.alert("ERROR "+response.status+": \n" + response.statusText);},
			success: function(response){$("div#pa_internal").html($(response).find("data").text());}
		});
	}
	-->
	</script>
<%
	_arrProfiles = tools.get_user_comp_profiles(curObjectID);
	if (ArrayOptFirstElem(_arrProfiles)!= undefined)
	{
%>
	<p>
		<b><%=tools.get_web_str('vcb_competence_profiles')%></b>
<%
		for (_catProfileElem in _arrProfiles)
		{
%>
			<br/>&nbsp;<a href="view_doc.html?mode=competence_profile&object_id=<%=_catProfileElem.PrimaryKey%>&doc_id=<%=curDocID%>"><%=_catProfileElem.name%></a>
<%
		}
%>
	</p>
<%
	}
%>
</div>
</td>
<td>
<div id="pa_internal" style="height: 100%; weight: 100%">
	&nbsp;
</div>
</td>
</table>
</div>
<%
	}

	if ( ArrayOptFind(_tabTypes, "id == 'desc' && show == true") != undefined )
	{
%>
<div width="100%" id="div_desc" style="display: none">
<TABLE width="100%" border="0" cellspacing="1" cellpadding="3">
	<TR>
		<TD>
<%
		if (IS_MODIFY && _editDesc)
		{
			Server.Execute( "view_tinymce.html" );
%>
			<textarea trigger id="collaborator_desc" name="collaborator_desc" style="width:600px;height:200px"><%=tools_web.get_web_desc( curObject.desc, UrlFromDocID( curObjectID ), "collaborator.desc" )%></textarea>
			<center><input type="submit" value="<%=tools.get_web_str("c_save")%>" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';" onclick='$.post("document_save.html", { data_0_id: "<%=curObjectID%>", data_0_source_fields: "desc", data_0_destination_fields: "[encoded]"+escape(tinyMCE.get("collaborator_desc").getContent()), doc_id: "<%=curDocID%>", ajax: 1 },function(data){if (parseInt(data) > 0) window.alert("<%=tools_web.get_web_str("c_form_save")%>"); else window.alert("<%=tools_web.get_web_str("vab_acquaint_error_1")%>");});'/></center>
<%
		}
		else
		{
%>
			<%=tools_web.get_web_desc( curObject.desc, UrlFromDocID( curObjectID ), "collaborator.desc" )%>
<%
		}
%>
		</TD>
	</TR>
</TABLE>
</div>
<%
	}
	if (ArrayOptFind(_tabTypes, "id == 'knowledge_part' && show == true") != undefined )
	{
%>
<div width="100%" id="div_knowledge_part" style="display: none">
<%
	SHOW_IMMEDIATELY = true;
	Server.Execute("view_knowledge_parts_base.html");
%>
</div>
<%
	}
	if ( ArrayOptFind(_tabTypes, "id == 'summary' && show == true") != undefined )
	{
		try
		{
			dSummaryStartDate = Date(Request.QueryString.summary_start_date);
			dSummaryEndDate = Date(Request.QueryString.summary_end_date);
		}
		catch(_x_)
		{
			dSummaryStartDate = null;
			dSummaryEndDate = null;
			dMonthAgo = DateNewTime(DateOffset(Date(), 0 - 86400 * 30));
			dYearAgo = DateNewTime(DateOffset(Date(), 0 - 86400 * 365));
		}
%>
<div width="100%" id="div_summary" style="display: none">
	<h3><%=tools_web.get_web_str('vcb_summary_edu_info')%></h3>
	<table>
		<tr>
			<td><input type="text" id="summary_start_date" style="width: 80px" class="inputEdit" value="<%=(dSummaryStartDate != null ? dSummaryStartDate : "")%>" readonly/></td>
			<td><a href="#" id="link_summary_start_date" onclick="CreateCalendar(this.getAttribute('id'), 'summary_start_date', 'dd.mm.yyyy'); return false;"><img src="/scripts/calendar/calendar.gif" border="0"/></a></td>
			<td><img src="pics/1blank.gif" width="20px" height="0"/></td>
			<td><input type="text" id="summary_end_date" style="width: 80px" class="inputEdit" value="<%=(dSummaryEndDate != null ? dSummaryEndDate : "")%>" readonly/></td>
			<td><a href="#" id="link_summary_end_date" onclick="CreateCalendar(this.getAttribute('id'), 'summary_end_date', 'dd.mm.yyyy'); return false;"><img src="/scripts/calendar/calendar.gif" border="0"/></a></td>
			<td><img src="pics/1blank.gif" width="20px" height="0"/></td>
			<td><input type="button" value="<%=tools_web.get_web_str('c_refresh')%>" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';" onclick="window.location.href='<%=tools_web.get_query_string( true, "summary_start_date;summary_end_date;tab_id")%>summary_start_date=' + $('input#summary_start_date').val() + '&summary_end_date=' + $('input#summary_end_date').val() + '&tab_id=' + $('input#tab_id').val();"/></td>
			<td><input type="button" value="<%=tools_web.get_web_str('c_default')%>" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';" onclick="window.location.href='<%=tools_web.get_query_string( true, "summary_start_date;summary_end_date;tab_id")%>tab_id=' + $('input#tab_id').val();"/></td>
		</tr>
	</table>
	<table width="100%" cellpadding="0" cellspacing="0" bgcolor="gray"><tr><td>
	<table cellspacing="1" width="100%">
		<tr bgcolor="white">
			<th>&nbsp;</th>
<%
			if (dSummaryStartDate == null)
			{
%>
			<th width="100px"><%=tools_web.get_web_str('vcb_last_month')%></th>
			<th width="100px"><%=tools_web.get_web_str('vcb_last_year')%></th>
<%
			}
%>
			<th width="100px"><%=tools_web.get_web_str('c_total')%></th>
		</tr>
<%
			if (dSummaryStartDate == null)
			{
				aCurrentSelection = ArraySelectAll(XQuery("for $elem in learnings where $elem/person_id = " + curObjectID + " return $elem"));
				aMonthSelection = ArraySelect(aCurrentSelection, "last_usage_date >= Date('" + dMonthAgo + "')");
				aYearSelection = ArraySelect(aCurrentSelection, "last_usage_date >= Date('" + dYearAgo + "')");
			}
			else
			{
				aCurrentSelection = ArraySelectAll(XQuery("for $elem in learnings where $elem/person_id = " + curObjectID + " and $elem/last_usage_date >= " +XQueryLiteral(dSummaryStartDate)+ " and $elem/last_usage_date <= " +XQueryLiteral(dSummaryEndDate)+ " return $elem"));
			}
%>
		<tr bgcolor="white">
			<td><%=tools_web.get_web_str('vcb_courses_edu')%></td>
<%
			if (dSummaryStartDate == null)
			{
%>
			<td align="center"><%=ArrayCount(aMonthSelection)%></td>
			<td align="center"><%=ArrayCount(aYearSelection)%></td>
<%
			}
%>
			<td align="center"><%=ArrayCount(aCurrentSelection)%></td>
		</tr>
<%
		aCurrentSelection = ArraySelect(aCurrentSelection, "try{ return course_id.ForeignElem.max_score > 0} catch(_X_){return false;} ");
		if (dSummaryStartDate == null)
		{
			aMonthSelection = ArraySelect(aCurrentSelection, "last_usage_date >= Date('" + dMonthAgo + "')");
			aYearSelection = ArraySelect(aCurrentSelection, "last_usage_date >= Date('" + dYearAgo + "')");
		}
%>
		<tr bgcolor="white">
			<td><%=tools_web.get_web_str('vcb_avr_score')%></td>
<%
			if (dSummaryStartDate == null)
			{
%>
			<td align="center"><%=(ArrayCount(aMonthSelection) > 0 ? StrReal(Real(ArraySum(aMonthSelection, "score * 100.0 / course_id.ForeignElem.max_score")) / Real(ArrayCount(aMonthSelection)), 2)+ "%": "-")%></td>
			<td align="center"><%=(ArrayCount(aYearSelection) > 0 ? StrReal(Real(ArraySum(aYearSelection, "score * 100.0 / course_id.ForeignElem.max_score")) / Real(ArrayCount(aYearSelection)), 2)+ "%": "-")%></td>
<%
			}
%>
			<td align="center"><%=(ArrayCount(aCurrentSelection) > 0 ? StrReal(Real(ArraySum(aCurrentSelection, "score * 100.0 / course_id.ForeignElem.max_score")) / Real(ArrayCount(aCurrentSelection)), 2)+ "%": "-")%></td>
		</tr>
<%
			if (dSummaryStartDate == null)
			{
				aCurrentSelection = ArraySelectAll(XQuery("for $elem in event_results where $elem/person_id = " + curObjectID + " return $elem"));
				aMonthSelection = ArraySelect(aCurrentSelection, "event_start_date >= Date('" + dMonthAgo + "')");
				aYearSelection = ArraySelect(aCurrentSelection, "event_start_date >= Date('" + dYearAgo + "')");
			}
			else
			{
				aCurrentSelection = ArraySelectAll(XQuery("for $elem in event_results where $elem/person_id = " + curObjectID + " and $elem/event_start_date >= " +XQueryLiteral(dSummaryStartDate)+ " and $elem/event_start_date <= " +XQueryLiteral(dSummaryEndDate)+ " return $elem"));
			}
%>
		<tr bgcolor="white">
			<td><%=tools_web.get_web_str('vcb_tran_finish')%></td>
<%
			if (dSummaryStartDate == null)
			{
%>
			<td align="center"><%=ArrayCount(aMonthSelection)%></td>
			<td align="center"><%=ArrayCount(aYearSelection)%></td>
<%
			}
%>
			<td align="center"><%=ArrayCount(aCurrentSelection)%></td>
		</tr>
		<tr bgcolor="white">
			<td><%=tools_web.get_web_str('vcb_tran_percent')%></td>
<%
			if (dSummaryStartDate == null)
			{
%>
			<td align="center"><%=(ArrayCount(aMonthSelection) > 0 ? StrReal(ArrayCount(ArraySelect(aMonthSelection, "is_assist"))*100.0 / ArrayCount(aMonthSelection),2) : "-" )%></td>
			<td align="center"><%=(ArrayCount(aYearSelection) > 0 ? StrReal(ArrayCount(ArraySelect(aYearSelection, "is_assist"))*100.0 / ArrayCount(aYearSelection),2) : "-" )%></td>
<%
			}
%>
			<td align="center"><%=(ArrayCount(aCurrentSelection) > 0 ? StrReal(ArrayCount(ArraySelect(aCurrentSelection, "is_assist"))*100.0 / ArrayCount(aCurrentSelection),2) : "-" )%></td>
		</tr>
		<tr bgcolor="white">
			<td><%=tools_web.get_web_str('vcb_fin_spend')%></td>
<%
			if (dSummaryStartDate == null)
			{
%>
			<td align="center"><%=ArraySum(aMonthSelection, "expense_sum")%></td>
			<td align="center"><%=ArraySum(aYearSelection, "expense_sum")%></td>
<%
			}
%>
			<td align="center"><%=ArraySum(aCurrentSelection, "expense_sum")%></td>
		</tr>
<%
			if (dSummaryStartDate == null)
			{
				aCurrentSelection = ArraySelectAll(XQuery("for $elem in test_learnings where $elem/person_id = " + curObjectID + " return $elem"));
				aMonthSelection = ArraySelect(aCurrentSelection, "last_usage_date >= Date('" + dMonthAgo + "')");
				aYearSelection = ArraySelect(aCurrentSelection, "last_usage_date >= Date('" + dYearAgo + "')");
			}
			else
			{
				aCurrentSelection = ArraySelectAll(XQuery("for $elem in test_learnings where $elem/person_id = " + curObjectID + " and $elem/last_usage_date >= " +XQueryLiteral(dSummaryStartDate)+ " and $elem/last_usage_date <= " +XQueryLiteral(dSummaryEndDate)+ " return $elem"));
			}
%>
		<tr bgcolor="white">
			<td><%=tools_web.get_web_str('vcb_test_finish')%></td>
<%
			if (dSummaryStartDate == null)
			{
%>
			<td align="center"><%=ArrayCount(aMonthSelection)%></td>
			<td align="center"><%=ArrayCount(aYearSelection)%></td>
<%
			}
%>
			<td align="center"><%=ArrayCount(aCurrentSelection)%></td>
		</tr>
<%
			aCurrentSelection = ArraySelect(aCurrentSelection, "max_score > 0");
			if (dSummaryStartDate == null)
			{
				aMonthSelection = ArraySelect(aMonthSelection, "max_score > 0");
				aYearSelection = ArraySelect(aYearSelection, "max_score > 0");
			}
%>
		<tr bgcolor="white">
			<td><%=tools_web.get_web_str('vcb_avr_test')%></td>
<%
			if (dSummaryStartDate == null)
			{
%>
			<td align="center"><%=(ArrayCount(aMonthSelection) > 0 ? StrReal(Real(ArraySum(aMonthSelection, "score * 100.0 / max_score")) / Real(ArrayCount(aMonthSelection)), 2) + "%" : "-")%></td>
			<td align="center"><%=(ArrayCount(aYearSelection) > 0 ? StrReal(Real(ArraySum(aYearSelection, "score * 100.0 / max_score")) / Real(ArrayCount(aYearSelection)), 2) + "%": "-")%></td>
<%
			}
%>
			<td align="center"><%=(ArrayCount(aCurrentSelection) > 0 ? StrReal(Real(ArraySum(aCurrentSelection, "score * 100.0 / max_score")) / Real(ArrayCount(aCurrentSelection)), 2)+ "%" : "-")%></td>
		</tr>
	</table>
	</td></tr></table>
<%
	if (global_settings.disp_ass)
	{
%>
	<h3><%=tools_web.get_web_str('vcb_summary_ass')%></h3>
<%
	xarrPAs = XQuery("for $pa in pas where $pa/person_id = " + curObjectID + " and $pa/assessment_appraise_type = 'competence_appraisal' and $pa/is_final = true() return $pa");
	aOfIntAssessmentIDs = ArrayExtract(ArraySelectDistinct(xarrPAs, "assessment_appraise_id"), "assessment_appraise_id");
	aOfCatAssAppraises = ArraySort(QueryCatalogByKeys("assessment_appraises", "id", aOfIntAssessmentIDs), "start_date", "+");
	aCompetenceArr = Array();
	for (_catPAElem in xarrPAs)
	{
		_tePA = OpenDoc(UrlFromDocID(_catPAElem.PrimaryKey)).TopElem;
		for (_fldCompetenceElem in _tePA.competences)
		{
			_oCurComp = ArrayOptFind(aCompetenceArr, "id == " + _fldCompetenceElem.PrimaryKey);
			if (_oCurComp == undefined)
			{
				try
				{
					_teComp = OpenDoc(UrlFromDocID(_fldCompetenceElem.PrimaryKey)).TopElem;
				}
				catch(_x_)
				{
					continue;
				}

				_oCurComp = new Object;
				_oCurComp.id = _fldCompetenceElem.PrimaryKey;
				_oCurComp.name = _teComp.name;
				_oCurComp.scales = _teComp.scales;
				_oCurComp.ass_pack = Array();
				aCompetenceArr[ArrayCount(aCompetenceArr)] = _oCurComp;
			}
			_oAssElem = ArrayOptFind(_oCurComp.ass_pack, "id == " + _catPAElem.assessment_appraise_id);
			if (_oAssElem == undefined)
			{
				_oAssElem = new Object;
				_oAssElem.id = _catPAElem.assessment_appraise_id;
				_oCurComp.ass_pack[ArrayCount(_oCurComp.ass_pack)]=_oAssElem;
				_oAssElem.mark = "";
				_oAssElem.value = null;
			}

			if (_fldCompetenceElem.mark == "" || _fldCompetenceElem.mark == "N")
			{
				_oAssElem.mark = _fldCompetenceElem.mark;
				_oAssElem.value = null;
			}
			else
			{
				_fldScale = _oCurComp.scales.GetOptChildByKey(_fldCompetenceElem.mark);
				if (_fldScale != undefined)
				{
					_oAssElem.mark = _fldScale.name;
					_oAssElem.value = (_fldScale.percent.HasValue ? _fldScale.percent : _fldScale.ChildIndex);
				}
				else
					try
					{
						_oAssElem.value = Real(_fldCompetenceElem.mark);
						_oAssElem.mark = StrReal(_oAssElem.value, 2);
					}
					catch(_o_){};
			}


		}

	}
%>
	<table width="100%" cellpadding="0" cellspacing="0" bgcolor="gray"><tr><td>
	<table cellspacing="1" width="100%">
		<tr bgcolor="white">
		<th>&nbsp;</th>
<%
	for (catAssAppraiseElem in aOfCatAssAppraises)
	{
%>
		<td><%=catAssAppraiseElem.name%></td>
<%
	}
%>
		</tr>
<%
	for (_oCurCompElem in aCompetenceArr)
	{
%>
		<tr bgcolor="white">
			<td><%=_oCurCompElem.name%></td>
<%
			for (catAssAppraiseElem in aOfCatAssAppraises)
			{
				_oAssElem = ArrayOptFind(_oCurCompElem.ass_pack, "id == " + catAssAppraiseElem.id);
%>
			<td align="center"><%=(_oAssElem != undefined ? _oAssElem.mark : "-")%></td>
<%
			}
%>
		</tr>
<%
	}
%>
	</table>
	</td></tr></table>
<%
	}
%>
</div>
<%
	}
	if (ArrayOptFind(_tabTypes, "id == 'change_log' && show == true") != undefined )
	{
%>
<div width="100%" id="div_change_log" style="display: none">
	<table width="100%" cellpadding="0" cellspacing="0" bgcolor="gray"><tr><td>
	<table cellspacing="1" cellpadding="5" width="100%">
		<tr bgcolor="white">
			<th><%=tools.get_web_str('c_date')%></th><th><%=tools_web.get_web_str('uf_main_position')%></th><th><%=tools.get_web_str('c_subd')%></th><th><%=tools.get_web_str('c_org')%></th>
		</tr>
<%
	for (fldLogElem in curObject.change_logs)
	{
%>
		<tr bgcolor="white">
			<td><%=fldLogElem.date%></td><td><%=fldLogElem.position_name%></td><td><%=fldLogElem.position_parent_name%></td><td><%=fldLogElem.org_name%></td>
		</tr>
<%
	}
%>
	</table>
	</td></tr></table>
</div>
<%
	}
	if ( ArrayOptFind(_tabTypes, "id == 'collabor_files' && show == true") != undefined )
	{
%>

<div width="100%" id="div_collabor_files" style="display: none">
<%
	Server.Execute( "view_files.html" );
%>
</div>
<%
	}
%>
<input type="hidden" value="" id="tab_id"/>
<script language="javascript">
<!--
	toggle_section("<%=_selectedTab%>");
-->
</script>