
<script language="javascript">
<!--

function checkkey(srcobj, keycode)
{
	if ((keycode<48 || keycode>57)& keycode!=46) return false;
	//if (keycode==46) if(srcobj.value.indexOf('.') >= 0) return false;
	return true;
}


function showHierarchy(inp_id,inp_name, inp_object_name, inp_parameter)
{
	var pars=new Object();
	pars.user_name=inp_name;
	pars.user_id=inp_id;
	pars.object_name = inp_object_name;
	var strAttr="status:no;dialogWidth:650px;dialogHeight:550px;help:no";

	showModalDialog('dlg_select.html?catalog_name=' + inp_object_name + '&doc_id=<%=curDocID%>&typein=1&rand='+ Math.random(), pars, strAttr);

	if (!pars.handle) return null;

	var ret_arr = Array();
	ret_arr[0] = pars.element_id;
	ret_arr[1] = pars.element_name;
	return ret_arr;
}

function paintStuff(_wtf)
{
	var _strAttr = "toolbar=yes,location=yes,directories=no,status=yes, menubar=no,scrollbars=yes, resizable=yes";
	if (_wtf == "g")
		window.open("dlg_custom_report_graph.html?custom_report_id=<%=curObjectID%>&r=" + Math.random(), null, _strAttr);
	else if (_wtf == "p")
		window.open("dlg_custom_report_pivot.html?custom_report_id=<%=curObjectID%>&r=" + Math.random(), null, _strAttr);
}


-->
</script>
<script src="scripts/calendar/calendar.js"></script>

<BR>
<table width="100%"  border="0" cellspacing="0" cellpadding="3" name="top_report_table">
<tr>
<td>

<%
	try
	{
		_href_suffix = String(_href_suffix);
	}
	catch(_opa_)
	{
		_href_suffix = "";
	}

	if (Request.Query.HasProperty("tabpage"))
		switch(Request.Query.GetProperty("tabpage"))
		{
			case "graph": _currentPage = "graph"; break;
			case "pivot": _currentPage = "pivot"; break;
			default: _currentPage = "default";
		}
	else
		_currentPage = "default";


%>
<FORM ACTION="custom_report_regenerate.html" NAME="regenerator001" METHOD="POST">

<input type="hidden" name="regenerate" value="1"/>
<input type="hidden" name="object_id" value="<%=curObjectID%>"/>
<input type="hidden" name="doc_id" value="<%=curDocID%>"/>
<input type="hidden" name="mode" value="<%=curMode%>"/>
<input type="hidden" name="href_suffix" value="<%=_href_suffix%>"/>
<input type="hidden" name="tabpage" value="<%=_currentPage%>"/>

<%
	_flag_ready_to_show = true;
	_flag_hierarchy = false;
	if (ArrayCount(  ArraySelect(curObject.criterions , 'flag_is_parameter == true && flag_value_filter == false && flag_active == true') ) > 0)
	{
%>

<TABLE width="100%" cellspacing="0" cellpadding="4" CLASS="tableBorder">
	<TR>
		<TD colspan="4" STYLE="font-weight:bolder; font-size:larger"><%=tools_web.get_web_str("vcrb_parameters")%><br/></TD>
	</TR>
<%
	N = 0;
	tools.fill_field_names(curObject.field_names, curObject.object_name);
	for (_criterion in curObject.criterions)
	{
		if (_criterion.flag_is_parameter && (!_criterion.flag_value_filter) && _criterion.flag_active == true)
		{

			_ac = ArrayCount(_criterion.catalog_chains);
			if (_ac > 0)
			{
				_chain = _criterion.catalog_chains.Child(_ac - 1);
				_catalog_name = _chain.catalog_name;

				if (!_chain.field.HasValue && _ac > 1)
				{
					_chain = _criterion.catalog_chains.Child(_ac - 2);
				}

				tools.fill_field_names(_criterion.field_names, _chain.catalog_name);
				_field = _criterion.field_names.GetChildByKey( _chain.field );
			}
			else
			{
				_field = null;
				continue;
			}

			if (_criterion.flag_hierarchy == 2 && _catalog_name == 'subdivision' || _criterion.flag_hierarchy > 0 && _catalog_name == 'collaborator')
			{
				_flag_hierarchy = true;
				continue;
			}

			if (_field.title.HasValue) _field_name = _field.title; else _field_name = _field.name;

%>
	<TR>
		<TD WIDTH="10"><li/></TD>
		<TD WIDTH="200" STYLE="font-weight:normal; font-size:larger"><%=(_criterion.column_title.HasValue ? _criterion.column_title : _field_name)%></TD>
		<TD WIDTH="80" align="center" STYLE="font-weight:bolder; font-size:inherit"><%=_criterion.option_type.ForeignElem.name%></TD>
		<TD STYLE="font-weight:normal" valign="middle">
		<input type="hidden" name="report_parameter_<%=N%>" id="report_parameter_<%=N%>" value="field_<%=_chain.field%>"/>
<%
			switch(_field.type)
			{
				case 'bool':
					Response.Write('&nbsp;<input class="inputEdit" type="radio" id="fld_id_'+N+'_'+ _chain.field +'" name="field_'+ _chain.field +'_'+N+'" value="true" ' + (_criterion.value == 'true' ? 'checked' : '') +'/> &nbsp; '+tools_web.get_web_str("c_yes")+'  &nbsp;&nbsp; <input class="inputEdit" type="radio" name="field_'+ _chain.field +'" value="false" ' + (_criterion.value == 'false' ? 'checked' : '') +'/>&nbsp;' + tools_web.get_web_str("c_yes"));
					break;

				case 'integer':
					if (_field.foreign_array.HasValue)
					{
					if (_field.foreign_catalog.HasValue)
					{
						try
						{
							curElemDoc = OpenDoc(UrlFromDocID(Int(_criterion.value))).TopElem;
							_disp_name = common.exchange_object_types.GetChildByKey(_catalog_name).disp_name;

							if (_disp_name == undefined)
									_disp_name = 'name';
							try
							{
								_nam = curElemDoc.EvalPath(_disp_name);
							}
							catch(_ogo_)
							{
								_nam = tools_web.get_web_str("vcrb_fail_name_msg");
							}


							_val = _criterion.value;
						}
						catch(_oblom_)
						{
							//alert(_oblom_);
							_nam = '';
							_val = '';
						}

						/*
						if (_flag_ready_to_show && _catalog_name == "subdivision" && _val !="" )
						{
							_curPosition = curUser.position_id.OptForeignElem;
							if (_curPosition != undefined)
								_elems_full = tools.get_sub_hierarchy(_curPosition.parent_object_id ,_catalog_name);
							else
								_elems_full = Array();

							try
							{
								ArrayFind(_elems_full , "id == Int(_val)");
							}
							catch(_oppa_)
							{
								_flag_ready_to_show = false;
							}
						}
						*/
%>

					<table border="0" cellpadding="5" cellspacing="0">
					<tr valign="middle">
					<td>
						<label style_="width: 300px" id="label_id_<%=N%>_<%=_chain.field%>"><%=_nam%></label><br/>
						<input type="hidden" id="fld_id_<%=N%>_<%=_chain.field%>" name="field_<%=_chain.field%>_<%=N%>" value="<%=_val%>" />
					</td>
					<td>
						<input type="button" value="..." class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';" onclick="var arrr = showHierarchy(document.getElementById('fld_id_<%=N%>_<%=_chain.field%>').value,'','<%=_catalog_name%>','<%=_criterion.flag_hierarchy%>'); if (arrr != null) {document.getElementById('fld_id_<%=N%>_<%=_chain.field%>').value = arrr[0]; document.getElementById('label_id_<%=N%>_<%=_chain.field%>').innerHTML = arrr[1];}" style="width: 25px"/>
					</td>
					</tr>
					</table>
<%
					}
					else
					{
%>
						<select id="fld_id_<%=N%>_<%=_chain.field%>" name="field_<%=_chain.field%>_<%=N%>" style="width: 50%">
<%
						for(_z in _field.foreign_array.Object)
						{
							Response.Write('<option'+((_z.PrimaryKey + '') == _criterion.value ? ' selected' : '')+' value="'+_z.PrimaryKey+'">'+(_z.ChildExists('name') ? _z.name : _z.PrimaryKey)+'</option>');
						}
%>
						</select>
<%
					}
					}
					else
					{
						Response.Write('&nbsp;<input class="inputEdit" type="text" id="fld_id_'+N+'_'+ _chain.field +'" name="field_'+ _chain.field +'" value="'+_criterion.value+'" style="width: 90%" onKeyPress="return checkkey(this,window.event.keyCode);"/>');
					}
					break;

				case 'date':
%>

					<table border="0" cellpadding="1" cellspacing="0">
					<tr valign="middle">
					<td>
						<input class="inputEdit" type="text" id="fld_id_<%=N%>_<%=_chain.field%>" name="field_<%=_chain.field%>_<%=N%>" value="<%=_criterion.value%>" style="width: 120px" readonly="true"/>
					</td>
					<td>
					<a href="#" onclick="var h=0; var offP = this.offsetParent; while(offP.id != 'main_block' && offP.tagName.toUpperCase()!='BODY') {h+=offP.offsetTop; offP = offP.offsetParent;} ;showCalendar(this, document.getElementById('fld_id_<%=N%>_<%=_chain.field%>'), 'dd.mm.yyyy','ru',1,null, (h + 28));"><img src="/scripts/calendar/calendar.gif" width="24" height="22" border="0"/></a>
					</td>
					</tr>
					</table>
<%

					break;
				case "combo": //IT'S CUSTOM FIELD APRIORI
					if (_criterion.is_custom_field && custom_templates.ChildExists(_chain.catalog_name))
					{
						_custom_temp_field = (custom_templates.Child(_chain.catalog_name).fields.GetOptChildByKey(_chain.field));
%>
						<select name="field_<%=_chain.field%>_<%=N%>">
<%
						for (_entry in _custom_temp_field.entries)
						{
							Response.Write('<option value="'+HtmlEncode(_entry.value)+'" ');
							if (_entry.value == _criterion.value)
								Response.Write("selected");
							Response.Write('>'+HtmlEncode(_entry.value)+'</option>');
						}
%>
						</select>
<%
					}
					else
						Response.Write('&nbsp;<input type="hidden" name="field_'+ _chain.field +'_' + N + '" value="'+_criterion.value+'"/>');
					break;
				default:

					Response.Write('&nbsp;<input class="inputEdit" type="text" name="field_'+ _chain.field +'_' + N + '" value="'+_criterion.value+'" style="width: 90%"/>');
			}
%>


		</TD>
	</TR>
<%
		N++;
		}
	}
%>
</TABLE>
<BR/>
<%
	}
%>
	<input type="submit" value="<%=tools_web.get_web_str("vcrb_build_report")%>" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';" onclick='if(!confirm("<%=HtmlEncode(tools_web.get_web_str("vcrb_refresh_report_msg"))%>")) return false; else return true;' style="width: 400px"/>
</FORM>
<%


if (_flag_ready_to_show && curObject.initiator_person_id != curUserID)
		_flag_ready_to_show = false;

if (_flag_ready_to_show)
	vReportResult = curObject.get_report_data(curObjectID, curUserID);
	
if (_flag_ready_to_show && vReportResult != null)
{
%>
	<script language="JavaScript">
	<!--
	function toggle_section(_word)
	{
		window.location.href = "<%=tools_web.get_query_string(true, "tabpage")%>tabpage=" + _word;
	}
	-->
	</script>
	<style>
	.tab_td {
		border-right: #aaaaaa 1px solid; border-top: #aaaaaa 1px solid; border-left: #aaaaaa 1px solid; border-bottom: #aaaaaa 1px solid; text-align: center; background-color: #EEEEEE;
	}
	.tab_td_sel {
		border-right: #aaaaaa 1px solid; border-top: #aaaaaa 1px solid; border-left: #aaaaaa 1px solid; border-bottom: #aaaaaa 0px solid; text-align: center; font-weight:bold; height:24px;
	}
	.tab_td_empty {
		border-bottom: #aaaaaa 1px solid;
	}
	</style>
	<table width="100%" border="0" cellspacing="0" cellpadding="0">
	<tr>
		<td class="tab_td_empty"><img src="pics/1blank.gif" width="10" height="0"/></td>
		<td class="<%=(_currentPage == "default" ? "tab_td_sel" : "tab_td")%>" onclick="toggle_section('default'); return false;"><img src="pics/1blank.gif" width="140" height="0"/><br/><a style="text-decoration:none" href="#" onclick="toggle_section('default'); return false;"><%=tools_web.get_web_str("vcrb_table")%></a></td>
		<td class="tab_td_empty" width="10px">&nbsp;</td>
<%
	if (curObject.show_chart)
	{
%>
		<td class="<%=(_currentPage == "graph" ? "tab_td_sel" : "tab_td")%>" onclick="toggle_section('graph'); return false;"><img src="pics/1blank.gif" width="140" height="0"/><br/><a style="text-decoration:none" href="#" onclick="toggle_section('graph'); return false;"><%=tools_web.get_web_str("vcrb_graph")%></a></td>
		<td class="tab_td_empty" width="10px">&nbsp;</td>
<%
	}
%>
<!--
		<td class="<%=(_currentPage == "pivot" ? "tab_td_sel" : "tab_td")%>" onclick="toggle_section('pivot'); return false;"><img src="pics/1blank.gif" width="140" height="0"/><br/><a style="text-decoration:none" href="#" onclick="toggle_section('pivot'); return false;"><%=tools_web.get_web_str("vcrb_pivot")%></a></td>
-->
		<td class="tab_td_empty" width="100%">&nbsp;</td>
	</tr>
</table>
<br/>
<%
	aColumnsDataSrc = ArrayExtract(curObject.columns, "tools.get_report_storage_field(This.datatype.Value)");
	switch(_currentPage)
	{
		case "default":
%>
		<table border="1" cellpadding="2" cellspacing="0" id="custom_report_data_table" width="100%">
			<tr valign="top">
<%
				try
				{
					_width = Int(100.0 / ArrayCount(vReportResult.h.cs)) + "%";
				}
				catch(_pusto_)
				{
					_width = "100%";
				}
				for (_head_column in vReportResult.h.cs)
				{
					if (_head_column.flag_visible)
					{
%>
				<td width="<%=_width%>" bgcolor="#ffcc99"><%=_head_column.title%></td>
<%
					}
				}
				if (curObject.categorize)
				{
					iPapaIndex = null;
				}
%>
			</tr>
<%
				for (_row in vReportResult.rs)
				{
					if (_row.bgcl.HasValue)
						_cell_color = _row.bgcl;
					else
						_cell_color = "255,255,255";
					if (curObject.categorize)
					{
						if (_row.main)
						{
							iPapaIndex = _row.ChildIndex;
							sDisplay = "main='1' id='tr_"+iPapaIndex+"' onclick='toggleChildren(this)' onmouseover='$(this).addClass(\"hovertr\");' onmouseout='$(this).removeClass(\"hovertr\");'";
						}
						else
							sDisplay = "style='display: none' papatr='tr_"+iPapaIndex+"'"
					}
					else
						sDisplay = "";
%>
			<tr valign="top" <%=sDisplay%>>
<%
					for (_column in _row.cs)
					{
						fldPapaColumn = vReportResult.h.cs.Child(_column.ChildIndex);
						if (fldPapaColumn.flag_visible)
						{
							vValue = _column.Child(aColumnsDataSrc[_column.ChildIndex]);
							if (!vValue.HasValue && !curObject.categorize) vValue = "&nbsp;";
%>
				<td style="background: rgb(<%=(_column.bgcl.HasValue? _column.bgcl : _cell_color)%>); color: rgb(<%=(_column.cl.HasValue? _column.cl : "black")%>)"><%=vValue%></TD>
<%
						}
					}
%>
			</tr>
<%
				}
%>
		</table>
		<br/>
		<center><input type="button" value="<%=tools_web.get_web_str("c_export_to_excel")%>" onclick="modalWin=window.open('assessment_excel_export.html?mode=custom_report_data&custom_report_id=<%=curObjectID%>','cr<%=curObjectID%>','')" class="activateButton" onmouseover="this.className='activateButtonOver';" onmouseout="this.className='activateButton';"/></center>
<%
		if (curObject.categorize)
		{
%>
		<style>
		tr.hovertr
		{
			font-weight: bold;
			text-decoration : underline;
			cursor: hand;
		}
		</style>
		<script language="javascript">
		<!--
			function toggleChildren(oSrc)
			{
				var _id = oSrc.getAttribute("id");
				//var _bVisible = $(src).is(":visible");
				$("#custom_report_data_table tr[papatr='"+_id+"']").each(function(){
						if ($(this).is(":visible"))
							$(this).hide();
						else
							$(this).show();
				});
			}
		-->
		</script>
<%
		}
		break;
		case "graph":

		try
		{
			curObject.disp_legend = Request.Form.HasProperty("disp_legend");
			curObject.flag_showvalues = Request.Form.HasProperty("flag_showvalues");
			if (Request.Form.HasProperty('chart_id'))
				curObject.chart_id = Request.Form.chart_id;
		}
		catch(_wow_)
		{
			Cancel();
		}
%>

	<form action="<%=Request.Url%>" method="post">
<table cellpadding="5" border="0" width="100%">
<tr>
<td>
	<table cellpadding="1" border="0">
		<tr>
	<%
		for (_chart in common.charts)
		{
	%>
		<td>
			<input type="radio" name="chart_id" value="<%=_chart.chart_id%>" <%=(curObject.chart_id == _chart.chart_id ? "checked" : "")%>/><%=_chart.chart_name%>
		</td>
	<%
		}
	%>
		</tr>
	</table>
	<hr/>
	<div>
		&nbsp;&nbsp;
		<input type="checkbox" name="disp_legend" <%=(curObject.disp_legend ? "checked" : "")%>/><%=tools_web.get_web_str("vcrb_show_legend")%>
		&nbsp;&nbsp;
		<input type="checkbox" name="flag_showvalues" <%=(curObject.flag_showvalues ? "checked" : "")%>/><%=tools_web.get_web_str("vcrb_show_values")%>
	</div>
	<hr/>
		<input type="submit" value="<%=tools_web.get_web_str("c_refresh")%>" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';" style="width:200px"/>
	</form>

</td>
</tr>
</table>

<div style="width:100%; height:500px">
<%
sValueAxisCaption = tools_web.get_web_str("vcrb_values");
Response.Write(EvalCodePageUrl("x-local://templates/custom_report_graph_v2.html"));
%>
</div>
<%
		break;
		case "pivot":
%>
<div id="WSGR_body">
		<script language="javascript" type="text/javascript" src="scripts/WSGR/tools.js"></script>
		<script language="javascript" type="text/javascript" src="scripts/WSGR/wsgrid.js"></script>
		<link href="scripts/WSGR/skin.css" rel="stylesheet" type="text/css" />

		<script>
		g_sTemplate = "scripts/WSGR/" + g_sTemplate;
		g_sPivotTemplate = "scripts/WSGR/" + g_sPivotTemplate;
		g_wsdistinct = "scripts/WSGR/" + g_wsdistinct;
		g_wsselect = "scripts/WSGR/" + g_wsselect;
		g_wsemptygrid = "scripts/WSGR/" + g_wsemptygrid;
		</script>
	<hr size="1"/>
	<table border="0">
		<tr>
			<td>
				<input type="button" value="&lt;" onclick="WSGR_Page('prev'); return false;" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';"/>
<%
		Response.Write(StrReplace(StrReplace(StrReplace(tools_web.get_web_str("vcrb_pivot_data_info"), "{PARAM1}", '<span id="wsgr_start"></span>'),"{PARAM2}", '<span id="wsgr_end"></span>'),"{PARAM3}", '<span id="wsgr_total"></span>'));
%>
				<input type="button" value="&gt;" onclick="WSGR_Page('next'); return false;" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';"/>
			</td>
			<td>
				<input type="button" value="<%=tools_web.get_web_str("vcrb_pivot_table")%>" onclick="WSGR_DisplayPivotSelector();" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';"/>
			</td>
		</tr>
		<tr>
			<td>
				<div id="WSGR_FakeHeader">&nbsp;</div>
				<div id="WSGR_main">&nbsp;</div>
			</td>
			<td>
				<div id="WSGR_FakeHeader">&nbsp;</div>
				<div id="WSGR_pivot">No Data Processed</div>
			</td>
		</tr>
	</table>
	<hr size="1"/>
	<div id="WSGR_wait">
		<table border="0">
			<tr>
				<td><img border="0" src="scripts/WSGR/images/wait.gif"/></td>
				<td>Rendering table...<br/>Please wait</td>
			</tr>
		</table>
	</div>

	<div id="WSGR_pivot_selector" style="display: none">
		<table border="0" id="WSGR_pivot_selector_head" cellpadding="0" cellspacing="0" width="100%">
			<tr>
				<td id="WSGR_pivot_selector_head_text"><%=tools_web.get_web_str("vcrb_building_pivot_table")%></td>
				<td id="WSGR_pivot_selector_head_button"><input onclick="WSGR_BuildPivot(); return false;" type="button" value="<%=tools_web.get_web_str("vcrb_build_pivot_table")%>" id="WSGR_pivot_selector_head_input" disabled="true"/></td>
				<td id="WSGR_pivot_selector_head_close" onclick="WSGR_CloseSelector(); return false;">X</td>
			</tr>
		</table>
		<table border="0" id="WSGR_pivot_selector_table" cellpadding="0" cellspacing="0">
			<tr>
				<td rowspan="2" id="WSGR_pivot_selector_collist">
					<div id="WSGR_pivot_columns_div">
						<table border="0" id="WSGR_pivot_selector_innertable" cellpadding="0" cellspacing="0">
						</table>
					</div>
				</td>
				<td id="WSGR_pivot_selector_empty_header">&nbsp;</td>
				<td id="WSGR_pivot_selector_col_header">
					<table border="0" id="WSGR_pivot_col_table" cellpadding="0" cellspacing="0">
					</table>
				</td>
			</tr>
			<tr>
				<td id="WSGR_pivot_selector_row_header">
					<table border="0" id="WSGR_pivot_row_table" cellpadding="0" cellspacing="0">
					</table>
				</td>
				<td id="WSGR_pivot_selector_data">
					<table border="0" id="WSGR_pivot_data_table" cellpadding="0" cellspacing="0">
					</table>
				</td>
			</tr>
		</table>
		<div id="WSGR_selector" style="display: none">
			<table border="0" cellpadding="0" cellspacing="0" width="100%">
				<tr>
					<td class="wsgr_selector_idle" id="WSGR_to_rows" dir="rows" onmouseover="WSGR_SelectOver(this); return false;" onmouseout="WSGR_SelectOut(this); return false;" onclick="WSGR_PlaceColumnInPivot(this); return false;"><%=tools_web.get_web_str("vcrb_to_rows")%></td>
				</tr>
				<tr>
					<td class="wsgr_selector_idle" id="WSGR_to_columns" dir="cols" onmouseover="WSGR_SelectOver(this); return false;" onmouseout="WSGR_SelectOut(this); return false;" onclick="WSGR_PlaceColumnInPivot(this); return false;"><%=tools_web.get_web_str("vcrb_to_columns")%></td>
				</tr>
				<tr>
					<td class="wsgr_selector_idle" id="WSGR_to_data" dir="data" onmouseover="WSGR_SelectOver(this); return false;" onmouseout="WSGR_SelectOut(this); return false;" onclick="WSGR_PlaceColumnInPivot(this); return false;"><%=tools_web.get_web_str("vcrb_to_data")%></td>
				</tr>
			</table>
		</div>
	</div>

	<XML id="strItems">
	<?xml version="1.0" encoding="windows-1251"?>
	<objects>
	<custom_report>
		<%=vReportResult.Xml%>
	</custom_report>
	</objects>
	</XML>
</div>
<script>WSGR_Start();</script>
<%
		break;
	}
}
%>
					</td>
					</tr>
					<tr>
						<td class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td>
					</tr>
		</table>