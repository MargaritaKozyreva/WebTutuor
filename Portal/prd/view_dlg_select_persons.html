<%
Server.Execute( "include/access_init.html" );

curEventID = null;
if ( Request.QueryString.HasProperty( 'event_id' ) && Request.QueryString.event_id != '' )
{
	curEventID = Int( Request.QueryString.event_id );
	curEvent = OpenDoc( UrlFromDocID( curEventID ) ).TopElem;
}
%>
<html>
<head>
<title><%=tools.get_web_str('vdsp_title')%></title>
<meta http-equiv="Content-Type" content="text/html; charset=windows-1251" />
<link href="style.css" rel="stylesheet" type="text/css"/>
</head>

<body>
<%
if ( curEventID != null && ArrayCount( curEvent.groups ) != 0 )
{	
	for ( _group in curEvent.groups )
	{
		try
		{
			_cur_group = OpenDoc( UrlFromDocID( _group.group_id ) ).TopElem;
%>
<table width="100%"  border="0" cellspacing="3" cellpadding="3">
	<tr>
		<td>
	
		<div class="headerText"><%=tools.get_web_str('c_group')%>"<%=tools_web.get_cur_lng_name( _cur_group.name )%>"</div>
		<table width="100%"  border="0" cellspacing="0" cellpadding="3">
			<tr>
				<td class="tableHeaderNoText" width="20"><img src="pics/1blank.gif" width="1" height="1" /></td>
				<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="1" height="1" /></td>
				<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="1" height="1" /></td>
				<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="1" height="1" /></td>
			</tr>	
<%				
			counter = 0;
			for ( _person in _cur_group.collaborators )
			{
				_class = counter++ % 2 ? 'tableRowEven' : 'tableRowOdd';
%>
			<TR VALIGN="MIDDLE">
				<TD class="<%=_class%>" width="20"><input type="checkbox" name="check_input" id="<%=_person.collaborator_id%>" <%=( curEvent.collaborators.ChildByKeyExists( _person.collaborator_id ) ? 'checked' : '' )%>></TD>
				<TD class="<%=_class%>"><%=_person.collaborator_fullname%></TD>
				<TD class="<%=_class%>"><%=tools_web.get_cur_lng_name( _person.person_position_name )%></TD>
				<TD class="<%=_class%>"><%=tools_web.get_cur_lng_name( _person.person_subdivision_name )%></TD>					
			</TR>
<%
			}
%>
			<tr>
				<td class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td>
				<td class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td>
				<td class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td>
				<td class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td>
			</tr>
		</table>
		<br>
		<br>
<%
		}
		catch ( gg )
		{
		}
	}
}
else
{
%>	
		<table width="100%"  border="0" cellspacing="0" cellpadding="3">
			<tr>
				<td class="tableHeaderWithText" width="20">&nbsp;</td>
				<td class="tableHeaderWithText"><%=tools.get_web_str('c_fio')%></td>
				<td class="tableHeaderWithText"><%=tools.get_web_str('uf_main_position')%></td>
				<td class="tableHeaderWithText"><%=tools.get_web_str('uf_main_subdivision')%></td>
			</tr>
			<tr>
				<td class="tableHeaderNoText" width="20"><img src="pics/1blank.gif" width="1" height="1" /></td>
				<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="1" height="1" /></td>
				<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="1" height="1" /></td>
				<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="1" height="1" /></td>
			</tr>	

<%
	if ( curUser.access.access_role == 'admin' || curUser.access.access_role == 'organizer' )
		curPersonsArray = XQuery( 'for $elem in collaborators order by $elem/fullname return $elem' );
	else
		curPersonsArray = tools.get_sub_persons_by_func_manager_id( curUserID );
	
	counter = 0;
	for ( _person in curPersonsArray )
	{
		_class = counter++ % 2 ? 'tableRowEven' : 'tableRowOdd';
%>
		
			<TR VALIGN="MIDDLE">
				<TD class="<%=_class%>" width="20">
					<input type="checkbox" name="check_input" id="<%=_person.id%>" <%=( curEvent.collaborators.ChildByKeyExists( _person.id ) ? 'checked' : '' )%>>
				</TD>
				<TD class="<%=_class%>"><%=_person.fullname%></TD>
				<TD class="<%=_class%>"><%=tools_web.get_cur_lng_name( _person.position_name )%></TD>
				<TD class="<%=_class%>"><%=tools_web.get_cur_lng_name( _person.position_parent_name )%></TD>						
			</TR>
<%
	}
%>
			<tr>
				<td class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td>
				<td class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td>
				<td class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td>
				<td class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td>
			</tr>
		</table>
<%
}
%>

		<table width="100%" border="0" cellspacing="0" cellpadding="0" class="activator">
			<tr>
				<TD ALIGN="CENTER" class="activator">
					<INPUT TYPE="button" ID="ok" VALUE="<%=tools.get_web_str('c_choose')%>" onClick="processChecked(true);" CLASS="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';">
					<INPUT TYPE="button" ID="cancel" VALUE="<%=tools.get_web_str('c_cancel')%>" onClick="processChecked(false);" CLASS="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';">
				</TD>
			</tr>
		</table>
	
		</td>
	</tr>
</table>
<script language="javascript">
if ( dialogArguments.selected_object_ids && dialogArguments.selected_object_ids != '' )
{
	elements = document.getElementsByName('check_input');
	selectArray = dialogArguments.selected_object_ids.split(';');
	for ( i=0; i<elements.length; i++ )
		for ( j=0; j<selectArray.length; j++ )
			if ( elements[i].id == selectArray[j] )
				elements[i].checked = true;
}

//---------------------------------------
function processChecked(flag)
{
	dialogArguments.selected_object_ids = '';
	elements = document.getElementsByName('check_input');
	for ( i=0; i<elements.length; i++ )
		if ( elements[i].checked )
			dialogArguments.selected_object_ids += elements[i].id + ';';

	dialogArguments.handle=flag;
	window.parent.close(); 
}
//---------------------------------------
</script>

</body>
</html>