<%
	isNew = curObjectID == null;
	curAction = Request.QueryString.HasProperty( 'action' ) ? Request.QueryString.action : 'view';
%>

<script language="javascript">
function doSubmitDocument( action )
{
	if ( <%=tools.document_notification_status( curObjectID, curObject )%> || document.getElementById("permit_subscription_id").checked )
		if ( window.confirm( <%=CodeLiteral( tools.get_web_str('vdb_subm_question') )%> ) )
			document.document_form.process_subscription.value = '1';

	if ( action )
	{
		switch ( action )
		{
			case 'add_catalog':
				sCatalogName = $("#add_catalog").val();
				if ( sCatalogName == '' )
					return false;

				if ( ! $("#add_catalog_all").is(":checked") )
				{
					var pars=new Object();
					var value = $("#add_catalog_ids_"+sCatalogName).val();
					if ( value )
						pars.selected_object_ids = value;
					xShowModalDialog( 'dlg_select.html?catalog_name=' + sCatalogName + '&multi_select=1&doc_id=<%=curDocID%>&typein=0&rand='+ Math.random(), pars );
					if ( ! pars.handle ) 
						return false;
					$("form input[name=selected_object_ids]").val( pars.selected_object_ids );
				}
				break;
		}

		$("form input[name=action]").val( action );
	}

	document.document_form.submit();
	return false;
}
</script>
<table width="100%" cellspacing="5" cellpadding="0">
<form action="document_change.html" name="document_form" method="POST" enctype="multipart/form-data">
<input type="hidden" name="doc_id" value="<%=curDocID%>">
<input type="hidden" name="sid" value="<%=tools.get_sum_sid( curDocID )%>">
<input type="hidden" name="action" value="<%=curAction%>"/>
<input type="hidden" name="object_id" value="<%=curObjectID%>"/>
<input type="hidden" name="parent_document_id" value="<%=curObject.parent_document_id%>"/>
<input type="hidden" name="parent_object_id" value="<%=curObject.parent_object_id%>"/>
<input type="hidden" name="process_subscription" value="0"/>
<input type="hidden" name="selected_object_ids" value=""/>
	<tr>
		<td width="100%">
		
		
<%Server.Execute( "view_tinymce.html" )%>

		<textarea id="elm1" name="text_area" rows="15" cols="80" width="100%" style="width: 100%; height: 200px;" richtext="true">
		<%=( isNew ? '' : tools_web.get_web_desc( curObject.text_area, UrlFromDocID( curObjectID ), "document.text_area" ) )%>
		</textarea>

		</td> 
	</tr>
	<tr>
		<td>
		
		<table width="100%" cellspacing="0" cellpadding="0" class="tableBorder">	
			<tr>
				<td width="140" align="RIGHT"><b><%=tools.get_web_str('c_name')%>:</b>&nbsp;</td>		
				<td style="font-weight:normal"><input type="text" name="name" class="inputEdit" value="<%=HtmlEncode( curObject.name )%>" style="width:100%"/></td>
			</tr>
			<tr>
				<td width="140" align="RIGHT"><b><%=tools.get_web_str('c_code')%>:</b>&nbsp;</td>		
				<td style="font-weight:normal"><input type="text" name="code" class="inputEdit" value="<%=HtmlEncode( curObject.code )%>" size="20"/></td>
			</tr>
			<tr>
				<td width="140" align="RIGHT"><b><%=tools.get_web_str('c_create_date')%>:</b>&nbsp;</td>		
				<td style="font-weight:normal"><input type="text" name="create_date" class="inputEdit" value="<%=curObject.create_date%>" size="20"/></td>
			</tr>	
			<tr>
				<td width="140" align="RIGHT"><b><%=tools.get_web_str('c_access_level')%>:</b>&nbsp;</td>		
				<td style="font-weight:normal"><input type="text" name="access.access_level" class="inputEdit" value="<%=curObject.access.access_level%>" size="10"/></td>
			</tr>
			<tr>
				<td width="140" align="RIGHT"><b><%=tools.get_web_str('c_pos_num')%>:</b>&nbsp;</td>		
				<td style="font-weight:normal"><input type="text" name="attributes.position" class="inputEdit" value="<%=curObject.attributes.position%>" size="10"/></td>
			</tr>
			<tr>
				<td width="140" align="RIGHT"><b><%=tools.get_web_str('doc_template')%>:</b>&nbsp;</td>
				<td style="font-weight:normal">
					<select name="web_template_type" id="web_template_type_id" onchange="document.getElementById('template_id').value=this.options[this.selectedIndex].getAttribute('url')">
						<option value="" url=""></option>
<%
	for ( _elem in curLngCommon.web_template_types )
	{
%>
						<option value="<%=_elem.PrimaryKey%>" url="<%=_elem.url%>"><%=_elem.name%></option>
<%
	}
%>
					</select>&nbsp;&nbsp;
<script language="javascript">
selcur=document.getElementById("web_template_type_id");
selcur.selectedIndex==-1;
for(i=0;i<selcur.options.length;i++)
    if(selcur.options[i].value=="<%=curObject.web_template_type%>")
	{
        selcur.selectedIndex=i;
		break;
    }
</script>
				<input type="text" name="attributes.template" id="template_id" value="<%=HtmlEncode( curObject.attributes.template )%>" class="inputEdit" style="width:300px"/>
				</td>
			</tr>
			<tr>
				<td width="140" align="RIGHT">&nbsp;</td>		
				<td style="font-weight:normal"><input type="checkbox" name="attributes.is_menu" <%=( curObject.attributes.is_menu ? 'checked="checked"' : '' )%>/><%=tools.get_web_str('vdb_is_menu')%></td>
			</tr>
			<tr>
				<td width="140" align="RIGHT">&nbsp;</td>		
				<td style="font-weight:normal"><input type="checkbox" name="attributes.is_main_item" <%=( curObject.attributes.is_main_item ? 'checked="checked"' : '' )%>/><%=tools.get_web_str('vdb_is_main')%></td>
			</tr>
			<tr>
				<td width="140" align="RIGHT">&nbsp;</td>		
				<td style="font-weight:normal"><input type="checkbox" name="attributes.is_news" <%=( curObject.attributes.is_news ? 'checked="checked"' : '' )%>/><%=tools.get_web_str('vdb_is_news')%></td>
			</tr>
			<tr>
				<td width="140" align="RIGHT">&nbsp;</td>		
				<td style="font-weight:normal"><input type="checkbox" name="attributes.no_disp_childs" <%=( curObject.attributes.no_disp_childs ? 'checked="checked"' : '' )%>/><%=tools.get_web_str('vdb_no_disp_child')%></td>
			</tr>
			<tr>
				<td width="140" align="RIGHT">&nbsp;</td>		
				<td style="font-weight:normal"><input type="checkbox" name="attributes.left_disp_childs" <%=( curObject.attributes.left_disp_childs ? 'checked="checked"' : '' )%>/><%=tools.get_web_str('vdb_disp_child_left')%></td>
			</tr>
			<tr>
				<td width="140" align="RIGHT">&nbsp;</td>
				<td style="font-weight:normal">
					<input type="checkbox" name="attributes.is_link" <%=( curObject.attributes.is_link ? 'checked="checked"' : '' )%>/><%=tools.get_web_str('vdb_is_link')%>:&nbsp;&nbsp;&nbsp;
					<input type="text" name="attributes.link_href" value="<%=HtmlEncode( curObject.attributes.link_href )%>" class="inputEdit" style="width:300px"/>&nbsp;&nbsp;
					<select name="attributes.link_target" id="link_target_id">
						<option value=""></option>
						<option value="_BLANK">_BLANK</option>
						<option value="_PARENT">_PARENT</option>
						<option value="_SELF">_SELF</option>
						<option value="_TOP">_TOP</option>
					</select>
<script language="javascript">
selcur=document.getElementById("link_target_id");
selcur.selectedIndex==-1;
for(i=0;i<selcur.options.length;i++)
    if(selcur.options[i].value=="<%=curObject.attributes.link_target%>")
	{
        selcur.selectedIndex=i;
		break;
    }
</script>
				</td>
			</tr>
			<tr>
				<td width="140" align="RIGHT">&nbsp;</td>		
				<td style="font-weight:normal"><input type="checkbox" name="attributes.permit_subscription" id="permit_subscription_id" <%=( curObject.attributes.permit_subscription ? 'checked="checked"' : '' )%>/><%=tools.get_web_str('vdb_can_submition')%></td>
			</tr>
			<tr>
				<td width="140" align="RIGHT"><b><%=tools.get_web_str('c_comment')%>:</b></td>		
				<td style="font-weight:normal"><input type="text" name="name" class="inputEdit" value="<%=HtmlEncode( curObject.comment )%>" style="width:100%"/></td>
			</tr>
		</table>
	
		</td>
	</tr>
	<tr>
		<td>
<%
	readOnly = true;
	Server.Execute( "view_custom_templates.html" );
%>
		</td>
	</tr>
<%
	dispDelete = curAction == 'save' || curAction == 'create';
	if ( dispDelete || curObject.files.ChildNum != 0 )
	{
%>
	<tr>
		<td>
		
		<table width="100%" cellspacing="0" cellpadding="0" class="tableBorder">
			<tr>
				<td colspan="2">
<%
	Server.Execute( "view_files.html" );
%>
				</td>		
			</tr>
<%
		if ( dispDelete )
		{
%>
			<tr>
				<td width="140" align="RIGHT"><b><%=tools.get_web_str('vdb_add_file')%>:</b>&nbsp;</td>		
				<td style="font-weight:normal">
<%
	Server.Execute('view_file_add.html');
%>
				</td>
			</tr>
<%
		}
%>
		</table>
		
		</td>
	</tr>
<%
	}

	if ( dispDelete || curObject.catalogs.ChildNum != 0 )
	{
%>
	<tr>
		<td>

		<table width="100%" cellspacing="0" cellpadding="0" class="tableBorder">
<%
		if ( dispDelete )
		{
%>
			<tr>
				<td width="140" align="right"><b><%=tools_web.get_web_str('vdb_add_cat')%>:&nbsp;</b></td>		
				<td><select id="add_catalog" name="add_catalog" class="inputEdit">
<%
			for ( fldObjectTypeElem in ArraySelect( curLngCommon.exchange_object_types, 'web_template.HasValue' ) )
			{
%>
						<option value="<%=fldObjectTypeElem.PrimaryKey%>"><%=fldObjectTypeElem.title + ' [' + fldObjectTypeElem.name + ']'%></option>
<%
			}
%>
				</select></td>
			</tr>
			<tr>
				<td width="140" align="right"><b><%=tools.get_web_str('c_desc')%>:&nbsp;</b></td>		
				<td><input type="text" name="add_catalog_title" id="add_catalog_title" style="width:100%" class="inputEdit" value=""/></td>
			</tr>
			<tr>
				<td width="140" align="right">&nbsp;</td>		
				<td style="font-weight:normal"><input type="checkbox" name="add_catalog_all" id="add_catalog_all"/>&nbsp;<%=tools_web.get_web_str('vdb_include_all')%></td>
			</tr>
			<tr>
				<td width="140" align="right">&nbsp;</td>		
				<td><input type="button" id="add_catalog_add" value="<%=tools_web.get_web_str('vdb_add_cat')%>" onclick="doSubmitDocument('add_catalog');" class="inputButton" onmouseover="this.className='inputButtonOver';" onmouseout="this.className='inputButton';"/></td>
			</tr>
<%
		}

		for ( fldCatalogElem in curObject.catalogs )
		{
			fldExchObject = curLngCommon.exchange_object_types.GetChildByKey( fldCatalogElem.PrimaryKey );
			sDispField = fldExchObject.disp_name;
			sCatalogTitle = fldCatalogElem.title.HasValue ? fldCatalogElem.title : fldExchObject.web_title;
%>
			<input type="hidden" id="add_catalog_ids_<%=fldCatalogElem.PrimaryKey%>" value="<%=ArrayMerge( fldCatalogElem.objects, 'PrimaryKey', ';' )%>"/>
			<tr>
				<td colspan="2">
<%
			if ( fldCatalogElem.all )
			{
%>
				<table width="100%" class="tableBasic" border="0" cellspacing="0" cellpadding="0">
					<tr>
						<td class="tableHeaderTextLeft"><img src="pics/1blank.gif" width="0" height="0"/></td>
						<td class="tableHeaderText"><p class="tableHeaderTextInner"><%=sCatalogTitle%> - <%=tools_web.get_web_str('vdb_all_obj')%></p></td>
						<td class="tableHeaderTextRight"><img src="pics/1blank.gif" width="0" height="0"/></td>
					</tr>
					<tr>
						<td class="tableFooterLeft"><img src="pics/1blank.gif" width="0" height="0"/></td>
						<td class="tableFooter"><img src="pics/1blank.gif" width="0" height="0"/></td>
						<td class="tableFooterRight"><img src="pics/1blank.gif" width="0" height="0"/></td>
					</tr>
				</table>
<%
			}
			else
			{
%>				
				<table width="100%" class="tableBasic" border="0" cellspacing="0" cellpadding="0">
					<tr>
						<td class="tableHeaderTextLeft"><img src="pics/1blank.gif" width="0" height="0"/></td>
						<td class="tableHeaderText"><p class="tableHeaderTextInner"><%=sCatalogTitle%></p></td>
						<td class="tableHeaderTextRight"><img src="pics/1blank.gif" width="0" height="0"/></td>
					</tr>
					<tr>
						<td class="tableHeaderWithTextLeft"><img src="pics/1blank.gif" width="0" height="0"/></td>
						<td class="tableHeaderWithText" width="100%"><%=tools.get_web_str('c_name')%></td>
						<td class="tableHeaderWithTextRight"><img src="pics/1blank.gif" width="0" height="0"/></td>
					</tr>
					<tr>
						<td class="tableHeaderNoTextLeft"><img src="pics/1blank.gif" width="0" height="0"/></td>
						<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="0" height="0"/></td>
						<td class="tableHeaderNoTextRight"><img src="pics/1blank.gif" width="0" height="0"/></td>
					</tr>
<%
				counter = 0;
				for ( fldObjectElem in fldCatalogElem.objects )
				{
					_class = counter % 2 ? 'tableRowEven' : 'tableRowOdd';
					_classl = counter % 2 ? 'tableRowEvenLeft' : 'tableRowOddLeft';		
					_classr = counter % 2 ? 'tableRowEvenRight' : 'tableRowOddRight';
					counter++;

					sTitle = fldObjectElem.PrimaryKey.OptForeignElem;
					sTitle = sTitle == undefined ? tools.get_web_str('c_deleted') : sTitle.Child( sDispField );
%>
						<tr>
							<td class="<%=_classl%>"></td>
							<td class="<%=_class%>"><%=sTitle%></td>
							<td class="<%=_classr%>"></td>
						</tr>
<%
				}
%>
					<tr>
						<td class="tableFooterLeft"><img src="pics/1blank.gif" width="0" height="0"/></td>
						<td class="tableFooter"><img src="pics/1blank.gif" width="0" height="0"/></td>
						<td class="tableFooterRight"><img src="pics/1blank.gif" width="0" height="0"/></td>
					</tr>
				</table>
<%
			}
%>
				</td>
			</tr>
<%
		}
%>
		</table>
		
		</td>
	</tr>
<%
	}

	if ( dispDelete )
	{	
%>
	<tr>
		<td>
	
		<table width="100%" border="0" cellspacing="0" cellpadding="0" class="activator">
			<tr>
				<td align="CENTER" class="activator">
					<input type="button" value="<%=tools.get_web_str('c_save')%>" onclick="doSubmitDocument();" class="inputButton" onmouseover="this.className='inputButtonOver';" onmouseout="this.className='inputButton';"/>
				</td>
			</tr>
		</table>
	
		</td>
	</tr>
<%
	}
%>
</form>
</table>