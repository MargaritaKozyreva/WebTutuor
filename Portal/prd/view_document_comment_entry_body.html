<%

Server.Execute( "include/access_init.html" );
bIsCommentPage=true;
curObjectID = null;
try
{
	if ( Request.QueryString.HasProperty( 'object_id' ) )
		curObjectID = Int( Request.QueryString.object_id );
	else 
		if ( Request.QueryString.HasProperty( 'portal_doc_id' ) )
			curObjectID = Int( Request.QueryString.portal_doc_id );
}
catch(ex)
{

}


if ( curObjectID != null )
{
	curObject = OpenDoc( UrlFromDocID( curObjectID ) ).TopElem;
	
	DispUserAvatar=curObject.attributes.disp_user_avatar
	DispUserStatus=curObject.attributes.disp_user_status;
	DispFoto=curObject.attributes.disp_foto;
	AllowAnonymousMessage=curObject.attributes.allow_anonymous_message;
	AllowRichTextEdit=curObject.attributes.allow_rich_text_edit;
	
	try
	{
		curDocPerson = curObject.document_persons.GetChildByKey( curUserID );
		CanEdit=curDocPerson.can_edit
		CanDelete=curDocPerson.can_delete
	}
	catch(ex)
	{
		CanEdit=false;
		CanDelete=false;
	}
}
else
{
	Response.Write("<font color='red' style='font-weight: boldest'>" + tools.get_web_str('vdceb_err_no_doc') + "</font><br/>");
	Cancel();
}


curCommentEntryID=null
curCommentEntry=null
try
{	
	curCommentEntryID = Int( Request.QueryString.entry_id );
	curCommentEntry = OpenDoc( UrlFromDocID( curCommentEntryID ) ).TopElem;
}
catch(err)
{

}

curCommentSubEntryID=null
curCommentSubEntry=null
try
{	
	curCommentSubEntryID = Int( Request.QueryString.sub_entry_id );
	curCommentSubEntry = OpenDoc( UrlFromDocID( curCommentSubEntryID ) ).TopElem;
}
catch(err)
{

}



curPage = Request.QueryString.HasProperty( 'cur_page' ) && Request.QueryString.cur_page != '' ? Int( Request.QueryString.cur_page ) : 1;
curViewType = Request.QueryString.HasProperty( 'view_type' ) && Request.QueryString.view_type != '' ? Request.QueryString.view_type : 'longtree';
bShortFlag = curViewType == 'shorttree';
curUrl = tools_web.get_query_string( true, "remove_entry_id;remove;replay;new_comment;app;edit;cur_page;view_type" );

oRegExp = tools_web.reg_exp_init();

function writeHierLine( iCommentEntryIDParam, catCommentEntryParam, sIndentParam  )
{
%>
	<tr>
		<td class="CL_forum_list_outer" align="middle">&nbsp;
<%
	if ( iCommentEntryIDParam == curCommentSubEntryID )
	{
%>
		<img height=11 src="pics/current.gif" width=13 border=0>
<%
	}
%>
		</td>
		<td class=CL_forum_list_outer align=middle><img src="<%=curLngCommon.forum_icon_types.GetChildByKey( catCommentEntryParam.icon_id ).url%>" border=0 title="<%=curLngCommon.forum_icon_types.GetChildByKey( catCommentEntryParam.icon_id ).name%>"></td>
		<td class=CL_forum_list_outer>
			<table cellspacing=0 cellpadding=0 width="100%" border=0>
			<tbody>
				<tr>
<%
		Response.Write( sIndentParam );
%>				
					<td width="100%">
<%
	deletedLine='<img src="\\pics\\Delete_3.gif" alt="' + tools.get_web_str('vdceb_comment_del') + '" border="0"/>&nbsp;' + tools.get_web_str('vdceb_comment_del');
	if ( iCommentEntryIDParam == curCommentSubEntryID )
	{
%>
					<b><%=(catCommentEntryParam.deleted?deletedLine:HtmlEncode( catCommentEntryParam.name ))%></b>
<%
	}
	else
	{
%>
					<a href="view_doc.html?mode=document_comment_entry&doc_id=<%=curDocID%>&portal_doc_id=<%=curObjectID%>&sub_entry_id=<%=iCommentEntryIDParam%>&entry_id=<%=curCommentEntryID%>&view_type=<%=curViewType%>&cur_page=<%=curPage%>"><%=(catCommentEntryParam.deleted?deletedLine:HtmlEncode( catCommentEntryParam.name ))%></a>
<%
		
	}
	
%>
					</td>
				</tr>
			</tbody>
			</table>
			</td>
			<td class=CL_forum_list_outer align=left>&nbsp;<%=(catCommentEntryParam.deleted?'':catCommentEntryParam.author_info)%></td>
			<td class=CL_forum_list_outer align=center>&nbsp;<%=(catCommentEntryParam.deleted?'':catCommentEntryParam.create_date)%></td>
		</td>
	</tr>
<%
}

function writeAnswerBlock( iCommentEntryIDParam, teCommentEntryParam)
{
%>
	<a name="ans_<%=iCommentEntryIDParam%>"/>
	<table cellspacing="0" cellpadding="0" width="100%" border="0">
	<tbody>
		<tr valign="top">
			<td class="CL_forum_answer_form_table">	
				<table cellspacing="0" cellpadding="0" width="100%" border="0">
					<tr>
						<td class="CL_forum_topic_author">
<%

	Response.Write( tools_web.get_web_str('vfb_author') + ":&nbsp;" );
	
	_user_line = "";
	avatar = "";
	_status = "";
	try
	{
		tePersonEntry = OpenDoc( UrlFromDocID( teCommentEntryParam.user_id ) ).TopElem;
		
		if ( teCommentEntryParam.how2show != "anonymous" && DispUserAvatar )  
		{
			if ( DispFoto )
			{
				avatar_filename = tePersonEntry.pict_url;
				avatar = tePersonEntry.pict_url.HasValue ? "<img src=\"http://" + curHost + avatar_filename + "\" border=\"0\"><br>" : "";
			}
			else
			{
				avatar_filename = tePersonEntry.personal_config.avatar_filename;
				avatar = tePersonEntry.personal_config.avatar_filename.HasValue ? "<img src=\"http://" + curHost + "/avatars/"+avatar_filename+"\" border=\"0\"><br>" : "";
			}
		}
		
		if ( teCommentEntryParam.how2show == "realname" )
		{
			_tip_html = '<b>' + tools_web.get_web_str('c_fio') + ':</b>&nbsp;' + HtmlEncode( tePersonEntry.fullname ) + '<br/>';
			_tip_html += '<b>' + tools_web.get_web_str('c_position') + ':</b>&nbsp;' + HtmlEncode( tePersonEntry.position_name ) + '<br/>';
			_tip_html += '<b>' + tools_web.get_web_str('c_subd') + ':</b>&nbsp;' + HtmlEncode( tePersonEntry.position_parent_name ) + '<br/>';
			_tip_html += '<b>' + tools_web.get_web_str('c_org') + ':</b>&nbsp;' + HtmlEncode( tePersonEntry.org_name );
			_user_line = '<a id=CL_forum_topic_author_name_' + iCommentEntryIDParam + ' href="view_doc.html?mode=collaborator&object_id=' + teCommentEntryParam.user_id + '&doc_id=' + curDocID + '" onmouseover="Tip(' + CodeLiteral( _tip_html ) + ',SHADOW,true,BGCOLOR,\'whitesmoke\')">' + tePersonEntry.fullname + '</a>';
		}
		else
		{
			_user_line = '<span id=CL_forum_topic_author_name_' + iCommentEntryIDParam + '>' + teCommentEntryParam.author_info( tePersonEntry ) + '</span>';
		}

		if ( DispUserStatus )
			_status = tools_web.get_web_str( 'c_status' )  + ": " +  tePersonEntry.personal_config.status + "<br/>";
	}
	catch( err )
	{
		alert( err );
	}

	Response.Write( _user_line + "<br/>" + _status + avatar );
%>
						</td>
					</tr>
					<tr>
						<td class="CL_forum_topic_date">
							<%=tools_web.get_web_str('c_date')%>:&nbsp;<%=StrDate( teCommentEntryParam.create_date, true, false )%>
						</td>
					</tr>
				</table>
				<img src="pics/1blank.gif" width="200" height="0" border="0"/>
			</td>

			<td width="100%" class="CL_forum_answer_form_table">
				<table cellspacing="0" cellpadding="0" width="100%" border="0">
					<tr>
						<td class="CL_forum_topic_name">
							<img src="<%=curLngCommon.forum_icon_types.GetChildByKey( teCommentEntryParam.icon_id ).url%>" border=0 title="<%=curLngCommon.forum_icon_types.GetChildByKey( teCommentEntryParam.icon_id ).name%>"/>&nbsp;<b><span id="CL_topicname_<%=iCommentEntryIDParam%>"><%=HtmlEncode( teCommentEntryParam.name )%></span></b>
						</td>
					</tr>
					<tr>
						<td class="CL_forum_topic_body">
							<div class="CL_forum_topic_content" id="CL_forum_topic_content_<%=iCommentEntryIDParam%>"><%=tools_web.convert_bbcode_to_html( teCommentEntryParam.text_area, oRegExp )%></div>
						</td>
					</tr>
				</table>
			</td>
		</tr>	
		<tr>
			<td class="CL_forum_topic_answer" colspan="2">
<%

				_delete ='<a onclick="confirm(' + CodeLiteral( tools_web.get_web_str( 'vfb_request2remove_topic' ) ) + ')" href="javascript:deleteEntry(\''+iCommentEntryIDParam+'\')">' + tools_web.get_web_str('vfb_remove_topic') + '</a>';
				
				
				if (!CanDelete&&teCommentEntryParam.user_id!=curUserID&&curUser.access.access_role != "admin")
				{
					_delete='';
				}

%>
				<%=_delete%>&nbsp;&nbsp;&nbsp;
<%
				if (CanEdit||teCommentEntryParam.user_id==curUserID||curUser.access.access_role == "admin")
				{
%>
				<a href="javascript: showMessage('<%=iCommentEntryIDParam%>','edit')"><%=tools_web.get_web_str('vfb_edit_mes') %></a>&nbsp;&nbsp;&nbsp;
<%
				}
%>
				<a href="javascript: showMessage('<%=iCommentEntryIDParam%>','replay')"><%=tools_web.get_web_str('vfb_submit')%></a>
			</td>
		</tr>
	</tbody>
	</table>
<%
}

function writeHierTopic( iCommentEntryIDParam, teCommentEntryParam, sIndentParam, bCloseFlagParam )
{
%>
<tr id="topic_line_<%=iCommentEntryIDParam%>">
	<td width="100%" valign="top">
	
	<table cellspacing="0" cellpadding="0" width="100%" border="0">
	<tbody>
		<tr id="topic_line_inner_table<%=iCommentEntryIDParam%>">
<%
	Response.Write( sIndentParam );

	if ( bCloseFlagParam )
	{
%>
		<td class="CL_forum_answer_form_table" width="100%">	
		<img src="\pics\Delete_3.gif" alt="<%=tools.get_web_str('vdceb_comment_del')%>" border="0"/>&nbsp;<b><%=tools.get_web_str('vdceb_comment_del')%></b>
<%
	}
	else
	{
%>
			<td width="100%">
<%
		writeAnswerBlock( iCommentEntryIDParam, teCommentEntryParam );
	}
%>
			</td>
		</tr>
	</tbody>
	</table>
	
	</td>
</tr>
<%
}
%>

<script language="JavaScript" src="scripts/tooltip/wz_tooltip_late.js"></script>
<%
if (AllowRichTextEdit)
{
%>
<script type="text/javascript" src="scripts/rte/js/tiny_mce.js"></script>
<%
}
%>
<script language="JavaScript">
isEditBody = false;


function setContent( sContentParam )
{
<%
if ( AllowRichTextEdit )
{
%>
	try
	{
		tinyMCE.get("content_id").setContent( sContentParam );
	}
	catch(ex)
	{
		$( "textarea" ).val( sContentParam );
	}

<%
}
else
{
%>	
	$( "#content_id" ).val( sContentParam );
<%
}
%>
}
function getContent()
{
<%
if ( AllowRichTextEdit )
{
%>	
	try
	{
		 Content= tinyMCE.get("content_id").getContent();
	}
	catch(ex)
	{
		 Content= $( "textarea" ).val();
	}
	return Content
	
<%
}
else
{
%>	
	return $( "#content_id" ).val();
<%
}
%>
}

function check_content( target )
{
<%
	if ( ! curUser.personal_config.nick.HasValue )
	{
%>
	if ( $("#how2show").val() == "nick" )
	{
		alert( <%=CodeLiteral( tools_web.get_web_str('vfeb_nick_mess') )%> );
		return;
	}
<%
	}
%>

	var max_title_len = 1000;
	var max_content_len = 10000;
	
	var _title = document.getElementById( "title_id" ).value;
	var _content = getContent();

	if ( _title == '' )
		alert( <%=CodeLiteral( tools_web.get_web_str( "vfb_message1" ) )%> );
	else if ( _title.length > max_title_len )
			alert( String( <%=CodeLiteral( tools_web.get_web_str( "vfb_message2" ) )%> ).replace( /{param1}/g, _title.length - max_title_len ) );				
		else if ( _content == '' )
				alert(  <%=CodeLiteral( tools_web.get_web_str( "vfb_message3" ) )%> );
			else if ( _content.length > max_content_len )
					alert( String( <%=CodeLiteral( tools_web.get_web_str( "vfb_message4" ) )%> ).replace( /{param1}/g, _title.length - max_content_len ) );
				else
					document.getElementById( "message_id" ).submit();
}


function showimage( selector )
{
	var container = selector.parentNode;
	if(container==null) return false;
	var svalue = selector.options[selector.selectedIndex].value;
	if(svalue==null) return false;
	var tags = container.getElementsByTagName( "img" );
	if(tags.length==0) return false;
	tags[0].src = svalue;
	document.getElementById( "icon" ).value = svalue;
	return false;
}

function vReplaceContentText(sReplaceWithThat, bForceInsert)
{
	var eContentArea = $("textarea:#content_id").get(0);
	//var iStartPos = eContentArea.selectionStart;
	//var iEndPos = eContentArea.selectionEnd;
	eContentArea.focus();
	var docRange = document.selection.createRange();
	if (docRange.parentElement() === eContentArea)
	//if (docRange.text.length != 0)
		docRange.text = sReplaceWithThat.replace(/\{\%s\%\}/g, docRange.text);
}


function deleteEntry(iCommentEntryIDParam)
{
	$( "#remove_entry_id" ).val( iCommentEntryIDParam );
	$( "#remove" ).val( 1 );
	document.forms['message_id'].submit()
}



function deleteNewRow()
{
	isEditBody = false;
<%
	if (bShortFlag)
	{
%>
		CurTable=document.getElementById("DocumentAllTopicTable")
<%
	}
	else
	{
%>	
		CurTable=document.getElementById("DocumentTopicTable")
<%
	}
%>	
		
	try
	{
		CurTable.deleteRow(document.getElementById("NewMainRow").rowIndex)
	}
	catch(ex)
	{
	}
	try
	{
		document.getElementById("NewCommentCell").innerHTML='&nbsp;'
	}
	catch(ex)
	{
		alert(ex)
	}
}
function showMessage( iCommentEntryIDParam, sModeParam )
{
if ( ! isAlreadyMessWrote() )
			return;
			
deleteNewRow();			
containerId= 'TextCell'
if  (sModeParam=='new_comment')
{
	containerId= 'NewCommentCell'
	isEditBody = true;
}
else
{
<%
	if (bShortFlag)
	{
%>
	CurTable=document.getElementById("DocumentAllTopicTable")
<%
	}
	else
	{
%>	
	CurTable=document.getElementById("DocumentTopicTable")
<%
	}
%>	
		
	AnswerRow=document.getElementById("topic_line_"+iCommentEntryIDParam)
	AnswerRowRowIndex=AnswerRow.rowIndex	
	AnswerTableRow=document.getElementById("topic_line_inner_table"+iCommentEntryIDParam)
	AnswerTableRowRowIndex=AnswerTableRow.rowIndex
	AnswerTableRowCells=AnswerTableRow.cells.length

	NextRowTableCells=0
	NextRowIndex=AnswerRowRowIndex+1
	if (CurTable.rows[NextRowIndex])
	{
		try
		{
			NextRowId=String(CurTable.rows[NextRowIndex].id).split("_")[2]
			NextRowTable=document.getElementById("topic_line_inner_table"+NextRowId)
			NextRowTableCells=NextRowTable.cells.length	
		}
		catch(ex)
		{
		}
	}

	
	NewRow=CurTable.insertRow(AnswerRowRowIndex+1) 
	NewRow.setAttribute("id","NewMainRow");

<%
	if (curViewType == 'longtree')
	{
%>
		NewCell=NewRow.insertCell(0)
		NewCell.innerHTML='<table cellspacing="0" cellpadding="0" width="100%" border="0"><tr id="newRow1"></tr></table>'
		NewRow1=document.getElementById("newRow1")
		
		if (AnswerTableRowCells<=NextRowTableCells)
		{
			for (ii=0;ii<NextRowTableCells;ii++)
			{
				NewCell=NewRow1.insertCell(ii)
				
				for (kk=0; kk<NextRowTable.cells[ii].attributes.length;kk++)
				{
					curAttr=NextRowTable.cells[ii].attributes[kk]
					NewCell.setAttribute(curAttr.nodeName,curAttr.nodeValue);
				}
				
				if (ii==(NextRowTableCells-2))
				{
					NewCell.background="pics/tree_vx.gif";
					NewCell.innerHTML='<img src="pics/tree_fx.gif" width="20" height="17" border="0">'
				}
				else if (ii!=(NextRowTableCells-1))
				{
					NewCell.innerHTML=NextRowTable.cells[ii].innerHTML
				}
			}
		}
		else
		{
			for (ii=0;ii<AnswerTableRowCells;ii++)
			{
				NewCell=NewRow1.insertCell(ii)
				
				for (kk=0; kk<AnswerTableRow.cells[ii].attributes.length;kk++)
				{
					curAttr=AnswerTableRow.cells[ii].attributes[kk]
					NewCell.setAttribute(curAttr.nodeName,curAttr.nodeValue);
				}
				
	
				if (ii!=(AnswerTableRowCells-1))
				{
					NewCell.innerHTML=AnswerTableRow.cells[ii].innerHTML
				}
			}
			
			try		
			{
				NewCell=NewRow1.insertCell(AnswerTableRowCells-2)
				NewCell.innerHTML='<img src="pics/zerro.gif" width="20" height="17" border="0">'
			}
			catch(ex)
			{
			}
				
		}
		TextCell=NewRow1.cells[NewRow1.cells.length-1]
		TextCell.setAttribute("id",containerId);
<%
	}
	else
	{
%>	
		TextCell=NewRow.insertCell(0)
		TextCell.setAttribute("id",containerId);	
<%
	}
%>	
}
dataStr="change_command=1&allow_rich_text_edit=<%=AllowRichTextEdit?'1':'0'%>&allow_anonymous_message=<%=AllowAnonymousMessage?'1':'0'%>"

$('#'+ containerId).empty().html('<table width="100%" height="50%"><tr><td height="50%" style="text-align: center"><img src="pics/ajax-loader.gif" alt="<%=tools.get_web_str('c_loading')%>..."/></td></tr><tr><td height="50%"><div align="center">Downloading</div></td></tr></table>');
$.post("document_comment_entry_change.html",dataStr,function(data)
	{

		$("#"+containerId).html(data);
		switch ( sModeParam )
		{
			case 'edit':
				$( "#document_entry_id_id" ).val( iCommentEntryIDParam );
				$( "#title_id" ).val( $( "#CL_topicname_" + iCommentEntryIDParam ).html() );
				setContent( $( "#CL_forum_topic_content_" + iCommentEntryIDParam ).html() );
				break;
	
			case 'replay':
				$( "#parent_document_entry_id_id" ).val( iCommentEntryIDParam );
				$( "#title_id" ).val( "Re: " + $( "#CL_topicname_" + iCommentEntryIDParam ).html() );
				setContent( "[quote][b]" + $( "#CL_forum_topic_author_name_" + iCommentEntryIDParam ).html() + ":[/b]<br/>" + $( "#CL_forum_topic_content_" + iCommentEntryIDParam ).html() + "[/quote]" );
				break;
		}

		isEditBody = true;
    	$("html,body").animate( { scrollTop: $("#ans_id").offset().top }, 500 )
	}
)

}

function isAlreadyMessWrote() 
{
	if ( isEditBody )
		return ( confirm( <%=CodeLiteral( tools_web.get_web_str( 'vfb_message_confirm' ) )%> ) );
	return true;
}

</script>
<form id="message_id" name="message_id" action="document_comment_entry_change.html" method="post" enctype="application/x-www-form-urlencoded">
	<input type=hidden name="doc_id" id="doc_id_id" value="<%=curDocID%>"/>
	<input type=hidden name="sid" id="sid_id" value="<%=tools.get_sum_sid( curDocID )%>"/>
	<input type=hidden name="cur_page" id="cur_page" value="<%=curPage%>"/>
	<input type=hidden name="view_type" id="view_type" value="<%=curViewType%>"/>
	<input type=hidden name="document_id" id="document_id_id" value="<%=curObjectID%>"/>
	<input type=hidden name="entry_id" id="document_entry_id_id" value=""/>
	<input type=hidden name="parent_document_entry_id" id="parent_document_entry_id_id" value="<%=curCommentEntryID%>"/>
	<input type=hidden name="remove_entry_id" id="remove_entry_id" value=""/>
	<input type=hidden name="remove" id="remove" value=""/>
<table border="0" cellspacing="0" cellpadding="0" width="100%" class="DocumentTopicTable" id="DocumentAllTopicTable">
	<tr>
		<td>
			<table id="CL_forum_mode_switch" width="100%" cellspacing="0" cellpadding="0" border="0">
				<tbody>
					<tr>
						<td width="80%">
							<select name="view_select" id="select_view_type" onChange="window.location.href='<%=curUrl%>&cur_page=<%=curPage%>&view_type='+this.value;return false;">
								<option value="longtree"><%=tools_web.get_web_str('vfb_view_all')%></option>
								<option value="shorttree"><%=tools_web.get_web_str('vfb_view_short')%></option>
								<option value="type"><%=tools_web.get_web_str('vfb_view_line')%></option>
							</select>
				<script language="javascript">
				selcur=document.getElementById("select_view_type");
				selcur.selectedIndex==-1;
				for (i=0;i<selcur.options.length;i++)
				if (selcur.options[i].value=="<%=curViewType%>") {
				selcur.selectedIndex=i;
				break;
				}
				</script>
						</td>
						<td width="20%" align="right">
<% 							if (curCommentEntryID!=null)
							{
%>
							<a href="view_doc.html?mode=document_comment_entry&doc_id=<%=curDocID%>&portal_doc_id=<%=curDocID%>&view_type=<%=curViewType%>&cur_page=<%=curPage%>"><%=tools.get_web_str('dc_read_all')%></a>
<%
							}
%>
						</td>
					</tr>
				</tbody>
			</table>
		</td>
	</tr>
	<tr>
		<td colspan="2" align="left" valign="middle">
			<a href="<%=curUrl%>&new_comment=1&view_type=<%=curViewType%>&cur_page=<%=curPage%>"><%=tools.get_web_str('dc_write_comment')%></a>
		</td>
	</tr>
	<tr>
		<td id="NewCommentCell">&nbsp;
			
		</td>
	</tr>
<%
	
	if ( bShortFlag )
	{
		if (curCommentSubEntryID!=null)
		{
			writeHierTopic( curCommentSubEntryID, curCommentSubEntry, '', curCommentSubEntry.deleted );
		}
		else if (curCommentEntryID!=null)
		{
			writeHierTopic( curCommentEntryID, curCommentEntry, '', curCommentEntry.deleted );
		}
	}
	
%>
	<tr>
		<td>

		<table cellspacing="0" cellpadding="0" width="100%" border="0">
		<tbody id="DocumentTopicTable" name="DocumentTopicTable">
<%
	if ( bShortFlag )
	{
%>
			<tr>
				<td class="CL_forum_list_header" align=middle width="22"><b>v</b></td>
				<td class="CL_forum_list_header" align=middle width="22"><b>&nbsp;</b></td>
				<td class="CL_forum_list_header"><b><%=tools_web.get_web_str('vfb_subject')%></b></td>
				<td class="CL_forum_list_header" align=center width="25%"><b><%=tools_web.get_web_str('vfb_author')%></b></td>
				<td class="CL_forum_list_header" align=center width="150"><b><%=tools_web.get_web_str('c_date')%></b></td>
			</tr>
<%
	}



if (curCommentEntryID==null)
{
	xarrCommentEntryAnswer = XQuery( 'for $elem in document_comment_entrys where $elem/portal_doc_id = ' + curObjectID + ' order by $elem/Hier(), $elem/last_create_date descending return $elem' );
}
else
{
	xarrCommentEntry = XQuery( 'for $elem in document_comment_entrys where $elem/id='+curCommentEntryID+' order by $elem/Hier() return $elem' );
	for (iCommentEntryElem in xarrCommentEntry)
	{
		xarrCommentEntryAnswer = ArraySort(XQuery("CatalogHierSubset('document_comment_entrys'," + iCommentEntryElem.id + ")"), "create_date", "+");
	}
	xarrCommentEntryAnswer=ArrayUnion(xarrCommentEntry,xarrCommentEntryAnswer)
}

iCommentEntryAnswerCount = ArrayCount(xarrCommentEntryAnswer);
/*for (iCommentEntryAnswerElem in xarrCommentEntryAnswer)
{
	Response.Write(iCommentEntryAnswerElem.name+'<br\>')
}*/

_mess_max_num = curWebCommon.count_forum_entry_page;
_start_index = 0;
_end_index = (iCommentEntryAnswerCount > _mess_max_num ? _mess_max_num : iCommentEntryAnswerCount);

if (curPage != 1)
{
	_start_index = _mess_max_num*(curPage - 1);
	_end_index = (iCommentEntryAnswerCount > _mess_max_num*curPage ? _mess_max_num*curPage : iCommentEntryAnswerCount);
}

arrIdentStr = Array();
iLastHLevel = null;
i = 0;

function vPrintCommentEntry(catCommentEntryAnsweElem, iHLevel, bLastFlag)
{

	if (i >= _end_index) return;
	
	if (curViewType == 'type')
	{
		if (i >= _start_index)
		{
			writeHierTopic(catCommentEntryAnsweElem.id, OpenDoc(UrlFromDocID(catCommentEntryAnsweElem.id)).TopElem, "", catCommentEntryAnsweElem.deleted);
		}
	}
	else
	{
		if (i >= _start_index)
		{
			sLastIdentStr = '';
			for (j=0; j<iHLevel; j++)
				sLastIdentStr += arrIdentStr[ j ];
			
			if (iHLevel!=0)
			{
				sLastIdentStr += '<td valign="top" align="left"' + (bLastFlag ? '' : ' background="pics/tree_vx.gif"') + '><img src="pics/tree_fx.gif" width="20" height="17" border="0"></td>'; 
			}
			else
			{
				sLastIdentStr='<td valign="top" align="left"><img src="pics/zerro.gif" width="20" height="17" border="0"></td>';
			}
				
			if (bShortFlag)
				writeHierLine(catCommentEntryAnsweElem.id, catCommentEntryAnsweElem, sLastIdentStr);
			else
				writeHierTopic(catCommentEntryAnsweElem.id, OpenDoc(UrlFromDocID( catCommentEntryAnsweElem.id)).TopElem, sLastIdentStr, catCommentEntryAnsweElem.deleted);
		}

		iLastHLevel = iHLevel;
		if (iHLevel!=0)
		{
			arrIdentStr[ iLastHLevel ] = bLastFlag ? '<td valign="top" align="left"><img src="pics/zerro.gif" width="20" height="17" border="0"></td>' : '<td valign="top" align="left" background="pics/tree_vx.gif"><img src="pics/tree_vx.gif" width="20" height="17" border="0"></td>';
		}
		else
		{
			arrIdentStr[ iLastHLevel ] ='<td valign="top" align="left"><img src="pics/zerro.gif" width="20" height="17" border="0"></td>';
		}
	}
	i++;
	if (curViewType != "type")
	{
		arrSubSelectedEntries = ArraySelectByKey(xarrCommentEntryAnswer, catCommentEntryAnsweElem.PrimaryKey,"parent_document_entry_id");
		var iSubBackCounter = ArrayCount(arrSubSelectedEntries) - 1;
		for (catSubCommentEntryElem in arrSubSelectedEntries)
		{
			vPrintCommentEntry(catSubCommentEntryElem, iHLevel+1 ,(iSubBackCounter == 0));
			iSubBackCounter--;
		}
	}
}

if (curViewType != "type")
	arrSelectedEntries = ArraySelect(xarrCommentEntryAnswer, 'parent_document_entry_id.HasValue == false')  //ArraySelectByKey(xarrCommentEntryAnswer, '',"parent_document_entry_id");
else
	arrSelectedEntries = xarrCommentEntryAnswer;

var iBackCounter = ArrayCount(arrSelectedEntries) - 1;
for (catCommentEntryElem in arrSelectedEntries)
{
	vPrintCommentEntry(catCommentEntryElem, 0 ,(iBackCounter == 0));
	iBackCounter--;
}
pages = ( iCommentEntryAnswerCount / _mess_max_num ) + ( ( iCommentEntryAnswerCount % _mess_max_num > 0 ) ? 1 : 0 );
%>
		</tbody>
		</table>
		</td>
	</tr>
	<tr>
		<td width="100%" valign="top" align="center">
<%
	for ( i = 1; i <= pages; i++ )
	{
		if ( pages == 1 )
			break;

		if ( curPage == i ) 
		{
%>
			<%=i%>&nbsp;
<%
		}
		else
		{
%>
			<a href="<%=curUrl%>&view_type=<%=curViewType%>&cur_page=<%=i%>"/><%=i%></a>&nbsp;
<%
		}
	}
%>
		</td>
	</tr>
</table>
</form>
<%
action=''
if (curCommentEntryID!=null)
{
	action=''
	if ( Request.Query.HasProperty( 'edit' ) && Request.Query.edit == '1' )
	{
		action='edit'
	}
	if ( Request.Query.HasProperty( 'replay' ) && Request.Query.replay == '1' )
	{
		action='replay'
	}
}
if ( Request.Query.HasProperty( 'new_comment' ) && Request.Query.new_comment == '1' )
{
	action='new_comment'
}
if (action!='')
{
%>
	<script language="javascript">
	$(document).ready(function() {
	showMessage('<%=curCommentEntryID%>','<%=action%>');
	});
	</script>
<%
}

%>