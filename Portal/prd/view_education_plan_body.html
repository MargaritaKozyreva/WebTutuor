<div class="headerText" style="position:relative; margin-top:10px;margin-bottom:5px;margin-left:5px;"><%=tools.get_web_str("vcpb_title")%></div> 
<table width="100%"  border="0" cellspacing="0" cellpadding="3"> 
<tr>
	<td class="tableHeaderWithText"><%=tools.get_web_str("c_name")%></td>
	<td class="tableHeaderWithText"><%=tools.get_web_str("c_edu_method")%></td>
	<td class="tableHeaderWithText" WIDTH="100"><%=tools.get_web_str("c_status")%></td>
	<td class="tableHeaderWithText"><%=tools.get_web_str("c_course")%> / <%=tools.get_web_str("c_event")%></td>
	<td class="tableHeaderWithText"><%=tools.get_web_str("vepb_required")%></td>
	<td class="tableHeaderWithText"><%="Документооборот"%></td>
<%
	_fmarr = XQuery("for $elem in func_managers where $elem/object_id = " + curObject.person_id.XQueryLiteral + " and $elem/person_id = " + curUserID + " return $elem");

	_im_in_groups = XQuery("for $elem in group_collaborators where $elem/collaborator_id = " + curObject.person_id.XQueryLiteral + " return $elem");

	_my_grops = XQuery("for $elem in func_managers where $elem/person_id = " + curUserID + " and $elem/catalog = 'group' return $elem");
	_my_grops = ArraySelect(_my_grops, "ArrayOptFind(_im_in_groups, 'group_id == ' + object_id) != undefined");
	_fmarr = ArrayUnion(_fmarr, _my_grops);

	_op_arr = Array();
	_spat_id = Array();
	try
	{
		catPersonObj = curObject.person_id.ForeignElem;
		_spat_id[ArrayCount(_spat_id)] = catPersonObj.org_id;
		_parent_document_object = catPersonObj.position_parent_id.OptForeignElem;

		my_position = curUser.position_id.OptForeignElem;
		if (my_position != undefined && my_position.is_boss && my_position.parent_object_id.HasValue)
			_boss_of_sub = my_position.parent_object_id;
		else
			_boss_of_sub = null;

		_parent_document_object = ArrayOptFirstElem(XQuery("for $sub in subdivisions where $sub/id = "+XQueryLiteral(_parent_document_object.PrimaryKey)+ " return $sub"));
		while (_parent_document_object != undefined)
		{
			_spat_id[ArrayCount(_spat_id)] = _parent_document_object.PrimaryKey;

			if (_boss_of_sub == _parent_document_object.PrimaryKey)
			{
				_op_arr[ArrayCount(_op_arr)] = ArrayOptFind(boss_types, "is_std == true");
				_boss_of_sub = null;
			}

			_parent_document_object = ArrayOptFirstElem(XQuery("for $sub in subdivisions where $sub/id = "+XQueryLiteral(_parent_document_object.parent_object_id)+ " return $sub"));
		}

	}
	catch(_gop_)
	{}


	for (_elem in _fmarr)
	{
		_a = _elem.boss_type_id.OptForeignElem;
		if (_a != undefined)
		{
			_op_arr[ArrayCount(_op_arr)] = _a;
		}
	}

	_fmarr = Array();
	_i = 0;
	for(_a in _op_arr)
	{
		if (_a == undefined) continue;
		if (_i > 0)
		{
			_na = Array();
			for (_j in _fmarr)
				if (StrContains(_a.operations, _j))
				if (_j + "" != "")
					_na[ArrayCount(_na)] = Int(_j);
			_fmarr = _na;
		}
		else
		{
			_fmarr = String(_a.operations).split(";");
			for (_j = 0; _j < ArrayCount(_fmarr); _j++)
			if (_fmarr[_j] + "" != "")
				_fmarr[_j] = Int(_fmarr[_j]);
		}
		if (ArrayCount(_fmarr) == 0)
			break;

		_i++;
	}

	if (ArrayCount(_spat_id) > 0 )
	{
		_elems = ArraySelect(QueryCatalogByKeys("func_managers", "object_id", _spat_id), "person_id == "+ curUserID);

		for (_elem in _elems)
		{
			_a = _elem.boss_type_id.OptForeignElem;
			if (_a != undefined)
			{
				_na = String(_a.operations).split(";");
				for (_j = 0; _j < ArrayCount(_na); _j++)
				if (_na[_j] + "" != "")
					_na[_j] = Int(_na[_j]);

				_fmarr = ArraySelectDistinct( ArrayUnion(_fmarr, _na) , "This");
			}
		}
	}

	_selectedActions = QueryCatalogByKeys("operations", "id", _fmarr);
	_selectedPriveleges = ArraySelect(_selectedActions, "operation_type == 1");
	
	_bEduEdit = (ArrayOptFind(_selectedPriveleges, "action == 'edit_education_plan'") != undefined);
	
	if (_bEduEdit)
	{
%>
	<td class="tableHeaderWithText">&nbsp;</td>
<%
	}
%>
</tr>
<tr>
	<td class="tableHeaderNoText" colspan="6"><img src="pics/1blank.gif" width="1" height="1" /></td>
<%
	if (_bEduEdit)
	{
%>
		<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="1" height="1" /></td> 
<%
	}
%>
</tr>
<%
	if (_bEduEdit)
	{
%>
		<script language="javascript">
		<!--
			function eduplan_select_smth_selectable(_inputIDID, _inputTitleID, _sCatalog)
			{
				var _inputID = $("#"+_inputIDID), _inputTitle = $("#"+_inputTitleID);
				var pars_pos=new Object();
				var strAttr="status:no;dialogWidth:780px;dialogHeight:550px;help:no;resizable:1";
				xShowModalDialog("dlg_select.html?doc_id=<%=curDocID%>&catalog_name=" +_sCatalog+ "&typein=0&multi_select=0&rand="+Math.random(), pars_pos, strAttr);

				if ( ! pars_pos.handle ) return false;
				
				if (_sCatalog == "education_method")
				{
					var emtype = $.ajax({type: 'POST', url: 'education_plan_process.html',  data: 'ajax=1&whattodo=getfield&field=type&object_id=' + pars_pos.element_id,async: false}).responseText;
					var _inputIDType = $("#"+_inputTitleID + "_type");
					_inputIDType.val(emtype);
					
					$("#"+_inputTitleID + "_target").empty().html("*");
					
				}
				_inputID.val(pars_pos.element_id);
				_inputTitle.text(pars_pos.element_name);
			}
		
			function eduplan_saveIt()
			{
				var postData = "whattodo=save&education_plan_id=<%=curObjectID%>";
				$("input:[data-name='__pc_prgrm_ids']").each(function(idx){
					var _pId = $(this).val();
					postData += "&program_" + idx + "=" + _pId;
					postData += "&p" + _pId + "_name=" + escape(($("#pc" +_pId+ "_name").val() || ""));
					postData += "&p" + _pId + "_type=" + $("#pc" +_pId+"_edumeth_type").val();
					postData += "&p" + _pId + "_education_method_id=" + $("#pc" +_pId+"_edumeth_id").val();
					postData += "&p" + _pId + "_request_id=" + $("#pc" +_pId+"_edumeth_request_id").val();
					postData += "&p" + _pId + "_object_id=" + $("#pc" +_pId+"_edumeth_object_id").val();
				});
				
				var sResult = $.ajax({type: 'POST', url: 'education_plan_process.html',  data: postData,async: false}).responseText;
				if (sResult == '')
				{
					alert("<%="Измененеия сохранены"%>");
					window.location.href = window.location.href;
				}
				else
					window.alert(sResult);
			}
		-->
		</script>
<%
	}
	
	var counter = 0;
	var _indent = "&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;";
	
	function put_doc_xml( _id, _indent_str )
	{
		var _child_part_array = ArraySelectByKey( curObject.programs, _id, "parent_progpam_id" );
		var _cur_child_part;
		
		for ( _part_course in _child_part_array )
		{
			_class = counter++ % 2 ? "tableRowEven" : "tableRowOdd";
%>
	<tr valign="middle">
		<td class="<%=_class%>">
 
		<table width="100%"  border="0" cellspacing="0" cellpadding="0">
			<tr valign="top">
				<td class="<%=_class%>" nowrap="nowrap"><%=_indent_str%></td>
				<td class="<%=_class%>" nowrap="nowrap"><img src="pics/folder.gif" width="13" height="11" border="0"/></td>
				<td class="<%=_class%>" width="100%">
<%
						if (_bEduEdit)
						{
%>
							<input type="hidden" data-name="__pc_prgrm_ids" value="<%=_part_course.id%>"/>
							<input type="text" id="pc<%=_part_course.id%>_name" name="pc<%=_part_course.id%>_name" class="inputEdit" value="<%=HtmlEncode(_part_course.name)%>"/>
<%				
						}
						else
							Response.Write(tools_web.get_cur_lng_name( _part_course.name ));
%>
				</td>
			</tr>
		</table>
	
		</td>
		<td class="<%=_class%>">
<%
			if (!_bEduEdit)
			{
				try
				{
					if ( _part_course.education_method_id.HasValue )
					{
						_cur_education_method = _part_course.education_method_id.ForeignElem;
%>
			<a HREF="view_doc.html?mode=education_method&doc_id=<%=curDocID%>&object_id=<%=_part_course.education_method_id%>" title="<%=tools.get_web_str("c_tip_edu_method")%>"><%=tools_web.get_cur_lng_name( _cur_education_method.name )%></a>
<%
					}		
				}
				catch ( ll )
				{
%>
			<font color="#FF0033"><%=tools.get_web_str("c_deleted")%></font>
<%
				}
			}
			else
			{
				_cur_education_method = _part_course.education_method_id.OptForeignElem
%>
				<nobr>
					<label id="pc<%=_part_course.id%>_edumeth"><a href="view_doc.html?mode=education_method&doc_id=<%=curDocID%>&object_id=<%=_part_course.education_method_id%>" title="<%=tools.get_web_str("c_tip_edu_method")%>"><%=(_cur_education_method != undefined ? _cur_education_method.name.Value : "")%></a></label>
					<input type="hidden" name="pc<%=_part_course.id%>_edumeth_type" id="pc<%=_part_course.id%>_edumeth_type" value="<%=(_cur_education_method != undefined ? _cur_education_method.type.Value : "")%>"/>
					<input type="hidden" name="pc<%=_part_course.id%>_edumeth_id" id="pc<%=_part_course.id%>_edumeth_id" value="<%=(_cur_education_method != undefined ? _cur_education_method.PrimaryKey : "")%>"/>
					<input type="button" value="..." class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';" onclick="eduplan_select_smth_selectable('pc<%=_part_course.id%>_edumeth_id', 'pc<%=_part_course.id%>_edumeth', 'education_method')" style="width: 25px"/>
				</nobr>
<%
			}
%>		 
		</td>	
		<td class="<%=_class%>" align="center"><%=curLngCommon.learning_states.GetChildByKey( _part_course.state_id ).name%></td>
		<td class="<%=_class%>" id="pc<%=_part_course.id%>_edumeth_target">
<%
			try
			{
				if ( _part_course.type == "event" )
				{
					if (_bEduEdit)
					{
%>
						<nobr>
						<label id="pc<%=_part_course.id%>_edumeth_object_title"><a href="view_doc.html?mode=event&doc_id=<%=curDocID%>&object_id=<%=_part_course.id%>"><%=_part_course.object_name%></a></label>
						<input type="hidden" name="pc<%=_part_course.id%>_edumeth_object_id" id="pc<%=_part_course.id%>_edumeth_object_id" value="<%=_part_course.object_id%>"/>
						<input type="button" value="..." class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';" onclick="eduplan_select_smth_selectable('pc<%=_part_course.id%>_edumeth_object_id', 'pc<%=_part_course.id%>_edumeth_object_title', 'event')" style="width: 25px"/>
						</nobr>
<%
					}
					else
					{
%>
			<a HREF="view_doc.html?mode=event&doc_id=<%=curDocID%>&object_id=<%=_part_course.object_id%>" title="<%=tools.get_web_str("c_tip_event")%>"><%=tools_web.get_cur_lng_name( _part_course.object_name )%></a>
<%
					}
				}	
				
				if ( _part_course.type == "course" )
				{
					if ( _part_course.learning_id.HasValue )
					{			
						_cur_learnind = _part_course.learning_id.ForeignElem;
%>
			<a HREF="view_doc.html?mode=learning_stat&doc_id=<%=curDocID%>&object_id=<%=_part_course.learning_id%>&course_id=<%=_cur_learnind.course_id%>&sid=<%=tools.get_sum_sid( _part_course.learning_id )%>"><%=_cur_learnind.start_usage_date%></a>
<%
					}
					else if ( _part_course.active_learning_id.HasValue )
					{			
						_cur_learnind = _part_course.active_learning_id.ForeignElem;
%>
			<a HREF="view_doc.html?mode=learning_proc&doc_id=<%=curDocID%>&object_id=<%=_part_course.active_learning_id%>&course_id=<%=_cur_learnind.course_id%>"><%=_cur_learnind.start_usage_date%></a>
<%
					}
					else if (_bEduEdit)
					{
%>
						<input type="button" value="Активировать курс" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';" onclick="var resp =  $.ajax({type: 'POST', url: 'education_plan_process.html',  data: 'ajax=1&whattodo=activatecourse&education_plan_id=<%=curObjectID%>&program_id=<%=_part_course.id%>',async: false}).responseText; if (resp == '') window.location.href = window.location.href; else window.alert(resp);"/>
<%
					}
				}	
			}
			catch ( err )
			{
%>
			<font color="#FF0033"><%=tools.get_web_str("c_deleted")%></font>
<%
			}
%>
		</td>
		<td class="<%=_class%>">
<%
			for ( _program in _part_course.completed_parent_programs )
			{
%>
		<li><small><%=tools_web.get_cur_lng_name( _program.program_id.ForeignElem.name )%></small></li>
<%
			}
			_catThisRequest = _part_course.request_id.OptForeignElem;
%>	
		</td>
		<td class="<%=_class%>">
<%
			if (_bEduEdit)
			{
%>
				<nobr>
				<label id="pc<%=_part_course.id%>_edumeth_request"><a href="view_doc.html?mode=request&doc_id=<%=curDocID%>&object_id=<%=(_catThisRequest != undefined ? _catThisRequest.PrimaryKey : "")%>"><%=(_catThisRequest != undefined ? _catThisRequest.code.Value : "")%></a></label>
				<input type="hidden" name="pc<%=_part_course.id%>_edumeth_request_id" id="pc<%=_part_course.id%>_edumeth_request_id" value="<%=_part_course.object_id%>"/>
				<input type="button" value="..." class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';" onclick="eduplan_select_smth_selectable('pc<%=_part_course.id%>_edumeth_request_id', 'pc<%=_part_course.id%>_edumeth_request', 'request')" style="width: 25px"/>
				</nobr>
<%
			}
			else
				Response.Write(_catThisRequest != undefined ? "<a href='view_doc.html?mode=request&doc_id=" +curDocID+ "&object_id=" +_catThisRequest.PrimaryKey + "'>"+ "Заявка" + " " +_catThisRequest.code.Value + "</a>" : "")
%>
		</td>
<%
	if (_bEduEdit)
	{
%>
		<td class="<%=_class%>">
			<input type="button" value="X" class="inputButton" onMouseOver
="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';" onclick="if (confirm('<%=HtmlEncode("Удалить строку?")%>')) $(this).closest('tr').remove();"/>
		</td>
<%
	}
%>
	</tr>
<%	
			put_doc_xml( _part_course.id, _indent_str + _indent );
		}
	}
	
	put_doc_xml( null, "" );
%>
	<tr> 
		<td class="tableFooter" colspan="6"><img src="pics/1blank.gif" width="1" height="1" /></td> 
<%
	if (_bEduEdit)
	{
%>
		<td class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td> 
<%
	}
%>
	</tr> 
</TABLE>
<%
	if (_bEduEdit)
	{
%>
		<center><input type="button" value="Добавить" class="inputButton" onMouseOver
="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';" onclick="if (confirm('<%=HtmlEncode("Добавить строку?")%>')) {$(document.createElement('input')).attr({'data-name':'__pc_prgrm_ids', 'type': 'hidden'}).val(parseInt(Math.random() * 10000000)).insertAfter($(this)); eduplan_saveIt();}"/><input type="button" value="Сохранить" class="inputButton" onMouseOver
="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';" onclick="eduplan_saveIt()"/></center>
<%
	}
%>