<%
try
{
	curDate = DateNewTime( Date( Request.Query.date ) );
}
catch ( rr )
{
	curDate = DateNewTime( CurDate );
}

_print = Request.Query.HasProperty( 'print' );

_year = Year( curDate );
_month = Month( curDate );
_num_days = Array( 31, ( DateToRawSeconds( Date( _year, 3, 1 ) ) - DateToRawSeconds( Date( _year, 2, 1 ) ) )/86400, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31 );


_date_start = Date( '1.' + _month + '.' + _year );
_date_end = Date( '1.' + ( _month == 12 ? '1.' + ( _year + 1 ) : ( _month + 1 ) + '.' + _year ) );
w = WeekDay( _date_start );
_week_day = ( w == 0 ? 6 : w - 1 );
_cur_num_days = _num_days[ _month - 1 ];


_date_str = "$elem/finish_date > date( '" + _date_start + "' ) and $elem/start_date < date( '" + _date_end + "' )";

if ( curUser.access.access_role == 'admin' )
{
	_events_array = XQuery( "for $elem in events where " + _date_str + " order by $elem/start_date return $elem" );
}
else	
{
    _ev_count = 0;
    _ev_array = Array();
    for ( _event in XQuery( "for $elem in event_collaborators where $elem/collaborator_id = 0 and " + _date_str + " return $elem" ) )
    {
    	eventDoc = OpenDoc( UrlFromDocID( _event.event_id ) ).TopElem;
        if ( eventDoc.is_public && tools_web.check_access( eventDoc, curUserID, curUser, Session ) == true )
        {
        	_ev_array[ _ev_count ] = _event;
            _ev_count++;
        }
    }
	_events_array = ArrayUnion( _ev_array, XQuery( "for $elem in event_collaborators where $elem/collaborator_id = " + curUserID + " and " + _date_str + " return $elem" ) );
    
	_i_m_lector = ArrayOptFirstElem( XQuery( "for $elem in lectors where $elem/person_id = " + curUserID + " return $elem" ) );
    if ( _i_m_lector != undefined )
		_events_array = ArrayUnion( _events_array, XQuery( "for $elem in event_lectors where $elem/lector_id = " + _i_m_lector.id + " and " + _date_str + " return $elem" ) );	
	
	_events_array = ArraySelectDistinct( _events_array, 'event_id' );
	
	_phases_array = ArraySelectDistinct( XQuery( "for $elem in event_phases where " + _date_str + " return $elem" ), 'start_date' );
	if ( ArrayCount( _phases_array ) != 0 )
		_events_array = ArrayUnion( _phases_array, ArraySelect( _events_array, "ArrayOptFind(_phases_array,'event_id=='+event_id)==undefined" ) );
	
	_events_array = ArraySort( _events_array, 'start_date', '+' );
}
%>	
  
<table cellpadding="0" cellspacing="0" border="0" width="100%">
<tr>
	<td class="calendarBodyTable">
	<table  cellpadding=0 cellspacing=0 border=0 width=100%>
		<tr>
			<td width=100% align=center class="calendarHeader">
<%
if ( ! _print )
{
%>
				<a href="view_doc.html?mode=event_calendar&doc_id=<%=curDocID%>&date=<%Response.Write( '1.' + ( _month == 1 ? '12.' + ( _year - 1 ) : ( _month - 1 ) + '.' + _year ) )%>">&lt;</a>
<%
}
%>
				&nbsp;<%=StrDate( curDate )%>&nbsp;
<%
if ( ! _print )
{
%>
				<a href="view_doc.html?mode=event_calendar&doc_id=<%=curDocID%>&date=<%=_date_end%>">&gt;</a>
<%
}
%>
			</td>
		</tr>
	</table>
	<table cellpadding="0" cellspacing="1" border="<%=( _print ? '1' : '0' )%>" width="100%" class="calendarInnerTable">
		<tr>
			<td width=16% align=center class="calendarDaysHeader"><%=tools.get_web_str('day_monday')%></td>
			<td width=16% align=center class="calendarDaysHeader"><%=tools.get_web_str('day_tuesday')%></td>
			<td width=16% align=center class="calendarDaysHeader"><%=tools.get_web_str('day_wednesday')%></td>
			<td width=16% align=center class="calendarDaysHeader"><%=tools.get_web_str('day_thursday')%></td>
			<td width=16% align=center class="calendarDaysHeader"><%=tools.get_web_str('day_friday')%></td>
			<td width=10% align=center class="calendarDaysHeader"><%=tools.get_web_str('day_saturday')%></td>
			<td width=10% align=center class="calendarDaysHeader"><%=tools.get_web_str('day_sunday')%></td>
		</tr>			
		<tr bgcolor="#FFFFFF">						
<%
	for ( i = 0; i < _week_day; i++ )
	{
%>			
			<td height=70></td>
<%
	}

	for ( i = 1; i <= _cur_num_days; i++ )
	{
		_cur_date = Date( i + '.' + _month + '.' + _year );

		if ( _week_day == 0 )
		{
%>
		<tr>
<%
		}
%>	
			<td class="calendarCell">								
				<table  cellpadding="0" cellspacing="0" border="0" width="100%">
					<tr>									
						<td class="<%=( _week_day > 4 ? 'tableRowEvenHoll' : 'tableRowEvenEvery' )%>" onclick="window.location='view_doc.html?mode=event_calendar&doc_id=<%=curDocID%>&date=<%=_cur_date%>'"><%=i%></td>
					</tr>								
				</table>		
<%
		dayArray = ArraySelect( _events_array, 'DateNewTime(start_date)<=_cur_date&&DateNewTime(finish_date)>=_cur_date' );
		for ( _cur_event in dayArray )
		{
%>								
					<li><%=( DateNewTime( _cur_event.start_date ) != _cur_date ? '&#9658;&nbsp;' : '' )%>
<%
			if ( _print )
			{
				Response.Write( tools_web.get_cur_lng_name( _cur_event.name ) );
			}
			else
			{
%>
						<a href="view_doc.html?mode=event&object_id=<%try{ Response.Write( _cur_event.event_id ) } catch(e) { Response.Write( _cur_event.id ) }%>&doc_id=<%=curDocID%>" title="<%=tools.get_web_str('c_tip_event')%>&nbsp;<%=StrDate( _cur_event.start_date, true, false )%>-<%=StrDate( _cur_event.finish_date, true, false )%>"><%=tools_web.get_cur_lng_name( _cur_event.name )%></a>
<%
			}
%>
					</li>
<%
		}
%>					
			</td>
<%
		_week_day++;		
		if ( _week_day == 7 )
		{
%>
		</tr>
<%
			_week_day = 0;
		}
	}

	a = 7 - _week_day;
	if ( _week_day )
	
	for ( i = 0; i < a; i++ )
	{
%>			
			<td class="calendarEmptyCell"></td>										
<%
		_week_day++;		
		if ( _week_day == 7 )
		{
%>
		</tr>
<%
		}
	}
%>							
					
	</table>
	</td>
</tr>


<%
if ( ! _print )
{
%>
<tr>
<td align="center">
	<br/>
	<INPUT TYPE="button" VALUE="<%=tools.get_web_str('vib_print')%>" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';" onClick='window.open("web_event_calendar.html?date=<%=curDate%>&doc_id=<%=curDocID%>&print=1","");'/>
</td>
</tr>
<%
}
%>

</table>