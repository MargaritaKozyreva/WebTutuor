<%
try
{
	_cur_date = DateNewTime( curDate );
}
catch ( rr )
{
	_cur_date = DateNewTime( Date() );
}
_year = Year( _cur_date );
_month = Month( _cur_date );

_date_start = Date( '1.' + _month + '.' + _year );
_date_end = Date( '1.' + ( _month == 12 ? '1.' + ( _year + 1 ) : ( _month + 1 ) + '.' + _year ) );
w = WeekDay( _date_start );
_week_day = ( w == 0 ? 6 : w - 1 );
_cur_num_days = _num_days[ _month - 1 ];


_period_str = "$elem/start_date < date( '" + _date_end + "' ) and $elem/finish_date > date( '" + _date_start + "' )";
_opt_str = ( curPlaceID == null ? "" : " and $elem/place_id = " + curPlaceID ) + ( curEducationOrgID == null ? "" : " and $elem/education_org_id = " + curEducationOrgID );

if ( curUser.access.access_role == 'admin' )
{
	_events_array = XQuery( "for $elem in events where " + _period_str + _opt_str + " order by $elem/start_date return $elem" );
}
else	
{
    _ev_count = 0;
    _ev_array = Array();
    for ( _event in XQuery( "for $elem in event_collaborators where $elem/collaborator_id = 0 and " + _period_str + " return $elem" ) )
    {
    	evDoc = OpenDoc( UrlFromDocID ( _event.event_id ) ).TopElem;
        if ( evDoc.is_public && tools_web.check_access( evDoc, curUserID, curUser, Session ) == true )
        {
        	_ev_array[ _ev_count ] = _event;
            _ev_count++;
        }
    }
	curUserEventArray = ArrayUnion( 
			_ev_array, 
			XQuery( "for $elem in event_collaborators where $elem/collaborator_id = " + curUserID + " and " + _period_str + " return $elem" ),
			XQuery( "for $elem in event_lectors where $elem/person_id = " + curUserID + " and " + _period_str + " return $elem" ) 
		);

	if ( _opt_str == "" )
	{
		_events_array = ArraySelectDistinct( curUserEventArray, 'event_id' );
	}
	else
	{
		curEventArray = XQuery( "for $elem in events where " + _period_str + _opt_str + " return $elem" );
		_events_array = ArraySelect( curEventArray, "ArrayOptFind(curUserEventArray,'event_id=='+PrimaryKey)!=undefined" );
	}
	
	_events_array = ArraySort( _events_array, 'start_date', '+' );
}
%>	
  
<table cellpadding=0 cellspacing=0 border=0 width=100%>
<tr>
	<td class="calendarBodyTable">
	<table  cellpadding=0 cellspacing=0 border=0 width=100%>
		<tr>
			<td width=100% align=center class="calendarHeader"><%=_name_months[_month-1]%>,&nbsp;<%=_year%></td>
		</tr>
	</table>
	<table cellpadding="0" cellspacing="1" border="0" width="100%" class="calendarInnerTable">
		<tr>
			<td width=16% align=center class="calendarDaysHeader"><%=tools.get_web_str('day_monday')%></td>
			<td width=16% align=center class="calendarDaysHeader"><%=tools.get_web_str('day_tuesday')%></td>
			<td width=16% align=center class="calendarDaysHeader"><%=tools.get_web_str('day_wednesday')%></td>
			<td width=16% align=center class="calendarDaysHeader"><%=tools.get_web_str('day_thursday')%></td>
			<td width=16% align=center class="calendarDaysHeader"><%=tools.get_web_str('day_friday')%></td>
			<td width=10% align=center class="calendarDaysHeader"><%=tools.get_web_str('day_saturday')%></td>
			<td width=10% align=center class="calendarDaysHeader"><%=tools.get_web_str('day_sunday')%></td>
		</tr>			
		<tr bgcolor="#FFFFFF">						
<%
	for ( i = 0; i < _week_day; i++ )
	{
%>			
			<td height=70></td>
<%
	}

	for ( i = 1; i <= _cur_num_days; i++ )
	{
		_cur_date = Date( i + '.' + _month + '.' + _year );

		if ( _week_day == 0 )
		{
%>
		<tr>
<%
		}
%>	
			<td class="calendarCell">		
									
			<table  cellpadding="0" cellspacing="0" border="0" width="100%">
				<tr>									
					<td class="<%=( _week_day > 4 ? 'tableRowEvenHoll' : 'tableRowEvenEvery' )%>" onclick="window.location='view_doc.html?mode=event_calendar&doc_id=<%=curDocID%>&date=<%=_cur_date%>'"><%=i%></td>
				</tr>								
			</table>		
<%
			dayArray = ArraySelect( _events_array, 'DateNewTime( start_date ) <= _cur_date && DateNewTime( finish_date ) >= _cur_date' );
			for ( _cur_event in dayArray )
			{
%>								
					<li><%=( DateNewTime( _cur_event.start_date ) != _cur_date ? '&gt;&nbsp;' : '' )%><a href="view_doc.html?mode=event&object_id=<%try{ Response.Write( _cur_event.event_id ) } catch(e) { Response.Write( _cur_event.id ) }%>&doc_id=<%=curDocID%>" title="<%=tools.get_web_str('c_tip_event')%>&nbsp;<%=StrDate( _cur_event.start_date, true, false )%>-<%=StrDate( _cur_event.finish_date, true, false )%>"><%=tools_web.get_cur_lng_name( _cur_event.name )%></a></li>
<%
			}
%>					
			</td>
<%
		_week_day++;		
		if ( _week_day == 7 )
		{
%>
		</tr>
<%
			_week_day = 0;
		}
	}

	a = 7 - _week_day;
	if ( _week_day )
	
	for ( i = 0; i < a; i++ )
	{
%>			
			<td class="calendarEmptyCell"></td>										
<%
		_week_day++;		
		if ( _week_day == 7 )
		{
%>
		</tr>
<%
		}
	}
%>							
					
	</table>
	</td>
</tr>
</table>
<br/>