<%
try
{
	_cur_date = DateNewTime( curDate );
}
catch ( rr )
{
	_cur_date = DateNewTime( Date() );
}
_year = Year( _cur_date );
_month = Month( _cur_date );

_date_month = Date( '1.' + _month + '.' + _year );
_w = WeekDay( _date_month );
_week_day = ( _w == 0 ? 6 : _w - 1 );
_date_start = DateOffset( _date_month, 86400 * ( 0 - _week_day ) );
_date_end = DateOffset( _date_month, 86400 * ( 42 - _week_day ) );
_date_end_day = DateOffset( _date_end, 0 - 86400 );


curUserEventArray = Array();
curLectorEventArray = Array();
if ( curUser.access.access_role != 'admin' )
{
	_period_str = "$elem/start_date < date( '" + _date_end + "' ) and $elem/finish_date > date( '" + _date_start + "' )";
	curUserEventArray = XQuery( "for $elem in event_collaborators where $elem/collaborator_id = " + curUserID + " and " + _period_str + " return $elem" );
	
    _ev_count = 0;
    _ev_array = Array();
    for ( _event in XQuery( "for $elem in event_collaborators where $elem/collaborator_id = 0 and " + _period_str + " return $elem" ) )
    {
    	evDoc = OpenDoc( UrlFromDocID ( _event.event_id  ) ).TopElem;
        if ( evDoc.is_public && tools_web.check_access( evDoc, curUserID, curUser, Session ) == true )
        {
        	_ev_array[ _ev_count ] = _event;
            _ev_count++;
        }
    }
	curUserEventArray = ArrayUnion( curUserEventArray, _ev_array );
	
	curLectorEventArray = XQuery( "for $elem in event_lectors where $elem/person_id = " + curUserID + " and " + _period_str + " return $elem" );
}
%>
<table cellspacing="0" cellpadding="0" border="0" width="100%" class="calendar_edu_table">
<tr style="height:30px;">
	<td class="calendar_edu_cell" rowspan="2"><b><%=_name_months[_month-1]%>, <%=_year%></b></td>
<%
	_last_date = _date_start;
	for ( i=0; i<6; i++ )
	{
		_cur_week_date = DateOffset( _last_date, 518400 );// 86400*6
%>
	<td class="calendar_tren_cell" colspan="7"><%=StrInt( Day(_last_date), 2 )%>.<%=StrInt( Month(_last_date), 2 )%>-<%=StrInt( Day(_cur_week_date), 2 )%>.<%=StrInt( Month(_cur_week_date), 2 )%></td>
<%
		_last_date = DateOffset( _cur_week_date, 86400 );
	}
%>
</tr>
<tr>
<%
	_last_date = _date_start;
	for ( i=0; i<42; i++ )
	{
%>
	<td class="calendar_tren_cell" style="width:16px"><img src="pics/1blank.gif" width="16" height="0"/><br/><%=Day(_last_date)%></td>
<%
		_last_date = DateOffset( _last_date, 86400 );
	}

	for ( _elem in curObjectArray )
	{
		curEventCounter = 0;
		curEventArray = XQuery( "for $elem in events where $elem/education_method_id = " + _elem.PrimaryKey + " and $elem/finish_date > date( '" + _date_start + "' ) and $elem/start_date < date( '" + _date_end + "' )" + ( curPlaceID == null ? "" : " and $elem/place_id = " + curPlaceID ) + ( curEducationOrgID == null ? "" : " and $elem/education_org_id = " + curEducationOrgID ) + " order by $elem/start_date return $elem" );

		if ( curUser.access.access_role != 'admin' )
			curEventArray = ArraySelect( curEventArray, "ArrayOptFind(curUserEventArray,'event_id=='+PrimaryKey)!=undefined || ArrayOptFind(curLectorEventArray,'event_id=='+PrimaryKey)!=undefined" );
		else
			curEventArray = ArrayDirect( curEventArray );		

		curEventNum = ArrayCount( curEventArray );	
		
		if ( curEventNum == 0 && ! distEmptyRow )
			continue;
			
		_method_name = tools_web.get_cur_lng_name( _elem.name );
%>
<tr>
	<td class="calendar_edu_cell"><a href="view_doc.html?mode=education_method&object_id=<%=_elem.PrimaryKey%>&doc_id=<%=curDocID%>" title="<%=XmlAttrEncode( _method_name )%>"><%=_method_name%></a></td>
<%
		_last_date = _date_start;
		for ( i=0; i<42; i++ )
		{
			while ( curEventCounter < curEventNum && DateNewTime( curEventArray[ curEventCounter ].finish_date ) < _last_date )
				curEventCounter++;
			
			curFirstEventID = null;
			curFirstEvent = null;
			eventCounter = 0;
			_temp_counter = curEventCounter;
			while ( _temp_counter < curEventNum && DateNewTime( curEventArray[ _temp_counter ].start_date ) <= _last_date )
			{
				eventCounter++;
				curEventID = curEventArray[ _temp_counter ].PrimaryKey;
				curEvent = OpenDoc( UrlFromDocID( curEventID ) ).TopElem
				if ( eventCounter == 1 )
				{
					curFirstEventID = curEventID;
					curFirstEvent = curEvent;
%>
	<td title="<%
				}
				else
				{
%>

<%

				}
%><%=eventCounter%>)	<%=XmlAttrEncode( tools_web.get_cur_lng_name( curEvent.name ) )%>
	<%=tools.get_web_str('c_status')%>:		<%=curLngCommon.event_status_types.GetChildByKey( curEvent.status_id ).name%>
	<%=tools.get_web_str('c_person_num')%>:		<%=curEvent.person_num%>&nbsp;<%=tools.get_web_str('c_of')%>&nbsp;<%=curEvent.max_person_num%>
	<%=tools.get_web_str('veb_quota')%>:			<%=curEvent.quota_org%>&nbsp;<%=tools.get_web_str('veb_quota_org')%>,&nbsp;<%=curEvent.quota_subdivision%>&nbsp;<%=tools.get_web_str('veb_quota_sub')%>,&nbsp;<%=curEvent.quota_person%>&nbsp;<%=tools.get_web_str('veb_quota_pers')%>
	<%=tools.get_web_str('vllec_title')%>:	<%
					_lector_str = '';
					for ( _lector in curEvent.lectors )
					try
					{
						_lector_str = _lector_str + ( _lector_str == '' ? '' : ', ' ) + _lector.PrimaryKey.ForeignElem.person_fullname;
					}
					catch ( ff )
					{
					}
						
					Response.Write( XmlAttrEncode( _lector_str ) );
					_currency_ = curEvent.currency.OptForeignElem;
%>
	<%=tools.get_web_str('c_cost')%>:		<%=curEvent.total_cost%>&nbsp;<%=( _currency_ != undefined ? _currency_.name : '' )%>
	<%=tools.get_web_str('c_action_place')%>:	<%=curEvent.place%>
	<%=tools.get_web_str('c_place')%>:		<%
				try
				{
					Response.Write( tools_web.get_cur_lng_name( curEvent.place_id.ForeignElem.name ) );
				}
				catch ( ff )
				{
				}
%><%
				_temp_counter++;
			}
			
			if ( eventCounter == 0 )
			{
%>
	<td class="calendar_tren_cell">&nbsp;</td>
<%
			}
			else
			{
%>" class="calendar_tren_cell" id="<%=_elem.PrimaryKey%>_<%=Day(_last_date)%>.<%=Month(_last_date)%>" onClick="onSelTraining(this,'<%=curFirstEventID%>','<%=_elem.PrimaryKey%>_<%=( curFirstEvent.start_date < _date_start ? Day(_date_start) + '.' + Month(_date_start) : Day(curFirstEvent.start_date) + '.' + Month(curFirstEvent.start_date) )%>-<%=( curFirstEvent.finish_date < _date_end_day ? Day(curFirstEvent.finish_date) + '.' + Month(curFirstEvent.finish_date) : Day(_date_end_day) + '.' + Month(_date_end_day) )%>','<%=curFirstEvent.default_request_type_id%>',<%=(curFirstEvent.is_open && curFirstEvent.status_id != 'close' && curFirstEvent.status_id != 'cancel')%>);return false;" ondblclick="submit_ecc('event','<%=curFirstEventID%>');return false;" style="background-color:#<%=StrHexColor( curFirstEvent.status_id.ForeignElem.bk_color )%>;cursor:hand;"><%=( eventCounter == 1 ? '&nbsp;' : eventCounter )%></td>
<%
			}
			
			_last_date = DateOffset( _last_date, 86400 );
		}
	}
%>	
</tr>
</table>
<br/>