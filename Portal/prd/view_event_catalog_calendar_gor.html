<%
_date_start = Date( _year, _month, 1 );

_date_end_day = Date( _year_end, _month_end, _num_days[ _month_end - 1 ] );
_date_end = DateOffset( _date_end_day, 86400 );


curUserEventArray = Array();
curLectorEventArray = Array();
if ( curUser.access.access_role != 'admin' )
{
	_period_str = "$elem/start_date < date( '" + _date_end + "' ) and $elem/finish_date > date( '" + _date_start + "' )";
	curUserEventArray = XQuery( "for $elem in event_collaborators where $elem/collaborator_id = " + curUserID + " and " + _period_str + " return $elem" );
	
	_ev_count = 0;
    _ev_array = Array();
    for ( _event in XQuery( "for $elem in event_collaborators where $elem/collaborator_id = 0 and " + _period_str + " return $elem" ) )
    {
    	evDoc = OpenDoc( UrlFromDocID ( _event.event_id ) ).TopElem;
        if ( evDoc.is_public && tools_web.check_access( evDoc, curUserID, curUser, Session ) == true )
        {
        	_ev_array[ _ev_count ] = _event;
            _ev_count++;
        }
    }
	curUserEventArray = ArrayUnion( curUserEventArray, _ev_array );
	
	curLectorEventArray = XQuery( "for $elem in event_lectors where $elem/person_id = " + curUserID + " and " + _period_str + " return $elem" );
}


curEmptyObjectNum = 0;
curEmptyObjectArray = Array();
curObjectsArray = Array();
for ( _elem in curObjectArray )
{
	curEventArray = XQuery( "for $elem in events where $elem/education_method_id = " + _elem.PrimaryKey + " and $elem/finish_date > date( '" + _date_start + "' ) and $elem/start_date < date( '" + _date_end + "' )" + ( curPlaceID == null ? "" : " and $elem/place_id = " + curPlaceID ) + ( curEducationOrgID == null ? "" : " and $elem/education_org_id = " + curEducationOrgID ) + " order by $elem/start_date return $elem" );
	
	if ( curUser.access.access_role != 'admin' )
		curEventArray = ArraySelect( curEventArray, "ArrayOptFind(curUserEventArray,'event_id=='+PrimaryKey)!=undefined || ArrayOptFind(curLectorEventArray,'event_id=='+PrimaryKey)!=undefined" );
	else
		curEventArray = ArrayDirect( curEventArray );

	if ( ArrayCount( curEventArray ) == 0 && ! distEmptyRow )
		continue;
		
	curEmptyObjectArray[ curEmptyObjectNum ] = _elem;
	curObjectsArray[ curEmptyObjectNum ] = curEventArray;
	curEmptyObjectNum++;
}
%>

<table cellspacing="0" cellpadding="0" border="0" width="100%" class="calendar_edu_table">
	<tr valign="top">
		<td>
		
		<table cellspacing="0" cellpadding="1" border="0" width="100%">
			<tr style="height:49px;">
				<td class="calendar_edu_cell"><img src="pics/1blank.gif" width="200" height="0"/></td>
			</tr>
<%
	for ( _elem in curEmptyObjectArray )
	{
		_method_name = tools_web.get_cur_lng_name( _elem.name );
%>
		<tr>
			<td class="calendar_edu_cell" style="height:16px"><div style="width:300px;overflow:hidden"><nobr><a href="view_doc.html?mode=education_method&object_id=<%=_elem.PrimaryKey%>&doc_id=<%=curDocID%>" title="<%=XmlAttrEncode( _method_name )%>"><%=_method_name%></a></nobr></div></td>
		</tr>
<%
	}
%>
		</table>
		
		</td>
		<td width="100%">
		
		<div style="width:200px; height: auto; overflow-x:scroll" id="cal_edu_event_div">
		<table cellspacing="0" cellpadding="1" border="0" width="100%">
			<tr style="height:30px;">
<%
	for ( i=0; i<numMonths; i++ )
	{
		_cur_num_month = ( _month + i ) % 12;
		_cur_num_month = ( _cur_num_month == 0 ? 12 : _cur_num_month );
		_cur_num_year = _year + ( _month + i - 1 ) / 12;
%>
				<td colspan="<%=_num_days[ _cur_num_month - 1 ]%>" class="calendar_tren_cell"><%=_name_months[ _cur_num_month - 1 ]%>,&nbsp;<%=_cur_num_year%></td>
<%		
	}
%>
			</tr>
			<tr style="height:16px;">
<%
	for ( i=0; i<numMonths; i++ )
	{
		_cur_num_month = ( _month + i ) % 12;
		_cur_num_month = ( _cur_num_month == 0 ? 12 : _cur_num_month );
		
		for ( _day=1; _day<=_num_days[ _cur_num_month - 1 ]; _day++ )
		{
%>
				<td class="calendar_tren_cell" style="width:16px"><img src="pics/1blank.gif" width="16" height="0"/><br/><%=_day%></td>
<%
		}		
	}
%>
			</tr>
<%
	for ( var _counter=0; _counter<curEmptyObjectNum; _counter++ )
	{
		_elem = curEmptyObjectArray[ _counter ];
		curEventCounter = 0;
		curEventArray = curObjectsArray[ _counter ];
		curEventNum = ArrayCount( curEventArray );
%>
			<tr>
<%
		for ( i=0; i<numMonths; i++ )
		{
			_cur_num_month = ( _month + i ) % 12;
			_cur_num_month = ( _cur_num_month == 0 ? 12 : _cur_num_month );
			_cur_num_year = _year + ( _month + i - 1 ) / 12;
			
			for ( _day=1; _day<=_num_days[ _cur_num_month - 1 ]; _day++ )
			{
				_last_date = Date( _cur_num_year, _cur_num_month, _day );
				while ( curEventCounter < curEventNum && DateNewTime( curEventArray[ curEventCounter ].finish_date ) < _last_date )
					curEventCounter++;
				
				curFirstEventID = null;
				curFirstEvent = null;
				eventCounter = 0;
				_temp_counter = curEventCounter;
				while ( _temp_counter < curEventNum && DateNewTime( curEventArray[ _temp_counter ].start_date ) <= _last_date )
				{
					eventCounter++;
					curEventID = curEventArray[ _temp_counter ].PrimaryKey;
					curEvent = OpenDoc( UrlFromDocID( curEventID ) ).TopElem
					if ( eventCounter == 1 )
					{
						curFirstEventID = curEventID;
						curFirstEvent = curEvent;
%>
				<td title="<%
					}
					else
					{
%>

<%

					}
%><%=eventCounter%>)	<%=XmlAttrEncode( tools_web.get_cur_lng_name( curEvent.name ) )%>
	<%=tools.get_web_str('c_status')%>:		<%=curLngCommon.event_status_types.GetChildByKey( curEvent.status_id ).name%>
	<%=tools.get_web_str('c_person_num')%>:		<%=curEvent.person_num%>&nbsp;<%=tools.get_web_str('c_of')%>&nbsp;<%=curEvent.max_person_num%>
	<%=tools.get_web_str('veb_quota_sub')%>:			<%=curEvent.quota_org%>&nbsp;<%=tools.get_web_str('veb_quota_org')%>,&nbsp;<%=curEvent.quota_subdivision%>&nbsp;<%=tools.get_web_str('veb_quota_sub')%>,&nbsp;<%=curEvent.quota_person%>&nbsp;<%=tools.get_web_str('veb_quota_pers')%>
	<%=tools.get_web_str('vllec_title')%>:	<%
					_lector_str = '';
					for ( _lector in curEvent.lectors )
					try
					{
						_lector_str = _lector_str + ( _lector_str == '' ? '' : ', ' ) + _lector.PrimaryKey.ForeignElem.person_fullname;
					}
					catch ( ff )
					{
					}
						
					Response.Write( XmlAttrEncode( _lector_str ) );
					_currency_ = curEvent.currency.OptForeignElem;
%>
	<%=tools.get_web_str('c_cost')%>:		<%=curEvent.total_cost%>&nbsp;<%=(_currency_ != undefined ? _currency_.name : '')%>
	<%=tools.get_web_str('c_action_place')%>:	<%=tools_web.get_cur_lng_name( curEvent.place )%>
	<%=tools.get_web_str('c_place')%>:		<%
				try
				{
					Response.Write( tools_web.get_cur_lng_name( curEvent.place_id.ForeignElem.name ) );
				}
				catch ( ff )
				{
				}
%><%
				_temp_counter++;
			}
			
			if ( eventCounter == 0 )
			{
%>
			<td class="calendar_tren_cell" style="width:16px">&nbsp;</td>
<%
			}
			else
			{
%>" class="calendar_tren_cell" id="<%=_elem.PrimaryKey%>_<%=Day(_last_date)%>.<%=Month(_last_date)%>" onClick="onSelTraining(this,'<%=curFirstEventID%>','<%=_elem.PrimaryKey%>_<%=( curFirstEvent.start_date < _date_start ? Day(_date_start) + '.' + Month(_date_start) : Day(curFirstEvent.start_date) + '.' + Month(curFirstEvent.start_date) )%>-<%=( curFirstEvent.finish_date < _date_end_day ? Day(curFirstEvent.finish_date) + '.' + Month(curFirstEvent.finish_date) : Day(_date_end_day) + '.' + Month(_date_end_day) )%>','<%=curFirstEvent.default_request_type_id%>',<%=(curFirstEvent.is_open && curFirstEvent.status_id != 'close' && curFirstEvent.status_id != 'cancel')%>);return false;" ondblclick="submit_ecc('event','<%=curFirstEventID%>');return false;" style="background-color:#<%=StrHexColor( curFirstEvent.status_id.ForeignElem.bk_color )%>;cursor:hand;height:16px;"><%=( eventCounter == 1 ? '&nbsp;' : eventCounter )%></td>
<%
			}
		}
	}
%>	
</tr>
<%
	}
%>
		</table>
		</div>

</td>
</tr>
</table>

<script language="javascript">
$(document).ready(function() {
	var $div = $("#cal_edu_event_div");
	$div.width( $div.parent().width() );
});
$(window).resize(function() {
	var $div = $("#cal_edu_event_div");
	$div.width( 100 );
	$div.width( $div.parent().width() );
});
</script>
<br/>