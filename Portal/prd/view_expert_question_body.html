<%
	if (curObjectID != null && curObject.Name == "expert_question")
	{
		_expert = curObject.expert_id.OptForeignElem;
%>
	<br/>
	<table width="100%" cellpadding="0">
	<tr>
		<td><%=(tools.get_web_str("veqb_asked") + "&nbsp;" + curObject.person_id.sd.fullname + ", " + curObject.date)%></td>
	</tr>
	</table>
	<table width="100%" cellspacing="0" cellpadding="4" class="tableBorder">			
		<tr>
			<td style="font-weight:normal"><%=curObject.question%></td>
		</tr>
	</table>
	<br/>
<%
		if (!curObject.status)
		{
%>
		<b id="b_unaswered_warning"><%=tools_web.get_web_str("veqb_is_not_answered")%></b>
<%		
		}
		
		if (_expert != undefined && curUserID == _expert.person_id)
		{
%>
		<%=tools_web.get_web_str("vkpb_expert")%>: <a href="view_doc.html?mode=expert&doc_id=<%=curDocID%>&object_id=<%=curObject.expert_id%>"><%=(_expert != undefined ? _expert.person_fullname : "")%></a>
		<br/>
		<div id="expert_take_control_here">
			<table width="100%">
				<tr>
					<td align="left">
						<textarea id="answer_as_expert" style="width: 100%" rows="10"><%=curObject.answer%></textarea>
					</td>
				</tr>
				<tr>
					<td align="left">
						<input type="checkbox" id="is_faq" value="1" <%=(curObject.is_faq?"checked":"")%>/><label for="is_faq"><%=tools_web.get_web_str("veqb_add_faq")%></label>
						<input type="checkbox" id="is_disclosed" value="1" <%=(curObject.is_disclosed?"checked":"")%>/><label for="is_faq"><%=tools_web.get_web_str("veqb_do_open")%></label>
					</td>
				</tr>
				<tr>
					<td align="left">
						<table width="100%" cellspacing="0" cellpadding="2" border="0">
							<tr>
							<td>
								<table>
								<tr>
									<td style="font-weight:bold">
										<%=tools.get_web_str("vkpb_knowledge_parts_title")%>
									</td>
									<td align="left">
										<input type="button" value="..." class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';" onclick="
											var pars=new Object(); pars.check_access = true;
											pars.can_be_empty = true;
											pars.selected_object_ids = $('div#expert_take_control_here input#knowledge_part_id').val();
											pars.xquery_qual = 'contains($elem/experts, \'<%=_expert.id%>\')';
											var strAttr='status:no;dialogWidth:780px;dialogHeight:550px;help:no;resizable:1';
											xShowModalDialog('dlg_select.html?doc_id=<%=curDocID%>&catalog_name=knowledge_part&typein=0&multi_select=1&rand='+Math.random(), pars, strAttr);
											if (!pars.handle ) return false;
											$('div#expert_take_control_here div[name=\'disp_knowledge_part_elem666\']').remove();
											$('div#expert_take_control_here input#knowledge_part_id').val(pars.selected_object_ids);
											for (var i=0;i<pars.elemArray.length;i++)
											{
												$('<div>').attr('name','disp_knowledge_part_elem666').insertBefore('div#expert_take_control_here input#knowledge_part_id').append($('<a>').attr('href','view_doc.html?mode=knowledge_part&knowledge_part_id='+pars.elemArray[i]+'&doc_id=<%=curDocID%>').html(pars.elemNamesArray[i]));
												//$('div#expert_take_control_here input#disp_knowledge_part').clone().attr({id:'',name:'disp_knowledge_part_elem666'}).val(pars.elemNamesArray[i]).show().insertBefore('div#expert_take_control_here input#knowledge_part_id');
											}
										" style="width: 25px" title="<%=XmlAttrEncode(tools_web.get_web_str("veb_sel_know_map"))%>"/>
									</td>
									
								</tr>
								</table>
							</td>
							</tr>
							<tr>
								<td width="100%"><input type="text" id="disp_knowledge_part" value="" class="inputEdit" style="width:100%;display:none" readonly/>
								<input type="hidden" id="knowledge_part_id" value=""/>
								</td>
							</tr>
						</table>
					</td>
				</tr>
			</table>
			<script language="javascript">
				var sErrMessage = <%=CodeLiteral(tools_web.get_web_str("veb_err_post"))%>;
				function saveQInfo(domSrcControl)
				{
					var sDocIdParam = '<%=curObjectID%>';
					var d = new Date();
					var sFldNam = 'answer;status;is_faq;is_disclosed;answer_date';
					var sValue = '[encoded]'+escape($('div#expert_take_control_here textarea#answer_as_expert').val()) + ';true;'+$("div#expert_take_control_here input#is_faq").is(':checked')+";"+$("div#expert_take_control_here input#is_disclosed").is(':checked') + ";[@formula]Date()";
					
					var sXmlKnowledges = "<knowledge_parts>";
					var arrOfKnowledgeIDs = $("div#expert_take_control_here input#knowledge_part_id").val().split(";");
					for (var i=0; i< arrOfKnowledgeIDs.length; i++)
					if (arrOfKnowledgeIDs[i] != "")
					{
						sXmlKnowledges+= "<knowledge_part><knowledge_part_id>"+arrOfKnowledgeIDs[i]+"</knowledge_part_id></knowledge_part>";
					}
					sXmlKnowledges+= "</knowledge_parts>";
					var sCode = "tools.create_notification('71', docResponse.DocID, '', null,docResponse.TopElem);";
					$(domSrcControl).hide().after("<img border='0' src='pics/progress.gif'/>");
					$.ajax({type: 'POST', url: 'document_save.html',  data: 'ajax=1&data_0_id='+sDocIdParam+'&data_0_source_fields='+sFldNam+'&data_0_destination_fields='+sValue+"&data_0_xml_0="+escape(sXmlKnowledges)+"&data_0_xml_assign_node_0=TopElem.knowledge_parts&code_access=<%=Md5Hex(String((Session.sid|curUserID)))%>&code_0_eval=" + escape(sCode),async: true, success: function(data){$(domSrcControl).show().next("img").remove(); if (parseInt(data) == 0) window.alert(sErrMessage); else window.alert("<%=HtmlEncode(tools.get_web_str("c_form_save"))%>");}, error: function(xht,msg){$(domSrcControl).show().next("img").remove(); window.alert(sErrMessage+"\n" + msg);} 
					});
				}
<%
		for (_fldKnowledgeChildElem in curObject.knowledge_parts)
		{
			_catKnowledgeName = _fldKnowledgeChildElem.PrimaryKey.OptForeignElem;
			if (_catKnowledgeName != undefined)
			{
				_sKnowledgeName = HtmlEncode(_catKnowledgeName.name);
%>
			$('<div>').attr('name','disp_knowledge_part_elem666').insertBefore('div#expert_take_control_here input#knowledge_part_id').append($("<a>").attr('href','view_doc.html?mode=knowledge_part&knowledge_part_id=<%=_catKnowledgeName.id%>&doc_id=<%=curDocID%>').html("<%=_sKnowledgeName%>"));
<%
			}
		}
%>
		$('div#expert_take_control_here input#knowledge_part_id').val("<%=ArrayMerge(curObject.knowledge_parts, "This.PrimaryKey", ";")%>");
		
				MM_preloadImages('pics/progress.gif');
			</script>
			<div width="100%" style="text-align: center">
				<input type="button" onClick="
						if (!confirm('<%=HtmlEncode(tools.get_web_str("veqb_are_you_sure_answer"))%>')) return false;
						if ($('textarea#answer_as_expert').val() == ''){window.alert('<%=tools_web.get_web_str("veqb_err_answer_text")%>'); return false;	}
						saveQInfo(this);
						$('b#b_unaswered_warning').hide();
				" value="<%=HtmlEncode(tools.get_web_str("veqb_answer"))%>" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';" style="width: 200px"/>
			</div>
				<br/>
		</div>
<%
				readOnly = true;
				Server.Execute( "view_custom_templates.html" );
		}
		else
		{
			if (curObject.status)
			{
%>
		<table width="100%" cellpadding="5">
		<tr>
			<td align="left"><%=(tools.get_web_str("veqb_expert_answer") + (_expert != undefined ? "&nbsp;<a href='view_doc.html?mode=expert&object_id=" + curObject.expert_id + "&doc_id=" + curDocID + "'>" + _expert.person_fullname + "</a>": ""))%><br/><%=(curObject.answer_date.HasValue ? curObject.answer_date : "")%><hr/></td>
		</tr>
		<tr>
			<td style="font-weight:normal"><%=tools_web.get_web_desc( curObject.answer, UrlFromDocID( curObjectID ), "expert_question.answer")%></td>
		</tr>
		</table>
<%
		                
				if (curUserID == curObject.person_id)
				{
					if (Request.QueryString.HasProperty("is_post") && Request.QueryString.GetProperty("is_post") == "2")
						Response.Write("<center><b>" + tools.get_web_str("c_form_save") + "</b></center><br/>");
%>
			<FORM id="reply_form">
<%
					fieldArray = Array();
					Server.Execute( "view_custom_templates.html" );
					if (ArrayOptFirstElem(fieldArray) != undefined)
					{
%>
				<script language="javascript">
					function getFormData(sFormName)
					{
						data = "";
						if(sFormName != "" && sFormName != null)
						{
							$("form#" + sFormName).find('input:text').each(function(){data += this.name + "=" + escape(this.value) + "&";});
							$("form#" + sFormName).find('input:checkbox').filter(":checked").each(function(){data += this.name + "=" + escape(this.value) + "&";});
							$("form#" + sFormName).find('input:radio').filter(":checked").each(function(){data += this.name + "=" + escape(this.value) + "&";});
							$("form#" + sFormName).find('input:hidden').each(function(){data += this.name + "=" + escape(this.value) + "&";});
							$("form#" + sFormName).find('textarea').each(function(){data += this.name + "=" + escape(this.value) + "&";});
							$("form#" + sFormName).find('select').each(function(){data += this.name + "=" + escape(this.value) + "&";});
							if(data.charAt(data.length - 1) == "&")
								data = data.substring(0, data.length - 1);
						}
						return data;
					}
				</script>
				<br/>
				<center><input type="button" onClick="
					var sDocIdParam = '<%=curObjectID%>';
					var domSrcControl = this;
					var sEval='<%=UrlEncode("tools_web.web_custom_elems_filling(\'expert_question\', docResponse.DocID, docResponse.TopElem, Request.Form );")%>';
					var sCodeAccess = '<%=Md5Hex(Session.sid)%>';
					
					if (!confirm('<%=HtmlEncode(tools.get_web_str("vab_acquaint_save_message"))%>')) return false;
					$.ajax({type: 'POST', url: 'document_save.html',  data: 'ajax=1&data_0_id='+sDocIdParam + '&code_eval='+sEval+'&code_access='+sCodeAccess + '&'+getFormData('reply_form'),async: true, success: function(data){$(domSrcControl).show().next('img').remove(); if (parseInt(data) == 0) window.alert(sErrMessage); else window.alert('<%=HtmlEncode(tools.get_web_str("c_form_save"))%>');}, error: function(xht,msg){$(domSrcControl).show().next('img').remove(); window.alert(sErrMessage+'\n' + msg);} 
					});
				" value="<%=HtmlEncode(tools.get_web_str("c_save"))%>" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';"/></center>
<%
					}
%>
			</FORM>
<%
				}
			}
%>
		<h4><%=tools.get_web_str("vkpb_knowledge_parts_title")%></h4>
<%
			for (_fldKnowledgeChildElem in curObject.knowledge_parts)
			{
				_catKnowledgeName = _fldKnowledgeChildElem.PrimaryKey.OptForeignElem;
				if (_catKnowledgeName != undefined)
				{
%>
					<a href="view_doc.html?mode=knowledge_part&knowledge_part_id=<%=_fldKnowledgeChildElem.PrimaryKey%>&doc_id=<%=curDocID%>"><%=_catKnowledgeName.name%></a><br/>
<%
				}
			}
		}
		if (_expert != undefined)
		{
%>
		<p align="center"><a href="view_doc.html?mode=expert&doc_id=<%=curDocID%>&object_id=<%=_expert.PrimaryKey%>"><%=tools_web.get_web_str("vkpb_proceed_to_expert_card")%></a></p>
<%
		}
	}
	else
	{
		if (curObject != null && curObject.Name == "expert")
			_flag_hide_expert = true;
		else
			_flag_hide_expert = false;
%>
		<table width="100%"  border="0" cellspacing="0" cellpadding="3">
					<tr>
						<td class="tableHeaderWithText"><%=tools.get_web_str("c_question")%></td>
						<td class="tableHeaderWithText" WIDTH="200"><%=tools.get_web_str("c_coll")%></td>
			<%
				if(!_flag_hide_expert)
				{
			%>
						<td class="tableHeaderWithText" WIDTH="200"><%=tools.get_web_str("vkpb_expert")%></td>
			<%
				}
			%>
						<td class="tableHeaderWithText" WIDTH="100"><%=tools.get_web_str("c_status")%></td>
					</tr>
					<tr>
						<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="1" height="1" /></td>
						<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="1" height="1" /></td>
			<%
				if(!_flag_hide_expert)
				{
			%>
						<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="1" height="1" /></td>
			<%
				}
			%>
						<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="1" height="1" /></td>
					</tr>
			<%
			amIExpert = XQuery("for $e in experts where $e/person_id = " + curUserID + " return $e");
			
			if (ArrayCount(amIExpert) > 0)
				amIExpert = ArrayFirstElem(amIExpert).PrimaryKey;
			else
				amIExpert = undefined;
			
			
				if ( curUser.access.access_role == 'admin' )
				{
					_q_array = XQuery("for $q in expert_questions order by $q/question return $q");
				}
				else
				{
					_q_array =  XQuery("for $q in expert_questions where $q/person_id = " + curUserID + (amIExpert != undefined? " or $q/expert_id = " + amIExpert : "") + " order by $q/question return $q");
				}
				
				counter = 0;
				for ( _q in _q_array )
				{
					_class = counter++ % 2 ? "tableRowEven" : "tableRowOdd";
					_expert_catalog_card = _q.expert_id.OptForeignElem;
			%>
					
				<TR VALIGN="MIDDLE">
					<TD class="<%=_class%>"><a HREF="view_doc.html?mode=expert_question&object_id=<%=_q.PrimaryKey%>&doc_id=<%=curDocID%><%=(_flag_hide_expert ? "&src_mode=expert" : "")%>"><%=_q.question%></a></TD>
					<TD class="<%=_class%>"><%=_q.person_fullname%></TD>
			<%
				if(!_flag_hide_expert)
				{
			%>
					<TD class="<%=_class%>"><a HREF="view_doc.html?mode=expert&object_id=<%=_q.expert_id%>&doc_id=<%=curDocID%>"><%=(_expert_catalog_card != undefined ? _expert_catalog_card.person_fullname : "???" )%></a></TD>
			<%
				}
			%>
					<TD class="<%=_class%>"><%=tools.get_web_str((_q.status ? "veqb_is_answered" : "veqb_is_not_answered" ))%></TD>
				</TR>
			<%
					}
			%>
					<tr>
						<td class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td>
						<td class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td>
						<td class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td>
						<td class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td>
					</tr>
				</table>
				<BR/>
<%
	}
%>