<%
_noheader = '0';
if ( Request.QueryString.HasProperty( 'noheader' ) )
{
	_noheader = '1';
	
	curObjectID = null;
	if ( Request.QueryString.HasProperty( 'object_id' ) )
	{
		curObjectID = Int( Request.QueryString.object_id );
		curObjectDoc = OpenDoc( UrlFromDocID( curObjectID ) );
		curObject = curObjectDoc.TopElem;
	}

	curForumEntryID = null;
	
	Server.Execute( "include/head.html" );
	Server.Execute( "include/access_init.html" );
}

if ( Request.QueryString.HasProperty( 'remove_forum_id' ) )
{
	Server.Execute('forum_remove.html');
%>
<script LANGUAGE="JAVASCRIPT">
	document.location.href = "view_doc.html?doc_id=<%=curDocID%>";
</script>
<%
	Cancel();
}
	
if ( Request.QueryString.HasProperty( 'close_forum_id' ) )
	Server.Execute('forum_close.html');
%>
<script LANGUAGE="JAVASCRIPT">
function showimage( selector )
{
	var container = selector.parentNode;
	if(container==null) return false;
	var svalue = selector.options[selector.selectedIndex].value;
	if(svalue==null) return false;
	var tags = container.getElementsByTagName( "img" );
	if(tags.length==0) return false;
	tags[0].src = svalue;
	document.getElementById( "icon" ).value = svalue;
	return false;
}

function selectModerators()
{
	var pars=new Object();
	var strAttr="status:no;dialogWidth:780px;dialogHeight:550px;help:no;resizable:1";
	pars.selected_object_ids = "<%=ArrayMerge( curObject.moderators, 'moderator_id', ';' )%>";
	pars.can_be_empty = true;

	xShowModalDialog( 'dlg_select.html?doc_id=<%=curDocID%>&catalog_name=collaborator&typein=0&multi_select=1&rand='+ Math.random(), pars, strAttr );
	if ( ! pars.handle ) 
		return null;
		
	document.forms['forum_info'].elements['selected_object_ids'].value = pars.selected_object_ids;
	document.forms['forum_info'].submit();
}

//********************************************************************************************
function doSubmit()
{
<%
//Проверяем нужно ли сохранять форум
if ( Request.Form.HasProperty( 'saved_forum_id' )  )
{
	curObject.moderators.DeleteChilds( true );

	for ( moderator_id in Request.Form.selected_object_ids.split( ';' ) ) 
	{
		if ( Trim( moderator_id ) == '' ) 
			continue;
		moderator = curObject.moderators.AddChild();
		moderator.moderator_id = moderator_id;
		tools.common_filling( 'collaborator', moderator, Int(moderator_id) );
	}
	curObject.name = Request.Form.forum_name;
	
	curObjectDoc.Save();
}

%>

}
//*************************************************************************************************

function forum_remove_confirm() 
{
	return confirm(<%=CodeLiteral( tools_web.get_web_str('vfb_request2remove_forum') )%>);
}
function forum_close_confirm() 
{
	return confirm(<%=CodeLiteral( tools_web.get_web_str('vfb_request2close_forum') )%>);
}


var curForumEntryID = null;
function themeRemove(iForumEntryID)
{
	if ( curForumEntryID != null || ! confirm(<%=CodeLiteral( tools_web.get_web_str('vfb_request2remove_theme') )%>) )
		return false;

	$("#div_edit_"+iForumEntryID).hide();
	$("#div_close_"+iForumEntryID).hide();
	$("#div_delete_"+iForumEntryID).hide();
	ajax.showLoader("div_loader_"+iForumEntryID);
	curForumEntryID = iForumEntryID;
	ajax.post("forum_entry_change.html","","ajax=1&action=remove&object_id=<%=curObjectID%>&doc_id=<%=curDocID%>&sid=<%=tools.get_sum_sid( curDocID )%>&forum_entry_id="+iForumEntryID,"html",onForumThemeDelete);
	return false;
}
function themeClose(iForumEntryID) 
{
	if ( curForumEntryID != null || ! confirm(<%=CodeLiteral( tools_web.get_web_str('vfb_request2close_theme') )%>) )
		return false;
		
	$("#div_edit_"+iForumEntryID).hide();
	$("#div_close_"+iForumEntryID).hide();
	ajax.showLoader("div_loader_"+iForumEntryID);
	curForumEntryID = iForumEntryID;
	ajax.post("forum_entry_change.html","","ajax=1&action=close&object_id=<%=curObjectID%>&doc_id=<%=curDocID%>&sid=<%=tools.get_sum_sid( curDocID )%>&forum_entry_id="+iForumEntryID,"html",onForumThemeClose);
	return false;
}

function onForumThemeClose(sResult)
{
	ajax.hideLoader("div_loader_"+curForumEntryID);
	if (sResult=='')
	{
		$("#div_close_"+curForumEntryID).show();
	}
	else
	{
		alert(sResult);
		$("#div_edit_"+curForumEntryID).show();
	}
	curForumEntryID = null;
}
function onForumThemeDelete(sResult)
{
	if (sResult=='')
	{
		$("table#table_forum_themes tr#tr_theme_"+curForumEntryID).remove();
	}
	else
	{
		alert(sResult);
		$("#div_delet_"+curForumEntryID).show();
		ajax.hideLoader("div_loader_"+curForumEntryID);
	}
	curForumEntryID = null;
}
</script> 


<%
_show_edit_panel = Request.QueryString.HasProperty("edit_panel") && Request.QueryString.edit_panel == "1";

if ( curUser.access.access_role == 'admin' )
{
%>
<div align=right>
<a href="<%=tools_web.get_query_string( true, 'edit_panel;' ) + '&edit_panel=' + ( _show_edit_panel ? '0' : '1' )%>"><%=_show_edit_panel ? tools_web.get_web_str('vfb_hide_edit_panel') : tools_web.get_web_str('vfb_show_edit_panel')%> </a>
</div>
<%
	if ( _show_edit_panel )
	{
%>
<form id="forum_info" name="forum_info" action="<%=Request.Url%>" method="post" onSubmit="doSubmit()">
	<input type=hidden name="doc_id" id="doc_id_id" value="<%=curDocID%>"/>
	<input type=hidden name="saved_forum_id" id="saved_forum_id" value="<%=curObjectID%>"/>
	<input type=hidden name="sid" id="sid_id" value="<%=tools.get_sum_sid( curDocID )%>"/>
	<input type=hidden name="selected_object_ids" value="<%=ArrayMerge(curObject.moderators, 'This.PrimaryKey', ';');%>"/>
	
	
	<table cellspacing=1 cellpadding=5 width="100%" border=0>
			<tr valign=top>
				<td align=right width="150px"> <%=tools_web.get_web_str('c_name')%>:</td>
				<td>
				<input name="forum_name" type="text" value="<%=XmlAttrEncode( curObject.name )%>" style="width:100% ">
				</td>
			</tr>
			<tr valign=top>
				<td align=right width="150px">	<%=tools_web.get_web_str('vfb_moderators')%>:	</td>
				<td>
				<table width="100%"  border="0" cellspacing="0" cellpadding="3">	
					<tr>
						<td class="tableHeaderWithText"><%=tools_web.get_web_str('c_fio')%></td>
						<td class="tableHeaderWithText" width="200"><%=tools_web.get_web_str('uf_main_position')%></td>
						<td class="tableHeaderWithText" width="200"><%=tools_web.get_web_str('uf_main_subdivision')%></td>
						<td class="tableHeaderWithText" width="200"><%=tools_web.get_web_str('uf_main_org')%></td>
					</tr>
					<tr>
						<td class="tableHeaderNoText" colspan=4><img src="pics/1blank.gif" width="1" height="1" />&nbsp;</td>
					</tr>	
<%
					counter = 0;
					for ( _person in curObject.moderators )
					{
						_class = counter++ % 2 ? 'tableRowEven' : 'tableRowOdd';
%>				
						<tr valign="MIDDLE">
							<td class="<%=_class%>"> <%=_person.person_fullname%> </td>
							<td class="<%=_class%>"> <%=_person.person_position_name%> </td>
							<td class="<%=_class%>"> <%=_person.person_subdivision_name%> </td>
							<td class="<%=_class%>"> <%=_person.person_org_name%> </td>
						</tr>
<%					
					}
%>				
					<tr>
						<td class="tableFooter" colspan=4><img src="pics/1blank.gif" width="1" height="1" />&nbsp;</td>
					</tr>
				</table>
				<br>
				<center><input type="button" value="<%=tools_web.get_web_str( 'veb_b7' )%>" onClick="selectModerators()" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';"></center>
				</td>
			</tr>			
	</table>
	<br>
	<table width="100%" border="0" cellspacing="0" cellpadding="0" class="activator">
		<tr>
			<TD ALIGN="CENTER" class="activator">
				<input type="submit" value="<%=tools_web.get_web_str('c_save')%>" onClick="" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';">
				&nbsp;&nbsp;&nbsp;&nbsp;
				<input type="button" value="<%=tools_web.get_web_str('vfb_close_forum')%>" onClick="if ( forum_close_confirm() ) document.location.href = '<%=Request.Url%>&close_forum_id=<%=curObjectID%>'" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';">
				&nbsp;&nbsp;&nbsp;&nbsp;
				<input type="button" value="<%=tools_web.get_web_str('vfb_remove_forum')%>" onClick="if ( forum_remove_confirm()) document.location.href = '<%=Request.Url%>&remove_forum_id=<%=curObjectID%>'" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';">
			</TD>	
		</tr>
	</table>	
</form>
<%
	}
}

Server.Execute( "view_desc.html" );
%>
<br/>
<%
if ( tools_web.is_forum_readed(curObjectID, curUserID) ) 
{
%>
	<a href="forum_unread.html?doc_id=<%=curDocID%>&unread_forum_id=<%=curObjectID%>&object_id=<%=curObjectID%>"><%=tools_web.get_web_str('vfb_unread_forum')%></a>
<%
}
%>

<table id="table_forum_themes" width="100%" border="0" cellspacing="0" cellpadding="3">
	<tr>
		<td colspan="5"><img src="pics/1blank.gif" width="1" height="1"/></td>
		<form action="view_doc.html?mode=search" method="post">
		<td width="150">
			<input type="hidden" name="search_catalogs" value="forum_entrys"/>
			<input type="text" name="word" value="" class="inputEdit" style="width: 100px"/>
			<input type="submit" value="<%=tools_web.get_web_str('c_search')%>" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';">
		</td>
		</form>
	</tr>
	<tr>
		<td class="tableHeaderWithText" width="15">:)</td>
		<td class="tableHeaderWithText"><%=tools_web.get_web_str('vfb_subject')%></td>
		<td class="tableHeaderWithText" width="200"><%=tools_web.get_web_str('vfb_author')%></td>
		<td class="tableHeaderWithText" width="50"><%=tools_web.get_web_str('vfb_entry_num')%></td>
		<td class="tableHeaderWithText" width="120"><%=tools_web.get_web_str('vfb_act')%></td>
		<td class="tableHeaderWithText" width="150"><%=tools_web.get_web_str('c_additional')%></td>
	</tr>
	<tr>
		<td class="tableHeaderNoText" colspan="6"><img src="pics/1blank.gif" width="1" height="1"/></td>
	</tr>	
<%
	counter = 0;
	xarrForumEntry = XQuery( 'for $elem in forum_entrys where $elem/forum_id = ' + curObjectID + ' and $elem/parent_forum_entry_id = null() order by $elem/pinned descending, $elem/last_create_date descending return $elem' );
	for ( catForumEntryElem in xarrForumEntry )
	{
		teForumEntry = OpenDoc( UrlFromDocID( catForumEntryElem.id ) ).TopElem;
		
		if ( ! tools_web.is_privilege_collaborator( catForumEntryElem.id, curUser, curUserID, teForumEntry ) ) 
			continue;

		// узнать прочитана ли тема
		isRead = ArrayOptFirstElem( XQuery( 'for $elem in forum_theme_read_by_collaborators where $elem/person_id= ' + curUserID + ' and $elem/forum_theme_id = ' + catForumEntryElem.id + ' return $elem' ) ) != undefined;

		_class = counter++ % 2 ? 'tableRowEven' : 'tableRowOdd';
		pinned_style = catForumEntryElem.pinned ? 'style="font-weight:bold;"' : '';
%>
	<tr valign="middle" id="tr_theme_<%=catForumEntryElem.id%>">
		<td class="<%=_class%>" width="15"><img src="<%=catForumEntryElem.icon_id.ForeignElem.url%>" width="13" height="11"></td>
		<td class="<%=_class%>" <%=pinned_style%>>
<%
		if ( _noheader == '1' )
			_href = "view_forum_entry_body"+((global_settings.settings.show_forum_entry_as_list)?'_line':'')+".html?object_id=" + curObjectID + "&entry_id=" + catForumEntryElem.id + "&noheader=";
		else
			_href = "view_doc.html?mode=forums&object_id=" + curObjectID + "&entry_id=" + catForumEntryElem.id + "&doc_id=" + curDocID;
%>
				<a href="<%=_href%>"><%=HtmlEncode( catForumEntryElem.name )%></a>
<%
		if ( ! isRead )
		{
%>
			&nbsp;<img src="pics/new.gif">
<%
		}
%>
		</td>
		<td class="<%=_class%>" <%=pinned_style%>><%=catForumEntryElem.author_info%></td>
		<td class="<%=_class%>" <%=pinned_style%> align="CENTER" width="50"><%=( catForumEntryElem.child_num == null ? '0' : catForumEntryElem.child_num )%></td>
		<td class="<%=_class%>" <%=pinned_style%> align="CENTER" width="120"><%=( catForumEntryElem.last_create_date == null ? StrDate( catForumEntryElem.create_date, true, false ) : StrDate( catForumEntryElem.last_create_date, true, false ) )%></td>
		<td class="<%=_class%>" <%=pinned_style%> align="CENTER" width="150">
<%
		div_close_style = 'inline';
		div_edit_style = 'inline';
		if ( tools_web.check_forum_entry_access( catForumEntryElem, curUser, curUserID, curObject ) )
		{
%>
			<div id="div_delete_<%=catForumEntryElem.id%>" style="display:<%=( curObject.allow_user_delete ? 'inline' : 'none' )%>"><a onclick="themeRemove('<%=catForumEntryElem.id%>')" href="#"><%=tools_web.get_web_str('vfb_remove_theme')%></a></div><br/>
<%
			if ( catForumEntryElem.closed )
			{
				div_edit_style = 'none';
			}
			else
			{
				div_close_style = 'none';
				div_edit_style = curObject.allow_edit ? 'inline' : 'none';
			}
		} 
		else 
		{
			div_close_style = catForumEntryElem.closed ? 'inline' : 'none';
			div_edit_style = 'none';
		}
%>
			<div id="div_edit_<%=catForumEntryElem.id%>" style="display:<%=div_edit_style%>">
				<a onclick="themeClose('<%=catForumEntryElem.id%>')" href="#"><%=tools_web.get_web_str('vfb_close_theme')%></a><br/>
				<a href="view_doc.html?mode=forums&object_id=<%=curObjectID%>&entry_id=<%=catForumEntryElem.id%>&doc_id=<%=curDocID%>&edit=1"><%=tools_web.get_web_str('vfb_edit_theme')%></a><br/>
			</div>
			<div id="div_close_<%=catForumEntryElem.id%>" style="display:<%=div_close_style%>"><%=tools_web.get_web_str('vfb_end_discus')%></div>
			<div id="div_loader_<%=catForumEntryElem.id%>"/>
		</td>
	</tr>
<%
	}
%>
	<tr>
		<td class="tableFooter" colspan="6"><img src="pics/1blank.gif" width="1" height="1"/></td>
	</tr>
</table>
<br/>
<%
if ( ! curObject.closed )
	Server.Execute( "view_forum_theme_edit.html" )
%>
<br/>
<%
curKnowlegedDoc = curObject;
Server.Execute( "view_knowledge_parts_body.html" );
%>