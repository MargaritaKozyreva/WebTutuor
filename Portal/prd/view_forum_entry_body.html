<%
_noheader = '0';
if ( Request.QueryString.HasProperty( 'noheader' ) )
{
	_noheader = '1';
	
	Server.Execute( "include/access_init.html" );
	
	curObjectID = null;
	if ( Request.QueryString.HasProperty( 'object_id' ) )
		curObjectID = Int( Request.QueryString.object_id );
	else 
		if ( Request.QueryString.HasProperty( 'forum_id' ) )
			curObjectID = Int( Request.QueryString.forum_id );

	if ( curObjectID != null )
		curObject = OpenDoc( UrlFromDocID( curObjectID ) ).TopElem;
		
	curForumEntryID = Int( Request.QueryString.entry_id );
	curForumEntry = OpenDoc( UrlFromDocID( curForumEntryID ) ).TopElem;
}

if ( ! tools_web.is_privilege_collaborator( curForumEntryID, curUser, curUserID, curForumEntry ) ) 
{
	Server.Execute( "view_access_panel.html" );
	Cancel();
}

curMainForumEntryID = tools.get_main_forum_entry_by_forum_entry_id( curForumEntryID, curForumEntry );
if ( curMainForumEntryID != curForumEntryID )
	curMainForumEntry = OpenDoc( UrlFromDocID( curMainForumEntryID ) ).TopElem;
else
	curMainForumEntry = curForumEntry;

if ( ArrayOptFirstElem( XQuery( 'for $elem in forum_theme_read_by_collaborators where $elem/person_id = ' + curUserID + ' and $elem/forum_theme_id = ' + curMainForumEntryID + ' return $elem' ) ) == undefined ) 
{
	docForumThemeRead = OpenNewDoc( 'x-local://wtv/wtv_forum_theme_read_by_collaborator.xmd' );
	docForumThemeRead.TopElem.forum_id = curObjectID;
	docForumThemeRead.TopElem.forum_theme_id = curMainForumEntryID;
	docForumThemeRead.TopElem.person_id = curUserID;
	docForumThemeRead.BindToDb( DefaultDb );
	docForumThemeRead.Save();
}

curPage = Request.QueryString.HasProperty( 'cur_page' ) && Request.QueryString.cur_page != '' ? Int( Request.QueryString.cur_page ) : 1;
curViewType = Request.QueryString.HasProperty( 'view_type' ) && Request.QueryString.view_type != '' ? Request.QueryString.view_type : (curObject.default_view_type.HasValue ? curObject.default_view_type: 'longtree');
bShortFlag = curViewType == 'shorttree';
curUrl = tools_web.get_query_string( true, "remove_entry_id;remove;app;edit;cur_page;view_type" );
bIsModerator = tools_web.is_moderator_forum( curObjectID, curUserID, curObject );

oRegExp = tools_web.reg_exp_init();
%>

<script language="JavaScript" src="scripts/tooltip/wz_tooltip_late.js"></script>
<script language="JAVASCRIPT">
isEditBody = false;

function setContent( sContentParam )
{
<%
if ( curObject.allow_rich_text_edit )
{
%>	
	tinyMCE.get("content_id").setContent( sContentParam );
<%
}
else
{
%>	
	$( "#content_id" ).val( sContentParam );
<%
}
%>
}
function getContent()
{
<%
if ( curObject.allow_rich_text_edit )
{
%>	
	return tinyMCE.get("content_id").getContent();
<%
}
else
{
%>	
	return $( "#content_id" ).val();
<%
}
%>
}


function showMessage( iForumEntryIDParam, sModeParam )
{
	if ( ! isAlreadyMessWrote() )
		return;

	switch ( sModeParam )
	{
		case 'edit':
			$( "#forum_entry_id_id" ).val( iForumEntryIDParam );
			$( "#title_id" ).val( $( "#CL_topicname_" + iForumEntryIDParam ).html() );
			setContent( $( "#CL_forum_topic_content_" + iForumEntryIDParam ).html() );
			break;

		case 'replay':
			$( "#parent_forum_entry_id_id" ).val( iForumEntryIDParam );
			$( "#title_id" ).val( "Re: " + $( "#CL_topicname_" + iForumEntryIDParam ).html() );
			setContent( "[quote][b]" + $( "#CL_forum_topic_author_name_" + iForumEntryIDParam ).html() + ":[/b]<br/>" + $( "#CL_forum_topic_content_" + iForumEntryIDParam ).html() + "[/quote]" );
			break;
	}

	isEditBody = true;
    $("html,body").animate( { scrollTop: $("#ans_id").offset().top }, 500 );
}

function isAlreadyMessWrote() 
{
	if ( isEditBody )
		return ( confirm( <%=CodeLiteral( tools_web.get_web_str( 'vfb_message_confirm' ) )%> ) );
	return true;
}

function doSubmitForum(mode)
{
	switch(mode)
	{
		case "add_forum_subscript":
			$("#add_forum_subscription_div").hide();
			$("#del_forum_subscription_div").hide();
			ajax.showLoader("forum_subscription_td");
			ajax.post("subscription_create.html","","ajax=1&subscription_type=forum&document_id=<%=curObjectID%>&doc_id=<%=curDocID%>&sid=<%=tools.get_sum_sid( curDocID )%>","html",onForumSubscriptionCreate);
			break;

		case "del_forum_subscript":
			$("#add_forum_subscription_div").hide();
			$("#del_forum_subscription_div").hide();
			ajax.showLoader("forum_subscription_td");
			ajax.post("subscription_delete_query.html","","ajax=1&document_id=<%=curObjectID%>&doc_id=<%=curDocID%>&sid=<%=tools.get_sum_sid( curDocID )%>","html",onForumSubscriptionDelete);
			break;
			
		case "add_entry_subscript":
			$("#add_entry_subscription_div").hide();
			$("#del_entry_subscription_div").hide();
			ajax.showLoader("entry_subscription_td");
			ajax.post("subscription_create.html","","ajax=1&subscription_type=forum_entry&document_id=<%=curMainForumEntryID%>&doc_id=<%=curDocID%>&sid=<%=tools.get_sum_sid( curDocID )%>","html",onEntrySubscriptionCreate);
			break;

		case "del_entry_subscript":
			$("#add_entry_subscription_div").hide();
			$("#del_entry_subscription_div").hide();
			ajax.showLoader("entry_subscription_td");
			ajax.post("subscription_delete_query.html","","ajax=1&document_id=<%=curMainForumEntryID%>&doc_id=<%=curDocID%>&sid=<%=tools.get_sum_sid( curDocID )%>","html",onEntrySubscriptionDelete);
			break;
	}
	return false;
}

function onForumSubscriptionCreate(sResult)
{
	ajax.hideLoader("forum_subscription_td");
	if ( sResult == '' )
	{
		$("#del_forum_subscription_div").show();
	}
	else
	{
		alert(sResult);
		$("#add_forum_subscription_div").show();
	}
}
function onForumSubscriptionDelete(sResult)
{
	ajax.hideLoader("forum_subscription_td");
	if ( sResult == '' )
	{
		$("#add_forum_subscription_div").show();
		$("#entry_subscription_area").show();
	}
	else
	{
		alert(sResult);
		$("#del_forum_subscription_div").show();
	}
}
function onEntrySubscriptionCreate(sResult)
{
	ajax.hideLoader("entry_subscription_td");
	if ( sResult == '' )
	{
		$("#del_entry_subscription_div").show();
	}
	else
	{
		alert(sResult);
		$("#add_entry_subscription_div").show();
	}
}



function onEntrySubscriptionDelete(sResult)
{
	ajax.hideLoader("entry_subscription_td");
	if ( sResult == '' )
	{
		$("#add_entry_subscription_div").show();
	}
	else
	{
		alert(sResult);
		$("#del_entry_subscription_div").show();
	}
}

function check_content( target )
{
<%
	if ( ! curUser.personal_config.nick.HasValue )
	{
%>
	if ( $("#how2show").val() == "nick" )
	{
		alert( <%=CodeLiteral( tools_web.get_web_str('vfeb_nick_mess') )%> );
		return;
	}
<%
	}
%>

	var max_title_len = 1000;
	var max_content_len = 10000;
	
	var _title = document.getElementById( "title_id" ).value;
	var _content = getContent();

	if ( _title == '' )
		alert( <%=CodeLiteral( tools_web.get_web_str( "vfb_message1" ) )%> );
	else if ( _title.length > max_title_len )
			alert( String( <%=CodeLiteral( tools_web.get_web_str( "vfb_message2" ) )%> ).replace( /{param1}/g, _title.length - max_title_len ) );				
		else if ( _content == '' )
				alert(  <%=CodeLiteral( tools_web.get_web_str( "vfb_message3" ) )%> );
			else if ( _content.length > max_content_len )
					alert( String( <%=CodeLiteral( tools_web.get_web_str( "vfb_message4" ) )%> ).replace( /{param1}/g, _title.length - max_content_len ) );
				else
					document.getElementById( "message_id" ).submit();
}

function showimage( selector )
{
	var container = selector.parentNode;
	if(container==null) return false;
	var svalue = selector.options[selector.selectedIndex].value;
	if(svalue==null) return false;
	var tags = container.getElementsByTagName( "img" );
	if(tags.length==0) return false;
	tags[0].src = svalue;
	document.getElementById( "icon" ).value = svalue;
	return false;
}
</script>

<%
function writeHierTopic( iForumEntryIDParam, teForumEntryParam, sIndentParam, bCloseFlagParam )
{
%>
<tr>
	<td width="100%" valign="top">
	
	<table cellspacing="0" cellpadding="0" width="100%" border="0">
	<tbody>
		<tr>
<%
	Response.Write( sIndentParam );
%>
			<td width="100%">
<%
	writeAnswerBlock( iForumEntryIDParam, teForumEntryParam, bCloseFlagParam );
%>
			</td>
		</tr>
	</tbody>
	</table>
	
	</td>
</tr>
<%
}

function writeHierLine( iForumEntryIDParam, catForumEntryParam, sIndentParam  )
{
%>
	<tr>
		<td class="CL_forum_list_outer" align="middle">&nbsp;
<%
	if ( iForumEntryIDParam == curForumEntryID )
	{
%>
		<img height=11 src="pics/current.gif" width=13 border=0>
<%
	}
%>
		</td>
		<td class=CL_forum_list_outer align=middle><img src="<%=curLngCommon.forum_icon_types.GetChildByKey( catForumEntryParam.icon_id ).url%>" border=0 title="<%=curLngCommon.forum_icon_types.GetChildByKey( catForumEntryParam.icon_id ).name%>"></td>
		<td class=CL_forum_list_outer>
			<table cellspacing=0 cellpadding=0 width="100%" border=0>
			<tbody>
				<tr>
<%
		Response.Write( sIndentParam );
%>				
					<td width="100%">
<%
	if ( iForumEntryIDParam == curForumEntryID )
	{
%>
					<b><%=HtmlEncode( catForumEntryParam.name )%></b>
<%
	}
	else
	{
		if (curObject.need_moder_approval == false || catForumEntryParam.is_moder_approved)
		{
%>
					<a href="view_doc.html?mode=forums&doc_id=<%=curDocID%>&object_id=<%=curObjectID%>&entry_id=<%=iForumEntryIDParam%>&view_type=<%=curViewType%>&cur_page=<%=curPage%>"><%=HtmlEncode( catForumEntryParam.name )%></a>
<%
		}
		else if (bIsModerator)
		{
%>
					<a href="view_doc.html?mode=forums&doc_id=<%=curDocID%>&object_id=<%=curObjectID%>&entry_id=<%=iForumEntryIDParam%>&view_type=<%=curViewType%>&cur_page=<%=curPage%>"><font color="red"><%=HtmlEncode( catForumEntryParam.name )%></font></a>
<%
		}
		else
		{
%>
                    <b><%=tools_web.get_web_str('vfeb_mes_moder')%></b>
<%
		}
	}
%>
					</td>
				</tr>
			</tbody>
			</table>
			</td>
			<td class=CL_forum_list_outer align=left>&nbsp;<%=catForumEntryParam.author_info%></td>
			<td class=CL_forum_list_outer align=center><%=catForumEntryParam.create_date%></td>
		</td>
	</tr>
<%
}


function writeAnswerBlock( iForumEntryIDParam, teForumEntryParam, bCloseFlagParam )
{
%>
	<a name="ans_<%=iForumEntryIDParam%>"/>
	<table cellspacing="0" cellpadding="0" width="100%" border="0">
	<tbody>
		<tr valign="top">
			<td class="CL_forum_answer_form_table">
				<table cellspacing="0" cellpadding="0" width="100%" border="0">
					<tr>
						<td class="CL_forum_topic_author">
<%
	Response.Write( tools_web.get_web_str('vfb_author') + ":&nbsp;" );
	
	_user_line = "";
	avatar = "";
	_status = "";
	try
	{
		tePersonEntry = OpenDoc( UrlFromDocID( teForumEntryParam.user_id ) ).TopElem;
		
		if ( teForumEntryParam.how2show != "anonymous" && curObject.disp_user_avatar ) 
		{
			if ( curObject.disp_foto )
			{
				avatar_filename = tePersonEntry.pict_url;
				avatar = tePersonEntry.pict_url.HasValue ? "<img src=\"http://" + curHost + avatar_filename + "\" border=0><br>" : "";
			}
			else
			{
				avatar_filename = tePersonEntry.personal_config.avatar_filename;
				avatar = tePersonEntry.personal_config.avatar_filename.HasValue ? "<img src=\"http://" + curHost + "/avatars/"+avatar_filename+"\" border=0><br>" : "";
			}
		}
		
		if ( teForumEntryParam.how2show == "realname" )
		{
			_tip_html = '<b>' + tools_web.get_web_str('c_fio') + ':</b>&nbsp;' + HtmlEncode( tePersonEntry.fullname ) + '<br/>';
			_tip_html += '<b>' + tools_web.get_web_str('c_position') + ':</b>&nbsp;' + HtmlEncode( tePersonEntry.position_name ) + '<br/>';
			_tip_html += '<b>' + tools_web.get_web_str('c_subd') + ':</b>&nbsp;' + HtmlEncode( tePersonEntry.position_parent_name ) + '<br/>';
			_tip_html += '<b>' + tools_web.get_web_str('c_org') + ':</b>&nbsp;' + HtmlEncode( tePersonEntry.org_name );
			_user_line = '<a id=CL_forum_topic_author_name_' + iForumEntryIDParam + ' href="view_doc.html?mode=collaborator&object_id=' + teForumEntryParam.user_id + '&doc_id=' + curDocID + '" onmouseover="Tip(' + CodeLiteral( _tip_html ) + ',SHADOW,true,BGCOLOR,\'whitesmoke\')">' + tePersonEntry.fullname + '</a>';
		}
		else
		{
			_user_line = '<span id=CL_forum_topic_author_name_' + iForumEntryIDParam + '>' + teForumEntryParam.author_info( tePersonEntry ) + '</span>';
		}

		if ( curObject.disp_user_status )
			_status = tools_web.get_web_str( 'c_status' )  + ": " +  tePersonEntry.personal_config.status + "<br/>";
	}
	catch( err )
	{
		alert( err );
	}

	Response.Write( _user_line + "<br/>" + _status + avatar );
%>
						</td>
					</tr>
					<tr>
						<td class="CL_forum_topic_date">
							<%=tools_web.get_web_str('c_date')%>:&nbsp;<%=StrDate( teForumEntryParam.create_date, true, false )%>
						</td>
					</tr>
				</table>
				<img src="pics/1blank.gif" width="200" height="0" border="0"/>
			</td>
			<td width="100%" class="CL_forum_answer_form_table">
<%
		if ( curObject.need_moder_approval == false || teForumEntryParam.is_moder_approved )
		{
%>
				<table cellspacing="0" cellpadding="0" width="100%" border="0">
					<tr>
						<td class="CL_forum_topic_name">
							<img src="<%=curLngCommon.forum_icon_types.GetChildByKey( teForumEntryParam.icon_id ).url%>" border=0 title="<%=curLngCommon.forum_icon_types.GetChildByKey( teForumEntryParam.icon_id ).name%>"/>&nbsp;<b><span id="CL_topicname_<%=iForumEntryIDParam%>"><%=HtmlEncode( teForumEntryParam.name )%></span></b>
						</td>
					</tr>
					<tr>
						<td class="CL_forum_topic_body">
							<div class="CL_forum_topic_content" id="CL_forum_topic_content_<%=iForumEntryIDParam%>"><%=tools_web.convert_bbcode_to_html( teForumEntryParam.text_area, oRegExp )%></div>
						</td>
					</tr>
				</table>
<%
			if ( curObject.can_attach_file )
			{
				if ( curForumEntryID == iForumEntryIDParam ) dispDelete = true;
					
				curFilesDoc = teForumEntryParam;
				Response.Write("<div id='files_list_area_"+iForumEntryIDParam+"'>")
				Server.Execute("view_files.html");
				Response.Write("</div>");
				dispDelete = false;
			}
		}
		else if ( bIsModerator )
		{
%>
			<font color="red">
				<img src="<%=curLngCommon.forum_icon_types.GetChildByKey( teForumEntryParam.icon_id ).url%>" border=0 title="<%=curLngCommon.forum_icon_types.GetChildByKey( teForumEntryParam.icon_id ).name%>"/>&nbsp;<b><span id="CL_topicname_<%=iForumEntryIDParam%>"><%=HtmlEncode( teForumEntryParam.name )%></span></b>
				<hr/>
				<%=tools_web.convert_bbcode_to_html(teForumEntryParam.text_area,oRegExp)%>
			</font><br/>
<%
			if (curObject.can_attach_file)
			{
				if (curForumEntryID == iForumEntryIDParam) dispDelete = true;
					
				curFilesDoc = teForumEntryParam;
				Server.Execute("view_files.html");
				dispDelete = false;
			}
		}
		else
		{
%>
                    <b><%=tools_web.get_web_str('vfeb_mes_moder')%></b>
<%
		}	
%>
			</td>
		</tr>
		<tr>
			<td class="CL_forum_topic_answer" colspan="2">
<%
if ( curObject.need_moder_approval == false || teForumEntryParam.is_moder_approved )
{
	if ( bCloseFlagParam )
	{
		Response.Write( tools_web.get_web_str( 'vfb_end_discus' ) );
	}
	else
	{
%>
<%
		_delete = "";
		_close = "";
		if ( tools_web.check_forum_entry_access( teForumEntryParam, curUser, curUserID, curObject ) )
		{
			if ( teForumEntryParam.parent_forum_entry_id.HasValue )
			{
				_delete = '<a onclick="confirm(' + CodeLiteral( tools_web.get_web_str( 'vfb_request2remove_topic' ) ) + ')" href="view_doc.html?mode=forums&entry_id=' + curMainForumEntryID + '&object_id=' + curObjectID + '&remove_entry_id=' + iForumEntryIDParam + '&doc_id=' + curDocID + '&remove=1&view_type=' + curViewType + '">' + tools_web.get_web_str('vfb_remove_topic') + '</a>'; 
			}
			else 
			{
				_close = '<a onclick="confirm(' + CodeLiteral( tools_web.get_web_str( 'vfb_request2close_theme' ) ) + ')" href="view_doc.html?mode=forums&object_id=' + curObjectID + '&close_entry_id=' + iForumEntryIDParam + '&doc_id=' + curDocID + '&close=1">' + tools_web.get_web_str('vfb_close_theme') + '</a>';
				_delete = '<a onclick="confirm(' + CodeLiteral( tools_web.get_web_str( 'vfb_request2remove_theme' ) ) + ')" href="view_doc.html?mode=forums&object_id=' + curObjectID + '&remove_entry_id=' + iForumEntryIDParam + '&doc_id=' + curDocID + '&remove=1&view_type=' + curViewType + '">' + tools_web.get_web_str('vfb_remove_theme') + '</a>';
			}
			
			if ( curUser.access.access_role != "admin" && ! curObject.allow_user_delete && !bIsModerator )
				_delete = "";
%>
			<%=_close%>&nbsp;&nbsp;&nbsp;<%=_delete%>&nbsp;&nbsp;&nbsp;
<%
			if ( curObject.allow_edit )
			{
%>			
			<a href="javascript: showMessage('<%=iForumEntryIDParam%>','edit')"><%=( teForumEntryParam.parent_forum_entry_id.HasValue ? tools_web.get_web_str('vfb_edit_mes') : tools_web.get_web_str( 'vfb_edit_theme' ) )%></a>&nbsp;&nbsp;&nbsp;
<%			
			}
		}

		if ( tools_web.is_privilege_collaborator( iForumEntryIDParam, curUser, curUserID, teForumEntryParam ) )
		{
%>
			<a href="javascript: showMessage('<%=iForumEntryIDParam%>','replay')"><%=tools_web.get_web_str('vfb_submit')%></a>
<%
		}
	}
}
else if ( bIsModerator )
{
%>
		<a onclick="return topic_remove_confirm()" href="view_doc.html?mode=forums&object_id=<%=curObjectID%>&entry_id=<%=(teForumEntryParam.parent_forum_entry_id.HasValue? curMainForumEntryID: "")%>&doc_id=<%=curDocID%>&cur_page=<%=curPage%>&view_type=<%=curViewType%>&remove_entry_id=<%=iForumEntryIDParam%>"><%=tools_web.get_web_str('vfb_remove_topic')%></a>&nbsp;&nbsp;&nbsp;
		<a onClick="var iResp = parseInt( $.ajax({type: 'POST', url: 'document_save.html',  data: 'ajax=1&data_0_id=<%=iForumEntryIDParam%>&data_0_source_fields=is_moder_approved&data_0_destination_fields=true',async: false}).responseText); if (isNaN(iResp) == false && iResp > 0) {$(this).hide(); $('#moderok<%=iForumEntryIDParam%>').show(); } else {window.alert(<%=CodeLiteral( tools_web.get_web_str('vfeb_err_post') )%>);} return false;" href="#">
				<%=tools_web.get_web_str('vdb_approve')%>
		</a>&nbsp;&nbsp;&nbsp;
		<span id="moderok<%=iForumEntryIDParam%>" style="display: none"><img src="pics/ok.gif"/>&nbsp;<font color="green"><b><%=tools_web.get_web_str('vdb_approved')%></b></font></span>
<%
}
else Response.Write("&nbsp;");
%>
			</td>
		</tr>	
	</tbody>
	</table>
<%
}
%>

<form id="message_id" name="message" action="forum_add.html" method="post" enctype="<%=( curObject.can_attach_file ? "multipart/form-data":"application/x-www-form-urlencoded")%>">
	
<table border="0" cellspacing="0" cellpadding="0" width="100%" class="forumTopicTable">
	<tr>
		<td>
		
		<table id="CL_forum_mode_switch" width="100%" cellspacing="0" cellpadding="0" border="0">
		<tbody>
			<tr>
				<td width="100%">
					<select name="view_select" id="select_view_type" onChange="window.location.href='<%=curUrl%>&cur_page=<%=curPage%>&view_type='+this.value;return false;">
						<option value="longtree"><%=tools_web.get_web_str('vfb_view_all')%></option>
						<option value="shorttree"><%=tools_web.get_web_str('vfb_view_short')%></option>
						<option value="type"><%=tools_web.get_web_str('vfb_view_line')%></option>
					</select>
<script language="javascript">
selcur=document.getElementById("select_view_type");
selcur.selectedIndex==-1;
for (i=0;i<selcur.options.length;i++)
    if (selcur.options[i].value=="<%=curViewType%>") {
        selcur.selectedIndex=i;
		break;
    }
</script>
				</td>
<%
	if ( curObject.permit_subscription )
	{
		catSubscription = ArrayOptFirstElem( XQuery( "for $elem in subscriptions where $elem/person_id = " + curUserID + " and $elem/document_id = " + curObjectID + " return $elem" ) );
		catSubscriptionEntry = ArrayOptFirstElem( XQuery( "for $elem in subscriptions where $elem/person_id = " + curUserID + " and $elem/document_id = " + curMainForumEntryID + " return $elem" ) );
%>
				<td align="right">
					<nobr>
						<%=tools_web.get_web_str('vfeb_submition')%>:&nbsp;
						<div id="add_forum_subscription_div" style="display:<%=( catSubscription == undefined ? 'inline' : 'none' )%>"><input type="button" value="<%=tools_web.get_web_str('vfb_add_subscript')%>" onclick="doSubmitForum('add_forum_subscript')" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';"/></div>
						<div id="del_forum_subscription_div" style="display:<%=( catSubscription != undefined ? 'inline' : 'none' )%>"><input type="button" value="<%=tools_web.get_web_str('vfb_del_subscript')%>" onclick="doSubmitForum('del_forum_subscript')" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';"/></div>
						<div id="forum_subscription_td"></div>
					</nobr>
				</td>
				<td align="right" id="entry_subscription_area" style="display:<%=( catSubscription == undefined || catSubscriptionEntry != undefined ? 'inline' : 'none' )%>">
					<nobr>
						<%=tools_web.get_web_str('vfeb_submition_theme')%>:&nbsp;
						<div id="add_entry_subscription_div" style="display:<%=( catSubscriptionEntry == undefined ? 'inline' : 'none' )%>"><input type="button" value="<%=tools_web.get_web_str('vfb_add_subscript')%>" onclick="doSubmitForum('add_entry_subscript')" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';"/></div>
						<div id="del_entry_subscription_div" style="display:<%=( catSubscriptionEntry != undefined ? 'inline' : 'none' )%>"><input type="button" value="<%=tools_web.get_web_str('vfb_del_subscript')%>" onclick="doSubmitForum('del_entry_subscript')" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';"/></div>
						<div id="entry_subscription_td"></div>
					</nobr>
				</td>
<%
	}
%>
			</tr>
		</tbody>
		</table>

		</td>
	</tr>
<%
	if ( bShortFlag )
		writeHierTopic( curForumEntryID, curForumEntry, '', curForumEntry.closed );
	else
		writeHierTopic( curMainForumEntryID, curMainForumEntry, '', curMainForumEntry.closed );
%>
	<tr>
		<td>

		<table cellspacing="0" cellpadding="0" width="100%" border="0">
		<tbody>
<%
	if ( bShortFlag )
	{
%>
			<tr>
				<td class="CL_forum_list_header" align=middle width="22"><b>v</b></td>
				<td class="CL_forum_list_header" align=middle width="22"><b>:)</b></td>
				<td class="CL_forum_list_header"><b><%=tools_web.get_web_str('vfb_subject')%></b></td>
				<td class="CL_forum_list_header" align=center width="25%"><b><%=tools_web.get_web_str('vfb_author')%></b></td>
				<td class="CL_forum_list_header" align=center width="150"><b><%=tools_web.get_web_str('c_date')%></b></td>
			</tr>
<%
	}
	
	
	
	
	
	
	
	
	
	xarrForumEntryAnswer = ArraySort(XQuery("CatalogHierSubset('forum_entrys'," + curMainForumEntryID + ")"), "create_date", "+");
	iForumEntryAnswerCount = ArrayCount(xarrForumEntryAnswer);
	
	_mess_max_num = curWebCommon.count_forum_entry_page;
	_start_index = 0;
	_end_index = (iForumEntryAnswerCount > _mess_max_num ? _mess_max_num : iForumEntryAnswerCount);

	if (curPage != 1)
	{
		_start_index = _mess_max_num*(curPage - 1);
		_end_index = (iForumEntryAnswerCount > _mess_max_num*curPage ? _mess_max_num*curPage : iForumEntryAnswerCount);
	}
	
	arrIdentStr = Array();
	iLastHLevel = null;
	i = 0;

	function vPrintForumEntry(catForumEntryAnsweElem, iHLevel, bLastFlag)
	{
		if (i >= _end_index) return;
		
		if (curViewType == 'type')
		{
			if (i >= _start_index)
			{
				writeHierTopic(catForumEntryAnsweElem.id, OpenDoc(UrlFromDocID(catForumEntryAnsweElem.id)).TopElem, "", (catForumEntryAnsweElem.closed ? true : curMainForumEntry.closed));
			}
		}
		else
		{
			if (i >= _start_index)
			{
				sLastIdentStr = '';
				for (j=0; j<iHLevel; j++)
					sLastIdentStr += arrIdentStr[ j ];
				sLastIdentStr += '<td valign="top" align="left"' + (bLastFlag ? '' : ' background="pics/tree_vx.gif"') + '><img src="pics/tree_fx.gif" width="20" height="17" border="0"></td>'; 
					
				if (bShortFlag)
					writeHierLine(catForumEntryAnsweElem.id, catForumEntryAnsweElem, sLastIdentStr);
				else
					writeHierTopic(catForumEntryAnsweElem.id, OpenDoc(UrlFromDocID( catForumEntryAnsweElem.id)).TopElem, sLastIdentStr, (catForumEntryAnsweElem.closed ? true : curMainForumEntry.closed));
			}

			iLastHLevel = iHLevel;
			arrIdentStr[ iLastHLevel ] = bLastFlag ? '<td valign="top" align="left"><img src="pics/zerro.gif" width="20" height="17" border="0"></td>' : '<td valign="top" align="left" background="pics/tree_vx.gif"><img src="pics/tree_vx.gif" width="20" height="17" border="0"></td>';
		}
		i++;
		if (curViewType != "type")
		{
			arrSubSelectedEntries = ArraySelectByKey(xarrForumEntryAnswer, catForumEntryAnsweElem.PrimaryKey,"parent_forum_entry_id");
			var iSubBackCounter = ArrayCount(arrSubSelectedEntries) - 1;
			for (catSubForumEntryElem in arrSubSelectedEntries)
			{
				vPrintForumEntry(catSubForumEntryElem, iHLevel+1 ,(iSubBackCounter == 0));
				iSubBackCounter--;
			}
		}
	}
	
	if (curViewType != "type")
		arrSelectedEntries = ArraySelectByKey(xarrForumEntryAnswer, curMainForumEntryID,"parent_forum_entry_id");
	else
		arrSelectedEntries = xarrForumEntryAnswer;
	
	var iBackCounter = ArrayCount(arrSelectedEntries) - 1;
	for (catForumEntryElem in arrSelectedEntries)
	{
		vPrintForumEntry(catForumEntryElem, 0 ,(iBackCounter == 0));
		iBackCounter--;
	}

	
	
	
	
	
	/* -------------- ORIGINAL ---------------------------
	
	
	xarrForumEntryAnswer = ArrayDirect( XQuery( "CatalogHierSubset('forum_entrys'," + curMainForumEntryID + ")" ) );
	iForumEntryAnswerCount = ArrayCount( xarrForumEntryAnswer );
		
	_mess_max_num = curWebCommon.count_forum_entry_page;
	_start_index = 0;
	_end_index = ( iForumEntryAnswerCount > _mess_max_num ? _mess_max_num : iForumEntryAnswerCount );

	if ( curPage != 1 )
	{
		_start_index = _mess_max_num*(curPage - 1);
		_end_index = ( iForumEntryAnswerCount > _mess_max_num*curPage ? _mess_max_num*curPage : iForumEntryAnswerCount );
	}
	
	arrIdentStr = Array();
	iLastHLevel = null;
	
	for ( i=0; i<_end_index; i++ )
	{
		catForumEntryAnsweElem = xarrForumEntryAnswer[ i ];
		
		if ( curViewType == 'type' )
		{
			if ( i < _start_index )
				continue;

			writeHierTopic( catForumEntryAnsweElem.id, OpenDoc( UrlFromDocID( catForumEntryAnsweElem.id ) ).TopElem, '', ( catForumEntryAnsweElem.closed ? true : curMainForumEntry.closed ) );
		}
		else
		{
			iHLevel = xarrForumEntryAnswer[ i ].__hlevel;
			bLastFlag = true;
			for ( j=i+1; j<iForumEntryAnswerCount; j++ )
			{
				if ( xarrForumEntryAnswer[ j ].__hlevel < iHLevel )
					break;

				if ( xarrForumEntryAnswer[ j ].__hlevel == iHLevel )
				{
					bLastFlag = false;
					break;
				}
			}
			
			if ( i >= _start_index )
			{
				sLastIdentStr = '';
				for ( j=0; j<iHLevel; j++ )
					sLastIdentStr += arrIdentStr[ j ];
				sLastIdentStr += '<td valign="top" align="left"' + ( bLastFlag ? '' : ' background="pics/tree_vx.gif"' ) + '><img src="pics/tree_fx.gif" width="20" height="17" border="0"></td>'; 
					
				if ( bShortFlag )
					writeHierLine( catForumEntryAnsweElem.id, catForumEntryAnsweElem, sLastIdentStr );
				else
					writeHierTopic( catForumEntryAnsweElem.id, OpenDoc( UrlFromDocID( catForumEntryAnsweElem.id ) ).TopElem, sLastIdentStr, ( catForumEntryAnsweElem.closed ? true : curMainForumEntry.closed ) );
			}

			iLastHLevel = iHLevel;
			arrIdentStr[ iLastHLevel ] = bLastFlag ? '<td valign="top" align="left"><img src="pics/zerro.gif" width="20" height="17" border="0"></td>' : '<td valign="top" align="left" background="pics/tree_vx.gif"><img src="pics/tree_vx.gif" width="20" height="17" border="0"></td>';
		}
	}

	 ------------- END ORIGINAL--------------- */
	
	
	
	
	
	
	
	
	
	
	pages = ( iForumEntryAnswerCount / _mess_max_num ) + ( ( iForumEntryAnswerCount % _mess_max_num > 0 ) ? 1 : 0 );
%>
		</tbody>
		</table>
		</td>
	</tr>
	<tr>
		<td width="100%" valign="top" align="center">
<%
	for ( i = 1; i <= pages; i++ )
	{
		if ( pages == 1 )
			break;

		if ( curPage == i ) 
		{
%>
			<%=i%>&nbsp;
<%
		}
		else
		{
%>
			<a href="<%=curUrl%>&view_type=<%=curViewType%>&cur_page=<%=i%>"/><%=i%></a>&nbsp;
<%
		}
	}
%>
		</td>
	</tr>
</table>


	<input type=hidden name="doc_id" id="doc_id_id" value="<%=curDocID%>"/>
	<input type=hidden name="sid" id="sid_id" value="<%=tools.get_sum_sid( curDocID )%>"/>
	<input type=hidden name="cur_page" id="cur_page" value="<%=curPage%>"/>
	<input type=hidden name="view_type" id="view_type" value="<%=curViewType%>"/>
	<input type=hidden name="forum_id" id="forum_id_id" value="<%=curObjectID%>"/>
	<input type=hidden name="forum_entry_id" id="forum_entry_id_id" value=""/>
	<input type=hidden name="parent_forum_entry_id" id="parent_forum_entry_id_id" value="<%=curForumEntryID%>"/>
	<input type=hidden name="main_forum_entry_id" id="main_forum_entry_id" value="<%=curMainForumEntryID%>"/>
	<input type=hidden name="noheader" id="noheader_id" value="<%=_noheader%>"/>
	
	<input type=hidden name="privilege_collaborators" value=""/>
	

<a id="ans_id"></a>
<%
if ( ! curForumEntry.closed )
{
%>
<table cellspacing="0" cellpadding="0" width="100%" border="0">
	<tr>
		<td class="CL_forum_answer_form_table">
		
		<h4 align=center><%=tools_web.get_web_str( 'vfb_title' )%></h4>
		<table cellspacing=1 cellpadding=0 width="100%" border=0>
			<tr>
				<td class="CL_forum_form_row" align="right" width="30%"><b><%=tools_web.get_web_str('vfb_subject')%>:</b></td>
				<td class="CL_forum_form_row"><input type="text" name="title" id="title_id" class="inputEdit" style="width: 300px" onkeypress="if ( window.event.keyCode == 13 ) return false;"></td>
			</tr>
			<tr>
				<td class="CL_forum_form_row" align="right"><b><%=tools_web.get_web_str('vfb_text')%>:</b></td>
				<td class="CL_forum_form_row">

<%
	if ( curObject.allow_rich_text_edit )
	{
		curTinymcePluginsType = 'bbcode';
		Server.Execute( "view_tinymce.html" );
	}
%>
					<textarea id="content_id" name="content" style="width:600px;height:200px" richtext="true"></textarea>
				</td>
			</tr>
<%
	if ( ! curObject.allow_rich_text_edit )
	{
%>
			<tr>
				<td class="CL_forum_answer_form_table">&nbsp;</td>
				<td class="CL_forum_answer_form_table">
<script language="javascript">
function vReplaceContentText(sReplaceWithThat, bForceInsert)
{
	var eContentArea = $("textarea:#content_id").get(0);
	//var iStartPos = eContentArea.selectionStart;
	//var iEndPos = eContentArea.selectionEnd;
	eContentArea.focus();
	var docRange = document.selection.createRange();
	if (docRange.parentElement() === eContentArea)
	//if (docRange.text.length != 0)
		docRange.text = sReplaceWithThat.replace(/\{\%s\%\}/g, docRange.text);
}
</script>
					<input type="button" value=" B " class="inputButton" onmouseover="this.className='inputButtonOver';" onmouseout="this.className='inputButton';" onclick="vReplaceContentText('[b]{%s%}[/b]')" style="font-weight: bold"/>
					<input type="button" value=" I " class="inputButton" onmouseover="this.className='inputButtonOver';" onmouseout="this.className='inputButton';" onclick="vReplaceContentText('[i]{%s%}[/i]')" style="font-style: italic"/>
					<input type="button" value=" U " class="inputButton" onmouseover="this.className='inputButtonOver';" onmouseout="this.className='inputButton';" onclick="vReplaceContentText('[u]{%s%}[/u]')" style="text-decoration: underline"/>
					<input type="button" value=" S " class="inputButton" onmouseover="this.className='inputButtonOver';" onmouseout="this.className='inputButton';" onclick="vReplaceContentText('[s]{%s%}[/s]')" style="text-decoration: line-through"/>
					<input type="button" value=" IMG " class="inputButton" onmouseover="this.className='inputButtonOver';" onmouseout="this.className='inputButton';" onclick="var sLink = prompt('Picture url:', '') + ''; if (sLink != '') vReplaceContentText('[img]'+sLink+'[/img]');"/>
					<input type="button" value=" URL " class="inputButton" onmouseover="this.className='inputButtonOver';" onmouseout="this.className='inputButton';" onclick="var sLink = prompt('URL:', '') + ''; if (sLink != '') vReplaceContentText('[url]'+sLink+'[/url]');"/>
					<input type="button" value=" Size " class="inputButton" onmouseover="this.className='inputButtonOver';" onmouseout="this.className='inputButton';" onclick="var iSize = parseInt(prompt('Size:', '')); if (isNaN(iSize) == false) { if(iSize > 99) iSize = 99; if (iSize <6) iSize = 6; vReplaceContentText('[size='+iSize+']{%s%}[/size]');}"/>
					<input type="button" value=" Color " class="inputButton" onmouseover="this.className='inputButtonOver';" onmouseout="this.className='inputButton';" onclick="var sColor = prompt('Color:', ''); if (sColor) { vReplaceContentText('[color='+sColor+']{%s%}[/color]'); }"/>
				</td>
			</tr>
<%
	}
	if ( curObject.allow_anonymous_message )
	{
%>
			<tr>
				<td class="CL_forum_form_row" align="right"><%=tools_web.get_web_str('vfb_how_show_name')%>:</td>
				<td class="CL_forum_form_row">
					<select name="how2show" id="how2show">
<%
		for ( _info_type in curLngCommon.forum_person_info_types )
		{
%>							
						<option value="<%=_info_type.id%>"><%=_info_type.name%></option>
<%
		}
%>
					</select>
				</td>
			</tr>
<%
	}
	else
	{
%>
		<input type="hidden" value="realname" name="how2show" id="how2show"/>
<%
	}
%>
			<tr>
				<td class="CL_forum_form_row" align="right"><%=tools_web.get_web_str( 'vfb_image' )%>:</td>
				<td class="CL_forum_form_row">
					<select name="icon" id="icon_id" onchange="showimage( this ); return false;" class="basic">
<%
	for ( _icon_type in curLngCommon.forum_icon_types )
	{ 
%>
						<option value="<%=_icon_type.url%>"><%=_icon_type.name%></option>
<%
	}
%>
					</select>
					<img src="<%=curLngCommon.forum_icon_types[0].url%>" id="icon" name="icons" width="13" height="11" border=0 hspace=15>
				</td>
			</tr>
<%
	if ( ! curObject.allow_rich_text_edit )
	{
%>
			<tr>
				<td class=CL_forum_form_row valign=top align=right><%=tools_web.get_web_str('vfb_smile')%>:</td>
				<td class=CL_forum_form_row>
<%
		for ( _smile in curLngCommon.forum_smile_types )
		{ 
%>
					<img style="CURSOR: pointer" onclick="setContent(getContent()+this.alt)" src="<%=_smile.url%>" border="0" alt="<%=_smile.id%>"/>
<%
		}
%>
				</td>
			</tr>
<%
	}
	if ( curObject.can_attach_file )
	{
%>
			<tr>
				<td class="CL_forum_form_row" align="right"><%=tools.get_web_str('vdb_add_file')%>:&nbsp;</td>		
				<td class="CL_forum_form_row">
<%
		Server.Execute('view_file_add.html');
%>
				</td>
			</tr>
<%
		}
%>
			<tr>
				<td class=CL_forum_form_row>&nbsp;</td>
				<td class=CL_forum_form_row><input type="button" name="go" value="<%=tools_web.get_web_str('vfb_submit2')%>" onclick="check_content();" class="inputButton" onmouseover="this.className='inputButtonOver';" onmouseout="this.className='inputButton';"></td>
			</tr>
		</table>
		
		</td>
	</tr>
</table>
<%
}
%>
</form>
<%
if ( Request.Query.HasProperty( 'edit' ) && Request.Query.edit == '1' )
{
%>
<script language="javascript">
$(document).ready(function() {
var counter = 0;
var id;

function check_mess()
{
	id = undefined;
	if ( counter >= 10 )
		return;

	try
	{
		showMessage('<%=Request.Query.entry_id%>','edit');
		counter = 10;
	}
	catch ( err )
	{
	}
	counter++;
	id = setTimeout( check_mess, 500 );
}

check_mess();
});
</script>
<%
}
%>