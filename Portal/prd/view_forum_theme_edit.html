<%
view_type = Request.QueryString.HasProperty( 'view_type' ) ? Request.QueryString.view_type : '';
curPage = Request.QueryString.HasProperty( 'cur_page' ) ? Int( Request.QueryString.cur_page ) : 0;
%>
<script type=text/JavaScript>
function check_topic_content(  )
{	
	var max_title_len = 1000;
	var max_content_len = 10000;
	
	var _title = document.getElementById( "title_id" ).value;
<%
if ( curObject.allow_rich_text_edit )
{
%>	
	var _content = tinyMCE.get('content_id').getContent();
<%
}
else
{
%>	
	var _content = document.getElementById( 'content_id' ).value;
<%
}
%>	
	
	if ( _title == '' )
		alert( "<%=tools_web.get_web_str( 'vfb_message1' )%>" );
	else if ( _title.length > max_title_len )
			alert( String("<%=tools_web.get_web_str( 'vfb_message2' )%>").replace( /{param1}/g, _title.length - max_title_len ) );				
		else if ( _content == '' )
				alert( "<%=tools_web.get_web_str( 'vfb_message3' )%>" );
			else if ( _content.length > max_content_len )
					alert( String("<%=tools_web.get_web_str( 'vfb_message4' )%>").replace( /{param1}/g, _title.length - max_content_len ) );
				else
				{
					var _form = document.getElementById( "message" );
					_form.title.value = _title;
					_form.content.value = _content;
					_form.icon.value = document.getElementById( "icon_id" ).value;
					if ( document.getElementById( "_pinned" ) )
						_form.pinned.value = document.getElementById( "_pinned" ).checked;
					else
						_form.pinned.value = false;
					if (document.getElementById("howshow") != undefined ) 
					{
						_form.how2show.value = document.getElementById( "howshow" ).value;
					}
					
					_form.submit();
				}
}

var selected_object_ids = "<%=( curForumEntry > 0 ? ArrayMerge( curForumEntry.privilege_collaborators, 'collaborator_id', ';' ) : '' )%>";

function doSelect()
{	
		var pars=new Object();
		var strAttr="status:no;dialogWidth:780px;dialogHeight:550px;help:no;resizable:1";
		pars.selected_object_ids = selected_object_ids;
		pars.can_be_empty = true;
		pars.show_all = true;

		xShowModalDialog( 'dlg_select.html?doc_id=<%=curDocID%>&catalog_name=collaborator&typein=1&multi_select=1&rand='+ Math.random(), pars, strAttr );
		if ( ! pars.handle ) 
			return null;
			
		//document.message.selected_object_ids.value = pars.selected_object_ids;
		document.getElementById( 'selected_object_ids' ).value = pars.selected_object_ids;
		selected_object_ids = pars.selected_object_ids;
}

function doSubmitForum(mode,id)
{
	$("#add_subscription_div").hide();
	$("#del_subscription_div").hide();
	ajax.showLoader("subscription_td");

	switch(mode)
	{
		case "add_subscript":
			ajax.post("subscription_create.html","","ajax=1&subscription_type=forum&document_id=<%=curObjectID%>&doc_id=<%=curDocID%>&sid=<%=tools.get_sum_sid( curDocID )%>","html",onSubscriptionCreate);
			break;

		case "del_subscript":
			ajax.post("subscription_delete_query.html","","ajax=1&document_id=<%=curObjectID%>&doc_id=<%=curDocID%>&sid=<%=tools.get_sum_sid( curDocID )%>","html",onSubscriptionDelete);
			break;
	}
	return false;
}

function onSubscriptionCreate(sResult)
{
	ajax.hideLoader("subscription_td");
	if ( sResult == '' )
	{
		$("#del_subscription_div").show();
	}
	else
	{
		alert(sResult);
		$("#add_subscription_div").show();
	}
}
function onSubscriptionDelete(sResult)
{
	ajax.hideLoader("subscription_td");
	if ( sResult == '' )
	{
		$("#add_subscription_div").show();
	}
	else
	{
		alert(sResult);
		$("#del_subscription_div").show();
	}
}
</script>

<form id="message" name="message" action="forum_add.html" method="post" >
	<input type=hidden name="doc_id" id="doc_id_id" value="<%=curDocID%>"/>
	<input type=hidden name="sid" id="sid_id" value="<%=tools.get_sum_sid( curDocID )%>"/>
	<input type=hidden name="cur_page" id="cur_page" value="<%=curPage%>"/>
	<input type=hidden name="view_type" id="view_type" value="<%=view_type%>"/>
	<input type=hidden name="forum_id" id="forum_id_id" value="<%=curObjectID%>"/>
	<input type=hidden name="forum_entry_id" id="forum_entry_id_id" value="<%=curForumEntryID%>"/>
	<input type=hidden name="parent_forum_entry_id" id="parent_forum_entry_id_id" value=""/>
<%
	try
	{
		curMainForumEntryID;
	}
	catch(err)
	{
		curMainForumEntryID = "";
	}
%>	
	<input type=hidden name="main_forum_entry_id" id="main_forum_entry_id" value="<%=curMainForumEntryID%>"/>
	
	<input type=hidden name="noheader" id="noheader_id" value="<%=_noheader%>"/>
	<input type=hidden name="selected_object_ids" id="selected_object_ids" value=""/>
	
	<input type=hidden name="title" value=""/>
	<input type=hidden name="content" value=""/>
	<input type=hidden name="icon" value=""/>
	<input type=hidden name="pinned" value=""/>
	<input type=hidden name="how2show" value=""/>
</form>


<table cellspacing="0" cellpadding="0" width="100%" border="0">
<tbody>
	<tr>
		<td class="CL_forum_answer_form_table">
		
		<h4 align=center><%=tools_web.get_web_str('vfb_title')%></h4>
		<table cellspacing=1 cellpadding=0 width="100%" border=0>
		<tbody>
			<tr>
				<td class=CL_forum_form_row align=right width="30%"><b><%=tools_web.get_web_str('vfb_subject')%>:</b></td>
				<td class=CL_forum_form_row><input type="text" name="title" id="title_id" class="inputEdit" style="width: 300px" onkeypress="if ( window.event.keyCode == 13 ) return false;" value="<%=curForumEntryID ? curForumEntry.name : ''%>"></td>
			</tr>
			<tr>
				<td class=CL_forum_form_row  align=right><b><%=tools_web.get_web_str('vfb_text')%>:</b></td>
				<td class=CL_forum_form_row>
<%
	if ( curObject.allow_rich_text_edit )
	{
		curTinymcePluginsType = 'bbcode';
		Server.Execute( "view_tinymce.html" );
	}
%>				

				<textarea name="content" id="content_id" class="inputTextarea" style="width: 300px; height: 100px" richtext="true"><%=( curForumEntryID ? tools_web.get_web_desc( curForumEntry.text_area, UrlFromDocID( curForumEntryID ), "forum_entry.text_area" ) : '' )%></textarea>
	
				</td>
			</tr>
<%
	if ( ! curObject.allow_rich_text_edit )
	{
%>
			<tr>
				<td class=CL_forum_form_row valign=top align=right><%=tools_web.get_web_str('vfb_smile')%>:</td>
				<td class=CL_forum_form_row>
<%
		for ( _smile in curLngCommon.forum_smile_types )
		{ 
%>
					<img style="CURSOR: pointer" onclick="<%=(curObject.allow_rich_text_edit ? "tinyMCE.get('content_id').getContent() += this.alt;" : "document.getElementById( 'content_id' ).value += this.alt;")%>" src="<%=_smile.url%>" border="0" alt="<%=_smile.id%>">
<%
		}
%>
				</td>
			</tr>
<%
	}
%>
			<tr>
				<td class=CL_forum_form_row valign=top align=right><%=tools_web.get_web_str('vfb_image')%>:</td>
				<td class=CL_forum_form_row>
					<select name="icon" id="icon_id" onchange="showimage(this); return false;" class="basic">
<%
	for ( _icon_type in curLngCommon.forum_icon_types )
	{ 
%>
						<option value="<%=_icon_type.url%>"><%=_icon_type.name%></option>
<%
	}
%>
					</select>
					<img src="<%=curLngCommon.forum_icon_types[0].url%>" id="icon" name="icons" width="13" height="11" border=0 hspace=15>
				</td>
			</tr>
<%
	if ( curForumEntryID == null && curObject.permit_subscription )
	{
		catSubscription = ArrayOptFirstElem( XQuery( "for $elem in subscriptions where $elem/person_id = " + curUserID + " and $elem/document_id = " + curObjectID + " return $elem" ) );
		sSubscriptionID = catSubscription == undefined ? null : catSubscription.id;
%>
			<tr>
				<td class="CL_forum_form_row" align="right"><%=tools_web.get_web_str('vfeb_submition')%>:</td>
				<td class="CL_forum_form_row" id_="subscription_td">
					<div id="add_subscription_div" style="display:<%=( sSubscriptionID == null ? 'inline' : 'none' )%>"><input type="button" value="<%=tools_web.get_web_str('vfb_add_subscript')%>" onclick="doSubmitForum('add_subscript','')" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';"/>&nbsp;&nbsp;&nbsp;&nbsp;</div>
					<div id="del_subscription_div" style="display:<%=( sSubscriptionID != null ? 'inline' : 'none' )%>"><input type="button" value="<%=tools_web.get_web_str('vfb_del_subscript')%>" onclick="doSubmitForum('del_subscript','<%=sSubscriptionID%>')" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';"/>&nbsp;&nbsp;&nbsp;&nbsp;</div>
					<a href="view_doc.html?mode=subscriptions&doc_code=subscriptions&doc_id=<%=curDocID%>"><%=tools_web.get_web_str('vfte_submitions')%></a>
					<div id="subscription_td"></div>
				</td>
			</tr>
<%
	}

	if ( curObject.allow_create_pinned_theme )
	{
%>			
			<tr>
				<td class=CL_forum_form_row align=right><%=tools_web.get_web_str('vfb_theme_pinned')%></td>
				<td class=CL_forum_form_row><input type="checkbox" name="_pinned" id="_pinned" <%=(curForumEntryID>0 && curForumEntry.pinned) ? 'checked' : ''%> value=""></td>
			</tr>
<%
	}

	if ( curObject.allow_create_closed_theme )
	{
%>			
			<tr>
				<td class=CL_forum_form_row align=right><%=tools_web.get_web_str('vfb_list_priv_collaborator')%>:</td>
				<td class=CL_forum_form_row>
					<input type="button" value="<%=tools_web.get_web_str('veb_b7')%>" onClick="doSelect()" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';">
				</td>
			</tr>
<%
	}
			if ( curObject.allow_anonymous_message )
			{
				if (  curForumEntryID > 0 && curForumEntry.user_id == curUserID || Trim(curForumEntryID) == ''  ) 
				{
%>
					<tr>
						<td class=CL_forum_form_row align=right><%=tools_web.get_web_str('vfb_how_show_name')%>:</td>
						<td class=CL_forum_form_row>
							<form>
							<select name="howshow" id="howshow">
<%
							for ( _info_type in common.forum_person_info_types )
							{
								_selected = ( ( curForumEntryID > 0 && curForumEntry.how2show.HasValue && _info_type.id == curForumEntry.how2show ) || ( curForumEntryID == null && _info_type.id == curUser.personal_config.default_info_type ) ) ? "selected" : "";
%>							
								<option value="<%=_info_type.id%>" <%=_selected%>><%=_info_type.name%></option>
<%							
							}
%>
							</select>
							</form>
						</td>
					</tr>
<%
				}
			}
			else
			{
%>
				<input type="hidden" value="realname" name="howshow" id="howshow"/>
<%	
			}
%>

			<tr>
				<td class=CL_forum_form_row>&nbsp;</td>
				<td class=CL_forum_form_row><input type="button" name="go" value="<%=tools_web.get_web_str( 'vfb_submit2' )%>" onclick="check_topic_content();" class="inputButton" onmouseover="this.className='inputButtonOver';" onmouseout="this.className='inputButton';"></td>
			</tr>
		</tbody>
		</table>
		
		</td>
	</tr>
</tbody>
</table>
