<%


	try
	{
		curProject = OpenDoc( UrlFromDocID( Int( Request.QueryString.object_id ) ) ).TopElem;
	}
	catch(_fuck_)
	{
		curProject = null;
	}

if (curProject != null)
{

	curPurpose = undefined;
	if (Request.QueryString.HasProperty("purpose_id") && Request.QueryString.purpose_id != "")
		curPurpose = curProject.purposes.GetOptChildByKey(Request.QueryString.purpose_id);


	try
	{
		curItem = OpenDoc( UrlFromDocID( Int(Request.QueryString.item_id) ) ).TopElem;
		curItemID = Request.QueryString.item_id;
	}
	catch(_vot_zaraza_)
	{
		curItem = null;
		curItemID = "";
	}
	
	
%>

<XML id="xml_item_data"><%=(curItem != null ? curItem.Xml : '')%></XML>

<script language="javascript">
<!--

function checkkey(srcobj, keycode, flag_flat)
{			
	if ((keycode<48 || keycode>57)& keycode!=46) return false;
	if (keycode==46) 
	{
		if( (!flag_flat) || srcobj.value.indexOf('.') >= 0) return false;
	}
	return true;
}

function addChild(flag_new)
{
		
	var tb = document.getElementById("recycler");
	var answers = xhierarchy.selectNodes('.//answers/answer');

	var counter = document.getElementById("answers_count");

	var cur_id = parseInt(counter.value);
	if (flag_new)
	{
		var _x_boundary = answers.length;
	}
	else
	{
		var _x_boundary = 1;
	}
	
	for (var _x = 0; _x < _x_boundary; _x++)	
	{
		var trow=document.createElement("TR");
		trow.setAttribute("id","answer_" + cur_id);
		trow.setAttribute("value",cur_id);
		trow.valign="middle";
		var trow=tb.insertAdjacentElement('beforeEnd',trow);
	
		_class = trow.rowIndex % 2 ? 'tableRowEven' : 'tableRowOdd';
			
		var tcol1=document.createElement("TD");
		tcol1.className = _class;
		var tcol1=trow.insertAdjacentElement('beforeEnd',tcol1);
		
		var tinput_qt=document.createElement('INPUT');
		tinput_qt.type='text'; 
		tinput_qt.className="inputEdit";
		tinput_qt.id='answer_question_text_' + cur_id;
		tinput_qt.name='answer_question_text_' + cur_id;
		tinput_qt.style.width="100%";
		if (flag_new)
		{
			tinput_qt.value = answers[_x].selectSingleNode("text").text;
		}
		var tinput_qt = tcol1.insertAdjacentElement('beforeEnd',tinput_qt);
		
		var tcol2=document.createElement("TD");
		tcol2.width="200px";
		tcol2.className = _class;
		tcol2.align = 'center';
		var tcol2=trow.insertAdjacentElement('beforeEnd',tcol2);
			
		var tinput_ica=document.createElement('INPUT');
		tinput_ica.type='checkbox';
		//tinput_ica.className="inputEdit";
		tinput_ica.id='answer_is_correct_answer_' + cur_id;
		tinput_ica.name='answer_is_correct_answer_' + cur_id;
		var tinput_ica = tcol2.insertAdjacentElement('beforeEnd',tinput_ica);
		
		if (flag_new)
		{
			if (parseInt(answers[_x].selectSingleNode("is_correct_answer").text ) )
			{
				tinput_ica.checked = true;
			}
		}
		
		var tcol3=document.createElement("TD");
		tcol3.width="100px";
		tcol3.className = _class;
		tcol3.align = 'center';
		var tcol3=trow.insertAdjacentElement('beforeEnd',tcol3);
		
		var tinput_delbut=document.createElement('INPUT');
		tinput_delbut.type='button'; 
		tinput_delbut.className="inputButton";
		tinput_delbut.id='answer_del_' + cur_id;
		tinput_delbut.name='answer_del_' + cur_id;
		tinput_delbut.style.width="20px";
		tinput_delbut.value="X";
		tinput_delbut.title="<%=tools.get_web_str('c_delete')%>";
		tinput_delbut.setAttribute("code", cur_id);
		tinput_delbut.attachEvent('onmouseleave', buttonMouseOut);
		tinput_delbut.attachEvent('onmouseenter', buttonMouseOver);
		tinput_delbut.attachEvent('onclick', deleteChild);
		var tinput_delbut = tcol3.insertAdjacentElement('beforeEnd',tinput_delbut);
		
		var tinput_upbut=document.createElement('INPUT');
		tinput_upbut.type='button'; 
		tinput_upbut.className="inputButton";
		tinput_upbut.id='answer_up_' + cur_id;
		tinput_upbut.name='answer_up_' + cur_id;
		tinput_upbut.style.width="20px";
		tinput_upbut.value= String.fromCharCode(0xE9) ;
		tinput_upbut.style.fontFamily = "Wingdings";
		tinput_upbut.title="<%=tools.get_web_str('c_move_up')%>";
		tinput_upbut.setAttribute("code", cur_id);
		tinput_upbut.attachEvent('onmouseleave', buttonMouseOut);
		tinput_upbut.attachEvent('onmouseenter', buttonMouseOver);
		tinput_upbut.attachEvent('onclick', moveRowUp);
		var tinput_upbut = tcol3.insertAdjacentElement('beforeEnd',tinput_upbut);
		
		var tinput_downbut=document.createElement('INPUT');
		tinput_downbut.type='button'; 
		tinput_downbut.className="inputButton";
		tinput_downbut.id='answer_down_' + cur_id;
		tinput_downbut.name='answer_down_' + cur_id;
		tinput_downbut.style.width="20px";
		tinput_downbut.value= String.fromCharCode(0xEA) ;
		tinput_downbut.style.fontFamily = "Wingdings";
		tinput_downbut.title="<%=tools.get_web_str('c_move_down')%>";
		tinput_downbut.setAttribute("code", cur_id);
		tinput_downbut.attachEvent('onmouseleave', buttonMouseOut);
		tinput_downbut.attachEvent('onmouseenter', buttonMouseOver);
		tinput_downbut.attachEvent('onclick', moveRowDown);
		var tinput_downbut = tcol3.insertAdjacentElement('beforeEnd',tinput_downbut);
			
		cur_id++;
	}	
	counter.value = cur_id;
}
//------------------------------------------------------------------------------------------
function deleteChild()
{
	var parent_tr=event.srcElement.parentNode.parentNode;
	var tobj=document.all.recycler;
		
	tobj.deleteRow(parent_tr.rowIndex);
			
	return true;
}
//------------------------------------------------------------------------------------------

function moveRowRoutine(tobj, _source_index, _dest_index, _parent_tr_value )
{
	var _s_className = tobj.rows[_source_index].children[0].className;
	var _d_className = tobj.rows[_dest_index].children[0].className;
	
	var _answer_check = document.getElementById("answer_is_correct_answer_" + _parent_tr_value);	
	var _answer_is_checked = _answer_check.checked;
		
	tobj.moveRow(_source_index, _dest_index);
	
	for(var _z = 0; _z < tobj.rows[_source_index].children.length; _z++)
	{
		tobj.rows[_source_index].children[_z].setAttribute("className",_s_className);
		tobj.rows[_dest_index].children[_z].setAttribute("className",_d_className);
	}
	_answer_check.checked = _answer_is_checked;
}

function moveRowDown()
{
	var _parent_tr=event.srcElement.parentNode.parentNode;
	var tobj=document.all.recycler;
	if (_parent_tr.rowIndex < tobj.rows.length + 1)
	{
		var _source_index = _parent_tr.rowIndex - 2;
		var _dest_index = _parent_tr.rowIndex - 1;
		
		moveRowRoutine(tobj, _source_index, _dest_index, _parent_tr.value );	
	}
}
function moveRowUp()
{
	var _parent_tr=event.srcElement.parentNode.parentNode;
		
	var tobj=document.all.recycler;
	if (_parent_tr.rowIndex > 2)
	{
		var _source_index = _parent_tr.rowIndex - 2;
		var _dest_index = _parent_tr.rowIndex - 3;
		
		moveRowRoutine(tobj, _source_index, _dest_index, _parent_tr.value );
	}
}

//------------------------------------------------------------------------------------------
function buttonMouseOver()
{
	window.event.srcElement.className='inputButtonOver';
}
function buttonMouseOut()
{
	window.event.srcElement.className='inputButton';
}

//------------------------------------------------------------------------------------------

function drawItemData()
{
	var _title = xhierarchy.selectSingleNode('.//title');
	if (_title != null)
		document.getElementById("title").value = _title.nodeTypedValue;
		
	var _question_text = xhierarchy.selectSingleNode('.//question_text');
	if (_question_text != null)
		document.getElementById("question_text").value = _question_text.nodeTypedValue;
	
	var _type_id = xhierarchy.selectSingleNode('.//type_id');
	if (_type_id != null)
	{
		var _t_elem = document.all.type_id;
		for (_i = 0; _i < _t_elem.length; _i++)
		{
			if(_t_elem[_i].value == _type_id.text) _t_elem[_i].checked = true;
		}

	}
	else
	{
		document.all.type_id[0].checked = true;
	}
	
	addChild(true);
}

//------------------------------------------------------------------------------------------
//#############################
function debuggg()
{
	var _s = "";
	
	var _rows=document.all.recycler.rows;
	
	for (var _i = 0; _i < _rows.length; _i++)
	{
		_s+= "#" + _rows[_i].rowIndex + ") " + _rows[_i].getAttribute("value") + "\n";
	}
	
	alert(_s);
	alert(xhierarchy.xml)

}
//#############################


//------------------------------------------------------------------------------------------
function what2submit()
{
	
	var _data_1_source_fields = document.all.data_1_source_fields
	var _data_1_destination_fields = document.all.data_1_destination_fields
	
	var _title = xhierarchy.selectSingleNode("//title");
	
	if (_title == null)
	{
		_title = xhierarchy.createElement("title");
		xhierarchy.documentElement.appendChild(_title);
	}
	
	_title.text = document.getElementById("title").value;
	
	_data_1_source_fields.value = "items.ObtainChildByKey({data_0_id}).title";
	_data_1_destination_fields.value = document.getElementById("title").value;
		
	var _question_text = xhierarchy.selectSingleNode("//question_text");
	if (_question_text == null)
	{
		_question_text = xhierarchy.createElement("question_text");
		xhierarchy.documentElement.appendChild(_question_text);
	}
	_question_text.text = document.getElementById("question_text").value;
	
	_data_1_source_fields.value += ";items.ObtainChildByKey({data_0_id}).question_text";
	_data_1_destination_fields.value += ";" + document.getElementById("question_text").value;
	
	
	var _type_id = xhierarchy.selectSingleNode("//type_id");
	
	if (_type_id == null)
	{
		_type_id = xhierarchy.createElement("type_id");
		xhierarchy.documentElement.appendChild(_type_id);
	}
	
	var _t_elem = document.all.type_id;
	for (var _i = 0; _i < _t_elem.length; _i++)
	{
		if( _t_elem[_i].checked == true)
		{
			_type_id.text = _t_elem[_i].value;
			break;
		}
		else
			_type_id.text = '';
	}
	
	_data_1_source_fields.value += ";items.ObtainChildByKey({data_0_id}).type_id";
	_data_1_destination_fields.value += ";" + _type_id.text;
	
	
	var _question_points = xhierarchy.selectSingleNode("//question_points");
	if (_question_points == null)
	{
		_question_points = xhierarchy.createElement("question_points");
		xhierarchy.documentElement.appendChild(_question_points);
	}
	_question_points.text = document.getElementById("question_points").value;
	
	_data_1_source_fields.value += ";items.ObtainChildByKey({data_0_id}).question_points";
	_data_1_destination_fields.value += ";" + _question_points.text;
		
	
	var _answers = xhierarchy.selectNodes("//answers");
	if (_answers != null)
		_answers.removeAll();

	var _answers = xhierarchy.createElement("answers");
	xhierarchy.documentElement.appendChild(_answers);
	
	var tobj=document.all.recycler;
	
	for (var _i = 0; _i < tobj.rows.length; _i++)
	{
		_id = tobj.rows[_i].value;
		var _answer_question_text = document.getElementById("answer_question_text_" + _id).value;
		var _answer_is_correct_answer = document.getElementById("answer_is_correct_answer_" + _id).checked;
		
		
		var _answer = xhierarchy.createElement("answer");
		_answers.appendChild(_answer);
		var _answer_id = xhierarchy.createElement("id");
		_answer_id.text = _i;
		_answer.appendChild(_answer_id);
		var _answer_qt = xhierarchy.createElement("text");
		_answer_qt.text = _answer_question_text;
		_answer.appendChild(_answer_qt);
				
		var _answer_ica = xhierarchy.createElement("is_correct_answer");
		if (_answer_is_correct_answer)
			_answer_ica.text = 1;
		else
			_answer_ica.text = 0;
		_answer.appendChild(_answer_ica);
		
	}
	
	_data_1_source_fields.value += ";items.ObtainChildByKey({data_0_id}).purpose_id";
	_data_1_destination_fields.value += ";" <%=(curPurpose != undefined ? "+ '" + curPurpose.PrimaryKey + "'" : "")%>;
	
	var _d = new Date();
	
	_data_1_source_fields.value += ";items.ObtainChildByKey({data_0_id}).create_date";
	_data_1_destination_fields.value += ";" + _d;
	
	_data_1_source_fields.value += ";items.ObtainChildByKey({data_0_id}).person_id";
	_data_1_destination_fields.value += ";<%=curUserID%>";
	
	_data_1_source_fields.value += ";items.ObtainChildByKey({data_0_id}).person_fullname";
	_data_1_destination_fields.value += ";<%=curUser.fullname%>";
	
	document.all.data_0_xml.value = xhierarchy.xml;
	
}
//------------------------------------------------------------------------------------------
xhierarchy = new ActiveXObject("Msxml.DOMDocument");
xhierarchy.async = false;
_xml_item_data = document.getElementById("xml_item_data").innerHTML;
if (_xml_item_data != "")
	xhierarchy.loadXML(_xml_item_data);
else
	xhierarchy.loadXML("<item></item>");


-->
</script>

<!--
<input type="button" onclick="debuggg()" value="DeBuG!" style="font-family:Wingdings" class="inputButton"/>
-->

<table width="100%"  border="0" cellspacing="0" cellpadding="3" name="top_report_table">
<tr>
<td>

<form name="item_submitter" id="item_submitter" action="document_save.html" method="post">
<input type="hidden" name="data_0_id" value="<%=curItemID%>"/>
<input type="hidden" name="data_0_xml" value=""/>
<input type="hidden" name="data_0_new" value="1"/>
<input type="hidden" name="data_0_xml_form" value="item"/>
<input type="hidden" name="data_1_id" value="<%=Request.QueryString.object_id%>"/>
<input type="hidden" name="data_1_source_fields" value=""/>
<input type="hidden" name="data_1_destination_fields" value=""/>

<input type="hidden" name="doc_id" value="<%=curDocID%>"/>
<input type="hidden" name="mode" value="test_project"/>
<input type="hidden" name="parameters" value="item_id=<%=curItemID%>&object_id=<%=Request.QueryString.object_id%>&purpose_id=<%=(curPurpose != undefined ? curPurpose.PrimaryKey : '')%>"/>

<table width="100%" cellspacing="0" cellpadding="4" class="tableBorder">
		<tr>
			<td style="font-weight:bolder; font-size:larger" width="200px"><%=tools.get_web_str('c_project')%>:</td>
			<td style="font-weight:bolder; font-size:larger"><%=curProject.name%></td>
		</tr>
<%
	if (curPurpose != undefined)
	{
%>
		<tr>
			<td style="font-weight:bolder; font-size:larger" width="200px"><%=tools.get_web_str('vsb_purpose')%>:</td>
			<td style="font-weight:bolder; font-size:larger"><%=curPurpose.name%></td>
		</tr>
<%
	}
%>
		<tr>
			<td style="font-weight:bolder; font-size:larger" width="200px"><%=tools.get_web_str('c_title')%>:</td>
			<td style="font-weight:bolder; font-size:larger"><input type="text" id="title" name="title" value="" class="inputEdit" style="width:90%"/></td>
		</tr>
		<tr>
			<td style="font-weight:bolder; font-size:larger" width="200px"><%=tools.get_web_str('c_question')%>:</td>
			<td style="font-weight:bolder; font-size:larger"><input type="text" id="question_text" name="question_text" value="" class="inputEdit" style="width:90%"/></td>
		</tr>
		<tr>
			<td style="font-weight:bolder; font-size:larger" width="200px"><%=tools.get_web_str('c_type')%>:</td>
			<td style="font-weight:bolder; font-size:larger"><input type="radio" id="type_id" name="type_id" value="multiple_choice" class="inputEdit"/> <%=tools.get_web_str('vicb_type_choice')%> &nbsp; &nbsp; <input type="radio" id="type_id" name="type_id" value="multiple_response" class="inputEdit"/> <%=tools.get_web_str('vicb_type_select')%></td>
		</tr>
		<tr>
			<td style="font-weight:bolder; font-size:larger" width="200px"><%=tools.get_web_str('c_score')%>:</td>
			<td style="font-weight:bolder; font-size:larger"><input type="text" id="question_points" name="question_points" value="" class="inputEdit" style="width:50px" onkeypress="return checkkey(this,window.event.keyCode, false);"/></td>
		</tr>
	</table>
	<p>
		<input type="button" value="<%=tools.get_web_str('vicb_add_answer')%>" class="inputButton" onmouseover="buttonMouseOver()" onmouseout="buttonMouseOut()" onclick="addChild(false);"/>
		<input type="hidden" id="answers_count" value="0"/>
	</p>
	
	
	<table width="100%"  border="0" cellspacing="0" cellpadding="3">
			
		<tr id="line_head">
			<td class="tableHeaderWithText"><%=tools.get_web_str('c_question')%></td>
			<td class="tableHeaderWithText" width="200px"><%=tools.get_web_str('c_answer')%></td>
			<td class="tableHeaderWithText" width="100px">#</td>
		</tr>
		<tr>
			<td class="tableHeaderNoText" colspan="3"><img src="pics/1blank.gif" width="1" height="1"/></td>
		</tr>	
		
		
		<tbody id="recycler">
							
					
		</tbody>
		<tr>
			<td colspan="3" class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td>
		</tr>
	</table>

	<br/>
		<center><input type="submit" value="<%=tools.get_web_str('c_save')%>" class="inputButton" onmouseover="buttonMouseOver()" onmouseout="buttonMouseOut()" onclick="return what2submit();"/></center>
	
</form>

<%
	_href = tools_web.get_url_protocol( Request.Url ) + Request.UrlHost + UrlPath( Request.Url ) + "?mode=test_project&doc_id="+curDocID+"&object_id=" + Request.QueryString.object_id + "&item_id=" + curItemID + "&purpose_id=" + (curPurpose != undefined ? curPurpose.PrimaryKey : '');
%>
<center><input type="button" value="<%=tools.get_web_str('vicb_back_project')%>" class="inputButton" onmouseover="buttonMouseOver()" onmouseout="buttonMouseOut()" onclick="window.location.href='<%=_href%>'"/></center>

<br/>

</td>
</tr>
<tr>
	<td colspan="3" class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td>
</tr>
</table>


<br/>


<script language="javascript">
<!--
	drawItemData();
-->
</script>


<%
}
else
{
	Response.Write("<br/><center><font color='red' style='font-weight: bolder; border:dotted; border-color:maroon' >" + tools.get_web_str('c_deleted') + "</font></center><br/>");
}
%>

								