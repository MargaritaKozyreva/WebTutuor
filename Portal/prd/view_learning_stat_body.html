<%
tempCurObject = curObject;
tempCurObjectID = curObjectID;
curObject = curCourse;
curObjectID = curCourseID;
Server.Execute( 'view_desc.html' );
curObject = tempCurObject;
curObjectID = tempCurObjectID;

	for ( _part in curCourse.parts )
		curObject.parts.ObtainChildByKey( _part.code );
	
	if ( curObject.state_id == 2 || curObject.state_id == 4 )
	{
%>
	<br/>
	<center><font size="3"><b><%=tools.get_web_str('vlpb_message4')%></b></font></center>
<%
	}
	
	if ( curCourse.start_after_finish )
	{
%>
<script language="JAVASCRIPT">
<!--
	var aTimer;
	var courseWindow;
		
	
	function refr()
	{
		clearTimeout( aTimer );
		
		if( courseWindow.closed )
		{
			_href = String( document.location.href );
			
			if ( _href.indexOf( 'start=' ) == -1 )
				document.location.reload();
			else
				document.location.href = _href.slice( 0, _href.indexOf( 'start=' ) - 1 );

			return;
		}
		
		aTimer = setTimeout( 'refr()', 2000 );
	}
	
	function course_launch( _width, _height, _index, _scrolling, _type )
	{
		if( screen.availWidth < _width || screen.availHeight < _height )
			alert("<%=tools.get_web_str('vcplb_message1')%>");
			
		if ( "<%=curCourse.view_type%>" == "structure" )	
		{
			document.location.href = "view_doc.html?mode=course_player&course_id=<%=curObject.course_id%>&object_id=<%=curObjectID%>" + ( _index != "" ? "&part_code=" + _index : "" );
		}
		else
		{
			if ( _type == "test" )
			{
				document.location.href = "view_doc.html?mode=test_learning_from_course_proc&doc_id=<%=curDocID%>&object_id=<%=curObjectID%>&part_code=" + _index;
			}
			else
			{
				courseWindow = window.open( 'course_launch.html?course_id=<%=curObject.course_id%>&object_id=<%=curObjectID%>&sid=<%=tools.get_sum_sid( curObject.course_id )%>' + ( _index != "" ? "&part_code=" + _index : "" ), 'win<%=curObjectID%>', 'toolbar=no,location=no,status=no,menubar=no,resizable=yes,directories=no,scrollbars=' + ( _scrolling ? 'yes' : 'no' ) + ',width=' + _width + ',height=' + _height );
				courseWindow.moveTo( 0, 0 );
				
				aTimer = setTimeout( 'refr()', 10000 );
			}
		}
	}
//-->
</script>	
<script language="JavaScript" type="text/javascript" src="scorm_api.js"></script>
<%
	}
%>
<br/>
<div class="headerText" style="margin-top:10px;margin-bottom:5px;margin-left:5px;"><%=tools.get_web_str('vlpb_title')%></div>
<table width="100%"  border="0" cellspacing="0" cellpadding="3">
	<tr>
		<td class="tableHeaderWithText"><%=tools.get_web_str('vlpb_part_name')%></td>
		<td class="tableHeaderWithText" width="120"><%=tools.get_web_str('vlpb_start_date')%></td>
		<td class="tableHeaderWithText" width="120"><%=tools.get_web_str('vlpb_finish_date')%></td>
		<td class="tableHeaderWithText" width="75"><%=tools.get_web_str('c_score')%></td>
		<td class="tableHeaderWithText" width="75"><%=tools.get_web_str('c_state')%></td>
	</tr>
	<tr>
		<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="1" height="1" /></td>
		<td class="tableHeaderNoText" width="120"><img src="pics/1blank.gif" width="1" height="1" /></td>					
		<td class="tableHeaderNoText" width="120"><img src="pics/1blank.gif" width="1" height="1" /></td>
		<td class="tableHeaderNoText" width="75"><img src="pics/1blank.gif" width="1" height="1" /></td>
		<td class="tableHeaderNoText" width="75"><img src="pics/1blank.gif" width="1" height="1" /></td>
	</tr>
<%
	var counter = 0;
	var _indent = '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;';
	
	function put_doc_xml( _code, _indent_str )
	{
		var _child_part_array = ArraySelect( curCourse.parts, 'parent_part_code == _code' );
		var _len = _child_part_array.length;
		var b = 0;
		
		for ( b = 0; b < _len; b++ )
		{
			_part_course = _child_part_array[b];			
			_class = counter++ % 2 ? 'tableRowEven' : 'tableRowOdd';
			
			w = _part_course.ChildIndex;
			_part = curObject.parts[w];
%>	
	<tr> 
		<td class="<%=_class%>"> 
		
		<table width="100%"  border="0" cellspacing="0" cellpadding="0">
			<tr>
<%
			if ( _indent_str != '' )
			{
%>	  
				<td nowrap="nowrap"><%=_indent_str%></td>
<%
			}
%>		
				<td nowrap="nowrap" valign="top" align="center" width="30"> 
<%			
			switch ( _part_course.type )
			{
				case 'lesson':
%>
					<img src="pics/lesson.gif" width="12" height="10" border="0"/>             
<%
				break;
				case 'test':
%>
					<img src="pics/test.gif" width="13" height="11" border="0"/>
<%	
				break;
				case 'inline':
%>
					<img src="pics/text.gif" width="13" height="11" border="0"/>
<%	
				break;				
				default:
%>
			 		<img src="pics/folder.gif" width="13" height="11" border="0"/>
<%
		}
%>
			</td>
				<td width="100%"><%=tools_web.get_cur_lng_name( _part_course.name )%></td>
			</tr>
		</table>

		</td>
		<td class="<%=_class%>" align="center" width="120"><%=( _part.start_usage_date != null ? StrDate( _part.start_usage_date, true, false ) : '-' )%></td>
		<td class="<%=_class%>" align="center" width="120"><%=( _part.last_usage_date != null ? StrDate( _part.last_usage_date, true, false ) : '-' )%></td>
		<td class="<%=_class%>" align="center" width="75"><%=_part.score%>&nbsp;<%=( curCourse.parts[w].max_score == null ? '' : '/ ' + curCourse.parts[w].max_score + ( curCourse.parts[w].max_score == 0 ? '' : ' ( ' + StrReal( _part.score * 100.0 / curCourse.parts[w].max_score, 0 ) + '% )' ) )%></td>
		<td class="<%=_class%>" align="center" width="75">
			<%=( _part.state_id.HasValue ? curLngCommon.learning_states.GetChildByKey( _part.state_id ).name : '' )%>
<%
			if ( curCourse.start_after_finish && ( _part_course.type == 'lesson' || _part_course.type == 'inline' ) )
			{
				_win_width = curCourse.Width( _part.code );
				_win_height = curCourse.Height( _part.code );
				_scrolling = curCourse.DispScrolling( _part.code );
%>
			<br/>
			<a href="#" onclick="course_launch( '<%=_win_width%>','<%=_win_height%>','<%=_part_course.code%>',<%=_scrolling%>,'<%=_part_course.type%>');"><%=tools.get_web_str('vlpb_next')%></a>
<%
			}
%>
		</td>
	</tr>
 <%
 			put_doc_xml( _part_course.code, _indent_str + _indent );
		} 
	}
	
	put_doc_xml( '', '' );
	
	
	for ( _event in curObject.events )
	{
		_class = counter++ % 2 ? 'tableRowEven' : 'tableRowOdd';
%>
	<tr valign="top"> 
<%
		try
		{
			_cur_event = _event.event_id.ForeignElem;
%>
		<td class="<%=_class%>">
		
		<table width="100%"  border="0" cellspacing="0" cellpadding="0">
			<tr valign="top">
				<td class="<%=_class%>" nowrap="nowrap"><img src=pics/event.gif border=0 width=16 height=16></td>
				<td class="<%=_class%>" width="100%"><%=tools_web.get_cur_lng_name( _cur_event.name )%> <%=StrDate( _cur_event.start_date, true, false )%></td>
			</tr>
		</table>
		  
		</td>
		<td class="<%=_class%>" align="center" width="120"><%=( _cur_event.start_date != null ? StrDate( _cur_event.start_date, true, false ) : '-' )%></td>
		<td class="<%=_class%>" align="center" width="120"><%=( _cur_event.finish_date != null ? StrDate( _cur_event.finish_date, true, false ) : '-' )%></td>
		<td class="<%=_class%>" align="center" width="75"><%=_event.score%></td>
		<td class="<%=_class%>" align="center" width="75"><%=curLngCommon.event_status_types.GetChildByKey( _cur_event.status_id ).name%></td>
<%
		}
		catch ( p )
		{
%>
		<td class="<%=_class%>" colspan="3"> <font color="#FF0033"><%=tools.get_web_str('c_deleted')%></font></td>
		<td class="<%=_class%>" align="center" width="75"><%=_event.score%></td>
		<td class="<%=_class%>" align="center" width="75">&nbsp;</td>
<%
		}
%>
	</tr>
 <%
	}
%>
	<tr>
		<td class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td>
		<td class="tableFooter" width="120"><img src="pics/1blank.gif" width="1" height="1" /></td>
		<td class="tableFooter" width="75"><img src="pics/1blank.gif" width="1" height="1" /></td>
		<td class="tableFooter" width="75"><img src="pics/1blank.gif" width="1" height="1" /></td>
		<td class="tableFooter" width="100"><img src="pics/1blank.gif" width="1" height="1" /></td>
	</tr>
				
	<tr valign="top"> 
		<td colspan=3 align=right><b><%=tools.get_web_str('vlpb_text4')%>:</b></td>
		<td align="left" colspan=2>&nbsp;<%=curObject.score%>&nbsp;<%=( curCourse.max_score == null ? '' : '/ ' + curCourse.max_score + ( curCourse.max_score == 0 ? '' : ' ( ' + StrReal( curObject.score * 100.0 / curCourse.max_score, 0 ) + '% )' ) )%></td>
	</tr>
</table>
<br>

<table width="100%" border="0" cellspacing="0" cellpadding="0" class="activator">
	<tr>
		<td width=33% align="CENTER" class="activator">
<%
	forumArray = XQuery( 'for $forum in forums where $forum/course_id = ' + curCourseID + ' return $forum' );
	if ( ArrayOptFirstElem( forumArray ) != undefined )
	{
	
%>		
			<a href="view_doc.html?mode=forums&object_id=<%=ArrayFirstElem( forumArray ).PrimaryKey%>&doc_id=<%=curDocID%>"><%=tools.get_web_str('vcorb_go_forum')%></a>
<%
	}
	
	responseArray = XQuery(" for $elem in responses where $elem/object_id = " + curCourseID + " and $elem/person_id = " + curUserID + " return $elem");
	if ( curCourse.default_response_type_id.HasValue && ArrayCount( responseArray ) == 0 )
	{
%>		
		<a href="#" onClick="document.location.href='view_doc.html?mode=response&doc_id=<%=curDocID%>&response_object_id=<%=curCourseID%>&response_type_id=<%=curCourse.default_response_type_id%>';return false;" CLASS="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';"><%=tools.get_web_str('c_text_create_response')%></a>
<%			
	}	
%>			
		</td>
	 </tr>
</table>
