
<link rel="stylesheet" href="/scripts/jqplugins/treeview/jquery.treeview.css"/>
<script src="/scripts/jqplugins/treeview/jquery.treeview.js" type="text/javascript"></script>
<%
_selectedTab = Request.Query.HasProperty("tab")&& Request.Query.GetProperty("tab")!="" ? Request.Query.tab : "library";
%>
<table width="100%" border="0" cellspacing="0" cellpadding="0">
	<tr>
		<td class="tab_td_empty"><img src="pics/1blank.gif" width="10" height="0"/></td>

		<td class="<%=(_selectedTab == "library" ? "tab_td_sel" : "tab_td")%>" id="td_0"><img src="pics/1blank.gif" width="140" height="0"/><br/><a style="text-decoration:none" href="<%=tools_web.get_query_string(true, "section_id;tab")%>tab=library">Библиотека</a></td>
		<td class="tab_td_empty" width="10px">&nbsp;</td>

		<td class="<%=(_selectedTab == "viewing" ? "tab_td_sel" : "tab_td")%>" id="td_1"><img src="pics/1blank.gif" width="140" height="0"/><br/><a style="text-decoration:none" href="<%=tools_web.get_query_string(true, "section_id;tab")%>tab=viewing">Мои материалы</a></td>
		<td class="tab_td_empty" width="10px">&nbsp;</td>
		
		<td class="<%=(_selectedTab == "search" ? "tab_td_sel" : "tab_td")%>" id="td_2"><img src="pics/1blank.gif" width="140" height="0"/><br/><a style="text-decoration:none" href="<%=tools_web.get_query_string(true, "section_id;tab")%>tab=search">Поиск</a></td>
		<td class="tab_td_empty" width="10px">&nbsp;</td>


		<td class="tab_td_empty" width="100%">&nbsp;</td>
	</tr>
</table>
<div style="padding: 5px">
<%
var sSectionHref = tools_web.get_query_string(true, "section_id");
	function __drawSection(catSectionPARAM, iParentSectionID, iDepthPARAM)
	{
		var _sHref=sSectionHref + "section_id=" + catSectionPARAM.PrimaryKey;
		Response.Write('<li><span class="librarySection"><a href="'+ _sHref + '">' + HtmlEncode(catSectionPARAM.name) + '</a></span>');
		if (iDepthPARAM > 10) return;

		var _xarrChildSections = XQuery("for $obj in library_sections where $obj/parent_object_id = " + catSectionPARAM.PrimaryKey + " order by $obj/name return $obj");
		var _catSectionElem;
		
		if(ArrayOptFirstElem(_xarrChildSections) != undefined)
		{
			Response.Write('<ul>');
			for (_catSectionElem in _xarrChildSections)
				__drawSection(_catSectionElem, catSectionPARAM.PrimaryKey, iDepthPARAM + 1);
			Response.Write('</ul>');
		}
		Response.Write('</li>');
	}
	
switch(_selectedTab)
{
	case "library":
%>
	<table border="0" cellpadding="0" cellspacing="4" width="100%">
		<tr>
			<td width="200px" style="vertical-align:top">
				<ul id="treeContainer" class="treeViewLibrary">
					<li><span class="librarySection"><a href="<%=sSectionHref%>section_id=all">Все материалы</a></span></li>
					<li><span class="librarySection"><a href="<%=sSectionHref%>section_id=recommended">Рекомендованные</a></span></li>
<%
		
		_xarrSections = XQuery("for $obj in library_sections where  $obj/parent_object_id = null() order by $obj/name return $obj");
		
		for (_catSection in _xarrSections)
			__drawSection(_catSection, null, 0);
%>
				</ul>
				<script type="text/javascript"> 
					$(function() {
						$("#treeContainer").treeview({
							collapsed: true,
							animated: "medium",
							persist: "location"
						});
					})
					
				</script> 
			</td>
			<td>
<%
		sSectionID = Request.QueryString.HasProperty("section_id") ? Request.QueryString.GetProperty("section_id") : "recommended";
		if(sSectionID == "recommended")
		{
			aOfIntMyGroupsID = ArrayExtract(XQuery("for $elem in group_collaborators where $elem/collaborator_id = " + curUserID + " return $elem"), "group_id");
			
			xarrMyGroups = XQuery("for $elem in group_collaborators where $elem/collaborator_id = " + curUserID + " return $elem");
			xarrMyMaterials = new Array();
			
			for(catGroup in xarrMyGroups)
			{
				teGroup = OpenDoc(UrlFromDocID(catGroup.group_id)).TopElem;
				for(catRecomendedMaterial in teGroup.recomended_library_materials)
				{
					xarrMyMaterials[ArrayCount(xarrMyMaterials)]=catRecomendedMaterial.PrimaryKey;
				}
			}
			alert(ArrayCount(xarrMyMaterials));
			xarrMyMaterials = ArraySelectDistinct(xarrMyMaterials);
			alert(ArrayCount(xarrMyMaterials));
			//xarrMyMaterials = QueryCatalogByKeys("library_materials","id",ArrayExtract(QueryCatalogByKeys("library_material_objects","object_id",aOfIntMyGroupsID), "library_material_id"));
			xarrMyMaterials = QueryCatalogByKeys("library_materials","id",xarrMyMaterials);
			
			curView = new Object;
			curView.SetProperty("title",'Рекомендованные материалы');
			curView.SetProperty("id", "library_materials_list");
			curView.SetProperty("catalog_name", "library_material");
			curView.SetProperty("array", xarrMyMaterials);
			curView.SetProperty("disp_link", "true");
			curView.SetProperty("disp_check_box", "false");
			curView.SetProperty( "disp_search", "false" );
			curView.SetProperty( "disp_filter", "false" );
			curView.SetProperty("list_columns", Array("name","author"));
			curView.SetProperty("list_headers", Array(tools.get_web_str('c_heading'),tools_web.get_web_str('vfb_author')));
			curView.SetProperty("link_field_index", "1");

			Server.Execute("view_catalog_list.html");
		}
		else if( sSectionID == "all" )
		{
			xarrMyMaterials = XQuery("for $elem in library_materials order by $elem/name return $elem");
			
			curView = new Object;
			curView.SetProperty("id", "library_material");
			curView.SetProperty("catalog_name", "library_material");
			curView.SetProperty("title", '');
			curView.SetProperty("array", xarrMyMaterials);
			curView.SetProperty("disp_link", "true");
			curView.SetProperty( "disp_search", "false" );
			curView.SetProperty( "disp_filter", "false" );
			curView.SetProperty("disp_check_box", "false");
			curView.SetProperty("list_columns", Array("name","author"));
			curView.SetProperty("list_headers", Array(tools.get_web_str('c_heading'),tools_web.get_web_str('vfb_author')));
			curView.SetProperty("link_field_index", "1");
			curView.SetProperty( "paging_size", 25 );

			Server.Execute("view_catalog_list.html");
		}
		else
		{
			teCurSection = OpenDoc(UrlFromDocID(Int(sSectionID))).TopElem;
			xarrMaterials = XQuery("for $elem in library_materials where $elem/section_id= " + sSectionID + " return $elem");						
			curView = new Object;
			curView.SetProperty("id", "library_materials_list");
			curView.SetProperty("catalog_name", "library_material");
			curView.SetProperty("title", "Раздел \"" + teCurSection.name + "\"");
			curView.SetProperty("array", xarrMaterials);
			curView.SetProperty("disp_link", "true");
			curView.SetProperty("disp_check_box", "false");
			curView.SetProperty( "disp_search", "false" );
			curView.SetProperty( "disp_filter", "false" );
			curView.SetProperty("list_columns", Array("name","author"));
			curView.SetProperty("list_headers", Array(tools.get_web_str('c_heading'),tools_web.get_web_str('vfb_author')));
			curView.SetProperty("link_field_index", "1");

			Server.Execute("view_catalog_list.html");
		}
%>
			</td>
		</tr>
	</table>
	
					
<%
	
		break;
		
	case "viewing":
	{
		xarrMyMaterials = XQuery("for $elem in library_material_viewings where $elem/person_id = " + curUserID + " return $elem");		
		curView = new Object;
		curView.SetProperty("id", "library_materials_viewings_list");
		curView.SetProperty("catalog_name", "library_material_viewing");		
		curView.SetProperty("title", "");
		curView.SetProperty("array", xarrMyMaterials);
		curView.SetProperty("disp_link", "true");
		curView.SetProperty("sort_index", 0);				
		curView.SetProperty("link_mode", "library_material");
		curView.SetProperty("link_object_field", "material_id");
		curView.SetProperty("disp_check_box", "false");
		curView.SetProperty("list_columns", Array("material_id.ForeignElem.name","start_viewing_date", "last_viewing_date", "finish_viewing_date", "duration", "state_id"));
//		curView.SetProperty("list_headers", Array(tools.get_web_str('c_heading'),tools_web.get_web_str('vfb_author')));
		curView.SetProperty("link_field_index", "1");

		Server.Execute("view_catalog_list.html");
	}
	break;
	
	case "search":
	{
		xarrMyMaterials = XQuery("for $elem in library_materials order by $elem/name return $elem");
		
		curView = new Object;
		curView.SetProperty("id", "library_material");
		curView.SetProperty("catalog_name", "library_material");
		curView.SetProperty("title", '');
		curView.SetProperty("array", xarrMyMaterials);
		curView.SetProperty("disp_link", "true");
		curView.SetProperty("disp_check_box", "false");
		curView.SetProperty("list_columns", Array("name","author"));
		curView.SetProperty("list_headers", Array(tools.get_web_str('c_heading'),tools_web.get_web_str('vfb_author')));
		curView.SetProperty("link_field_index", "1");
		curView.SetProperty("paging_size", 25 );

		Server.Execute("view_catalog_list.html");
	}
	break;
}
%>
</div>