<%
_action = Request.Form.HasProperty( 'action' ) ? Request.Form.action : '0';
_search_text = Request.Form.HasProperty('search_text') ? Request.Form.search_text : '';
_xtype = Request.Form.HasProperty('book_types') ? Request.Form.book_types : '';
_xformat = Request.Form.HasProperty('book_formats') ? Request.Form.book_formats : '';
_xfulltext = Request.Query.HasProperty( 'full_text_search' ) && Request.Form.full_text_search == '1';
_xauthor = Request.Form.HasProperty('book_author') ? Request.Form.book_author : '';
_xyear = Request.Form.HasProperty('book_year') ? Request.Form.book_year : '';
_xisbn = Request.Form.HasProperty('book_isbn') ? Request.Form.book_isbn : '';
%>

<script language="JavaScript">
function do_submit()
{
	document.search_lib_form.submit();
}
function do_clear()
{
	document.search_lib_form.reset();
	document.search_lib_form.search_text.value='';
	document.search_lib_form.book_author.value='';
	document.search_lib_form.book_isbn.value='';
	document.search_lib_form.book_year.value='';
	document.search_lib_form.full_text_search.checked=false;
}
</script>
<form action="view_doc.html?mode=<%=curMode%>&doc_id=<%=curDocID%>" name="search_lib_form" method="POST">
<input type="hidden" name="action" value="1">
<table width="100%" cellspacing="4" cellpadding="0">
	<tr><td>
		<table width="100%" cellspacing="0" cellpadding="4" class="tableBorder">
			<tr> 
				<td width="200" align="RIGHT"><b><%=tools.get_web_str('c_key_word')%>:</b></td>
				<td align="LEFT"><input type="text" name="search_text" value="<%=_search_text%>" style="width:300px;" class="inputEdit"/></td>
<%
if (AppConfig.HasProperty("DB-STORE-HOOK")!=true)
{
%>
				<td width="100" align="RIGHT">&nbsp;</td>
				<td align="LEFT">&nbsp;</td>
<%
}
else
{
%>
				<td width="100" align="RIGHT"><b><%=tools.get_web_str('vlsb_search')%>:</b></td>
				<td align="LEFT"><input type="checkbox" name="full_text_search" value="1" <%=(_xfulltext?"checked":"")%>/></td>
<%
}
%>
				<td width="220">&nbsp;</td>
			</tr> 
			<tr> 
				<td width="200" align="RIGHT"><b><%=tools.get_web_str('c_view')%>:</b></td>
				<td align="LEFT">
					<select name="book_types" id="book_types">
						<option SELECTED value=""><%=tools.get_web_str('c_all')%></option>
<%
	for ( _type in XQuery( "for $elem in library_material_types return $elem" ) )
	{
%>
						<option value="<%=_type.id%>"><%=tools_web.get_cur_lng_name( _type.name )%></option>
<%
	}
%>
					</select> 
<script language="JavaScript">
selcur=document.forms['search_lib_form'].book_types;
for (i=0;i<selcur.options.length;i++)
    if (selcur.options[i].value=="<%=_xtype%>")
	{
        selcur.selectedIndex=i;
		break;
	}
</script>
				</td> 
			</tr> 
			<tr> 
				<td width="200" align="RIGHT"><b><%=tools_web.get_web_str('c_format')%>:</b></td>
				<td align="LEFT">
					<select name="book_formats" id="book_formats">
						<option SELECTED value=""><%=tools.get_web_str('c_all')%></option>
<%
	for ( _format in XQuery( "for $elem in library_material_formats return $elem" ) )
	{
%>
						<option value="<%=_format.id%>"><%=tools_web.get_cur_lng_name( _format.name )%></option>
<%
	}
%>					
					</select> 
<script language="JavaScript">
selcur=document.forms['search_lib_form'].book_formats;
for (i=0;i<selcur.options.length;i++)
    if (selcur.options[i].value=="<%=_xformat%>")
	{
        selcur.selectedIndex=i;
		break;
	}
</script>
				</td> 
			</tr> 
			<tr> 
				<td width="200" align="RIGHT"><b><%=tools_web.get_web_str('vfb_author')%>:</b></td>
				<td align="LEFT"><input type="text" name="book_author" value="<%=_xauthor%>" style="width:300px;" class="inputEdit"/></td>
			</tr> 
			<tr> 
				<td width="200" align="RIGHT"><b>ISSN/ISBN:</b></td>
				<td align="LEFT"><input type="text" name="book_isbn" value="<%=_xisbn%>" style="width:300px;" class="inputEdit"/></td>
			</tr> 
			<tr> 
				<td width="200" align="RIGHT"><b><%=tools.get_web_str('c_imprint_date')%>:</b></td>
				<td align="LEFT"><input type="text" name="book_year" value="<%=_xyear%>" size="4" class="inputEdit"/></td>
			</tr> 
		</table> 
	</td></tr>
	<tr><td align="CENTER">
			<table width="100%" border="0" cellspacing="0" cellpadding="0" class="activator">
			<tr> 
				<td align="CENTER" class="activator">
					<input type="button" value="<%=tools.get_web_str('sf_submit')%>" onclick="do_submit();" class="inputButton" onmouseover="this.className='inputButtonOver';" onmouseout="this.className='inputButton';">&nbsp;&nbsp;&nbsp;&nbsp;
					<input type="button" value="<%=tools.get_web_str('c_clear')%>" onclick="do_clear();" class="inputButton" onmouseover="this.className='inputButtonOver';" onmouseout="this.className='inputButton';">
				</td>
			</tr> 
			</table>				
	</td></tr>
</table> 
</form>
<%

if ( _action == '1' )
{
	if (AppConfig.HasProperty("DB-STORE-HOOK")==true && _xfulltext && _search_text != '')
	{
		_books_array = Array();
		sqlQuery = "sql: select * from [(spxml_blobs)] where contains(data,'" + _search_text + "*')";

		_ft_array = XQuery(sqlQuery);
		for ( _file in _ft_array )
		{
			if(StrBegins(_file.url, 'x-local://wt_data/attachments/', true))
			{
				_file_name = StrRightRangePos(_file.url, 30);
				_dot_pos = _file_name.lastIndexOf('.');
				_file_id = StrLeftRange(_file_name, _dot_pos);

				fileQuery = "sql: select * from library_material where ";
				innerText = 'for $id in library_material where $id/file_name="' + _file_id + '" return $id';
				fileQuery += "data.exist(" + CodeLiteral( innerText ) + ") = 1 ";

				_mat_array = XQuery(fileQuery);
				for ( _mat in _mat_array )
				{
					_query_str = "for $elem in library_materials where $elem/is_archived = false()";
					_query_str += " and $elem/id = " + _mat.id + " return $elem";
					_tmp_array = XQuery(_query_str);
					_books_array = ArrayUnion(_books_array, _tmp_array);
				}
			}
		}
	} 
	else 
	{

		_query_str = "for $elem in library_materials";

		_where_str = " where $elem/is_archived = false()";
		_where_str += ( _xtype == "" ? "" : " and $elem/library_material_type_id = " + _xtype);
		_where_str += ( _xyear == "" ? "" : " and $elem/year = " + CodeLiteral( _xyear ));
		_where_str += ( _xisbn == "" ? "" : " and $elem/isbn = " + CodeLiteral( _xisbn ));
		_where_str += ( _xauthor == "" ? "" : " and $elem/author = " + CodeLiteral( _xauthor ));
		_where_str += ( _xformat == "" ? "" : " and contains($elem/library_material_formats," +CodeLiteral(_xformat)+ ")");
		_query_str += _where_str;
		_query_str += " order by $elem/name return $elem";

		_books_array = XQuery(_query_str);

		if ( _search_text != '' )
			_books_array = ArraySelect( _books_array, 'StrContains(Xml,' + CodeLiteral( _search_text ) + ')' );
	}
	
	curView = new Object;
	curView.SetProperty("id", "library_materials_result_list");
	curView.SetProperty("catalog_name", "library_material");
	curView.SetProperty( "array", _books_array);
	curView.SetProperty("disp_link", "true");
	curView.SetProperty("disp_check_box", "false");
	curView.SetProperty( "list_columns", Array("name","author") );
	curView.SetProperty( "list_headers", Array(tools.get_web_str('c_title'),tools_web.get_web_str('vfb_author')) );
	curView.SetProperty( "col_headers", Array(tools.get_web_str('c_available')) );
	curView.SetProperty( "col_cells", Array("'<center><img src=\"pics/'+ (ListElem.is_available? 'ok.gif':'no.gif') +'\" border=0/></center>'") );
	curView.SetProperty( "link_field_index", "1" );
	curView.SetProperty( "disp_search", "false" );
	curView.SetProperty( "disp_filter", "false" );

	Server.Execute("view_catalog_list.html");
}
%>