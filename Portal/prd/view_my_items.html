<script src="scripts\tree\ua000000.js"></script>
<script src="scripts\tree\ftiens40.js"></script>
<script language="javascript">
USETEXTLINKS = 1;
STARTALLOPEN = 0;
USEFRAMES = 0;
USEICONS = 0;
WRAPTEXT = 1;
PRESERVESTATE = 1;
ICONPATH = "scripts/tree/";
var parent_elem;
<%
_href = tools_web.get_query_string(true, "role_id")+"role_id=";
_STREAM = "foldersTree = gFld('<b>" + tools_web.get_web_str("c_sections") + "</b>', '"+_href+"');\n";



_itemCardDoc = tools_web.get_my_person_object_link_card("item",curUserID);
if (_itemCardDoc != undefined)
{
	_item_allowed_pack = ArrayExtract(_itemCardDoc.objects, "PrimaryKey");
	if (_itemCardDoc.all_can_edit)
		_editable_list = "'*'";
	else
		_editable_list = CodeLiteral(ArrayMerge(ArraySelectByKey(_itemCardDoc.objects, true, "can_edit"), "This.PrimaryKey", ";"));
		
	if (_itemCardDoc.all_can_delete)
		_deletable_list = "'*'";
	else
		_deletable_list = CodeLiteral(ArrayMerge(ArraySelectByKey(_itemCardDoc.objects, true, "can_delete"), "This.PrimaryKey", ";"));
}
else
{
	_item_allowed_pack = Array();
	_editable_list = "''";
	_deletable_list = "''";
}



_roleCardDoc = tools_web.get_my_person_object_link_card("role",curUserID);

if (_roleCardDoc != undefined)
{
	_role_allowed_pack = ArrayExtract(_roleCardDoc.objects, "PrimaryKey");
	if (_roleCardDoc.all_can_delete)
		_deletable_role_list = "*";
	else
		_deletable_role_list = ArrayMerge(ArraySelectByKey(_roleCardDoc.objects, true, "can_delete"), "This.PrimaryKey", ";");

}
else
{
	_role_allowed_pack = Array();
	_deletable_role_list = "";
}
_itemed_roles = ArrayMerge(QueryCatalogByKeys("items", "id", _item_allowed_pack), "ArrayMerge(This.role_id, 'This', ';')", ";");
	
_roles = _role_allowed_pack;


_roles = ArrayMerge(_role_allowed_pack, "This", ";");
_roles = XQuery("for $obj in roles where contains(" +XQueryLiteral(_roles + ";" + _itemed_roles)+ ",$obj/id) order by $obj/Hier() return $obj");

//_roles = XQuery("for $obj in roles order by $obj/Hier() return $obj");

for (_role in _roles)
{
	_parent_object = _role.parent_role_id.OptForeignElem;
	if (_parent_object != undefined)
	{
		_parent = "role" + _role.parent_role_id;
	}
	else
	{
		_parent = "foldersTree";
	}
	_href = tools_web.get_query_string(true, "role_id") + "role_id=" +_role.PrimaryKey;
	_STREAM = _STREAM + "try{parent_elem = "+_parent + ";}catch(_e_){parent_elem = foldersTree;}\n";
	_STREAM = _STREAM + ("var role" + _role.id +' = insFld( parent_elem, gFld("<img src=\'pics/folder.gif\' border=0/>&nbsp;'+HtmlEncode(_role.name)+ '", "' + _href + '")); \n');
}
Response.Write(_STREAM);
%>
</script>
<br/>
<table border="0" width="100%" style="height:100%">
<tr>
	<td id="treeArea" width="300px" valign="top">
		<span class="TreeviewSpanArea" style="overflow:auto; width:300px">
			<script>initializeDocument();</script>
		</span>
	</td>	
	<td valign="top">
<%
		try
		{
			_role = ArrayFirstElem(XQuery("for $role in roles where $role/id = " + Int(Request.QueryString.GetProperty("role_id")) + " return $role"));
		}
		catch(_o_)
		{
			_role = undefined;
		}
		
		if(_role != undefined) Response.Write("<h2>" + tools_web.get_web_str('c_section') + ": "+_role.name+"</h2>");
		
				
		if (_role != undefined)
			xarrItemsAllMine = XQuery("for $elem in items where MatchSome($elem/role_id," + XQueryLiteral(_role.id) + ") return $elem" );
		else
			xarrItemsAllMine = XQuery("for $elem in items where IsEmpty($elem/role_id)=true() return $elem" );
		
		_itemArray = Array();
		
		for (catMyItemElem in xarrItemsAllMine)
		if (ArrayOptFind(_item_allowed_pack, "This == " + catMyItemElem.id) != undefined)
		{
			_itemArray[ArrayCount(_itemArray)] = catMyItemElem;
		}
				
		/*
		_itemArray = ArraySelect( QueryCatalogByKeys("items", "id", _item_allowed_pack), (_role != undefined ? "role_id.HasValue && StrContains( "+ CodeLiteral(ArrayMerge(XQuery( "CatalogHierSubset('roles'," + _role.id + ")" ), "This.id",";") + ";" + _role.id )+" ,role_id )" : "true"));
		*/	
		curView = new Object;
		curView.SetProperty("id", "it_list");
		curView.SetProperty("catalog_name", "item");
		curView.SetProperty("disp_link", "("+_editable_list+"=='*' || StrContains("+_editable_list+",ListElem.PrimaryKey) ? true: false)");
		curView.SetProperty("disp_check_box", "true");
		curView.SetProperty("disp_check_box_visibility", "("+_deletable_list+"=='*' || StrContains("+_deletable_list+",ListElem.PrimaryKey) ? true: false)");
		curView.SetProperty("title", tools_web.get_web_str('c_questions') );
		curView.SetProperty("array", _itemArray);
		curView.SetProperty("link_mode", "item_edit");
		
		Server.Execute( "view_catalog_list.html" );
%>
	<br/>
	<form name="role_submitter" id="role_submitter" action="content_panel_process.html" method="post">
		<input type="hidden" name="role_name" value=""/>
		<input type="hidden" name="parent_role_id" value="<%=(_role != undefined ? _role.id : "")%>"/>
		<input type="hidden" name="doc_id" value="<%=curDocID%>"/>
		<input type="hidden" name="href" value="<%=Request.Url%>"/>
		<input type="hidden" name="mode" value="make_role"/>
	</form>
	<script language="javascript">
		function mk_role()
		{
			var pars = new Object;
			var strAttr="status:no;dialogWidth:500px;dialogHeight:150px;help:no;resizable:no;scroll:no";	
			xShowModalDialog("dlg_textarea.html?doc_id=<%=curDocID%>&rand="+Math.random() + "&show_input=1&input_title="+escape('<%=(_role != undefined ? tools_web.get_web_str("vmi_add_name_section") : tools_web.get_web_str("vmi_add_name_subsection"))%>'), pars, strAttr);
	
			if (!pars.handle) return false;
			var stringa = pars.input_value;
			if (stringa == null) return false;
			if (stringa == '') return false;
			if (stringa.length > 500) stringa = stringa.substring(0, 500);
			stringa = String(stringa).replace(/;/, "");
			if (!window.confirm('<%=(_role != undefined ? tools_web.get_web_str("vmi_create_section") : tools_web.get_web_str("vmi_create_subsection"))%> ' + stringa + '?')) return false;
			
			document.forms["role_submitter"].role_name.value = stringa;
			document.forms["role_submitter"].submit();
		}
	</script>
<%
	if (_roleCardDoc != undefined)
	{
		if(_roleCardDoc.all_can_create)
		{
%>
	<input type="button" value="<%=(_role != undefined ? tools_web.get_web_str("vmi_create_subsection_in_sec") +" &quot;"+_role.name+"&quot;" : tools_web.get_web_str("vmi_create_section"))%>" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';" onclick="mk_role()"/>
<%
		}
		if (_deletable_role_list != "")
		{
%>
			<input type="button" value="Удалить раздел" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';" onclick="
				
				var oPars=new Object(); oPars.check_access = true;
				var strAttr='status:no;dialogWidth:780px;dialogHeight:550px;help:no;resizable:1';
				oPars.display_object_ids = '<%=(_deletable_role_list != "*" ? _deletable_role_list : "")%>';
				xShowModalDialog('dlg_select.html?doc_id=<%=curDocID%>&catalog_name=role&rand='+Math.random(), oPars, strAttr);
				
				if (oPars.handle)
				{
					document.forms['role_killa'].elements['dead_object_ids'].value = oPars.element_id;
					document.forms['role_killa'].submit();
					return true;
				}
				return false;
			"/>
<%
		}
	}
	if (_itemCardDoc != undefined && _itemCardDoc.all_can_create)
	{
%>
	<input type="button" value="<%=tools.get_web_str("vmi_create_question")%>" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';" onclick="window.location.href='<%=tools_web.get_url_protocol( Request.Url ) + Request.UrlHost + UrlPath( Request.Url ) + "?mode=item_edit&doc_id="+curDocID+(_role != undefined ? "&role_id=" + _role.id : "");%>'"/>
<%
	}
	if (_deletable_list != "''")
	{
%>
	<input type="button" value="<%=tools.get_web_str("dcs_del_question")%>" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';" onclick="
		var _str = '';
		var _dead_list = document.getElementsByName('select_check_box_it_list');
		var x =0;
		for (var i =0; i<_dead_list.length;i++)
		if (_dead_list[i].checked)
		{
			_str += (_str != '' ? ';': '') + _dead_list[i].id;
			x++;
		}
		document.forms['item_killa'].elements['dead_object_ids'].value = _str;
		if (_str != '' && confirm(String('<%=tools_web.get_web_str("vmi_mess_del_questions")%>').replace('{PARAM1}',x) ))
			document.forms['item_killa'].submit();
	"/>
	
	<form name="item_killa" id="item_killa" action="content_panel_process.html" method="post">
		<input type="hidden" name="doc_id" value="<%=curDocID%>"/>
		<input type="hidden" name="href" value="<%=Request.Url%>"/>
		<input type="hidden" name="mode" value="delete_elements"/>
		<input type="hidden" name="catalog_name" value="item"/>
		<input type="hidden" name="dead_object_ids" value=""/>
	</form>
<%
	}
	if (_deletable_role_list != "")
	{
%>
		<form name="role_killa" id="role_killa" action="content_panel_process.html" method="post">
			<input type="hidden" name="doc_id" value="<%=curDocID%>"/>
			<input type="hidden" name="href" value="<%=Request.Url%>"/>
			<input type="hidden" name="mode" value="delete_elements"/>
			<input type="hidden" name="catalog_name" value="role"/>
			<input type="hidden" name="dead_object_ids" value=""/>
		</form>
<%
	}
%>
	</td>
</tr>
</table>