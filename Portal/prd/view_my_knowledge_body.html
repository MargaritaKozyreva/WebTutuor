<script src="scripts\tree\ua000000.js"></script>
<script src="scripts\tree\ftiens40.js"></script>
<script language="javascript">
<!--
USETEXTLINKS = 1;
STARTALLOPEN = 0;
USEFRAMES = 0;
USEICONS = 0;
WRAPTEXT = 1;
PRESERVESTATE = 1;
ICONPATH = "scripts/tree/";

foldersTree = gFld("<b><%=tools_web.get_web_str('c_classifiers')%></b>", '');
<%
bShowPendingOnly = (Request.QueryString.HasProperty("show_pending") && Request.QueryString.GetProperty("show_pending")=="1");
sPartsList = "";
sMeExpert = ArrayMerge(XQuery("for $elem in experts where $elem/person_id = " + curUserID + " return $elem"), "This.id", ";");
_sHref = "view_doc.html?mode=" + curMode + "&doc_id=" + curDocID + (bShowPendingOnly? "&show_pending=1":"") + "&object_id=";

 xarrMyKnowledgesPack = QueryCatalogByKeys("knowledge_parts", "id", ArrayExtract(curUser.knowledge_parts, "knowledge_part_id"));
if (sMeExpert != "")
{
	xarrMyKnowledgesPack = ArrayUnion(XQuery("for $elem in knowledge_parts where contains($elem/experts, " +XQueryLiteral(sMeExpert)+ ") return $elem"),xarrMyKnowledgesPack);
	xarrMyKnowledgesPack = ArraySelectDistinct(xarrMyKnowledgesPack, "id");
}
aClassifierPack = Array();
aKnowledgePack = Array();
function getList(iKnowledgeIDParam)
{
	var _arrObjz = Array();
	
	for (commonKnowledgePartsObject in common.knowledge_parts_objects)
	{
		_arrObjz = ArrayUnion(_arrObjz,  XQuery ( 'for $obj in ' + commonKnowledgePartsObject.PrimaryKey + 's where contains($obj/knowledge_parts, \'' + iKnowledgeIDParam + '\') return $obj' ) );
		
	}
	 return _arrObjz;
}
function printknowledgeBranch(catKnowledgeParam, bTrustedParam, catKnowledgeClassifierParam)
{
	if (bTrustedParam || ArrayOptFind(xarrMyKnowledgesPack, "PrimaryKey == " + catKnowledgeParam.PrimaryKey) != undefined)
	{
		if (ArrayOptFind(aClassifierPack, "This == " + catKnowledgeClassifierParam.id) == undefined)
		{
			aClassifierPack[ArrayCount(aClassifierPack)] = catKnowledgeClassifierParam.id;
			Response.Write("var C" + catKnowledgeClassifierParam.id + ' = insFld( foldersTree, gFld("'+HtmlEncode(catKnowledgeClassifier.name)+'", "' + _sHref + catKnowledgeClassifier.id + '"));');
		}
		if (catKnowledgeParam.experts != "" && sMeExpert != "")
			var bIExpert = (ArrayOptFind(String(catKnowledgeParam.experts).split(";"), "StrContains(" +CodeLiteral(sMeExpert)+ ", This)") != undefined);
		else
			var bIExpert =false;
		
		sPartsList += catKnowledgeParam.id + ";"
		Response.Write("var P" + catKnowledgeParam.id +" = insFld( " + (catKnowledgeParam.parent_object_id.HasValue && bTrustedParam?  "P" + catKnowledgeParam.parent_object_id : (catKnowledgeClassifierParam != null ? "C"+catKnowledgeClassifierParam.id: "foldersTree")) + ' , gFld("'+(bIExpert? "<img src='pics/person.gif' border='0'/>":"")+HtmlEncode(catKnowledgeParam.name)+'", "' + _sHref + catKnowledgeParam.id+ '")); \n');
		bTrustedParam = true;
		aKnowledgePack[ArrayCount(aKnowledgePack)] = catKnowledgeParam;
	}
	var carrDescKnowledges = XQuery("for $elem in knowledge_parts where $elem/parent_object_id = " + catKnowledgeParam.id + " return $elem");
		for (catDescKnowledge in carrDescKnowledges) printknowledgeBranch(catDescKnowledge, bTrustedParam, catKnowledgeClassifierParam);
	
}
function __and(_aSpecie1Param, _aSpecie2Param)
{
	_aSpecie1Param = ArraySort(_aSpecie1Param, "PrimaryKey", "+");_aSpecie2Param = ArraySort(_aSpecie2Param, "PrimaryKey", "+");
	var _aHybrid = Array();var _ac1 = ArrayCount(_aSpecie1Param);var _ac2 = ArrayCount(_aSpecie2Param);var _i=0; var _j=0; var _k=0;

	while (_i < _ac1 &&_j < _ac2)
	{
		if (_aSpecie1Param[_i].PrimaryKey == _aSpecie2Param[_j].PrimaryKey)
		{
			_aHybrid[_k] = _aSpecie1Param[_i];_i++;_j++;_k++;
		}
		else if (_aSpecie1Param[_i].PrimaryKey > _aSpecie2Param[_j].PrimaryKey) _j++;else _i++;
	}
	
	return _aHybrid;
}
for (catKnowledgeClassifier in knowledge_classifiers)
{
	xarrKnowledgePack = XQuery("for $elem in knowledge_parts where $elem/knowledge_classifier_id = " + catKnowledgeClassifier.id + " and $elem/parent_object_id = null() return $elem");
	for (catKnowledge in xarrKnowledgePack) printknowledgeBranch(catKnowledge, false, catKnowledgeClassifier);
	
}

if (curObject != null)
{
	if (curObject.Name == "knowledge_classifier")
	{
		xarrKnowledgePack = XQuery("for $elem in knowledge_parts where $elem/knowledge_classifier_id = " + curObjectID + " and $elem/parent_object_id = null() return $elem");
		arrChildKnowledges = xarrKnowledgePack;
		for (catKnowledge in xarrKnowledgePack)
			arrChildKnowledges = ArrayUnion(arrChildKnowledges, XQuery( "CatalogHierSubset('knowledge_parts'," + catKnowledge.id + ")" ));
	}
	else if (curObject.Name == "knowledge_part")
	{
		arrChildKnowledges = ArrayUnion(XQuery("for $elem in knowledge_parts where $elem/id = "+curObjectID+" return $elem"), XQuery( "CatalogHierSubset('knowledge_parts'," + curObjectID + ")" ));
	}
	else
		arrChildKnowledges = Array();
	
	arrChildKnowledges = __and(arrChildKnowledges, aKnowledgePack);
	
	_arrAllOfObjects = Array();
	for (catKnowledge in arrChildKnowledges)
	{
		_arrAllOfObjects = ArrayUnion(_arrAllOfObjects, getList(catKnowledge.id));
	}
}

%>
function saveNewKnowledge(_id)
{	
	var oPars=new Object(); oPars.check_access = true;
	var strAttr='status:no;dialogWidth:780px;dialogHeight:550px;help:no;resizable:1';
	
	if (oPars.display_object_ids == '') oPars.display_object_ids = '0';
	
	oPars.display_object_ids = "<%=sPartsList%>";
	oPars.can_be_empty = false;
	oPars.disp_filter = false;
	xShowModalDialog('dlg_select.html?doc_id=<%=curDocID%>&catalog_name=knowledge_part&typein=0&multi_select=0&rand='+Math.random(), oPars, strAttr);
	if (!oPars.handle ) return false;
	
	$("table#control"+_id).hide();
	$("img#loading"+_id).show();
	$.getJSON("knowledge_acknowledgement.html", {whattodo: "insert_knowledge_parts_into_doc", knowledge_parts_ids: oPars.element_id, doc_id: _id, preserve: 1, rand: Math.random()}, function(json){ $("table#control"+_id).show(); $("img#loading"+_id).hide(); window.alert(json.operation_status_result_message);});
}
function wipeKnowledge(_id, sKnowledgeIDs)
{	
	var oPars=new Object(); oPars.check_access = true;
	var strAttr='status:no;dialogWidth:780px;dialogHeight:550px;help:no;resizable:1';
	
	oPars.display_object_ids = sKnowledgeIDs;
	oPars.can_be_empty = false;
	oPars.disp_filter = false;
	xShowModalDialog('dlg_select.html?doc_id=<%=curDocID%>&catalog_name=knowledge_part&typein=0&multi_select=1&rand='+Math.random(), oPars, strAttr);
	if (!oPars.handle ) return false;
	
	$("table#control"+_id).hide();
	$("img#loading"+_id).show();
	$.getJSON("knowledge_acknowledgement.html", {whattodo: "wipe_from_doc", knowledge_parts_ids: oPars.selected_object_ids, doc_id: _id, rand: Math.random()}, function(json){ $("table#control"+_id).show(); $("img#loading"+_id).hide(); window.alert(json.operation_status_result_message); if (parseInt(json.operation_status_result) == 1) $("tr#tr"+_id).remove();});
}
function massApproval(_id, sKnowledgeIDs)
{	
	$("table#control"+_id).hide();
	$("img#loading"+_id).show();
	$.getJSON("knowledge_acknowledgement.html", {whattodo: "mass_approval", knowledge_parts_ids: sKnowledgeIDs, doc_id: _id, rand: Math.random()}, function(json){ $("table#control"+_id).show(); $("img#loading"+_id).hide(); window.alert(json.operation_status_result_message); if (parseInt(json.operation_status_result) == 1) $("td#tdstat"+_id).html("<%=tools_web.get_web_str('vppb_state_working')%>");});
}
-->
</script>
<table width="100%" border="0">
<tr>
	<td width="300px">
		<span class="TreeviewSpanArea" style="overflow:auto; width:100%">
			<script>initializeDocument();</script>
		</span>
	</td>
	<td valign="top">
<%
	if (curObject != null)
	{
%>
		<table border="0" cellpadding="0" cellspacing="0" bgcolor="gray" width="100%"><tr><td>
		<table cellpadding="1" cellspacing="1" border="0" width="100%">
		<tr bgcolor="white">
			<th width="100%"><%=tools.get_web_str('c_name')%></th><th width="400px"><%=tools.get_web_str('c_type')%></th><th width="200px"><%=tools_web.get_web_str('c_state')%></th><th>&nbsp;</th>
		</tr>
		<tbody>
<%
		for (catKnowledgeObject in ArraySelectDistinct(_arrAllOfObjects,"id"))
		{
			_commonExchangeObjectType = common.exchange_object_types.GetChildByKey(catKnowledgeObject.Name);
			_sDispName = catKnowledgeObject.EvalPath(_commonExchangeObjectType.disp_name).Value;
			teObjectopened = OpenDoc(UrlFromDocID(catKnowledgeObject.PrimaryKey)).TopElem;
			listCurObjKnowledges = ArraySelect(teObjectopened.knowledge_parts, "ArrayOptFind(arrChildKnowledges,'id == ' + PrimaryKey) != undefined");
			bRequireOK = ArrayOptFind(listCurObjKnowledges, "require_acknowledgement == true") != undefined;
			if (!bShowPendingOnly || bRequireOK)
			{
				_common_part_lib = curLngCommon.knowledge_parts_objects.GetOptChildByKey(_commonExchangeObjectType.name);
				if (_common_part_lib != undefined)
				{
					_bIsFunctional = _common_part_lib.is_functional;
				}
				else
				{
					_bIsFunctional = false;
				}
				switch(_commonExchangeObjectType.name)
				{
					case "forum":
						_sWebTemplate = "view_doc.html?mode=forums&object_id=" + catKnowledgeObject.PrimaryKey + "&doc_id=" + curDocID;
						break;
					case "document":
						_sWebTemplate = "view_doc.html?doc_id=" + catKnowledgeObject.PrimaryKey ;
						break;
					case "competence_profile":
						_sWebTemplate = "view_doc.html?mode=competence_profile&object_id=" + catKnowledgeObject.PrimaryKey + "&doc_id=" + curDocID;
						break;
					default:
						_sWebTemplate = ( _commonExchangeObjectType.web_template.HasValue ? _commonExchangeObjectType.web_template + ( StrContains( _commonExchangeObjectType.web_template, "?")? "&":"?") + "doc_id=" + curDocID + "&object_id=" +catKnowledgeObject.PrimaryKey : "" );
				}
				if (_bIsFunctional && _sWebTemplate != "")
					_sDispName = '<a href="' + _sWebTemplate + '">' + _sDispName + '</a>';
			
%>
			<tr bgcolor="white" id="tr<%=catKnowledgeObject.id%>">
				<td><%=_sDispName%></td>
				<td><%=_commonExchangeObjectType.title%></td>
				<td id="tdstat<%=catKnowledgeObject.id%>"><%=(bRequireOK ? tools_web.get_web_str('vmkb_wait'): tools_web.get_web_str('vppb_state_working'))%></td>
				<td align="center">
					<img src="pics/progress.gif" id="loading<%=catKnowledgeObject%>" style="display:none"/>
					<table cellpadding="0" cellspacing="0" id="control<%=catKnowledgeObject%>">
						<tr>
							<td><input type="button" value="&#8596" title="<%=tools_web.get_web_str('vmkb_other_klass')%>" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';" onclick="saveNewKnowledge('<%=catKnowledgeObject.id%>')"/></td>
							<td><input type="button" value="X" title="<%=tools_web.get_web_str('vmkb_undo')%>" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';" onclick="wipeKnowledge('<%=catKnowledgeObject.id%>', '<%=ArrayMerge(listCurObjKnowledges, "This.PrimaryKey", ";")%>')"/></td>
<%				if (bRequireOK)
				{
%>
					<td><input type="button" value="V" title="<%=tools_web.get_web_str('vherb_submit')%>" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';" onclick="massApproval('<%=catKnowledgeObject.id%>', '<%=ArrayMerge(listCurObjKnowledges, "This.PrimaryKey", ";")%>')"/></td>
<%
				}
%>
						</tr>
					</table>
				</td>
			</tr>
<%
			}
		}
%>
		</tbody>
		</table>
		</td></tr></table>
		<input type="checkbox" value="1" <%=(bShowPendingOnly ? "checked":"")%> onclick="window.location.href='<%=tools_web.get_query_string(true, "show_pending")%>'+(this.checked ? 'show_pending=1':'show_pending=0')"/><%=tools_web.get_web_str('vmkb_show_only')%>
<%
		if (curObject.ChildExists("tags") && ArrayOptFirstElem(curObject.tags) != undefined)
		{
			Response.Write( "<p><b>" + tools_web.get_web_str("vkpb_tag_name") + ":</b>&nbsp;" + ArrayMerge(curObject.tags, "(This.PrimaryKey.OptForeignElem != undefined ? '<a href=\"view_doc.html?mode=knowledge_cloud&tag_id=' + This.PrimaryKey + '&doc_id=' + curDocID + '\">' + This.PrimaryKey.OptForeignElem.name + '</a>' : '')", "&nbsp;&nbsp;") + "</p>");
		}
	}
%>
	</td>
</tr>
</table>