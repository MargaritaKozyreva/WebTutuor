<%
	curDate = DateNewTime( Date() );
	if ( Request.QueryString.HasProperty( 'date' ) && Request.QueryString.date != '' )
		curDate = DateNewTime( Date( Request.QueryString.date ) );
	
	_year = Year( curDate );
	_month = Month( curDate );
	_date_start = Date( '1.' + _month + '.' + _year );
	_date_end = Date( '1.' + ( _month == 12 ? '1.' + ( _year + 1 ) : ( _month + 1 ) + '.' + _year ) );	
	curObjectResourceArray = XQuery( "for $elem in event_phases where $elem/object_resource_id = " + curObjectID + " and $elem/finish_date > date( '" + _date_start + "' ) and $elem/start_date < date( '" + _date_end + "' ) order by $elem/start_date return $elem" );
%>


<%
	if (curHostSettings.default_portal_type == "sharepoint")
	{
%>
<script language="javascript">
<!--
	var imgDir = '<%=curHostSettings.proxy_prefix%>/scripts/calendar/';
-->
</script>
<%
	}
%>
<script src="<%=(curHostSettings.default_portal_type == "sharepoint" ? curHostSettings.proxy_prefix + '/': "")%>scripts/calendar/calendar.js"></script>



<script language="javascript">
function doSubmitRequest()
{
	if ( document.getElementById("event_name_id").value=='' || document.getElementById("event_code_id").value=='' || document.getElementById("event_person_num_id").value=='' || document.getElementById("event_start_date_id").value=='' || document.getElementById("event_finish_date_id").value=='' || document.getElementById("event_initiator_id").value=='' )
	{
		alert("<%=tools.get_web_str('uc_error2')%>");
		return false;
	}
	
	document.object_resource_form.submit();
}
</script>
<br/>
<table width="100%"  border="0" cellspacing="0" cellpadding="3">
	<tr>
		<td valign="top" align="left"><%Server.Execute( "view_desc.html" )%></td>
		<td valign="top">
<%
	_year = Year( curDate );
	_month = Month( curDate );
	_num_days = Array( 31, ( DateToRawSeconds( Date( _year, 3, 1 ) ) - DateToRawSeconds( Date( _year, 2, 1 ) ) ) / 86400, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31 );
	
	_date_start = Date( '1.' + _month + '.' + _year );
	_date_end = Date( '1.' + ( _month == 12 ? '1.' + ( _year + 1 ) : ( _month + 1 ) + '.' + _year ) );
	w = WeekDay( _date_start );
	_week_day = ( w == 0 ? 6 : w - 1 );
	_cur_num_days = _num_days[ _month - 1 ];
	
	curQueryString = tools_web.get_query_string( true, 'date;m' );
%>	
 
<a href="#CALENDAR1"></a>
<table cellpadding=0 cellspacing=0 border=0 width=100%>
<tr>
	<td class="calendarBodyTable">
	<table  cellpadding=0 cellspacing=0 border=0 width=100%>
		<tr>
			<td width=100% align=center class="calendarHeader">
				<a href="<%=( curQueryString + 'date=1.' + ( _month == 1 ? '12.' + ( _year - 1 ) : ( _month - 1 ) + '.' + _year ) )%>">&lt;</a>&nbsp;<%=StrDate( curDate )%>&nbsp;<a href="<%=( curQueryString + 'date=' + _date_end )%>">&gt;</a>
			</td>
		</tr>
	</table>
	<table cellpadding="0" cellspacing="1" border="0" width="100%" class="calendarInnerTable">
		<tr>
			<td width=15% align=center class="calendarDaysHeader"><%=tools.get_web_str('day_monday')%></td>
			<td width=15% align=center class="calendarDaysHeader"><%=tools.get_web_str('day_tuesday')%></td>
			<td width=15% align=center class="calendarDaysHeader"><%=tools.get_web_str('day_wednesday')%></td>
			<td width=15% align=center class="calendarDaysHeader"><%=tools.get_web_str('day_thursday')%></td>
			<td width=15% align=center class="calendarDaysHeader"><%=tools.get_web_str('day_friday')%></td>
			<td width=12% align=center class="calendarDaysHeader"><%=tools.get_web_str('day_saturday')%></td>
			<td width=12% align=center class="calendarDaysHeader"><%=tools.get_web_str('day_sunday')%></td>
		</tr>			
		<tr bgcolor="#FFFFFF">						
<%
	for ( i = 0; i < _week_day; i++ )
	{
%>			
			<td></td>
<%
	}

	for ( i = 1; i <= _cur_num_days; i++ )
	{
		curDate = Date( i + '.' + _month + '.' + _year );

		if ( _week_day == 0 )
		{
%>
		<tr>
<%
		}
%>	
			<td background="<%
					dayArray = ArraySelect( curObjectResourceArray, 'DateNewTime( start_date ) == curDate' );
					_bg = '';
					_f_flag = false;
					_s_flag = false;
					for ( _day in dayArray )
					{
//alert(_day.start_date + '     '+Hour( _day.start_date )+' -- '+Hour( _day.finish_date )+'    '+_day.name)
						if ( Hour( _day.finish_date ) < 14 )
						{
							_bg = 'pics/fhalf.gif';
							_f_flag = true;
						}
						if ( Hour( _day.start_date ) >= 14 )
						{
							_bg = 'pics/shalf.gif';
							_s_flag = true;
						}
						if ( ( _f_flag && _s_flag ) || ( Hour( _day.finish_date ) > 14 && Hour( _day.start_date ) < 14 ) )
						{
							_bg = 'pics/full.gif';
							break;
						}
					}
					Response.Write( _bg );
			%>" class="tableRowEvenEvery"><%=i%></td>

<%
		_week_day++;		
		if ( _week_day == 7 )
		{
%>
		</tr>
<%
			_week_day = 0;
		}

	}

	a = 7 - _week_day;
	if ( _week_day )
		for ( i = 0; i < a; i++ )
		{
%>			
			<td></td>										
<%
			_week_day++;		
			if ( _week_day == 7 )
			{
%>
		</tr>
<%
			}
		}
%>							
					
	</table>
	</td>
</tr>
</table>
		</td>
	</tr>
<%
	if ( true )
	{
%>
<form action="object_resource_reserve.html" name="object_resource_form" method="post">
<INPUT TYPE="HIDDEN" NAME="doc_id" VALUE="<%=curDocID%>"/>
<INPUT TYPE="HIDDEN" NAME="sid" VALUE="<%=tools.get_sum_sid( curDocID )%>"/>
<INPUT TYPE="HIDDEN" NAME="object_id" VALUE="<%=curObjectID%>"/>

	<tr>
		<td colspan="2">
		
<%
		if ( Request.Query.HasProperty( 'm' ) && Request.Query.m == '1' )
		{
%>
		<br/>
		<br/>
		<center><font color="#FF0000"><b><%=tools.get_web_str('verb_message2')%></b></font></center>
<%
		}
%>
		
		<div style="margin:12px;" class="headerText"><%=tools.get_web_str('c_event')%></div>
		<TABLE width="100%" cellspacing="0" cellpadding="4" CLASS="tableBorder">
			<tr>
				<TD WIDTH="140"><b><%=tools.get_web_str('c_name')%>:</b></TD>
				<TD><input type="text" name="event_name" id="event_name_id" size="60" class="inputEdit"/></TD>
			</tr>
			<tr>
				<TD WIDTH="140"><b><%=tools.get_web_str('c_code')%>:</b></TD>
				<TD><input type="text" name="event_code" id="event_code_id" size="10" class="inputEdit"/></TD>
			</tr>
			<tr>
				<TD WIDTH="140"><b><%=tools.get_web_str('c_type')%>:</b></TD>
				<TD><select name="event_type" class="inputEdit" onchange="document.getElementById('education_method_tr').style.display=(this.value=='education_method'?'inline':'none')">
					<option value=""></option>
<%
		for ( _type in curLngCommon.event_types )
		{
%>
					<option value="<%=_type.PrimaryKey%>"><%=_type.name%></option>
<%
		}
%>
				</select></TD>
			</tr>
			<tr id="education_method_tr" style="display:none">
				<TD WIDTH="140"><b><%=tools.get_web_str('c_edu_method')%>:</b></TD>
				<TD><select name="event_education_method" class="inputEdit">
					<option value=""></option>
<%
		for ( _education_method in ArraySort( education_methods, 'name', '+' ) )
		{
%>
					<option value="<%=_education_method.PrimaryKey%>"><%=tools_web.get_cur_lng_name( _education_method.name )%></option>
<%
		}
%>
				</select></TD>
			</tr>
			<tr>
				<TD WIDTH="140"><b><%=tools.get_web_str('c_person_num')%>:</b></TD>
				<TD><input type="text" name="event_person_num" id="event_person_num_id" size="10" class="inputEdit"/></TD>
			</tr>
			<tr>
				<TD WIDTH="140"><b><%=tools.get_web_str('c_start_date')%>:</b></TD>
				<TD><input type="text" id="event_start_date_id" name="event_start_date" size="10" class="inputEdit"/>&nbsp;<a href="#" onclick="var h=0; var offP = this.offsetParent; while(offP.id != 'main_block' && offP.tagName.toUpperCase()!='BODY') {h+=offP.offsetTop; offP = offP.offsetParent;} ;showCalendar(this, document.getElementById('event_start_date_id'), 'dd.mm.yyyy','ru',1,null, (h + 28));return false"><img src="/scripts/calendar/calendar.gif" width="24" height="22" border="0"/></a>&nbsp;&nbsp;<input type="text" name="event_start_time" value="09:00" size="4" class="inputEdit"/></TD>
			</tr>
			<tr>
				<TD WIDTH="140"><b><%=tools.get_web_str('c_finish_date')%>:</b></TD>
				<TD><input type="text" id="event_finish_date_id" name="event_finish_date" size="10" class="inputEdit"/>&nbsp;<a href="#" onclick="var h=0; var offP = this.offsetParent; while(offP.id != 'main_block' && offP.tagName.toUpperCase()!='BODY') {h+=offP.offsetTop; offP = offP.offsetParent;} ;showCalendar(this, document.getElementById('event_finish_date_id'), 'dd.mm.yyyy','ru',1,null, (h + 28));return false"><img src="/scripts/calendar/calendar.gif" width="24" height="22" border="0"/></a>&nbsp;&nbsp;<input type="text" name="event_finish_time" value="18:00" size="4" class="inputEdit"/></TD>
			</tr>
			<tr>
				<TD WIDTH="140">&nbsp;</TD>
				<TD><input type="checkbox" name="event_is_public" checked="checked"/><%=tools.get_web_str('veb_text1')%></TD>
			</tr>
			<tr>
				<TD WIDTH="140">&nbsp;</TD>
				<TD><input type="checkbox" name="event_is_open"/><%=tools.get_web_str('veb_text2')%></TD>
			</tr>
			<tr>
				<TD WIDTH="140"><b><%=tools.get_web_str('vrb_initiator')%>:</b></TD>
				<TD><input type="text" name="event_initiator" id="event_initiator_id" size="60" class="inputEdit"/></TD>
			</tr>
			<tr>
				<TD WIDTH="140"><b><%=tools.get_web_str('c_desc')%>:</b></TD>
				<TD><textarea name="event_desc" cols="60" rows="3" class="inputEdit"></textarea></TD>
			</tr>
		</TABLE>
		
		</td>
	</tr>
	<tr>
		<td colspan="2">
		
		<table width="100%" border="0" cellspacing="0" cellpadding="0" class="activator">
			<TD ALIGN="CENTER" class="activator">
				<INPUT TYPE="button" VALUE="<%=tools.get_web_str('c_text_create_request')%>" onclick="doSubmitRequest();" CLASS="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';">
			</TD>
		</table>
		
		</td>
	</tr>
</form>
<%
	}
%>
</table>
<br/>