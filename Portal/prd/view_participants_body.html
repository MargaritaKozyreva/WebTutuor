<%
is_post = '';
_cancel = false;
if (!_cancel)
{
	try
	{
		curAssessmentPlanID = Int(Request.QueryString.assessment_plan_id);
		curAssessmentPlan = OpenDoc( UrlFromDocID( curAssessmentPlanID ) ).TopElem;
		_temp_assessment_plan = curAssessmentPlan;
	}
	catch(_blya_)
	{
		Response.Write('<center><b>' + tools.get_web_str("vrb_no_pa_text") + '</b></center>');
		//Cancel();
		_cancel = true;
	}
}
if (!_cancel)
{
	try
	{
		if (StrContains(_PRIVATE_PAS , curAssessmentPlanID) == false)
			throw 'Kuda lezesh, gad!';
	}
	catch(_gik_)
	{
		Response.Write('<center><b>' + tools.get_web_str("vrb_message1") + '</b></center>');
		//Cancel();
		_cancel = true;
	}
}
if (!_cancel)
{
	try
	{
		is_post = Request.QueryString.is_post;
	}
	catch(_zapadlo_)
	{
		is_post = '';
	}
%>


		<TABLE width="100%" border="0" cellspacing="0" cellpadding="5">
		<TR valign="top">
			<TD>



<script language="JavaScript">
<!--

function doSubmit( action )
{
	document.workflow_process.action_id.value = action;
	if (document.workflow_process.cur_comment && document.f_switch && document.f_switch.comment)
	{
<%
		if (curAssessmentAppraise.is_comment_required)
		{
%>
		if (document.f_switch.comment.value == "")
		{
			window.alert("<%=HtmlEncode(tools.get_web_str("ass_message_please_fill_in_comment"))%>");
			return false;
		}
<%
		}
%>
	
		document.workflow_process.cur_comment.value = document.f_switch.comment.value;
	}
	document.workflow_process.submit();
}



//********************************************************************************************

function xShowModalDialog( sURL, vArguments, sFeatures ) 
{ 
	if (sURL==null||sURL=='') 
	{ 
		alert ("Invalid URL input."); 
		return false; 
	} 
	if (vArguments==null||vArguments=='') 
	{ 
		vArguments=''; 
	} 
	if (sFeatures==null||sFeatures=='') 
	{ 
		sFeatures=dFeatures; 
	} 
	if (window.navigator.appVersion.indexOf("MSIE")!=-1) 
	{ 
		window.showModalDialog ( sURL, vArguments, sFeatures ); 
		return false; 
	} 
	sFeatures = sFeatures.replace(/ /gi,''); 
	aFeatures = sFeatures.split(";"); 
	sWinFeat = "directories=0,menubar=0,titlebar=0,toolbar=0,"; 
	for ( x in aFeatures ) 
	{ 
		aTmp = aFeatures[x].split(":"); 
		sKey = aTmp[0].toLowerCase(); 
		sVal = aTmp[1]; 
		switch (sKey) 
		{ 
			case "dialogheight": 
				sWinFeat += "height="+sVal+","; 
				pHeight = sVal; 
				break; 
			case "dialogwidth": 
				sWinFeat += "width="+sVal+","; 
				pWidth = sVal; 
				break; 
			case "dialogtop": 
				sWinFeat += "screenY="+sVal+","; 
				break; 
			case "dialogleft": 
				sWinFeat += "screenX="+sVal+","; 
				break; 
			case "resizable": 
				sWinFeat += "resizable="+sVal+","; 
				break; 
			case "status": 
				sWinFeat += "status="+sVal+","; 
				break; 
			case "center": 
				if ( sVal.toLowerCase() == "yes" ) 
				{ 
					sWinFeat += "screenY="+((screen.availHeight-pHeight)/2)+","; 
					sWinFeat += "screenX="+((screen.availWidth-pWidth)/2)+","; 
				} 
				break; 
		} 
	} 
	modalWin=window.open(String(sURL),"",sWinFeat); 
	if (vArguments!=null&&vArguments!='') 
	{ 
		modalWin.dialogArguments=vArguments; 
	} 
} 

function checkFocus() 
{ 
	if (window.navigator.appVersion.indexOf("MSIE")==-1) 
	{ 
		if (modalWin!=null && !modalWin.closed) 
		{ 
			self.blur(); 
			modalWin.focus(); 
		} 
	} 
}
//*************************************************************************************************

-->
</script>
<%
	Server.Execute( "view_assessment_access_variables.html" );

    try
    {
        _show_val = eval(tools_ass.get_workflow_state_parameter(_curState, "select_all"));
        if (_show_val) _show_val = 1;
    }
    catch(_wow_)
    {
        _show_val = 0;
    }
    
    try
    {
        _min_val = Int(eval(tools_ass.get_workflow_state_parameter(_curState, "min")));
    }
    catch(_wow_)
    {
        _min_val = undefined;
    }
    
    try
    {
        _max_val = Int(eval(tools_ass.get_workflow_state_parameter(_curState, "max")));
    }
    catch(_wow_)
    {
        _max_val = undefined;
    }
    
    
    _alter_role = tools_ass.get_workflow_state_parameter(_curState, "select_role");
    if (_alter_role == "")
    	_alter_role = undefined;
    
    
%>	




<script language="JavaScript">

function showHierarchy()
{
	var pars=new Object();
	pars.title = "<%=tools.get_web_str("vdsp_title")%>";
	var strAttr="status:no;dialogWidth:800px;dialogHeight:600px;help:no;resizable:1";
	
	pars.elemArray = Array();
	pars.elemNamesArray = Array();
	
	var i = 0;

	var o = document.getElementById("identifier_"+i);
	while (o)
	{
		pars.elemArray[i] = o.value;
		pars.elemNamesArray[i] = o.value2;
		i++;
		o = document.getElementById("identifier_"+i);
	}
	
	
	<%
		if (_min_val == 1 && _max_val == 1)
		{
	%>
			xShowModalDialog('dlg_select.html?catalog_name=collaborator&doc_id=<%=curDocID%>&typein=1&show_all=<%=_show_val%>&rand='+ Math.random(), pars, strAttr);
		
			pars.elemArray[0] = pars.element_id;
			pars.elemNamesArray[0] = pars.element_name;
		
	<%
		}
		else
		{
	%>
			xShowModalDialog('dlg_select.html?catalog_name=collaborator&multi_select=1&doc_id=<%=curDocID%>&typein=1&show_all=<%=_show_val%>&rand='+ Math.random(), pars, strAttr);
	<%
		}
	%>
		
	if (!pars.handle) return null;


	var tbl = document.getElementById("recycler666");
	
	for (i=tbl.rows.length-1;i>=0;i--)
	{
		tbl.deleteRow(i);
	}
	
	for (i=0;i<pars.elemArray.length;i++)
	{
		var _class = i % 2 ? 'tableRowEven' : 'tableRowOdd';
		var trow=document.createElement("TR");
		var trow=tbl.insertAdjacentElement('beforeEnd',trow);
		
		var tcol=document.createElement("TD");
		tcol.className = _class;
		trow.insertAdjacentElement('beforeEnd',tcol);
		
		var tinput = document.createElement("INPUT");
		tinput.setAttribute("id","identifier_"+i);
		tinput.setAttribute("name","identifier_"+i);
		tinput.setAttribute("type","hidden");
		tinput.setAttribute("value",pars.elemArray[i]);
		tinput.setAttribute("value2",pars.elemNamesArray[i]);

		tcol.insertAdjacentElement('beforeEnd',tinput);
		tcol.insertAdjacentHTML('beforeEnd', "&bull; " + pars.elemNamesArray[i]);
		
	}

}
//****************************************************************************************

function whatToSubmit()
{
<%
	if (curAssessmentAppraise.is_comment_required)
	{
%>
		if (document.all.comment && document.all.comment.tagName.toLowerCase() == "textarea")
			if (document.all.comment.value == "")
			{
				window.alert("<%=HtmlEncode(tools.get_web_str("ass_message_please_fill_in_comment"))%>");
				return false;
			}
<%
	}
%>
	var i = 0;
	var o = document.getElementById("identifier_" + i);
	while (o != undefined)
	{
		i++;
		o = document.getElementById("identifier_" + i);
	}
	
	var _min = <%=_min_val%>;
	var _max = <%=_max_val%>;
	
	if (_min != undefined)
		if (_min > i)
		{
			alert("<%=tools.get_web_str("vpb_error_min")%>" + _min);
			return false;
		}
	
	if (_max != undefined)
		if (_max < i)
		{
			alert("<%=tools.get_web_str("vpb_error_max")%>" + _max);
			return false;
		}
	
	return true;
}
</script>

<%Server.Execute("view_assessment_header.html");%>

<FORM ACTION="workflow_assessment_process.html" NAME="workflow_process" METHOD="POST">

	<input type="hidden" name="doc_id" value="<%=curDocID%>"/>
	<input type="hidden" name="object_id" value="<%=curAssessmentPlanID%>"/>
<%
	if (!curAssessmentAppraise.is_basic_comment)
	{
%>
		<input type="hidden" name="cur_comment" value=""/>
<%
	}
%>
	<input type="hidden" name="action_id" value=""/>
	<input type="hidden" name="mode" value="<%=curMode%>"/>
	<input type=hidden name="assessment_appraise_id" value="<%=curAssessmentAppraiseID%>"/>
	<center>
<%
	sIsLineOriented = tools_ass.get_workflow_state_parameter(_curState, "wf_buttons_orientation");
	
		for ( _action in curWorkflow.actions )
		{	
		
			/*
				alert('curPersonID='+curPersonID);
				alert('STATUS='+STATUS);
				alert('COLLABORATOR_USER_ID='+COLLABORATOR_USER_ID);
				alert('COLLABORATOR_EXPERT_ID='+COLLABORATOR_EXPERT_ID);
				alert('IS_DONE='+IS_DONE);
				alert('PA_IS_DONE='+PA_IS_DONE);
			
				alert(_action.condition_eval_str );
				alert('---');
			*/
			try
			{
			if ( _in_time && (_action.condition_eval_str == '' || eval( _action.condition_eval_str)) )
			{
%>				
					<input type="button" value="<%=_action.name%>" class="inputButton" onClick="doSubmit( '<%=_action.code%>' );" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';"/>
<%
				Response.Write(sIsLineOriented == "horizontal" ? "<nobr/>":"<br/>");
			}
			}
			catch(_hren_)
			{
				Response.Write(alert("ERROR ACTION " + _action.name + " CONDITION: " + _action.condition_eval_str + "<br/>\n" + _hren_));
			}
		}
%>	
	</center>
</FORM>

<%
	if (is_post == '1')
	{
		try
		{
			_save_message = Session.assessment_save_msg;
			Session.assessment_save_msg = "";
			if (_save_message == "" || _save_message == null || _save_message == undefined)
				throw "bez_slov";
		}
		catch(_bez_slov_)
		{
			_save_message = "";
		}
%>
<p>
<center><b><%=(_save_message != "" ? HtmlEncode(_save_message) : tools.get_web_str("c_form_save"))%></b></center>
</p>
<%
		//Cancel();
		_cancel = true;
	}

}

if (!_cancel) // _cancel start
{




if (_alter_role == undefined)
	_participant_code = curAssessmentAppraise.participant_select;
else
	_participant_code = _alter_role;
    
    
	_participant_elem = common.assessment_appraise_participants.GetOptChildByKey(_participant_code);


	_custom_title = tools_ass.get_workflow_state_parameter(_curState, "select_title");
    
	if (_custom_title == undefined)
	{
	    if (_participant_elem == undefined)
	    	_custom_title = "<font color='red'>"+tools.get_web_str("vpb_error_role")+'</font>';
	    else
	    {
	    	_custom_title = curAssessmentAppraise.participants.GetOptChildByKey(_participant_code);
	    	if (_custom_title != undefined && _custom_title.customize.custom_title.HasValue)
	    		_custom_title = _custom_title.customize.custom_title;
	        else
		    	_custom_title = _participant_elem.name;
	    }
	}
%>


					<form action='participants_save.html' name='f_switch' id='f_switch' method="POST">
					
					<input type="hidden" name="doc_id" value="<%=curDocID%>">
					<input type=hidden name="assessment_appraise_id" value="<%=curAssessmentAppraiseID%>">
					<input type=hidden name="is_post" value="1">
                    <input type=hidden name="role" value="<%=_participant_code%>">
					<input type=hidden name="assessment_plan_id" value="<%=Request.QueryString.assessment_plan_id%>">
					<input type=hidden name="isflawed" value="">
<%
				if (_min_val != undefined && _min_val == _max_val)
					Response.Write(tools.get_web_str("ass_need_amount") + ":" + _min_val + "<br/>");
                else
                {
                    if (_min_val != undefined)
                             Response.Write(tools.get_web_str("ass_min") + ":" + _min_val + "<br/>");
                    if (_max_val != undefined)
                             Response.Write(tools.get_web_str("ass_max") + ":" + _max_val + "<br/>" );
                }

				if (IS_MODIFY)
				{
%>
					<br/>
					<input type="button" value="<%=tools.get_web_str("vdsp_title")%>" class="inputButton" onClick="showHierarchy()" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';">

<%
				}
				
%>
						<table width=100% cellpadding=0 cellspacing=0 border=0 bgcolor="gray"><tr><td>
						<table width=100% cellpadding=1 cellspacing=1>

							<tr>
								<td bgcolor="silver">
									<%=_custom_title%>
								</td>
							</tr>
							<tbody id="recycler666">
								<%
                                	_cur_experts = ArraySelect(curAssessmentPlan.experts , 'status == _participant_code');
                                    _i = 0;
									for(_ex in _cur_experts)
									{
										_class = _ex.ChildIndex % 2 ? 'tableRowEven' : 'tableRowOdd';
								%>
										<tr>
											<td class="<%=_class%>">
												<input type="hidden" name="identifier_<%=_i%>" id="identifier_<%=_i%>" value="<%=_ex.PrimaryKey%>" value2="<%=_ex.PrimaryKey.ForeignElem.fullname%>"/>
												&bull; <%=_ex.PrimaryKey.ForeignElem.fullname%>
											</td>
										</tr>
								<%
										_i++;
									}
								%>
							</tbody>
						</table>
						</td></tr></table>

			
					<%
						if (IS_MODIFY && _participant_elem != undefined)
						{
					%>
						<p><center><input type=submit onclick='return whatToSubmit();' value="   <%=tools.get_web_str("c_save")%>   " class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';"></center></p>
					<%
						}
					
						curPA = curAssessmentPlan;
						Server.Execute('view_assessment_comment.html');
					%>



					</form>
<%
	} // _cancel end
%>
			</td>
		</tr>
		</table>