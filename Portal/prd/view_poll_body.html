<script src="scripts/calendar/calendar.js"></script>
<%
try
{
	if ( curUserID == null )
		throw 'no_user';

	Server.Execute( "include/access_init.html" );
}
catch ( err )
{
	curUserID = null;
	curUser = null;
	if ( ! Session.HasProperty( 'sid' ) )
		Session.sid = Random( 0, 1152921504606846976 );

	Server.Execute( "include/host_init.html" );
	Server.Execute( "include/object_init.html" );
}

//View modes: CREATE,EDIT,VIEW,DENIED,DELETE
sViewMode="CREATE";

teCurUserResult = null;
catCurUserResult = undefined;
if(curObject.is_one_time)
{ 
	catCurUserResult = ArrayOptFirstElem(XQuery( "for $elem in poll_results where $elem/poll_id = " + curObjectID + " and $elem/person_id = " + curUserID + " return $elem"));
	if(catCurUserResult != undefined)
	{
		if(Request.Query.HasProperty("edit") && curObject.allow_change)
		{
			sViewMode = "EDIT";
		}
		else if(curObject.allow_view || curObject.allow_change)
		{
			sViewMode = "VIEW";			
		}
		else
		{
			sViewMode = "DENIED";
		}
		if(sViewMode == "EDIT" || sViewMode=="VIEW" )
		{
			teCurUserResult = OpenDoc( UrlFromDocID( catCurUserResult.id ) ).TopElem;
		}
	}
}
if(curObject.report_viewers.ChildByKeyExists(curUserID))
{
    if(Request.QueryString.HasProperty("show_report"))
    {
        var Ps = curObject;
        Session.excel_html = EvalCodePageUrl( 'x-local://templates/poll_results_report.html' );
%>
<script language="javascript">
document.location.href="assessment_excel_export.html";
</script>
<%
        //Response.Redirect( 'assessment_excel_export.html' );
    }


    if(Request.QueryString.HasProperty("clear_results"))
    {
       xarrResults= XQuery( "for $elem in poll_results where $elem/poll_id = " + curObjectID + " and $elem/person_id = " + curUserID + "  return $elem");
       if(ArrayOptFirstElem(xarrResults) != undefined)
       {
       		for(catResult in xarrResults)
            {
	            DeleteDoc( UrlFromDocID( catResult.PrimaryKey ), true );
            }
       }
    }
%>
<TABLE WIDTH="100%" CELLSPACING="0" CELLPADDING="5" CLASS="activator">
	<TR VALIGN="MIDDLE">
		<TD ALIGN="CENTER">
		<input type="button" value="<%=tools.get_web_str('vpb_report')%>" onclick="location.href='view_doc.html?mode=poll&doc_id=<%=curDocID%>&object_id=<%=curObjectID%>&show_report=1'"/>
		<input type="button" value="<%=tools.get_web_str('vpb_clear_results')%>" onclick="location.href='<%=tools_web.get_query_string(true, 'clear_results')%>clear_results=1'"/>
		</TD>
	</TR>
</TABLE>
<%
}
_cont_flag = true;
if ( ( curObject.start_date.HasValue && curObject.start_date > CurDate ) || ( curObject.end_date.HasValue && curObject.end_date < CurDate ) )
{
%>
<center><font color="red"><%=tools.get_web_str('vpb_start_message')%></font></center>
<%
	//_cont_flag = false;
	sViewMode == "DENIED";
}
else if ( ! curObject.is_anonymous && curObject.is_one_time && sViewMode != "CREATE" )
{
%>
<center><font color="red"><%=tools.get_web_str('vpollb_message1')%></font></center>
<%
	//_cont_flag = false;
}
if ( sViewMode != "DENIED" )
{

questionArray = Array();
questionNamesArray = Array();
questionSelectArray = Array();
questionSelectNamesArray = Array();

aFormuledQuestions = ArraySelect(curObject.questions, "This.value_condition.HasValue");
%>

<script language="javascript">
function set_foreign_elem_field(_name,_catalog,_value)
{
	var pars=new Object();
	var strAttr='status:no;dialogWidth:780px;dialogHeight:550px;help:no;resizable:1';
	pars.element_id =_value;
	pars.can_be_empty = true;

	xShowModalDialog('dlg_select.html?doc_id=<%=curDocID%>&catalog_name='+ _catalog +'&typein=0&multi_select=0&rand='+Math.random(), pars, strAttr);
	if ( ! pars.handle )
		return null;

	document.getElementById(_name).value = pars.element_name;
	document.getElementById('q'+_name).value = pars.element_id;
}
function poolSubmit()
{
	var required_questions = document.custom_templates_form.required_questions.value;
	var required_select_questions = document.custom_templates_form.required_select_questions.value;
	if ( required_questions == '' && required_select_questions == '' && <%=(ArrayOptFirstElem(aFormuledQuestions) == undefined)%>)
	{
		document.custom_templates_form.submit();
		return false;
	}

	var reqQuestionsStr = '';
	var required_questions_names = document.custom_templates_form.required_questions_names.value;
	var required_select_questions_names = document.custom_templates_form.required_select_questions_names.value;
	var required_questions_array = required_questions.split( ';' );
	var required_questions_names_array = required_questions_names.split( '#~#' );
	var required_select_questions_array = required_select_questions.split( ';' );
	var required_select_questions_names_array = required_select_questions_names.split( '#~#' );
//debugger;
	for ( var i=0; i < required_questions_array.length; i++ )
		if ( required_questions_array[ i ] != '' )
		{
			var entry = document.forms[ 'custom_templates_form' ].elements[ required_questions_array[ i ] ];
			if ( entry.length == undefined || ( entry.tagName != undefined && entry.tagName.toLowerCase() == 'select' ) )
			{
				if ( entry.value == '' )
					reqQuestionsStr += required_questions_names_array[ i ] + '\n';
			}
			else
			{
				var add_flag = true;
				for ( var j=0; j < entry.length; j++ )
					if ( entry[ j ].checked )
					{
						add_flag = false;
						break;
					}
				if ( add_flag )
					reqQuestionsStr += required_questions_names_array[ i ] + '\n';
			}
		}

	for ( var i=0; i < required_select_questions_array.length; i++ )
		if ( required_select_questions_array[ i ] != '' )
		{
			var entrys = required_select_questions_array[ i ].split( '#' );
			var add_flag = true;
			for ( var j=0; j < entrys.length; j++ )
				if (entrys[ j ]!= "")
				if ( eval( 'document.custom_templates_form.' + entrys[ j ] ).checked )
				{
					add_flag = false;
					break;
				}

			if ( add_flag )
				reqQuestionsStr += required_select_questions_names_array[ i ] + '\n';
		}
	var o,_ok,ANSWER,ANSWERS;
<%
	for ( _question in aFormuledQuestions)
	{
%>
	ANSWERS=0;
	ANSWER = "";
<%
		switch (_question.type)
		{
			case "select":
			for ( _entry in _question.entries )
			{
%>
	o = document.all["q<%=_question.id%>_" + "<%=_entry.id%>"];
	if (o != undefined) if (o.checked) {ANSWERS++;ANSWER+=(ANSWER != "" ? ";":"")+o.value}
<%
			}
			break;
			default:
%>
	o = document.all["q<%=_question.id%>"];
	if (o != undefined)
	{
<%
			if (_question.type == "choice")
			{
%>
			if (o.name == undefined && o.length != undefined)
			{
				for (var j = 0; j < o.length; j++) if (o[j].checked) {ANSWERS++;ANSWER+=(ANSWER != "" ? ";":"")+o[j].value}
			}
			else
<%
			}
%>
			{
			ANSWER = o.value;
			if (ANSWER != "") ANSWERS++;
			}
	}
<%
		}
%>
		try
		{
			_ok = eval("<%=StrReplace(_question.value_condition, "\"", "\\\"")%>");
			if (_ok) _ok = true; else _ok = false;
		}
		catch(_x_)
		{
			_ok = true;
		}
		if (!_ok)
		{
			window.alert("<%=tools.get_web_str("vppb_all_invalid_value")+" - "+tools.get_web_str("c_question")+" "+(_question.ChildIndex + 1)%>");
			return false;
		}
<%
	}
%>
	if ( reqQuestionsStr == '' )
		document.custom_templates_form.submit();
	else
		alert( <%=CodeLiteral( tools.get_web_str('vpb_mess_mondatory_question') )%> + ":\n" + reqQuestionsStr );

	return false;
}
</script>


<FORM ACTION="poll_result_create.html" NAME="custom_templates_form" METHOD="POST">
<INPUT TYPE="HIDDEN" NAME="poll_id" VALUE="<%=curObjectID%>"/>
<INPUT TYPE="HIDDEN" NAME="sid" VALUE="<%=tools.get_sum_sid( curObjectID )%>"/>
<INPUT TYPE="HIDDEN" NAME="doc_id" VALUE="<%=curDocID%>"/>
<INPUT TYPE="HIDDEN" NAME="view_mode" id="view_mode" VALUE="<%=sViewMode%>"/>

<TABLE width="100%" cellspacing="4" cellpadding="0" border="0">
<TR>
	<TD>

	<TABLE width="100%" cellspacing="0" cellpadding="4" border="0">
<%

	function show_question(_question)
	{
	//Response.Write('title='+_question.title);
		if ( String(_question)== '0' )
		{

%>
			<TR>
				<TD ALIGN="center"><b></b></TD>
			</TR>
<%

			return;
		}
		if ( _question.type == 'title' )
		{
			if ( _question.show_header )
			{
%>
			<TR>
				<TD ALIGN="center" colspan="2"><b><%=HtmlEncode( _question.title )%></b></TD>
			</TR>
<%
			}
			return;
		}
		else
		{
			if ( _question.show_header )
			{
%>
			<TR>
				<TD ALIGN="left" colspan="2"><%=HtmlEncode( _question.title )%></TD>
			</TR>
<%
			}
		}
		sDefaultValue = _question.default_value;
		fldQuestionAnswer = undefined;
		if(sViewMode == "EDIT" || sViewMode=="VIEW")
			fldQuestionAnswer = ArrayOptFind(teCurUserResult.questions,'id=='+_question.id);
		sDisabled = (sViewMode=="VIEW" ? "disabled=\"disabled\"" : "");
		switch ( _question.type )
		{
			case 'combo':
%>
			<TR>
				<TD><select name="q<%=_question.id%>" <%=sDisabled%>>
					<option value=""></option>
<%
				for ( _entry in _question.entries )
				{
					if(fldQuestionAnswer == undefined)
					{
						sSelected = (_question.default_value == _entry.value) ? 'selected="selected"' : '';
					}
					else
					{
						sSelected = (String(fldQuestionAnswer.value) == String(_entry.id)) ? 'selected="selected"' : '';
					}
%>
					<option value="<%=_entry.id%>" <%=sSelected%>><%=HtmlEncode( _entry.value )%></option>
<%
				}
%>
					</select>
				</TD>
			</TR>
<%
				break;

			case 'text':
					sValue = (fldQuestionAnswer != undefined) ? fldQuestionAnswer.value : _question.default_value;
%>
			<TR>
				<TD ALIGN="LEFT"><textarea name="q<%=_question.id%>" rows="5" cols="60" <%=sDisabled%>><%=sValue%></textarea></TD>
			</TR>
<%
				break;

			case 'select':
%>
			<TR>
				<TD ALIGN="LEFT">
<%
				arrDefaultValues = String( _question.default_value ).split( ';' )
				
				sAnswers = new Array();
				if(fldQuestionAnswer != undefined)
				{
					sAnswers = String( fldQuestionAnswer.value ).split( ';' );
				}
				for ( _entry in _question.entries )
				{
					sChecked = '';
					if(sAnswers.length > 0)
					{
						for(sValue in sAnswers)
						{
							if(sValue == String(_entry.id))
							{
								sChecked = 'checked="checked"';
								break;
							}
						}
					}
					else
					{
						for(sValue in arrDefaultValues)
						{
							if(sValue == _entry.value)
							{
								sChecked = 'checked="checked"';
								break;
							}
						}
					}
%>
					<input name="q<%=( _question.id + '_' + _entry.id )%>" type="checkbox" value="<%=_entry.id%>" <%=sChecked%> <%=sDisabled%>/><%=_entry.value%><br/>
<%
				}
%>
				</TD>
			</TR>
<%
				break;

			case 'choice':
%>
			<TR>
				<TD ALIGN="LEFT">
<%
				sValue = (fldQuestionAnswer != undefined) ? fldQuestionAnswer.value : _question.default_value;
				for ( _entry in _question.entries )
				{
					if(fldQuestionAnswer != undefined)
						sChecked = (String(fldQuestionAnswer.value) == String(_entry.id)) ? 'checked="checked"' : '';
					else
						sChecked = (sValue == _entry.value) ? 'checked="checked"' : '';
%>
					<input name="q<%=_question.id%>" type="radio" value="<%=_entry.id%>" <%=sChecked%> <%=sDisabled%>/><%=_entry.value%><br/>
<%
				}
%>
				</TD>
			</TR>
<%
				break;

			case 'number':				
					sValue = (fldQuestionAnswer != undefined) ? fldQuestionAnswer.value : _question.default_value;
%>
				<TR>
					 <TD ALIGN="LEFT"><%=tools_web.draw_calendar('q'+ _question.id,sValue,'dd.mm.yyyy')%></TD>
				</TR>
<%
				break;

			case 'link_to_database_object':
			//Response.Write('title='+_question.title);
						try
		{
			_value = curObject.custom_elems.GetChildByKey( _field.name ).value;
		}
		catch ( dd )
		{
			_value = '';
		}

		_str = '';


				_value_str = '';
				if ( _value != '' )
				{
					try
					{
						_disp_name = curLngCommon.exchange_object_types.GetChildByKey( _question.catalog ).disp_name;
						_value_str = HtmlEncode( OpenDoc( UrlFromDocID( Int( _value ) ) ).TopElem.Child( _disp_name ) );
					}
					catch ( err )
					{
						_value_str = HtmlEncode( tools.get_web_str('c_deleted') );
					}
				}
				
				sValueStr = "";
				sValueId = "";
				if(fldQuestionAnswer != undefined)
				{
					catAnsweredNum = ArrayOptFirstElem(XQuery( "for $elem in " + _question.catalog + "s where $elem/id = " + fldQuestionAnswer.value + " return $elem"));
					if(catAnsweredNum != undefined)
					{
						sValueId = catAnsweredNum.id;
						sDispName = curLngCommon.exchange_object_types.GetChildByKey( _question.catalog ).disp_name;
						sValueStr = catAnsweredNum.Child( sDispName );
					}
					else
					{
						sValueStr = HtmlEncode( tools.get_web_str('c_deleted') );
					}
				}
				
				//Response.Write('title='+_question.title);
%>
					  <tr>
						<input type="hidden" name="q<%=_question.id%>" id="q<%=_question.id%>" value="<%=sValueId%>" <%=sDisabled%>/>
                        <td><input type="text" name="<%=_question.id%>" id="<%=_question.id%>" value="<%=sValueStr%>" size="60" class="inputEdit" readonly="readonly"/>&nbsp;<input type="button" value="<%=tools.get_web_str('c_choose')%>" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';" onclick="set_foreign_elem_field('<%=_question.id%>','<%=_question.catalog%>','<%=_value%>')" <%=sDisabled%>/></td>
					</tr>
<%
//Response.Write('title='+_question.title);
				break;
//------------------------------------
					default:
							
					sValue = (fldQuestionAnswer != undefined) ? fldQuestionAnswer.value : _question.default_value;
		%>
			<TR>
				 <TD ALIGN="LEFT"><INPUT type="text" NAME="q<%=_question.id%>" VALUE="<%=sValue%>" SIZE="60" CLASS="inputEdit" <%=sDisabled%>/></TD>
			</TR>
		<%
		}

		if ( _question.required )
		{
			if ( _question.type == 'select' )// || _question.type == 'choice' )
			{
				questionSelectArray[ArrayCount(questionSelectArray)] = ArrayMerge( _question.entries, "'q" + _question.id + "_' + id", "#" );
				questionSelectNamesArray[ArrayCount(questionSelectNamesArray)] = HtmlToPlainText( _question.title );
			}
			else
			{
				questionArray[ArrayCount(questionArray)] = 'q' + _question.id;
				questionNamesArray[ArrayCount(questionNamesArray)] = HtmlToPlainText( _question.title );
			}
		}
		if (_question.add_comment)
		{
%>
	<TR>
		<TD ALIGN="left" colspan="2"><br/><%=tools.get_web_str("vpollb_comment")%></TD>
	</TR>
	<TR>
		<TD ALIGN="left" colspan="2"><textarea name="q<%=_question.id%>_comment" id="q<%=_question.id%>_comment" rows="5" cols="30"></textarea></TD>
	</TR>
<%
		}
	}

	for ( _question in curObject.questions )
	{
		if ( _question.is_in_table )
			continue;

		if ( _question.type == 'table' )
		{
			if ( _question.show_header )
			{
%>
			<TR>
				<TD ALIGN="left" colspan="2"><%=_question.title%></TD>
			</TR>
<%
			}
%>
			<TR>
				<td bgcolor="gray" style="padding:0">
				<TABLE width="100%" cellspacing="1" cellpadding="5" border="0">
<%
				_rows_array=_question.rows;
				for(i=0;i<ArrayCount(_rows_array);i++)
				{
%>
					<TR bgcolor="white">
<%
					if (i==0)
					{
%>
					<TD ALIGN="LEFT">&nbsp;</TD>
<%
					}
					else
					{
%>
						<TD ALIGN="LEFT" style="background: rgb(<%=_rows_array[i].bg_color%>)"><b><%=_rows_array[i].value%></b></TD>
<%
					}
					for (j=0;j<ArrayCount(_rows_array[0].columns);j++)
					{
						if (i==0)
						{
%>
							<TD ALIGN="LEFT" style="background: rgb(<%=_rows_array[i].bg_color%>)"><b><%=_rows_array[i].columns[j].value%></b></TD>
<%
						}
						else
						{
%>
							<TD>
							<TABLE width="100%" cellspacing="1" cellpadding="0" border="0">
<%
							//Response.Write(Trim(_rows_array[i].columns[j].value));
							_quest=0;
							try
							{
							_quest=curObject.questions.GetChildByKey(Int(Trim(_rows_array[i].columns[j].value)));
							}
							catch (e)
							{
							}
							show_question(_quest);
%>
							</TABLE>
							</TD>
<%
						}
					}
%>
					</TR>
<%
				}
%>
				</TABLE>
				</td>
			</TR>
<%
		}
		else
		{
			show_question( _question );
		}
	}
%>
	</TABLE>

	</TD>
</TR>
<TR>
	<TD ALIGN="CENTER">

	<table width="100%" border="0" cellspacing="0" cellpadding="0" class="activator">
	<tr>
		<TD ALIGN="CENTER" class="activator">
<%
	if(sViewMode=="CREATE" || sViewMode=="EDIT")
	{
%>
			<input type="button" value="<%=tools.get_web_str('c_save')%>" onclick="poolSubmit()" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';"/>
<%
	}
	
	if(sViewMode == "VIEW" && curObject.allow_change && !curObject.is_anonymous)
	{
%>
		<input type="button" value="Изменить" onclick="location.href='<%=tools_web.get_query_string(true, 'edit')%>edit=1'" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';"/>
<%		
	}
	if((sViewMode == "VIEW" || sViewMode == "EDIT") && curObject.allow_delete && !curObject.is_anonymous)
	{
%>
		<input type="button" value="Удалить" onclick="document.getElementById('view_mode').value='DELETE';poolSubmit()" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';"/>
<%		
	}
%>			
		</TD>
	</tr>
	</table>

	</TD>
</TR>

</TABLE>
<input type="hidden" name="required_questions" value="<%=ArrayMerge( questionArray, 'This', ';' )%>"/>
<input type="hidden" name="required_questions_names" value="<%=XmlAttrEncode( ArrayMerge( questionNamesArray, 'This', '#~#' ) )%>"/>
<input type="hidden" name="required_select_questions" value="<%=ArrayMerge( questionSelectArray, 'This', ';' )%>"/>
<input type="hidden" name="required_select_questions_names" value="<%=XmlAttrEncode( ArrayMerge( questionSelectNamesArray, 'This', '#~#' ) )%>"/>
</FORM>
<%
}
%>