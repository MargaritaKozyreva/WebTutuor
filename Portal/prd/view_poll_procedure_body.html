<%
	if (curObject == null)
	{
%>
<table width="100%"  border="0" cellspacing="0" cellpadding="3">
		<tr>
			<td class="tableHeaderWithText"><%=tools_web.get_web_str("vppb_procedure")%></td>
			<td width="100px" class="tableHeaderWithText"><%=tools_web.get_web_str("vppb_are_completed")%></td>
		</tr>
		<tr>
			<td class="tableHeaderNoText" colspan="2"><img src="pics/1blank.gif" width="1" height="1" /></td>				
		</tr>

<%
	counter = 0;
	_prs_im_in = XQuery("for $elem in poll_procedures where $elem/is_model = false() and doc-contains($elem/id,'wt_data','[sub_person_id=" +curUserID+"]') return $elem");
	for (_pps in ArraySelect(poll_procedures,"web_display == true"))
	{
		if (curUserID == _pps.person_id)
			_prs = XQuery("for $elem in poll_results where $elem/poll_procedure_id = " +_pps.PrimaryKey+ " return $elem");
		else
		{
			_prs = XQuery("for $elem in poll_results where $elem/person_id = " + curUserID +" and $elem/poll_procedure_id = " +_pps.PrimaryKey+ " return $elem");
		}
		
		if (ArrayOptFirstElem(_prs) == undefined)
		{
			if (ArrayOptFind(_prs_im_in, "PrimaryKey == " + _pps.PrimaryKey) != undefined)
				_prs = XQuery("for $elem in poll_results where $elem/poll_procedure_id = " +_pps.PrimaryKey+ " return $elem");
		}
		_done_prs = ArraySelectByKey(_prs, true, "is_done");
		
		if (ArrayOptFirstElem(_prs) != undefined)
		{
			_class = counter++ % 2 ? "tableRowEven" : "tableRowOdd";
%>
		<TR valign="middle">
			<TD class="<%=_class%>"><a HREF="view_doc.html?mode=<%=curMode%>&doc_id=<%=curDocID%>&object_id=<%=_pps.id%>"><%=_pps.name%></a></TD>
			<TD class="<%=_class%>" align="center"><%=(ArrayCount(_prs) == ArrayCount(_done_prs) ? "<img src='pics/ok.gif'/>" : "")%></TD>
		</TR>
<%
		}
	}
%>
		<tr>
			<td class="tableFooter" colspan="2"><img src="pics/1blank.gif" width="1" height="1" /></td>
		</tr>
</table>
<BR/>
<%
	}
	else
	{
		if (curObject.web_display)
		{
%>
		<table width="100%" cellpadding="0" cellspacing="0" border="0" bgcolor="gray"><tr><td>
		<table width="100%" cellpadding="10" cellspacing="1" id="comp_data_table">
		<tr bgcolor="white">
			<td width="200" valign="top">
				<table border="0" cellspacing="0" cellpadding="1">
<%
		try
		{
			_curPollResultID = Int(Request.Query.poll_result_id);
		}
		catch(_o_)
		{
			_curPollResultID = undefined;
		}
		
	
		_i_m_responsible = (ArrayOptFind(curObject.subdivisions, "person_id == " + curUserID) != undefined);
		if (_i_m_responsible)
		{
			_my_pigeons = ArraySelect(curObject.auditorys, "responsible_person_id == " + curUserID);
			_my_pigeons_line = ArrayMerge(_my_pigeons, "This.person_id", ";");
		}
		else
			_my_pigeons = Array();
		
		if (curUserID == curObject.person_id)
		{
			_results = XQuery("for $elem in poll_results where $elem/poll_procedure_id = " +curObjectID+ " return $elem");
			_poll_list = curObject.polls;
			for (_pg in curObject.additional.poll_groups)
				_poll_list = ArrayUnion(_poll_list, _pg.polls);
			
			_poll_list = ArraySelectDistinct(_poll_list, "PrimaryKey");
		}
		else
		{
			_results = XQuery("for $elem in poll_results where $elem/person_id = " + curUserID +" and $elem/poll_procedure_id = " +curObjectID+ " and $elem/status != 1 return $elem");
			if (_i_m_responsible)
			{
				_results = ArraySelectDistinct( ArrayUnion(_results, XQuery("for $elem in poll_results where $elem/poll_procedure_id = " +curObjectID+ " and contains(" + XQueryLiteral(_my_pigeons_line) + ", $elem/person_id) return $elem")) , "id");
				_poll_list = Array();
												
				for (_curaud in ArrayUnion(_my_pigeons, ArraySelect(curObject.auditorys, "person_id == " + curUserID)))
				{
					if (ArrayCount(_curaud.poll_groups) > 0)
					{
						for (_pg in _curaud.poll_groups)
						{
							_pg_herself = _pg.PrimaryKey.OptForeignElem;
							if (_pg_herself != undefined)
							{
								_poll_list = ArrayUnion(_poll_list, ArraySelect(_pg_herself.polls, 'poll_id.HasValue'));
							}
						}
					}
					else
						_poll_list = ArraySelect(curObject.polls, "poll_id.HasValue");
				}
				_poll_list = ArraySelectDistinct(_poll_list, "PrimaryKey");
			}
			else
			{
				_poll_list = Array();
				_curaud = curObject.auditorys.GetOptChildByKey(curUserID);
				if (_curaud != undefined)
				{
					if (ArrayCount(_curaud.poll_groups) > 0)
					{
						for (_pg in _curaud.poll_groups)
						{
							_pg_herself = _pg.PrimaryKey.OptForeignElem;
							if (_pg_herself != undefined)
							{
								_poll_list = ArrayUnion(_poll_list, ArraySelect(_pg_herself.polls, 'poll_id.HasValue'));
							}
						}
						_poll_list = ArraySelectDistinct(_poll_list, "PrimaryKey");
					}
					else
						_poll_list = ArraySelect(curObject.polls, "poll_id.HasValue");
				}
			}
		}	
		
					
		_undone_count = 0;
		_x = 0;
		
		_bad_results = Array();
		
		for (_poll in _poll_list)
		{
			_x++;
			for (_result in ArraySelect(_results, "poll_id == " + _poll.PrimaryKey))
			{
				_poll = _result.poll_id.OptForeignElem;
				if (curObject.additional.mini_workflow_code.HasValue)
				{
					POLL_PROCEDURE = curObject;
					POLL_PROCEDURE_ID = curObjectID;
					RESULT_ENTRY = _result;
					POLL_ENTRY = _poll;
					I_AM_RESPONSIBLE = _i_m_responsible;
					SUBORDINATES_IDS = ArrayExtract(_my_pigeons, "person_id");
					try
					{
						if (eval(curObject.additional.mini_workflow_code) == false) continue;
					}
					catch(_OoO_){alert(POLL_PROCEDURE.name + ": Code failed!\n" + _OoO_);}
				}
				
				if (!_result.is_done && _result.status != 1)
				{
					_bad_results[ArrayCount(_bad_results)] = _result;
					if (_result.person_id == curUserID)
						_undone_count++;
				}
%>
				<tr><td><%=(_result.is_done ? "<img src='pics/ok.gif'/>&nbsp;&nbsp;" : "<li/>")%><a HREF="view_doc.html?mode=<%=curMode%>&doc_id=<%=curDocID%>&object_id=<%=curObjectID%>&poll_id=<%=_result.poll_id%>&poll_result_id=<%=_result.id%>" style="font-weight: <%=(_result.id == _curPollResultID ? "bold": "normal")%>"><%=_x%>.<%=((_poll != undefined ? _poll.name : "*"+tools.get_web_str("c_error")+"*" ) + (_i_m_responsible || curUserID == curObject.person_id ? " [" + _result.person_fullname +"]":""))%></a></td></tr>
<%
			}
		}
		
%>
			</table>
			</td>
			<td valign="top">
<%
	try
	{
		_curPollID = Int(Request.Query.poll_id);
		_curPoll = OpenDoc(UrlFromDocID(_curPollID)).TopElem;
		_curPollResult = OpenDoc(UrlFromDocID(_curPollResultID)).TopElem;
	}
	catch(_o_)
	{
		_curPollID = undefined;
		_curPoll = undefined;
		_curPollResultID = undefined;
		_curPollResult = undefined;
	}
	if (_undone_count > 0 && _curPollResult != undefined && _curPollResult.person_id == curUserID && curObject.status != 1 && _curPollResult.status != 1)
		IS_MODIFY = true;
	else
		IS_MODIFY = false;
	
	if (IS_MODIFY)
	{
		if ((curObject.start_date.HasValue && curObject.start_date > Date()) || (curObject.end_date.HasValue && curObject.end_date < Date()) )
		{
%>
			<p><center><font size="+1" color="red"><%=tools_web.get_web_str("vppb_procedure_conduct_period")%><%=(curObject.start_date.HasValue ? " "+tools_web.get_web_str("vppb_from")+" " + DateNewTime(curObject.start_date):"" )%><%=(curObject.end_date.HasValue ? " "+tools_web.get_web_str("vppb_to")+" " + DateNewTime(curObject.end_date):"" )%></font></center></p>
<%
			IS_MODIFY = false;
		}
	}
	
	if (curObject.status == 1)
	{
%>
			<p><center><font><%=tools_web.get_web_str("vppb_procedure_is_completed")%></font></center></p>
<%
	}
	
	if (_curPoll != undefined)
	{
		_str_required = "";
%>
<center><font size="3"><%=_curPoll.name%></font></center><br/>
<%
	if (curObject.status != 1)
	if (curObject.person_id == curUserID || (_curPollResult.person_id.HasValue && ArrayOptFind(_my_pigeons, "person_id == " + _curPollResult.person_id) != undefined) )
	{
%>
		<b><%=tools_web.get_web_str("vppb_state")%>:</b>&nbsp;<%=(_curPollResult.status == 0? tools_web.get_web_str("vppb_state_working") : tools_web.get_web_str("vppb_state_rejected"))%>
		<form action="poll_procedure_save.html" id="poll_procedure_<%=_curPollID%>_management" name="poll_procedure_<%=_curPollID%>_management" method="POST" enctype="multipart/form-data">
		<input type="HIDDEN" name="doc_id" value="<%=curDocID%>"/>
		<input type="HIDDEN" name="poll_id" value="<%=_curPollID%>"/>
		<input type="HIDDEN" name="poll_result_id" value="<%=_curPollResultID%>"/>
		<input type="HIDDEN" name="mode" value="<%=curMode%>"/>
		<input type="HIDDEN" name="change_status" value=""/>
		<%
			_is_confirmed = false;
			
			if (_i_m_responsible)
			{
				_bad_results = ArraySelect(_bad_results, "StrContains('" + _my_pigeons_line + "', person_id + '')");
				if (ArrayOptFind(curObject.subdivisions, "person_id == " + curUserID + " && confirmation == false") == undefined)
					_is_confirmed = true;
			}
			else if (curObject.person_id == curUserID && curObject.status == 1)
				_is_confirmed = true;
			
			if (_is_confirmed)
				Response.Write("<center><font color='maroon'><b>"+tools_web.get_web_str("vppb_completion_acknowledged")+"</b></font></center>");
			
			if (_curPollResult.status == 0)
			if (curUserID == curObject.person_id || (_i_m_responsible == true && _is_confirmed == false))
			{
		%>
				<textarea name="comment" id="comment" cols="50" rows="8"><%=_curPollResult.comment%></textarea><br/>
				<input type="submit" value="<%=tools_web.get_web_str("vppb_do_reject")%>" onclick="document.all['change_status'].value=1; return true;" class="inputButton" onmouseover="this.className='inputButtonOver';" onmouseout="this.className='inputButton';"/>
		<%
			}
			if (_curPollResult.status == 1)
			if (curUserID == curObject.person_id || (_i_m_responsible == true && _is_confirmed == false))
			{
		%>
				<p><%=_curPollResult.comment%></p>
				<input type="submit" value="<%=tools_web.get_web_str("vppb_do_return_2_work")%>" onclick="document.all['change_status'].value=0; return true;" class="inputButton" onmouseover="this.className='inputButtonOver';" onmouseout="this.className='inputButton';"/>
		<%
			}
			
			//_bad_results = XQuery("for $elem in poll_results where $elem/poll_procedure_id = " +curObjectID+ " and $elem/is_done = false() and $elem/status != 1 return $elem");
			
			if (ArrayOptFirstElem(_bad_results)==undefined)
			{
				if (_is_confirmed == false)
				{
		%>
				<input type="hidden" name="responsible_type" value="<%=(_i_m_responsible ? 0 : 1)%>"/>
				<p>
				<center><input type="submit" value="<%=tools_web.get_web_str("vppb_do_acknowledge_completion")%>" onclick="document.all['change_status'].value='ok'; return true;" class="inputButton" onmouseover="this.className='inputButtonOver';" onmouseout="this.className='inputButton';"/></center>
				</p>
<%
				}
			}
			else if (curObject.person_id == curUserID)
			{
%>
				<center><input type="submit" value="<%=tools_web.get_web_str('vppb_finish_procedure')%>" onclick="document.all['change_status'].value='enough'; return true;" class="inputButton" onmouseover="this.className='inputButtonOver';" onmouseout="this.className='inputButton';"/></center>
<%
			}
			else if (_i_m_responsible)
			{
%>
				<center><input type="submit" value="<%=tools_web.get_web_str('vppb_finish_procedure')%>" onclick="document.all['change_status'].value='close'; return true;" class="inputButton" onmouseover="this.className='inputButtonOver';" onmouseout="this.className='inputButton';"/></center>
<%				
			}
%>
		
		</form>
		<br/>
		<hr/>
		<br/>
<%
	}
		
	if (_undone_count == 0 && curObject.additional.show_after_completion == false)
	{
%>
	<center><font color='maroon'><b><%=tools_web.get_web_str("vppb_all_forms_filled")%></b></font></center>
<%
	}
	else
	{
		Response.Write(_curPoll.comment.HasValue ? _curPoll.comment + "<br/>" : "");
%>

<script language="javascript" src="scripts/calendar/calendar.js"></script>
<script language="javascript">
function set_foreign_elem_field(_name,_catalog,_value,_isMultiple)
{
	var pars=new Object();
	var strAttr='status:no;dialogWidth:780px;dialogHeight:550px;help:no;resizable:1';
	
	if (_isMultiple == true)
	{
		var _target = document.getElementById(_name + "_disp");
		pars.selected_object_ids = "";
		for (var m=0; m < _target.options.length; m++)
		{
			pars.selected_object_ids += _target.options[m].value +";"
		}
		
	}
	else
	{
		pars.element_id = _value;
	}
	pars.can_be_empty = true;
	
	xShowModalDialog('dlg_select.html?doc_id=<%=curDocID%>&catalog_name='+ _catalog +'&typein=0&multi_select=' + (_isMultiple == true ? 1 : 0 )+ '&rand='+Math.random(), pars, strAttr);
	if ( ! pars.handle )
		return null;
	
	if (_isMultiple == true)
	{
		var _target = document.getElementById(_name + "_disp");
		for(m=_target.options.length-1;m>=0;m--)
		{
			_target.options.remove(m);
		}
		
		for(m=0;m<pars.elemArray.length;m++)
		{
			var aoption=document.createElement("OPTION");
			aoption.setAttribute("value",pars.elemArray[m]);
			aoption.text=pars.elemNamesArray[m];
			_target.add(aoption);
		}
		document.getElementById(_name).value = pars.selected_object_ids;
	}
	else
	{
		document.getElementById(_name).value = pars.element_id;
		document.getElementById(_name+'_disp').value = pars.element_name;
	}
}
</script>

<form action="poll_procedure_save.html" id="poll_procedure_<%=_curPollID%>_data" name="poll_procedure_<%=_curPollID%>_data" method="POST" enctype="multipart/form-data">	
<input type="hidden" name="doc_id" value="<%=curDocID%>"/>
<!-- input type="hidden" name="object_id" value="<%=curObjectID%>"/-->
<input type="hidden" name="poll_id" value="<%=_curPollID%>"/>
<input type="hidden" name="poll_result_id" value="<%=_curPollResultID%>"/>
<input type="hidden" name="mode" value="<%=curMode%>"/>
<input type="hidden" id="isflawed" name="isflawed" value=""/>

<table border="0" cellpadding="5" cellspacing="0">
<%
	_idx = 0;
	
	COLUMNS = _curPoll.columns_num;
	
	_col_width = Int( 100.0 / Real(COLUMNS));
	_last_question = ArrayCount(_curPoll.questions) - 1;
		
	for ( _question in _curPoll.questions )
	{	
		if (_idx == 0)
			Response.Write("<tr>");
		else if (_idx % COLUMNS == 0)
			Response.Write("</tr><tr>");

		if ( _question.type == "title" )
		{
			if (_idx > 0 && _idx % COLUMNS != 0)
			{
				Response.Write("<td colspan='" + (COLUMNS - 1)+"'>&nbsp;</td></tr><tr>");
				_last_question = _last_question + ((COLUMNS - _idx) % COLUMNS);
				_idx = _idx + ((COLUMNS - _idx) % COLUMNS);
			}
%>
	<td colspan="<%=COLUMNS%>">
	<TABLE width="100%" cellspacing="0" border="0" cellpadding="4">
	<TR> 
		<TD>
			<%
				_complexity_level = 0;
				if (_question.is_current && _question.catalog_entry_id.HasValue)
				{
					try{
						objDoc = OpenDoc(UrlFromDocID(_question.catalog_entry_id)).TopElem;
					}
					catch(_O_)
					{
						objDoc = undefined;
					}
					
					if (objDoc != undefined)
					{
						_complexity_level = 1;
						if (StrBegins(objDoc.Name, "cc_"))
						{
							doc_type = ArrayOptFirstElem(XQuery("for $elem in doc_types where $elem/object_name = " + XQueryLiteral(objDoc.Name) + " return $elem"));
							if (doc_type == undefined)
							{
								_complexity_level = 0 - 1;
			%>
				<center><b><%=tools.get_web_str("c_deleted")%></b></center>
			<%
							}
							else if (doc_type.custom_web_template_id.HasValue)
							{
								try{
									customWebTemplate = OpenDoc(UrlFromDocID(doc_type.custom_web_template_id)).TopElem;
									_complexity_level = 2;
								}
								catch(_O_)
								{
									customWebTemplate = undefined;
								}
							}
						}
					}
				}
				
				if (_complexity_level == 0)
				{
			%>
			<center><b><%=_question.title%></b></center>
			<%
				}
				if (_complexity_level == 1)
				{
					Response.Write( "<center><b>" + objDoc.EvalPath( common.exchange_object_types.GetChildByKey(objDoc.Name).disp_name ) +"</b></center>");
				}
				
				if (_complexity_level == 2)
				{
					_anti_str = "";
					for (_wvar in customWebTemplate.wvars)	_anti_str = _anti_str + _wvar.name + " = '" + HtmlEncode(_wvar.value) + "'; ";
					
					Response.Write(EvalCodePage( "<" + "%" + _anti_str + "%" + ">" + customWebTemplate.html.Value));
				}
			%>
		</TD>
	</TR>
	
	</TABLE></td>
<%
			Response.Write("</tr>");
			continue;
		}
		else
		{
			if (_question.required)
				_str_required = _str_required + ( _str_required =="" ? "" : "," ) + '"q' + _question.id + '"';
%>
	<td width="<%=_col_width%>%" valign="top">
	<TABLE width="100%" cellspacing="0" border="0" cellpadding="4" border="1">
<%
			if (_question.show_header)
			{
%>
	<TR> 
		<TD ALIGN="left" colspan="2"><%=_question.title%></TD>
	</TR>
<%	
			}
		}
		
		_question_value = _curPollResult.questions.GetOptChildByKey( _question.id );
		if (_question_value != undefined)
		{
			_question_comment = HtmlEncode(_question_value.comment);
			_question_value = HtmlEncode(_question_value.value);
		}
		else
		{
			_question_comment = "";
			_question_value = "";
		}
		
		switch ( _question.type )
		{
			case "combo":
%>
	<TR>
		<TD>
<%
		if (IS_MODIFY)
		{
%>
		<select name="q<%=_question.id%>" id="q<%=_question.id%>">
			<option value=""></option>
<%
				for ( _entry in _question.entries )
				{
%>
			<option value="<%=_entry.id%>" <%=(_question_value == _entry.id + "" ? "selected":"")%>><%=_entry.value%></option>
<%
				}
%>
			</select> 
<%
		}
		else
		{
			_checked_arr = ArrayOptFind(_question.entries, "id + '' == '" + _question_value + "'");
			if (_checked_arr != undefined)
				Response.Write(_checked_arr.value);
			Response.Write("&nbsp;");
		}
%>
		</TD>
	</TR>					
<%		
				break;
				
			case "text":
%>
	<TR> 
		<TD ALIGN="LEFT"><textarea name="q<%=_question.id%>" id="q<%=_question.id%>" rows="5" cols="30" <%=(IS_MODIFY ? "" : "readonly")%>><%=(_question_value != undefined ? _question_value :"")%></textarea></TD>
	</TR>
<%
				break;
				
				case "select":
%>
	<TR> 
		<TD ALIGN="LEFT">
<%
				_checked_arr = String(_question_value).split(";");
				for ( _entry in _question.entries )
				{
					if (IS_MODIFY)
					{
%>
			<input name="q<%=( _question.id + "_" + _entry.id )%>" type="checkbox" value="<%=_entry.id%>" <%=(ArrayOptFind(_checked_arr, "This == _entry.id + ''")!=undefined ? "checked" :"")%>/><%=_entry.value%><br/>
<%
					}
					else
					{
%>
						<%=(ArrayOptFind(_checked_arr, "This == _entry.id + ''")!=undefined ? "<li/>" :"&nbsp;&nbsp;")%>&nbsp;<%=_entry.value%><br/>
<%
					}
				}
%>	
		</TD>
	</TR>
<%
				break;
				
				case "choice":
%>
	<TR> 
		<TD ALIGN="LEFT">
<%
		if (_question.subtype == 1)
		{
			_uppercount = ArrayCount(_question.entries) ;
			if (_uppercount > 0)
			{
				_uppercount = Real(_uppercount - 1);
%>
			<table border="0" cellpadding="2" cellspacing="0">
			<tr>
				<td colspan="<%=(_uppercount + 1)%>">
					<table cellpadding="0" cellspacing="0" border="0" width="100%">
						<tr><td width="50%" align="left"><%=_question.entries[0].value%></td><td align="right"><%=_question.entries[_uppercount].value%></td></tr>
					</table>
				</td>
			</tr>
			<tr>
<%
				for ( _entry in _question.entries )
				{
					if (_uppercount > 0)
					{
						if (_entry.ChildIndex >= _uppercount / 2.0)
						{
							_red = 255.0;
							_green = 255.0 * (2.0 - 2.0 * Real(_entry.ChildIndex) / _uppercount);
						}
						else
						{
							_red = 255.0 * 2.0 * Real(_entry.ChildIndex) / ( _uppercount);
							_green = 255.0;
						}
						_tdcolor = Int(_red) + "," + Int(_green) + ",0";
					}
					else
						_tdcolor = "255,255,255";
%>
					<td style="width: 50px; border: 1px black solid; background-color: rgb(<%=_tdcolor%>)" align="center">
					<%
						if (IS_MODIFY)
						{
					%>
						<input name="q<%=_question.id%>" type="radio" value="<%=_entry.id%>" <%=(_question_value == _entry.id + "" ? "checked":"")%>/>
					<%
						}
						else
							Response.Write((_question_value == _entry.id + "" ? "<input type='radio' checked disabled/>":"&nbsp;"))
					%>
					</td>
<%
				}
%>
			</tr>
			</table>
<%			}
		}
		else
		{
				for ( _entry in _question.entries )
				{
					if (IS_MODIFY)
					{
%>
			<input name="q<%=_question.id%>" type="radio" value="<%=_entry.id%>" <%=(_question_value == _entry.id + "" ? "checked":"")%>/><%=_entry.value%><br/>
<%
					}
					else
					{
%>
						<%=(_question_value == _entry.id + "" ? "<li/>":"&nbsp;&nbsp;")%>&nbsp;<%=_entry.value%><br/>
<%
					}
				}
		}
%>	
		</TD>
	</TR>
<%
				break;
				case "link_to_database_object":
					if (_question_value != undefined)
					if (_question.is_multiple)
					{
						try
						{
							_question_value = String(_question_value).split(";");
							for (_m =0;_m < ArrayCount(_question_value); _m++)
								_question_value[_m] = Int(_question_value[_m]);
							_checked_arr = QueryCatalogByKeys(_question.catalog+"s","id", _question_value);
							_checked_arr_names = ArrayExtract(_checked_arr, common.exchange_object_types.GetChildByKey(_question.catalog).disp_name);
							_checked_arr = ArrayExtract(_checked_arr, "id");
						}
						catch(_pu_)
						{_question_value = undefined;}
					}
					else
					{
						try
						{
							_checked_arr = ArrayFirstElem(XQuery("for $elem in " + _question.catalog + "s where $elem/id = "+ Int(_question_value) + " return $elem"));
							_checked_arr = _checked_arr.EvalPath( common.exchange_object_types.GetChildByKey(_checked_arr.Name).disp_name );
						}
						catch(_pu_)
						{_question_value = undefined;}
					}
%>
	<TR> 
		<TD ALIGN="LEFT">
<%
		if (IS_MODIFY)
		{
%>
			<input type="hidden" name="q<%=_question.id%>" id="q<%=_question.id%>" value="<%=(_question_value != undefined ? _question_value :"")%>"/>
<%
			if (_question.is_multiple)
			{
%>
			<table cellpadding="0" cellspacing="1">
			<tr><td>
			<select multiple="1" name="q<%=_question.id%>_disp" id="q<%=_question.id%>_disp" readonly style="width:400px; height: 100px; border: 1px; background-color: whitesmoke" size="5">
<%
			if (_question_value != undefined)
			for (_m = 0; _m < ArrayCount(_checked_arr); _m++)
			{
				Response.Write('<option value="'+_checked_arr[_m]+'">' +HtmlEncode(_checked_arr_names[_m])+ '</option>');
			}
%>
			</select>
			</td><td valign="top"><input type="button" value="<%=tools.get_web_str("c_choose")%>" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';" onclick="set_foreign_elem_field('q<%=_question.id%>','<%=_question.catalog%>','',true)"/></td>
			</tr></table>
<%
			}
			else
			{
%>
			<input type="text" name="q<%=_question.id%>_disp" id="q<%=_question.id%>_disp" value="<%=(_question_value != undefined ? _checked_arr :"")%>" size="60" class="inputEdit" readonly/>&nbsp;<input type="button" value="<%=tools.get_web_str("c_choose")%>" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';" onclick="set_foreign_elem_field('q<%=_question.id%>','<%=_question.catalog%>','',false)"/>
<%
			}
		}
		else
		{
%>
			<input type="text" value="<%=(_question_value != undefined ? _checked_arr :"")%>" size="60" class="inputEdit" readonly/>
<%
		}
%>
		</TD>
	</TR>
<%
				break;				
				case "number":
%>
	<TR> 
		<TD ALIGN="LEFT"><INPUT type="text" NAME="q<%=_question.id%>" id="q<%=_question.id%>" VALUE="<%=(_question_value != undefined ? _question_value :"")%>" SIZE="30" CLASS="inputEdit" <%=(IS_MODIFY ? "" : "readonly")%>/></TD>
	</TR>
<%
				break;
			case "date":
%>
	<TR> 
		<TD ALIGN="LEFT">
		<%
			if (IS_MODIFY)
			{
		%>
			<input type="text" name="q<%=_question.id%>" id="q<%=_question.id%>" value="<%=(_question_value != undefined ? _question_value :"")%>" style="width: 80px" class="inputEdit" readonly="true"/><a href="javascript: init_calendat_control('<%=_field.name%>')"><img src="/scripts/calendar/calendar.gif" width="24" height="22" border="0"/></a>
		<%
			}
			else
			{
		%>
			<input type="text" value="<%=(_question_value != undefined ? _question_value :"")%>" style="width: 80px" class="inputEdit" readonly="true">
		<%
			}
		%>
		</TD>
	</TR>
<%			
			default:		
%>						
	<TR>
		 <TD ALIGN="LEFT"><INPUT type="text" NAME="q<%=_question.id%>" VALUE="<%=(_question_value != undefined ? _question_value :"")%>" SIZE="60" CLASS="inputEdit" <%=(IS_MODIFY ? "" : "readonly")%>/></TD>
	</TR>
<%
		}
		
		if (_question.add_comment)
		{
%>
	<TR> 
		<TD ALIGN="left" colspan="2"><br/><%=tools.get_web_str("vpollb_comment")%></TD>
	</TR>
	<TR>
		<TD ALIGN="left" colspan="2"><textarea name="q<%=_question.id%>_comment" id="q<%=_question.id%>_comment" rows="5" cols="30" <%=(IS_MODIFY ? "" : "readonly")%>><%=_question_comment%></textarea></TD>
	</TR>
<%	
		}
		
%>
	</TABLE>
	</td>
<%
		if (_idx >= _last_question)
			Response.Write((_idx % COLUMNS == 0 ?"<td colspan='" + (COLUMNS - 1)+"'>&nbsp;</td>" :"") +"</tr>");
	
		_idx++;
	}
%>	
	</table>
	
<%
	if (IS_MODIFY)
	{
%>
		<table width="100%" border="0" cellspacing="0" cellpadding="0" class="activator">
			<td align="CENTER" class="activator">
				<input type="submit" value="<%=tools.get_web_str("c_save")%>" onclick="return doSubmit_ct();" class="inputButton" onmouseover="this.className='inputButtonOver';" onmouseout="this.className='inputButton';"/>
			</td>
		</table>
<%
	}
%>
	</form>
<script language="javascript">
<!--
function check_required()
{
	var reqArray = new Array(<%=_str_required%>);
	var o;
	
	for ( var i=0; i<reqArray.length; i++ )
	{
		o = document.all[reqArray[i]];
		if (o)
		if (o.name == undefined && o.length != undefined)
		{
			var flag_bu = false;
			for (var j = 0; j < o.length; j++)
			{
				if (o[j].checked)
				{
					flag_bu = true;
					break;
				}
			}
			if ( flag_bu ==false )
			{
				//window.alert("<%=tools.get_web_str("uc_error2")%>");
				return false;
			}
		}
		else
			if ( o.value == '' )
			{
				//window.alert("<%=tools.get_web_str("uc_error2")%>");
				return false;
			}
	}	
	return true;
}

function doSubmit_ct() 
{
	$("form#poll_procedure_<%=_curPollID%>_data > input#isflawed").val("");
	if ( ! check_required() )
	{
		if (!window.confirm(<%=CodeLiteral( tools_web.get_web_str('vppb_form_mess') )%>))
			return false;
		else
			$("form#poll_procedure_<%=_curPollID%>_data > input#isflawed").val("1");
	}
	var o,ANSWER="",ANSWERS=0;
<%
	for ( _question in _curPoll.questions )
	if (_question.value_condition.HasValue)
	{
%>
	ANSWERS=0;
	ANSWER = "";
<%
		switch (_question.type)
		{
			case "select":
			for ( _entry in _question.entries )
			{
%>
	o = document.all["q<%=_question.id%>_" + "<%=_entry.id%>"];
	if (o != undefined) if (o.checked) {ANSWERS++;ANSWER+=(ANSWER != "" ? ";":"")+o.value}
<%
			}
			break;
			default:
%>
	o = document.all["q<%=_question.id%>"];
	if (o != undefined)
	{
<%
		if (_question.type == "choice")
		{
%>
		if (o.name == undefined && o.length != undefined)
		{
			for (var j = 0; j < o.length; j++) if (o[j].checked) {ANSWERS++;ANSWER+=(ANSWER != "" ? ";":"")+o[j].value}
		}
		else
<%
		}
%>
		{
		ANSWER = o.value;
		if (ANSWER != "") ANSWERS++;
		}
	}
<%
		}
%>
	
	try
	{
		var _ok = eval("<%=StrReplace(_question.value_condition, "\"", "\\\"")%>");
		if (_ok) _ok = true; else _ok = false;
	}
	catch(_x_)
	{
		_ok = true;
	}
	if (!_ok)
	{
		if (!window.confirm("<%=tools.get_web_str("vppb_all_invalid_value")+" - "+tools.get_web_str("c_question")+" "+(_question.ChildIndex + 1)%>\n<%=tools_web.get_web_str('vppb_next_mess')%>"))
			return false;
		else
		{
			$("form#poll_procedure_<%=_curPollID%>_data > input#isflawed").val("1");
		}
	}
	
<%
	}
%>
	
	return true;
}
-->
</script>
<%
	}
	}
%>
			</td>
		</tr>
		</table>
		</td></tr></table>
<%
		}
		else
			Response.Write("<center><font color='red' size='+1'><b>Procedure display prohibited</b></font></center>");
	}
%>