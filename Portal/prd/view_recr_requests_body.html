<%
	_filter = Request.Query.HasProperty( 'filter_id' ) ? Request.Query.filter_id : 'active';
	_mode = Request.Query.HasProperty( 'm' ) ? Request.Query.m : '0';
	_sort_type = Request.Query.HasProperty( 'sort_type' ) ? Request.Query.sort_type : 'date';
%>

<CENTER>
<%
	switch ( _mode )
	{
		case '1':
%>		
	<br><br>
	<FONT COLOR="#009900"><b><%=tools.get_web_str('verb_message1')%></b></FONT>
<%
			break;	
		case '2':
%>		
	<br><br>
	<FONT COLOR="#FF3333"><b><%=tools.get_web_str('vhrb_message2')%></b></FONT>
<%
			break;
		case '3':
%>
	<br><br>
	<FONT COLOR="#FF3333"><b><%=tools.get_web_str('verb_message2')%></b></FONT>
<%
			break;
	}
%>
</CENTER>



   <TABLE width="100%" cellspacing="5" cellpadding="0">
   <FORM ACTION="view_doc.html?mode=recr_requests&doc_id=<%=curDocID%>" NAME="set_person_form" METHOD="POST">
	  <TR>
		<TD>
		
		<div class="headerText" style="margin-top:10px;margin-bottom:5px;margin-left:5px;"><%=tools.get_web_str('vhrb_title2')%></div>
	
		<TABLE width="100%" cellspacing="0" cellpadding="0" CLASS="tableBorder">	
		<TR>		
		<TD WIDTH="170" ALIGN="RIGHT"><b><%=tools.get_web_str('c_status')%>:</b></TD>
		<TD ALIGN="LEFT">
		<select name="filter_id" onChange="document.set_person_form.submit();">
			<option value="all"><%=tools.get_web_str('c_all')%>
<%
	for ( _status in curLngCommon.request_status_types )
	{
%>
        	<option selected value="<%=_status.id%>"><%=_status.name%>
<%
	}
%>
         </select>
<SCRIPT language="JavaScript">
selcur=document.forms['set_person_form'].filter_id;
selcur.selectedIndex = -1;
for (i=0;i<selcur.options.length;i++)
    if (selcur.options[i].value=="<%=_filter%>") {
        selcur.selectedIndex=i;
		break;
    }
</SCRIPT>
		 		</TD>
		 	</TR>
			<TR>
				<TD WIDTH="170" ALIGN="RIGHT"><b><%=tools.get_web_str('c_sort')%>:</b></TD>
				<TD ALIGN="LEFT">
					<SELECT NAME="sort_type" onChange="document.set_person_form.submit();">						
						<option value="code"><%=tools.get_web_str('c_code')%></option>
						<option value="type"><%=tools.get_web_str('c_type')%></option>
						<option value="object_type"><%=tools.get_web_str('c_object')%></option>
						<option value="object_name"><%=tools.get_web_str('c_name')%></option>
						<option value="state"><%=tools.get_web_str('c_state')%></option>
						<option value="date"><%=tools.get_web_str('c_create_date')%></option>
					</SELECT>
<SCRIPT language="JavaScript">
selcur=document.forms['set_person_form'].sort_type;
selcur.selectedIndex = -1;
for (i=0;i<selcur.options.length;i++)
    if (selcur.options[i].value=="<%=_sort_type%>") {
        selcur.selectedIndex=i;
		break;
    }
</SCRIPT>
				</TD>
			</TR>
			</TABLE>

		</TD>
	</TR>
	<TR>
		 <TD> 
<%
	_order_str = '';
	
	switch ( _sort_type )
	{
		case 'date':
			_order_str = ' order by $elem/create_date descending';
			break;
		case 'code':
			_order_str = ' order by $elem/code descending';
			break;
		case 'object_name':
			_order_str = ' order by $elem/object_name';
			break;
		case 'type':
			_order_str = ' order by $elem/request_type_id';
			break;
		case 'object_type':
			_order_str = ' order by $elem/type';
			break;
		case 'state':
			_order_str = ' order by $elem/status_id';
			break;
	}
	
	if ( global_settings.settings.recruitment.default_request_type_id.HasValue )
	{					
		switch ( _filter )
		{
			case 'all':
				_requests = XQuery( "for $elem in requests where $elem/person_id = " + curUserID + " and $elem/request_type_id = " + global_settings.settings.recruitment.default_request_type_id + _order_str + " return $elem" );
				break;
				
			default:
				_requests = XQuery( "for $elem in requests where $elem/person_id = " + curUserID + " and $elem/request_type_id = " + global_settings.settings.recruitment.default_request_type_id + " and $elem/status_id = '" + _filter + "'" + _order_str + " return $elem" );
		}
	}
	else
	{
		_requests = Array();
	}
%>
					
		<table width="100%"  border="0" cellspacing="0" cellpadding="3">
			<tr>
				<td class="tableHeaderWithText" width="60px"><%=tools.get_web_str('c_code')%></td>
				<td class="tableHeaderWithText" width="130px"><%=tools.get_web_str('c_create_date')%></td>
				<td class="tableHeaderWithText"><%=tools.get_web_str('c_name')%></td>						
				<td class="tableHeaderWithText" width="130px"><%=tools.get_web_str('c_state')%></td>
			</tr>
			<tr>
				<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="1" height="1" /></td>
				<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="1" height="1" /></td>
				<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="1" height="1" /></td>
				<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="1" height="1" /></td>
			</tr>				

<%
			counter = 0;
			for ( _request in _requests )
			{
				_class = counter++ % 2 ? 'tableRowEven' : 'tableRowOdd';
%>
		<TR>
			<TD class="<%=_class%>" align=center>
				<a href="view_doc.html?mode=request&doc_id=<%=curDocID%>&object_id=<%=_request.id%>" title="<%=tools.get_web_str('c_tip_request')%>"><%=_request.code%></a>
			</TD>
			<TD class="<%=_class%>" ALIGN="CENTER">
				<a href="view_doc.html?mode=request&doc_id=<%=curDocID%>&object_id=<%=_request.id%>" title="<%=tools.get_web_str('c_tip_request')%>"><%=StrDate( _request.create_date, true, false )%></a>
			</TD>
			<TD class="<%=_class%>">
<%
				if ( _request.type.HasValue )
				{
					Response.Write( _request.object_name );
				}
				else
				{
					try
					{
						requestDoc = OpenDoc( UrlFromDocID( _request.PrimaryKey.Value ) ).TopElem;
						Response.Write( requestDoc.custom_elems.ObtainChildByKey('position_name').value );
					}
					catch ( t )
					{
%>
				<font color="#FF0033"><%=tools.get_web_str('c_deleted')%></font>
<%
					}
				}
%>	
			</TD>										
			<TD class="<%=_class%>" align=center>
				<%=curLngCommon.request_status_types.GetChildByKey( _request.status_id ).name%>
			</TD>
		</TR>
<%
			}
%>	
			<tr>
				<td class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td>
				<td class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td>
				<td class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td>
				<td class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td>
			</tr>
		</table>					
					
		</TD>
	</TR>
	<TR>
		<TD ALIGN="CENTER">
		<table width="100%" border="0" cellspacing="0" cellpadding="0" class="activator">
			<TD ALIGN="CENTER" class="activator">
				<INPUT TYPE="SUBMIT" VALUE="<%=tools.get_web_str('c_refresh')%>" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';">
<%				
				if ( global_settings.settings.recruitment.default_request_type_id.HasValue )
				{
%>				
				<INPUT TYPE="button" VALUE="<%=tools.get_web_str('c_text_create_request')%>" onclick="document.location.href='view_doc.html?mode=request_create&doc_id=<%=curDocID%>&request_type_id=<%=global_settings.settings.recruitment.default_request_type_id%>&redirect_mode=recr_requests';" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';">
<%
				}
%>
			</TD>
		</table>

		</TD>
	</TR>
	</FORM>
	
<%
	if ( global_settings.settings.recruitment.estaff_server_url.HasValue )
	{
	    _url = ( StrBegins( global_settings.settings.recruitment.estaff_server_url, 'http://' ) || StrBegins( global_settings.settings.recruitment.estaff_server_url, 'https://' ) ? '' : tools_web.get_url_protocol( Request.Url ) ) + global_settings.settings.recruitment.estaff_server_url;
		resp = HttpRequest( UrlAppendPath( _url, '/active_positions.xml' ) , 'post' );
		respDoc = OpenDocFromStr( resp.Body, "form=x-local://wtv/estaff/active_positions.xmd" ).TopElem;
%>	
	<TR>
		<TD>
	
		<div class="headerText" style="margin-top:10px;margin-bottom:5px;margin-left:5px;"><%=tools.get_web_str('c_vacancys')%></div>
		
		<table width="100%"  border="0" cellspacing="0" cellpadding="3">
			<tr>
				<td class="tableHeaderWithText"><%=tools.get_web_str('c_name')%></td>
				<td class="tableHeaderWithText"><%=tools.get_web_str('c_customer')%></td>
				<td class="tableHeaderWithText"><%=tools.get_web_str('c_subd')%></td>
				<td class="tableHeaderWithText" width="130px"><%=tools.get_web_str('c_state')%></td>
			</tr>
			<tr>
				<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="1" height="1" /></td>
				<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="1" height="1" /></td>
				<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="1" height="1" /></td>
				<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="1" height="1" /></td>
			</tr>				

<%
//alert(respDoc.Xml)
			counter = 0;
			for ( _vac in ArraySelect( respDoc, "person_data.portal_eid == '0x" + StrHexInt( curUserID, 14 ) + "'" ) )
			{
				_class = counter++ % 2 ? 'tableRowEven' : 'tableRowOdd';
%>
		<TR>
			<TD class="<%=_class%>"><a href="view_doc.html?mode=vacancy&doc_id=<%=curDocID%>&eid=<%=_vac.eid%>" title="<%=tools.get_web_str('c_tip_vacancy')%>"><%=( _vac.name.HasValue ? _vac.name : tools.get_web_str('c_not_name') )%></a></TD>
			<TD class="<%=_class%>"><%=_vac.person_data.fullname%></TD>
			<TD class="<%=_class%>"><%=_vac.subdivision_data.disp_name.HasValue?_vac.subdivision_data.disp_name:_vac.subdivision_data.name%></TD>										
			<TD class="<%=_class%>" align="center"><%=_vac.state_name%></TD>
		</TR>
<%
			}
%>	
			<tr>
				<td class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td>
				<td class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td>
				<td class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td>
				<td class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td>
			</tr>
		</table>

		</TD>
	</TR>
<%
	}
%>	

	</TABLE>