<%
	_filter = Request.Query.HasProperty( 'filter_id' ) ? Request.Query.filter_id : 'active';
	_mode = Request.Query.HasProperty( 'm' ) ? Request.Query.m : '0';
	_sort_type = Request.Query.HasProperty( 'sort_type' ) ? Request.Query.sort_type : 'date';
	
	try
	{
		if ( dispWorkflowProcessing != true )
			dispWorkflowProcessing = false;
	}
	catch ( ff )
	{
		dispWorkflowProcessing = false;
	}
	
	try
	{
		curPostMode; 
	}
	catch ( ff )
	{
		curPostMode = dispWorkflowProcessing ? "requests_work" : "requests";
	}
%>

<CENTER>
<%
	_doc = null;
	
	switch ( _mode )
	{
		case '1':
%>		
	<br><br>
	<FONT COLOR="#009900"><b><%=tools.get_web_str('verb_message1')%></b></FONT>
<%
			break;	
		case '2':
%>		
	<br><br>
	<FONT COLOR="#FF3333"><b><%=tools.get_web_str('vhrb_message2')%></b></FONT>
<%
			break;
		case '3':
%>
	<br><br>
	<FONT COLOR="#FF3333"><b><%=tools.get_web_str('verb_message2')%></b></FONT>
<%
			break;
	}
%>
</CENTER>


<FORM ACTION="view_doc.html?mode=<%=curPostMode%>&doc_id=<%=curDocID%>" NAME="set_person_form" METHOD="POST">
<div class="headerText" style="margin-top:10px;margin-bottom:5px;margin-left:5px;"><%=tools.get_web_str('vhrb_title2')%></div>

<TABLE width="100%" cellspacing="5" cellpadding="0">
<TR>
	<TD>
			
	<TABLE width="100%" cellspacing="0" cellpadding="0" CLASS="tableBorder">	
	<TR>		
		<TD WIDTH="170" ALIGN="RIGHT"><b><%=tools.get_web_str('c_status')%>:</b></TD>
		<TD ALIGN="LEFT">
		<select name="filter_id" onChange="document.set_person_form.submit();">
			<option value="all"><%=tools.get_web_str('c_all')%>
<%
	for ( _status in curLngCommon.request_status_types )
	{
%>
        	<option selected value="<%=_status.id%>"><%=_status.name%>
<%
	}
%>
         </select>
<SCRIPT language="JavaScript">
<!--
selcur=document.forms['set_person_form'].filter_id;
for (i=0;i<selcur.options.length;i++) {
    if (selcur.options[i].value=="<%=_filter%>") {
        selcur.selectedIndex=i;
    }
	
if (selcur.selectedIndex==-1) {selcur.selectedIndex=0;}
}
//-->
</SCRIPT>
		</TD>
	</TR>
	<TR>
		<TD WIDTH="170" ALIGN="RIGHT"><b><%=tools.get_web_str('c_sort')%>:</b></TD>
		<TD ALIGN="LEFT">
			<SELECT NAME="sort_type" onChange="document.set_person_form.submit();">						
				<option value="code"><%=tools.get_web_str('c_code')%></option>
				<option value="type"><%=tools.get_web_str('c_type')%></option>
				<option value="object_type"><%=tools.get_web_str('c_object')%></option>
				<option value="object_name"><%=tools.get_web_str('c_name')%></option>
				<option value="state"><%=tools.get_web_str('c_state')%></option>
				<option value="date"><%=tools.get_web_str('c_create_date')%></option>
			</SELECT>
<SCRIPT language="JavaScript">
selcur=document.forms['set_person_form'].sort_type;
for (i=0;i<selcur.options.length;i++) {
    if (selcur.options[i].value=="<%=_sort_type%>") {
        selcur.selectedIndex=i;
    }
	
if (selcur.selectedIndex==-1) {selcur.selectedIndex=0;}
}
</SCRIPT>
		</TD>
	</TR>
	</TABLE>

	</TD>
</TR>
<TR>
	 <TD> 
<%
	_order_str = '';
	
	switch ( _sort_type )
	{
		case 'date':
			_order_str = ' order by $elem/create_date descending';
			break;
		case 'code':
			_order_str = ' order by $elem/code descending';
			break;
		case 'object_name':
			_order_str = ' order by $elem/object_name';
			break;
		case 'type':
			_order_str = ' order by $elem/request_type_id';
			break;
		case 'object_type':
			_order_str = ' order by $elem/type';
			break;
		case 'state':
			_order_str = ' order by $elem/status_id';
			break;
	}
	
	_person_str = "";
	if ( ! dispWorkflowProcessing )
		_person_str = " where $elem/person_id = " + curUserID;
	
	switch ( _filter )
	{
		case 'all':
			_requests = XQuery( "for $elem in requests" + _person_str + _order_str + " return $elem" );
			break
			
		default:
			_requests = XQuery( "for $elem in requests" + _person_str + ( _person_str == "" ? " where" : " and" ) + " $elem/status_id = '" + _filter + "'" + _order_str + " return $elem" );
	}


	if ( dispWorkflowProcessing )
	{
		_req_counter = 0;
		_request_list = Array();
		for ( _request in _requests )
			try
			{
				curObject = OpenDoc( UrlFromDocID( _request.id ) ).TopElem;
//alert(curObject.object_id.ForeignElem.name)	
//alert(curObject.person_id.ForeignElem.fullname)	
//alert(curObject.workflow_state);
				if ( ! curObject.workflow_id.HasValue )
					continue;
				
				_eval_custom_str = '';
				for ( _custom_state in curObject.workflow_custom_states )
					_eval_custom_str = _eval_custom_str + ( _custom_state.ChildIndex == 0 ? '' : '||' ) + "(curObject.workflow_state=='" + _custom_state.code + "'" + ( _custom_state.condition_eval_str.HasValue ? "&&(" + _custom_state.condition_eval_str + ")" : "" ) + ")";
				
//alert(curObject.workflow_id.ForeignElem.name);
//alert('eval_custom_str = '+_eval_custom_str)
//alert('curUserID = '+curUserID)
				if ( _eval_custom_str != '' && eval( _eval_custom_str ) ) 
				{
					_request_list[ _req_counter ] = _request;
					_req_counter++;
				}
				else
				{
					_eval_str = curObject.workflow_id.ForeignElem.condition_eval_str;
//alert('eval_str = '+_eval_str)
					if ( _eval_str == '' || eval( _eval_str ) )
					{
						_request_list[ _req_counter ] = _request;
						_req_counter++;
					}
				}
			}
			catch ( dfg )
			{
//alert(dfg)			
			}
			
		_requests = _request_list;
	}
%>						
					
	<table width="100%"  border="0" cellspacing="0" cellpadding="3">
		<tr>
			<td class="tableHeaderWithText" width="60px"><%=tools.get_web_str('c_code')%></td>
			<td class="tableHeaderWithText" width="130px"><%=tools.get_web_str('c_create_date')%></td>
			<td class="tableHeaderWithText"><%=tools.get_web_str('c_coll')%></td>
			<td class="tableHeaderWithText"><%=tools.get_web_str('c_type')%></td>
			<td class="tableHeaderWithText" width="160px"><%=tools.get_web_str('c_object')%></td>
			<td class="tableHeaderWithText"><%=tools.get_web_str('c_name')%></td>						
			<td class="tableHeaderWithText" width="130px"><%=tools.get_web_str('c_state')%></td>
			<td class="tableHeaderWithText" width="130px"><%=tools.get_web_str('c_cur_workflow_state')%></td>
		</tr>
		<tr>
			<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="1" height="1" /></td>
			<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="1" height="1" /></td>
			<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="1" height="1" /></td>
			<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="1" height="1" /></td>
			<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="1" height="1" /></td>
			<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="1" height="1" /></td>
			<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="1" height="1" /></td>
			<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="1" height="1" /></td>
		</tr>				

<%
	counter = 0;
	for ( _request in _requests )
	{
		_class = counter++ % 2 ? 'tableRowEven' : 'tableRowOdd';
		_object_type = ( _request.type.HasValue ? curLngCommon.exchange_object_types.GetOptChildByKey( _request.type ) : undefined );
%>
		<TR>
			<TD class="<%=_class%>" align="center"><a href="view_doc.html?mode=request&doc_id=<%=curDocID%>&object_id=<%=_request.id%>" title="<%=tools.get_web_str('c_tip_request')%>"><%=_request.code%></a></TD>
			<TD class="<%=_class%>" ALIGN="CENTER"><a href="view_doc.html?mode=request&doc_id=<%=curDocID%>&object_id=<%=_request.id%>" title="<%=tools.get_web_str('c_tip_request')%>"><%=StrDate( _request.create_date, true, false )%></a></TD>
			<TD class="<%=_class%>"><a href="view_doc.html?mode=collaborator&doc_id=<%=curDocID%>&object_id=<%=_request.person_id%>"><%=_request.person_fullname%></a></TD>
			<TD class="<%=_class%>">
<%
		if ( _request.request_type_id.HasValue )
		{
			try
			{
				_cur_type = _request.request_type_id.ForeignElem;

				Response.Write( tools_web.get_cur_lng_name( _cur_type.name ) );
			}
			catch ( t )
			{
%>
				<font color="#FF0033"><%=tools.get_web_str('c_deleted')%></font>
<%
			}
		}
%>					
			</TD>
			<TD class="<%=_class%>"><%=( _object_type != undefined ? _object_type.title : '&nbsp;' )%></TD>					
			<TD class="<%=_class%>">
<%
		if ( _object_type != undefined )
		{
			if ( _object_type.web_template.HasValue )
			{
%>
				<a href="<%=_object_type.web_template%>&doc_id=<%=curDocID%>&object_id=<%=_request.object_id%>"><%=tools_web.get_cur_lng_name( _request.object_name )%></a>
<%
			}
			else
			{
				Response.Write( tools_web.get_cur_lng_name( _request.object_name ) );
			}
		}
		else
		{
			Response.Write( '\&nbsp;' );
		}
%>
			</TD>
			<TD class="<%=_class%>" align=center><%=curLngCommon.request_status_types.GetChildByKey( _request.status_id ).name%></TD>
			<TD class="<%=_class%>" align=center><%=_request.workflow_state_name%></TD>
		</TR>
<%
	}
%>	
		<tr>
			<td class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td>
			<td class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td>
			<td class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td>
			<td class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td>
			<td class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td>
			<td class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td>
			<td class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td>
			<td class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td>
		</tr>
	</table>					
						
	</TD>
</TR>
<TR>
	<TD ALIGN="CENTER">
	
	<table width="100%" border="0" cellspacing="0" cellpadding="0" class="activator">
	<tr>
		<TD ALIGN="CENTER" class="activator">
			<INPUT TYPE="SUBMIT" VALUE="<%=tools.get_web_str('c_refresh')%>" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';">
		</TD>
	</tr>
	</table>

	</TD>
</TR>
</TABLE>
</FORM>