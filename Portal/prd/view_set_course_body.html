<%
	 _position_array = '';

	_mode = Request.QueryString.HasProperty( 'm' ) ? Request.QueryString.m : '0';
	_course_id = Request.QueryString.HasProperty( 'course_id' ) ? Request.QueryString.course_id : '';
	_day_num = Request.QueryString.HasProperty( 'd_num' ) ? Request.QueryString.d_num : '';
	_attempts_num = Request.QueryString.HasProperty( 'att_num' ) ? Request.QueryString.att_num : '1';


	curPositionID = null;
	if ( curUser.position_id.HasValue )
	{
		curPositionID = curUser.position_id;
	}
	else
	{
		_position_array = XQuery( "for $obj in positions where $obj/basic_collaborator_id = " + curUserID + " return $obj" );
		curPositionID = ArrayOptFirstElem( _position_array );
		curPositionID = ( curPositionID == undefined ? null : curPositionID.id );
	}

	if ( curPositionID == null )
	{
		curPosition = null;
		_is_boss = false;
	}
	else
	{
		curPosition = OpenDoc( UrlFromDocID( curPositionID ) ).TopElem;
		_is_boss = curPosition.is_boss;
	}


	_collaborators = Array();
	_coll_counter = 0;

	_positions = Array();
	_pos_counter = 0;

	function sub_nodes( _p_id )
	{
		var _subs =  XQuery( "for $obj in subs where $obj/parent_id = " + _p_id + " return $obj" );
		var _sub;

		for ( _sub in _subs )
		{
			if ( _sub.type == 'position' && _sub.basic_collaborator_id != null )
				try
				{
					_collaborators[ _coll_counter ] = _sub.basic_collaborator_id.ForeignElem;
					_coll_counter++;
				}
				catch ( ff )
				{
				}

			sub_nodes( _sub.id );
		}
	}

%>
<script>
function doSubmit()
{
	if ( document.getElementById( 'type_doc_id' ).value != "" && parseInt( document.getElementById( 'type_doc_id' ).value, 10 ).toString() != document.getElementById( 'type_doc_id' ).value || parseInt( document.getElementById( 'type_doc_id' ).value, 10 ) <= 0 )
	{
		alert(<%=CodeLiteral( tools.get_web_str('vscb_error1') )%>);
		return false;
	}

	if ( document.getElementById( 'type_attempts_num' ).value != "" && parseInt( document.getElementById( 'type_attempts_num' ).value, 10 ).toString() != document.getElementById( 'type_attempts_num' ).value || parseInt( document.getElementById( 'type_attempts_num' ).value, 10 ) <= 0 )
	{
		alert(<%=CodeLiteral( tools.get_web_str('vscb_error2') )%>);
		return false;
	}

	if( document.getElementById( 'course_ids' ).value == "" )
	{
		alert(<%=CodeLiteral( tools.get_web_str('vscb_error3') )%>);
		return false;
	}

	if ( <%=_mode%> )
	{
		if ( $("input:checkbox[name^=pos_]:checked").length == 0 )
		{
			alert(<%=CodeLiteral( tools.get_web_str('vscb_error4') )%>);
			return false;
		}
	}
	else if ( document.getElementById( 'collaborator_ids' ).value == "" )
	{
		alert(<%=CodeLiteral( tools.get_web_str('vscb_error4') )%>);
		return false;
	}

	document.set_course_form.submit();
}
</script>

<br>
<br>

<form action="course_activate_admin.html" name="set_course_form" method="POST">
<input type="hidden" name="doc_id" value="<%=curDocID%>">
<input type="hidden" name="mode" value="<%=_mode%>">
<input type="hidden" name="sid" value="<%=tools.get_sum_sid( curDocID )%>">
<table width="100%" cellspacing="4" cellpadding="0">
<tr>
	<td>

	<table width="100%" cellspacing="0" cellpadding="4" class="tableBorder">
	<tr>
		<td width="140" align="RIGHT"><b><%=tools.get_web_str('c_course')%>:</b>&nbsp;</td>
		<td>
		<select name="course_id" id="course_ids">
        	<option SELECTED value=""></option>
<%
	_courses = XQuery( "for $course in courses order by $course/name return $course" );

	for ( _course in _courses )
	{
		if ( global_settings.settings.check_access_on_lists && tools_web.check_access( OpenDoc( UrlFromDocID ( _course.PrimaryKey ), 'form=x-local://wtv/wtv_form_doc_access.xmd;ignore-top-elem-name=1' ).TopElem, curUserID, curUser, Session ) == false )
			continue;
%>
        	<option value="<%=_course.id%>"><%=_course.code%> <%=tools_web.get_cur_lng_name( _course.name )%></option>
<%
	}
%>
         </select>
<script language="JavaScript">
selcur=document.getElementById('course_ids');
selcur.selectedIndex==-1;
for (i=0;i<selcur.options.length;i++)
    if (selcur.options[i].value=="<%=_course_id%>")
	{
        selcur.selectedIndex=i;
		break;
    }
</script>
		 </td>
	</tr>
	<tr>
		<td width="140" align="RIGHT"><b><%=tools.get_web_str('vscb_day_num')%>:</b>&nbsp;</td>
		<td><input type="text" name="day_num" size="10" value="<%=_day_num%>" id="type_doc_id" class="inputEdit"></td>
	</tr>
	<tr>
		<td width="140" align="RIGHT"><b><%=tools.get_web_str('c_start_learning_date')%>:</b>&nbsp;</td>
		<td>
			<INPUT TYPE="TEXT" name="start_learning_date" id="start_learning_date_id" VALUE="<%=StrDate( Date(), false )%>" CLASS="inputEdit" style="width:100">
			<INPUT TYPE="TEXT" name="start_learning_time" id="start_learning_time_id" VALUE="<%=StrTime( Date() )%>" CLASS="inputEdit" style="width:40">
		</td>
	</tr>
	<tr>
		<td width="140" align="RIGHT"><b><%=tools.get_web_str('vscb_att_num')%>:</b>&nbsp;</td>
		<td><input type="text" name="attempts_num" size="10" value="<%=_attempts_num%>" id="type_attempts_num" class="inputEdit"></td>
	</tr>
	</table>

	</td>
</tr>
<tr>
	<td>

	<table width="100%" cellspacing="0" cellpadding="4" class="tableBorder">
<%
	if ( _mode == '0' )
	{
%>
	<tr>
		<td width="140" align="RIGHT"><b><%=tools.get_web_str('c_coll')%>:</b>&nbsp;</td>
		<td><select name="collaborator_id" id="collaborator_ids">
			<option SELECTED value=""></option>
<%
		if ( _is_boss )
		{
			if ( curPosition.org_id != null && curPosition.parent_object_id == null )
			{
				_collaborators = XQuery( "for $obj in collaborators where $obj/org_id = " + curPosition.org_id + " order by $obj/fullname return $obj" );
			}
			else
			{
				if ( curPosition.parent_object_id != null )
				{
					sub_nodes( curPosition.parent_object_id );
					ArraySort( _collaborators, 'fullname', '+' );
				}
			}
		}
		else
		{
			_collaborators = XQuery( "for $collaborator in collaborators order by $collaborator/fullname return $collaborator" );
		}

		for ( _collaborator in _collaborators )
		{
%>
			<option value="<%=_collaborator.id%>"><%=_collaborator.fullname%>
<%
		}
%>
		 </select>&nbsp;
		 <a onclick="document.location.href = 'view_doc.html?mode=set_course&doc_id=<%=curDocID%>&m=1&course_id=' + document.set_course_form.course_id.value + '&d_num=' + document.set_course_form.day_num.value + '&att_num=' + document.set_course_form.attempts_num.value" href="#"><%=tools.get_web_str('c_detail')%></a>
		</td>
	</tr>
<%
	}
	else
	{
%>
	<tr>
		<td width="140" align="RIGHT"><b><%=tools.get_web_str('c_subd')%>:</b></td>
		<td align="LEFT">
		<select name="subdivision_id" id="subdivision_ids" onchange="if ( document.set_course_form.subdivision_id.value != '' ) document.location.href = 'view_doc.html?mode=set_course&doc_id=<%=curDocID%>&m=1&course_id=' + document.set_course_form.course_id.value + '&d_num=' + document.set_course_form.day_num.value + '&att_num=' + document.set_course_form.attempts_num.value + '&sub_id=' + document.set_course_form.subdivision_id.value + '&st=' + document.set_course_form.sort_type.value">
        	<option SELECTED value=""></option>
			<option value="all"><%=tools.get_web_str('c_all')%></option>
<%

	function node_subdivision( _p_id, _indent )
	{
		var _cur_sub_array = XQuery( "for $obj in subs where $obj/parent_id = " + ( _p_id == null ? 'null()' : _p_id ) + " order by $obj/type, $obj/name return $obj" );
		var _cur_sub;

		for ( _cur_sub in _cur_sub_array )
		{
			if ( _cur_sub.type != 'position' )
			{
%>
			<option value="<%=_cur_sub.id%>"><%=( _indent + tools_web.get_cur_lng_name( _cur_sub.name ) )%></option>
<%
			}

			if ( _cur_sub.type == 'position' && _cur_sub.basic_collaborator_id != null )
			{
				_positions[ _pos_counter ] = _cur_sub;
				_pos_counter++;
			}

			node_subdivision( _cur_sub.id, _indent + '&nbsp;&nbsp;&nbsp;&nbsp;' );
		}
	}


	if ( _is_boss )
	{
		if ( curPosition.org_id != null && curPosition.parent_object_id == null )
		{
%>
			<option value="<%=curPosition.org_id%>"><%=tools_web.get_cur_lng_name( curPosition.org_id.ForeignElem.disp_name )%></option>
<%
			node_subdivision( curPosition.org_id, '&nbsp;&nbsp;&nbsp;&nbsp;' );
		}
		else
		{
			if ( curPosition.parent_object_id != null )
			{
				curParentObject = OpenDoc( UrlFromDocID( curPosition.parent_object_id ) ).TopElem;
%>
			<option value="<%=curPosition.parent_object_id%>"><%=tools_web.get_cur_lng_name( curParentObject.name )%></option>
<%
				node_subdivision( curPosition.parent_object_id, '&nbsp;&nbsp;&nbsp;&nbsp;' );
			}
		}
	}
	else
	{
		node_subdivision( null, '' );
	}

%>         </select>&nbsp;
		<a onclick="document.location.href = 'view_doc.html?mode=set_course&doc_id=<%=curDocID%>&m=0&course_id=' + document.set_course_form.course_id.value + '&d_num=' + document.set_course_form.day_num.value + '&att_num=' + document.set_course_form.attempts_num.value" href="#"><%=tools.get_web_str('c_shortly')%></a>
<%
	try
	{
		_sub_id = Int( Request.QueryString.sub_id );
%>
<script language="JavaScript">
selcur=document.forms["set_course_form"].elements["subdivision_id"];
selcur.selectedIndex=-1;
for (i=0;i<selcur.options.length;i++)
    if (selcur.options[i].value=="<%=_sub_id%>")
	{
        selcur.selectedIndex=i;
		break;
    }
</script>
<%
	}
	catch ( e )
	{
		_sub_id = null;
	}
%>
		</td>
	</tr>
	<tr>
		<td width="140" align="RIGHT"><b><%=tools.get_web_str('c_sort')%>:</b></td>
		<td align="LEFT">
			<select name="sort_type" onchange="document.location.href = 'view_doc.html?mode=set_course&doc_id=<%=curDocID%>&m=1&course_id=' + document.set_course_form.course_id.value + '&d_num=' + document.set_course_form.day_num.value + '&att_num=' + document.set_course_form.attempts_num.value + '&sub_id=' + document.set_course_form.subdivision_id.value + '&st=' + document.set_course_form.sort_type.value">
				<option SELECTED value=coll><%=tools.get_web_str('c_coll')%></option>
				<option value=pos><%=tools.get_web_str('c_position')%></option>
			</select>
<%
	if ( _sub_id != null )
	{

%>
<script language="JavaScript">
selcur=document.forms['set_course_form'].sort_type;
for (i=0;i<selcur.options.length;i++) {
    if (selcur.options[i].value=="<%=Request.QueryString.st%>") {
        selcur.selectedIndex=i;
    }

if (selcur.selectedIndex==-1) {selcur.selectedIndex=0;}
}
</script>
<%
	}
%>
		</td>
	</tr>
<%
	}
%>
	</table>

	</td>
</tr>

<%
	if ( _mode != '0' )
	{
%>

<tr>
	 <td>

	<br/>
	<table width="100%"  border="0" cellspacing="0" cellpadding="3">
	<tr>
		<td class="tableHeaderWithText" width="40">#</td>
		<td class="tableHeaderWithText"><%=tools.get_web_str('c_coll')%></td>
		<td class="tableHeaderWithText"><%=tools.get_web_str('c_position')%></td>
	</tr>
	<tr>
		<td class="tableHeaderNoText" width="40"><img src="pics/1blank.gif" width="1" height="1" /></td>
		<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="1" height="1" /></td>
		<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="1" height="1" /></td>
	</tr>
<%
		if ( _sub_id != null )
		{
			_order_str = '';
			switch ( Request.QueryString.st )
			{
				case 'pos':
					_order_str = 'name';
					break;
				case 'coll':
					_order_str = 'basic_collaborator_fullname';
					break;
			}

			if ( _sub_id == 'all' )
			{
				_positions = ArraySort( _positions, _order_str, '+' );
			}
			else
			{
				_sub_doc = ArrayFirstElem( XQuery( "for $obj in subs where $obj/id = " + _sub_id + " return $obj" ) );
				if ( _sub_doc.type == 'org' )
				{
					_positions = XQuery( "for $position in positions where $position/org_id = " + _sub_id + " order by $position/" + _order_str + " return $position" );
				}
				else
				{
					_positions = XQuery( "for $position in positions where $position/parent_object_id = " + _sub_id + " order by $position/" + _order_str + " return $position" );
				}
			}

			_counter = 0;
			for ( _position in _positions )
			{
				try
				{
					if ( _position.basic_collaborator_id == null )
						continue;

					_counter++;
					_class = _counter % 2 ? 'tableRowEven' : 'tableRowOdd';
%>
	<tr valign="MIDDLE">
		<td height="17" class="<%=_class%>" width="40" align="center"><%=_counter%></td>
		<td height="17" class="<%=_class%>"><input type=checkbox name="pos_<%=( _counter - 1 )%>" value="<%=_position.basic_collaborator_id%>">&nbsp;<%=_position.basic_collaborator_fullname%></td>
		<td height="17" class="<%=_class%>"><%=tools_web.get_cur_lng_name( _position.name )%></td>
	</tr>
<%
				}
				catch ( k )
				{
				}
			}
		}
%>

	<tr>
		<td class="tableFooter" width="40"><img src="pics/1blank.gif" width="1" height="1" /></td>
		<td class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td>
		<td class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td>
	</tr>
	</table>

	</td>
</tr>
<%
	}
%>

<tr>
	<td align="CENTER">

	<table width="100%" border="0" cellspacing="0" cellpadding="0" class="activator">
	<tr>
		<td align="CENTER" class="activator">
			<input type="hidden" name="position_num" value="<%=ArrayCount( _positions )%>">
			<input type="button" value="<%=tools.get_web_str('vscb_submit')%>" onclick="doSubmit();" class="inputButton" onmouseover="this.className='inputButtonOver';" onmouseout="this.className='inputButton';">
		</td>
	</tr>
	</table>

	</td>
</tr>
</table>
</form>
<br/>