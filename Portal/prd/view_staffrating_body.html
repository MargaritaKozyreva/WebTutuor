<%
_cancel = false;
try
{
	curPAID = Int(Request.QueryString.pa_id);
	curPA = OpenDoc( UrlFromDocID( curPAID ) ).TopElem;
}
catch(_vot_zaraza_)
{
	Response.Write('<center><b>' + tools.get_web_str("vrb_no_pa_text") + '</b></center>');
	//Cancel();
	_cancel = true;
}

if (!_cancel)
{
	if (Request.QueryString.HasProperty("is_post"))
		is_post = Request.QueryString.is_post;
	else
		is_post = '';

	try
	{
		if ( is_post != "1" && StrContains(_PRIVATE_PAS , curPAID) == false)
			throw 'Kuda lezesh, gad!';
	}
	catch(_gik_)
	{
		Response.Write('<center><b>' + tools.get_web_str("vrb_message1") + '</b></center>');
		//Cancel();
		_cancel = true;
	}
}

if (!_cancel)
{
	IS_HUMAN = !curPA.flag_appraise_department;
%>
		<TABLE width="100%" border="0" cellspacing="0" cellpadding="5">
		<TR valign="top">
			<TD>
<%
	_self_pa = null;
	_manager_pa = null;

	try
	{
		if (curPA.status == 'manager' || curPA.status == 'interview')
		{
			_temp_self_pa = ArrayFirstElem(XQuery( 'for $pa in pas where $pa/assessment_appraise_id = ' + curAssessmentAppraiseID + (IS_HUMAN ? ' and $pa/person_id = ' + curPA.person_id : ' and $pa/department_id = ' + curPA.department_id) + ' and $pa/status = \'self\' and $pa/assessment_appraise_type = \'' + curPA.assessment_appraise_type + '\' return $pa' ));
			
			_self_pa = OpenDoc( UrlFromDocID( _temp_self_pa.id ) ).TopElem;
			
			if (curPA.status == 'interview')
			{
				_temp_manager_pa = ArrayFirstElem(XQuery( 'for $pa in pas where $pa/assessment_appraise_id = ' + curAssessmentAppraiseID + (IS_HUMAN ? ' and $pa/person_id = ' + curPA.person_id : ' and $pa/department_id = ' + curPA.department_id) + ' and $pa/status = \'manager\' and $pa/assessment_appraise_type = \'' + curPA.assessment_appraise_type + '\' return $pa' ));
			
			_manager_pa = OpenDoc( UrlFromDocID( _temp_manager_pa .id ) ).TopElem;
			}
		
		}		
	}
	catch(_uuuublin_)
	{
		//alert(_uuuublin_);
	}

	try
	{
		_use_plan = curAssessmentAppraise.flag_use_plan;
		_temp_assessment_plan = ArrayFirstElem(XQuery( 'for $assessment_plan in assessment_plans where $assessment_plan/assessment_appraise_id = ' + curAssessmentAppraiseID +(IS_HUMAN ? ' and $assessment_plan/person_id = ' + curPA.person_id : ' and $assessment_plan/department_id = ' + curPA.department_id) + ' return $assessment_plan' ));
		
		if (_use_plan)
		{
			curAssessmentPlanID = _temp_assessment_plan.id;
			curAssessmentPlan = OpenDoc( UrlFromDocID( curAssessmentPlanID ) ).TopElem;	
		}
		else
		{
			
			//_temp_assessment_plan = ArrayFirstElem(XQuery( 'for $pa in pas where $pa/assessment_appraise_id = ' + curAssessmentAppraiseID + (IS_HUMAN ? (' and $pa/person_id = ' + curPA.person_id) : (' and $pa/department_id = ' + curPA.department_id)) +' and $pa/expert_person_id = ' + curPA.expert_person_id + ' and $pa/status = \'' +curPA.status+ '\' return $pa' ));

			curAssessmentPlanID = curPAID;
			curAssessmentPlan = curPA;
		}
	}
	catch(_oblom_)
	{
		Response.Write(alert("Assessment plan not found..."));
		//Cancel();
		_cancel = true;
	}
}

if (!_cancel)
{
	Server.Execute( "view_assessment_access_variables.html" );

	if (_ALLOW_ADD)
		_ALLOW_ADD = tools_ass.get_assessment_parameter(curAssessmentAppraise, STATUS, 'ProjButtonchecked');
	if (_ALLOW_DELETE)
		_ALLOW_DELETE = tools_ass.get_assessment_parameter(curAssessmentAppraise, STATUS, 'ProjButtoncheckDelete');

	Server.Execute("view_assessment_header.html");
	
	 WF_FORM_TOP = 'top';
	Server.Execute('view_assessment_workflow_buttons.html');

	if (is_post == '1')  //is_pos  start
	{

		if ( Request.QueryString.HasProperty("wfbutt"))
			_wfbutt = Request.QueryString.GetProperty("wfbutt")
		else
			_wfbutt = undefined;
		
		try
		{
			_save_message = Session.assessment_save_msg;
			Session.assessment_save_msg = "";
			if (_save_message == "" || _save_message == null || _save_message == undefined)
				throw "bez_slov";
		}
		catch(_bez_slov_)
		{
			_save_message = "";
		}
		
		if (_wfbutt == undefined || _save_message != "")
		{
%>
<p>
<center><b><%=(_save_message != "" ? HtmlEncode(_save_message) : tools.get_web_str("c_form_save"))%></b></center>
</p>
<%
		}
			
		if( _use_plan && (_wfbutt == curAssessmentPlan.workflow_state || _wfbutt == undefined))
		{

			_href=null;
			if (IS_DONE == false)
			for (_temp_pa in _temp_pas)
			{
				if (Int(Request.QueryString.pa_id) != _temp_pa.id && StrContains(_PRIVATE_PAS , _temp_pa.id))
				if (!_temp_pa.is_done) 
				{ 
					
					_href = 'view_doc.html?mode=assessment_appraise&doc_id=' + curDocID +'&pa_id='+_temp_pa.id + '&assessment_appraise_id=' + curAssessmentAppraiseID + '&assessment_appraise_type=' + _temp_pa.assessment_appraise_type;
					 break;
				}
			}
			
			if (_href == null && curAssessmentPlan.status == curPA.status && (!curAssessmentPlan.is_done) && StrContains(_PRIVATE_PAS , curAssessmentPlanID))
			{		
				_href = 'view_doc.html?mode=assessment_appraise&doc_id=' + curDocID +'&pa_id='+curAssessmentPlanID + '&assessment_appraise_id=' + curAssessmentAppraiseID + '&assessment_appraise_type=result';			
			}	
			
			if (_href != null)
			{
%>		
	<center><a class="asLink" href="<%=_href%>"><%=tools.get_web_str("ass_go_to_next_form")%> &raquo;</a></center>
<%		
			}
		}

	//Cancel();
	_cancel = true;

	}
}
if (!_cancel) // _cancel start
{

// ------------ WORKFLOW-FIELDS -------------------
var workflow_fields = Array();
var wfid = 0;
for (_wf_group in curWorkflow.field_groups)
{
	if ( _wf_group.read_conditions.condition_eval_str == '' || eval( _wf_group.read_conditions.condition_eval_str) )
	{
		_field_group = ArraySelect( curWorkflow.workflow_fields, "field_group_id == _wf_group.PrimaryKey");
		if (ArrayCount(_field_group) > 0)
		{
			if ( _wf_group.write_conditions.condition_eval_str == '' || eval( _wf_group.write_conditions.condition_eval_str) )
				_use_dirty_fingers = true;
			else
				_use_dirty_fingers = false;
		
			for (_fg in _field_group)
			{
				workflow_fields[wfid] = new Object;
				workflow_fields[wfid].field = _fg;
				if (StrBegins(_wf_group.code, "$"))
					workflow_fields[wfid].major = true;
				else
					workflow_fields[wfid].major = false;
				
				workflow_fields[wfid].is_modify = _use_dirty_fingers;
				workflow_fields[wfid].index = wfid;
				wfid = wfid + 1;
			}
		}
	}
}

function drill_select(_DRILL_PACK, _E_NODE, _E_PACK, _E_IDX)
{
	try
    {
        if (_E_IDX == ArrayCount(_E_PACK) - 1)
        {
            _DRILL_PACK[ArrayCount(_DRILL_PACK)] = eval( (_E_NODE != null ? '_E_NODE' : '') + _E_PACK[_E_IDX]);
        }
        else
        {
            _e_new = eval((_E_NODE != null ? '_E_NODE' : '') + _E_PACK[_E_IDX]);
            for (_e_new_item in _e_new)
            {
                _DRILL_PACK = drill_select(_DRILL_PACK, _e_new_item, _E_PACK, _E_IDX + 1);
            }
        }
    }
    catch(_mrmr_)
    {}
	return _DRILL_PACK;
}
// ------------ -------- -------------------



if (_cur_assessment_appraise_type != undefined)
{
	_flag_translate = _cur_assessment_appraise_type.flag_01;
	if (_cur_assessment_appraise_type.flag_02 == 'rank')
	{
		if (_cur_assessment_appraise_type.flag_03.HasValue)
			_ranking = _cur_assessment_appraise_type.flag_03;
		else
			_ranking = 0;
	}
	else
	{
		_ranking = null;
	}
    
    _scale_type = _cur_assessment_appraise_type.flag_03;
    if (_scale_type == null)
    	_scale_type = 1;
    _scale_string = _cur_assessment_appraise_type.flag_07;

}
else
{
	_flag_translate = false;
	_ranking = null;
    _scale_type = 1;
    _scale_string = "";
}

_hide_fields = tools_ass.get_workflow_state_parameter(_curState, "hide_fields");

if (_hide_fields == undefined)
	_hide_fields = Array();
else
	_hide_fields = String(_hide_fields).split(",");

_proj_show = tools_ass.get_assessment_parameter(curAssessmentAppraise, STATUS, "Projshow");
if (_proj_show && ArrayOptFind(_hide_fields, "This == 'staffrating_form'") != undefined)
	_proj_show = false;
	
if (ArrayOptFind(_hide_fields, "This == 'staffrating_weight'") != undefined)
	_weight_hide = "none";
else
	_weight_hide = "";
	
if (ArrayOptFind(_hide_fields, "This == 'staffrating_mark'") != undefined)
	_mark_hide = "none";
else
	_mark_hide = "";

_submit_script_hide = (ArrayOptFind(_hide_fields, "This == 'staffrating_submit_script'") != undefined);	

_lock_fields = tools_ass.get_workflow_state_parameter(_curState, "lock_fields");
if (_lock_fields == undefined)
	_lock_fields = Array();
else
	_lock_fields = String(_lock_fields).split(",");

	
if (tools_ass.get_workflow_state_parameter(_curState, "force_open_mark") == "true")	
	_force_mark_open = true;
else
	_force_mark_open = false;

if (tools_ass.get_workflow_state_parameter(_curState, "force_open_plan") == "true")	
	_force_plan_open = true;
else
	_force_plan_open = false;

	
SUPPLEMENTARY_INDEXER = 0;


	if (curHostSettings.default_portal_type == "sharepoint")
	{
%>
<script language="javascript">
<!--
	var imgDir = '<%=curHostSettings.proxy_prefix%>/scripts/calendar/';
-->
</script>
<%
	}
%>
<script src="<%=(curHostSettings.default_portal_type == "sharepoint" ? curHostSettings.proxy_prefix + '/': "")%>scripts/calendar/calendar.js"></script>

<script language="javascript">
<!--

function changeColor()
	{		
		event.srcElement.style.borderColor="red";
		event.srcElement.flag="m";
	}

function changeColorNew(srcElement)
	{
		srcElement.style.borderColor="red";		
		srcElement.flag="m";
	}
//--------------------------------------------------------------------------------------------

		function checkkey()
		{
			var srcobj = event.srcElement;
			var keycode=event.keyCode;
			if ((keycode<48 || keycode>57)& keycode!=46) return false;			
			if (keycode==46) if(srcobj.value.indexOf('.') >= 0) return false;	
			return true;
		}



		function checkkeyInt()
		{
			var srcobj = event.srcElement;
			var keycode=event.keyCode;
			if ((keycode<48 || keycode>57)) return false;						
			return true;
		}

//--------------------------------------------------------------------------------------------

<%
	if (_proj_show)
	{
%>

function projForceSum100(Eq)
{
	
	var sum=0;
	var count=0;
	var temp="";
	var currid="";
	
	var i=1;
	
	var tcounter=0;
	if (document.getElementById("tcounter").value!="") tcounter=parseInt(document.getElementById("tcounter").value);
	for (i=1; i<=tcounter; i++)
	if (document.getElementById("i_weight_0_"+ i))
	{
		temp=document.getElementById("i_weight_0_"+ i).value;
		if (temp=="") {temp="0";document.getElementById("i_weight_0_"+ i).value="0"; changeColorNew(document.getElementById("i_weight_0_"+ i));}
		sum=sum+parseInt(temp);
		temp="";
		count++;
	}
	
	if (sum>0 & Eq!=1)
	{
		scale=100.0/sum;
		sum=0;
		for (i=1; i<=tcounter; i++)
			if (document.getElementById("i_weight_0_"+ i))
		{
			document.getElementById("i_weight_0_"+ i).value=parseInt(parseFloat(document.getElementById("i_weight_0_"+ i).value) * scale);
			changeColorNew(document.getElementById("i_weight_0_"+ i));
			sum=sum+parseInt(document.getElementById("i_weight_0_"+ i).value);
		}
	}
	else
	{
		if (count  > 0)
		{
			scale=100.0/(count);
			sum=0;
			for (i=1; i<=tcounter; i++)
				if (document.getElementById("i_weight_0_"+ i))
			{	
				document.getElementById("i_weight_0_"+ i).value=parseInt(scale);
				changeColorNew(document.getElementById("i_weight_0_"+ i));
				sum=sum+parseInt(document.getElementById("i_weight_0_"+ i).value);
			}
		}
	}
	
	if (document.getElementById("i_weight_0_"+ 1)) document.getElementById("i_weight_0_"+ 1).value=(parseInt(document.getElementById("i_weight_0_"+ 1).value) + 100-sum);


}

//--------------------------------------------------------------------------------------------



function addTarget(srcElement)
{
	var tobj=document.getElementById("userbodytable");
	var major_count=parseInt(document.getElementById("tcounter").value);
	major_count++;
	document.getElementById("tcounter").value=major_count;
	
	var trow=document.createElement("TR");
	
	trow.setAttribute("id","line0_"+major_count);
	trow.setAttribute("subobjectives","0");
	trow.setAttribute("bgColor","whitesmoke");
	 
	var tinsrow=tobj.appendChild(trow);
	
	<!--  * ¹ *  -->
	var tcol1=document.createElement("TD");
	tcol1.innerHTML= + major_count;
	tcol1.colSpan=1;
	tcol1.rowSpan=<%=((_ranking == null ? 2 : 1) - (_mark_hide == "none" ? 1 : 0))%>;
	tcol1.setAttribute("align","center");
	tcol1.setAttribute("id","td1_0_"+major_count);
	tcol1.setAttribute("name","td1_0_"+major_count);
	var tinscol1=trow.appendChild(tcol1);
	
	<!--  * target name *  -->
	var tcol2=document.createElement("TD");
	tcol2.setAttribute("align","center");
	tcol2.setAttribute("vAlign","top");
	tcol2.colSpan=1;
	tcol2.rowSpan= <%=((_ranking == null ? 2 : 1) - (_mark_hide == "none" ? 1 : 0))%>;
	tcol2.setAttribute("id","td2_0_"+major_count);
	tcol2.setAttribute("name","td2_0_"+major_count);
	var tinscol2=trow.appendChild(tcol2);
	
	
	/*
	//var tinput2=document.createElement("INPUT");
	var tinput2=document.createElement("TEXTAREA");
	tinput2.className="commonTextarea";
	//tinput2.setAttribute("type","Text");
	tinput2.style.width="200px";
	tinput2.setAttribute("id","i_name_0_"+major_count);
	tinput2.setAttribute("name","i_name_0_"+major_count);
	tinput2.attachEvent("onchange",changeColor);
	tinscol2.appendChild(tinput2);
	changeColorNew(tinput2);
	*/
	
	var _headHTML = ' <table cellpadding="5" cellspacing="0"><tr><td colspan="2"><textarea style="width: 300px" rows="5" id="i_name_0_'+ major_count +'" name="i_name_0_' + major_count + '" class="commonTextarea" onChange="changeColor();"></textarea><input type="hidden" id="i_identifier_0_'+ major_count +'" name="i_identifier_0_' + major_count + '" value="' + (Math.random() * 1000000000) + '"/>				</td></tr>';
<%
	if (_flag_translate)
	{
%>
	_headHTML += '<tr><td colspan="2" align="center">		<hr/>	</td></tr>			<tr><td colspan="2" align="center"><input type="button" class="inputButton" onMouseOver="this.className=\'inputButtonOver\';" onMouseOut="this.className=\'inputButton\';" value="<%=tools.get_web_str("vsb_translate")%>" id="transbut0_' + major_count + '" name="transbut0_'+ major_count + '" onclick="translate(this)"/>			</td></tr>				<tr><td width="100%">				<select name="transfered_urls_0_' + major_count + '" class="personalMenu">			<option value="#"> <%=tools.get_web_str("vsb_translations_does_not_exist")%></option>			</select>		</td><td>  <input type="button" name="transfered_urls_but_0_' + major_count + '" id="transfered_urls_but_0_' + major_count + '" value="&nbsp;&gt;&nbsp;" onClick="MM_jumpMenuGo(\'transfered_urls_0_' + major_count + '\',\'document\',0)" class="inputButton" onMouseOver="this.className=\'inputButtonOver\';" onMouseOut="this.className=\'inputButton\';" style="display:none"/>		</td></tr>		<tr><td colspan="2" align="center">		<hr/>		</td></tr>		<tr><td colspan="2" align="center"><input type="button" class="inputButton" onMouseOver="this.className=\'inputButtonOver\';" onMouseOut="this.className=\'inputButton\';" value="<%=tools.get_web_str("vsb_connect")%>" id="bindbut0_' + major_count + '" name="bindbut0_' + major_count + '" onclick="bind(this)"/>	</td></tr>	<tr><td colspan="2" align="center" id="td_bind_name_0_' + major_count + '" name="td_bind_name_0_' + major_count + '">		</td></tr>';
<%
	}
%>
	_headHTML += '</table>';
	
	
	tinscol2.insertAdjacentHTML('beforeEnd',_headHTML);
	
	
	changeColorNew(document.getElementById(("i_name_0_"+ major_count )));
	
	var tinput2_2=document.createElement("INPUT");
	tinput2_2.setAttribute("type","hidden");
	tinput2_2.className="semiVisibleField";
	tinput2_2.readOnly=true;
	tinput2_2.setAttribute("id","i_identifier_0_"+major_count);
	tinput2_2.setAttribute("name","i_identifier_0_"+major_count);
	
	tinput2_2.value=Math.random() * 1000000000;
	
	tinscol2.appendChild(tinput2_2);
	
		
	<!--  * weight *  -->
	 var tcol3=document.createElement("TD");
	tcol3.setAttribute("align","center");
	tcol3.setAttribute("vAlign","top");
	tcol3.colSpan=1;
	tcol3.rowSpan=<%=((_ranking == null ? 2 : 1) - (_mark_hide == "none" ? 1 : 0))%>;
	tcol3.setAttribute("id","td3_0_"+major_count);
	tcol3.setAttribute("name","td3_0_"+major_count);
	tcol3.style.display = "<%=_weight_hide%>";
	var tinscol3=trow.appendChild(tcol3);
	
<%
	if (_ranking != null)
	{
%>
	var tinput3=document.createElement("SELECT");
	tinput3.style.width="50px";
	tinput3.setAttribute("id","i_weight_0_"+major_count);
	tinput3.setAttribute("name","i_weight_0_"+major_count);
//	tinput3.attachEvent("onchange",changeColor);
	$(tinput3).change = function(){
		changeColor();
		update_marks(major_count, this.value);
	}
<%
	for( x=0;x<=_ranking;x++)
	{
%>
		var ioption=document.createElement("OPTION");
		ioption.setAttribute("value","<%=x%>");
		ioption.text=" <%=x%> ";
		tinput3.add(ioption);
<%
	}
%>
	
	
	tinscol3.appendChild(tinput3);
	changeColorNew(tinput3);
		
<%
	}
	else
	{
%>
	
	var tinput3=document.createElement("INPUT");
	tinput3.setAttribute("type","Text");
	tinput3.className="inputEdit";
	tinput3.style.width="50px";
	tinput3.setAttribute("id","i_weight_0_"+major_count);
	tinput3.setAttribute("name","i_weight_0_"+major_count);
	//$(tinput3).keypress(checkkeyInt);
//	$(tinput3).change(changeColor);
	$(tinput3).keypress(checkkeyInt);
	$(tinput3).change(changeColor);
	tinscol3.appendChild(tinput3);
	changeColorNew(tinput3);
	
<%
	}
%>
	
	var n = 0;
	var id = major_count;
<%
		//----------- WORKFLOW-FIELDS ---------------- //
			for (_wf in workflow_fields)
			if (_wf.major)
			{
				_extra_identifier = "extra_" + _wf.field.name + "$";
%>
	var tcol_extra=document.createElement("TD");
	tcol_extra.setAttribute("align","center");
	tcol_extra.setAttribute("vAlign","top");
	tcol_extra.setAttribute("id","td_<%=(_extra_identifier)%>" + n + "_"+id);
	tcol_extra.setAttribute("name","td_<%=(_extra_identifier)%>" + n + "_"+id);
	tcol_extra.rowSpan=<%=((_ranking == null ? 2 : 1) - (_mark_hide == "none" ? 1 : 0))%>;
	
	var tinput_extra_ident = document.createElement("INPUT");
	tinput_extra_ident.setAttribute("id","i_name_<%=(_extra_identifier)%>"+ n +"_"+id);
	tinput_extra_ident.setAttribute("name","i_name_<%=(_extra_identifier)%>"+ n +"_"+id);
	tinput_extra_ident.type="hidden";
	tinput_extra_ident.value="<%=(_wf.field.name)%>";
	tcol_extra.appendChild(tinput_extra_ident);
	
	var _RESP_VAL = "";
	var _extra_identifier = "<%=_extra_identifier%>";
<%
		if (_wf.is_modify)
		{
				switch (_wf.field.type)
				{
					case "string":
%>
			_RESP_VAL = '<input TYPE="text" style="width: 300px" class="inputEdit" onChange="changeColor();" id="i_value_' + _extra_identifier + n + '_' + id + '" name="i_value_' + _extra_identifier + n + '_' + id + '"/>';
<%
						break;
					case "integer":
%>
			_RESP_VAL = '<input TYPE="text" style="width: 60px" class="inputEdit" onChange="changeColor();" id="i_value_' + _extra_identifier + n + '_' + id + '" name="i_value_' + _extra_identifier + n + '_' + id + '" onKeyPress="return checkkeyInt();"/>';
<%
						break;
					case "real":
%>
			_RESP_VAL = '<input TYPE="text" style="width: 60px" class="inputEdit" onChange="changeColor();" id="i_value_' + _extra_identifier + n + '_' + id + '" name="i_value_' + _extra_identifier + n + '_' + id + '" onKeyPress="return checkkey();"/>';
<%
						break;
					case "date":
%>
			_RESP_VAL = '<input type="text" style="width: 70px" id="i_value_' + _extra_identifier + n + '_' + id + '" name="i_value_' + _extra_identifier + n + '_' + id + '" class="inputEdit" onChange="changeColor();" readonly><a href="#"  tn="i_value_' + _extra_identifier + n + '_' + id + '" onClick="var h=0; var offP = this.offsetParent; while(offP.id != \'main_block\' && offP.tagName.toUpperCase()!=\'BODY\') {h+=offP.offsetTop; offP = offP.offsetParent;} ; showCalendar(this, document.getElementById(\'i_value_' + _extra_identifier + n + '_' + id + '\'), \'dd.mm.yyyy\',\'ru\',1, null, h + 40); changeColorNew(document.getElementById(\'i_value_' + _extra_identifier + n + '_' + id + '\')); return false;" id="cal' + _extra_identifier + '" name="cal' + _extra_identifier + '"><img src="<%=(curHostSettings.default_portal_type == "sharepoint" ? curHostSettings.proxy_prefix : "")%>/scripts/calendar/calendar.gif" width="24" height="22" border="0" align="absmiddle" /></a>';
<%
						break;
					case "bool":
%>
			_RESP_VAL = '<input type="checkbox" style="width: 15px" id="i_value_' + _extra_identifier + n + '_' + id + '" name="i_value_' + _extra_identifier + n + '_' + id + '" onclick="if (this.checked) this.value=1; else this.value=0;"/>';
<%
						break;
					case "combo":
%>
			_RESP_VAL = '<select onChange="changeColor();" id="i_value_' + _extra_identifier + n + '_' + id + '" name="i_value_' + _extra_identifier + n + '_' + id + '"><option value="">&nbsp;</option>';
<%


						for (_ent in _wf.field.entries)
						{
							_reload_val = HtmlEncode(_ent.value);
							if (StrBegins(_reload_val , "@"))
							{
								_reload_val = String(_reload_val).slice(1);
								_reload_val =_reload_val.split("[]");
								
								_drill_response = drill_select(Array(), null, _reload_val, 0);
								for (_dr in _drill_response)
								{
%>
										_RESP_VAL = _RESP_VAL + '<option value="<%=HtmlEncode(_dr)%>"><%=HtmlEncode(_dr)%></option>';
<%
								}
							}
							else
							{
%>
								_RESP_VAL = _RESP_VAL + '<option value="<%=_reload_val%>"><%=_reload_val%></option>';
<%
							}
						}
%>
				_RESP_VAL = _RESP_VAL + '</select>';
<%
						break;
					default:
%>
			_RESP_VAL = '<textarea id="i_value_' + _extra_identifier + n + '_' + id + '" name="i_value_' + _extra_identifier +  n + '_' + id + '" class="commonTextarea" onChange="changeColor();"></textarea>';
<%
						break;
				}
		}
		else
		{
%>
			_RESP_VAL = '<input TYPE="hidden" id="i_value_' + _extra_identifier +  n + '_' + id + '" name="i_value_' + _extra_identifier +  n + '_' + id + '"/>&nbsp;';
<%
		}	
%>
			tcol_extra.insertAdjacentHTML("beforeEnd",_RESP_VAL);
			tcol_extra=trow.appendChild(tcol_extra);

			var t_extra_obj_init = document.getElementById("i_value_" + _extra_identifier + n + "_" + id);
			
			changeColorNew(t_extra_obj_init);
<%
			}
			//----------- -------- ---------------- //
%>
	
	<!-- inforow -->
	
	var tcol4=document.createElement("TD");
	tcol4.colSpan= <%= 4 + (ArrayCount(ArraySelect(workflow_fields, "major == false")) - (_mark_hide == "none" ? 1 : 0))%>;
	tcol4.setAttribute("id","td4_0_"+major_count);
	tcol4.setAttribute("name","td4_0_"+major_count);
	var tinscol4=trow.appendChild(tcol4);
	
	
	tinscol4.insertAdjacentHTML('beforeEnd','<table width="100%" cellspacing="0" cellpadding="5"><tr><td align="left">');
<%
	if (ArrayOptFind(_lock_fields, "This == 'staffrating_add_subobjective'" ) == undefined)
	{
%>
		tinscol4.insertAdjacentHTML('beforeEnd','<input type="button" class="inputButton" onMouseOver="this.className=\'inputButtonOver\';" onMouseOut="this.className=\'inputButton\';" id="add0_'+major_count+'" name="add0_'+major_count+'" value="<%=(_ranking != null ? tools.get_web_str("vsb_add_criterion_of_purpose")  : tools.get_web_str("vsb_add_expected_result")  )%>" onClick="addSubTarget(this);"/>');
<%
	}
%>	
	tinscol4.insertAdjacentHTML('beforeEnd','&nbsp;</td></tr></table>');
	
	<!-- * mark * -->
	/*
	 var tcol7=document.createElement("TD");
	tcol7.setAttribute("align","center");
	tcol7.colSpan=1;
	tcol7.setAttribute("id","td7_0_"+major_count);
	tcol7.setAttribute("name","td7_0_"+major_count);
	var tinscol7=trow.appendChild(tcol7);
	*/
	
	<!-- * buttons * -->
	 var tcol8=document.createElement("TD");
	tcol8.setAttribute("align","center");
	tcol8.colSpan=1;
	tcol8.setAttribute("id","td8_0_"+major_count);
	tcol8.setAttribute("name","td8_0_"+major_count);
	var tinscol8=trow.appendChild(tcol8);
	
	
	var tinput8=document.createElement("INPUT");
	tinput8.setAttribute("type","BUTTON");
	tinput8.className="inputButton";
	tinput8.setAttribute("id","but0_"+major_count);
	tinput8.setAttribute("name","but0_"+major_count);
	tinput8.setAttribute("value","X");
	tinput8.disabled=<%=(ArrayOptFind(_lock_fields, "This == 'staffrating_add_objective'" ) != undefined)%>;
	$(tinput8).click(function(){deleteTarget(tinput8)});
	$(tinput8).mouseover(function(){srcElement.className='inputButtonOver';});
	$(tinput8).mouseout(function(){srcElement.className='inputButton';});
	
	tinscol8.appendChild(tinput8);
	
		
	<!-- * Mark bottom ROW! * -->
<%
	if (_ranking == null)
	{
%>
	var trow=document.createElement("TR");
	
	 
	trow.setAttribute("id","linex_"+major_count);
	trow.height="30px";
	trow.style.display = "<%=_mark_hide%>";
	trow.setAttribute("bgColor","whitesmoke");
	
	var tinsrow=tobj.appendChild(trow);
	var tcol1=document.createElement("TD");
	tcol1.innerHTML= "<b><%=tools.get_web_str("ass_final_estimation")%>:</b>";
	tcol1.colSpan=3 + <%=ArrayCount(ArraySelect(workflow_fields, "major == false"))%>;
	tcol1.setAttribute("align","right");
	tcol1.setAttribute("id","td1_x_"+major_count);
	tcol1.setAttribute("name","td1_x_"+major_count);
	//tcol1.setAttribute("className","tableHeaderWithText");
	//tcol1.setAttribute("align", 'left');
	var tinscol1=trow.appendChild(tcol1);
	
	var tcol7=document.createElement("TD");
	tcol7.colSpan=2;
	tcol7.setAttribute("align","center");
	tcol7.setAttribute("id","td7_x_"+major_count);
	tcol7.setAttribute("name","td7_x_"+major_count);
	var tinscol7=trow.appendChild(tcol7);
	
	var tinput7=document.createElement("INPUT");
	tinput7.setAttribute("type","Text");
	tinput7.className="inputEdit";
	tinput7.style.width="80px";
	tinput7.setAttribute("id","i_mark_0_"+major_count);
	tinput7.setAttribute("name","i_mark_0_"+major_count);
	$(tinput7).keypress(checkkey);
	$(tinput7).change(changeColor);
	tinscol7.appendChild(tinput7);
	tinput7.readOnly=true;
	changeColorNew(tinput7);
	paintPetrified(tinput7);
<%
	}
%>
	
	document.getElementById("tcounter").value=major_count;
}

//---------------------------------------------------------------------------------------

function addSubTarget(srcElement)
{

/*

	var stAttr="status:no;dialogWidth:350px;dialogHeight:300px;help:no";
	var parobj=new Object();
	parobj.handle=false;
	showModalDialog("[pageurl]dlg_staffrating_typeselect.html" , parobj, stAttr);
	
	if (!parobj.handle) return false;
	var objtype=(parobj.type);
*/

	<%
		if (_scale_type > 0)
		{
			Response.Write("var objtype=(" + _scale_type + ");");
		}
	%>
	//var id=event.srcElement.getAttribute('name');
        var id=srcElement.getAttribute('name');
	if (id)	id=id.substring(5,id.length);
	
	var n=0;
	
	var lastobject;
	
	var trow_main=document.getElementById("line0_" + id);
	if (!(trow_main.getAttribute("subobjectives")) ) trow_main.setAttribute("subobjectives",0);
			
	
	for (x=0; x<=parseInt(trow_main.getAttribute("subobjectives")); x++)
	{
		if (document.getElementById("line" + x + "_" + id))
		{
			lastobject=document.getElementById("line" + x + "_" + id);
			n=x+1;
		}
	}
	
	//alert("subobj="+parseInt(trow_main.subobjectives)+" ; n=" + n + "; x=" +x);
	
	if (n==0) n=1;
	
	var trow=document.createElement("TR");
	trow.setAttribute("id","line" + n + "_" + id);
	trow.setAttribute("bgColor","whitesmoke");
	var tinsrow=lastobject.insertAdjacentElement('afterEnd',trow);
	document.getElementById("td1_0_"+id).rowSpan = n + <%=((_ranking == null ? 2 : 1) - (_mark_hide == "none" ? 1 : 0))%>;
	document.getElementById("td2_0_"+id).rowSpan = n + <%=((_ranking == null ? 2 : 1) - (_mark_hide == "none" ? 1 : 0))%>;
	document.getElementById("td3_0_"+id).rowSpan = n + <%=((_ranking == null ? 2 : 1) - (_mark_hide == "none" ? 1 : 0))%>;
	<%
		//----------- WORKFLOW-FIELDS ---------------- //
			for (_wf in workflow_fields)
			if (_wf.major)
			{
				_extra_identifier = "extra_" + _wf.field.name + "$";
	%>
	document.getElementById("td_<%=(_extra_identifier)%>" + 0 + "_"+id).rowSpan = n + <%=((_ranking == null ? 2 : 1) - (_mark_hide == "none" ? 1 : 0))%>;
	<%
			}
	%>
	 <!--  * plan *  -->
	 var tcol4=document.createElement("TD");
	tcol4.setAttribute("align","center");
	tcol4.setAttribute("id","td4_"+n+"_"+id);
	tcol4.setAttribute("name","td4_"+n+"_"+id);
	var tinscol4=trow.appendChild(tcol4);
	
	<!--  * period *  -->
	 var tcol5=document.createElement("TD");
	tcol5.setAttribute("align","center");
	tcol5.setAttribute("id","td5_"+n+"_"+id);
	tcol5.setAttribute("name","td5_"+n+"_"+id);
	var tinscol5=trow.appendChild(tcol5);
	
	var tinput5=document.createElement("INPUT");
	tinput5.setAttribute("type","Text");
	tinput5.className="inputEdit";
	tinput5.style.width="70px";
	tinput5.readOnly=true;
	tinput5.setAttribute("id","i_period_"+n+"_"+id);
	tinput5.setAttribute("name","i_period_"+n+"_"+id);
	$(tinput5).change(changeColor);
	tinscol5.appendChild(tinput5);
	
	tinscol5.insertAdjacentHTML("beforeEnd","<a class='asLink' href='#' style='display: <%=(ArrayOptFind(_lock_fields, "This == 'staffrating_period'" ) != undefined ? "none" : "")%>' tn='i_period_"+n+"_"+id+"' onClick='var h=0; var offP = this.offsetParent; while(offP.id != \"main_block\" && offP.tagName.toUpperCase()!=\"BODY\") {h+=offP.offsetTop; offP = offP.offsetParent;} ; showCalendar(this, document.getElementById(\"i_period_"+n+"_"+id+"\"), \"dd.mm.yyyy\",\"ru\",1, null, h + 40);return false;' id='pcal"+n+"_"+id+"' name='pcal"+n+"_"+id+"'><img src='<%=(curHostSettings.default_portal_type == "sharepoint" ? curHostSettings.proxy_prefix: "")%>/scripts/calendar/calendar.gif' width=24 height=22 border=0 align=absmiddle></a>");
		
			
	changeColorNew(tinput5);
	
	if (<%=(ArrayOptFind(_lock_fields, "This == 'staffrating_period'" ) != undefined)%>)
		paintPetrified(document.getElementById("i_period_"+n+"_"+id));
	
	
	<!-- * fact * -->
	 var tcol6=document.createElement("TD");
	tcol6.setAttribute("align","center");
	tcol6.setAttribute("id","td6_"+n+"_"+id);
	tcol6.setAttribute("name","td6_"+n+"_"+id);
	var tinscol6=trow.appendChild(tcol6);
	 
	 
<%
		//----------- WORKFLOW-FIELDS ---------------- //
			for (_wf in workflow_fields)
			if (!_wf.major)
			{
				_extra_identifier = "extra_" + _wf.field.name + "$";
%>
	var tcol_extra=document.createElement("TD");
	tcol_extra.setAttribute("align","center");
	tcol_extra.setAttribute("id","td_<%=(_extra_identifier)%>"+n+"_"+id);
	tcol_extra.setAttribute("name","td_<%=(_extra_identifier)%>"+n+"_"+id);

	var tinput_extra_ident = document.createElement("INPUT");
	tinput_extra_ident.setAttribute("id","i_name_<%=(_extra_identifier)%>"+n+"_"+id);
	tinput_extra_ident.setAttribute("name","i_name_<%=(_extra_identifier)%>"+n+"_"+id);
	tinput_extra_ident.type="hidden";
	tinput_extra_ident.value="<%=(_wf.field.name)%>";
	tcol_extra.appendChild(tinput_extra_ident);
	
	var _RESP_VAL = "";
	var _extra_identifier = "<%=_extra_identifier%>";
<%
		if (_wf.is_modify)
		{
				switch (_wf.field.type)
				{
					case "string":
%>
			_RESP_VAL = '<input TYPE="text" style="width: 300px" class="inputEdit" onChange="changeColor();" id="i_value_' + _extra_identifier + n + '_' + id + '" name="i_value_' + _extra_identifier + n + '_' + id + '"/>';
<%
						break;
					case "integer":
%>
			_RESP_VAL = '<input TYPE="text" style="width: 60px" class="inputEdit" onChange="changeColor();" id="i_value_' + _extra_identifier + n + '_' + id + '" name="i_value_' + _extra_identifier + n + '_' + id + '" onKeyPress="return checkkeyInt();"/>';
<%
						break;
					case "real":
%>
			_RESP_VAL = '<input TYPE="text" style="width: 60px" class="inputEdit" onChange="changeColor();" id="i_value_' + _extra_identifier + n + '_' + id + '" name="i_value_' + _extra_identifier + n + '_' + id + '" onKeyPress="return checkkey();"/>';
<%
						break;
					case "date":
%>
			_RESP_VAL = '<input type="text" style="width: 70px" id="i_value_' + _extra_identifier + n + '_' + id + '" name="i_value_' + _extra_identifier + n + '_' + id + '" class="inputEdit" onChange="changeColor();" readonly><a class="asLink" href="#"  tn="i_value_' + _extra_identifier + n + '_' + id + '" onClick="var h=0; var offP = this.offsetParent; while(offP.id != \'main_block\' && offP.tagName.toUpperCase()!=\'BODY\') {h+=offP.offsetTop; offP = offP.offsetParent;} ; showCalendar(this, document.getElementById(\'i_value_' + _extra_identifier + n + '_' + id + '\'), \'dd.mm.yyyy\',\'ru\',1, null, h + 40); changeColorNew(document.getElementById(\'i_value_' + _extra_identifier + n + '_' + id + '\')); return false;" id="cal' + _extra_identifier + '" name="cal' + _extra_identifier + '"><img src="<%=(curHostSettings.default_portal_type == "sharepoint" ? curHostSettings.proxy_prefix : "")%>/scripts/calendar/calendar.gif" width="24" height="22" border="0" align="absmiddle" /></a>';
<%
						break;
					case "bool":
%>
			_RESP_VAL = '<input type="checkbox" style="width: 15px" id="i_value_' + _extra_identifier + n + '_' + id + '" name="i_value_' + _extra_identifier + n + '_' + id + '" onclick="if (this.checked) this.value=1; else this.value=0;"/>';
<%
						break;
					case "combo":
%>
			_RESP_VAL = '<select onChange="changeColor();" id="i_value_' + _extra_identifier + n + '_' + id + '" name="i_value_' + _extra_identifier + n + '_' + id + '"><option value="">&nbsp;</option>';
<%
						for (_ent in _wf.field.entries)
						{
							_reload_val = HtmlEncode(_ent.value);
							if (StrBegins(_reload_val , "@"))
							{
								_reload_val = String(_reload_val).slice(1);
								_reload_val =_reload_val.split("[]");
								
								_drill_response = drill_select(Array(), null, _reload_val, 0);
								for (_dr in _drill_response)
								{
%>
									_RESP_VAL = _RESP_VAL + '<option value="<%=HtmlEncode(_dr)%>"><%=HtmlEncode(_dr)%></option>';
<%
								}
							}
							else
							{
%>
								_RESP_VAL = _RESP_VAL + '<option value="<%=_reload_val%>"><%=_reload_val%></option>';
<%
							}
						}
%>
				_RESP_VAL = _RESP_VAL + '</select>';
<%
						break;
					default:
%>
			_RESP_VAL = '<textarea id="i_value_' + _extra_identifier + n + '_' + id + '" name="i_value_' + _extra_identifier +  n + '_' + id + '" class="commonTextarea" onChange="changeColor();"></textarea>';
<%
						break;
				}
		}
		else
		{
%>
			_RESP_VAL = '<input TYPE="hidden" id="i_value_' + _extra_identifier +  n + '_' + id + '" name="i_value_' + _extra_identifier +  n + '_' + id + '"/>&nbsp;';
<%
		}	
%>
			tcol_extra.insertAdjacentHTML("beforeEnd",_RESP_VAL);
			tcol_extra=trow.appendChild(tcol_extra);

			var t_extra_obj_init = document.getElementById("i_value_" + _extra_identifier + n + "_" + id);
			
			changeColorNew(t_extra_obj_init);
<%
			}
			//----------- -------- ---------------- //
%>

	<!-- * mark * -->
	 var tcol7=document.createElement("TD");
	tcol7.setAttribute("align","center");
	tcol7.colSpan=1;
	tcol7.setAttribute("id","td7_"+n+"_"+id);
	tcol7.setAttribute("name","td7_"+n+"_"+id);
	tcol7.style.display="<%=_mark_hide%>";
	var tinscol7=trow.appendChild(tcol7);
	
<%
	if (_ranking != null)
	{
%>
		var tinput4=document.createElement("TEXTAREA");
		tinput4.className="commonTextarea";
		tinput4.style.width="200px";
		tinput4.setAttribute("id","i_plan_"+n+"_"+id);
		tinput4.setAttribute("name","i_plan_"+n+"_"+id);
		tinput4.readOnly=<%=(ArrayOptFind(_lock_fields, "This == 'staffrating_plan'" ) != undefined)%>;
		$(tinput4).change(changeColor);
		tinscol4.appendChild(tinput4);
		changeColorNew(tinput4);
		
		var tinput6=document.createElement("TEXTAREA");
		tinput6.className="commonTextarea";
		tinput6.style.width="200px";
		tinput6.setAttribute("id","i_fact_"+n+"_"+id);
		tinput6.setAttribute("name","i_fact_"+n+"_"+id);
		tinput6.readOnly=<%=(!_ALLOW_MARK_MODIFY || ArrayOptFind(_lock_fields, "This == 'staffrating_fact'" ) != undefined)%>;
		$(tinput6).change(changeColor);
		tinscol6.appendChild(tinput6);
		changeColorNew(tinput6);
		
		
		var tinput7=document.createElement("SELECT");
		tinput7.className="inputEdit";
		tinput7.style.width="50px";
		tinput7.readOnly=<%=(!_ALLOW_MARK_MODIFY || ArrayOptFind(_lock_fields, "This == 'staffrating_mark'" ) != undefined)%>;
		tinput7.disabled = <%=(!_ALLOW_MARK_MODIFY || ArrayOptFind(_lock_fields, "This == 'staffrating_mark'" ) != undefined)%>;
		tinput7.setAttribute("id","i_mark_"+n+"_"+id);
		tinput7.setAttribute("name","i_mark_"+n+"_"+id);
		$(tinput7).change(function(){ update_status_bar(); changeColor();} );
				
		var ms_value = document.getElementById("i_weight_0_"+id).value;
		
		if ( ms_value != "")
		{
			var ioption=document.createElement("OPTION");
			ioption.setAttribute("value","");
			ioption.text=" ";
			tinput7.add(ioption);
			
			for (_a = 0 - ms_value; _a <= ms_value; _a ++)
			{
				ioption=document.createElement("OPTION");
				ioption.setAttribute("value",_a);
				ioption.text=" "+ _a +" ";
				tinput7.add(ioption);
			}
		}
		tinscol7.appendChild(tinput7);
	
		
		changeColorNew(tinput7);
		
		if (<%=(!_ALLOW_MARK_MODIFY || ArrayOptFind(_lock_fields, "This == 'staffrating_plan'" ) != undefined)%>)
			paintPetrified(tinput4);
		if (<%=(!_ALLOW_MARK_MODIFY || ArrayOptFind(_lock_fields, "This == 'staffrating_fact'" ) != undefined)%>)
			paintPetrified(tinput6);
		if (<%=(!_ALLOW_MARK_MODIFY || ArrayOptFind(_lock_fields, "This == 'staffrating_mark'" ) != undefined)%>)
			paintPetrified(tinput7);
<%
	}
		else
	{
%>

	switch (parseInt(objtype))
	{
	case 3:
	
	tinscol4.insertAdjacentHTML('beforeEnd',"<input type='TEXT' onKeyPress='return checkkey();' style='width: 200px' id='i_plan_"+n+"_"+id+"' name='i_plan_"+n+"_"+id+"' class='inputEdit' onChange='changeColor();' onBlur='check_swear_calc(this,\"i_fact_"+n+"_"+id+"\",\"\",\"\",0, \"i_mark_"+n+"_"+id+"\");' <%=(ArrayOptFind(_lock_fields, "This == 'staffrating_plan'" ) == undefined ? "" : "readonly")%>/>");
	
	changeColorNew(document.getElementById("i_plan_"+n+"_"+id));
	
	if (<%=(ArrayOptFind(_lock_fields, "This == 'staffrating_plan'" ) != undefined)%>)
		paintPetrified(document.getElementById("i_plan_"+n+"_"+id));
	
	tinscol6.insertAdjacentHTML('beforeEnd',"<input type='TEXT' onKeyPress='return checkkey();' style='width: 200px' id='i_fact_"+n+"_"+id+"' name='i_fact_"+n+"_"+id+"' class='inputEdit' onChange='changeColor();' onBlur='check_swear_calc(this,\"i_plan_"+n+"_"+id+"\",\"\",\"\",1, \"i_mark_"+n+"_"+id+"\");' <%=(ArrayOptFind(_lock_fields, "This == 'staffrating_fact'" ) == undefined ? "" : "readonly")%>/>");
	
	changeColorNew(document.getElementById("i_fact_"+n+"_"+id));
	if (<%=(!_ALLOW_MARK_MODIFY || ArrayOptFind(_lock_fields, "This == 'staffrating_fact'" ) != undefined)%>)
		paintPetrified(document.getElementById("i_fact_"+n+"_"+id));
	
	var tinput7=document.createElement("INPUT");
	tinput7.setAttribute("type","Text");
	tinput7.readOnly = true;
	tinput7.className="inputEdit";
	tinput7.style.width="50px";
	tinput7.setAttribute("id","i_mark_"+n+"_"+id);
	tinput7.setAttribute("name","i_mark_"+n+"_"+id);
	tinscol7.appendChild(tinput7);
	changeColorNew(tinput7);
	if (<%=(!_ALLOW_MARK_MODIFY || ArrayOptFind(_lock_fields, "This != 'staffrating_mark'" ) == undefined)%>)
		paintPetrified(tinput7);
	
	
	
		break;
	case 2:
		var tinput4=document.createElement("TEXTAREA");
		tinput4.className="commonTextarea";
		tinput4.style.width="200px";
		tinput4.setAttribute("id","i_plan_"+n+"_"+id);
		tinput4.setAttribute("name","i_plan_"+n+"_"+id);
		$(tinput4).change(changeColor);
		tinput4.readOnly=<%=(ArrayOptFind(_lock_fields, "This == 'staffrating_plan'" ) != undefined)%>;
		tinscol4.appendChild(tinput4);
		changeColorNew(tinput4);
		if (<%=(ArrayOptFind(_lock_fields, "This == 'staffrating_plan'" ) != undefined)%>)
			paintPetrified(tinput4);
		
		var tinput6=document.createElement("TEXTAREA");
		tinput6.className="commonTextarea";
		tinput6.style.width="200px";
		tinput6.readOnly=<%=(!_ALLOW_MARK_MODIFY || ArrayOptFind(_lock_fields, "This == 'staffrating_fact'" ) != undefined)%>;
		tinput6.setAttribute("id","i_fact_"+n+"_"+id);
		tinput6.setAttribute("name","i_fact_"+n+"_"+id);
		$(tinput6).change(changeColor);
		tinscol6.appendChild(tinput6);
		changeColorNew(tinput6);
		if (<%=(!_ALLOW_MARK_MODIFY || ArrayOptFind(_lock_fields, "This == 'staffrating_fact'" ) != undefined)%>)
			paintPetrified(tinput6);
	
	//tinscol7.insertAdjacentHTML('beforeEnd','<input type="text" id="i_mark_'+n+'_'+id +'" name="i_mark_'+n+'_'+id +'" value=""  style="width: 50px" class="inputEdit" readonly><div id="i_marktext_'+n+'_'+id +'" name="i_marktext_'+n+'_'+id +'" style="display: none"></div><input type="button" id="i_markbutton_'+n+'_'+id +'" name="i_markbutton_'+n+'_'+id +'" value="..." style="width: 20px ; height: 20px" class="Beauty_button" onClick=\'showSelectionDialog("i_mark_'+n+'_'+id +'", "i_marktext_'+n+'_'+id +'");\' <%=(_ALLOW_MARK_MODIFY && ArrayOptFind(_lock_fields, "This == 'staffrating_fact'" ) == undefined ? "" : "disabled")%>>');
	
	var tinput7=document.createElement("SELECT");
	tinput7.setAttribute("id","i_mark_"+n+"_"+id);
	tinput7.setAttribute("name","i_mark_"+n+"_"+id);
	tinput7.style.width="90%";
	tinput7.disabled=<%=(!_ALLOW_MARK_MODIFY || ArrayOptFind(_lock_fields, "This == 'staffrating_mark'" ) != undefined)%>;
	 var ioption=document.createElement("OPTION");
	 
	 tinput7.readOnly = tinput7.disabled;
	 
	 ioption.setAttribute("value","");
	 ioption.text='';
	tinput7.add(ioption);
	
	<%
			_sell_vals = String(_scale_string).split(";");
			for (_selv in _sell_vals )
			{
				if (StrContains(_selv, "|"))
				{
					_selv = String(_selv).split("|");
					
					try
					{
						_cur_mark=Real(_selv[1]);
					}
					catch(_zhi_)
					{
						continue
					}
					
	%>
		ioption=document.createElement("OPTION");
		ioption.setAttribute("value","<%=_cur_mark%>");
		ioption.text='<%=HtmlEncode(_selv[0])%>'; 
		tinput7.add(ioption);
	<%
				}
			}
	%>
	
	tinscol7.appendChild(tinput7);
	
	changeColorNew(document.getElementById("i_mark_"+n+"_"+id));
	if (<%=(!_ALLOW_MARK_MODIFY || ArrayOptFind(_lock_fields, "This == 'staffrating_fact'" ) != undefined)%>)
		paintPetrified(document.getElementById("i_mark_"+n+"_"+id));
	
		break;
	case 1:
		var tinput4=document.createElement("TEXTAREA");
		tinput4.className="commonTextarea";
		tinput4.style.width="200px";
		tinput4.setAttribute("id","i_plan_"+n+"_"+id);
		tinput4.setAttribute("name","i_plan_"+n+"_"+id);
		tinput4.readOnly=<%=(ArrayOptFind(_lock_fields, "This == 'staffrating_plan'" ) != undefined)%>;
		$(tinput4).change(changeColor);
		tinscol4.appendChild(tinput4);
		changeColorNew(tinput4);
		if (<%=(ArrayOptFind(_lock_fields, "This == 'staffrating_plan'" ) != undefined)%>)
			paintPetrified(tinput4);
		
		var tinput6=document.createElement("TEXTAREA");
		tinput6.className="commonTextarea";
		tinput6.style.width="200px";
		tinput6.setAttribute("id","i_fact_"+n+"_"+id);
		tinput6.setAttribute("name","i_fact_"+n+"_"+id);
		tinput6.readOnly=<%=(!_ALLOW_MARK_MODIFY || ArrayOptFind(_lock_fields, "This == 'staffrating_fact'" ) != undefined)%>;
		$(tinput6).change(changeColor);
		tinscol6.appendChild(tinput6);
		changeColorNew(tinput6);
		if (<%=(!_ALLOW_MARK_MODIFY || ArrayOptFind(_lock_fields, "This == 'staffrating_fact'" ) != undefined)%>)
			paintPetrified(tinput6);
	
		var tinput7=document.createElement("INPUT");
		tinput7.setAttribute("type","Text");
		tinput7.className="inputEdit";
		tinput7.style.width="50px";
		tinput7.readOnly=<%=(!_ALLOW_MARK_MODIFY || ArrayOptFind(_lock_fields, "This == 'staffrating_mark'" ) != undefined)%>;
		tinput7.setAttribute("id","i_mark_"+n+"_"+id);
		tinput7.setAttribute("name","i_mark_"+n+"_"+id);
		$(tinput7).change(changeColor);
		$(tinput7).keypress(checkkey);
		tinscol7.appendChild(tinput7);
		changeColorNew(tinput7);
		if (<%=(!_ALLOW_MARK_MODIFY || ArrayOptFind(_lock_fields, "This == 'staffrating_mark'" ) != undefined)%>)
			paintPetrified(tinput7);
	
		break;
	}
	
<%
	}
%>	
	
	<!-- * buttons * -->
	 var tcol8=document.createElement("TD");
	tcol8.setAttribute("align","center");
	tcol8.colSpan=1;
	tcol8.setAttribute("id","td8_"+n+"_"+id);
	tcol8.setAttribute("name","td8_"+n+"_"+id);
	var tinscol8=trow.appendChild(tcol8);
	
	var tinput2_1=document.createElement("INPUT");
	tinput2_1.setAttribute("type","hidden");
	tinput2_1.className="semiVisibleField";
	tinput2_1.setAttribute("id","i_scaletype_"+n+"_"+id);
	tinput2_1.setAttribute("name","i_scaletype_"+n+"_"+id);
	tinput2_1.value=objtype;
	tinscol8.appendChild(tinput2_1);
	
	var tinput8=document.createElement("INPUT");
	tinput8.setAttribute("type","BUTTON");
	tinput8.className="inputButton";
	tinput8.setAttribute("id","del"+n+"_"+id);
	tinput8.setAttribute("name","del"+n+"_"+id);
	tinput8.setAttribute("value","x");
	tinput8.disabled=<%=(ArrayOptFind(_lock_fields, "This == 'staffrating_add_subobjective'" ) != undefined)%>;
	$(tinput8).click(function(){delSubTarget(tinput8)});
	$(tinput8).mouseover(function(){this.className='inputButtonOver';});
	$(tinput8).mouseout(function(){this.className='inputButton';});
	tinscol8.appendChild(tinput8);



	if ( trow_main.getAttribute("subobjectives") )
	{
		if (trow_main.getAttribute("subobjectives") != "") 
			trow_main.setAttribute("subobjectives",(parseInt(trow_main.getAttribute("subobjectives")) + 1));
	}
	else trow_main.setAttribute("subobjectives",1);
}
//-----------------------------------------------------------------------------------------------------
function delSubTarget(srcElement)
{
	var code=srcElement.getAttribute('name');
	var tobj=document.getElementById("userbodytable");
	if (code) code=code.substring(3,code.length);
	
	var id=code.substring(code.indexOf("_") + 1,code.length);
	var n=code.substring(0,code.indexOf("_"));
	
	var rowspan=parseInt(document.getElementById("td1_0"+"_"+id).rowSpan) - 1;
	
	document.getElementById("td1_0"+"_"+id).rowSpan=rowspan;
	document.getElementById("td2_0"+"_"+id).rowSpan=rowspan;
	document.getElementById("td3_0"+"_"+id).rowSpan=rowspan;
	<%
		//----------- WORKFLOW-FIELDS ---------------- //
			for (_wf in workflow_fields)
			if (_wf.major)
			{
				_extra_identifier = "extra_" + _wf.field.name + "$";
	%>
	document.getElementById("td_<%=(_extra_identifier)%>" + 0 + "_"+id).rowSpan = rowspan;
	<%
			}
	%>
	
	tobj.deleteRow(document.getElementById("line"+n +"_" + id).rowIndex);
	
	n++;
}

//---------------------------------------------------------------------------------------

function deleteTarget(srcElement)
{
	var id=srcElement.getAttribute('name');
		var tobj=document.getElementById("userbodytable");
		if (id) id=parseInt(id.substring(5,id.length));
	
	
	var i=0;
	
	var subobjs=0;
	if (document.getElementById("line"+ i +"_" + id).getAttribute("subobjectives")) if (document.getElementById("line"+ i +"_" + id).getAttribute("subobjectives") != "") subobjs=parseInt(document.getElementById("line"+ i +"_" + id).getAttribute("subobjectives"));
	
	<%
		if(_ranking == null)
		{
	%>
	
	tobj.deleteRow(document.getElementById("linex_" + id).rowIndex);
	
	<%
		}
	%>
	
	//while (document.getElementById("line"+ i +"_" + id))
	
	for (i=0; i<=subobjs; i++)
	if (document.getElementById("line"+ i +"_" + id))
	{
	tobj.deleteRow(document.getElementById("line"+i +"_" + id).rowIndex);
	//i++;
	}
	
	//document.getElementById("tcounter").value=(parseInt(document.getElementById("tcounter").value) - 1);
	
	for (x=id; x<=parseInt(document.getElementById("tcounter").value) ; x++)
	{	
		o=document.getElementById("td1_0_"+x);
		if(o) o.innerHTML=parseInt(o.innerHTML) - 1;
	
	}

}

//---------------------------------------------------------
function flashPetrified()
{
var id=1;
var i=0;

var tcounter=0;
if (document.getElementById("tcounter").value!="") tcounter=parseInt(document.getElementById("tcounter").value);

for (id=0; id<=tcounter; id++)
if (document.getElementById("line"+ i +"_" + id))
{
target=document.getElementById("i_name_"+ i +"_" + id);
if (target.readOnly==true) paintPetrified(target);

target=document.getElementById("i_weight_"+ i +"_" + id);
if (target.readOnly==true) paintPetrified(target);

target=document.getElementById("i_mark_"+ i +"_" + id);
if (target)
	if (target.readOnly==true) paintPetrified(target);

var subobjs=0;
if (document.getElementById("line"+ i +"_" + id).getAttribute("subobjectives")) if (document.getElementById("line"+ i +"_" + id).getAttribute("subobjectives") != "") subobjs=parseInt(document.getElementById("line"+ i +"_" + id).getAttribute("subobjectives"));

for (i=1; i<=subobjs; i++)
if (document.getElementById("line"+ i +"_" + id))
	{

		target=document.getElementById("i_plan_"+ i +"_" + id);
		if (target.readOnly==true) paintPetrified(target);
	
		target=document.getElementById("pcal"+ i +"_" + id);
		if (target.style.display=="none") paintPetrified(document.getElementById("i_period_"+ i +"_" + id));
	
		target=document.getElementById("i_fact_"+ i +"_" + id);
		if (target.readOnly==true) paintPetrified(target);
	
		if (document.getElementById("i_scaletype_"+ i +"_" + id).value!="1")
		{		
			target=document.getElementById("i_mark_"+ i +"_" + id);
			if (target.readOnly==true) paintPetrified(target);
		}
	}
i=0;
}
}

//------------------------------------------------------------------------------------------

function update_marks(o_id, _x)
{
	var subobjs=0;
	var i = 0;
if (document.getElementById("line"+ i +"_" + o_id).getAttribute("subobjectives")) if (document.getElementById("line"+ i +"_" + o_id).getAttribute("subobjectives") != "") subobjs=parseInt(document.getElementById("line"+ i +"_" + o_id).getAttribute("subobjectives"));
	var o;	
	for (i=1; i<=subobjs; i++)
	{
		o = document.getElementById("i_mark_"+ i +"_" + o_id);
		if (o)
		{
			for(var _a = o.options.length - 1; _a >= 0; _a--)
			{
				o.options.remove(0);
			}
									
			for (var _a = 0 - _x; _a <= _x; _a++)
			{
				var ioption=document.createElement("OPTION");
				ioption.setAttribute("value",_a);
				ioption.text=" "+ _a +" ";
				o.add(ioption);
			}
		}
	}
	
	update_status_bar();
	
}
//------------------------------------------------------------------------------------------
function update_status_bar()
{
		var _rank = 0;
		var _res = 0;
		var o ;
		
		var tcounter=0;
		if (document.getElementById("tcounter").value!="") tcounter=parseInt(document.getElementById("tcounter").value);
		var _i = 0;
		for (var lid=0; lid<=tcounter; lid++)
		if (document.getElementById("line"+ _i +"_" + lid))
		{
			o = document.getElementById("i_weight_"+ i +"_" + lid);
			if (o && o.value != "")
			{
				_rank+= parseInt(o.value);
			}
			
			var subobjs=0;
			if (document.getElementById("line"+ _i +"_" + lid).getAttribute("subobjectives")) if (document.getElementById("line"+ _i +"_" + lid).getAttribute("subobjectives") != "") subobjs=parseInt(document.getElementById("line"+ _i +"_" + lid).getAttribute("subobjectives"));

			for (_i=1; _i<=subobjs; _i++)
			{				
				o = document.getElementById("i_mark_"+ _i +"_" + lid);
				if (o && o.value != "")
				{
					_res+= parseInt(o.value);
				}
			}
			_i = 0;
		}
		
		document.getElementById("td2_x_x").innerHTML = _rank;
		document.getElementById("td7_x_x").innerHTML = _res;
}

//--------------------------------------------------------------------------------------------

function calculateMarks()
{

	var id=1;
	var i=0;
	var n=0.0;
	
	var result=0.0;
	var target;
	var weight=0;
	var tmp;
	var flag_nullify=0;
	
	var tcounter=0;
	if (document.getElementById("tcounter").value!="") tcounter=parseInt(document.getElementById("tcounter").value);
	
	for (id=0; id<=tcounter; id++)
		if (document.getElementById("line"+ i +"_" + id))
		{
			result=0;
			target=document.getElementById("i_mark_"+ i +"_" + id);
			
			if (target)
			{
			
			if (document.getElementById("i_weight_"+ i +"_" + id).value=="") weight=0.0;
			else weight=parseFloat(document.getElementById("i_weight_"+ i +"_" + id).value);
			
			var subobjs=0;
			if (document.getElementById("line"+ i +"_" + id).getAttribute("subobjectives")) if (document.getElementById("line"+ i +"_" + id).getAttribute("subobjectives") != "") subobjs=parseInt(document.getElementById("line"+ i +"_" + id).getAttribute("subobjectives"));
			
			n = 0.0;
			for (i=1; i<=subobjs; i++)
			if (document.getElementById("line"+ i +"_" + id))
			{
				tmp=document.getElementById("i_mark_"+ i +"_" + id);
				
				if (tmp.value!="")
				{
					weight=100;
					result+=weight*parseFloat(tmp.value) / (100);
					if (parseFloat(tmp.value)==0) flag_nullify=1;
					n = n + 1.0;
				}
				else if (!tmp.readOnly)
				{
					flag_nullify=1;
				}
			}
			if (n > 0) {result=result / n}
									
			if (flag_nullify==1) target.value=0; else target.value=result.toFixed(2);
			
			flag_nullify=0;
			}
			
			i=0;
		}
}

<%
	}
%>

//---------------------------------------------------------

function paintPetrified(src)
{
	if(src) src.style.backgroundColor="darkgray";
}
//------------------------------------------------------------------------------------------

function restoreRedFaces(holder_name)
{
	var holder=document.getElementById(holder_name);
	if (holder)
		{
		var aval=holder.value.split("@");
		for(i=0; i<aval.length; i++)
			{
				if (document.getElementById(aval[i])) changeColorNew(document.getElementById(aval[i]));
			}
		}
}
//------------------------------------------------------------------------------------------
<%
	if (!_submit_script_hide)
	{
%>


function What2submit()
{

<%
	if (curAssessmentAppraise.is_comment_required)
	{
%>
		if (document.getElementById("comment") && document.getElementById("comment").tagName.toLowerCase() == "textarea")
			if (document.getElementById("comment").value == "")
			{
				window.alert("<%=HtmlEncode(tools.get_web_str("ass_message_please_fill_in_comment"))%>");
				return false;
			}
<%
	}
	
	if (_proj_show)
	{
%>
calculateMarks();
<%
	}
%>
var all_ids="" , all_types="",  all_names="",  all_weights="", all_plans="" , all_periods="", all_facts="" , all_marks="";
var all_identifiers="", all_scaletypes="";
var all_wfinfo="", all_wfvalues="";

var m_flags="";

var totalweight=0.0;

var id=1;
var i=0;

var save_id=1;
var save_i=0;

var skip_flag=0;


var tmp="";
var censor=document.forms.f_switch.isflawed;
censor.value="";

var whoFailed="";

//while (document.getElementById("line"+ i +"_" + id))
var tcounter=0;
if (document.getElementById("tcounter") != undefined) if (document.getElementById("tcounter").value!="") tcounter=parseInt(document.getElementById("tcounter").value);

for (id=0; id<=tcounter; id++)
if (document.getElementById("line"+ i +"_" + id))
{
if (all_ids=="") all_ids+=save_id + "_" + save_i; else all_ids+="^"+ save_id + "_" + save_i;
all_types+="1^";
tmp=document.getElementById("i_name_"+ i +"_" + id).value;
if (tmp=="" && <%=_ALLOW_PLAN_MODIFY%>) {censor.value="1"; whoFailed+="<%=tools.get_web_str("vsb_no_name_of_purpose")%> " + id + "\n";}
all_names+= tmp + "^";
if (document.getElementById("i_name_"+ i +"_" + id).flag) if (document.getElementById("i_name_"+ i +"_" + id).flag=="m") m_flags+="i_name_"+ save_i +"_" + save_id + "@";


all_scaletypes+="-1^";
tmp=document.getElementById("i_identifier_"+ i +"_" + id).value;
all_identifiers+= tmp + "^";

tmp=document.getElementById("i_weight_"+ i +"_" + id).value;
if (tmp=="")
	{
	 	if (<%=(_ALLOW_PLAN_MODIFY && _weight_hide != "none")%>) {censor.value="1"; whoFailed+="<%=tools.get_web_str("vsb_no_weight_of_purpose")%> " + id + "\n";}
		var saveweight=0;
	}
	else
	{
		totalweight+=parseInt(tmp);
		var saveweight=parseInt(tmp); // /100.0;
		if (saveweight == 0 && "<%=_weight_hide%>" != "none" ) {alert("<%=tools.get_web_str("vsb_mess1_part1")%> " + id + " <%=tools.get_web_str("vsb_mess1_part2")%> "); censor.value="1";}
	}

all_weights+= saveweight + "^";
if (document.getElementById("i_weight_"+ i +"_" + id).flag) if (document.getElementById("i_weight_"+ i +"_" + id).flag=="m") m_flags+="i_weight_"+ save_i +"_" + save_id + "@";

all_plans+="0^";
all_periods+="0^";
all_facts+="0^";

if (document.getElementById("i_mark_"+ i +"_" + id))
{
tmp=document.getElementById("i_mark_"+ i +"_" + id).value;
if (tmp != "") {tmp=parseFloat(tmp) / 1;}
	else if (tmp=="" && <%=(_ALLOW_MARK_MODIFY && _ranking != null && _mark_hide != "none")%> ) {censor.value="1"; whoFailed+="<%=tools.get_web_str("vsb_zero_result_of_purpose")%> " + id + "?\n";}

if (document.getElementById("i_mark_"+ i +"_" + id).flag) if (document.getElementById("i_mark_"+ i +"_" + id).flag=="m") m_flags+="i_mark_"+ save_i +"_" + save_id + "@";
}
else
{
	tmp = " ";
}
all_marks+= tmp + "^";


<%
	if (ArrayCount(workflow_fields) > 0)
	{
		for (_wf in workflow_fields)
		if (_wf.major)
		{
			_extra_identifier = "extra_" + _wf.field.name + "$";
%>
		if (document.getElementById("i_name_<%=_extra_identifier%>" + i + "_" + id))
		{
			all_wfinfo+="<%=_wf.field.name%>$$$$<%=_wf.field.field_group_id%>$$$$<%=_wf.field.type%>$$$$<%=(HtmlEncode(_wf.field.title))%>&|&";
			all_wfvalues+=document.getElementById("i_value_<%=_extra_identifier%>" + i + "_" + id).value + "&|&";
			
			if (document.getElementById("i_value_<%=_extra_identifier%>" + i + "_" + id).flag) if (document.getElementById("i_value_<%=_extra_identifier%>" + i + "_" + id).flag=="m") m_flags+="i_value_<%=_extra_identifier%>" + save_i + "_" + save_id + "@";
			
		}
<%
		}
%>
		all_wfinfo+="^";
		all_wfvalues+="^";
<%
		
	}
%>

//while (document.getElementById("line"+ i +"_" + id))	
var subobjs=0;
if (document.getElementById("line"+ i +"_" + id).getAttribute("subobjectives")) if (document.getElementById("line"+ i +"_" + id).getAttribute("subobjectives") != "") subobjs=parseInt(document.getElementById("line"+ i +"_" + id).getAttribute("subobjectives"));
//i++;
save_i++;
for (i=1; i<=subobjs; i++)
if (document.getElementById("line"+ i +"_" + id))
	{
		all_ids+="^"+ save_id + "_" + save_i;
		all_types+="0^";
		all_names+="^";

		tmp=document.getElementById("i_scaletype_"+ i +"_" + id).value;
		all_scaletypes+= tmp + "^";

		all_identifiers+= "0^";

		all_weights+="^";

		tmp=document.getElementById("i_plan_"+ i +"_" + id).value;

		if (tmp=="" && <%=_ALLOW_PLAN_MODIFY%>) {censor.value="1"; whoFailed+="<%=tools.get_web_str("vsb_mess2_part1")%> " + i + "  <%=tools.get_web_str("vsb_mess2_part2")%> " + id + "\n";}

		all_plans+=tmp + "^";

		tmp=document.getElementById("i_period_"+ i +"_" + id).value;

		if (tmp=="" && <%=_ALLOW_PLAN_MODIFY%>) {censor.value="1"; whoFailed+="<%=tools.get_web_str("vsb_mess3_part1")%> " + i + "  <%=tools.get_web_str("vsb_mess2_part2")%> " + id + "\n";}

		all_periods+=tmp + "^";

		tmp=document.getElementById("i_fact_"+ i +"_" + id).value;
		if (document.getElementById("i_fact_"+ i +"_" + id).readOnly==true) skip_flag=1; else skip_flag=0;

		if (tmp=="" && <%=_ALLOW_MARK_MODIFY%> && skip_flag != 1) {censor.value="1"; whoFailed+="<%=tools.get_web_str("vsb_mess4_part1")%> " + i + "  <%=tools.get_web_str("vsb_mess2_part2")%> " + id + "\n";}

		all_facts+= tmp + "^";

		
<%
	if (ArrayCount(workflow_fields) > 0)
	{
		for (_wf in workflow_fields)
		if (!_wf.major)
		{
			_extra_identifier = "extra_" + _wf.field.name + "$";
%>
		if (document.getElementById("i_name_<%=_extra_identifier%>" + i + "_" + id))
		{
			all_wfinfo+="<%=_wf.field.name%>$$$$<%=_wf.field.field_group_id%>$$$$<%=_wf.field.type%>$$$$<%=(HtmlEncode(_wf.field.title))%>&|&";
			all_wfvalues+=document.getElementById("i_value_<%=_extra_identifier%>" + i + "_" + id).value + "&|&";
			
			if (document.getElementById("i_value_<%=_extra_identifier%>" + i + "_" + id).flag) if (document.getElementById("i_value_<%=_extra_identifier%>" + i + "_" + id).flag=="m") m_flags+="i_value_<%=_extra_identifier%>" + save_i + "_" + save_id + "@";
			
		}
<%
		}
%>
		all_wfinfo+="^";
		all_wfvalues+="^";
<%
		
	}
%>

tmp=document.getElementById("i_mark_"+ i +"_" + id).value;

if (tmp!="" & tmp!="0") {tmp=parseFloat(tmp) / 1;}

		if (tmp=="" && <%=(_ALLOW_MARK_MODIFY && _mark_hide != "none")%> && skip_flag!=1) {censor.value="1"; whoFailed+="<%=tools.get_web_str("vsb_mess5_part1")%> " + i + "  <%=tools.get_web_str("vsb_mess2_part2")%> " + id + "\n";}

		all_marks+= tmp + "^";
if (document.getElementById("i_plan_"+ i +"_" + id).flag) if (document.getElementById("i_plan_"+ i +"_" + id).flag=="m") m_flags+="i_plan_"+ save_i +"_" + save_id + "@";
if (document.getElementById("i_fact_"+ i +"_" + id).flag) if (document.getElementById("i_fact_"+ i +"_" + id).flag=="m") m_flags+="i_fact_"+ save_i +"_" + save_id + "@";	
if (document.getElementById("i_mark_"+ i +"_" + id).flag) if (document.getElementById("i_mark_"+ i +"_" + id).flag=="m") m_flags+="i_mark_"+ save_i +"_" + save_id + "@";


if (document.getElementById("i_period_"+ i +"_" + id).flag) if (document.getElementById("i_period_"+ i +"_" + id).flag=="m") m_flags+="i_period_"+ save_i +"_" + save_id + "@";

		save_i++;
		//i++;
	}
	save_i=0;
	save_id++;
	i=0;
	//id++;
}

var frm=document.forms.f_switch;

//if (document.getElementById("isflawed").value=="1") {censor.value="1"; whoFailed+="Flawed, ";}
//alert(whoFailed);

n = 0;
var stqObj;
while (document.all["stq_id_" + n] != undefined)
{
	stqObj = $("#supplementary_table input[name='stq_requered_" + n+"']");
	if (stqObj.val() == "1")
	{
		stqObj = $("#supplementary_table [name='stq_mark_"+n+"']");
		if (stqObj.length > 0)
		{
			if (stqObj.val() == "")
			{
				whoFailed+="<%=tools.get_web_str("vsb_mess6_part1")%> " + (n+1) + " <%=tools.get_web_str("vsb_mess6_part2")%>\n";
				censor.value = "1";
			}
		}
		else
		{
			stqObj = $("#supplementary_table input[parent_id='stq_mark_" + n+"']");
			if (stqObj.length > 0)
			{
				if (stqObj.filter(":checked").length == 0)
				{
					whoFailed+="<%=tools.get_web_str("vsb_mess6_part1")%> " + (n+1) + " <%=tools.get_web_str("vsb_mess6_part2")%>\n";
					censor.value = "1";
				}
			}
		}
	}
	n++;
}

if (censor.value=="1") {
	//alert("whoFailed:\n" + whoFailed);
	if(!confirm("<%=tools.get_web_str("vrb_message2")%> <%=tools.get_web_str("ass_question_save")%>\n\n" + whoFailed)) {return false;}

}


if (totalweight != 100 && <%=(_ranking == null && _weight_hide != "none" && _proj_show)%>) {
		//alert("<%=tools.get_web_str("vsb_mess7")%>"); 	
	censor.value="1";
	if(!confirm("<%=tools.get_web_str("vsb_mess7")%> <%=tools.get_web_str("ass_question_save")%>")) {return false;}

}


var hidin=document.createElement('INPUT'); hidin.type='hidden'; hidin.name='field_ids';
hidin.value=all_ids;
var hidinins = frm.appendChild(hidin);

var hidin=document.createElement('INPUT'); hidin.type='hidden'; hidin.name='field_i_types';
hidin.value=all_types;
var hidinins = frm.appendChild(hidin);

var hidin=document.createElement('INPUT'); hidin.type='hidden'; hidin.name='field_i_names';
hidin.value=all_names;
var hidinins = frm.appendChild(hidin);


var hidin=document.createElement('INPUT'); hidin.type='hidden'; hidin.name='field_i_scaletypes';
hidin.value=all_scaletypes;
var hidinins = frm.appendChild(hidin);

var hidin=document.createElement('INPUT'); hidin.type='hidden'; hidin.name='field_i_identifiers';
hidin.value=all_identifiers;
var hidinins = frm.appendChild(hidin);




var hidin=document.createElement('INPUT'); hidin.type='hidden'; hidin.name='field_i_weights';
hidin.value=all_weights;
var hidinins = frm.appendChild(hidin);

var hidin=document.createElement('INPUT'); hidin.type='hidden'; hidin.name='field_i_plans';
hidin.value=all_plans;
var hidinins = frm.appendChild(hidin);

var hidin=document.createElement('INPUT'); hidin.type='hidden'; hidin.name='field_i_periods';
hidin.value=all_periods;
var hidinins = frm.appendChild(hidin);

var hidin=document.createElement('INPUT'); hidin.type='hidden'; hidin.name='field_i_facts';
hidin.value=all_facts;
var hidinins = frm.appendChild(hidin);

var hidin=document.createElement('INPUT'); hidin.type='hidden'; hidin.name='field_i_marks';
hidin.value=all_marks;
var hidinins = frm.appendChild(hidin);

var hidin=document.createElement('INPUT'); hidin.type='hidden'; hidin.name='field_i_wfinfo';
hidin.value=all_wfinfo;
var hidinins = frm.appendChild(hidin);

var hidin=document.createElement('INPUT'); hidin.type='hidden'; hidin.name='field_i_wfvalues';
hidin.value=all_wfvalues;
var hidinins = frm.appendChild(hidin);


var hidin=document.createElement('INPUT'); hidin.type='hidden'; hidin.name='field_modified_list'; hidin.id='field_modified_list';
hidin.value=m_flags;
var hidinins = frm.appendChild(hidin);

return true;

}
<%
	}
%>

//------------------------------------------------------------------------------------------------
function MM_jumpMenu(targ,selObj,restore){ //v3.0
  eval(targ+".location='"+selObj.options[selObj.selectedIndex].value+"'");
  if (restore) selObj.selectedIndex=0;
}

function MM_findObj(n, d) { //v4.01
  var p,i,x;  if(!d) d=document; if((p=n.indexOf("?"))>0&&parent.frames.length) {
    d=parent.frames[n.substring(p+1)].document; n=n.substring(0,p);}
  if(!(x=d[n])&&d.all) x=d.all[n]; for (i=0;!x&&i<d.forms.length;i++) x=d.forms[i][n];
  for(i=0;!x&&d.layers&&i<d.layers.length;i++) x=MM_findObj(n,d.layers[i].document);
  if(!x && d.getElementById) x=d.getElementById(n); return x;
}

function MM_jumpMenuGo(selName,targ,restore){ //v3.0
  var selObj = MM_findObj(selName); if (selObj) MM_jumpMenu(targ,selObj,restore);
}
//------------------------------------------------------------------------------------------------

function buildselect(s_name, identifier)
{	
	var selector=document.getElementById(s_name);

/*var xmlpa=new ActiveXObject("Msxml.DOMDocument");
	xmlpa.setProperty("SelectionLanguage","XPath");
xmlpa.async = false;

var url="staffrating_objectives.xml?identifier=" + identifier + "&assessment_appraise_id=<%=curAssessmentAppraiseID%>&boss_id=<%=curPersonID%>&show_me=translated";
xmlpa.load(url);*/

/*var xmlpa=CreateDOMDocument();
//xmlpa.setProperty("SelectionLanguage","XPath");
xmlpa.async = false;
var url="staffrating_objectives.xml?identifier=" + identifier + "&assessment_appraise_id=<%=curAssessmentAppraiseID%>&boss_id=<%=curPersonID%>&show_me=translated";
xmlpa.load(url)*/
	var params="identifier=" + identifier + "&assessment_appraise_id=<%=curAssessmentAppraiseID%>&boss_id=<%=curPersonID%>&show_me=translated";
	ajax.post("staffrating_objectives.xml","",params,"xml", onResult);
	function onResult(result)
	{
		var seloptions=result.selectNodes('.//objective_translate');
		
		 var ioption;
		 var page="";
		var doc_id="";
		
		
		if (seloptions.length > 0)
			{
			selector.innerHTML="";	
			for (i=0; i<seloptions.length ; i++)
				{
					var ioption=document.createElement("OPTION");
					var pa_id=seloptions[i].getAttribute("pa_id");
					if (pa_id == "")
							ioption.setAttribute("value","#" );
					else
							ioption.setAttribute("value","view_doc.html?mode=assessment_appraise&assessment_appraise_id=<%=curAssessmentAppraiseID%>&pa_id=" + pa_id + "&doc_id=<%=curDocID%>");
						 ioption.text=seloptions[i].getAttribute("recepient"); 
						selector.options.add(ioption);
				}
			}		
	}
}


<%
	if (_flag_translate)
	{
%>		

//-------------------------------------------------------------------------------------------------

function translate(srcobj)
{
	//var srcobj = event.srcElement;
	
	var id=srcobj.getAttribute('name');
	if (id) id=(id.substring(8,id.length));

	var stAttr="status:no;dialogWidth:700px;dialogHeight:600px;help:no";

	var parobj=new Object();
	
	parobj.name=document.getElementById("i_name_" + id).value;
	parobj.identifier=document.getElementById("i_identifier_" + id).value;

	xShowModalDialog("dlg_staffrating_translate_objective.html?assessment_appraise_id=<%=curAssessmentAppraiseID%>&identifier="+parobj.identifier+"&pa_id=<%=curPAID%>&rand="+ Math.random() , parobj, stAttr);

	//alert(parobj.amount);

	buildselect("transfered_urls_"+id, parobj.identifier);
}

//---------------------------------------------------------------------------------------------

function bind(srcobj)
{
		
	var id=srcobj.getAttribute('name');
	if (id) id=(id.substring(7,id.length));

	var stAttr="status:no;dialogWidth:700px;dialogHeight:600px;help:no";

	var parobj=new Object();
	
	parobj.name=document.getElementById("i_name_" + id).value;
	parobj.identifier=document.getElementById("i_identifier_" + id).value;

	xShowModalDialog("dlg_staffrating_translate_objective.html?assessment_appraise_id=<%=curAssessmentAppraiseID%>&identifier="+parobj.identifier+"&bind=1&pa_id=<%=curPAID%>&rand="+ Math.random() , parobj, stAttr);

	if (parobj.victims != undefined)
	{
		document.getElementById("td_bind_name_"+id).innerHTML=unescape(parobj.victims) + "&nbsp;";
	}
	
//alert(parobj.amount);

}

<%
	}
%>


function checkFocus() 
{ 
	if (window.navigator.appVersion.indexOf("MSIE")==-1) 
	{ 
		if (modalWin!=null && !modalWin.closed) 
		{ 
			self.blur(); 
			modalWin.focus(); 
		} 
	} 
}
//*************************************************************************************************


function check_swear_calc(source, companion_name, min, max, nominator, dest_name)
{
		if (source.value!="")
	{
		source.value=parseFloat(source.value);
		if (isNaN(source.value)) source.value=0;
		if (max!="") if (parseFloat(source.value)>parseFloat(max)) alert("<%=tools_web.get_web_str("vkb_message1")%>");
		if (min!="") if (parseFloat(source.value)<parseFloat(min)) alert("<%=tools_web.get_web_str("vkb_message2")%>");
		if (document.getElementById(companion_name) && document.getElementById(dest_name))
		{
			if (document.getElementById(companion_name).value != "")
			{
				var compval=document.getElementById(companion_name).value;
				if (isNaN(compval)) document.getElementById(companion_name).value=0;
				if  ((nominator == 1 && parseFloat(document.getElementById(companion_name).value) > 0 ) || (nominator==0 && parseFloat(source.value) > 0)   )	
				{
					if (nominator == 1)
					var TO_4TO_OCTALOCb = parseFloat(source.value) / parseFloat(document.getElementById(companion_name).value);
					else
					var TO_4TO_OCTALOCb = parseFloat(document.getElementById(companion_name).value) / parseFloat(source.value);
	
					TO_4TO_OCTALOCb=(TO_4TO_OCTALOCb*100);
					TO_4TO_OCTALOCb=TO_4TO_OCTALOCb.toFixed(2);
					document.getElementById(dest_name).value=TO_4TO_OCTALOCb;
					
				}
				else document.getElementById(dest_name).value="";
			
			}
		}
	
	}
}

-->
</script>


<%
	if (ArrayOptFind(_hide_fields, "This == 'translate_info'") == undefined)
	{
		_query = 'for $objective_translate in objective_translates where $objective_translate/assessment_appraise_id = ' + curAssessmentAppraiseID + ' and $objective_translate/recipient_person_id = ' + curPersonID + ' return $objective_translate';
		
		_objective_translates = XQuery( _query );
		
		if (ArrayCount(_objective_translates))
		{
%>

<b><%=tools.get_web_str("vsb_translations")%>:</b>
<table>
<%
		for (_ot in _objective_translates)
		{
			if (curPA.objectives.GetOptChildByKey(_ot.recipient_objective_id) != undefined)
				_font_color = "green";
			else
				_font_color = "red";
			
			_tranComment = OpenDoc(UrlFromDocID(_ot.PrimaryKey)).TopElem.comment + "";
%>
			<tr>
				<td width="200px" class="newsColumnDigest"><b><%=_ot.translator_person_id.ForeignElem.fullname%></b></td>
				<td width="30px" class="newsColumnDigest"><%=tools.get_web_str("vsb_purpose")%>:</td>
				<td class="newsColumnDigest"><font color="<%=_font_color%>"><%=_ot.translator_objective_name%></font></td>
				<td width="30px" class="newsColumnDigest">&nbsp;
<%
			if(_tranComment != "")
			{
%>
				<a href="#" onclick="window.alert('<%=HtmlEncode(_tranComment)%>'); return false;"><img src="pics/1.gif" border="0"/></a>
<%
			}
%>
				</td>
			</tr>
<%
		}
%>

</table>

<%
		}
	}
	_self_pa = null;
	_manager_pa = null;

	try
	{
		if (curPA.status == 'manager' || curPA.status == 'interview')
		{
			_temp_self_pa = ArrayFirstElem(XQuery( 'for $pa in pas where $pa/assessment_appraise_id = ' + curAssessmentAppraiseID + (IS_HUMAN ? ' and $pa/person_id = ' + curPA.person_id : ' and $pa/department_id = ' + curPA.department_id) + ' and $pa/status = \'self\' and $pa/assessment_appraise_type = \'' + curPA.assessment_appraise_type + '\' return $pa' ));

			_self_pa = OpenDoc( UrlFromDocID( _temp_self_pa.id ) ).TopElem;

			if (curPA.status == 'interview')
			{
				_temp_manager_pa = ArrayFirstElem(XQuery( 'for $pa in pas where $pa/assessment_appraise_id = ' + curAssessmentAppraiseID + (IS_HUMAN ? ' and $pa/person_id = ' + curPA.person_id : ' and $pa/department_id = ' + curPA.department_id) + ' and $pa/status = \'manager\' and $pa/assessment_appraise_type = \'' + curPA.assessment_appraise_type + '\' return $pa' ));

			_manager_pa = OpenDoc( UrlFromDocID( _temp_manager_pa .id ) ).TopElem;
			}
		}		
	}
	catch(_uuuublin_)
	{
		//alert(_uuuublin_);
	}
	
	sourcePA = curPA;
				
	if (!curPA.flag_is_processed)
	{
		if (curPA.status == 'manager')
		{
			if (_self_pa != null) sourcePA = _self_pa;
		}
		else if (curPA.status == 'interview')
		{
			if (_manager_pa != null) sourcePA = _manager_pa;
		}	
	
	}
%>

					<form action='staffrating_save.html' name='f_switch' id='f_switch' method="POST">
					<p>

					<input type="hidden" name="doc_id" value="<%=curDocID%>"/>

					<input type=hidden name="assessment_appraise_id" value="<%=curAssessmentAppraiseID%>"/>
					<input type=hidden name="is_post" value="1"/>
					<input type=hidden name="pa_id" value="<%=curPAID%>"/>
					<input type=hidden name="isflawed" value=""/>
					<input type=hidden name="assessment_appraise_type" value="<%=Request.QueryString.assessment_appraise_type%>"/>

					<input type="hidden" name="tcounter" id="tcounter" value="<%=ArrayCount(sourcePA.objectives)%>"/>

					<input type="hidden" id="modified_list" name="modified_list" value="<%=curPA.temp%>" style="width: 600px"/>

					<input type="hidden" id="workflow_fields_count" name="workflow_fields_count" value="<%=ArrayCount(workflow_fields)%>"/>
				
<%
	if (_cur_assessment_appraise_type != undefined)
	{
		try
		{
			Response.Write(tools_web.insert_custom_code(_cur_assessment_appraise_type.custom_web_template_id, null,true,false));
		}
		catch(_oi_)
		{}
		
		if(_cur_assessment_appraise_type.custom_post_web_template_id.HasValue)
		{
%>
			<input type="hidden" name="custom_post_web_template_id" value="<%=_cur_assessment_appraise_type.custom_post_web_template_id%>"/>
<%
		}
	}

	if (_proj_show)
	{
%>
<table cellpadding="5" cellspacing="0" border="1" class="tableBorder" style="border-collapse:collapse; border-style:solid;" width="100%">
	<TBODY id="userbodytable">
	<tr id="tr_000">
		<td rowspan="2" class="tableHeaderWithText">¹</td>
		<td rowspan="2" class="tableHeaderWithText"><%=tools.get_web_str("vsb_purposes")%></td>
		<td rowspan="2" class="tableHeaderWithText" style="display: <%=_weight_hide%>"><%=(_ranking != null ? tools.get_web_str("vsb_rank_of_purpose") : tools.get_web_str("vsb_weight_factor"))%></td>
	<%
			for (_wf in workflow_fields)
			{
				if (_wf.major)
				{
	%>
				<td align="center" rowspan="2" class=""><%=_wf.field.title%></td>
	<%
				}
			}
	%>
				
		<td colspan="<%=(4 + ArrayCount(ArraySelect(workflow_fields, "major == false")) - (_mark_hide == "none" ? 1 : 0))%>" class="tableHeaderWithText"><%=tools.get_web_str("vsb_control_points")%></td>
		<td rowspan="2" class="tableHeaderWithText"><%=tools.get_web_str("c_delete")%></td>
	</tr>
	
	<tr>
		<%
			if (_ranking != null)
			{
		%>
			<td align="center" class="tableHeaderWithText"><%=tools.get_web_str("vsb_criterion_of_purpose")%></td>
			<td align="center" class="tableHeaderWithText"><%=tools.get_web_str("vsb_term_of_performance")%></td>
			<td align="center" class="tableHeaderWithText"><%=tools.get_web_str("vsb_reached_result")%></td>
			
			<%
				for (_wf in workflow_fields)
				if (_wf.major == false)
				{
			%>
					<td align="center" class="tableHeaderWithText"><%=_wf.field.title%></td>
			<%
				}
			%>
			
			<td align="center" class="tableHeaderWithText"><%=tools.get_web_str("vsb_actual_result")%></td>
		<%
			}
			else
			{
		%>
			<td align="center" class="tableHeaderWithText"><%=tools.get_web_str("vsb_expected_result")%></td>
			<td align="center" class="tableHeaderWithText"><%=tools.get_web_str("vsb_term_of_performance")%></td>
			<td align="center" class="tableHeaderWithText"><%=tools.get_web_str("vsb_actual_result")%></td>
			
			<%
				for (_wf in workflow_fields)
				if (_wf.major == false)
				{
			%>
					<td align="center" class="tableHeaderWithText"><%=_wf.field.title%></td>
			<%
				}
			%>
			
			<td align="center" class="tableHeaderWithText" style="display: <%=_mark_hide%>"><%=tools.get_web_str("vsb_estimation_in_control_point")%></td>
		<%
			}
		%>
	</tr>
	
	<%
		for (_objective in sourcePA.objectives)
		{
			_objective_id = _objective.ChildIndex + 1;
			_rowspan = ArrayCount(_objective.subobjectives) + (_ranking == null ? 2 : 1) - (_mark_hide == "none" ? 1 : 0);	
	%>	
		
			<tr id="line0_<%=_objective_id%>" subobjectives="<%=ArrayCount(_objective.subobjectives)%>" bgcolor="whitesmoke">
			
		
			<td id="td1_0_<%=_objective_id%>" name="td1_0_<%=_objective_id%>" align="center" rowspan="<%=_rowspan%>"> <%=_objective_id%> </td>
			<td id="td2_0_<%=_objective_id%>" name="td2_0_<%=_objective_id%>" align="center" valign="top" rowspan="<%=_rowspan%>">
				<table cellpadding="0" cellspacing="0">
					<tr><td colspan="2">
						<textarea style="width: 300px" rows="5" id="i_name_0_<%=_objective_id%>" name="i_name_0_<%=_objective_id%>" class="commonTextarea" onChange="changeColor();" <%=(_ALLOW_PLAN_MODIFY && ArrayOptFind(_lock_fields, "This == 'staffrating_objective'" ) == undefined ? "" : "readonly")%>><%=_objective.name%></textarea>
						<input type="hidden" id="i_identifier_0_<%=_objective_id%>" name="i_identifier_0_<%=_objective_id%>" value="<%=_objective.PrimaryKey%>"/>
					</td></tr>
					<tr><td colspan="2" align="center">
						<hr/>
					</td></tr>
		<%
		
	if (_flag_translate)
	{
		
			if (_ALLOW_PLAN_MODIFY)
			{
		%>
					<tr><td colspan="2" align="center">
						<input type="button" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';" value="<%=tools.get_web_str("vsb_translate")%>" id="transbut0_<%=_objective_id%>" name="transbut0_<%=_objective_id%>" onclick="translate(this)"/>
					</td></tr>
		<%
			}
		%>
					<tr><td width="100%">
						<select name="transfered_urls_0_<%=_objective_id%>" id="transfered_urls_0_<%=_objective_id%>" class="personalMenu">
							<option value='#'> <%=tools.get_web_str("vsb_translations_does_not_exist")%> </option>
						</select>
					</td><td>
  <input type="button" name="transfered_urls_but_0_<%=_objective_id%>" id="transfered_urls_but_0_<%=_objective_id%>" value="&nbsp;&gt;&nbsp;" onClick="MM_jumpMenuGo('transfered_urls_0_<%=_objective_id%>','document',0)" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';" style="display:none"/>
					</td></tr>
					<tr><td colspan="2" align="center">
						<hr/>
					</td></tr>
		<%
			if (_ALLOW_PLAN_MODIFY)
			{
		%>
					<tr><td colspan="2" align="center">
						<input type="button" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';" value="<%=tools_web.get_web_str("vsb_connect")%>" id="bindbut0_<%=_objective_id%>" name="bindbut0_<%=_objective_id%>" onclick="bind(this)"/>
					</td></tr>
		<%
			}
		%>
					<tr><td colspan="2" align="center" id="td_bind_name_0_<%=_objective_id%>" name="td_bind_name_0_<%=_objective_id%>">
		<%
						_res = XQuery(('for $objective_translate in objective_translates where $objective_translate/assessment_appraise_id = ' + curAssessmentAppraiseID + ' and $objective_translate/recipient_objective_id = \'' + _objective.PrimaryKey + '\' and $objective_translate/recipient_person_id = ' + curPersonID + ' return $objective_translate'));
						
						if (ArrayCount(_res) > 0)
						{
							Response.Write(_res[0].translator_person_id.ForeignElem.fullname);
						}
		%>						
					</td></tr>
	
		<%
	}
		%>
					
				</table>
				<script>buildselect('transfered_urls_0_<%=_objective_id%>', '<%=_objective.PrimaryKey%>');</script>
			</td>
			
			<td id="td3_0_<%=_objective_id%>" name="td3_0_<%=_objective_id%>" align="center" valign="top" rowspan="<%=_rowspan%>" style="display: <%=_weight_hide%>" >
<%
	if (_ranking != null)
	{
		if(_ALLOW_PLAN_MODIFY)
		{
%>
		<select id="i_weight_0_<%=_objective_id%>" name="i_weight_0_<%=_objective_id%>" onchange="update_marks(<%=_objective_id%>, this.value)" <%=(_ALLOW_PLAN_MODIFY && ArrayOptFind(_lock_fields, "This == 'staffrating_weight'" ) == undefined ? "" : "readonly")%>>
<%
		for( x=0; x<=_ranking ;x++)
		{
			if (x + '' != _objective.weight + '')
				Response.Write('<option value="' + x + '">' + x + '</option>')
			else
				Response.Write('<option selected value="' + x + '">' + x + '</option>')
		}
%>
		</select>
<%
		}
		else
		{
%>
			<input type="text" style="width: 50px" id="i_weight_0_<%=_objective_id%>" name="i_weight_0_<%=_objective_id%>" class="inputEdit" value="<%=_objective.weight%>" readonly/>
<%		
		}
	}
	else
	{
%>

		 <input type="text" style="width: 50px" id="i_weight_0_<%=_objective_id%>" name="i_weight_0_<%=_objective_id%>" value="<%=_objective.weight%>" onKeyPress="return checkkeyInt();" class="inputEdit" onChange="changeColor();" <%=(_ALLOW_PLAN_MODIFY && ArrayOptFind(_lock_fields, "This == 'staffrating_weight'" ) == undefined ? "" : "readonly")%>/>
<%
	}
%>
			</td>

<%
		//----------- WORKFLOW-FIELDS ---------------- //
			for (_wf in workflow_fields)
			{
				if (_wf.major)
				{
					_extra_identifier = "extra_" + _wf.field.name + "$" + 0 + "_" + _objective_id;
%>
				<td id="td_<%=(_extra_identifier)%>" name="td_<%=(_extra_identifier)%>" align="center" valign="top" rowspan="<%=_rowspan%>">
					<input TYPE="hidden" id="i_name_<%=(_extra_identifier)%>" name="i_<%=(_extra_identifier)%>" value="<%=(_wf.field.name)%>"/>
										
<%
						_curwf = _objective.workflow_fields.ObtainChildByKey(_wf.field.name);
						
						if (_wf.is_modify)
						{
							switch (_wf.field.type)
							{
								case "string":
									_RESP_VAL = '<input TYPE="text" style="width: 300px" class="inputEdit" onChange="changeColor();" id="i_value_' + _extra_identifier + '" name="i_value_' + _extra_identifier + '" value="' + HtmlEncode(_curwf.value) + '"/>';
									break;
								case "integer":
									_RESP_VAL = '<input TYPE="text" style="width: 60px" class="inputEdit" onChange="changeColor();" id="i_value_' + _extra_identifier + '" name="i_value_' + _extra_identifier + '" value="' + HtmlEncode(_curwf.value) + '" onKeyPress="return checkkeyInt();"/>';
									break;
								case "real":
									_RESP_VAL = '<input TYPE="text" style="width: 60px" class="inputEdit" onChange="changeColor();" id="i_value_' + _extra_identifier + '" name="i_value_' + _extra_identifier + '" value="' + HtmlEncode(_curwf.value) + '" onKeyPress="return checkkey();"/>';
									break;
								case "date":
									_RESP_VAL = '<input type="text" style="width: 70px" id="i_value_' + _extra_identifier + '" name="i_value_' + _extra_identifier + '"  value="' + _curwf.value + '" class="inputEdit" onChange="changeColor();" readonly><a href="#"  tn="i_value_' + _extra_identifier + '" onClick="var h=0; var offP = this.offsetParent; while(offP.id != \'main_block\' && offP.tagName.toUpperCase()!=\'BODY\') {h+=offP.offsetTop; offP = offP.offsetParent;} ; showCalendar(this, document.getElementById(\'i_value_' + _extra_identifier + '\'), \'dd.mm.yyyy\',\'ru\',1, null, h + 40); changeColorNew(document.getElementById(\'i_value_' + _extra_identifier + '\')); return false;" id="cal' + _extra_identifier + '" name="cal' + _extra_identifier + '"><img src="scripts/calendar/calendar.gif" width="24" height="22" border="0" align="absmiddle" /></a>';
									break;
								case "bool":
									_RESP_VAL = '<input type="checkbox" style="width: 15px" id="i_value_' + _extra_identifier + '" name="i_value_' + _extra_identifier + '" value="' + _curwf.value + '" onclick="if (this.checked) this.value=1; else this.value=0;" ' + (Trim(_curwf.value) == "1" ? "checked" : "") + '/>';
									break;
								case "combo":
									_RESP_VAL = '<select onChange="changeColor();" id="i_value_' + _extra_identifier + '" name="i_value_' + _extra_identifier + '"><option value="">&nbsp;</option>';
									for (_ent in _wf.field.entries)
                                    {
                                    	_reload_val = HtmlEncode(_ent.value);
                                        if (StrBegins(_reload_val , "@"))
                                        {
                                        	_reload_val = String(_reload_val).slice(1);
                                            _reload_val =_reload_val.split("[]");
											
                                            _drill_response = drill_select(Array(), null, _reload_val, 0);
                                            for (_dr in _drill_response)
                                            {
                                            	if (HtmlEncode(_dr) == _curwf.value)
                                                    _RESP_VAL = _RESP_VAL + '<option value="' + HtmlEncode(_dr) + '" selected>' + HtmlEncode(_dr) + '</option>';
                                                else
                                                    _RESP_VAL = _RESP_VAL + '<option value="' + HtmlEncode(_dr) + '">' + HtmlEncode(_dr) + '</option>';
                                            }
                                        }
                                        else
                                        {
                                        if (_reload_val == _curwf.value)
                                            _RESP_VAL = _RESP_VAL + '<option value="' + _reload_val + '" selected>' + _reload_val + '</option>';
                                        else
                                            _RESP_VAL = _RESP_VAL + '<option value="' + _reload_val + '">' + _reload_val + '</option>';
                                        }
                                    }
									_RESP_VAL = _RESP_VAL + '</select>';
									break;
								default:
									_RESP_VAL = '<textarea id="i_value_' + _extra_identifier + '" name="i_value_' + _extra_identifier + '" class="commonTextarea" onChange="changeColor();">' + _curwf.value + '</textarea>';
									break;
							}
							Response.Write(_RESP_VAL);
						}
						else
						{
%>
							<input TYPE="hidden" id="i_value_<%=(_extra_identifier)%>" name="i_value_<%=(_extra_identifier)%>" value="<%=(_curwf.value)%>"/><%=(_curwf.value)%>
<%
						}
%>
				</td>
<%
				}
			}
			//----------- -------- ---------------- //
%>	

			<td id="td4_0_<%=_objective_id%>" name="td4_0_<%=_objective_id%>" colspan="<%=(4 + ArrayCount(ArraySelect(workflow_fields, "major == false")) - (_mark_hide == "none" ? 1 : 0 ) )%>">
			<table width="100%"><tr>
			<td align="left">
<%
	if (ArrayOptFind(_lock_fields, "This == 'staffrating_add_subobjective'" ) == undefined)
	{
%>
				<input type="button" class="inputButton" id="add0_<%=_objective_id%>" name="add0_<%=_objective_id%>" value="<%=(_ranking != null ? tools.get_web_str("vsb_add_criterion_of_purpose") : tools.get_web_str("vsb_add_expected_result"))%>" onClick="addSubTarget(this);" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';" <%=(_ALLOW_PLAN_MODIFY ? "" : "disabled")%>/>&nbsp;
<%
	}
%>
			</td>
			</tr></table>
			</td>

			<td id="td8_0_<%=_objective_id%>" name="td8_0_<%=_objective_id%>" align="center">
				<input type="button" class="inputButton" id="but0_<%=_objective_id%>" name="but0_<%=_objective_id%>" value="X" onClick="deleteTarget(this);" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';" <%=(_ALLOW_DELETE && ArrayOptFind(_lock_fields, "This == 'staffrating_add_objective'" ) == undefined ? "" : "disabled")%>/>
			</td>	
			</tr>
	
	<%
		for (_subobjective in _objective.subobjectives)
		{
			_subobjective_id = _subobjective.ChildIndex + 1;
			
			if (_force_mark_open)
				_open_mark_edit = true;
			else
			{
				_open_mark_edit = false;
							
				if (USE_MATRIX)
				{
					if ( _ALLOW_MARK_MODIFY && PERIOD != undefined && _subobjective.date.HasValue )
					{
						if (_subobjective.date >= PERIOD.start_time && _subobjective.date <= PERIOD.end_time)
						{
							_open_mark_edit = true;
						}
					}
				}
				else
					_open_mark_edit = _ALLOW_MARK_MODIFY;
			}
	%>
			
		<tr id="line<%=(_subobjective_id + "_" + _objective_id)%>" bgcolor="whitesmoke">
		

			<td id="td4_<%=(_subobjective_id + "_" + _objective_id)%>" name="td4_<%=(_subobjective_id + "_" + _objective_id)%>" align="center" valign="top">
<%
			if (_scale_type != 3)
            {
%>
				<textarea style="width: 200px" id="i_plan_<%=(_subobjective_id + "_" + _objective_id)%>" name="i_plan_<%=(_subobjective_id + "_" + _objective_id)%>" class="commonTextarea" onChange="changeColor();" <%=((_ALLOW_PLAN_MODIFY && (_subobjective.mark.HasValue == false || USE_MATRIX == false) || (IS_MODIFY && _force_plan_open)) && ArrayOptFind(_lock_fields, "This == 'staffrating_plan'" ) == undefined ? "" : "readonly")%>><%=_subobjective.plan%></textarea>
<%
			}
            else
            {
%>
				<input type='TEXT' onKeyPress='return checkkey();' style='width: 200px' value='<%=_subobjective.plan%>' id='i_plan_<%=(_subobjective_id + "_" + _objective_id)%>' name='i_plan_<%=(_subobjective_id + "_" + _objective_id)%>' class='inputEdit' onChange='changeColor();' onBlur='check_swear_calc(this,"i_fact_<%=(_subobjective_id + "_" + _objective_id)%>","","",0, "i_mark_<%=(_subobjective_id + "_" + _objective_id)%>");' <%=((_ALLOW_PLAN_MODIFY && (_subobjective.mark.HasValue == false || USE_MATRIX == false) || (IS_MODIFY && _force_plan_open)) && ArrayOptFind(_lock_fields, "This == 'staffrating_plan'" ) == undefined ? "" : "readonly")%>/>

<%
			}
%>
			</td>
			
			<td id="td5_<%=(_subobjective_id + "_" + _objective_id)%>" name="td5_<%=(_subobjective_id + "_" + _objective_id)%>" align="center" valign="middle">
				<input type="text" style="width: 70px" id="i_period_<%=(_subobjective_id + '_' + _objective_id)%>" name="i_period_<%=(_subobjective_id + "_" + _objective_id)%>"  value="<%=_subobjective.date%>" class="inputEdit" onChange="changeColor();" readonly><a href='#' style="<%=((_ALLOW_PLAN_MODIFY && (_subobjective.mark.HasValue == false || USE_MATRIX == false) || (IS_MODIFY && _force_plan_open))&& ArrayOptFind(_lock_fields, "This == 'staffrating_period'" ) == undefined ? "" : "display:none")%>" tn='i_period_<%=(_subobjective_id + "_" + _objective_id)%>' onClick='var h=0; var offP = this.offsetParent; while(offP.id != "main_block" && offP.tagName.toUpperCase()!="BODY") {h+=offP.offsetTop; offP = offP.offsetParent;} ; showCalendar(this, document.getElementById("i_period_<%=(_subobjective_id + '_' + _objective_id)%>"), "dd.mm.yyyy","ru",1, null, h + 40); changeColorNew(document.getElementById("i_period_<%=(_subobjective_id + '_' + _objective_id)%>")); return false;' id='pcal<%=(_subobjective_id + "_" + _objective_id)%>' name='pcal<%=(_subobjective_id + '_' + _objective_id)%>'><img src='scripts/calendar/calendar.gif' width="24" height="22" border="0" align="absmiddle" /></a>
			</td>
	
	
	
	
			<td id="td6_<%=(_subobjective_id + "_" + _objective_id)%>" name="td6_<%=(_subobjective_id + "_" + _objective_id)%>" align="center" valign="top">
<%
			if (_scale_type != 3)
            {
%>	 
				<textarea style="width: 200px" id="i_fact_<%=(_subobjective_id + "_" + _objective_id)%>" name="i_fact_<%=(_subobjective_id + "_" + _objective_id)%>" class="commonTextarea" onChange="changeColor();" <%=(_open_mark_edit && ArrayOptFind(_lock_fields, "This == 'staffrating_fact'" ) == undefined ? "" : "readonly")%>><%=_subobjective.fact%></textarea>
                      
<%
			}
            else
            {
%>
				<input type='TEXT' onKeyPress='return checkkey();' style='width: 200px' value='<%=_subobjective.fact%>' id='i_fact_<%=(_subobjective_id + "_" + _objective_id)%>' name='i_fact_<%=(_subobjective_id + "_" + _objective_id)%>' class='inputEdit' onChange='changeColor();' onBlur='check_swear_calc(this,"i_plan_<%=(_subobjective_id + "_" + _objective_id)%>","","",1, "i_mark_<%=(_subobjective_id + "_" + _objective_id)%>");' <%=(_open_mark_edit && ArrayOptFind(_lock_fields, "This == 'staffrating_fact'" ) == undefined ? "" : "readonly")%>/>
<%
			}
%>
			</td>

	
<%
		//----------- WORKFLOW-FIELDS ---------------- //
			for (_wf in workflow_fields)
			{
				if (!_wf.major)
				{
					_extra_identifier = "extra_" + _wf.field.name + "$" + _subobjective_id + "_" + _objective_id;
%>
				<td id="td_<%=(_extra_identifier)%>" name="td_<%=(_extra_identifier)%>" align="center" valign="top">
					<input TYPE="hidden" id="i_name_<%=(_extra_identifier)%>" name="i_<%=(_extra_identifier)%>" value="<%=(_wf.field.name)%>"/>
										
<%
						_curwf = _subobjective.workflow_fields.ObtainChildByKey(_wf.field.name);
						
						if (_wf.is_modify)
						{
							switch (_wf.field.type)
							{
								case "string":
									_RESP_VAL = '<input TYPE="text" style="width: 300px" class="inputEdit" onChange="changeColor();" id="i_value_' + _extra_identifier + '" name="i_value_' + _extra_identifier + '" value="' + HtmlEncode(_curwf.value) + '"/>';
									break;
								case "integer":
									_RESP_VAL = '<input TYPE="text" style="width: 60px" class="inputEdit" onChange="changeColor();" id="i_value_' + _extra_identifier + '" name="i_value_' + _extra_identifier + '" value="' + HtmlEncode(_curwf.value) + '" onKeyPress="return checkkeyInt();"/>';
									break;
								case "real":
									_RESP_VAL = '<input TYPE="text" style="width: 60px" class="inputEdit" onChange="changeColor();" id="i_value_' + _extra_identifier + '" name="i_value_' + _extra_identifier + '" value="' + HtmlEncode(_curwf.value) + '" onKeyPress="return checkkey();"/>';
									break;
								case "date":
									_RESP_VAL = '<input type="text" style="width: 70px" id="i_value_' + _extra_identifier + '" name="i_value_' + _extra_identifier + '"  value="' + _curwf.value + '" class="inputEdit" onChange="changeColor();" readonly><a href="#"  tn="i_value_' + _extra_identifier + '" onClick="var h=0; var offP = this.offsetParent; while(offP.id != \'main_block\' && offP.tagName.toUpperCase()!=\'BODY\') {h+=offP.offsetTop; offP = offP.offsetParent;} ; showCalendar(this, document.getElementById(\'i_value_' + _extra_identifier + '\'), \'dd.mm.yyyy\',\'ru\',1, null, h + 40); changeColorNew(document.getElementById(\'i_value_' + _extra_identifier + '\')); return false;" id="cal' + _extra_identifier + '" name="cal' + _extra_identifier + '"><img src="/scripts/calendar/calendar.gif" width="24" height="22" border="0" align="absmiddle" /></a>';
									break;
								case "bool":
									_RESP_VAL = '<input type="checkbox" style="width: 15px" id="i_value_' + _extra_identifier + '" name="i_value_' + _extra_identifier + '" value="' + _curwf.value + '" onclick="if (this.checked) this.value=1; else this.value=0;" ' + (Trim(_curwf.value) == "1" ? "checked" : "") + '/>';
									break;
								case "combo":
									_RESP_VAL = '<select onChange="changeColor();" id="i_value_' + _extra_identifier + '" name="i_value_' + _extra_identifier + '"><option value="">&nbsp;</option>';
                                    
									for (_ent in _wf.field.entries)
                                    {
                                    	_reload_val = HtmlEncode(_ent.value);
                                        if (StrBegins(_reload_val , "@"))
                                        {
                                        	_reload_val = String(_reload_val).slice(1);
                                            _reload_val =_reload_val.split("[]");
											
                                            _drill_response = drill_select(Array(), null, _reload_val, 0);
                                            for (_dr in _drill_response)
                                            {
                                            	if (HtmlEncode(_dr) == _curwf.value)
                                                    _RESP_VAL = _RESP_VAL + '<option value="' + HtmlEncode(_dr) + '" selected>' + HtmlEncode(_dr) + '</option>';
                                                else
                                                    _RESP_VAL = _RESP_VAL + '<option value="' + HtmlEncode(_dr) + '">' + HtmlEncode(_dr) + '</option>';
                                            }
                                        }
                                        else
                                        {
                                        if (_reload_val == _curwf.value)
                                            _RESP_VAL = _RESP_VAL + '<option value="' + _reload_val + '" selected>' + _reload_val + '</option>';
                                        else
                                            _RESP_VAL = _RESP_VAL + '<option value="' + _reload_val + '">' + _reload_val + '</option>';
                                        }
                                    }
                                    _RESP_VAL = _RESP_VAL + '</select>';
									break;
								default:
									_RESP_VAL = '<textarea id="i_value_' + _extra_identifier + '" name="i_value_' + _extra_identifier + '" class="commonTextarea" onChange="changeColor();">' + _curwf.value + '</textarea>';
									break;
							}
							Response.Write(_RESP_VAL);
						}
						else
						{
%>
							<input TYPE="hidden" id="i_value_<%=(_extra_identifier)%>" name="i_value_<%=(_extra_identifier)%>" value="<%=(_curwf.value)%>"/><%=(_curwf.value)%>
<%
						}
%>
				</td>
<%
				}
			}
			//----------- -------- ---------------- //
%>	
	
			<td id="td7_<%=(_subobjective_id + "_" + _objective_id)%>" name="td7_<%=(_subobjective_id + "_" + _objective_id)%>" align="center" style="display: <%=_mark_hide%>">
			
<%
	if (_ranking != null)
	{
		if(_open_mark_edit)
		{
%>		
	<select id="i_mark_<%=(_subobjective_id + "_" + _objective_id)%>" name="i_mark_<%=(_subobjective_id + "_" + _objective_id)%>" <%=((_open_mark_edit) && ArrayOptFind(_lock_fields, "This == 'staffrating_mark'" ) == undefined ? "" : "readonly")%> onchange="update_status_bar(); changeColor();">
	<option value=""> </option>
<%
	if(_objective.weight.HasValue && _objective.weight <= _ranking)		
	{
		for( x=0 - _objective.weight;x<=_objective.weight;x++)
		{
			if (StrReal(x, 0) != StrReal(_subobjective.mark, 0))
				Response.Write('<option value="' + StrReal(x, 0) + '">' + StrReal(x, 0) + '</option>')
			else
				Response.Write('<option selected value="' + StrReal(x, 0) + '">' + StrReal(x, 0) + '</option>')
		}
	
	}
%>
	</select>

<%
		}
		else
		{
%>
			<input type="text" style="width: 50px" id="i_mark_<%=(_subobjective_id + "_" + _objective_id)%>" name="i_mark_<%=(_subobjective_id + "_" + _objective_id)%>" value="<%=_subobjective.mark%>" class="inputEdit" readonly/>
<%
		}
	}
	else
	{
    
    	switch (_scale_type)
        {
    		case 1:
%>

						<input type="text" style="width: 50px" id="i_mark_<%=(_subobjective_id + "_" + _objective_id)%>" name="i_mark_<%=(_subobjective_id + "_" + _objective_id)%>" value="<%=_subobjective.mark%>" onKeyPress="return checkkey();" class="inputEdit" onChange="changeColor(); calculateMarks();" <%=((_open_mark_edit) && ArrayOptFind(_lock_fields, "This == 'staffrating_mark'" ) == undefined ? "" : "readonly")%>/>


<%			break;
			case 2:
%>
			<select id="i_mark_<%=(_subobjective_id + "_" + _objective_id)%>" name="i_mark_<%=(_subobjective_id + "_" + _objective_id)%>" <%=((_open_mark_edit) && ArrayOptFind(_lock_fields, "This == 'staffrating_mark'" ) == undefined ? "" : "disabled")%> onchange="changeColor();" style="width: 90%">
	<option value=""> </option>
<%

		_sell_vals = String(_scale_string).split(";");
		for (_selv in _sell_vals )
		{            
			if (StrContains(_selv, "|"))
			{
				_selv = String(_selv).split("|");
                
                try
                {
                    _cur_mark=Real(_selv[1]);
                }
                catch(_zhi_)
                {
                    continue
                }
                
				Response.Write('<option ' + (_cur_mark == _subobjective.mark ? "selected" : "") + ' value="' + _cur_mark + '">' + _selv[0] + '</option>')
			}
        }
	
%>
	</select>

<%
            break;
            
            case 3:
%>
            	<input type="text" style="width: 50px" id="i_mark_<%=(_subobjective_id + "_" + _objective_id)%>" name="i_mark_<%=(_subobjective_id + "_" + _objective_id)%>" value="<%=_subobjective.mark%>" onKeyPress="return checkkey();" class="inputEdit" onChange="changeColor(); calculateMarks();" readonly/>
<%
            
		}
	}
%>

				<input type="hidden" id="i_scaletype_<%=(_subobjective_id + "_" + _objective_id)%>" name="i_scaletype_<%=(_subobjective_id + "_" + _objective_id)%>" value="2"/>
			</td>
	
			<td id="td8_<%=(_subobjective_id + "_" + _objective_id)%>" name="td8_<%=(_subobjective_id + "_" + _objective_id)%>" align="center">
				<input type="button" class="inputButton" id="del<%=(_subobjective_id + "_" + _objective_id)%>" name="del<%=(_subobjective_id + "_" + _objective_id)%>" value="x" onClick="delSubTarget(this);" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';" <%=(_ALLOW_DELETE && ArrayOptFind(_lock_fields, "This == 'staffrating_add_subobjective'" ) == undefined ? "" : "disabled")%>/>
			</td>
		</tr>

	<%
		}
		
		
			if ( _ranking == null)
			{
			
	%>

			<tr id="linex_<%=_objective_id%>" name="linex_<%=_objective_id%>" bgcolor="whitesmoke" height="30px" style="display: <%=_mark_hide%>">
				<td id="td1_x_<%=_objective_id%>" name="td1_x_<%=_objective_id%>" align="right" colspan="<%=(3 + ArrayCount(ArraySelect(workflow_fields, "major == false")))%>"><b><%=tools.get_web_str("ass_final_estimation")%>:</b></td>
				<td id="td7_x_<%=_objective_id%>" name="td7_x_<%=_objective_id%>" align="center" colspan="2">
					<input type="text" style="width: 80px" id="i_mark_0_<%=_objective_id%>" name="i_mark_0_<%=_objective_id%>" value="<%=_objective.mark%>" onKeyPress="return checkkey();" class="inputEdit" onChange="changeColor();" <%=(false ? "" : "readonly")%>/>
				</td>
			</tr>

	<%
			}
		}
	
	%>

	</TBODY>
	
<%
		
	if (_ranking != null || curPA.overall.HasValue)
	{		
%>	
	<tr id="linex_x" name="linex_x" height="30px" style="display: <%=_mark_hide%>">
		<td id="td1_x_x" class="tableHeaderWithText" colspan="2">&nbsp;		</td>
		<td id="td2_x_x" class="tableHeaderWithText">&nbsp;</td>
		<td id="td3_x_x" class="tableHeaderWithText" colspan="<%=(3 + ArrayCount(workflow_fields))%>">&nbsp;</td>
		<td id="td7_x_x" class="tableHeaderWithText"><%=tools.get_web_str("vsb_overall")%>&nbsp;<%=(curPA.overall.HasValue ? curPA.overall : "&nbsp;")%></td>
		<td id="td8_x_x" class="tableHeaderWithText">&nbsp;		</td>
	</tr>
<%
		if (_ranking != null)
		{
%>	
	<script language="javascript">
	<!--
		update_status_bar();
	-->
	</script>
	
	
<%
		}
	}
%>
</table>

<br />

<div name="secretArea" id="secretArea" style="text-align:center">
					
<%
						if (IS_MODIFY)
						{
							if (_ALLOW_ADD)
							{
								if (ArrayOptFind(_lock_fields, "This == 'staffrating_add_objective'" ) == undefined && ArrayOptFind(_hide_fields, "This == 'staffrating_add_objective'" ) == undefined)
								{
%>
					<input type="button" name="add_target" value="<%=tools.get_web_str("vsb_add_purpose")%>" onClick="addTarget(this);" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';"/>
					
<%
								}
								
								if (ArrayOptFind(_lock_fields, "This == 'staffrating_weight'" ) == undefined && ArrayOptFind(_hide_fields, "This == 'staffrating_weight'" ) == undefined)
								{
%>
					
					
					<input type=button name="whatthefuckisgoingon" value="<%=tools.get_web_str("vsb_make_even_weights")%>" onClick="projForceSum100(1);" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';"/>
					<input type=button name="gaddammazafakers" value="<%=tools.get_web_str("vsb_to_lead_100")%>" onClick="projForceSum100(0);" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';"/>
					
					<%
								}
							}
						}
									
	}
%>
</div>
<%
						Server.Execute('view_supplementary_questions.html');
						
						Response.Write('<hr/>');
						
						Server.Execute('view_assessment_comment.html');
					
					
						if (IS_MODIFY)
						{
					%>
						<p><center><input type="submit" <%if (!_submit_script_hide) {%>onClick='return What2submit();'<%}%> value="    <%=tools.get_web_str("c_save")%>    " class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';"/></center></p>
					<%
						}
					%>
					</form>
<%
	if (_proj_show)
	{
%>					
<script language="javascript">
	<!--
		flashPetrified();
		restoreRedFaces('modified_list');
	-->
</script>
										
<%
	}
	
	WF_FORM_TOP = 'bottom';
	Server.Execute('view_assessment_workflow_buttons.html');
	
	} // _cancel end
%>
			</td>
		</tr>
		</table>