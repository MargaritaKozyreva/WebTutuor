<%
	if ( Request.QueryString.HasProperty( 'mine' ) && Request.QueryString.mine == '1' )
		_mine = true;
	else
		_mine = false;
%>
<form name="subscription_action_delete" action="subscription_delete.html" method="post">
	<input type="hidden" name="doc_id" value="<%=curDocID%>"/>
	<input type="hidden" name="subscription_id" id="subscription_id" value=""/>
	<input type="hidden" name="sid" value="<%=tools.get_sum_sid( curDocID )%>"/>
</form>
<table width="100%" cellspacing="0" cellpadding="4" class="tableBorder">
	<tr>		
		<td width="200" align="RIGHT">&nbsp;</td>
		<td align="LEFT"><input type="checkbox" name="mine" <%=(_mine ? 'checked=&quot;checked&quot;' : '')%> onclick="document.location.href='view_doc.html?mode=subscriptions&doc_id=<%=curDocID%>&mine='+(this.checked?'1':'0');return false;"/><%=tools.get_web_str('csubscb_disp_active')%></td>
	</tr>
</table>
<br/>

<%
	for ( _subscription_type in curLngCommon.subscription_object_types )
	{
		columnNum = ( _subscription_type.is_hier ? 4 : 3 );
%>
<table width="100%"  border="0" cellspacing="0" cellpadding="0">
<form name="subscription_action_create_<%=_subscription_type.name%>" action="subscription_create.html" method="post">
	<input type="hidden" name="doc_id" value="<%=curDocID%>"/>
	<input type="hidden" name="document_id" id="document_id_<%=_subscription_type.name%>" value=""/>
	<input type="hidden" name="sid" value="<%=tools.get_sum_sid( curDocID )%>"/>
	<input type="hidden" name="subscription_type" value="<%=_subscription_type.name%>"/>
	<tr>
		<td class="tableHeaderTextLeft"><img src="pics/1blank.gif" width="0" height="0" /></td>
		<td class="tableHeaderText" colspan="<%=columnNum%>"><p class="tableHeaderTextInner"><%=_subscription_type.title%></p></td>
		<td class="tableHeaderTextRight"><img src="pics/1blank.gif" width="0" height="0" /></td>
	</tr>
	<tr>
		<td class="tableHeaderWithTextLeft"><img src="pics/1blank.gif" width="0" height="0" /></td>
		<td class="tableHeaderWithText" width="30px">&nbsp;</td>
		<td class="tableHeaderWithText" width="100%"><%=tools.get_web_str('c_name')%></td>
<%
		if ( _subscription_type.is_hier )
		{
%>
		<td class="tableHeaderWithText" width="100px"><%=tools.get_web_str('vdb_subdocs')%></td>
<%
		}
%>
		<td class="tableHeaderWithText" width="120px">&nbsp;</td>
		<td class="tableHeaderWithTextRight"><img src="pics/1blank.gif" width="0" height="0" /></td>
	</tr>
	<tr>
		<td class="tableHeaderNoTextLeft"><img src="pics/1blank.gif" width="0" height="0" /></td>
		<td class="tableHeaderNoText" colspan="<%=columnNum%>"><img src="pics/1blank.gif" width="1" height="1" /></td>
		<td class="tableHeaderNoTextRight"><img src="pics/1blank.gif" width="0" height="0" /></td>
	</tr>	
<%
		if ( _subscription_type.name == 'forum_entry' )
		{
			elemArray = XQuery( 'for $elem in forum_entrys where $elem/parent_forum_entry_id = null() return $elem' );
			elemArray = ArraySelect( elemArray, 'fe=forum_id.OptForeignElem,fe==undefined?false:fe.permit_subscription' );
		}
		else
		{
			elemArray = XQuery( _subscription_type.name + 's' );
			firstElem = ArrayOptFirstElem( elemArray );
			if ( firstElem != undefined && firstElem.ChildExists( 'permit_subscription' ) )
				elemArray = ArraySelectByKey( elemArray, true, 'permit_subscription' );
		}

		subscriptionArray = XQuery( "for $elem in subscriptions where $elem/person_id = " + curUserID + " and $elem/type = '" + _subscription_type.name + "' return $elem" );
		elemArray = ArraySort( elemArray, _subscription_type.disp_name, '+' );

		counter = 0;
		for ( _document in elemArray )
		{
			_cur_document = ArrayOptFind( subscriptionArray, 'document_id==_document.id' );
			
			if ( _cur_document == undefined )
				if ( _mine || ! tools_web.check_access( OpenDoc( UrlFromDocID( _document.PrimaryKey ), 'form=x-local://wtv/wtv_form_doc_access.xmd;digest=1;ignore-top-elem-name=1' ).TopElem, curUserID, curUser, Session ) )
					continue;
			
			_class = counter++ % 2 ? 'tableRowEven' : 'tableRowOdd';	
			_classl = counter++ % 2 ? 'tableRowEvenLeft' : 'tableRowOddLeft';
			_classr = counter++ % 2 ? 'tableRowEvenRight' : 'tableRowOddRight';
%>
	<tr>
		<td class="<%=_classl%>"></td>
		<td class="<%=_class%>" align="center">
<%
			if ( _cur_document != undefined )
			{
%>
			<img src="pics/ok.gif" width="13" height="11"/>
<%				
			}
%>					
		</td>
		<td class="<%=_class%>"><%=_document.name%></td>
<%
			if ( _subscription_type.is_hier )
			{
%>
		<td class="<%=_class%>" align="center">
<%
				if ( _cur_document == undefined )
				{
%>
			<input type="checkbox" name="<%=_document.id%>"/>
<%			
				}
				else if ( _cur_document.include_subdocs )
				{
%>
			<img src="pics/ok.gif" width="13" height="11"/>
<%
				}
%>					
		</td>
<%
			}
%>
		<td class="<%=_class%>" align="center">
<%
			if ( _cur_document == undefined )
			{
%>
			<input type="submit" value="<%=tools.get_web_str('csubscb_subscript')%>" class="inputButton" onmouseover="this.className='inputButtonOver';" onmouseout="this.className='inputButton';" onclick="document.getElementById('document_id_<%=_subscription_type.name%>').value='<%=_document.id%>';return true;"/>
<%			
			}
			else
			{
%>
			<input type="button" value="<%=tools.get_web_str('c_delete')%>" class="inputButton" onmouseover="this.className='inputButtonOver';" onmouseout="this.className='inputButton';" onclick="document.getElementById('subscription_id').value='<%=_cur_document.id%>';document.subscription_action_delete.submit();return false;">
<%
			}
%>	
		</td>
		<td class="<%=_classr%>"></td>
	</tr>
<%
		}
%>
	<tr>
		<td class="tableFooterLeft"><img src="pics/1blank.gif" width="0" height="0" /></td>
		<td class="tableFooter" colspan="<%=columnNum%>"><img src="pics/1blank.gif" width="1" height="1" /></td>
		<td class="tableFooterRight"><img src="pics/1blank.gif" width="0" height="0" /></td>
	</tr>
</form>
</table>
<br/>
<%
	}
%>