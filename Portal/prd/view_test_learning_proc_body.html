<%
bComplite = curObject.state_id != 0 && curObject.state_id != 1;
bExpertEvalFlag = curObject.state_id == 2 && curObject.expert_eval;

_is_active = ! bExpertEvalFlag && ( ! bComplite || curObject.attempts_num > curObject.test_learnings.ChildNum ) && ( ! curObject.start_learning_date.HasValue || curObject.start_learning_date < CurDate );

if ( curObject.start_learning_date.HasValue && curObject.start_learning_date > CurDate )
{
%>
<center>
	<h4><font color="RED"><%=tools.get_web_str('c_start_learning_date')%> <%=StrDate( curObject.start_learning_date, true, false )%>. <%=tools.get_web_str('vlpb_message10')%>: <%=( ( DateToRawSeconds( curObject.start_learning_date ) - DateToRawSeconds( CurDate ) ) / 86400 )%>. <%=tools.get_web_str('vlpb_message11')%></font></h4>
</center>
<%
}
else if ( curAssessment.schedule.type != 'always' )
{
	scheduleWeekDay = ArrayOptFind( curAssessment.schedule.week_days, 'PrimaryKey.ForeignElem.index==' + WeekDay( CurDate ) );
	dateNewTime = DateNewTime( CurDate );
	if ( scheduleWeekDay == undefined || Date( dateNewTime + ' ' + scheduleWeekDay.start_time ) > CurDate || Date( dateNewTime + ' ' + scheduleWeekDay.finish_time ) < CurDate )
	{
		_is_active = false;
%>
	<center>
		<h4><font color="RED"><%=tools.get_web_str('vlpb_message11')%></font></h4>
	</center>
<%
	}
}

if ( curObject.max_end_date.HasValue )
{
	if ( curObject.max_end_date < CurDate )
	{
%>
<center>
	<H4><FONT COLOR="RED"><%=tools.get_web_str('vtlpb_message1')%><%=( ( DateToRawSeconds( CurDate ) - DateToRawSeconds( curObject.max_end_date ) ) / 86400 )%><%=tools.get_web_str('vtlpb_message2')%></FONT></H4>
</center>
<%
	}
	else
	{
		if ( _is_active )
		{
%>
<center>
	<H4><FONT COLOR="RED"><%=tools.get_web_str('vtlpb_message3')%>&nbsp;<%=( ( DateToRawSeconds( curObject.max_end_date ) - DateToRawSeconds( CurDate ) ) / 86400 )%>&nbsp;<%=tools.get_web_str('vtlpb_message2')%></FONT></H4>
</center>
<%
		}
	}
}

if ( bComplite )
{
%>
<CENTER><FONT SIZE="3"><B><%=tools.get_web_str('vtlpb_message4')%></B></FONT></CENTER>
<%
}
%>
<SCRIPT LANGUAGE="JAVASCRIPT">
var win;
var aTimer;
var courseWindow = window;

function refr()
{
	clearTimeout( aTimer );

	if( win.closed )
	{
		_href = String( document.location.href ).replace( /&object_id=/i, "&old_object_id=" );
		_href.replace( /\?object_id=/i, "?old_object_id=" );
		if ( _href.indexOf( 'start=' ) != -1 )
			_href = _href.slice( 0, _href.indexOf( 'start=' ) - 1 );

		document.location.href = _href;
		return;
	}

	aTimer = setTimeout( 'refr()', 5000 );
}

function test_launch( _width, _height )
{
	if( screen.availWidth < _width || screen.availHeight < _height )
		alert("<%=tools.get_web_str('vcplb_message1')%>");

	win = window.open( 'test_launch.html?assessment_id=<%=curAssessmentID%>&object_id=<%=curObjectID%>&sid=<%=tools.get_sum_sid( curAssessmentID )%>', 'win<%=curObjectID%>', 'toolbar=no,location=no,status=no,menubar=no,resizable=yes,directories=no,scrollbars=no,width=' + _width + ',height=' + _height );
	win.moveTo( 0, 0 );

	aTimer = setTimeout( 'refr()', 10000 );

	buttonsTd = document.getElementById('test_buttons_panel');
	if ( buttonsTd )
		buttonsTd.style.display = 'none';
}

function test_finish( bAttemptParam )
{
	if( ! confirm( <%=CodeLiteral( tools.get_web_str('vtlpb_mess_not_complete') )%> ) )
		return false;
		
	document.location.href = 'test_finish.html?object_id=<%=curObjectID%>&assessment_id=<%=curAssessmentID%>&sid=<%=tools.get_sum_sid(curObjectID)%>&move_to=<%=curAssessment.test_finish_redirect%>&attempt=' + ( bAttemptParam ? '1' : '0' );
}
</SCRIPT>




<TABLE width="100%" cellspacing="4" cellpadding="0">
	<TR>
		<TD>

		<TABLE width="100%" cellspacing="0" cellpadding="4" CLASS="tableBorder">
			<TR>
				<TD WIDTH="200" ALIGN="RIGHT"><b><%=tools.get_web_str('c_act_date')%>:</b>&nbsp;</TD>
				<TD STYLE="font-weight:normal"><%=StrDate( curObject.start_usage_date, true, false )%></TD>
			</TR>
			<TR>
				<TD WIDTH="200" ALIGN="RIGHT"><b><%=tools.get_web_str('vtlpb_last_use')%>:</b>&nbsp;</TD>
				<TD STYLE="font-weight:normal"><%=StrDate( curObject.last_usage_date, true, false )%></TD>
			</TR>
			<TR>
				<TD WIDTH="200" ALIGN="RIGHT"><b><%=tools.get_web_str('c_pass_score')%>:</b>&nbsp;</TD>
				<TD STYLE="font-weight:normal"><%=curAssessment.passing_score%></TD>
			</TR>
<%
if ( curObject.attempts_num > 1 )
{
	if ( ! curAssessment.not_display_unfinished_score )
	{
%>			
			<TR>
				<TD WIDTH="200" ALIGN="RIGHT"><b><%=tools.get_web_str('c_res_score')%>:</b>&nbsp;</TD>
				<TD STYLE="font-weight:normal"><b><%=curObject.score%></b><%=( curObject.max_score == 0 || ! curObject.max_score.HasValue ? '' : ' / ' + curObject.max_score + ' (' + StrReal( ( 100.0 * curObject.score ) / curObject.max_score, 1 ) + '%)' )%></TD>
			</TR>
<%
	}
%>
			<TR>
				<TD WIDTH="200" ALIGN="RIGHT"><b><%=tools.get_web_str('c_res_state')%>:</b>&nbsp;</TD>
				<TD STYLE="font-weight:normal"><%=curLngCommon.learning_states.GetChildByKey( curObject.state_id ).name%></TD>
			</TR>
<%
}

if ( ! curAssessment.not_display_unfinished_score )
{
%>			
			<TR>
				<TD WIDTH="200" ALIGN="RIGHT"><b><%=tools.get_web_str('c_cur_score')%>:</b>&nbsp;</TD>
				<TD STYLE="font-weight:normal"><b><%=curObject.cur_score%></b><%=( curObject.max_score == 0 || ! curObject.max_score.HasValue ? '' : ' / ' + curObject.max_score + ' (' + StrReal( ( 100.0 * curObject.cur_score ) / curObject.max_score, 1 ) + '%)' )%></TD>
			</TR>
<%
}
%>
			<TR>
				<TD WIDTH="200" ALIGN="RIGHT"><b><%=tools.get_web_str('uf_current_state')%>:</b>&nbsp;</TD>
				<TD STYLE="font-weight:normal"><%=curLngCommon.learning_states.GetChildByKey( curObject.cur_state_id ).name%></TD>
			</TR>
			<TR>
				<TD WIDTH="200" ALIGN="RIGHT"><b><%=tools.get_web_str('c_attempt_num')%>:</b>&nbsp;</TD>
				<TD STYLE="font-weight:normal"><%=curObject.test_learnings.ChildNum%>&nbsp;/&nbsp;<%=curObject.attempts_num%></TD>
			</TR>
		</TABLE>

		</TD>
	</TR>
<%
	if ( _is_active )
	{
%>
	<TR>
		<TD>

		<TABLE width="100%" border="0" cellspacing="0" cellpadding="0" class="activator">
			<TR>
				<TD id="test_buttons_panel" align="center" width=33% class="activator">
<%
		_win_width = curAssessment.win_width;//750;
		_win_height = curAssessment.win_height;//530;
		if ( curObject.state_id == 0 )
		{
%>
			<input type="button" value="<%=tools.get_web_str('vtlpb_start')%>" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';" onClick="test_launch( '<%=_win_width%>', '<%=_win_height%>' );">
<%
		}

		if ( curObject.state_id == 1 || ( curObject.state_id != 0 && curObject.attempts_num > curObject.test_learnings.ChildNum ) )
		{
%>
			<input type="button" value="<%=tools.get_web_str('vtlpb_next')%>" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';" onClick="test_launch( '<%=_win_width%>', '<%=_win_height%>' );">
<%
		}
%>
			&nbsp;&nbsp;&nbsp;
			<input type="button" value="<%=tools.get_web_str('vtlpb_stop')%>" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';" onClick="test_finish(false)">
<%

		if ( curObject.attempts_num > 1 )
		{
%>
			<input type="button" value="<%=tools.get_web_str('vtlpb_end_attempt')%>" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';" onClick="test_finish(true)">
<%
		}
%>
				</TD>
			 </TR>
		</TABLE>

		</TD>
	</TR>

<%
	}
	if ( curAssessment.display_result_report && curUserID == curObject.person_id && curObject.lesson_report != '' )
	{
%>
	<TR>
		<TD>
			<center>
				<b><a href="view_test_report.html?doc_id=<%=curDocID%>&object_id=<%=curObjectID%>" target="_blank"><%=tools.get_web_str('c_stat')%></a></b>
			</center>
		</TD>
	</TR>
<%
	}

	if ( _is_active && ( curObject.attempts_num > 1 || curObject.test_learnings.ChildNum > 0 ) )
	{
%>
	<TR>
		<TD>

		<p class="headerText" style="margin-top:10px; margin-bottom:10px;"><%=tools.get_web_str('vlpb_last_attemps')%></p>
		<table width="100%"  border="0" cellspacing="0" cellpadding="3">
			<tr>
				<td class="tableHeaderWithText"><%=tools.get_web_str('c_date')%></td>
				<td class="tableHeaderWithText" WIDTH="120"><%=tools.get_web_str('c_score')%></td>
				<td class="tableHeaderWithText" WIDTH="120"><%=tools.get_web_str('c_state')%></td>
			</tr>
			<tr>
				<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="1" height="1" /></td>
				<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="1" height="1" /></td>
				<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="1" height="1" /></td>
			</tr>
<%
		counter = 0;
		for ( _test_learning in curObject.test_learnings )
		{
			_class = counter++ % 2 ? 'tableRowEven' : 'tableRowOdd';
%>
			<TR VALIGN="top">
				<TD class="<%=_class%>"><a HREF="view_doc.html?mode=test_learning_stat&doc_id=<%=curDocID%>&object_id=<%=_test_learning.PrimaryKey%>&assessment_id=<%=curAssessmentID%>&sid=<%=tools.get_sum_sid(_test_learning.PrimaryKey)%>" title="<%=tools.get_web_str('c_tip_edu_method')%>"><%=( StrDate( _test_learning.start_usage_date, true, false ) + ' - ' + StrDate( _test_learning.last_usage_date, true, false ) )%></a></TD>
				<TD class="<%=_class%>"><center><%=StrReal( _test_learning.score, 1 )%>&nbsp;<%=( curObject.max_score == 0 || ! curObject.max_score.HasValue ? '' : '(' + StrReal( ( 100 * _test_learning.score ) / curObject.max_score, 1 ) + '%)' )%></center></TD>
				<TD class="<%=_class%>"><center><%=( _test_learning.state_id.HasValue ? curLngCommon.learning_states.GetChildByKey( _test_learning.state_id ).name : '' )%></center></TD>
			</TR>
<%
		}
%>
			<tr>
				<td class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td>
				<td class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td>
				<td class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td>
			</tr>
		</table>

		</TD>
	</TR>
<%
	}
%>

</TABLE>