<%

	try
	{
		curExpert = ArrayFind( curObject.experts, "PrimaryKey == curUserID" );
	}
	catch(_levak_)
	{
		curExpert = null;
	}




%>



<style>
   /* styles for the tree */
   SPAN.TreeviewSpanArea A {
      	font-size: 8pt; 
        font-family: verdana,helvetica; 
        text-decoration: none;
        color: black
   }
   SPAN.TreeviewSpanArea A:hover {
        color: '#820082';
   }
   /* rest of the document */
   BODY {background-color: white}
   TD {
        font-size: 10pt; 
        font-family: verdana,helvetica; 
   }
</style>

<script src="scripts\tree\ua000000.js"></script>
<script src="scripts\tree\ftiens40.js"></script>
<script>

function checkkey(srcobj, keycode, flag_flat)
{			
	if ((keycode<48 || keycode>57)& keycode!=46) return false;
	if (keycode==46) 
	{
		if( (!flag_flat) || srcobj.value.indexOf('.') >= 0) return false;
	}
	return true;
}


USETEXTLINKS = 1;
STARTALLOPEN = 0;
USEFRAMES = 0;
USEICONS = 0;
WRAPTEXT = 1;
PRESERVESTATE = 1;
ICONPATH = "scripts\\tree\\";


foldersTree = gFld("<b><%=tools_web.get_cur_lng_name( curObject.name )%></b>", '<%=( tools_web.get_url_protocol( Request.Url ) + Request.UrlHost + UrlPath( Request.Url ) + "?mode=" + Request.QueryString.mode + "&doc_id="+curDocID+"&object_id=" + curObjectID )%>');

<%
	
	for (_purpose in curObject.purposes)
	{
	
		_href = tools_web.get_url_protocol( Request.Url ) + Request.UrlHost + UrlPath( Request.Url ) + "?mode=" + Request.QueryString.mode + "&doc_id="+curDocID+"&object_id=" + curObjectID + "&purpose_id=" + _purpose.PrimaryKey;
		if (_purpose.parent_id.HasValue)
		{
			_parent_var = "p_" + _purpose.parent_id;
		}
		else
		{
			_parent_var = 'foldersTree';
		}
	
		Response.Write('var p_' + _purpose.id +' = insFld(' + _parent_var + ', gFld("'+_purpose.name+'", "'+ _href +'")); \n')
	}
	
	for (_item in curObject.items)
	{
	
		_href = tools_web.get_url_protocol( Request.Url ) + Request.UrlHost + UrlPath( Request.Url ) + "?mode=" + Request.QueryString.mode + "&doc_id="+curDocID+"&object_id=" + curObjectID + "&item_id="+_item.PrimaryKey;

	
		if (_item.purpose_id.HasValue)
		{
			_parent_var = "p_" + _item.purpose_id;
			_href = _href + "&purpose_id=" + _item.purpose_id;
		}
		else
		{
			_parent_var = 'foldersTree';
		}
				
		Response.Write("insDoc( "+_parent_var+", gLnk('S', '<img src=\"/pics/2.gif\" border=\"0\"><b>" + _item.title + "</b>' , '"+ _href + "'));\n");
	}
		
%>

</script>

<table border="0" width="100%" style="height:100%">
	<tr>
		<td id="treeArea" rowspan="2" width="300px" valign="top">
			<span class="TreeviewSpanArea" style="overflow:auto; width:300px">
				<script>initializeDocument();</script>
			</span>

<%
	if (curExpert != null)
	{
			var _q_invented = ArrayCount( ArraySelect(  curObject.items, "person_id == curUserID" ) );
			var _q_2_invent = (curExpert.item_count.HasValue ? curExpert.item_count : 0);
			var _q_print_color = (_q_invented >= _q_2_invent ? "green" : "red");
%>
			<br/><br/>
			<table width="100%" cellspacing="5" cellpadding="4" class="tableBorder">
				<tr>
					<td bgcolor="white" style="font-size:larger; font-weight:lighter;" width="30%">
						<%=tools.get_web_str('vtpb_new_question_count')%>:&nbsp;<font color="<%=_q_print_color%>"><b><%=_q_invented%>&frasl;<%=_q_2_invent%></b></font>
					</td>					
				</tr>
			</table>
<%
	}
%>
		</td>
		<td id="purposeArea" height="50%">
<%
	if (Request.QueryString.HasProperty("purpose_id") && Request.QueryString.purpose_id != "")
	{
		curPurposeID = Request.QueryString.purpose_id;
		curPurpose = curObject.purposes.GetOptChildByKey(Request.QueryString.purpose_id);
		if (curPurpose != undefined)
		{
			_href = tools_web.get_url_protocol( Request.Url ) + Request.UrlHost + UrlPath( Request.Url ) + "?mode=" + Request.QueryString.mode + "&doc_id="+curDocID+"&object_id=" + curObjectID + "&purpose_id=" + curPurposeID;
%>		
			<table width="100%" cellspacing="0" cellpadding="4" class="tableBorder">
			<tr>
				<td width="200px" style="font-weight:bold; font-size:larger"><%=tools.get_web_str('vsb_purpose')%>:</td>
				<td style="font-size:larger; font-weight:lighter;">
					<a href="<%=_href%>"><%=tools_web.get_cur_lng_name( curPurpose.name )%></a>
				</td>
			</tr>
			<tr>
				<td width="200px" style="font-weight:bold; font-size:larger"><%=tools.get_web_str('vcpb_weight')%>:</td>
				<td style="font-size:larger; font-weight:lighter;"><%=curPurpose.weight%></td>
			</tr>
			<tr>
				<td width="200px" style="font-weight:bold; font-size:larger"><%=tools.get_web_str('vtpb_need_question_count')%>:</td>
				<td style="font-size:larger; font-weight:lighter;"><%=curPurpose.item_count%></td>
			</tr>
			<tr>
				<td width="200px" style="font-weight:bold; font-size:larger"><%=tools.get_web_str('vtpb_db_question_count')%>:</td>
				
<%
				_q_count = ArrayCount(ArraySelect(curObject.items, 'purpose_id == "' + curPurposeID + '"'));
				if (curPurpose.item_count.HasValue)
				{
					if (curPurpose.item_count < _q_count)
						_font_color = 'green';
					else if (curPurpose.item_count > _q_count)
						_font_color = 'red';
					else
						_font_color = 'black';
				}
				else
				{
					_font_color = 'black';
				}
						
					
%>

				<td style="font-size:larger; font-weight:lighter; color: <%=_font_color%>"><b><%=_q_count%></b></td>
			</tr>
			
			
			
			</table>
<%
		}
	}
	else
	{
		curPurposeID = null;
	}
%>
		</td>
	</tr>
	<tr>
		<td id="itemArea" height="50%" valign="top">
<%
	if (Request.QueryString.HasProperty("item_id") && Request.QueryString.item_id != "")
	{
		curItemID = Int(Request.QueryString.GetProperty("item_id"))
	}
	else
	{
		curItemID = null;
	}
	
	if (curItemID != null)
	{
		_cur_item = curObject.items.GetOptChildByKey(curItemID);
		if (_cur_item != undefined)
		{
			try
			{
				curItem = OpenDoc(UrlFromDocID(_cur_item.PrimaryKey)).TopElem;
			}
			catch(_FUCK_)
			{
				Response.Write("<br/><center><font color='red' style='font-weight: bolder; border:dotted; border-color:maroon' >" + tools.get_web_str('c_deleted') + "</font></center><br/>");
				Cancel();
			}
			
%>


		<script language="javascript">
			function what2submit()
			{
				var _source_fields = document.all.data_0_source_fields;
				var _destination_fields = document.all.data_0_destination_fields;
								
				_source_fields.value += "@_item_comment.person_id";
				_destination_fields.value += "<%=curUserID%>"; 
				
				_source_fields.value += ";@_item_comment.item_id";
				_destination_fields.value += ";<%=curItemID%>"; 
				
				_source_fields.value += ";@_item_comment.status";
				_destination_fields.value += ";" + document.getElementById("item_comment_status").value; 
				
				_source_fields.value += ";@_item_comment.comment";
				_destination_fields.value += ";" + document.getElementById("item_comment").value; 
				
				_source_fields.value += ";@_item_comment.quota_correct";
				_destination_fields.value += ";" + document.getElementById("quota_correct").value; 
				
				return true;
			}
		</script>

		<form name="item_submitter" id="item_submitter" action="document_save.html" method="post" onsubmit="return what2submit();">
		<input type="hidden" name="data_0_id" value="<%=curObjectID%>"/>
		<input type="hidden" name="data_0_source_fields" value=""/>
		<input type="hidden" name="data_0_destination_fields" value=""/>
		<input type="hidden" name="data_0_elements" value="_item_comment = item_comments.ObtainChildByKey('<%=curUserID%>_<%=curItemID%>')"/>
		
		
		<input type="hidden" name="doc_id" value="<%=curDocID%>"/>
		<input type="hidden" name="mode" value="test_project"/>
		<input type="hidden" name="parameters" value="item_id=<%=curItemID%>&object_id=<%=curObjectID%>&purpose_id=<%=(curPurposeID != null ? curPurposeID : '')%>"/>

			<table width="100%" cellspacing="0" cellpadding="4" class="tableBorder">
				<tr>
					<td width="200px" style="font-weight:bold; font-size:larger"><%=tools.get_web_str('c_question')%>:</td>
					<td style="font-size:larger; font-weight:lighter;"><%=curItem.title%></td>
				</tr>
				<tr>
					<td width="200px" style="font-weight:bold; font-size:larger"><%=tools.get_web_str('vfb_text')%>:</td>
					<td style="font-size:larger; font-weight:lighter;"><%=curItem.question_text%></td>
				</tr>
				<tr>
					<td width="200px" style="font-weight:bold; font-size:larger"><%=tools.get_web_str('c_type')%>:</td>
					<td style="font-size:larger; font-weight:lighter;"><%=(curItem.type_id == "multiple_choice" ? tools.get_web_str('vicb_type_choice') : (curItem.type_id == "multiple_response" ? tools.get_web_str('vicb_type_select') : '?' ) )%></td>
				</tr>
				<tr>
					<td width="200px" style="font-weight:bold; font-size:larger"><%=tools.get_web_str('c_score')%>:</td>
					<td style="font-size:larger; font-weight:lighter;"><%=curItem.question_points%></td>
				</tr>
				<tr>
					<td width="200px" style="font-weight:bold; font-size:larger"><%=tools.get_web_str('vfb_author')%>:</td>
					<td style="font-size:larger; font-weight:lighter;"><%=_cur_item.person_fullname%></td>
				</tr>
				<tr>
					<td width="200px" style="font-weight:bold; font-size:larger"><%=tools.get_web_str('c_status')%>:</td>
					<td style="font-size:larger; font-weight:lighter;"><%=(_cur_item.status.HasValue ? _cur_item.status.ForeignElem.name : '???')%></td>
				</tr>
				<tr>
					<td colspan="2">
						<table width="100%" cellspacing="0" cellpadding="4" class="tableBorder">
							<tr>
								<td bgcolor="white">
								
								
									<table width="100%"  border="0" cellspacing="0" cellpadding="3">
			
										<tr id="line_head">
											<td class="tableHeaderWithText"><%=tools.get_web_str('vtpb_answer_text')%></td>
											<td class="tableHeaderWithText" width="100px"><%=tools.get_web_str('vtpb_correct')%></td>
										</tr>
										<tr>
											<td class="tableHeaderNoText" colspan="2"><img src="pics/1blank.gif" width="1" height="1" /></td>
										</tr>
										
<%
	_counter = 0;
	for( _answer in curItem.answers)
	{
		_class = _counter++ % 2 ? 'tableRowEven' : 'tableRowOdd';
%>
				<tr valign="MIDDLE">
					<td class="<%=_class%>"><%=_answer.text%></td>
					<td class="<%=_class%>" align="center">
						<font style="font-family:Wingdings; font-size: small">
							<%=(_answer.is_correct_answer ? "&#252;" : "&nbsp;" )%>
						</font>
					</td>
				</tr>						
<%
	}
%>
										
										
										<tr>
											<td class="tableFooter" colspan="2"><img src="pics/1blank.gif" width="1" height="1" /></td>
										</tr>
									</table>
								
								
								</td>
							</tr>
						</table>
					</td>
				</tr>
<%
		
		_item_comment = curObject.item_comments.GetOptChildByKey(curUserID + "_" + curItemID);
		
		if(curExpert != null)
		{
			if (_item_comment != undefined)
			{
				if (_item_comment.status == "active")
					_is_modify = true;
				else
					_is_modify = false;
			}
			else
			{
				_is_modify = true;
			}
		}
		else		
			_is_modify = false;
		
%>
				<tr>
					<td width="200px" style="font-weight:bold; font-size:larger"><%=tools.get_web_str('vtpb_apr_status')%>:</td>
					<td style="font-size:larger; font-weight:lighter;">
<%
						if (_item_comment != undefined && _item_comment.status.HasValue)
						{
							Response.Write(_item_comment.status.ForeignElem.name);
						}
						else
							Response.Write("&nbsp;");
%>

					</td>
				</tr>
				
				
				<tr>
					<td width="200px" style="font-weight:bold; font-size:larger"><%=tools.get_web_str('vtpb_correct_percent')%>:</td>
					<td style="font-size:larger; font-weight:lighter;">
<%
						if (_is_modify)
						{
%>
							<input id="quota_correct" name="quota_correct" value="<%=( _item_comment != undefined ? _item_comment.quota_correct : 0 )%>" onkeypress="return checkkey(this,window.event.keyCode, false);" class="inputEdit" style="width: 40px"/>
<%
						}
						else
							Response.Write((_item_comment != undefined ? _item_comment.quota_correct : 0));
%>
					</td>
				</tr>
				
				<tr>
					<td width="200px" style="font-weight:bold; font-size:larger"><%=tools.get_web_str('c_comment')%>:</td>
					<td style="font-size:larger; font-weight:lighter;">
<%
						if (_is_modify)
						{
%>
						<textarea rows="5" id="item_comment" name="item_comment" style="width:100%"><%=(_item_comment != undefined ? _item_comment.comment : "")%></textarea>
<%
						}
						else
							Response.Write((_item_comment != undefined ? StrReplace(_item_comment.comment , "\n" , "<br/>") : ""));
%>

					</td>
				</tr>
<%
						if (_is_modify)
						{
%>

				<tr>
					<td colspan="2" align="center">
						<input type="hidden" id="item_comment_status" name="item_comment_status" value="active"/>
						<input type="submit" value="<%=tools.get_web_str('c_approve')%>" class="inputButton" onmouseover="this.className='inputButtonOver';" onmouseout="this.className='inputButton';" onclick="document.all.item_comment_status.value = 'approved';"/> &nbsp; <input type="submit" value="<%=tools.get_web_str('c_reject')%>" class="inputButton" onmouseover="this.className='inputButtonOver';" onmouseout="this.className='inputButton';" onclick="document.all.item_comment_status.value = 'rejected';"/>
					</td>
				</tr>
<%
						}
%>

			</table>
			
			
		</form>
			
<%
			_counter = 0;
			_e_comments = ArraySelect( curObject.item_comments , "person_id != curUserID && item_id == curItemID");
		
			if (ArrayCount(_e_comments) > 0)
			{
%>	
			<table width="100%" cellspacing="0" cellpadding="4" class="tableBorder">
				<tr>
					<td>
						<table width="100%"  border="0" cellspacing="0" cellpadding="3">			
							<tr id="line_head">
								<td class="tableHeaderWithText" width="30%"><%=tools.get_web_str('vkpb_expert')%></td>
								<td class="tableHeaderWithText"><%=tools.get_web_str('vtpb_expert_comment')%></td>
								<td class="tableHeaderWithText" width="50px"><%=tools.get_web_str('c_status')%></td>
								<td class="tableHeaderWithText" width="50px"><%=tools.get_web_str('vtpb_quota')%></td>
							</tr>
							<tr>
								<td class="tableHeaderNoText" colspan="4"><img src="pics/1blank.gif" width="1" height="1" /></td>
							</tr>
							
<%
					for( _e_comment in _e_comments)
					{
						_class = _counter++ % 2 ? 'tableRowOdd' : 'tableRowEven';
						_cur_expert = curObject.experts.GetOptChildByKey(_e_comment.person_id);
%>
							<tr valign="MIDDLE">
								<td class="<%=_class%>"><%=( _cur_expert == undefined ? tools_web.get_web_str('c_deleted') : _cur_expert.person_fullname )%></td>
								<td class="<%=_class%>" align="left"><%=StrReplace(_e_comment.comment , "\n" , "<br/>")%></td>
								<td class="<%=_class%>" align="center"><%=(_e_comment.status.HasValue ? _e_comment.status.ForeignElem.name : "?")%></td>
								<td class="<%=_class%>" align="center"><%=_e_comment.quota_correct%>%</td>
							</tr>
<%
					}
%>						
						</table>
					</td>
				</tr>
			</table>			
			
<%
			}
			
			
		}
		else
		{
			Response.Write("<br/><center><font color='red' style='font-weight: bolder; border:dotted; border-color:maroon' >" + tools.get_web_str('c_deleted') + "</font></center><br/>");
		}
	}
	else
	{
	
		if (curPurposeID != null) 
			_items = ArraySelect(curObject.items, 'purpose_id == "' + curPurposeID + '"')
		else
			_items = ArraySelect(curObject.items, 'purpose_id.HasValue == false')
		
		if (ArrayCount(_items) > 0)
		{	
		
%>
		<table width="100%"  border="0" cellspacing="0" cellpadding="3">
			
			<tr id="line_head">
				<td class="tableHeaderWithText"><%=tools.get_web_str('c_question')%></td>
				<td class="tableHeaderWithText" width="50%"><%=tools.get_web_str('vfb_text')%></td>
				<td class="tableHeaderWithText" width="100px"><%=tools.get_web_str('c_type')%></td>
				<td class="tableHeaderWithText" width="100px"><%=tools.get_web_str('c_score')%></td>
			</tr>
			<tr>
				<td class="tableHeaderNoText" colspan="4"><img src="pics/1blank.gif" width="1" height="1" /></td>
			</tr>	
<%	
			_counter = 0;					
			for( _item in _items)
			{
				_class = _counter++ % 2 ? 'tableRowEven' : 'tableRowOdd';
				
				_href = tools_web.get_url_protocol( Request.Url ) + Request.UrlHost + UrlPath( Request.Url ) + "?mode=" + Request.QueryString.mode + "&doc_id="+curDocID+"&object_id=" + curObjectID + "&item_id="+_item.PrimaryKey + (curPurposeID != null ? "&purpose_id=" + curPurposeID : "");
			
%>	
				<tr valign="MIDDLE">					
					<td class="<%=_class%>"><a href="<%=_href%>"><%=_item.title%></a></td>
					<td class="<%=_class%>"><%=_item.question_text%></td>
					<td class="<%=_class%>" align="center"><%=(_item.type_id == "multiple_choice" ? tools.get_web_str('vicb_type_choice') : (_item.type_id == "multiple_response" ? tools.get_web_str('vicb_type_select') : '?' ) )%></td>
					<td class="<%=_class%>" align="center"><%=_item.question_points%></td>
				</tr>
<%
			}
	
%>
			<tr>
				<td class="tableFooter" colspan="4"><img src="pics/1blank.gif" width="1" height="1" /></td>
			</tr>
		</table>
<%
		}
	}
	
	
if (curExpert != null)
{

	if (curItemID != null )
	{
		_cur_item = curObject.items.GetOptChildByKey(curItemID);
		if (_cur_item != undefined)
		{
			if (_cur_item.person_id != curUserID)
			{
				curItemID = null;
			}
		}
	}

	_href = tools_web.get_url_protocol( Request.Url ) + Request.UrlHost + UrlPath( Request.Url ) + "?mode=item_compose&doc_id="+curDocID+"&object_id=" + curObjectID + "&item_id=" + (curItemID != null ? curItemID : '') + "&purpose_id=" + (curPurposeID != null ? curPurposeID : '');	
%>
			<p>
				<input type="submit" value="<%=(curItemID != null ? tools.get_web_str('c_edit') : tools.get_web_str('c_create'))%> <%=tools.get_web_str('c_question')%>" class="inputButton" onmouseover="this.className='inputButtonOver';" onmouseout="this.className='inputButton';" onclick="window.location.href='<%=_href%>'"/>
			</p>
<%

}

%>
		</td>
	</tr>
</table>