<%
	is_anonymous = false;
	if ( curUserID == null )
		is_anonymous = true;
	

	
	try
	{
		curVacancyDoc = OpenDoc( UrlFromDocID( curObjectID ) ).TopElem;
	}
	catch(err)
	{
		Cancel();
	}
	
	_page_name = "";
	object_type = ArrayOptFirstElem( ArraySelectByKey( common.exchange_object_types, curObject.Name, "name" ) );
	if ( object_type != undefined )
		_page_name = object_type.title + " &quot;" + curObject.Child( object_type.disp_name ) + "&quot;";
		
	if ( Request.QueryString.HasProperty("selected") && Request.QueryString.GetProperty("selected") == "1" && !is_anonymous &&  ArrayOptFirstElem( XQuery("for $elem in selected_vacancys where $elem/person_id=" + curUserID + " and $elem/vacancy_id=" + curObjectID + " return $elem") ) == undefined )
	{
			_doc = OpenNewDoc( 'x-local://wtv/wtv_selected_vacancy.xmd' );
			_doc.BindToDb( DefaultDb );
			_doc.TopElem.vacancy_id = curObjectID;
			_doc.TopElem.vacancy_name = curObject.name;
			_doc.TopElem.person_id = curUserID;
			_doc.TopElem.person_fullname = curUser.fullname;
			_doc.Save();
	}
	
	if ( Request.QueryString.HasProperty("test_id") && Request.QueryString.GetProperty("test_id") != "" && !is_anonymous  )
	{
		_test_id = Int( Request.QueryString.GetProperty("test_id") );
		_active_learning = tools.activate_test_to_person( curUserID, _test_id, null, curUser );
		
%>
		<SCRIPT TYPE="text/javascript">
			window.location.href = "view_doc.html?doc_id=<%=curDocID%>&object_id=<%=_active_learning.DocID%>&assessment_id=<%=_test_id%>&mode=test_learning_proc"
		</SCRIPT>
<%
		//Response.Redirect(alert("view_doc.html"));
	}
	
%>

<table width="100%" border="0" cellspacing="2" cellpadding="2">
  <tr valign=top>
    <td width="200"><b>Название:</b></td>
    <td><%=curVacancyDoc.name%></td>
    <td width="300" rowspan="20" valign=top>
	<!--<div style=" background-image:url(pics/note.jpg)"> -->

	<%=curVacancyDoc.source_id.HasValue ? "<b>Вакансия №" + curVacancyDoc.source_id + "</b><br><br>": ""%>
	
	Дата размещения: <%=curVacancyDoc.doc_info.creation.date%>
	<br>
	Дата посл. редактирования: <%=curVacancyDoc.doc_info.modification.date%>
	<br>
	<br>
<%
	//is_anonymous = true;
	if ( curVacancyDoc.is_closed )
	{
		Response.Write("<i>Вакансия закрыта</i><br>")
	}
	else
	{
		if ( !( curUser!= null && (curUser.access.access_role == "admin" || curUser.access.access_role == "organizer") )  )
			if ( is_anonymous )
				Response.Write("<i>Чтобы откликнуться на вакансию вам необходимо <a href='view_doc.html?mode=register'>зарегистрироваться</a></i><br>")
			else
			{
				_response_array = ArrayOptFirstElem(XQuery( "for $elem in vacancy_responses where $elem/vacancy_id=" + curObjectID + " and $elem/person_id=" + curUserID + " return $elem" ));
				if ( _response_array != undefined )
				{
	%>
	<a href="view_doc.html?mode=vacancy_response&object_id=<%=_response_array.id%>&doc_id=<%=curDocID%>">Посмотреть отклик</a><br>
	<%
				}
				else
				{
					_is_ready = true;
					for ( _test in curVacancyDoc.assessments )
					{
						person_learning = ArrayOptFirstElem( XQuery("for $elem in test_learnings where $elem/assessment_id=" + _test.assessment_id + " and $elem/person_id=" + curUserID + " return $elem" ))
						if ( person_learning == undefined )
							_is_ready = false;
					}
					if ( _is_ready )
					{
						resume_count = ArrayCount( XQuery("for $elem in resumes where $elem/person_id=" + curUserID + " return $elem"));
						if ( resume_count > 0 )
							Response.Write('<a href="view_doc.html?mode=vacancy_response&vacancy_id=' + curObjectID + '&doc_id=" + curDocID>Отправить резюме на вакансию</a><br>')
						else
							Response.Write('Чтобы откликнуться на вакансию вам необходимо <a href="view_doc.html?mode=resume&doc_id=' + curDocID + '">Создать резюме</a><br>')
					}
					else
						Response.Write('<i>Чтобы откликнуться на вакансию вам необходимо пройти тестирование (см. карточку вакансии)</i><br>')
				}
			}
	}
%>
<!--	<a href="#">Распечатать вакансию</a><br> -->
<%
	if ( !is_anonymous && !( curUser.access.access_role == "admin" || curUser.access.access_role == "organizer" ) )
	{
		if ( ArrayOptFirstElem( XQuery("for $elem in selected_vacancys where $elem/person_id=" + curUserID + " and $elem/vacancy_id=" + curObjectID + " return $elem") ) == undefined )
			Response.Write('<a href="' + Request.Url + '&selected=1">Добавить в избранное</a><br>')
		else
			Response.Write('<img alt="Вакансия добавлена в Избранные" src="pics/yes.png"/><i>Вакансия добавлена в <a href="view_doc.html?mode=selected_vacancys">Избранные</a></i><br>')
%>	
	
<%
	}
%>
	<!-- </div> -->
	&nbsp;</td>
  </tr>
<%
	if ( curVacancyDoc.profession_area_id.HasValue )
	{
%>
  <tr>
    <td width="200"><b>Профессиональная область: </b></td>
    <td><%=curVacancyDoc.profession_area_id.OptForeignElem.name%></td>
  </tr>
<%
	}
%>
<%
	if ( curVacancyDoc.region_id.HasValue )
	{
%>
  <tr>
    <td width="200"><b>Регоин: </b></td>
    <td><%=curVacancyDoc.region_id.OptForeignElem.name%></td>
  </tr>
<%
	}
%>
<%
	if ( curVacancyDoc.employment_type_id.HasValue )
	{
%>
  <tr>
    <td width="200"><b>Тип занятости:</b></td>
    <td><%=curVacancyDoc.employment_type_id.OptForeignElem.name%></td>
  </tr>
<%
	}
%>
<%
	if ( curVacancyDoc.educ_type_id.HasValue )
	{
%>
  <tr>
    <td width="200"><b>Тип образования:</b></td>
    <td><%=curVacancyDoc.educ_type_id.OptForeignElem.name%></td>
  </tr>
<%
	}
%>
<%
	if ( curVacancyDoc.min_exp_years.HasValue )
	{
%>
  <tr>
    <td width="200"><b>Минимальный опыт работы (лет):</b></td>
    <td><%=curVacancyDoc.min_exp_years %></td>
  </tr>
<%
	}
%>
<%
	if ( curVacancyDoc.min_age.HasValue || curVacancyDoc.max_age.HasValue )
	{
%>
  <tr>
    <td width="200"><b>Возраст:</b></td>
    <td><%=curVacancyDoc.min_age.HasValue ? "от " + curVacancyDoc.min_age : ""%> <%=curVacancyDoc.max_age.HasValue ? " до " + curVacancyDoc.max_age : ""%> лет</td>
  </tr>
<%
	}
%>

<%
	if ( curVacancyDoc.min_wage.HasValue || curVacancyDoc.max_wage.HasValue )
	{
%>
  <tr>
    <td width="200"><b>Доход:</b></td>
    <td><%=curVacancyDoc.min_wage.HasValue ? "от " + curVacancyDoc.min_wage : ""%> <%=curVacancyDoc.max_wage.HasValue ? " до " + curVacancyDoc.max_wage : ""%> <%=curVacancyDoc.currency_type_id.HasValue ? curVacancyDoc.currency_type_id.OptForeignElem.short_name : ""%></td>
  </tr>
<%
	}
%>
	<tr> <td colspan=3> </td>&nbsp;</tr>
<%
	if ( curVacancyDoc.contact_fullname.HasValue )
	{
%>
  <tr>
    <td width="200"><b>ФИО контактного лица:</b></td>
    <td><%=curVacancyDoc.contact_fullname %></td>
  </tr>
<%
	}
%>

<%
	if ( curVacancyDoc.contact_phone.HasValue )
	{
%>
  <tr>
    <td width="200"><b>Контактный телефон:</b></td>
    <td><%=curVacancyDoc.contact_phone %></td>
  </tr>
<%
	}
%>
<%
	if ( curVacancyDoc.contact_email.HasValue )
	{
%>
  <tr>
    <td width="200"><b>Контактный e-mail:</b></td>
    <td><%=curVacancyDoc.contact_email %></td>
  </tr>
<%
	}
%>
	<tr> <td colspan=3> </td>&nbsp;</tr>
<%
	if ( ArrayCount(curVacancyDoc.assessments) > 0 )
	{
%>
  <tr>
    <td width="200" valign=top><b>Необходимо пройти тесты:</b></td>
    <td><%
	for ( _test in curVacancyDoc.assessments )
	{
		Response.Write( "<i>" + _test.assessment_code  + "&nbsp;&nbsp;&nbsp;" +_test.assessment_name + "</i>" )
		if ( !is_anonymous )
		{
			person_active_learning = ArrayOptFirstElem( XQuery("for $elem in active_test_learnings where $elem/assessment_id=" + _test.assessment_id + " and $elem/person_id=" + curUserID + " return $elem" ))
			person_learning = ArrayOptFirstElem( XQuery("for $elem in test_learnings where $elem/assessment_id=" + _test.assessment_id + " and $elem/person_id=" + curUserID + " return $elem" ))
			if ( person_learning != undefined )
				Response.Write( "&nbsp;&nbsp;&nbsp;<img alt='Тест вами пройден' src='pics/yes.png'/>" )
			
			if ( person_active_learning != undefined )
				Response.Write( "&nbsp;&nbsp;&nbsp;<a href='/view_doc.html?doc_id=" + curDocID + "&object_id=" + person_active_learning.id + "&assessment_id=" + _test.assessment_id + "&mode=test_learning_proc'>Продолжить тестирование</a>" )
			
			if ( person_active_learning == undefined && person_learning == undefined )
				Response.Write("&nbsp;&nbsp;&nbsp;<a href='" + Request.Url +"&test_id=" + _test.assessment_id +"'>Пройти тест</a>");
			
		}
		Response.Write( "<br>" )
	}
	%></td>
  </tr>
<%
	}
%>

<%
	if ( curVacancyDoc.desc.HasValue )
	{
%>
  <tr>
    <td width="200" valign=top><b>Описание:</b></td>
    <td><%=curVacancyDoc.desc%></td>
  </tr>  
<%
	}
%>
</table>