<%
Server.Execute( "include/access_init.html" );
_read_only = true;
curVacancyID = null;
curVacancyDoc = null;

if ( Request.QueryString.HasProperty("vacancy_id") && Request.QueryString.GetProperty("vacancy_id") != "" )
{
	_read_only = false;
	try
	{
		curVacancyID = Int( Request.QueryString.GetProperty("vacancy_id") );
		curVacancyDoc = OpenDoc( UrlFromDocID( curVacancyID ) ).TopElem;
	}
	catch(err)
	{
		alert(err)
		_read_only = true;
	}
}	

if ( Request.Form.HasProperty("resume_id") && Request.Form.GetProperty("resume_id") != "" )
{
	docResponse = OpenNewDoc( 'x-local://wtv/wtv_vacancy_response.xmd' );
	docResponse.BindToDb( DefaultDb );
	
	try
	{
		vacancyID = Int( Request.Form.vacancy_id);
		vacancyDoc = OpenDoc( UrlFromDocID( vacancyID ) ).TopElem;
		docResponse.TopElem.vacancy_id = vacancyID;
		docResponse.TopElem.vacancy_name = vacancyDoc.name;
		docResponse.TopElem.person_id = curUserID;
		tools.common_filling ('collaborator', docResponse.TopElem, curUserID, curUser );
		
		docResponse.TopElem.resume_id = Int( Request.Form.resume_id);
		docResponse.TopElem.desc = ( Request.Form.response_letter);
		docResponse.TopElem.date = Date();
		docResponse.Save();
		tools.create_notification( "estaff_api_002", docResponse.DocID, "", vacancyID );
		
	}
	catch(err)
	{
		alert(err)
	}
	
	%>
		<SCRIPT TYPE="text/javascript">
			window.location.href = "view_doc.html?mode=vacancy_response&object_id=<%=docResponse.DocID%>"
		</SCRIPT>
<%
}

if ( _read_only && curObjectID != null )
{
	//просмотр существующего отклика
%>

<script language="javascript">	
	function check_form()
	{
		
		_log = "";
		if ( document.getElementById("resume_id").value == "")
			_log += "Не выбрано резюме <br>"
		if ( document.getElementById("response_letter").value == "")
			_log += 'Не заполнено поле "Сопроводительное письмо" <br>'
		document.getElementById("log_label").innerHTML = _log;
		if ( _log == "" )
			document.forms["response_form"].submit();
		
	}

	
</script>

	<table width="100%"  border="0" cellspacing="0" cellpadding="3">
		<tr>
			<td width="170"><b>Вакансия:</b></td>
			<td>
<%
			vacDoc = null;
			try
			{
				vacDoc = OpenDoc( UrlFromDocID( curObject.vacancy_id ) ).TopElem;
				Response.Write('<a href="view_doc.html?mode=vacancy_estaff&object_id=' + curObject.vacancy_id + '&doc_id=' + curDocID + '">' + vacDoc.name + '</a>')
			}
			catch(err)
			{
				Response.Write( curObject.vacancy_name )
			}
%>			
			
			</td>
		</tr>
		
		<tr>
			<td width="170"><b>Резюме:</b></td>
			<td>
<%
			resumeDoc = null;
			try
			{
				resumeDoc = OpenDoc( UrlFromDocID( curObject.resume_id ) ).TopElem;
				Response.Write('<a href="view_doc.html?mode=resume&resume_id=' + curObject.resume_id + '&doc_id=' + curDocID + '">' + resumeDoc.name + '</a>')
			}
			catch(err)
			{
				if ( curObject.resume_id.HasValue ) Response.Write( "Резюме было удалено" )
			}
%>			
				
			</td>
		</tr>
		<tr>
			<td width="170"><b>Дата отклика:</b></td>
			<td> <%=curObject.doc_info.creation.date%>		
			</td>
		</tr>	
		<tr>
			<td width="170"><b>Статус:</b></td>
			<td><%=curObject.status.OptForeignElem != undefined ? curObject.status.OptForeignElem.name : ""%>		
			</td>
		</tr>
<%
	if ( curObject.desc.HasValue )
	{
%>	
		<tr>
			<td width="170" valign=top><b>Сопроводительное письмо:</b></td>
			<td> <%=curObject.desc%>		
			</td>
		</tr>
<%
	}
%>	

<%
	if ( curObject.employer_answer.HasValue )
	{
%>	
		<tr>
			<td width="170" valign=top><b>Ответ работодателя:</b></td>
			<td> <%=curObject.employer_answer%>		
			</td>
		</tr>
<%
	}
%>	
	</table>
	
<%
}

if ( curVacancyID != null )
{
	//создание отклика на вакансию
%>
	<div style="text-align:center; margin:12px;" class="headerText">Отклик на вакансию</div>
<form action="<%=Request.Url%>" method="post" name="response_form">
	<table width="100%"  border="0" cellspacing="0" cellpadding="3">
		<tr>
			<td width="170"><b>Вакансия:</b></td>
			<td>
<%
			if ( curVacancyDoc != null )
				Response.Write('<a href="view_doc.html?mode=vacancy&object_id=' + curVacancyID + '&doc_id=' + curDocID + '">' + curVacancyDoc.name + '</a>')

%>			
			
			</td>
		</tr>
		

		<tr>
			<td width="170"><b>Резюме:</b></td>
			<td>
<%
				resume_array = XQuery("for $elem in resumes where $elem/person_id=" + curUserID + " return $elem")
				if ( ArrayCount( resume_array ) == 0 )
					Response.Write('Необходимо <a href="view_doc.html?mode=resume&doc_id' + curDocID + '">создать резюме</a><br>')
%>

<%
				i = 0;
				for ( _resume in resume_array )
				{
					i++;
%>
					<input type="radio" name="resume_id" id="resume_id" value="<%=_resume.id%>" <%= i==1 ? " checked" : "" %>> &nbsp;<a href="view_doc.html?mode=resume&object_id=<%=_resume.id%>&doc_id=<%=curDocID%>"><%=_resume.name%></a> <br/>
						
<%

				}

%>			

			</td>
		</tr>		
		<tr>
			<td width="170" valign=top><b>Сопроводительное письмо:</b></td>
			<td>
				<textarea name="response_letter" id="response_letter" cols="80" rows="7"></textarea>

			</td>
		</tr>				
	</table>
	<label id="log_label" style="color:red"></label>
	<div align=center>
	<input type=hidden name="vacancy_id" value="<%=curVacancyID%>">
	<input type="button" value="Отправить" onclick='
		_log = "";
		if ( document.getElementById("response_letter").value == "")
			_log += "Не заполнено поле \"Сопроводительное письмо\" <br>"
		document.getElementById("log_label").innerHTML = _log;
		if ( _log == "" )
			document.forms["response_form"].submit();
		
		'>
		</div>
</form>
<%	
}
%>