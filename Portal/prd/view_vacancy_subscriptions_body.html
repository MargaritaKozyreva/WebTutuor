<%
Server.Execute( "include/access_init.html" );
result_array = Array();
if ( curUserID != undefined )
	result_array = XQuery( "for $elem in vacancy_subscriptions where $elem/person_id=" + curUserID + " return $elem" );
	
if ( Request.Form.HasProperty("sort_field") && Request.Form.GetProperty("sort_field") != "")
	result_array = ArraySort( result_array, Request.Form.GetProperty("sort_field"), Request.Form.HasProperty("sort_type") ? Request.Form.GetProperty("sort_type") : "+" );
	
if ( Request.Form.HasProperty("vacancy_subscription_id") && Request.Form.GetProperty("vacancy_subscription_id") != "")
{
	_cur_subscription_id = Int(Request.Form.GetProperty("vacancy_subscription_id"));
	
	if ( Request.Form.GetProperty("type_action_" + _cur_subscription_id) == "delete" )
		try
		{
			DeleteDoc( UrlFromDocID( ( _cur_subscription_id ) ) )
		}
		catch(err)
		{}
	if ( Request.Form.GetProperty("type_action_" + _cur_subscription_id) == "change_state" )
	{
		vacancy_subscriptionDoc = OpenDoc( UrlFromDocID( (_cur_subscription_id) ) );
		vacancy_subscriptionDoc.TopElem.is_active = !vacancy_subscriptionDoc.TopElem.is_active;
		vacancy_subscriptionDoc.Save();
	}
}
%>

<script language="javascript">	
	function sort_result(_field_name)
	{
		document.getElementById("sort_field").value = _field_name;
		_old_value = document.getElementById("sort_type").value;
		document.getElementById("sort_type").value = ( _old_value == "+" ? "-" : "+" );
		document.all["form_sort"].submit();
	}
	
	function question( _form_name, _type_action_name )
	{
		if ( confirm('Вы уверены, что хотите удалить отклик?') )
		{
			document.all[_type_action_name].value = 'delete';			
			document.all[_form_name].submit();
		}
	}
	
	function change_state( _form_name, _type_action_name )
	{
		document.all[_type_action_name].value = 'change_state';			
		document.all[_form_name].submit();
	}
	
	
	
</script>


<form ACTION="<%=Request.Url%>" name="form_sort" method="post">
	<input type=hidden name="sort_field" id="sort_field" value="<%=Request.Form.HasProperty('sort_field') ? Request.Form.GetProperty('sort_field') : 'name'%>">
	<input type=hidden name="sort_type" id="sort_type" value="<%=Request.Form.HasProperty('sort_type') ? Request.Form.GetProperty('sort_type') : '+'%>">

</form>

<p align=right> <a href="view_doc.html?mode=vacancy_subscription&is_new=1&doc_id=<%=curDocID%>">Создать новую подписку </a></p>
<table width="100%"  border="0" cellspacing="0" cellpadding="3">
					<tr>
						<td class="tableHeaderWithText">&nbsp;</td>
						<td class="tableHeaderWithText" width="20%">Название</td>
						<td class="tableHeaderWithText">Параметры подписки</td>

						<td class="tableHeaderWithText" width="20%">Действия</td>
						<td class="tableHeaderWithText">&nbsp;</td>
					</tr>
					<tr>
						<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="1" height="1" /></td>				
						<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="1" height="1" /></td>
						<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="1" height="1" /></td>
						<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="1" height="1" /></td>
						<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="1" height="1" /></td>
					</tr>
					
	<%
		counter = 0;
		for ( _result in result_array  )
		{
			try
			{
				resultDoc = OpenDoc( UrlFromDocID( _result.id ) ).TopElem;
			}
			catch(err)
			{
				continue;
			}
			
			
			
			
			//ТРАНСЛЯЦИЯ УСЛОВИЙ ПОИСКА из ПОДПИСКИ в локальные переменные шаблона	
	curObject = resultDoc;
	categ_array = Array();
	_prof_areas_str = "";
	_prof_area_ids = "";
	local_var_array = Array( "_max_age", "_min_age", "_min_wage", "_max_wage", "_currency_type", "_educ_type", "_employment_type", "_region_id" );
	form_property_array = Array( "max_age", "min_age", "min_wage", "max_wage", "currency_type_id", "educ_type_id", "employment_type_id", "region_id" ); 
	i = 0;
	while ( i < ArrayCount( local_var_array ) )
	{
		eval( local_var_array[i] + ' = ""' )
		i++;
	}
	_key_word_in_name = "";
	

		for ( _cond in ArraySelect( curObject.conditions, "field=='name'" ) )
		{
			_key_word_in_name += _cond.value + " "
		}
		_key_word_in_name = UnifySpaces( _key_word_in_name );
		
		i = 0;
		while ( i < ArrayCount( local_var_array ) )
		{
			eval( local_var_array[i] + ' = ""' )
			try
			{
				_find = eval ( ( 'ArrayOptFind( curObject.conditions, "field==\'' + form_property_array[i] + '\'" )' ))
				if ( _find != undefined )
					eval( ( local_var_array[i] + ' = _find.value' ) )
			}
			catch(err)
			{
				alert("@@@@" + err)
			}
			i++;
		}
		if ( _region_id != "" )
			_region_id = Int( _region_id );
			
		

		
		for ( _cond in ArraySelect( curObject.conditions, "field=='profession_area_id'" ) )
		{
			categ_array[ArrayCount(categ_array)] = _cond.value;
			_prof_area_ids += _cond.value + ",";
			_find = ArrayOptFind( lists.professional_areas, "id=='" + _cond.value +"'" );
				if ( _find != undefined )
					_prof_areas_str += _find.name + " | ";
		}
		
			
			
			//_class = counter++ % 2 ? 'tableRowEven' : 'tableRowOdd';
			_class = "";
			//if ( _result.status == "accepted" )
				//_class = ' bgcolor="#CCFFCC"';
			//if ( _result.status == "rejected" )
				//_class = ' bgcolor="#FFCCFF"';
			if ( !_result.is_active )
				_class = ' bgcolor="#E2E2E2"';
	%>
				<TR VALIGN="TOP">					
						<TD <%=_class%>>&nbsp;</TD>
						<TD <%=_class%>>
						
						<b><a href="view_doc.html?mode=vacancy_subscription&doc_id=<%=curDocID%>&object_id=<%=_result.id%>"><%=_result.name%></b> </a> <br>
						<%=_result.is_active ? "Подписка включена" : "Подписка выключена" %><br><br>
						Создана: <%=_result.creation_date%><br>
						Изменена: <%=_result.modification_date%>
						
						</TD>
						<TD <%=_class%>>
						
						

Параметры отбора вакансий: 
<UL>
<%
	if ( _key_word_in_name != "" )
	{
%>
		<LI>Ключевые слова в названии должности: <b><%=_key_word_in_name%></b> </LI>
<%
	}
	if ( curObject.full_text_search_str.HasValue )
	{
%>
		<LI>Ключевые слова в тексте вакансии: <b><%=curObject.full_text_search_str%></b> </LI>	
<%
	}
	if ( _prof_areas_str != "" )
	{
%>
		<LI>Профессиональная область: <b><%=_prof_areas_str%></b> </LI>	
<%
	}
	if ( _region_id != "" )
	{
		try
		{
			curRegion = OpenDoc( UrlFromDocID( _region_id ) ).TopElem;
%>
		<LI>Регион: <b><%=curRegion.name%></b> </LI>	
<%
		}
		catch(err)
		{}
	}
	_educ_elem = ArrayOptFind( common.educ_types, "id=='" + _educ_type + "'" )
	if ( _educ_type != "" && _educ_elem != undefined )
	{
%>
		<LI>Образование: <b><%=_educ_elem.name%></b> </LI>	
<%
	}
	_employment_elem = ArrayOptFind( common.employment_types, "id=='" + _employment_type + "'" )
	if ( _employment_type != "" && _employment_elem != undefined )
	{
%>
		<LI>Занятость: <b><%=_employment_elem.name%></b> </LI>	
<%
	}
	if ( _max_age != "" || _min_age != "" )
	{
%>
		<LI>Возраст: <b><%=_min_age != "" ? "от " + _min_age : ""%> <%= _max_age != ""  ? " до " + _max_age : ""%> лет</b> </LI>	
<%
	}
	if ( _min_wage != "" || _max_wage != "" )
	{
		_currency_elem = ArrayOptFind( lists.currency_types, "id=='" + _currency_type + "'" )
%>
		<LI>Доход: <b><%=_min_wage != "" ? "от " + _min_wage : ""%> <%=_max_wage != "" ? " до " + _max_wage : ""%> <%=(_currency_type != "" && _currency_elem != undefined )? _currency_elem.short_name : ""%></b> </LI>
<%
	}
%>
</UL>						
						
						
						</TD>
						
						
						<TD <%=_class%> valign=center>
						<form action="<%Request.Url%>" name="action_<%=_result.id%>" method="post"> 
							<a href="#" onclick="change_state('action_<%=_result.id%>', 'type_action_<%=_result.id%>')"><%= _result.is_active ? "Выключить рассылку": "Включить рассылку" %></a><br>
							<a href="view_doc.html?mode=vacancy_subscription&object_id=<%=_result.id%>&edit=1&doc_id=<%=curDocID%>">Редактировать подписку</a><br>
							<a href="view_doc.html?mode=vacancy_subscription&object_id=<%=_result.id%>&doc_id=<%=curDocID%>">Посмотреть подходящие вакансии</a><br>
							
						
							<a href="#" onclick="question('action_<%=_result.id%>', 'type_action_<%=_result.id%>')">Удалить
							<input type="hidden" name="vacancy_subscription_id" value="<%=_result.id%>"/> 
							<input type="hidden" name="type_action_<%=_result.id%>" value=""/> 
                        </form> 
						
						
						</TD>
						<TD <%=_class%>></TD>
					</TR>
					<tr>
						<td class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td>
						<td class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td>
						<td class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td>
						<td class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td>
						<td class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td>						
					</tr>
	
	<%
		}
	%>					
					
					
		</table>