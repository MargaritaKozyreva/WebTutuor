<%

	local_var_array = Array( "_key_word_in_name", "_key_word_in_fulltext", "_max_age", "_min_age", "_min_wage", "_max_wage", "_currency_type", "_min_exp_years", "_educ_type", "_employment_type" );
	form_property_array = Array( "key_word_in_name", "key_word_in_fulltext", "max_age", "min_age", "min_wage", "max_wage", "currency_type", "min_exp_years", "educ_type", "employment_type" );

	categ_array = Array();
	_prof_areas_str = "";
	_region_id =Int('0');
	if ( Request.QueryString.HasProperty("reset") && Request.QueryString.GetProperty("reset") == "1" )
	{
		//очистить все элементы формы
		i = 0;
		while ( i < ArrayCount( local_var_array ) )
		{
			eval( local_var_array[i] + ' = ""' )
			try
			{
				eval( 'Request.Form.' + form_property_array[i] + ' = ""' )
			}
			catch(err)
			{}
			i++;
		}
	}
	else
	{
		i = 0;
		while ( i < ArrayCount( local_var_array ) )
		{
			eval( local_var_array[i] + ' = ""' )
			try
			{
				eval( local_var_array[i] + ' = Request.Form.' + form_property_array[i] )
			}
			catch(err)
			{}
			i++;
		}
		
		
		
		try
		{
			_region_id = Int(Request.Form.region_id);
		}
		catch(err)
		{
		}

		
		if ( Request.Form.HasProperty("prof_areas_ids") && Request.Form.GetProperty("prof_areas_ids") != "" )
			categ_array = String(Request.Form.GetProperty("prof_areas_ids")).split(",");
		
		for ( _prof in categ_array )
		{
			_find = ArrayOptFind( lists.professional_areas, "id=='" + _prof +"'" );
			if ( _find != undefined )
				_prof_areas_str += _find.name + " | ";
		}
		/*
		for ( _prof_area in lists.professional_areas )
		{
			try
			{
				categ_array[ArrayCount(categ_array)] = eval( "(Request.Form.prof_area_" + _prof_area.id + ")")
				_prof_areas_str += _prof_area.name + " | ";
			}
			catch(err)
			{
				//alert("@@@@@" + err)
			}
				
		}
		*/
	}
	
	

	result_array = Array();
	try
	{
		Request.Form.init;
		result_array = XQuery("for $elem in vacancys where $elem/is_closed=false() return $elem");
		
		
		_temp_array = Array();
		if ( _key_word_in_name != "" )
		{
			for ( _key_word in UnifySpaces(_key_word_in_name).split(" ") )
			{
				alert(_key_word)
				sub_result_array = XQuery("for $elem in vacancys where contains($elem/name, '" + _key_word + "') and $elem/is_closed=false() return $elem");
				
				result_cross_array = Array();
				for ( _sub_res_elem in sub_result_array )
				{
					alert( _sub_res_elem.name )
					if ( ArrayOptFind( result_array, "id==" + _sub_res_elem.id ) != undefined )
						result_cross_array[ArrayCount(result_cross_array)] = _sub_res_elem;
				}
				_temp_array = ArrayUnion( _temp_array, result_cross_array );
			}
			result_array = _temp_array;
		}
		
		_temp_array = Array();
		if ( _key_word_in_fulltext != "" )
		{
			for ( _key_word in UnifySpaces(_key_word_in_fulltext).split(" ") )
			{
				sub_result_array = XQuery("for $elem in vacancys where doc-contains($elem/id, 'DefaultDb', '" + _key_word + "') and $elem/is_closed=false() return $elem");
				
				result_cross_array = Array();
				for ( _sub_res_elem in sub_result_array )
					if ( ArrayOptFind( result_array, "id==" + _sub_res_elem.id ) != undefined )
						result_cross_array[ArrayCount(result_cross_array)] = _sub_res_elem;
				_temp_array = ArrayUnion( _temp_array, result_cross_array );
			}
			result_array = _temp_array;
		}
		
		if ( _min_age != "" )
			result_array = ArrayUnion( ArraySelect( result_array, "min_age>=" + _min_age ), ArraySelect( result_array, "!min_age.HasValue" ));
		
		if ( _max_age != "" )
			result_array = ArrayUnion( ArraySelect( result_array, "max_age<=" + _max_age ), ArraySelect( result_array, "!max_age.HasValue" ));
	
		if ( _min_wage != "" )
			result_array = ArrayUnion( ArraySelect( result_array, "min_wage>=" + _min_wage ), ArraySelect( result_array, "!min_wage.HasValue" ));
			
		if ( _max_wage != "" )
			result_array = ArrayUnion( ArraySelect( result_array, "max_wage<=" + _max_wage ), ArraySelect( result_array, "!max_wage.HasValue" ));
		
		if ( _currency_type != "" )
			result_array = ArrayUnion( ArraySelect( result_array, "currency_type_id=='" + _currency_type + "'" ), ArraySelect( result_array, "!currency_type_id.HasValue" ));
			
		if ( _educ_type != "" )
			result_array = ArrayUnion( ArraySelect( result_array, "educ_type_id=='" + _educ_type + "'" ), ArraySelect( result_array, "!educ_type_id.HasValue" ));
			
		if ( _employment_type != "" )
			result_array = ArrayUnion( ArraySelect( result_array, "employment_type_id=='" + _employment_type + "'" ), ArraySelect( result_array, "!employment_type_id.HasValue" ));
			
		if ( _region_id != 0 )
		{
			_regions_array = XQuery('CatalogHierSubset( "regions", ' + Int(_region_id) + ' )');
			sub_result_array = ArrayUnion( ArraySelect( result_array, "region_id==" + Int(_region_id) ), ArraySelect( result_array, "!region_id.HasValue" ));
			for ( _region in _regions_array )
				sub_result_array = ArrayUnion( sub_result_array, ArraySelect( result_array, "region_id==" + _region.id ) );
			result_array = sub_result_array;
		}
		
		if ( ArrayCount( categ_array ) > 0 )
		{
			sub_result_array = ArraySelect( result_array, "!profession_area_id.HasValue" );
			for ( _prof_area in categ_array )
				if ( _prof_area != "" )
					sub_result_array = ArrayUnion ( sub_result_array, ArraySelect( result_array, "profession_area_id=='" + _prof_area + "'" ) )
			result_array = sub_result_array;
		}
		
		result_array = ArraySort( result_array, "creation_date", "-" )
		if ( Request.Form.HasProperty("sort_field") && Request.Form.GetProperty("sort_field") != "")
			result_array = ArraySort( result_array, Request.Form.GetProperty("sort_field"), Request.Form.HasProperty("sort_type") ? Request.Form.GetProperty("sort_type") : "+" );
		
	}
	catch(err)
	{
		alert(err)
	}
	
	
	
	function node_subdivision( _p_id, _p_name, _indent )
	{
		_cur_sub_array = XQuery( "for $obj in regions where $obj/parent_object_id = " + ( _p_id == null ? 'null()' : _p_id ) + " order by $obj/name return $obj" );

		for ( _cur_sub in _cur_sub_array )
		{
			_selected = ( _region_id == _cur_sub.id  ? " selected" : "");
		%>
			<option value="<%=_cur_sub.id%>" <%=_selected%>><%=( _indent + _cur_sub.name )%></option>
		<%
			node_subdivision( _cur_sub.id, _cur_sub.name, _indent + '&nbsp;&nbsp;&nbsp;&nbsp;' );
		}
	}
	
%>
<script language="javascript">
	
	function save()
	{
		//document.all["command"].value = 'save';
		document.all["search_vac_form"].submit();
	}
	
	function sort_result(_field_name)
	{
		document.getElementById("sort_field").value = _field_name;
		_old_value = document.getElementById("sort_type").value;
		document.getElementById("sort_type").value = ( _old_value == "+" ? "-" : "+" );
		document.all["search_vac_form"].submit();
	}
	
</script>

<form ACTION="<%=tools_web.get_query_string( true, "reset;")%>" name="search_vac_form" method="post">
	<input type="hidden" name="init" value="">
	
	<table width="100%"  border="0" cellspacing="1" cellpadding="3">
		<tr valign=top>
			<td width=260>
				<b>Ключевые слова в названии должности: &nbsp;&nbsp;&nbsp;</b> 
				<br>(слова разделяются пробелами)
			</td>
			<td>
				<input type="text" value="<%=_key_word_in_name%>" name="key_word_in_name" size="30"/> 
			</td>
	
			<td width=150>
				<b>Регион:&nbsp;&nbsp;&nbsp;</b>
			</td>
			<td>
				<select name="region_id">
					<option value=""></option>
					<%
						
						for (_region in XQuery("for $elem in regions where $elem/parent_object_id=null() order by $elem/name return $elem"))
						{
							_selected = ( (_region_id == _region.id)  ? " selected" : "");
							%>
								<option value="<%=_region.id%>" <%=_selected%>><%=( _region.name )%></option>
							<%
							node_subdivision( _region.id, _region.name, '&nbsp;&nbsp;&nbsp;&nbsp;' );
						}
						
					%>
				</select>
			</td>
		</tr>	
		<tr valign=top>	
			<td  width=260>
				<b>Ключевые слова в тексте вакансии:&nbsp;&nbsp;&nbsp; </b> 
				<br>(слова разделяются пробелами)
			</td>
			<td>
				<input type="text" value="<%=_key_word_in_fulltext%>" name="key_word_in_fulltext" size="30"/>
			</td>
	
			<td width=150>
				<b>Образование:&nbsp;&nbsp;&nbsp;</b>
			</td>
			<td>
				<select name="educ_type">
					<option value=""></option>
					<%
						
						for (_educ_type_elem in common.educ_types)
						{
							_selected = ( (_educ_type == _educ_type_elem.id)  ? " selected" : "");
							%>
								<option value="<%=_educ_type_elem.id%>" <%=_selected%>><%=( _educ_type_elem.name )%></option>
							<%
						}
						
					%>
				</select>
			</td>
		</tr>	
		<tr valign=top>	
			<td width=260>
				<b>Возраст:&nbsp;&nbsp;&nbsp;</b> 
			</td>
			<td>
				<input type="text" value="<%=_min_age%>" name="min_age" size="8" onchange="check_int(this);"/> <b>&nbsp;&nbsp;-&nbsp;&nbsp;</b> <input type="text" value="<%=_max_age%>" name="max_age" size="8" onchange="check_int(this);"/>
			</td>
	
			<td width=150>
				<b>Тип занятости:&nbsp;&nbsp;&nbsp;</b>
			</td>
			<td>
				<select name="employment_type">
					<option value=""></option>
					<%
						
						for (_employment_type_elem in common.employment_types)
						{
							_selected = ( (_employment_type == _employment_type_elem.id)  ? " selected" : "");
							%>
								<option value="<%=_employment_type_elem.id%>" <%=_selected%>><%=( _employment_type_elem.name )%></option>
							<%
						}
						
					%>
				</select>
			</td>
		</tr>	
		<tr valign=top>	
			<td width=260>
				<b>Уровень дохода:&nbsp;&nbsp;&nbsp;</b> 
			</td>
			<td>
				<input type="text" value="<%=_min_wage%>" name="min_wage" size="8" onchange="check_int(this);"/> <b>&nbsp;&nbsp;-&nbsp;&nbsp;</b> <input type="text" value="<%=_max_wage%>" name="max_wage" size="8" onchange="check_int(this);"/>
				<select name="currency_type">
					<option value=""></option>
					<%
						
						for (_currency in lists.currency_types)
						{
							_selected = ( (_currency_type == _currency.id)  ? " selected" : "");
							%>
								<option value="<%=_currency.id%>"<%=_selected%>><%=( _currency.id )%></option>
							<%
						}
						
					%>
				</select>
			</td>
	
			<td>
				
			</td>
			<td>
			
			</td>
		</tr>
	</table>
	
	
<br><br><br>
<b>Профессиональная область:&nbsp;&nbsp;&nbsp;</b> <%=_prof_areas_str%>
<br>

<SCRIPT LANGUAGE="JavaScript">
<!--//
	function check_all (_checked)
	{
		prof_areas_str = "";
<%
		for ( _prof_area in lists.professional_areas )
		{
%>
			document.getElementById("prof_area_<%=_prof_area.id%>").checked = _checked;
			prof_areas_str = prof_areas_str + "<%=_prof_area.id%>,";
<%
			
		}
%>
		if ( _checked )
			document.getElementById("prof_areas_ids").value = prof_areas_str;
		else
			document.getElementById("prof_areas_ids").value = "";
	}
	
	function prof_area_select( _value, _checked, _name )
	{
		
		_curr_value = document.getElementById("prof_areas_ids").value;
		if ( _checked )
		{
			_new_value = _curr_value + _value + ",";
		}
		else
		{
			_index = _curr_value.indexOf(_value);
			part1 = _curr_value.slice( 0, _index );
			part2 = _curr_value.slice( _index + 1 + _value.length );
			if ( _index >= 0 )
				_new_value = part1 + part2;
		}
		document.getElementById("prof_areas_ids").value = _new_value;
	}
	
	function hide_show( _value )
	{

		elem_show_block = document.getElementById("show_block");
		elem_block = document.getElementById("prof_areas_block");
		if ( elem_show_block.value == "1" )
			elem_show_block.value = "0";
		else
			elem_show_block.value = "1";
		
		if ( elem_show_block.value == "1" )
			elem_block.style.display = 'inline';
		else
			elem_block.style.display = 'none';
		return false;
		
	}
	
	function check_int( _object )
	{
		var re = new RegExp( "^[0-9]*$" );
		if ( _object.value != '' && _object.value.match(re) == null )
		{
			alert( "Введите целое число" );
			_object.value = "";
			return;
		}
	}
//-->
</SCRIPT>
<%
_selected_flag_all = "";
if ( Request.Form.HasProperty( "all_prof_area" ) )
	_selected_flag_all = " checked";
%>
<table width="100%" border="0">
  <tr>
<%

	if ( Request.Form.HasProperty("show_block") && Request.Form.GetProperty("show_block") == "1" )
		_prof_block_enable = true;
	else
		_prof_block_enable = false;
	_prof_block_display = _prof_block_enable ? "inline" : "none";
%>
    <!--<td align="right"><a href="<%=tools_web.get_query_string( true, "prof_block_enable;")%>prof_block_enable=<%=!_prof_block_enable%>"><%=_prof_block_enable ? "Скрыть" : "Показать" %></a></td> 
	
	
    <input type=button onclick="hide_show( this.value)" value='<%=_prof_block_enable ? "Скрыть блок выбора профессии" : "Показать блок выбора профессии" %>' name="button_show_hide">
	<br>-->
	<td align="right">
	<a onclick="hide_show( this.value)" href="#">Скрыть/показать блок выбора профессии</a>
	</td>
  </tr>
</table>
<input type=hidden name="show_block" id="show_block" value="<%=Request.Form.HasProperty('show_block') ? Request.Form.GetProperty('show_block') : '0'%>">
<input type="hidden" size=200 name="prof_areas_ids" id="prof_areas_ids" value="<%=Request.Form.HasProperty('prof_areas_ids') ? Request.Form.GetProperty('prof_areas_ids') : ''%>"><br>

<input type=hidden name="sort_field" id="sort_field" value="<%=Request.Form.HasProperty('sort_field') ? Request.Form.GetProperty('sort_field') : 'name'%>">
<input type=hidden name="sort_type" id="sort_type" value="<%=Request.Form.HasProperty('sort_type') ? Request.Form.GetProperty('sort_type') : '+'%>">
<input type=hidden name="num_elem_in_page" value="<%=Request.Form.HasProperty('num_elem_in_page') ? Request.Form.GetProperty('num_elem_in_page') : '50'%>">

<div id="prof_areas_block" style="display: <%=_prof_block_display%>">
				
<input type="checkbox" name="all_prof_area" value="1"<%=_selected_flag_all%> onClick="check_all(this.checked)"><br>
					<%
					for ( _prof_area in ArraySort( lists.professional_areas, "name", "+" ) )
					{
						
						_selected_flag="";
						
						if ( (ArrayOptFind( categ_array, "This=='" + _prof_area.id + "'" )) != undefined ) 
							_selected_flag=" checked";
						%>
						
						<input type="checkbox" name="prof_area_<%=_prof_area.id%>" id="prof_area_<%=_prof_area.id%>" value="<%=_prof_area.id%>"<%=_selected_flag%> onclick="prof_area_select( this.value, this.checked, '<%=_prof_area.name%>' )"><%=_prof_area.name%><br>
						<%
					}
					%>
</div>
	<p><center><input type="button" value="Найти вакансии" class="inputButton" onClick="save();" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';"> &nbsp;&nbsp;&nbsp;
	<a href="<%=tools_web.get_query_string( true, "reset;")%>reset=1">Очистить форму</a>
	
	<%
	//alert( tools_web.get_query_string( true, "reset;") )
	%>
	
	</center></p>
	
</form>


	<table width="100%"  border="0" cellspacing="0" cellpadding="3">
					<tr>
						<td class="tableHeaderWithText">&nbsp;</td>
						<td class="tableHeaderWithText" width="20%"><a href="<%=Request.Url%>#" onclick="sort_result( 'name' )"><%=tools.get_web_str('c_name')%></a></td>
						<td class="tableHeaderWithText"><a href="<%=Request.Url%>#" onclick="sort_result( 'profession_area_id' )">Проф.область</a></td>

						<td class="tableHeaderWithText"><a href="<%=Request.Url%>#" onclick="sort_result( 'avg_wage' )">Доход</a></td>
						<td class="tableHeaderWithText"><a href="<%=Request.Url%>#" onclick="sort_result( 'region_id' )">Регион</a></td>
						<td class="tableHeaderWithText"><a href="<%=Request.Url%>#" onclick="sort_result( 'employment_type_id' )">Тип занятости</a></td>						
						<td class="tableHeaderWithText"><a href="<%=Request.Url%>#" onclick="sort_result( 'creation_date' )">Дата публикации</a></td>						
						<td class="tableHeaderWithText">&nbsp;</td>
					</tr>
					<tr>
						<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="1" height="1" /></td>				
						<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="1" height="1" /></td>
						<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="1" height="1" /></td>
						<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="1" height="1" /></td>
						<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="1" height="1" /></td>
						<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="1" height="1" /></td>	
						<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="1" height="1" /></td>	
						<td class="tableHeaderNoText"><img src="pics/1blank.gif" width="1" height="1" /></td>	
					</tr>
	<%
		counter = 0;
		for ( _result in result_array  )
		{
			_class = counter++ % 2 ? 'tableRowEven' : 'tableRowOdd';
	%>
				<TR VALIGN="MIDDLE">					
						<TD class="<%=_class%>">&nbsp;</TD>
						<TD class="<%=_class%>"><a HREF="view_doc.html?mode=vacancy_estaff&object_id=<%=_result.id%>&doc_id=<%=curDocID%>"><%=_result.name%></a></TD>
						<TD class="<%=_class%>"><%=_result.profession_area_id.HasValue ? _result.profession_area_id.OptForeignElem.name : ""%></TD>
						<TD class="<%=_class%>"><%=_result.min_wage.HasValue ? "от " + _result.min_wage + " " : ""%><%=_result.max_wage.HasValue ? " до " + _result.max_wage + " " : ""%>
						<%=( (_result.max_wage.HasValue || _result.min_wage.HasValue) && _result.currency_type_id.HasValue )? " " + _result.currency_type_id.OptForeignElem.short_name : ""%>
						</TD>
						<TD class="<%=_class%>">
						<%
							if ( _result.region_id.HasValue )
								try
								{
									regionDoc = OpenDoc( UrlFromDocID( _result.region_id )  ).TopElem;
									Response.Write( regionDoc.name )
								}
								catch(err)
								{}
						%></TD>
						<TD class="<%=_class%>"><%=_result.employment_type_id.HasValue ? _result.employment_type_id.OptForeignElem.name : ""%></TD>
						<TD class="<%=_class%>"><%=_result.creation_date%></TD>
						<TD class="<%=_class%>"></TD>
					</TR>
	
	<%
		}
	%>
	
				<tr>
						<td class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td>
						<td class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td>
						<td class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td>
						<td class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td>
						<td class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td>
						<td class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td>
						<td class="tableFooter"><img src="pics/1blank.gif" width="1" height="1" /></td>						
					</tr>
		</table>