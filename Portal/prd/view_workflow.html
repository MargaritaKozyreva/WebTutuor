<%
curWorkflow = OpenDoc( UrlFromDocID( curObject.workflow_id ) ).TopElem;

_eval_custom_str = '';
_custom_state = curObject.workflow_custom_states.GetOptChildByKey( curObject.workflow_state );
if ( _custom_state != undefined )
	_eval_custom_str = _custom_state.condition_eval_str;

if ( ( _eval_custom_str != '' && eval( _eval_custom_str ) ) || ! curWorkflow.condition_eval_str.HasValue || eval( curWorkflow.condition_eval_str ) )
{		
%>
<script language="javascript">
function doSubmit_wf( action )
{
	document.getElementById( 'action_id' ).value = action;
	document.workflow_process.submit();
}
function set_foreign_elem_field(_name,_catalog,_value)
{
	var pars=new Object();
	var strAttr='status:no;dialogWidth:780px;dialogHeight:550px;help:no;resizable:1';
	pars.element_id = _value;			
	pars.can_be_empty = true;
	pars.show_all = true;
	
	xShowModalDialog('dlg_select.html?doc_id=<%=curDocID%>&catalog_name='+ _catalog +'&typein=0&multi_select=0&rand='+Math.random(),pars,strAttr);
	if ( ! pars.handle ) 
		return null;
	
	document.getElementById(_name).value = pars.element_id;
	document.getElementById(_name+'_disp').value = pars.element_name;
}
</script>

<form action="workflow_process.html" name="workflow_process" id="workflow_process_form" method="POST" enctype="multipart/form-data">
<input type="hidden" name="doc_id" value="<%=curDocID%>"/>
<input type="hidden" name="object_id" value="<%=curObjectID%>"/>
<input type="hidden" name="action_id" id="action_id" value=""/>
<input type="hidden" name="mode" value="<%=curMode%>"/>
<input type="hidden" name="stage_max_num" value="0"/>
<input type="hidden" name="person_max_num" value="0"/>

<div class="headerText" style="margin-top:10px;margin-bottom:5px;margin-left:5px;"><%=tools.get_web_str('vw_title')%></div>

<table width="100%" cellspacing="5" cellpadding="0">
 	<tr>
		<td align="CENTER">
		
		<table width="100%" border="0" cellspacing="0" cellpadding="0" class="activator">
			<tr>
				<td align="CENTER" class="activator">
<%
		for ( _action in curWorkflow.actions )
		{
			if ( _action.condition_eval_str == '' || eval( _action.condition_eval_str ) )
			{
				if ( ArrayOptFind( _action.operations, "type=='set_workflow_custom_state'" ) != undefined )
				{
%>
<style>
.custom_stage_table {
	border-right: #d3d3d3 1px solid; border-top: #d3d3d3 1px solid; border-left: #d3d3d3 1px solid; border-bottom: #d3d3d3 1px solid;
}
.custom_stage_cell {
	border-right: #ffffff 0px solid; border-top: #ffffff 0px solid; border-left: #ffffff 0px solid; border-bottom: #ffffff 0px solid;
}
</style>
<script language="javascript">
var stageCounter = 0;
var personCounter = 0;
var _stage_body = null;

function start_init()
{

<%
	for ( _custom_state in curObject.workflow_custom_states )
	{
%>
_stage_body = addCustomStage( "<%=HtmlEncode( _custom_state.name )%>" );
<%
		for ( _condition in _custom_state.conditions )
		{
%>
addCustomStagePerson( _stage_body, stageCounter, "<%=_condition.person_id%>", "<%=HtmlEncode( _condition.person_id.ForeignElem.fullname )%>" );
<%
		}
	}
%>
}
function addCustomStage( _name )
{
	var _table = document.getElementById("table_workflow_custom_stages");	
	stageCounter++;
	var _stage_id = "custom_stage_" + stageCounter;
	
	var _tr = document.createElement('<TR id="tr_' + _stage_id + '">');	
	
	var _td = document.createElement("TD");
	_tr.insertAdjacentElement('beforeEnd',_td);

	var _table_stage = document.createElement('<TABLE id="' + _stage_id + '" width="100%" border="1" cellspacing="0" cellpadding="3" class="custom_stage_table"/>');
	_td.insertAdjacentElement('beforeEnd',_table_stage);
	
	var _table_stage_body = document.createElement('<TBODY id="body_' + _stage_id + '">');
	_table_stage.insertAdjacentElement('beforeEnd',_table_stage_body);
	
	/////////////////////////
	var _tr_buttons = document.createElement("TR");
	_table_stage_body.insertAdjacentElement('beforeEnd',_tr_buttons);
	
	var _td_buttons = document.createElement('<TD class="custom_stage_cell">');
	_tr_buttons.insertAdjacentElement('beforeEnd',_td_buttons);	
	_td_buttons.insertAdjacentElement('beforeEnd',document.createElement('<input type="button" value="<%=tools_web.get_web_str('c_delete')%>" class="inputButton" onclick="delRow(\'tr_'+_stage_id+'\');" onmouseover="this.className=\'inputButtonOver\';" onmouseout="this.className=\'inputButton\';"/>'));
	
	var _td_buttons2 = document.createElement('<TD class="custom_stage_cell">');
	_tr_buttons.insertAdjacentElement('beforeEnd',_td_buttons2);	
	_td_buttons2.insertAdjacentElement('beforeEnd',document.createElement('<input type="button" value="<%=tools_web.get_web_str('vw_add_reconciler')%>" class="inputButton" onclick="addCustomStagePerson(\'body_'+_stage_id+'\',' + stageCounter + ');" onmouseover="this.className=\'inputButtonOver\';" onmouseout="this.className=\'inputButton\';"/>'));
	
	//////////////////////////
	var _tr_input = document.createElement("TR");
	_table_stage_body.insertAdjacentElement('beforeEnd',_tr_input);
	
	var _td_input_name = document.createElement('<TD class="custom_stage_cell">');
	_tr_input.insertAdjacentElement('beforeEnd',_td_input_name);
	_td_input_name.innerHTML = "<%=tools_web.get_web_str('c_name')%>:";
	
	var _td_input = document.createElement('<TD class="custom_stage_cell">');
	_tr_input.insertAdjacentElement('beforeEnd',_td_input);	
	_td_input.insertAdjacentElement('beforeEnd',document.createElement('<INPUT type="text" class="inputEdit" size="60" id="stage_name_' + stageCounter + '" name="stage_name_' + stageCounter + '" value="' + ( _name != undefined ? _name : '' ) + '"/>'));
	

	_table.insertAdjacentElement('beforeEnd',_tr);
	
	document.workflow_process.stage_max_num.value = stageCounter;
	return 'body_' + _stage_id;
}
function addCustomStagePerson( _tbody_id, _stage_num, _rerson_id, _person_fullname )
{
	var _table = document.getElementById(_tbody_id);
	personCounter++;
	var _pers_id = "custom_pers_" + personCounter;

	if ( _rerson_id == undefined )
	{
		var pars=new Object();
		var strAttr="status:no;dialogWidth:700px;dialogHeight:550px;help:no;resizable:1";
		
		xShowModalDialog('dlg_select.html?catalog_name=collaborator&doc_id=<%=curDocID%>&typein=1&rand='+ Math.random(), pars, strAttr);
		if ( ! pars.handle ) 
			return null;
			
		_rerson_id = pars.element_id;
		_person_fullname = "" + pars.element_name;
	}
		
	var _stage_name = document.getElementById("stage_name_"+_stage_num);
	if ( _stage_name.value == "" )
		_stage_name.value = "<%=tools_web.get_web_str('vw_reconciler')%> " + _person_fullname;		
	
	
	var _tr = document.createElement('<TR id="' + _pers_id + '">');
	
	_tr.insertAdjacentElement('beforeEnd',document.createElement('<INPUT type="hidden" name="stage_' + _stage_num + '_person_' + personCounter + '" value="' + _rerson_id + '"/>'));
	
	var _td_name = document.createElement('<TD class="custom_stage_cell">');
	_tr.insertAdjacentElement('beforeEnd',_td_name);
	_td_name.innerHTML = "<%=tools_web.get_web_str('vw_reconciler')%>:";
		
	var _td = document.createElement('<TD class="custom_stage_cell">');
	_tr.insertAdjacentElement('beforeEnd',_td);
	_td.innerHTML = _person_fullname;
	
	var _td_del = document.createElement('<TD class="custom_stage_cell">');
	_tr.insertAdjacentElement('beforeEnd',_td_del);
	
	_td_del.insertAdjacentElement('beforeEnd',document.createElement('<input type="button" value="<%=tools_web.get_web_str('c_delete')%>" class="inputButton" onclick="delRow(\''+_pers_id+'\');" onmouseover="this.className=\'inputButtonOver\';" onmouseout="this.className=\'inputButton\';"/>'));
	
	
	_table.insertAdjacentElement('beforeEnd',_tr);
	
	document.workflow_process.person_max_num.value = personCounter;
}
function delRow( _tr_id )
{
	var _tr = document.getElementById(_tr_id);
	_tr.parentNode.removeChild(_tr);
}

</script>
					<input type="button" value="<%=tools_web.get_web_str('vw_set_custom_states')%>" class="inputButton" onclick="addCustomStage();" onmouseover="this.className='inputButtonOver';" onmouseout="this.className='inputButton';">
<%
				}
%>
					<input type="button" value="<%=HtmlEncode( tools_web.get_cur_lng_name( _action.name ) )%>" class="inputButton" onclick="doSubmit_wf('<%=_action.code%>');" onmouseover="this.className='inputButtonOver';" onmouseout="this.className='inputButton';">
<%
			}
		}
%>					
				</td>
			</tr>
		</table>
		
		</td>
	</tr>
	<tr>
		<td>
		
		<table width="100%" border="0" cellspacing="5" cellpadding="0">
			<tbody id="table_workflow_custom_stages">
			</tbody>
		</table>
		
		</td>
	</tr>
<script language="javascript">
try
{ 
	start_init();
}
catch(e)
{}
</script>
	<tr>
		<td>
		
		<table width="100%" border="0" cellspacing="0" cellpadding="4" class="tableBorder">
<%
	for ( _group in curWorkflow.field_groups )
	{
		if ( _group.read_conditions.condition_eval_str == '' || eval( _group.read_conditions.condition_eval_str ) )
		{
			for ( _field in ArraySelectByKey( curWorkflow.workflow_fields, _group.code, 'field_group_id' ) )
			{
				_value = '';
				_value_str = '';
				try
				{
					_value = curObject.workflow_fields.GetChildByKey( _field.name ).value;
				}
				catch ( err )
				{
				}
				if ( _value != '' )
				{
					try
					{
						_disp_name = curLngCommon.exchange_object_types.GetChildByKey( _field.catalog ).disp_name;
						_value_str = eval( 'OpenDoc( UrlFromDocID( ' + _value + ' ) ).TopElem.' + _disp_name );
					}
					catch ( err )
					{
						_value_str = tools.get_web_str('c_deleted');
					}
				}
				
				if ( _group.write_conditions.condition_eval_str == '' || eval( _group.write_conditions.condition_eval_str ) )
				{
				
				_tooltip=''
				try
				{
					_tooltip =_field.tooltip;
				}
				catch ( err )
				{
				}
	
				if (_tooltip!='')
				{
					_tooltip='title="'+HtmlEncode(_tooltip)+'"'
				}
	
		switch ( _field.type )
		{
			case 'heading':
%>
			<tr> 
				<td align="center" colspan="2"><%=tools_web.get_cur_lng_name( _field.title )%></td>
			</tr>
<%
				break;
			
			case 'bool':
%>
			<tr> 
				<td width="160">&nbsp;</td>
				<td><input type="checkbox" <%=_tooltip%> name="<%=_field.name%>" <%=( _value == 'true' ? 'checked="checked"' : '' )%>/><b><%=tools_web.get_cur_lng_name( _field.title )%></b></td>
			</tr>
<%		
				break;
				
			case 'file':
%>
			<tr> 
				<td width="140" valign="top" align="RIGHT"><%=tools_web.get_cur_lng_name( _field.title )%>:</td>
				<td><input type="file" <%=_tooltip%> name="<%=_field.name%>" id="<%=_field.name%>"/></td>
			</tr>
<%		
				break;
				
			case 'combo':
%>
			<tr> 
				<td width="160" valign="top" align="RIGHT"><%=tools_web.get_cur_lng_name( _field.title )%>:</td>
				<td><select <%=_tooltip%> name="<%=_field.name%>">
					 <option value=""></option>
<%
				for ( _entry in _field.entries )
				{
%>
                            <option value="<%=HtmlEncode( _entry.value )%>"><%=_entry.value%></option>
<%
				}
%>
			 		</select>
<script language="JavaScript">
selcur=document.forms['workflow_process'].elements['<%=_field.name%>'];
selcur.selectedIndex==-1;
for (i=0;i<selcur.options.length;i++)
    if (selcur.options[i].value=="<%=_value%>")
    {
        selcur.selectedIndex=i;
        break;
    }
</script> 
				  </td>
			</tr>					
<%		
				break;
				
			case 'text':
%>
			<tr> 
				<td width="160" valign="top" align="RIGHT"><%=tools_web.get_cur_lng_name( _field.title )%>:</td>
				<td align="LEFT">
					<textarea <%=_tooltip%> name="<%=_field.name%>" rows="5" cols="60"><%=_value%></textarea>
				</td>
			</tr>
<%
				break;
				
			case 'string':
%>
			<tr> 
				<td width="160" valign="top" align="RIGHT"><%=tools_web.get_cur_lng_name( _field.title )%>:</td>
				<td align="LEFT">
					<input type="text" <%=_tooltip%> name="<%=_field.name%>" value="<%=HtmlEncode( _value )%>"  size="60" class="inputEdit"/>
				</td>
			</tr>
<%
				break;
				
			case 'foreign_elem':
%>
			<tr> 
				<td width="160" valign="top" align="RIGHT"><%=tools_web.get_cur_lng_name( _field.title )%>:</td>
				<td align="LEFT">
					<input type="hidden" name="<%=_field.name%>" id="<%=_field.name%>" value="<%=_value%>"/>
					<input type="text" <%=_tooltip%> name="<%=_field.name%>_disp" id="<%=_field.name%>_disp" value="<%=HtmlEncode( _value_str )%>" size="60" class="inputEdit" readonly="1"/>&nbsp;<input type="button" value="<%=tools.get_web_str('c_choose')%>" class="inputButton" onMouseOver="this.className='inputButtonOver';" onMouseOut="this.className='inputButton';" onclick="set_foreign_elem_field('<%=_field.name%>','<%=_field.catalog%>','<%=_value%>')"/>
				</td>
			</tr>
<%
				break;
				
			default:		
%>						
			<tr> 
				<td width="160" align="RIGHT"><%=tools_web.get_cur_lng_name( _field.title )%>:</td>
				 <td align="LEFT">
						<input type="text" <%=_tooltip%> name="<%=_field.name%>" value="<%=HtmlEncode( _value )%>" size="30" class="inputEdit" >
				</td>
			</tr>
<%
		}
				}
				else
				{
					if ( _field.type == 'foreign_elem' )
						_value = _value_str;
%>
			<tr> 
				<td width="160" align="RIGHT"><%=tools_web.get_cur_lng_name( _field.title )%>:</td>
				<td align="LEFT" style="font-weight:normal"><%=_value%></td>
			</tr>
<%				
				}
			}
		}
	}
	
%>						
		</table>
			
		</td>
	</tr>
</table>	
</form>
<%
}
%>