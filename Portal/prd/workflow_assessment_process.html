<%
Server.Execute( "include/user_init.html" );

curObjectID = Int( Request.Form.object_id );
curObjectDoc = OpenDoc( UrlFromDocID( curObjectID ) );
curObject = curObjectDoc.TopElem;
curWorkflow = OpenDoc( UrlFromDocID( curObject.workflow_id ) ).TopElem;
_old_state = String(curObject.workflow_state);
curPAID = ( Request.Form.HasProperty("pa_id") ?  Int( Request.Form.pa_id ) : undefined);

is_post = ( Request.Form.HasProperty("is_post") ?   Request.Form.is_post : "");

BRUTE_MESSAGE = "";

if (curPAID != undefined)
{
	try
	{
		curPADoc = OpenDoc(UrlFromDocID( curPAID ));
	}
	catch(_hoho_)
	{
		curPADoc = undefined;
	}
}
else
{
	curPADoc = undefined;
}
_temp_assessment_plan = undefined;
curAssessmentPlan = curObject;
curAssessmentPlanID = curObjectID;

curAssessmentAppraiseID = curAssessmentPlan.assessment_appraise_id;
curAssessmentAppraise = OpenDoc(UrlFromDocID( curAssessmentAppraiseID )).TopElem;

	/* ---=== IMPERSONATE BLOCK ===--- */	
	try
	{
		Session.ImpersonatePersonID = Int(Session.ImpersonatePersonID);
	}
	catch(_no_trace_)
	{
		Session.ImpersonatePersonID = null;
	}
	arrImpersonates = ArraySelect(curAssessmentAppraise.impersonate_persons, "impersonator_id == " + curUserID + " && face_person_id.HasValue && (from_date.HasValue == false || from_date <= DateNewTime(Date())) && (to_date.HasValue == false || to_date >= DateNewTime(Date()))");
	
	if (Session.ImpersonatePersonID != null && ArrayOptFind(arrImpersonates, "face_person_id == " + Session.ImpersonatePersonID) != undefined)
		_bIsFakePerson = true;
	else
		_bIsFakePerson = false;
	
	if (_bIsFakePerson)
	{
		curPersonID = Session.ImpersonatePersonID;
		curPerson = OpenDoc(UrlFromDocID(curPersonID)).TopElem;
		Session.ImpersonatePersonID = curPersonID;
	}
	else
	{
		curPersonID = curUserID;
		curPerson = curUser;
		Session.ImpersonatePersonID = null;
	}
	
	/* ---=== ================= ===--- */

if (Request.Form.HasProperty("cur_comment") )
	COMMENT = Request.Form.GetProperty("cur_comment")
else
	COMMENT = null;

_submit_flag = curWorkflow.auto_submit_fields;
if ( Request.Form.action_id != '' )
{
	curAction = curWorkflow.actions.GetChildByKey( Request.Form.action_id );
	for ( _operation in curAction.operations )
		if ( _operation.type == 'submit_fields' )
			_submit_flag = true;
}
else
{
	curAction = '';
}

if (curAction != '')
if (global_settings.settings.check_wf_access_assessment)
{
	Server.Execute( "view_assessment_access_variables.html" );
	
	if ( curAction.condition_eval_str != '' && !(eval( curAction.condition_eval_str)) )
	{
		Response.Redirect( "view_doc.html" );
		Cancel();
	}	
}


if ( _submit_flag )
{	

	_counter = 0;
	try
	{
		for ( _group in curWorkflow.field_groups )
			if ( _group.read_conditions.condition_eval_str == '' || eval( _group.read_conditions.condition_eval_str ) )
				if ( _group.write_conditions.condition_eval_str == '' || eval( _group.write_conditions.condition_eval_str ) )
					for ( _field in ArraySelect( curWorkflow.workflow_fields, 'field_group_id == _group.code' ) )
						try
						{
							_value = eval( 'Request.Form.' + _field.name );
							
							if ( _field.type == 'bool' )
								_value = 'true';
							
							if ( _value != '' )
							{
								curObject.workflow_fields.ObtainChildByKey( _field.name ).value = _value;
								_counter++;
							}
						}
						catch ( ee )
						{
						}
	}
	catch ( e )
	{
	}
}

if ( curAction != '' )
{
	tools.workflow_action_process( curObjectDoc, Request.Form.action_id, curObject.workflow_id, curWorkflow, curPAID );
}

curObjectDoc.Save();

//Response.Redirect( 'view_doc.html?mode=assessment_appraise&doc_id=' + Request.Form.doc_id +'&assessment_appraise_id=' + Request.Form.assessment_appraise_id );

curDocID = Request.Form.doc_id;


_href = 'view_doc.html?mode=assessment_appraise&doc_id=' + curDocID + '&f_id=' + Random(0,9999999999) + '&assessment_appraise_id=' + Request.Form.assessment_appraise_id + '&f_id='  + Random(0,999999999) +  '&is_post=1&wfbutt=' + _old_state;

if (curPADoc != undefined)
{
	_href = _href + '&pa_id=' + curPAID + '&assessment_appraise_type=' + curPADoc.TopElem.assessment_appraise_type;
}

Session.assessment_save_msg = BRUTE_MESSAGE;

//Response.Redirect( _href );

%>

<script language="javascript">
	<!--
		document.location.href="<%=_href%>";
	-->
</script>
