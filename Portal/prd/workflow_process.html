<%
Server.Execute( "include/user_init.html" );

curObjectID = Int( Request.Query.object_id );
curObjectDoc = OpenDoc( UrlFromDocID( curObjectID ) );
curObject = curObjectDoc.TopElem;
curWorkflow = OpenDoc( UrlFromDocID( curObject.workflow_id ) ).TopElem;

_submit_flag = curWorkflow.auto_submit_fields;
if ( Request.Form.action_id != '' )
{
	curAction = curWorkflow.actions.GetChildByKey( Request.Form.action_id );
	if ( ! _submit_flag )
	    _submit_flag = ArrayOptFindByKey( curAction.operations, 'submit_fields', 'type' ) != undefined;
}
else
{
	curAction = '';
}

if ( _submit_flag )
{
	_counter = 0;
	try
	{
		for ( _group in curWorkflow.field_groups )
			if ( _group.read_conditions.condition_eval_str == '' || eval( _group.read_conditions.condition_eval_str ) )
				if ( _group.write_conditions.condition_eval_str == '' || eval( _group.write_conditions.condition_eval_str ) )
					for ( _field in ArraySelect( curWorkflow.workflow_fields, 'field_group_id == _group.code' ) )
						try
						{
							if ( _field.type == 'bool' )
							{
								_value = ( Request.Form.HasProperty( _field.name ) ? 'true' : 'false' );
							}
							else if ( _field.type == 'file' )	
							{
								_ref = Request.Form.GetProperty( _field.name );
								if ( ! _ref.FileName.HasValue )
									continue;
									
								doc = OpenNewDoc( 'x-local://wtv/wtv_resource.xmd' );
								doc.BindToDb( DefaultDb );
								doc.TopElem.put_str( _ref, _ref.FileName, curObject );
								_value = doc.DocID;
							}
							else			
							{
								switch(curHostSettings.default_portal_type)
								{
									case 'sharepoint':
										_value =  DecodeCharset( Request.Form.GetProperty( _field.name ) , 'utf-8' );
										break;
									default:
										_value =  Request.Form.GetProperty( _field.name );
								}
							}
							
							curObject.workflow_fields.ObtainChildByKey( _field.name ).value = _value;
							_counter++;
						}
						catch ( ee )
						{
							alert( ee );
						}
	}
	catch ( e )
	{
	    alert( e );
	}
}

if ( curAction != '' )
{
	_log_entry = curObject.workflow_log_entrys.AddChild();
	_log_entry.create_date = Date();
	_log_entry.action_id = curAction.PrimaryKey;
	_log_entry.person_id = curUserID;
	_log_entry.person_fullname = curUser.fullname;
	_log_entry.begin_state = curObject.workflow_state;
	_log_entry.submited = _submit_flag;
	
	tools.workflow_action_process( curObjectDoc, Request.Form.action_id, curObject.workflow_id, curWorkflow );
	
	_log_entry.finish_state = curObject.workflow_state;
}

curObjectDoc.Save();

curDocID = Request.Form.doc_id;
%>
<script language="javascript">
	document.location.href="view_doc.html?mode=requests_work&doc_id=<%=curDocID%>";
</script>