<%

// build 20090917
// v.2.6+

//  alert("In API");
//  alert( GetSysUserName() );
     _error = 0;
	Response.WriteMode = "single";
	Server.Execute( "include/user_init.html" );


	_response_text = new Binary;
	_response_text.AssignStr( "<?xml version=\"1.0\" encoding=\"windows-1251\"?><response>" );

    sObjectDeleted = "Объект удален из базы";
    sEId = "";
    sAction = "view";
    sLayout = "summary";
    sObjectType = "all";
    sState = "active";
    sFilter = "all";
    sPerson = "me";
    sMenu = "my_active_all";
    sSort = "";
    sOrder = "1";
    sReqId = "";
    sRespId = "";
//    alert("start");


    try {	sEId = String( Request.QueryString.eid ).toLowerCase(); }                   catch(e) {}
    try {	sAction = String( Request.QueryString.action ).toLowerCase(); }             catch(e) {}
    try {	sLayout = String( Request.QueryString.layout ).toLowerCase(); }             catch(e) {}
    try {	sObjectType = String( Request.QueryString.object_type ).toLowerCase(); }    catch(e) {}
    try {	sState = String( Request.QueryString.state ).toLowerCase(); }               catch(e) {}
    try {	sFilter = String( Request.QueryString.filter ).toLowerCase(); }             catch(e) {}
    try {	sPerson = String( Request.QueryString.person ).toLowerCase(); }             catch(e) {}
    try {	sMenu = String( Request.QueryString.menu ).toLowerCase(); }                 catch(e) {}
    try {	sSort = String( Request.QueryString.sort ).toLowerCase(); }                 catch(e) {}
    try {	sOrder = String( Request.QueryString.order ).toLowerCase(); }               catch(e) {}
    try {	sRespId = String( Request.QueryString.resp_id ).toLowerCase(); }            catch(e) {}
    try {	sReqId = String( Request.QueryString.req_id ).toLowerCase(); }              catch(e) {}

    if(sEId!="")
    {
        iEId = Int ( sEId );
    }
    else
    {
        iEId = 0;
    }
    if(sRespId!="")
    {
        iRespId = Int ( sRespId );
    }
    else
    {
        iRespId = 0;
    }
    if(sReqId!="")
    {
        iReqId = Int ( sReqId );
    }
    else
    {
        iReqId = 0;
    }


function Validate(oTarget)
{
    try
    {
        if(oTarget==null) return "";
        return oTarget!="" ? oTarget : "";
    }
    catch(e)
    {
        return "";
    }
}

function CreateMenu()
{
    _response_text.AppendStr("<menu>");

        _response_text.AppendStr("<item isheader=\"1\" islink=\"0\" isselected=\"0\">");
            _response_text.AppendStr("<id>personal</id>");
            _response_text.AppendStr("<name>Мое обучение</name>");
            _response_text.AppendStr("<url></url>");

            if(sMenu == "my_active_all")
            {
                _response_text.AppendStr("<item isheader=\"0\" islink=\"1\" isselected=\"1\">");
            }
            else
            {
                _response_text.AppendStr("<item isheader=\"0\" islink=\"1\" isselected=\"0\">");
            }
            _response_text.AppendStr("<id>my_active_all</id>");
            _response_text.AppendStr("<name>Мой план обучения</name>");
            _response_text.AppendStr("<url>layout=summary&amp;object_type=all&amp;state=active&amp;filter=all&amp;person=me</url>");
            _response_text.AppendStr("</item>");

            if(sMenu == "my_active_courses")
            {
                _response_text.AppendStr("<item isheader=\"0\" islink=\"1\" isselected=\"1\">");
            }
            else
            {
                _response_text.AppendStr("<item isheader=\"0\" islink=\"1\" isselected=\"0\">");
            }
            _response_text.AppendStr("<id>my_active_courses</id>");
            _response_text.AppendStr("<name>Мои курсы</name>");
            _response_text.AppendStr("<url>layout=list&amp;object_type=course&amp;state=active&amp;filter=all&amp;person=me</url>");
            _response_text.AppendStr("</item>");

            if(sMenu == "my_active_tests")
            {
                _response_text.AppendStr("<item isheader=\"0\" islink=\"1\" isselected=\"1\">");
            }
            else
            {
                _response_text.AppendStr("<item isheader=\"0\" islink=\"1\" isselected=\"0\">");
            }
            _response_text.AppendStr("<id>my_active_tests</id>");
            _response_text.AppendStr("<name>Мои тесты</name>");
            _response_text.AppendStr("<url>layout=list&amp;object_type=test&amp;state=active&amp;filter=all&amp;person=me</url>");
            _response_text.AppendStr("</item>");

            if(sMenu == "my_active_events")
            {
                _response_text.AppendStr("<item isheader=\"0\" islink=\"1\" isselected=\"1\">");
            }
            else
            {
                _response_text.AppendStr("<item isheader=\"0\" islink=\"1\" isselected=\"0\">");
            }
            _response_text.AppendStr("<id>my_active_events</id>");
            _response_text.AppendStr("<name>Мои мероприятия</name>");
            _response_text.AppendStr("<url>layout=list&amp;object_type=event&amp;state=active&amp;filter=all&amp;person=me</url>");
            _response_text.AppendStr("</item>");

            if(sMenu == "my_active_requests")
            {
                _response_text.AppendStr("<item isheader=\"0\" islink=\"1\" isselected=\"1\">");
            }
            else
            {
                _response_text.AppendStr("<item isheader=\"0\" islink=\"1\" isselected=\"0\">");
            }
            _response_text.AppendStr("<id>my_active_requests</id>");
            _response_text.AppendStr("<name>Мои запросы</name>");
            _response_text.AppendStr("<url>layout=list&amp;object_type=request&amp;state=active&amp;filter=all&amp;person=me</url>");
            _response_text.AppendStr("</item>");

            if(sMenu == "my_active_responses")
            {
                _response_text.AppendStr("<item isheader=\"0\" islink=\"1\" isselected=\"1\">");
            }
            else
            {
                _response_text.AppendStr("<item isheader=\"0\" islink=\"1\" isselected=\"0\">");
            }
            _response_text.AppendStr("<id>my_active_responses</id>");
            _response_text.AppendStr("<name>Мои отзывы</name>");
            _response_text.AppendStr("<url>layout=list&amp;object_type=response&amp;state=active&amp;filter=all&amp;person=me</url>");
            _response_text.AppendStr("</item>");

            if(sMenu == "my_archive_all")
            {
                _response_text.AppendStr("<item isheader=\"0\" islink=\"1\" isselected=\"1\">");
            }
            else
            {
                _response_text.AppendStr("<item isheader=\"0\" islink=\"1\" isselected=\"0\">");
            }
            _response_text.AppendStr("<id>my_archive_all</id>");
            _response_text.AppendStr("<name>Мой архив</name>");
            _response_text.AppendStr("<url>layout=multilist&amp;object_type=all&amp;state=archive&amp;filter=all&amp;person=me</url>");
            _response_text.AppendStr("</item>");

            if(sMenu == "my_appraisals")
            {
                _response_text.AppendStr("<item isheader=\"0\" islink=\"1\" isselected=\"1\">");
            }
            else
            {
                _response_text.AppendStr("<item isheader=\"0\" islink=\"1\" isselected=\"0\">");
            }
            _response_text.AppendStr("<id>my_appraisals</id>");
            _response_text.AppendStr("<name>Мои оценки</name>");
            _response_text.AppendStr("<url>layout=list&amp;object_type=appraisal&amp;state=active&amp;filter=all&amp;person=me</url>");
            _response_text.AppendStr("</item>");


        _response_text.AppendStr("</item>");

        if(bBoss)
        {
            _response_text.AppendStr("<item isheader=\"1\"  islink=\"0\" isselected=\"0\">");
                _response_text.AppendStr("<id>common</id>");
                _response_text.AppendStr("<name>Мои сотрудники</name>");
                _response_text.AppendStr("<url></url>");

                if(sMenu == "col_requests")
                {
                    _response_text.AppendStr("<item isheader=\"0\" islink=\"1\" isselected=\"1\">");
                }
                else
                {
                    _response_text.AppendStr("<item isheader=\"0\" islink=\"1\" isselected=\"0\">");
                }
                _response_text.AppendStr("<id>col_requests</id>");
                _response_text.AppendStr("<name>Запросы</name>");
                _response_text.AppendStr("<url>layout=list&amp;object_type=request&amp;state=active&amp;filter=all&amp;person=col</url>");
                _response_text.AppendStr("</item>");

                if(sMenu == "col_responses")
                {
                    _response_text.AppendStr("<item isheader=\"0\" islink=\"1\" isselected=\"1\">");
                }
                else
                {
                    _response_text.AppendStr("<item isheader=\"0\" islink=\"1\" isselected=\"0\">");
                }
                _response_text.AppendStr("<id>col_responses</id>");
                _response_text.AppendStr("<name>Отзывы</name>");
                _response_text.AppendStr("<url>layout=list&amp;object_type=response&amp;state=active&amp;filter=all&amp;person=col</url>");
                _response_text.AppendStr("</item>");

            _response_text.AppendStr("</item>");
        }


        _response_text.AppendStr("<item isheader=\"1\"  islink=\"0\" isselected=\"0\">");
            _response_text.AppendStr("<id>common</id>");
            _response_text.AppendStr("<name>Учебный центр</name>");
            _response_text.AppendStr("<url></url>");

            if(sMenu == "courses")
            {
                _response_text.AppendStr("<item isheader=\"0\" islink=\"1\" isselected=\"1\">");
            }
            else
            {
                _response_text.AppendStr("<item isheader=\"0\" islink=\"1\" isselected=\"0\">");
            }
            _response_text.AppendStr("<id>courses</id>");
            _response_text.AppendStr("<name>Курсы</name>");
            _response_text.AppendStr("<url>layout=list&amp;object_type=course&amp;state=all&amp;filter=all&amp;person=me</url>");
            _response_text.AppendStr("</item>");

            if(sMenu == "tests")
            {
                _response_text.AppendStr("<item isheader=\"0\" islink=\"1\" isselected=\"1\">");
            }
            else
            {
                _response_text.AppendStr("<item isheader=\"0\" islink=\"1\" isselected=\"0\">");
            }
            _response_text.AppendStr("<id>tests</id>");
            _response_text.AppendStr("<name>Тесты</name>");
            _response_text.AppendStr("<url>layout=list&amp;object_type=test&amp;state=all&amp;filter=all&amp;person=me</url>");
            _response_text.AppendStr("</item>");

            if(sMenu == "events")
            {
                _response_text.AppendStr("<item isheader=\"0\" islink=\"1\" isselected=\"1\">");
            }
            else
            {
                _response_text.AppendStr("<item isheader=\"0\" islink=\"1\" isselected=\"0\">");
            }
            _response_text.AppendStr("<id>events</id>");
            _response_text.AppendStr("<name>Мероприятия</name>");
            _response_text.AppendStr("<url>layout=list&amp;object_type=event&amp;state=all&amp;filter=all&amp;person=me</url>");
            _response_text.AppendStr("</item>");

            if(sMenu == "programs")
            {
                _response_text.AppendStr("<item isheader=\"0\" islink=\"1\" isselected=\"1\">");
            }
            else
            {
                _response_text.AppendStr("<item isheader=\"0\" islink=\"1\" isselected=\"0\">");
            }
            _response_text.AppendStr("<id>programs</id>");
            _response_text.AppendStr("<name>Программы</name>");
            _response_text.AppendStr("<url>layout=list&amp;object_type=program&amp;state=all&amp;filter=all&amp;person=me</url>");
            _response_text.AppendStr("</item>");

            if(sMenu == "lectors")
            {
                _response_text.AppendStr("<item isheader=\"0\" islink=\"1\" isselected=\"1\">");
            }
            else
            {
                _response_text.AppendStr("<item isheader=\"0\" islink=\"1\" isselected=\"0\">");
            }
            _response_text.AppendStr("<id>lectors</id>");
            _response_text.AppendStr("<name>Преподаватели</name>");
            _response_text.AppendStr("<url>layout=list&amp;object_type=lector&amp;state=all&amp;filter=all&amp;person=me</url>");
            _response_text.AppendStr("</item>");

        _response_text.AppendStr("</item>");

    _response_text.AppendStr("</menu>");
}



function List()
{
    sData = "<data>";
    sColumns = "<columns>";
    sFields = "<fields>";
    sActions = "<actions>";
    sError = "<error>";
    sPageName = "";

    switch(sObjectType)
    {
        case "appraisal":
            sPageName = "<pagename>" + tools.get_web_str("vaasb_assessment_appraises") + "</pagename>";

			oDoc = XQuery( "for $assessment_appraise in assessment_appraises where $assessment_appraise/is_model = false() and $assessment_appraise/web_display = true() and  $assessment_appraise/status = '0' order by $assessment_appraise/name return $assessment_appraise" ) ;

            sFields = sFields + "<field type=\"string\">eid</field>";
            sFields = sFields + "<field type=\"string\">name</field>";

            sColumns = sColumns + "<column type=\"icon\" file=\"proc\" nowrap=\"1\"></column>";
            sColumns = sColumns + "<column type=\"string\" span=\"1\" field=\"name\" nowrap=\"1\" sort=\"name\" ismodal=\"1\" linkurl=\"link_modal\" >Процедура</column>";

            for (oElem in oDoc)
            {
				bDisplay = false;

				if (oElem.person_id == curUserID)
				{
					bDisplay = true;
				}
				else if ( ArrayOptFirstElem(  ArrayUnion( XQuery( 'for $pa in pas where $pa/expert_person_id = ' + curUserID + '  and $pa/assessment_appraise_id = ' + oElem.PrimaryKey + ' return $pa' ),  XQuery( 'for $pa in development_plans where $pa/expert_person_id = ' + curUserID + '  and $pa/assessment_appraise_id = ' + oElem.PrimaryKey + ' return $pa' )  )  ) != undefined  )
				{
					bDisplay = true;
				}
				else if ( ArrayOptFirstElem(  ArrayUnion( XQuery( 'for $pa in pas where $pa/person_id = ' + curUserID + '  and $pa/assessment_appraise_id = ' + oElem.PrimaryKey + ' return $pa' ),  XQuery( 'for $pa in development_plans where $pa/person_id = ' + curUserID + '  and $pa/assessment_appraise_id = ' + oElem.PrimaryKey + ' return $pa' )  )  ) != undefined )
				{
					bDisplay = true;
				}
				else
				{
					_curAADoc = OpenDoc(UrlFromDocID(oElem.PrimaryKey)).TopElem;

					_custom_experts_participants = ArraySelect(_curAADoc.participants, 'customize.is_custom_experts == true');

					if (ArrayOptFirstElem(_custom_experts_participants) != undefined)
					{
					    if (ArrayOptFirstElem(  ArrayUnion( XQuery( 'for $pa in pas where $pa/assessment_appraise_id = ' + oElem.PrimaryKey + ' and contains( $pa/custom_experts, "' + curUserID + '") return $pa' ), XQuery( 'for $pa in development_plans where $pa/assessment_appraise_id = ' + oElem.PrimaryKey + ' and contains( $pa/custom_experts, "' + curUserID + '") return $pa' ) ) ) != undefined )
					    {
						    bDisplay = true;
					    }
					}
				}

                if(!bDisplay) continue;

                try
                {
                    oTmpDoc = OpenDoc( UrlFromDocID( Int(oElem.id) ) ).TopElem;
                }
                catch(e)
                {
                    continue;
                }
                if(!tools_web.check_access(oTmpDoc, curUserID, curUser, Session)) continue;

                sData = sData + "<element>";
                sData = sData + "<eid>" + Validate(oElem.id) + "</eid>";
                sData = sData + "<name>" + Validate(oElem.name) + "</name>";
                sData = sData + "<link_name>eid=" + oElem.id + "&amp;layout=card&amp;object_type=appraisal&amp;state=active&amp;person=me&amp;filter=none&amp;menu=my_appraisals</link_name>";
                sData = sData + "<link_modal>view_doc.html?mode=assessment_appraise&amp;doc_id=" + sEId + "&amp;assessment_appraise_id=" + oElem.id + "</link_modal>";
                sData = sData + "</element>";
            }

            break;

        case "test":
            switch(sState)
            {
                case "active":
                    switch(sPerson)
                    {
                        case "me":
                            sPageName = "<pagename>Мои тесты</pagename>";
                            oDoc = XQuery( "for $elem in active_test_learnings where $elem/person_id = " + curUserID.XQueryLiteral + " order by $elem/last_usage_date descending return $elem" );
                            sFields = sFields + "<field type=\"id\">eid</field>";
                            sFields = sFields + "<field type=\"string\">test_id</field>";
                            sFields = sFields + "<field type=\"string\">test_code</field>";
                            sFields = sFields + "<field type=\"string\">test_name</field>";
                            sFields = sFields + "<field type=\"date\">start_usage_date</field>";
                            sFields = sFields + "<field type=\"number\">start_usage_date_int</field>";
                            sFields = sFields + "<field type=\"date\">last_usage_date</field>";
                            sFields = sFields + "<field type=\"number\">last_usage_date_int</field>";
                            sFields = sFields + "<field type=\"date\">max_end_date</field>";
                            sFields = sFields + "<field type=\"number\">max_end_date_int</field>";
                            sFields = sFields + "<field type=\"number\">score</field>";
                            sFields = sFields + "<field type=\"number\">max_score</field>";
                            sFields = sFields + "<field type=\"number\">state_id</field>";
                            sFields = sFields + "<field type=\"string\">state_name</field>";
                            sFields = sFields + "<field type=\"string\">action_string</field>";

                            sColumns = sColumns + "<column type=\"icon\" file=\"test\" nowrap=\"1\"></column>";
                            sColumns = sColumns + "<column type=\"string\" field=\"test_code\" nowrap=\"1\" sort=\"test_code\">Код</column>";
                            sColumns = sColumns + "<column type=\"string\" field=\"test_name\" sort=\"test_name\" islink=\"1\" linkurl=\"link_test_name\" linkid=\"test_id\" linktemplate=\"CardTest.aspx?action=card&amp;target=test&amp;mode=full\">Наименование</column>";
                            sColumns = sColumns + "<column type=\"date\" field=\"start_usage_date\" nowrap=\"1\" sort=\"start_usage_date_int\">Начат</column>";
                            sColumns = sColumns + "<column type=\"date\" field=\"last_usage_date\" nowrap=\"1\" sort=\"last_usage_date_int\">Последний вход</column>";
                            sColumns = sColumns + "<column type=\"date\" field=\"max_end_date\" nowrap=\"1\" sort=\"max_end_date_int\">Закончить до</column>";
                            sColumns = sColumns + "<column type=\"number\" field=\"score\" nowrap=\"1\" sort=\"score\">Результат</column>";
                            sColumns = sColumns + "<column type=\"number\" field=\"max_score\" nowrap=\"1\" sort=\"score\">Макс.оценка</column>";
                            sColumns = sColumns + "<column type=\"string\" field=\"state_name\" nowrap=\"1\" sort=\"state_id\">Состояние</column>";
                            sColumns = sColumns + "<column type=\"string\" field=\"action_string\" nowrap=\"1\" sort=\"state_id\" linkurl=\"link_action_string\" islink=\"1\" linkid=\"eid\" linktemplate=\"Card.aspx?action=card&amp;target=test&amp;mode=active\">Действие</column>";

                            for (oElem in oDoc)
                            {
                                try
                                {
                                    oTmpDoc = OpenDoc( UrlFromDocID( Int(oElem.id) ) ).TopElem;
                                }
                                catch(e)
                                {
                                    continue;
                                }
                                if(!tools_web.check_access(oTmpDoc, curUserID, curUser, Session)) continue;
                                sData = sData + "<element>";
                                sData = sData + "<eid>" + Validate(oElem.id) + "</eid>";
                                sData = sData + "<test_id>" + Validate(oElem.assessment_id) + "</test_id>";
                                try
                                {
                                    sData = sData + "<test_code>" + Validate(oElem.assessment_id.ForeignElem.code) + "</test_code>";
                                    sData = sData + "<test_name>" + Validate(oElem.assessment_id.ForeignElem.title) + "</test_name>";
                                }
                                catch(e)
                                {
                                    sData = sData + "<test_code>" + sObjectDeleted + "</test_code>";
                                    sData = sData + "<test_name>" + sObjectDeleted + "</test_name>";
                                }
                                sData = sData + "<start_usage_date>" + Validate(oElem.start_usage_date) + "</start_usage_date>";
                                try {
                                    iDate = DateToRawSeconds(oElem.start_usage_date);
                                }
                                catch(e)
                                {
                                    iDate = 0;
                                }
                                sData = sData + "<start_usage_date_int>" + String(iDate) + "</start_usage_date_int>";
                                sData = sData + "<last_usage_date>" + Validate(oElem.last_usage_date) + "</last_usage_date>";
                                try {
                                    iDate = DateToRawSeconds(oElem.last_usage_date);
                                }
                                catch(e)
                                {
                                    iDate = 0;
                                }
                                sData = sData + "<last_usage_date_int>" + String(iDate) + "</last_usage_date_int>";
                                sData = sData + "<max_end_date>" + Validate(oElem.max_end_date) + "</max_end_date>";
                                try {
                                    iDate = DateToRawSeconds(oElem.max_end_date);
                                }
                                catch(e)
                                {
                                    iDate = 0;
                                }
                                sData = sData + "<max_end_date_int>" + String(iDate) + "</max_end_date_int>";
                                sData = sData + "<score>" + Validate(oElem.score) + "</score>";
                                sData = sData + "<max_score>" + Validate(oElem.max_score) + "</max_score>";
                                sData = sData + "<state_id>" + Validate(oElem.state_id) + "</state_id>";
                                sData = sData + "<action_string>" + ( Validate(oElem.state_id)==1 ? "Продолжить" : "Начать" ) + "</action_string>";
                                sData = sData + "<state_name>" + Validate(common.learning_states.GetChildByKey( oElem.state_id ).name) + "</state_name>";
                                sData = sData + "<link_test_name>eid=" + Validate(oElem.assessment_id) + "&amp;layout=card&amp;object_type=test&amp;state=active&amp;filter=none&amp;person=me&amp;menu=my_active_tests</link_test_name>";
                                sData = sData + "<link_action_string>eid=" + Validate(oElem.id) + "&amp;layout=launch&amp;object_type=test&amp;state=active&amp;filter=none&amp;person=me&amp;menu=my_active_tests</link_action_string>";
                                sData = sData + "</element>";
                            }
                            break;
                    }
                    break;
                case "all":
                    sPageName = "<pagename>Тесты</pagename>";
                    oFullList = XQuery( "assessments" );
                    oActiveList = XQuery( "for $elem in active_test_learnings where $elem/person_id = " + curUserID.XQueryLiteral + " return $elem" );
                    oArchiveList = XQuery( "for $elem in test_learnings where $elem/person_id = " + curUserID.XQueryLiteral + " return $elem" );
                    sFields = sFields + "<field type=\"id\">eid</field>";
                    sFields = sFields + "<field type=\"string\">test_id</field>";
                    sFields = sFields + "<field type=\"string\">test_code</field>";
                    sFields = sFields + "<field type=\"string\">test_name</field>";
                    sFields = sFields + "<field type=\"number\">state_id</field>";
                    sFields = sFields + "<field type=\"string\">state_name</field>";
                    sFields = sFields + "<field type=\"string\">action_string</field>";

                    sColumns = sColumns + "<column type=\"icon\" file=\"folder\" nowrap=\"1\"></column>";
                    sColumns = sColumns + "<column type=\"string\" field=\"test_code\" nowrap=\"1\" sort=\"test_code\">Код</column>";
                    sColumns = sColumns + "<column type=\"string\" field=\"test_name\" sort=\"test_name\" islink=\"1\" linkurl=\"link_test_name\" linkid=\"test_id\" linktemplate=\"Card.aspx?action=card&amp;target=test&amp;mode=full\">Наименование</column>";
                    sColumns = sColumns + "<column type=\"string\" field=\"state_name\" nowrap=\"1\" sort=\"state_id\">Состояние</column>";
                    sColumns = sColumns + "<column type=\"string\" field=\"action_string\" nowrap=\"1\" sort=\"state_id\" linkurl=\"link_action_string\" islink=\"1\" linkid=\"eid\" linktemplate=\"Card.aspx?action=card&amp;target=test&amp;mode=archive\">Действие</column>";
				    aRequestTypes = XQuery (" for $elem in request_types where $elem/object_type = 'assessment' return $elem ");
                    try {
                        oRType = ArrayFirstElem(aRequestTypes);
                        sReqId = oRType.id;
                    } catch(e) {
                        sReqId = "";
                    }

                    for (oElem in oFullList)
                    {
                        try
                        {
                            oTmpDoc = OpenDoc( UrlFromDocID( Int(oElem.id) ) ).TopElem;
                        }
                        catch(e)
                        {
                            continue;
                        }
                        if(!tools_web.check_access(oTmpDoc, curUserID, curUser, Session)) continue;

                        try {
                            bOpen = oTmpDoc.is_open;
                        }
                        catch(e)
                        {
                            bOpen = false;
                        }

                        sData = sData + "<element>";
                        sData = sData + "<eid>" + Validate(oElem.id) + "</eid>";
                        sData = sData + "<test_id>" + Validate(oElem.id) + "</test_id>";
                        sData = sData + "<test_code>" + Validate(oElem.code) + "</test_code>";
                        sData = sData + "<test_name>" + Validate(oElem.title) + "</test_name>";

				        sState = "0";
				        sStateName = ""
				        for ( oActive in oActiveList )
				        {
				            if ( oActive.assessment_id == oElem.id )
				            {
				                sState = "1";
				                break;
				            }
				        }
				        aRequests = XQuery (" for $elem in requests where $elem/object_id = " + oElem.id + " and $elem/person_id = " + curUserID.XQueryLiteral + " and $elem/status_id = 'active' return $elem ");
				        if (ArrayOptFirstElem(aRequests) != undefined && sState != "1") sState = "2";

                        if(sState=="0")
                        {
				            for ( oArchive in oArchiveList )
				            {
				                if ( oArchive.assessment_id == oElem.id )
				                {
				                    sState = "3";
				                    break;
				                }
				            }
                        }
                        switch(sState)
                        {
                            case "1":
                                sStateName = "Активирован";
                                break;
                            case "2":
                                sStateName = "Запрос принят";
                                break;
                            case "3":
                                sStateName = "В архиве";
                                break;
                        }
                        sData = sData + "<state_id>" + sState + "</state_id>";
                        sData = sData + "<state_name>" + sStateName + "</state_name>";
                        sActString = "";
                        if(sState=="0" || sState=="3")
                        {
                            if(bOpen)
                            {
                                sActString = "Активировать";
                            }
                            else
                            {
                                if(sReqId == "")
                                {
                                    sActString = "[DIAGNOSTIC]: Не определена форма запроса для данного типа объекта. Невозможно создать запрос. Пожалуйста, свяжитесь с администратором системы обучения.";
                                }
                                else
                                {
                                    sActString = "Создать запрос";
                                }
                            }
                        }

                        sData = sData + "<action_string>" + sActString + "</action_string>";

                        if(bOpen)
                        {
                            sData = sData + "<link_action_string>eid=" + Validate(oElem.id) + "&amp;layout=form&amp;object_type=test&amp;state=all&amp;filter=none&amp;person=me&amp;menu=tests</link_action_string>";
                            sData = sData + "<link_test_name>eid=" + Validate(oElem.id) + "&amp;layout=card&amp;object_type=test&amp;state=all&amp;filter=none&amp;person=me&amp;menu=tests</link_test_name>";
                        }
                        else
                        {
                            if(sReqId != "")
                            {
                                sData = sData + "<link_action_string>eid=" + Validate(oElem.id) + "&amp;layout=form&amp;object_type=request&amp;state=all&amp;filter=none&amp;person=me&amp;menu=my_active_requests&amp;req_id=" + sReqId + "</link_action_string>";
                                sData = sData + "<link_test_name>eid=" + Validate(oElem.id) + "&amp;layout=card&amp;object_type=test&amp;state=all&amp;filter=none&amp;person=me&amp;menu=tests</link_test_name>";
                            }
                            else
                            {
                                sData = sData + "<link_action_string>#</link_action_string>";
                                sData = sData + "<link_test_name>eid=" + Validate(oElem.id) + "&amp;layout=card&amp;object_type=test&amp;state=all&amp;filter=none&amp;person=me&amp;menu=tests</link_test_name>";
                            }
                        }
                        sData = sData + "</element>";
                    }
                    break;
            }
            break;
        case "course":
            switch(sState)
            {
                case "active":
                    switch(sPerson)
                    {
                        case "me":
                            sPageName = "<pagename>Мои курсы</pagename>";
                            if(sSort=="") sSort = "last_usage_date";
                            sPageName = sPageName + "<sort order=\"" + sOrder + "\"></sort>";
                            sOrder = sOrder=="1" ? "descending" : "ascending";
                            oDoc = XQuery( "for $elem in active_learnings where $elem/person_id = " + curUserID.XQueryLiteral + " order by $elem/" + sSort + " " + sOrder + " return $elem" );

                            sFields = sFields + "<field type=\"id\">eid</field>";
                            sFields = sFields + "<field type=\"string\">course_id</field>";
                            sFields = sFields + "<field type=\"string\">course_code</field>";
                            sFields = sFields + "<field type=\"string\">course_name</field>";
                            sFields = sFields + "<field type=\"date\">start_usage_date</field>";
                            sFields = sFields + "<field type=\"number\">start_usage_date_int</field>";
                            sFields = sFields + "<field type=\"date\">last_usage_date</field>";
                            sFields = sFields + "<field type=\"number\">last_usage_date_int</field>";
                            sFields = sFields + "<field type=\"date\">max_end_date</field>";
                            sFields = sFields + "<field type=\"number\">max_end_date_int</field>";
                            sFields = sFields + "<field type=\"number\">score</field>";
                            sFields = sFields + "<field type=\"number\">state_id</field>";
                            sFields = sFields + "<field type=\"string\">state_name</field>";
                            sFields = sFields + "<field type=\"string\">action_string</field>";

                            sColumns = sColumns + "<column type=\"icon\" file=\"folder\" nowrap=\"1\"></column>";
                            sColumns = sColumns + "<column type=\"string\" field=\"course_code\" nowrap=\"1\">Код</column>";
                            sColumns = sColumns + "<column type=\"string\" field=\"course_name\" islink=\"1\" linkurl=\"link_course_name\" linkid=\"course_id\" linktemplate=\"Card.aspx?action=card&amp;target=course&amp;mode=full\">Наименование</column>";
                            sColumns = sColumns + "<column type=\"date\" field=\"start_usage_date\" nowrap=\"1\" sort=\"start_usage_date\">Начат</column>";
                            sColumns = sColumns + "<column type=\"date\" field=\"last_usage_date\" nowrap=\"1\" sort=\"last_usage_date\">Последний вход</column>";
                            sColumns = sColumns + "<column type=\"date\" field=\"max_end_date\" nowrap=\"1\" sort=\"max_end_date\">Закончить до</column>";
                            sColumns = sColumns + "<column type=\"number\" field=\"score\" nowrap=\"1\" sort=\"score\">Результат</column>";
                            sColumns = sColumns + "<column type=\"string\" field=\"state_name\" nowrap=\"1\" sort=\"state_id\">Состояние</column>";
                            sColumns = sColumns + "<column type=\"string\" field=\"action_string\" nowrap=\"1\" sort=\"state_id\" linkurl=\"link_action_string\" islink=\"1\" linkid=\"eid\" linktemplate=\"Card.aspx?action=card&amp;target=course&amp;mode=active\">Действие</column>";

                            for (oElem in oDoc)
                            {
                                try
                                {
                                    oTmpDoc = OpenDoc( UrlFromDocID( Int(oElem.id) ) ).TopElem;
                                }
                                catch(e)
                                {
                                    continue;
                                }
                                if(!tools_web.check_access(oTmpDoc, curUserID, curUser, Session)) continue;
                                sData = sData + "<element>";
                                sData = sData + "<eid>" + Validate(oElem.id) + "</eid>";
                                sData = sData + "<course_id>" + Validate(oElem.course_id) + "</course_id>";
                                try
                                {
                                    sData = sData + "<course_code>" + Validate(oElem.course_id.ForeignElem.code) + "</course_code>";
                                    sData = sData + "<course_name>" + Validate(oElem.course_id.ForeignElem.name) + "</course_name>";
                                }
                                catch(e)
                                {
                                    sData = sData + "<course_code>" + sObjectDeleted + "</course_code>";
                                    sData = sData + "<course_name>" + sObjectDeleted + "</course_name>";
                                }
                                sData = sData + "<start_usage_date>" + Validate(oElem.start_usage_date) + "</start_usage_date>";
                                try {
                                    iDate = DateToRawSeconds(oElem.start_usage_date);
                                }
                                catch(e)
                                {
                                    iDate = 0;
                                }
                                sData = sData + "<start_usage_date_int>" + String(iDate) + "</start_usage_date_int>";
                                sData = sData + "<last_usage_date>" + Validate(oElem.last_usage_date) + "</last_usage_date>";
                                try {
                                    iDate = DateToRawSeconds(oElem.last_usage_date);
                                }
                                catch(e)
                                {
                                    iDate = 0;
                                }
                                sData = sData + "<last_usage_date_int>" + String(iDate) + "</last_usage_date_int>";
                                sData = sData + "<max_end_date>" + Validate(oElem.max_end_date) + "</max_end_date>";
                                try {
                                    iDate = DateToRawSeconds(oElem.max_end_date);
                                }
                                catch(e)
                                {
                                    iDate = 0;
                                }
                                sData = sData + "<max_end_date_int>" + String(iDate) + "</max_end_date_int>";
                                sData = sData + "<score>" + Validate(oElem.score) + "</score>";
                                sData = sData + "<state_id>" + Validate(oElem.state_id) + "</state_id>";
								switch( Validate(oElem.state_id) )
								{
									case 1:
										sData = sData + "<action_string>Продолжить</action_string>";
										break;
									case 2:
									case 4:
										sData = sData + "<action_string>Просмотреть</action_string>";
										break;
									default:
										sData = sData + "<action_string>Начать</action_string>";
										break;
								}
                                // sData = sData + "<action_string>" + ( Validate(oElem.state_id)==1 ? "Продолжить" : "Начать" ) + "</action_string>";
                                try
                                {
                                    sData = sData + "<state_name>" + Validate(common.learning_states.GetChildByKey( oElem.state_id ).name) + "</state_name>";
                                }
                                catch(e)
                                {
                                    sData = sData + "<state_name>" + sObjectDeleted + "</state_name>";
                                }
                                sData = sData + "<link_course_name>eid=" + Validate(oElem.course_id) + "&amp;layout=card&amp;object_type=course&amp;state=active&amp;filter=none&amp;person=me&amp;menu=my_active_courses</link_course_name>";
                                sData = sData + "<link_action_string>eid=" + Validate(oElem.id) + "&amp;layout=launch&amp;object_type=course&amp;state=active&amp;filter=none&amp;person=me&amp;menu=my_active_courses</link_action_string>";
                                sData = sData + "</element>";
                            }
                            break;
                    }
                    break;
                case "all":
                    sPageName = "<pagename>Курсы</pagename>";
                    oFullList = XQuery( "courses" );
                    oActiveList = XQuery( "for $elem in active_learnings where $elem/person_id = " + curUserID.XQueryLiteral + " return $elem" );
                    oArchiveList = XQuery( "for $elem in learnings where $elem/person_id = " + curUserID.XQueryLiteral + " return $elem" );

                    sFields = sFields + "<field type=\"id\">eid</field>";
                    sFields = sFields + "<field type=\"string\">course_id</field>";
                    sFields = sFields + "<field type=\"string\">course_code</field>";
                    sFields = sFields + "<field type=\"string\">course_name</field>";
                    sFields = sFields + "<field type=\"bool\">self_enroll</field>";
                    sFields = sFields + "<field type=\"number\">state_id</field>";
                    sFields = sFields + "<field type=\"string\">state_name</field>";
                    sFields = sFields + "<field type=\"string\">action_string</field>";

                    sColumns = sColumns + "<column type=\"icon\" file=\"folder\" nowrap=\"1\"></column>";
                    sColumns = sColumns + "<column type=\"string\" field=\"course_code\" nowrap=\"1\" sort=\"course_code\">Код</column>";
                    sColumns = sColumns + "<column type=\"string\" field=\"course_name\" sort=\"course_name\" islink=\"1\" linkurl=\"link_course_name\" linkid=\"course_id\" linktemplate=\"Card.aspx?action=card&amp;target=course&amp;mode=full\">Наименование</column>";
                    sColumns = sColumns + "<column type=\"string\" field=\"state_name\" nowrap=\"1\" sort=\"state_id\">Состояние</column>";
                    sColumns = sColumns + "<column type=\"string\" field=\"action_string\" nowrap=\"1\" sort=\"state_id\" islink=\"1\" linkurl=\"link_action_string\" linkid=\"eid\" linktemplate=\"Card.aspx?action=card&amp;target=course&amp;mode=archive\">Действие</column>";
				    try
					{
						aRequestTypes = XQuery (" for $elem in request_types where $elem/object_type = 'course' return $elem ");
						oRType = ArrayFirstElem(aRequestTypes);
						sReqId = oRType.id;
					}
					catch(e)
					{
						sReqId = "";
					}

                    for (oElem in oFullList)
                    {
                        try
                        {
                            oTmpDoc = OpenDoc( UrlFromDocID( Int(oElem.id) ) ).TopElem;
                        }
                        catch(e)
                        {
                            continue;
                        }
                        if(!tools_web.check_access(oTmpDoc, curUserID, curUser, Session)) continue;
                        sData = sData + "<element>";
                        sData = sData + "<eid>" + Validate(oElem.id) + "</eid>";
                        sData = sData + "<course_id>" + Validate(oElem.id) + "</course_id>";
                        sData = sData + "<course_code>" + Validate(oElem.code) + "</course_code>";
                        sData = sData + "<course_name>" + Validate(oElem.name) + "</course_name>";
                        sData = sData + "<self_enroll>" + Validate(oElem.yourself_start) + "</self_enroll>";

				        sState = "0";
				        sStateName = ""
				        for ( oActive in oActiveList )
				        {
				            if ( oActive.course_id == oElem.id )
				            {
				                sState = "1";
				                break;
				            }
				        }
				        aRequests = XQuery (" for $elem in requests where $elem/object_id = " + oElem.id + " and $elem/person_id = " + curUserID.XQueryLiteral + " and $elem/status_id = 'active' return $elem ");
				        if (ArrayOptFirstElem(aRequests) != undefined && sState != "1") sState = "2";

                        if(sState=="0")
                        {
				            for ( oArchive in oArchiveList )
				            {
				                if ( oArchive.course_id == oElem.id )
				                {
				                    sState = "3";
				                    break;
				                }
				            }
                        }
                        switch(sState)
                        {
                            case "1":
                                sStateName = "Активирован";
                                break;
                            case "2":
                                sStateName = "Запрос принят";
                                break;
                            case "3":
                                sStateName = "В архиве";
                                break;
                        }
                        sData = sData + "<state_id>" + sState + "</state_id>";
                        sData = sData + "<state_name>" + sStateName + "</state_name>";
                        sActString = "";
                        if(sState=="0" || sState=="3")
                        {
                            if(oElem.yourself_start)
                            {
                                sActString = "Активировать";
                                sData = sData + "<link_action_string>eid=" + oElem.id + "&amp;layout=form&amp;object_type=course&amp;state=all&amp;filter=none&amp;person=me&amp;menu=courses</link_action_string>";
                            }
                            else
                            {
                                if(sReqId!="")
								{
									sActString = "Создать запрос";
									sData = sData + "<link_action_string>eid=" + oElem.id + "&amp;layout=form&amp;object_type=request&amp;state=all&amp;filter=none&amp;person=me&amp;menu=my_active_requests&amp;req_id=" + sReqId + "</link_action_string>";
								}
								else
								{
									sActString = "[DIAGNOSTIC]: Не определена форма запроса для данного типа объекта. Невозможно создать запрос. Пожалуйста, свяжитесь с администратором системы обучения.";
									sData = sData + "<link_action_string>#</link_action_string>";
								}
                            }
                        }
                        else
                        {
                           sData = sData + "<link_action_string>#</link_action_string>";
                        }
                        sData = sData + "<action_string>" + sActString + "</action_string>";
                        sData = sData + "<link_course_name>eid=" + Validate(oElem.id) + "&amp;layout=card&amp;object_type=course&amp;state=active&amp;filter=none&amp;person=me&amp;menu=my_active_courses</link_course_name>";
                        sData = sData + "</element>";
                    }

                    break;
            }
            break;
        case "lector":
            sPageName = "<pagename>Преподаватели</pagename>";
            oDoc = XQuery( "lectors" );

            sFields = sFields + "<field type=\"id\">eid</field>";
            sFields = sFields + "<field type=\"id\">person_id</field>";
            sFields = sFields + "<field type=\"string\">full_name</field>";
            sFields = sFields + "<field type=\"string\">type_id</field>";
            sFields = sFields + "<field type=\"string\">type_name</field>";
            sFields = sFields + "<field type=\"string\">email</field>";

            sColumns = sColumns + "<column type=\"icon\" file=\"person\" nowrap=\"1\"></column>";
            sColumns = sColumns + "<column type=\"string\" field=\"full_name\" nowrap=\"1\" sort=\"full_name\" islink=\"1\" linkurl=\"link_name\" linkid=\"eid\" linktemplate=\"CardLector.aspx?action=card&amp;target=lector&amp;mode=active\">ФИО</column>";
            sColumns = sColumns + "<column type=\"string\" field=\"type_name\" nowrap=\"1\" sort=\"type_name\">Тип</column>";
            sColumns = sColumns + "<column type=\"string\" field=\"email\" nowrap=\"1\" sort=\"email\">E-mail</column>";

            for (oElem in oDoc)
            {
                try
                {
                    oTmpDoc = OpenDoc( UrlFromDocID( Int(oElem.id) ) ).TopElem;
                }
                catch(e)
                {
                    continue;
                }
                if(!tools_web.check_access(oTmpDoc, curUserID, curUser, Session)) continue;
                sData = sData + "<element>";
                sData = sData + "<eid>" + Validate(oElem.id) + "</eid>";
                sData = sData + "<person_id>" + Validate(oElem.person_id) + "</person_id>";
                sData = sData + "<full_name>" + Validate(oElem.person_fullname) + "</full_name>";
                sData = sData + "<link_name>eid=" + oElem.id + "&amp;layout=card&amp;object_type=lector&amp;state=active&amp;person=me&amp;filter=none&amp;menu=lectors</link_name>";
                sData = sData + "<type_id>" + Validate(oElem.type) + "</type_id>";
                try
                {
                    sData = sData + "<type_name>" + Validate(common.lector_types.GetChildByKey(oElem.type).name) + "</type_name>";
                }
                catch(e)
                {
                    sData = sData + "<type_name>" + sObjectDeleted + "</type_name>";
                }
                sData = sData + "<email>" + Validate(oElem.email) + "</email>";
                sData = sData + "</element>";
            }
            break;

        case "program":
            sPageName = "<pagename>Учебные программы</pagename>";
            oDoc = XQuery( "education_methods" );
            oDoc1 = XQuery( "education_programs" );
            oDoc2 = XQuery( "compound_programs" );

            sFields = sFields + "<field type=\"id\">eid</field>";
            sFields = sFields + "<field type=\"string\">code</field>";
            sFields = sFields + "<field type=\"string\">name</field>";
            sFields = sFields + "<field type=\"string\">type_id</field>";
            sFields = sFields + "<field type=\"string\">type_name</field>";
            sFields = sFields + "<field type=\"bool\">is_open</field>";
            sFields = sFields + "<field type=\"string\">is_open_name</field>";
            sFields = sFields + "<field type=\"string\">participants</field>";
            sFields = sFields + "<field type=\"string\">duration</field>";
            sFields = sFields + "<field type=\"string\">cost</field>";
            sFields = sFields + "<field type=\"string\">cost_type</field>";
            sFields = sFields + "<field type=\"string\">cost_currency</field>";
            sFields = sFields + "<field type=\"string\">price</field>";

            sColumns = sColumns + "<column type=\"icon\" file=\"program\" nowrap=\"1\"></column>";
            sColumns = sColumns + "<column type=\"string\" field=\"code\" nowrap=\"1\" sort=\"code\">Код</column>";
            sColumns = sColumns + "<column type=\"string\" field=\"name\" sort=\"name\" islink=\"1\" linkurl=\"link_name\" linkid=\"eid\" linktemplate=\"CardProgram.aspx?action=card&amp;target=program&amp;mode=active\">Наименование</column>";
            sColumns = sColumns + "<column type=\"string\" field=\"type_name\" nowrap=\"1\" sort=\"type_name\">Тип</column>";
            sColumns = sColumns + "<column type=\"string\" field=\"is_open_name\" nowrap=\"1\" sort=\"is_open_name\">Открытая</column>";
            sColumns = sColumns + "<column type=\"string\" field=\"participants\" nowrap=\"1\" sort=\"participants\">Участников</column>";
            sColumns = sColumns + "<column type=\"string\" field=\"duration\" nowrap=\"1\" sort=\"duration\">Продолжительность</column>";
            sColumns = sColumns + "<column type=\"string\" field=\"price\" nowrap=\"1\" sort=\"price\">Стоимость</column>";

            for (oElem in oDoc)
            {
                try
                {
                    oTmpDoc = OpenDoc( UrlFromDocID( Int(oElem.id) ) ).TopElem;
                }
                catch(e)
                {
                    continue;
                }
                if(!tools_web.check_access(oTmpDoc, curUserID, curUser, Session)) continue;
                sData = sData + "<element>";
                sData = sData + "<eid>" + Validate(oElem.id) + "</eid>";
                sData = sData + "<code>" + Validate(oElem.code) + "</code>";
                sData = sData + "<name>" + Validate(oElem.name) + "</name>";
                sData = sData + "<link_name>eid=" + oElem.id + "&amp;layout=card&amp;object_type=program&amp;state=active&amp;person=me&amp;filter=none&amp;menu=programs</link_name>";
                sData = sData + "<type_id>" + Validate(oElem.type) + "</type_id>";
                try
                {
                    sData = sData + "<type_name>" + Validate(curLngCommon.education_method_types.GetChildByKey(oElem.type).name) + "</type_name>";
                }
                catch(e)
                {
                    sData = sData + "<type_name>" + sObjectDeleted + "</type_name>";
                }
                sData = sData + "<is_open>" + Validate(oElem.is_open) + "</is_open>";
                sOpen = "нет";
                if(oElem.is_open) sOpen = "да";
                sData = sData + "<is_open_name>" + sOpen + "</is_open_name>";
                sData = sData + "<duration>" + Validate(oElem.duration) + "</duration>";
                sData = sData + "<participants>" + Validate(oElem.person_num) + "</participants>";
                sData = sData + "<price>" + Validate(oElem.cost);
		        if ( oElem.cost != "" )
		        {
		            try { sData = sData + " " + oElem.currency.ForeignElem.name; }  catch(e) {}
		            try { sData = sData + " " + curLngCommon.cost_types.GetChildByKey( oElem.cost_type ).name ; }     catch(e) {}
		        }
		        sData = sData + "</price>";
                sData = sData + "</element>";
            }
            for (oElem in oDoc1)
            {
                try
                {
                    oTmpDoc = OpenDoc( UrlFromDocID( Int(oElem.id) ) ).TopElem;
                }
                catch(e)
                {
                    continue;
                }
                if(!tools_web.check_access(oTmpDoc, curUserID, curUser, Session)) continue;
                sData = sData + "<element>";
                sData = sData + "<eid>" + Validate(oElem.id) + "</eid>";
                sData = sData + "<code>" + Validate(oElem.code) + "</code>";
                sData = sData + "<name>" + Validate(oElem.name) + "</name>";
                sData = sData + "<link_name>eid=" + oElem.id + "&amp;layout=card&amp;object_type=program&amp;state=active&amp;person=me&amp;filter=none&amp;menu=programs</link_name>";
                sData = sData + "<type_name>Набор программ</type_name>";
                sData = sData + "<is_open_name>-</is_open_name>";
                sData = sData + "<duration>-</duration>";
                sData = sData + "<participants>-</participants>";
                sData = sData + "<price>-";
		        sData = sData + "</price>";
                sData = sData + "</element>";
            }
            for (oElem in oDoc2)
            {
                try
                {
                    oTmpDoc = OpenDoc( UrlFromDocID( Int(oElem.id) ) ).TopElem;
                }
                catch(e)
                {
                    continue;
                }
                if(!tools_web.check_access(oTmpDoc, curUserID, curUser, Session)) continue;
                sData = sData + "<element>";
                sData = sData + "<eid>" + Validate(oElem.id) + "</eid>";
                sData = sData + "<code>" + Validate(oElem.code) + "</code>";
                sData = sData + "<name>" + Validate(oElem.name) + "</name>";
                sData = sData + "<link_name>eid=" + oElem.id + "&amp;layout=card&amp;object_type=program&amp;state=active&amp;person=me&amp;filter=none&amp;menu=programs</link_name>";
                sData = sData + "<type_name>Модульная программа</type_name>";
                sData = sData + "<is_open_name>-</is_open_name>";
                sData = sData + "<duration>-</duration>";
                sData = sData + "<participants>-</participants>";
                sData = sData + "<price>-";
		        sData = sData + "</price>";
                sData = sData + "</element>";
            }
            break;
        case "request":
            switch(sState)
            {
                case "active":
                    switch(sPerson)
                    {
                        case "me":
                            sPageName = "<pagename>Мои запросы</pagename>";
                            oDoc = XQuery( "for $elem in requests where $elem/person_id = " + curUserID.XQueryLiteral + " return $elem" );
                            sFields = sFields + "<field type=\"id\">eid</field>";
                            sFields = sFields + "<field type=\"string\">code</field>";
                            sFields = sFields + "<field type=\"string\">type_id</field>";
                            sFields = sFields + "<field type=\"string\">type_name</field>";
                            sFields = sFields + "<field type=\"string\">name</field>";
                            sFields = sFields + "<field type=\"date\">create_date</field>";
                            sFields = sFields + "<field type=\"date\">create_date_int</field>";
                            sFields = sFields + "<field type=\"string\">status_id</field>";
                            sFields = sFields + "<field type=\"string\">status_name</field>";

                            sColumns = sColumns + "<column type=\"icon\" file=\"request\" nowrap=\"1\"></column>";
                            sColumns = sColumns + "<column type=\"string\" field=\"code\" nowrap=\"1\" sort=\"code\">Код</column>";
                            sColumns = sColumns + "<column type=\"string\" field=\"type_name\" nowrap=\"1\" sort=\"type_name\" islink=\"1\" linkurl=\"link_type_name\" linkid=\"eid\" linktemplate=\"Card.aspx?action=card&amp;target=request&amp;mode=active\">Тип запроса</column>";
                            sColumns = sColumns + "<column type=\"string\" field=\"name\" sort=\"name\">Предмет запроса</column>";
                            sColumns = sColumns + "<column type=\"date\" field=\"create_date\" nowrap=\"1\" sort=\"create_date_int\">Дата создания</column>";
                            sColumns = sColumns + "<column type=\"string\" field=\"status_name\" nowrap=\"1\" sort=\"status_name\">Состояние</column>";

                            for (oElem in oDoc)
                            {
                                try
                                {
                                    oTmpDoc = OpenDoc( UrlFromDocID( Int(oElem.id) ) ).TopElem;
                                }
                                catch(e)
                                {
                                    continue;
                                }
                                if(!tools_web.check_access(oTmpDoc, curUserID, curUser, Session)) continue;
                                sData = sData + "<element>";
                                sData = sData + "<eid>" + Validate(oElem.id) + "</eid>";
                                sData = sData + "<code>" + Validate(oElem.code) + "</code>";
                                sData = sData + "<name>" + Validate(oElem.object_name) + "</name>";
                                sData = sData + "<type_id>" + Validate(oElem.request_type_id) + "</type_id>";
                                try
                                {
                                    sData = sData + "<type_name>" + Validate(oElem.request_type_id.ForeignElem.name) + "</type_name>";
                                }
                                catch(e)
                                {
                                    sData = sData + "<type_name>" + sObjectDeleted + "</type_name>";
                                }
                                sData = sData + "<create_date>" + Validate(oElem.create_date) + "</create_date>";
                                sData = sData + "<status_id>" + Validate(oElem.status_id) + "</status_id>";
                                sData = sData + "<status_name>" + Validate(curLngCommon.request_status_types.GetChildByKey( oElem.status_id ).name) + "</status_name>";
                                sData = sData + "<link_type_name>eid=" + oElem.id + "&amp;layout=card&amp;object_type=request&amp;state=active&amp;person=me&amp;filter=none&amp;menu=my_active_requests</link_type_name>";
                                sData = sData + "</element>";
                            }
                            break;
                        case "col":
                            sPageName = "<pagename>Запросы сотрудников</pagename>";

                            aColleagues = XQuery( "for $elem in collaborators where $elem/org_id = " + sOrgId + " return $elem" );

                            sFields = sFields + "<field type=\"id\">eid</field>";
                            sFields = sFields + "<field type=\"string\">code</field>";
                            sFields = sFields + "<field type=\"string\">type_id</field>";
                            sFields = sFields + "<field type=\"string\">type_name</field>";
                            sFields = sFields + "<field type=\"string\">name</field>";
                            sFields = sFields + "<field type=\"date\">create_date</field>";
                            sFields = sFields + "<field type=\"date\">create_date_int</field>";
                            sFields = sFields + "<field type=\"string\">status_id</field>";
                            sFields = sFields + "<field type=\"string\">status_name</field>";

                            sColumns = sColumns + "<column type=\"icon\" file=\"request\" nowrap=\"1\"></column>";
                            sColumns = sColumns + "<column type=\"string\" field=\"person\" nowrap=\"1\" sort=\"code\">ФИО</column>";
                            sColumns = sColumns + "<column type=\"string\" field=\"code\" nowrap=\"1\" sort=\"code\">Код</column>";
                            sColumns = sColumns + "<column type=\"string\" field=\"type_name\" nowrap=\"1\" sort=\"type_name\" islink=\"1\" linkurl=\"link_type_name\" linkid=\"eid\">Тип запроса</column>";
                            sColumns = sColumns + "<column type=\"string\" field=\"name\" sort=\"name\">Предмет запроса</column>";
                            sColumns = sColumns + "<column type=\"date\" field=\"create_date\" nowrap=\"1\" sort=\"create_date_int\">Дата создания</column>";
                            sColumns = sColumns + "<column type=\"string\" field=\"status_name\" nowrap=\"1\" sort=\"status_name\">Состояние</column>";

                            for (oColleague in aColleagues)
                            {
                                if(oColleague.id == curUserID) continue;
                                oDoc = XQuery( "for $elem in requests where $elem/person_id = " + oColleague.id + " and $elem/status_id = 'active' return $elem" );

                                for (oElem in oDoc)
                                {
                                    try
                                    {
                                        oTmpDoc = OpenDoc( UrlFromDocID( Int(oElem.id) ) ).TopElem;
                                    }
                                    catch(e)
                                    {
                                        continue;
                                    }
                                    if(!tools_web.check_access(oTmpDoc, curUserID, curUser, Session)) continue;
                                    sData = sData + "<element>";
                                    sData = sData + "<eid>" + Validate(oElem.id) + "</eid>";
                                    sData = sData + "<person>" + Validate(oElem.person_fullname) + "</person>";
                                    sData = sData + "<code>" + Validate(oElem.code) + "</code>";
                                    sData = sData + "<name>" + Validate(oElem.object_name) + "</name>";
                                    sData = sData + "<type_id>" + Validate(oElem.request_type_id) + "</type_id>";
                                    try
                                    {
                                        sData = sData + "<type_name>" + Validate(oElem.request_type_id.ForeignElem.name) + "</type_name>";
                                    }
                                    catch(e)
                                    {
                                        sData = sData + "<type_name>" + sObjectDeleted + "</type_name>";
                                    }
                                    sData = sData + "<create_date>" + Validate(oElem.create_date) + "</create_date>";
                                    sData = sData + "<status_id>" + Validate(oElem.status_id) + "</status_id>";
                                    sData = sData + "<status_name>" + Validate(curLngCommon.request_status_types.GetChildByKey( oElem.status_id ).name) + "</status_name>";
                                    sData = sData + "<link_type_name>eid=" + oElem.id + "&amp;layout=ack&amp;object_type=request&amp;state=active&amp;person=col&amp;filter=none&amp;menu=col_requests&amp;req_id=" + oElem.request_type_id + "</link_type_name>";
                                    sData = sData + "</element>";
                                }

                            }
                            break;
                     }
                     break;
            }
            break;
        case "response":
            switch(sState)
            {
                case "active":
                    switch(sPerson)
                    {
                        case "me":
                            sPageName = "<pagename>Мои отзывы</pagename>";
                            oDoc = XQuery( "for $elem in responses where $elem/person_id = " + curUserID.XQueryLiteral + " return $elem" );

                            sFields = sFields + "<field type=\"id\">eid</field>";
                            sFields = sFields + "<field type=\"date\">create_date</field>";
                            sFields = sFields + "<field type=\"date\">create_date_int</field>";
                            sFields = sFields + "<field type=\"string\">type_id</field>";
                            sFields = sFields + "<field type=\"string\">type_name</field>";
                            sFields = sFields + "<field type=\"string\">object_id</field>";
                            sFields = sFields + "<field type=\"string\">object_name</field>";
                            sFields = sFields + "<field type=\"string\">object_type</field>";

                            sColumns = sColumns + "<column type=\"icon\" file=\"response\" nowrap=\"1\"></column>";
                            sColumns = sColumns + "<column type=\"date\" field=\"create_date\" nowrap=\"1\" sort=\"create_date_int\">Дата создания</column>";
                            sColumns = sColumns + "<column type=\"string\" field=\"type_name\" nowrap=\"1\" sort=\"type_name\" islink=\"1\" linkurl=\"link_type_name\" linkid=\"eid\" linktemplate=\"CardResponse.aspx?action=card&amp;target=response&amp;mode=active\">Тип отзыва</column>";
                            sColumns = sColumns + "<column type=\"string\" field=\"object_name\" sort=\"object_name\">Предмет отзыва</column>";

                            for (oElem in oDoc)
                            {
                                try
                                {
                                    oTmpDoc = OpenDoc( UrlFromDocID( Int(oElem.id) ) ).TopElem;
                                }
                                catch(e)
                                {
                                    continue;
                                }
                                if(!tools_web.check_access(oTmpDoc, curUserID, curUser, Session)) continue;
                                sData = sData + "<element>";
                                sData = sData + "<eid>" + Validate(oElem.id) + "</eid>";
                                sData = sData + "<create_date>" + Validate(oElem.create_date) + "</create_date>";
                                sData = sData + "<type_id>" + Validate(oElem.response_type_id) + "</type_id>";
                                try
                                {
                                    sData = sData + "<type_name>" + Validate(oElem.response_type_id.ForeignElem.name) + "</type_name>";
                                }
                                catch(e)
                                {
                                    sData = sData + "<type_name>" + sObjectDeleted + "</type_name>";
                                }
                                sData = sData + "<object_id>" + Validate(oElem.object_id) + "</object_id>";
                                sData = sData + "<object_name>" + Validate(oElem.object_name) + "</object_name>";
                                sData = sData + "<object_type>" + Validate(oElem.type) + "</object_type>";
                                sData = sData + "<link_type_name>eid=" + oElem.id + "&amp;layout=card&amp;object_type=response&amp;state=active&amp;person=me&amp;filter=none&amp;menu=my_active_responses</link_type_name>";
                                sData = sData + "</element>";
                            }
                            break;

                        case "col":
                            sPageName = "<pagename>Отзывы сотрудников</pagename>";

                            aColleagues = XQuery( "for $elem in collaborators where $elem/org_id = " + sOrgId + " return $elem" );

                            sFields = sFields + "<field type=\"id\">eid</field>";
                            sFields = sFields + "<field type=\"date\">create_date</field>";
                            sFields = sFields + "<field type=\"date\">create_date_int</field>";
                            sFields = sFields + "<field type=\"string\">type_id</field>";
                            sFields = sFields + "<field type=\"string\">type_name</field>";
                            sFields = sFields + "<field type=\"string\">object_id</field>";
                            sFields = sFields + "<field type=\"string\">object_name</field>";
                            sFields = sFields + "<field type=\"string\">object_type</field>";

                            sColumns = sColumns + "<column type=\"icon\" file=\"response\" nowrap=\"1\"></column>";
                            sColumns = sColumns + "<column type=\"string\" field=\"person\" nowrap=\"1\" sort=\"code\">ФИО</column>";
                            sColumns = sColumns + "<column type=\"date\" field=\"create_date\" nowrap=\"1\" sort=\"create_date_int\">Дата создания</column>";
                            sColumns = sColumns + "<column type=\"string\" field=\"type_name\" nowrap=\"1\" sort=\"type_name\" islink=\"1\" linkurl=\"link_type_name\" linkid=\"eid\">Тип отзыва</column>";
                            sColumns = sColumns + "<column type=\"string\" field=\"object_name\" sort=\"object_name\">Предмет отзыва</column>";

                            for (oColleague in aColleagues)
                            {
                                if(oColleague.id == curUserID) continue;
                                oDoc = XQuery( "for $elem in responses where $elem/person_id = " + oColleague.id + " return $elem" );

                                for (oElem in oDoc)
                                {
                                    try
                                    {
                                        oTmpDoc = OpenDoc( UrlFromDocID( Int(oElem.id) ) ).TopElem;
                                    }
                                    catch(e)
                                    {
                                        continue;
                                    }
                                    if(!tools_web.check_access(oTmpDoc, curUserID, curUser, Session)) continue;
                                    sData = sData + "<element>";
                                    sData = sData + "<eid>" + Validate(oElem.id) + "</eid>";
                                    sData = sData + "<person>" + Validate(oElem.person_fullname) + "</person>";
                                    sData = sData + "<create_date>" + Validate(oElem.create_date) + "</create_date>";
                                    sData = sData + "<type_id>" + Validate(oElem.response_type_id) + "</type_id>";
                                    try
                                    {
                                        sData = sData + "<type_name>" + Validate(oElem.response_type_id.ForeignElem.name) + "</type_name>";
                                    }
                                    catch(e)
                                    {
                                        sData = sData + "<type_name>" + sObjectDeleted + "</type_name>";
                                    }
                                    sData = sData + "<object_id>" + Validate(oElem.object_id) + "</object_id>";
                                    sData = sData + "<object_name>" + Validate(oElem.object_name) + "</object_name>";
                                    sData = sData + "<object_type>" + Validate(oElem.type) + "</object_type>";
                                    sData = sData + "<link_type_name>eid=" + oElem.id + "&amp;layout=card&amp;object_type=response&amp;state=active&amp;person=me&amp;filter=none&amp;menu=col_responses</link_type_name>";
                                    sData = sData + "</element>";
                                }

                            }
                            break;
                    }
                    break;
            }
            break;
        case "event":
            switch(sState)
            {
                case "active":
                    switch(sPerson)
                    {
                        case "me":
                            sPageName = "<pagename>Мои мероприятия</pagename>";

			                oDoc1 = XQuery( "for $event in event_collaborators where $event/collaborator_id = " + curUserID.XQueryLiteral + " and $event/is_public = false() and $event/status_id != 'close' return $event" );
			                oDoc2 = XQuery( "for $event in event_collaborators where $event/collaborator_id = " + curUserID.XQueryLiteral + " and $event/is_public = true() and $event/status_id != 'close' return $event" );

                            sFields = sFields + "<field type=\"id\">eid</field>";
                            sFields = sFields + "<field type=\"string\">code</field>";
                            sFields = sFields + "<field type=\"string\">name</field>";
                            sFields = sFields + "<field type=\"string\">type_id</field>";
                            sFields = sFields + "<field type=\"string\">type_name</field>";
                            sFields = sFields + "<field type=\"date\">start_date</field>";
                            sFields = sFields + "<field type=\"number\">start_date_int</field>";
                            sFields = sFields + "<field type=\"date\">finish_date</field>";
                            sFields = sFields + "<field type=\"number\">finish_date_int</field>";
                            sFields = sFields + "<field type=\"string\">person_num</field>";
                            sFields = sFields + "<field type=\"string\">status_id</field>";
                            sFields = sFields + "<field type=\"string\">status_name</field>";

                            sColumns = sColumns + "<column type=\"icon\" file=\"event\" nowrap=\"1\"></column>";
                            sColumns = sColumns + "<column type=\"string\" field=\"code\" sort=\"code\">Код</column>";
                            sColumns = sColumns + "<column type=\"string\" field=\"name\" nowrap=\"1\" sort=\"name\" islink=\"1\" linkurl=\"link_name\" linkid=\"eid\" linktemplate=\"CardEvent.aspx?action=card&amp;target=event&amp;mode=active\">Наименование</column>";
                            sColumns = sColumns + "<column type=\"string\" field=\"type_name\" nowrap=\"1\" sort=\"type_name\">Тип</column>";
                            sColumns = sColumns + "<column type=\"date\" field=\"start_date\" nowrap=\"1\" sort=\"start_date_int\">Дата начала</column>";
                            sColumns = sColumns + "<column type=\"date\" field=\"finish_date\" nowrap=\"1\" sort=\"finish_date_int\">Дата завершения</column>";
                            sColumns = sColumns + "<column type=\"string\" field=\"person_num\" sort=\"person_num\">Число участников</column>";
                            sColumns = sColumns + "<column type=\"string\" field=\"status_name\" sort=\"status_name\">Состояние</column>";

                            for (oElem in oDoc1)
                            {
                                try
                                {
                                    oTmpDoc = OpenDoc( UrlFromDocID( Int(oElem.event_id) ) ).TopElem;
                                }
                                catch(e)
                                {
                                    continue;
                                }
                                if(!tools_web.check_access(oTmpDoc, curUserID, curUser, Session)) continue;
                                sData = sData + "<element>";
                                sData = sData + "<eid>" + Validate(oElem.event_id) + "</eid>";
                                sData = sData + "<code>" + Validate(oElem.code) + "</code>";
                                sData = sData + "<name>" + Validate(oElem.name) + "</name>";
                                sData = sData + "<link_name>eid=" + oElem.event_id + "&amp;layout=card&amp;object_type=event&amp;state=active&amp;person=me&amp;filter=none&amp;menu=my_active_events</link_name>";
                                sData = sData + "<type_id>" + Validate(oElem.type_id) + "</type_id>";
                                try
                                {
                                    sData = sData + "<type_name>" + Validate(oElem.type_id.ForeignElem.name) + "</type_name>";
                                }
                                catch(e)
                                {
                                    sData = sData + "<type_name>" + sObjectDeleted + "</type_name>";
                                }
                                sData = sData + "<start_date>" + Validate(oElem.start_date) + "</start_date>";
                                sData = sData + "<finish_date>" + Validate(oElem.finish_date) + "</finish_date>";
                                sData = sData + "<person_num>" + Validate(oElem.person_num) + "</person_num>";
                                sData = sData + "<status_id>" + Validate(oElem.status_id) + "</status_id>";
                                try
                                {
                                    sData = sData + "<status_name>" + Validate(oElem.status_id.ForeignElem.name) + "</status_name>";
                                }
                                catch(e)
                                {
                                    sData = sData + "<status_name>" + sObjectDeleted + "</status_name>";
                                }
                                sData = sData + "</element>";
                            }

                            for (oElem in oDoc2)
                            {
                                try
                                {
                                    oTmpDoc = OpenDoc( UrlFromDocID( Int(oElem.event_id) ) ).TopElem;
                                }
                                catch(e)
                                {
                                    continue;
                                }
                                if(!tools_web.check_access(oTmpDoc, curUserID, curUser, Session)) continue;
                                sData = sData + "<element>";
                                sData = sData + "<eid>" + Validate(oElem.event_id) + "</eid>";
                                sData = sData + "<code>" + Validate(oElem.code) + "</code>";
                                sData = sData + "<name>" + Validate(oElem.name) + "</name>";
                                sData = sData + "<link_name>eid=" + oElem.event_id + "&amp;layout=card&amp;object_type=event&amp;state=active&amp;person=me&amp;filter=none&amp;menu=my_active_events</link_name>";
                                sData = sData + "<type_id>" + Validate(oElem.type_id) + "</type_id>";
                                try
                                {
                                    sData = sData + "<type_name>" + Validate(oElem.type_id.ForeignElem.name) + "</type_name>";
                                }
                                catch(e)
                                {
                                    sData = sData + "<type_name>" + sObjectDeleted + "</type_name>";
                                }
                                sData = sData + "<start_date>" + Validate(oElem.start_date) + "</start_date>";
                                sData = sData + "<finish_date>" + Validate(oElem.finish_date) + "</finish_date>";
                                sData = sData + "<person_num>" + Validate(oElem.person_num) + "</person_num>";
                                sData = sData + "<status_id>" + Validate(oElem.status_id) + "</status_id>";
                                try
                                {
                                    sData = sData + "<status_name>" + Validate(oElem.status_id.ForeignElem.name) + "</status_name>";
                                }
                                catch(e)
                                {
                                    sData = sData + "<status_name>" + sObjectDeleted + "</status_name>";
                                }
                                sData = sData + "</element>";
                            }


                            break;
                    }
                    break;
                case "archive":
                    break;
                case "all":
                    sPageName = "<pagename>Мероприятия</pagename>";

	                oDoc1 = XQuery( "for $event in event_collaborators where $event/collaborator_id = " + curUserID.XQueryLiteral + " and $event/is_public = false() and $event/status_id != 'close' return $event" );
                    oDoc2 = XQuery( "for $event in events where $event/is_public = true() and $event/status_id != 'close' return $event" );

                    sFields = sFields + "<field type=\"id\">eid</field>";
                    sFields = sFields + "<field type=\"string\">code</field>";
                    sFields = sFields + "<field type=\"string\">name</field>";
                    sFields = sFields + "<field type=\"string\">type_id</field>";
                    sFields = sFields + "<field type=\"string\">type_name</field>";
                    sFields = sFields + "<field type=\"date\">start_date</field>";
                    sFields = sFields + "<field type=\"number\">start_date_int</field>";
                    sFields = sFields + "<field type=\"date\">finish_date</field>";
                    sFields = sFields + "<field type=\"number\">finish_date_int</field>";
                    sFields = sFields + "<field type=\"string\">person_num</field>";
                    sFields = sFields + "<field type=\"string\">status_id</field>";
                    sFields = sFields + "<field type=\"string\">status_name</field>";

                    sColumns = sColumns + "<column type=\"icon\" file=\"event\" nowrap=\"1\"></column>";
                    sColumns = sColumns + "<column type=\"string\" field=\"code\" sort=\"code\">Код</column>";
                    sColumns = sColumns + "<column type=\"string\" field=\"name\" nowrap=\"1\" sort=\"name\" islink=\"1\" linkurl=\"link_name\" linkid=\"eid\" linktemplate=\"CardEvent.aspx?action=card&amp;target=event&amp;mode=active\">Наименование</column>";
                    sColumns = sColumns + "<column type=\"string\" field=\"type_name\" nowrap=\"1\" sort=\"type_name\">Тип</column>";
                    sColumns = sColumns + "<column type=\"date\" field=\"start_date\" nowrap=\"1\" sort=\"start_date_int\">Дата начала</column>";
                    sColumns = sColumns + "<column type=\"date\" field=\"finish_date\" nowrap=\"1\" sort=\"finish_date_int\">Дата завершения</column>";
                    sColumns = sColumns + "<column type=\"string\" field=\"person_num\" sort=\"person_num\">Число участников</column>";
                    sColumns = sColumns + "<column type=\"string\" field=\"status_name\" sort=\"status_name\">Состояние</column>";

                    for (oElem in oDoc1)
                    {
                        try
                        {
                            oTmpDoc = OpenDoc( UrlFromDocID( Int(oElem.event_id) ) ).TopElem;
                        }
                        catch(e)
                        {
                            continue;
                        }
                        if(!tools_web.check_access(oTmpDoc, curUserID, curUser, Session)) continue;
                        sData = sData + "<element>";
                        sData = sData + "<eid>" + Validate(oElem.event_id) + "</eid>";
                        sData = sData + "<code>" + Validate(oElem.code) + "</code>";
                        sData = sData + "<name>" + Validate(oElem.name) + "</name>";
                        sData = sData + "<link_name>eid=" + oElem.event_id + "&amp;layout=card&amp;object_type=event&amp;state=all&amp;person=me&amp;filter=none&amp;menu=events</link_name>";
                        sData = sData + "<type_id>" + Validate(oElem.type_id) + "</type_id>";
                        try
                        {
                            sData = sData + "<type_name>" + Validate(oElem.type_id.ForeignElem.name) + "</type_name>";
                        }
                        catch(e)
                        {
                            sData = sData + "<type_name>" + sObjectDeleted + "</type_name>";
                        }
                        sData = sData + "<start_date>" + Validate(oElem.start_date) + "</start_date>";
                        sData = sData + "<finish_date>" + Validate(oElem.finish_date) + "</finish_date>";
                        sData = sData + "<person_num>" + Validate(oElem.person_num) + "</person_num>";
                        sData = sData + "<status_id>" + Validate(oElem.status_id) + "</status_id>";
                        try
                        {
                            sData = sData + "<status_name>" + Validate(oElem.status_id.ForeignElem.name) + "</status_name>";
                        }
                        catch(e)
                        {
                            sData = sData + "<status_name>" + sObjectDeleted + "</status_name>";
                        }
                        sData = sData + "</element>";
                    }
                    for (oElem in oDoc2)
                    {
                        try
                        {
                            oTmpDoc = OpenDoc( UrlFromDocID( Int(oElem.id) ) ).TopElem;
                        }
                        catch(e)
                        {
                            continue;
                        }
                        if(!tools_web.check_access(oTmpDoc, curUserID, curUser, Session)) continue;
                        sData = sData + "<element>";
                        sData = sData + "<eid>" + Validate(oElem.id) + "</eid>";
                        sData = sData + "<code>" + Validate(oElem.code) + "</code>";
                        sData = sData + "<name>" + Validate(oElem.name) + "</name>";
                        sData = sData + "<link_name>eid=" + oElem.id + "&amp;layout=card&amp;object_type=event&amp;state=all&amp;person=me&amp;filter=none&amp;menu=events</link_name>";
                        sData = sData + "<type_id>" + Validate(oElem.type_id) + "</type_id>";
                        try
                        {
                            sData = sData + "<type_name>" + Validate(oElem.type_id.ForeignElem.name) + "</type_name>";
                        }
                        catch(e)
                        {
                            sData = sData + "<type_name>" + sObjectDeleted + "</type_name>";
                        }
                        sData = sData + "<start_date>" + Validate(oElem.start_date) + "</start_date>";
                        sData = sData + "<finish_date>" + Validate(oElem.finish_date) + "</finish_date>";
                        sData = sData + "<person_num>" + Validate(oElem.person_num) + "</person_num>";
                        sData = sData + "<status_id>" + Validate(oElem.status_id) + "</status_id>";
                        try
                        {
                            sData = sData + "<status_name>" + Validate(oElem.status_id.ForeignElem.name) + "</status_name>";
                        }
                        catch(e)
                        {
                            sData = sData + "<status_name>" + sObjectDeleted + "</status_name>";
                        }
                        sData = sData + "</element>";
                    }
                    break;
            }
            break;
    }

    sData = sData + "</data>";
    sColumns = sColumns + "</columns>";
    sFields = sFields + "</fields>";
    sActions = sActions + "</actions>";
    sError = sError + "</error>";

    return sPageName + sData + sFields + sColumns + sActions + sError;
}

function Multilist()
{
    sLists = "";
    sData = "<data>";
    sColumns = "<columns>";
    sFields = "<fields>";
    sPageName = "";

/*    switch(sObjectType)
    {
        case "all":*/
            switch(sState)
            {
                case "archive":
                    switch(sPerson)
                    {
                        case "me":
                            sLists = sLists + "<pagename>Мой архив обучения</pagename>";
                            sLists = sLists + "<pages>";
                            sLists = sLists + "<page><id>courses</id><name>Курсы</name></page>";
                            sLists = sLists + "<page><id>tests</id><name>Тесты</name></page>";
                            sLists = sLists + "<page><id>events</id><name>Мероприятия</name></page>";
                            /*sLists = sLists + "<page><id>requests</id><name>Запросы</name></page>";
                            sLists = sLists + "<page><id>responses</id><name>Отзывы</name></page>";*/
                            sLists = sLists + "</pages>";

                            sLists = sLists + "<item id=\"courses\">";

                            oDoc = XQuery( "for $elem in learnings where $elem/person_id = " + curUserID.XQueryLiteral + " order by $elem/last_usage_date descending return $elem" );

                            sFields = sFields + "<field type=\"id\">eid</field>";
                            sFields = sFields + "<field type=\"string\">course_id</field>";
                            sFields = sFields + "<field type=\"string\">course_code</field>";
                            sFields = sFields + "<field type=\"string\">course_name</field>";
                            sFields = sFields + "<field type=\"date\">start_usage_date</field>";
                            sFields = sFields + "<field type=\"number\">start_usage_date_int</field>";
                            sFields = sFields + "<field type=\"date\">last_usage_date</field>";
                            sFields = sFields + "<field type=\"number\">last_usage_date_int</field>";
                            sFields = sFields + "<field type=\"number\">score</field>";
                            sFields = sFields + "<field type=\"number\">state_id</field>";
                            sFields = sFields + "<field type=\"string\">state_name</field>";
                            sFields = sFields + "<field type=\"string\">action_string</field>";

                            sColumns = sColumns + "<column type=\"icon\" file=\"folder\" nowrap=\"1\"></column>";
                            sColumns = sColumns + "<column type=\"string\" field=\"course_code\" nowrap=\"1\" sort=\"course_code\">Код</column>";
                            sColumns = sColumns + "<column type=\"string\" field=\"course_name\" sort=\"course_name\" islink=\"1\" linkurl=\"link_course_name\" linkid=\"course_id\" linktemplate=\"Card.aspx?action=card&amp;target=course&amp;mode=full\">Наименование</column>";
                            sColumns = sColumns + "<column type=\"date\" field=\"start_usage_date\" nowrap=\"1\" sort=\"start_usage_date_int\">Начат</column>";
                            sColumns = sColumns + "<column type=\"date\" field=\"last_usage_date\" nowrap=\"1\" sort=\"last_usage_date_int\">Последний вход</column>";
                            sColumns = sColumns + "<column type=\"number\" field=\"score\" nowrap=\"1\" sort=\"score\">Результат</column>";
                            sColumns = sColumns + "<column type=\"string\" field=\"state_name\" nowrap=\"1\" sort=\"state_id\">Состояние</column>";
                            sColumns = sColumns + "<column type=\"string\" field=\"action_string\" nowrap=\"1\" sort=\"state_id\" islink=\"1\" linkurl=\"link_action_string\" linkid=\"eid\" linktemplate=\"Card.aspx?action=card&amp;target=course&amp;mode=archive\">Действие</column>";

                            for (oElem in oDoc)
                            {
                                try
                                {
                                    oTmpDoc = OpenDoc( UrlFromDocID( Int(oElem.id) ) ).TopElem;
                                }
                                catch(e)
                                {
                                    continue;
                                }
                                if(!tools_web.check_access(oTmpDoc, curUserID, curUser, Session)) continue;
                                sData = sData + "<element>";
                                sData = sData + "<eid>" + Validate(oElem.id) + "</eid>";
                                sData = sData + "<course_id>" + Validate(oElem.course_id) + "</course_id>";
                                try
                                {
                                    sData = sData + "<course_code>" + Validate(oElem.course_id.ForeignElem.code) + "</course_code>";
                                    sData = sData + "<course_name>" + Validate(oElem.course_id.ForeignElem.name) + "</course_name>";
                                }
                                catch(e)
                                {
                                    sData = sData + "<course_code>" + sObjectDeleted + "</course_code>";
                                    sData = sData + "<course_name>" + sObjectDeleted + "</course_name>";
                                }
                                sData = sData + "<start_usage_date>" + Validate(oElem.start_usage_date) + "</start_usage_date>";
                                try {
                                    iDate = DateToRawSeconds(oElem.start_usage_date);
                                }
                                catch(e)
                                {
                                    iDate = 0;
                                }
                                sData = sData + "<start_usage_date_int>" + String(iDate) + "</start_usage_date_int>";
                                sData = sData + "<last_usage_date>" + Validate(oElem.last_usage_date) + "</last_usage_date>";
                                try {
                                    iDate = DateToRawSeconds(oElem.last_usage_date);
                                }
                                catch(e)
                                {
                                    iDate = 0;
                                }
                                sData = sData + "<last_usage_date_int>" + String(iDate) + "</last_usage_date_int>";
                                sData = sData + "<score>" + Validate(oElem.score) + "</score>";
                                sData = sData + "<state_id>" + Validate(oElem.state_id) + "</state_id>";
                                sData = sData + "<action_string>Просмотреть</action_string>";
                                sData = sData + "<state_name>" + Validate(common.learning_states.GetChildByKey( oElem.state_id ).name) + "</state_name>";
                                sData = sData + "<link_course_name>eid=" + oElem.course_id + "&amp;layout=card&amp;object_type=course&amp;state=archive&amp;person=me&amp;filter=none&amp;menu=my_archive_all</link_course_name>";
                                sData = sData + "<link_action_string>eid=" + oElem.id + "&amp;layout=review&amp;object_type=course&amp;state=archive&amp;person=me&amp;filter=none&amp;menu=my_archive_all&amp;action=view</link_action_string>";
                                sData = sData + "</element>";
                            }

                            sData = sData + "</data>";
                            sColumns = sColumns + "</columns>";
                            sFields = sFields + "</fields>";

                            sLists = sLists + sFields + sColumns + sData + "</item>";

                            sData = "<data>";
                            sColumns = "<columns>";
                            sFields = "<fields>";

                            sLists = sLists + "<item id=\"tests\">";

                            oDoc = XQuery( "for $elem in test_learnings where $elem/person_id = " + curUserID.XQueryLiteral + " order by $elem/last_usage_date descending return $elem" );

                            sFields = sFields + "<field type=\"id\">eid</field>";
                            sFields = sFields + "<field type=\"string\">test_id</field>";
                            sFields = sFields + "<field type=\"string\">test_code</field>";
                            sFields = sFields + "<field type=\"string\">test_name</field>";
                            sFields = sFields + "<field type=\"date\">start_usage_date</field>";
                            sFields = sFields + "<field type=\"number\">start_usage_date_int</field>";
                            sFields = sFields + "<field type=\"date\">last_usage_date</field>";
                            sFields = sFields + "<field type=\"number\">last_usage_date_int</field>";
                            sFields = sFields + "<field type=\"number\">score</field>";
                            sFields = sFields + "<field type=\"number\">max_score</field>";
                            sFields = sFields + "<field type=\"number\">state_id</field>";
                            sFields = sFields + "<field type=\"string\">state_name</field>";
                            sFields = sFields + "<field type=\"string\">action_string</field>";

                            sColumns = sColumns + "<column type=\"icon\" file=\"test\" nowrap=\"1\"></column>";
                            sColumns = sColumns + "<column type=\"string\" field=\"test_code\" nowrap=\"1\" sort=\"test_code\">Код</column>";
                            sColumns = sColumns + "<column type=\"string\" field=\"test_name\" sort=\"test_name\" islink=\"1\" linkurl=\"link_test_name\" linkid=\"test_id\" linktemplate=\"Card.aspx?action=card&amp;target=test&amp;mode=full\">Наименование</column>";
                            sColumns = sColumns + "<column type=\"date\" field=\"start_usage_date\" nowrap=\"1\" sort=\"start_usage_date_int\">Начат</column>";
                            sColumns = sColumns + "<column type=\"date\" field=\"last_usage_date\" nowrap=\"1\" sort=\"last_usage_date_int\">Последний вход</column>";
                            sColumns = sColumns + "<column type=\"number\" field=\"score\" nowrap=\"1\" sort=\"score\">Результат</column>";
                            sColumns = sColumns + "<column type=\"number\" field=\"max_score\" nowrap=\"1\" sort=\"score\">Макс.оценка</column>";
                            sColumns = sColumns + "<column type=\"string\" field=\"state_name\" nowrap=\"1\" sort=\"state_id\">Состояние</column>";
                            sColumns = sColumns + "<column type=\"string\" field=\"action_string\" nowrap=\"1\" sort=\"state_id\" islink=\"1\" linkurl=\"link_action_string\" linkid=\"eid\" linktemplate=\"Card.aspx?action=card&amp;target=test&amp;mode=active\">Действие</column>";

                            for (oElem in oDoc)
                            {
                                try
                                {
                                    oTmpDoc = OpenDoc( UrlFromDocID( Int(oElem.id) ) ).TopElem;
                                }
                                catch(e)
                                {
                                    continue;
                                }
                                if(!tools_web.check_access(oTmpDoc, curUserID, curUser, Session)) continue;
                                sData = sData + "<element>";
                                sData = sData + "<eid>" + Validate(oElem.id) + "</eid>";
                                sData = sData + "<test_id>" + Validate(oElem.assessment_id) + "</test_id>";
                                sData = sData + "<test_code>";
                                try
                                {
                                    sData = sData + Validate(oElem.assessment_id.ForeignElem.code);
                                }
                                catch(e) {
                                    sData = sData + sObjectDeleted;
                                }
                                sData = sData + "</test_code>";
                                try
                                {
                                    sData = sData + "<test_name>" + Validate(oElem.assessment_id.ForeignElem.title) + "</test_name>";
                                }
                                catch(e)
                                {
                                    sData = sData + "<test_name>" + sObjectDeleted + "</test_name>";
                                }
                                sData = sData + "<start_usage_date>" + Validate(oElem.start_usage_date) + "</start_usage_date>";
                                try {
                                    iDate = DateToRawSeconds(oElem.start_usage_date);
                                }
                                catch(e)
                                {
                                    iDate = 0;
                                }
                                sData = sData + "<start_usage_date_int>" + String(iDate) + "</start_usage_date_int>";
                                sData = sData + "<last_usage_date>" + Validate(oElem.last_usage_date) + "</last_usage_date>";
                                try {
                                    iDate = DateToRawSeconds(oElem.last_usage_date);
                                }
                                catch(e)
                                {
                                    iDate = 0;
                                }
                                sData = sData + "<last_usage_date_int>" + String(iDate) + "</last_usage_date_int>";
                                sData = sData + "<score>" + Validate(oElem.score) + "</score>";
                                sData = sData + "<max_score>" + Validate(oElem.max_score) + "</max_score>";
                                sData = sData + "<state_id>" + Validate(oElem.state_id) + "</state_id>";
                                sData = sData + "<action_string>Просмотреть</action_string>";
                                sData = sData + "<state_name>" + Validate(common.learning_states.GetChildByKey( oElem.state_id ).name) + "</state_name>";
                                sData = sData + "<link_test_name>eid=" + oElem.assessment_id + "&amp;layout=card&amp;object_type=test&amp;state=archive&amp;person=me&amp;filter=none&amp;menu=my_archive_all</link_test_name>";
                                sData = sData + "<link_action_string>eid=" + oElem.id + "&amp;layout=review&amp;object_type=test&amp;state=archive&amp;person=me&amp;filter=none&amp;menu=my_archive_all&amp;action=view</link_action_string>";
                                sData = sData + "</element>";
                            }

                            sData = sData + "</data>";
                            sColumns = sColumns + "</columns>";
                            sFields = sFields + "</fields>";

                            sLists = sLists + sFields + sColumns + sData + "</item>";

                            sData = "<data>";
                            sColumns = "<columns>";
                            sFields = "<fields>";

                            sLists = sLists + "<item id=\"events\">";

	                        oDoc1 = XQuery( "for $event in event_collaborators where $event/collaborator_id = " + curUserID.XQueryLiteral + " and $event/is_public = false() and $event/status_id = 'close' return $event" );

                            sFields = sFields + "<field type=\"id\">eid</field>";
                            sFields = sFields + "<field type=\"string\">code</field>";
                            sFields = sFields + "<field type=\"string\">name</field>";
                            sFields = sFields + "<field type=\"string\">type_id</field>";
                            sFields = sFields + "<field type=\"string\">type_name</field>";
                            sFields = sFields + "<field type=\"date\">start_date</field>";
                            sFields = sFields + "<field type=\"number\">start_date_int</field>";
                            sFields = sFields + "<field type=\"date\">finish_date</field>";
                            sFields = sFields + "<field type=\"number\">finish_date_int</field>";
                            sFields = sFields + "<field type=\"string\">person_num</field>";
                            sFields = sFields + "<field type=\"string\">status_id</field>";
                            sFields = sFields + "<field type=\"string\">status_name</field>";

                            sColumns = sColumns + "<column type=\"icon\" file=\"event\" nowrap=\"1\"></column>";
                            sColumns = sColumns + "<column type=\"string\" field=\"code\" sort=\"code\">Код</column>";
                            sColumns = sColumns + "<column type=\"string\" field=\"name\" nowrap=\"1\" sort=\"name\" islink=\"1\" linkurl=\"link_name\" linkid=\"eid\" linktemplate=\"CardEvent.aspx?action=card&amp;target=event&amp;mode=active\">Наименование</column>";
                            sColumns = sColumns + "<column type=\"string\" field=\"type_name\" nowrap=\"1\" sort=\"type_name\">Тип</column>";
                            sColumns = sColumns + "<column type=\"date\" field=\"start_date\" nowrap=\"1\" sort=\"start_date_int\">Дата начала</column>";
                            sColumns = sColumns + "<column type=\"date\" field=\"finish_date\" nowrap=\"1\" sort=\"finish_date_int\">Дата завершения</column>";
                            sColumns = sColumns + "<column type=\"string\" field=\"person_num\" sort=\"person_num\">Число участников</column>";
                            sColumns = sColumns + "<column type=\"string\" field=\"status_name\" sort=\"status_name\">Состояние</column>";
                            sColumns = sColumns + "<column type=\"string\" field=\"action_string\" nowrap=\"1\" sort=\"state_id\" islink=\"1\" linkurl=\"link_action_string\" linkid=\"eid\">Действие</column>";

                            for (oElem in oDoc1)
                            {
                                try
                                {
                                    oTmpDoc = OpenDoc( UrlFromDocID( Int(oElem.event_id) ) ).TopElem;
                                                                }
                                catch(e)
                                {
                                    continue;
                                }
                                if(!tools_web.check_access(oTmpDoc, curUserID, curUser, Session)) continue;
                                sData = sData + "<element>";
                                sData = sData + "<eid>" + Validate(oElem.event_id) + "</eid>";
                                sRespId = oTmpDoc.default_response_type_id;
                                sData = sData + "<code>" + Validate(oElem.code) + "</code>";
                                sData = sData + "<name>" + Validate(oElem.name) + "</name>";
                                sData = sData + "<link_name>eid=" + oElem.event_id + "&amp;layout=card&amp;object_type=event&amp;state=archive&amp;person=me&amp;filter=none&amp;menu=my_archive_all</link_name>";
                                sData = sData + "<type_id>" + Validate(oElem.type_id) + "</type_id>";
                                try
                                {
                                    sData = sData + "<type_name>" + Validate(oElem.type_id.ForeignElem.name) + "</type_name>";
                                }
                                catch(e)
                                {
                                    sData = sData + "<type_name>" + sObjectDeleted + "</type_name>";
                                }
                                sData = sData + "<start_date>" + Validate(oElem.start_date) + "</start_date>";
                                sData = sData + "<finish_date>" + Validate(oElem.finish_date) + "</finish_date>";
                                sData = sData + "<person_num>" + Validate(oElem.person_num) + "</person_num>";
                                sData = sData + "<status_id>" + Validate(oElem.status_id) + "</status_id>";
                                try
                                {
                                    sData = sData + "<status_name>" + Validate(oElem.status_id.ForeignElem.name) + "</status_name>";
                                }
                                catch(e)
                                {
                                    sData = sData + "<status_name>" + sObjectDeleted + "</status_name>";
                                }
                                sData = sData + "<action_string>Написать отзыв</action_string>";
                                sData = sData + "<link_action_string>eid=" + oElem.event_id + "&amp;layout=form&amp;object_type=response&amp;state=archive&amp;person=me&amp;filter=none&amp;menu=my_active_responses&amp;resp_id=" + sRespId + "</link_action_string>";
                                sData = sData + "</element>";
                            }

                            sData = sData + "</data>";
                            sColumns = sColumns + "</columns>";
                            sFields = sFields + "</fields>";

                            sLists = sLists + sFields + sColumns + sData + "</item>";
                            break;
                    }
                    break;
             }
/*             break;
    }*/
    return sLists;

}

function Summary()
{
    sPageName = "<pagename>Мой план обучения</pagename>";
    sPageName = sPageName + "<pageheader>На сегодня, " + StrDate( DateNewTime( Date() ) ) + ":</pageheader>";

    sRows = "<rows>";
    sRows = sRows + "<row><type>total</type><target>courses</target><name>Всего активных курсов</name><value>count</value></row>"
    sRows = sRows + "<row><type>subtotal</type><target>courses</target><filter>notfinished</filter><name>Из них начато, но не закончено</name><value>count</value></row>"
    sRows = sRows + "<row><type>list</type><target>courses</target><filter>notfinished</filter><name></name><value></value></row>"
    sRows = sRows + "<row><type>subtotal</type><target>courses</target><filter>notstarted</filter><name>Из них не начато</name><value>count</value></row>"
    sRows = sRows + "<row><type>list</type><target>courses</target><filter>notstarted</filter><name></name><value></value></row>"
    sRows = sRows + "<row><type>total</type><target>tests</target><name>Всего активных тестов</name><value>count</value></row>"
    sRows = sRows + "<row><type>subtotal</type><target>tests</target><filter>notfinished</filter><name>Из них начато, но не закончено</name><value>count</value></row>"
    sRows = sRows + "<row><type>list</type><target>tests</target><filter>notfinished</filter><name></name><value></value></row>"
    sRows = sRows + "<row><type>subtotal</type><target>tests</target><filter>notstarted</filter><name>Из них не начато</name><value>count</value></row>"
    sRows = sRows + "<row><type>list</type><target>tests</target><filter>notstarted</filter><name></name><value></value></row>"
    sRows = sRows + "<row><type>total</type><target>events</target><name>Всего мероприятий</name><value>count</value></row>"
    sRows = sRows + "<row><type>subtotal</type><target>events</target><filter>active</filter><name>Из них активных</name><value>count</value></row>"
    sRows = sRows + "<row><type>list</type><target>events</target><filter>active</filter><name></name><value></value></row>"
    sRows = sRows + "<row><type>subtotal</type><target>events</target><filter>planned</filter><name>Из них планируется</name><value>count</value></row>"
    sRows = sRows + "<row><type>list</type><target>events</target><filter>planned</filter><name></name><value></value></row>"
    sRows = sRows + "</rows>";

    sData = "<data>";

    aActiveCourses = XQuery( "for $elem in active_learnings where $elem/person_id = " + curUserID.XQueryLiteral + " return $elem" );
    aActiveTests = XQuery( "for $elem in active_test_learnings where $elem/person_id = " + curUserID.XQueryLiteral + " return $elem" );
	aEvents = XQuery( "for $event in event_collaborators where $event/collaborator_id = " + curUserID.XQueryLiteral + " and $event/is_public = false() and $event/status_id != 'close' return $event" );

    sData = sData + "<items id=\"courses\">"

    for ( oCourse in aActiveCourses )
    {
        try
        {
            oTmpDoc = OpenDoc( UrlFromDocID( Int(oCourse.course_id) ) ).TopElem;
        }
        catch(e)
        {
            continue;
        }
        if(!tools_web.check_access(oTmpDoc, curUserID, curUser, Session)) continue;
        if (oCourse.last_usage_date!=null && oCourse.last_usage_date!="")
        {
            sData = sData + "<item filter=\"notfinished\">";
        }
        else
        {
            sData = sData + "<item filter=\"notstarted\">";
        }
        sData = sData + "<eid>" + oCourse.id + "</eid>";
        try
        {
            sData = sData + "<code>" + Validate(oCourse.course_id.ForeignElem.code) + "</code>";
            sData = sData + "<name>" + Validate(oCourse.course_id.ForeignElem.name) + "</name>";
        }
        catch(e)
        {
            sData = sData + "<code>" + sObjectDeleted + "</code>";
            sData = sData + "<name>" + sObjectDeleted + "</name>";
        }
        sData = sData + "<url>layout=launch&amp;object_type=course&amp;state=active&amp;eid=" + oCourse.id + "&amp;filter=none&amp;person=me&amp;menu=my_active_courses</url>";
        sData = sData + "</item>";
    }
    sData = sData + "</items>";

    sData = sData + "<items id=\"tests\">"

    for ( oTest in aActiveTests )
    {
        try
        {
            oTmpDoc = OpenDoc( UrlFromDocID( Int(oTest.assessment_id) ) ).TopElem;
        }
        catch(e)
        {
            continue;
        }
        if(!tools_web.check_access(oTmpDoc, curUserID, curUser, Session)) continue;
        if (oTest.last_usage_date!=null && oTest.last_usage_date!="")
        {
            sData = sData + "<item filter=\"notfinished\">";
        }
        else
        {
            sData = sData + "<item filter=\"notstarted\">";
        }
        sData = sData + "<eid>" + oTest.id + "</eid>";
        try
        {
            sData = sData + "<code>" + Validate(oTest.assessment_id.ForeignElem.code) + "</code>";
            sData = sData + "<name>" + Validate(oTest.assessment_id.ForeignElem.title) + "</name>";
        }
        catch(e)
        {
            sData = sData + "<code>" + sObjectDeleted + "</code>";
            sData = sData + "<name>" + sObjectDeleted + "</name>";
        }
        sData = sData + "<url>layout=launch&amp;object_type=test&amp;state=active&amp;eid=" + oTest.id + "&amp;filter=none&amp;person=me&amp;menu=my_active_tests</url>";
        sData = sData + "</item>";
    }
    sData = sData + "</items>";

    sData = sData + "<items id=\"events\">"
    for ( oEvent in aEvents )
    {
        try
        {
            oTmpDoc = OpenDoc( UrlFromDocID( Int(oEvent.event_id) ) ).TopElem;
        }
        catch(e)
        {
            continue;
        }
        if(!tools_web.check_access(oTmpDoc, curUserID, curUser, Session)) continue;
        if(oEvent.status_id=="plan")
        {
            sData = sData + "<item filter=\"planned\">";
        }
        else
        {
            sData = sData + "<item filter=\"active\">";
        }
        sData = sData + "<eid>" + oEvent.event_id + "</eid>";
        sData = sData + "<code>" + oEvent.code + "</code>";
        sData = sData + "<name>" + oEvent.name + "</name>";
        sData = sData + "<url>layout=card&amp;object_type=event&amp;state=active&amp;eid=" + oEvent.event_id + "&amp;filter=none&amp;person=me&amp;menu=my_active_events</url>";
        sData = sData + "</item>";
    }
    sData = sData + "</items>";

    sData = sData + "</data>";
    return sPageName + sRows + sData ;
}

function Card()
{
    sCard = "";
    sData = "<data>";
    sFields = "<fields>";
    sRows = "<rows>";
    sActions = "<actions>";
    sError = "<error>";

    switch(sObjectType)
    {
        case "response":
        	oDoc = OpenDoc( UrlFromDocID( iEId ) ).TopElem;
        	aResponses = XQuery (" for $elem in responses where $elem/id = " + iEId + " return $elem ");
        	oElem = ArrayFirstElem(aResponses);
        	try
        	{
                sName = Validate(oElem.response_type_id.ForeignElem.name);
            }
            catch(e)
            {
                sName = sObjectDeleted;
            }
            sCard = sCard + "<pagename>" + sName + "</pagename>";
            sData = sData + "<element>";

            sRows = sRows + "<row type=\"string\" field=\"type_name\">Тип:</row>";
            if ( oDoc.type.HasValue )
            {
			    _common_obj = common.exchange_object_types.GetChildByKey( oDoc.type );
                sData = sData + "<objtitle>" + _common_obj.title + "</objtitle>";
                sData = sData + "<objname>" + oDoc.object_name + "</objname>";
                sRows = sRows + "<row type=\"string\" field=\"objname\">" + _common_obj.title + ":</row>";
            }
            sRows = sRows + "<row type=\"string\" field=\"create_date\">Дата составления:</row>";
            sRows = sRows + "<row type=\"string\" field=\"person_name\">ФИО:</row>";
            sRows = sRows + "<row type=\"string\" field=\"person_position\">Должность:</row>";
            sRows = sRows + "<row type=\"string\" field=\"person_subdivision\">Подразделение:</row>";
            sRows = sRows + "<row type=\"string\" field=\"comment\">Комментарий:</row>";

		    sData = sData + "<eid>" + sEId + "</eid>";
		    sData = sData + "<type_id>" + oElem.response_type_id + "</type_id>";
		    sData = sData + "<type_name>" + sName + "</type_name>";
		    sData = sData + "<create_date>" + oDoc.create_date + "</create_date>";
		    sData = sData + "<person_name>" + oElem.person_fullname + "</person_name>";
		    try
		    {
		        sData = sData + "<person_position>" + oElem.person_id.ForeignElem.position_name + "</person_position>";
		    }
		    catch(e)
		    {
		        sData = sData + "<person_position>" + sObjectDeleted + "</person_position>";
		    }
		    sData = sData + "<person_subdivision>" + oElem.person_org_name + "</person_subdivision>";

		    sData = sData + "<comment>" + oDoc.comment + "</comment>";

		    aItem  = tools.get_custom_template( "response_type", oElem.response_type_id, oDoc );
		    aFields = oDoc.custom_elems;
		    if(aItem!=null && aFields!=null)
		    {
		        aInputs = aItem.fields;
    		    for (var i=0;i<ArrayCount(aInputs);i++)
    		    {
		            if(aInputs[i].disp_web)
		            {
                        sData = sData + "<" + aInputs[i].name + ">";
                        try
                        {
                            oItem = ArrayFind(aFields,"name==aInputs[i].name");
                            sData = sData + oItem.value;
                        }
                        catch(e)
                        {
                        }
	                    sData = sData + "</" + aInputs[i].name + ">";
	                    sRows = sRows + "<row type=\"string\" field=\"" + aInputs[i].name + "\">" + aInputs[i].title + "</row>";
		            }
		        }
		    }

	        sData = sData + "</element>";
            break;
        case "request":
        	oDoc = OpenDoc( UrlFromDocID( iEId ) ).TopElem;
        	aRequests = XQuery (" for $elem in requests where $elem/id = " + iEId + " return $elem ");
        	oElem = ArrayFirstElem(aRequests);
        	try
        	{
                sName = Validate(oDoc.request_type_id.ForeignElem.name);
            }
            catch(e)
            {
                sName = sObjectDeleted;
            }
            sCard = sCard + "<pagename>" + sName + "</pagename>";
            sData = sData + "<element>";

            sRows = sRows + "<row type=\"string\" field=\"type_name\">Тип:</row>";
            if ( oDoc.type.HasValue )
            {
			    _common_obj = common.exchange_object_types.GetChildByKey( oDoc.type );
                sData = sData + "<objtitle>" + _common_obj.title + "</objtitle>";
                sData = sData + "<objname>" + oDoc.object_name + "</objname>";
                sRows = sRows + "<row type=\"string\" field=\"objname\">" + _common_obj.title + ":</row>";
            }
            sRows = sRows + "<row type=\"string\" field=\"state_name\">Состояние:</row>";
            sRows = sRows + "<row type=\"string\" field=\"person_name\">ФИО:</row>";
            sRows = sRows + "<row type=\"string\" field=\"person_position\">Должность:</row>";
            sRows = sRows + "<row type=\"string\" field=\"person_subdivision\">Подразделение:</row>";

		    sData = sData + "<eid>" + sEId + "</eid>";
		    sData = sData + "<type_id>" + oDoc.request_type_id + "</type_id>";
		    sData = sData + "<type_name>" + sName + "</type_name>";
		    sData = sData + "<person_name>" + oDoc.person_fullname + "</person_name>";
		    sData = sData + "<person_position>" + oDoc.person_position_name + "</person_position>";
		    sData = sData + "<person_subdivision>" + oDoc.person_subdivision_name + "</person_subdivision>";

		    aItem  = tools.get_custom_template( "request_type", oDoc.request_type_id, oDoc );
		    aFields = oDoc.custom_elems;
		    if(aItem!=null && aFields!=null)
		    {
		        aInputs = aItem.fields;
    		    for (var i=0;i<ArrayCount(aInputs);i++)
    		    {
		            if(aInputs[i].disp_web)
		            {
                        sData = sData + "<" + aInputs[i].name + ">";
                        try
                        {
                            oItem = ArrayFind(aFields,"name==aInputs[i].name");
                            sData = sData + oItem.value;
                        }
                        catch(e)
                        {
                        }
	                    sData = sData + "</" + aInputs[i].name + ">";
	                    sRows = sRows + "<row type=\"string\" field=\"" + aInputs[i].name + "\">" + aInputs[i].title + "</row>";
		            }
		        }
		    }

		    sData = sData + "<comment>" + oDoc.comment + "</comment>";
            sRows = sRows + "<row type=\"string\" field=\"comment\">Комментарий:</row>";
		    sData = sData + "<state_id>" + oElem.status_id + "</state_id>";
		    try
		    {
		        sData = sData + "<state_name>" + Validate(oElem.status_id.ForeignElem.name) + "</state_name>";
            }
            catch(e)
            {
		        sData = sData + "<state_name>" + sObjectDeleted + "</state_name>";
            }
	        sData = sData + "</element>";
            break;

        case "lector":
        	oDoc = OpenDoc( UrlFromDocID( iEId ) ).TopElem;
            aFullList = XQuery( "for $elem in lectors where $elem/id = " + iEId + " return $elem" );
            oElem = ArrayFirstElem(aFullList);

            sCard = sCard + "<pagename>" + Validate(oElem.person_fullname) + "</pagename>";

            sRows = sRows + "<row type=\"string\" field=\"name\">ФИО:</row>";
            sRows = sRows + "<row type=\"string\" field=\"type_name\">Тип:</row>";
            if(oDoc.allow_publication)
            {
                sRows = sRows + "<row type=\"string\" field=\"email\">E-mail:</row>";
                if (oDoc.desc.HasValue) sRows = sRows + "<row type=\"html\" field=\"desc\">Описание:</row>";
            }

            sData = sData + "<element>";
            sData = sData + "<eid>" + sEId + "</eid>";

	        sData = sData + "<name>" + oElem.person_fullname + "</name>";
	        sData = sData + "<type_name>" + curLngCommon.lector_types.GetChildByKey( oDoc.type ).name + "</type_name>";
	        sData = sData + "<open>" + oDoc.allow_publication + "</open>";
	        if ( oDoc.allow_publication )
	        {
	            try {
	                oInfo = oDoc.person_id.ForeignElem;
	                sData = sData + "<email>" + oInfo.email + "</email>";
	                } catch(e) {}
	            if ( oDoc.desc.HasValue )
	            {
	                sData = sData + "<desc><![CDATA[" + tools_web.get_web_desc( oDoc.desc, UrlFromDocID( iEId ), oDoc.Name + '.desc') + "]]></desc>";

	            }
	        }
	        sData = sData + "</element>";
            break;
        case "program":
            sType = "education_method";
            aFullList = XQuery( "for $elem in education_methods where $elem/id = " + iEId + " return $elem" );
            if(ArrayOptFirstElem(aFullList) != undefined)
            {
                aEventList = XQuery( "for $elem in events where $elem/education_method_id = " + iEId + " return $elem" );
                sType = "education_method";
            }
            else
            {
                aFullList = XQuery( "for $elem in compound_programs where $elem/id = " + iEId + " return $elem" );
                if(ArrayOptFirstElem(aFullList) != undefined)
                {
                    aEventList = XQuery( "for $elem in events where $elem/compound_program_id = " + iEId + " return $elem" );
                    sType = "compound_program";
                }
                else
                {
                    aFullList = XQuery( "for $elem in education_programs where $elem/id = " + iEId + " return $elem" );
                    if(ArrayOptFirstElem(aFullList) != undefined)
                    {
                        aEventList = XQuery( "for $elem in events where $elem/education_program_id = " + iEId + " return $elem" );
                        sType = "education_program";
                    }
                    else
                    {
                        break;
                    }
                }
            }

            oElem = ArrayFirstElem(aFullList);
            oDoc = OpenDoc( UrlFromDocID( iEId ) ).TopElem;

            aRequestTypes = XQuery (" for $elem in request_types where $elem/object_type = '" + sType + "' return $elem ");
        	try
        	{
        	    oReqType = ArrayFirstElem(aRequestTypes);
        	} catch(e) {
        	    oReqType = null;
        	}
        	if(oReqType!=null)
        	{
        	    sObjType = oReqType.object_type;
        	    sReqId = oReqType.id;
            }


            switch(sType)
            {
                case "education_method":
                    sCard = sCard + "<pagename>" + Validate(oElem.code) + " " + Validate(oElem.name) + "</pagename>";

                    sRows = sRows + "<row type=\"string\" field=\"code\">Код:</row>";
                    sRows = sRows + "<row type=\"string\" field=\"name\">Наименование:</row>";
                    sRows = sRows + "<row type=\"string\" field=\"type_name\">Тип программы:</row>";
                    if(oElem.type=="org") sRows = sRows + "<row type=\"string\" field=\"org_name\">Обучающая организация:</row>";

                    sRows = sRows + "<row type=\"string\" field=\"duration\">Продолжительность (часов):</row>";
                    sRows = sRows + "<row type=\"string\" field=\"participants\">Число участников:</row>";
                    sRows = sRows + "<row type=\"string\" field=\"price\">Стоимость:</row>";
                    sRows = sRows + "<row type=\"array\" field=\"lectors/item/name\">Преподаватели:</row>";
                    if(ArrayOptFirstElem(aEventList) != undefined) sRows = sRows + "<row type=\"array\" field=\"events/item/name\">Мероприятия, входящие в программу:</row>";
                    if(oDoc.comment!=null) sRows = sRows + "<row type=\"string\" field=\"comment\">Комментарий:</row>";
                    sRows = sRows + "<row type=\"string\" field=\"state_name\">Мое участие:</row>";
                    if(oDoc.desc!=null) sRows = sRows + "<row type=\"html\" field=\"desc\">Описание:</row>";

                    sData = sData + "<element>";
                    sData = sData + "<eid>" + oElem.id + "</eid>";
                    sData = sData + "<code>" + Validate(oElem.code) + "</code>";
                    sData = sData + "<name>" + Validate(oElem.name) + "</name>";

		            sData = sData + "<type_id>" + oElem.type + "</type_id>";
		            sData = sData + "<type_name>" + Validate(curLngCommon.education_method_types.GetChildByKey( oElem.type ).name) + "</type_name>";

		            if(oElem.type=="org")
		            {
		                sData = sData + "<org_id>" + oDoc.education_org_id + "</org_id>";
		                try
		                {
		                    sData = sData + "<org_name>" + Validate(oDoc.education_org_id.ForeignElem.name) + "</org_name>";
		                }
		                catch(e)
		                {
		                    sData = sData + "<org_name>" + sObjectDeleted + "</org_name>";
		                }
                    }

		            sData = sData + "<duration>" + oElem.duration + "</duration>";
		            sData = sData + "<participants>" + oElem.person_num + "</participants>";
		            sPrice = oElem.cost;
		            sData = sData + "<cost>" + oElem.cost + "</cost>";
		            sData = sData + "<cost_currency>";
    		        try
		            {
			            sPrice = sPrice + " " + Validate( oDoc.currency.ForeignElem.name );
			            sData = sData + Validate( oDoc.currency.ForeignElem.name );
		            }
		            catch ( e )
		            {
		            }
		            sData = sData + "</cost_currency>";
		            sData = sData + "<cost_type>";
		            try
		            {
			            sData = sData + Validate( oDoc.cost_type.ForeignElem.name );
			            sPrice = sPrice + " " + Validate( oDoc.cost_type.ForeignElem.name );
		            }
		            catch ( e )
		            {
		            }
		            sData = sData + "</cost_type>";
                    sData = sData + "<price>" + sPrice + "</price>";
                    sData = sData + "<open_program>" + oElem.is_open + "</open_program>";

                    sData = sData + "<lectors>";
			        for ( _lector in oDoc.lectors )
			        {
				        try
				        {
					        _cur_lector = _lector.lector_id.ForeignElem;
					        sData = sData + "<item>";
					        sData = sData + "<id>" + _lector.PrimaryKey + "</id>";
					        sData = sData + "<type>" + Validate(curLngCommon.lector_types.GetChildByKey( _cur_lector.type ).name) + "</type>";
					        sData = sData + "<name>" + _cur_lector.person_fullname + "</name>";
					        sData = sData + "</item>";
				        }
				        catch ( e )
				        {

				        }
			        }
                    sData = sData + "</lectors>";

                    if(ArrayOptFirstElem(aEventList) != undefined)
                    {
                        sData = sData + "<events>";
			            for ( oEvent in aEventList )
			            {
				            try
				            {
					            sData = sData + "<item>";
					            sData = sData + "<id>" + oEvent.id + "</id>";
					            sData = sData + "<name>" + oEvent.name + "</name>";
					            sData = sData + "</item>";
				            }
				            catch ( e )
				            {

				            }
			            }
                        sData = sData + "</events>";
			        }

		            if(oDoc.comment!=null) sData = sData + "<comment>" + oDoc.comment + "</comment>";

		            if(oDoc.desc!=null) sData = sData + "<desc><![CDATA[" + oDoc.desc + "]]></desc>";

		            aRequests = XQuery (" for $elem in requests where $elem/object_id = " + oElem.id + " and $elem/person_id = " + curUserID.XQueryLiteral + " and $elem/status_id = 'active' return $elem ");
                    sState = "0";
                    if(ArrayOptFirstElem(aRequests) != undefined)
                    {
                        sState = "2";
                    }
                    sData = sData + "<state_id>" + sState + "</state_id>";
                    if(oElem.is_open && sState=="0" && sReqId!="")
                    {
                        sActions = sActions + "<item id=\"request\">";
                        sActions = sActions + "<name>Создать запрос</name>";
                        sActions = sActions + "<url>layout=form&amp;object_type=request&amp;state=active&amp;filter=all&amp;person=me&amp;menu=my_active_requests&amp;eid=" + oElem.id + "&amp;req_id=" + sReqId + "</url>";
                        sRows = sRows + "<row type=\"action\" control=\"button\">request</row>";
                        sActions = sActions + "</item>";
                    }

                    switch(sState)
                    {
                        case "0":
                            sState = "Не участвую";
                            break;
                        case "1":
                            sState = "В числе участвующих";
                            break;
                        case "2":
                            sState = "Подан запрос на участие";
                            break;
                    }
                    sData = sData + "<state_name>" + sState + "</state_name>";


                    sData = sData + "</element>";
                    break;
                case "education_program":
                case "compound_program":
                    sCard = sCard + "<pagename>" + Validate(oElem.code) + " " + Validate(oElem.name) + "</pagename>";

                    sRows = sRows + "<row type=\"string\" field=\"code\">Код:</row>";
                    sRows = sRows + "<row type=\"string\" field=\"name\">Наименование:</row>";
                    sRows = sRows + "<row type=\"string\" field=\"type_name\">Тип программы:</row>";
                    sRows = sRows + "<row type=\"array\" field=\"programs/item/name\">Включает учебные программы:</row>";


                    sData = sData + "<element>";
                    sData = sData + "<eid>" + oElem.id + "</eid>";
                    sData = sData + "<code>" + Validate(oElem.code) + "</code>";
                    sData = sData + "<name>" + Validate(oElem.name) + "</name>";


                    if(sType=="compound_program")
                    {
		                sData = sData + "<type_name>Модульная программа</type_name>";
                        sData = sData + "<programs>";
			            for ( oProgram in oElem.programs )
			            {
				            try
				            {
					            sData = sData + "<item>";
					            sData = sData + "<id>" + oProgram.id + "</id>";
					            sData = sData + "<name>" + oProgram.name + "</name>";
					            sData = sData + "</item>";
				            }
				            catch ( e )
				            {

				            }
			            }
			        }
			        else
			        {
		                sData = sData + "<type_name>Набор программ</type_name>";
                        sData = sData + "<programs>";
			            for ( oProgram in oDoc.education_methods )
			            {
				            try
				            {
					            sData = sData + "<item>";
					            sData = sData + "<id>" + oProgram.education_method_id + "</id>";
					            sData = sData + "<name>" + oProgram.education_method_id.ForeignElem.name + "</name>";
					            sData = sData + "</item>";
				            }
				            catch ( e )
				            {

				            }
			            }
			        }
                    sData = sData + "</programs>";
                    sData = sData + "</element>";
                    break;
            }

/*        	if(sReqId!="")
        	{
                sActions = sActions + "<item id=\"request\">";
                sActions = sActions + "<name>Создать запрос</name>";
                sActions = sActions + "<url>layout=form&amp;object_type=request&amp;state=active&amp;filter=all&amp;person=me&amp;menu=my_active_requests&amp;eid=" + oElem.id + "&amp;req_id=" + sReqId + "</url>";
                sRows = sRows + "<row type=\"action\" control=\"button\">request</row>";
                sActions = sActions + "</item>";
        	}*/

//       	sCard = sCard + oElem.Xml;
//          sCard = sCard + tools_web.get_web_desc( oElem.desc, UrlFromDocID( iEId ), 'course.desc' );
            break;

        case "event":
            aFullList = XQuery( "for $elem in events where $elem/id = " + iEId + " return $elem" );
            oElem = ArrayFirstElem(aFullList);
            aActiveList = XQuery( "for $event in event_collaborators where $event/collaborator_id = " + curUserID.XQueryLiteral + " and $event/is_public = false() and $event/status_id != 'close' return $event" );
            aPublicList = XQuery( "for $event in events where $event/is_public = true() and $event/status_id != 'close' return $event" );
            aArchiveList = XQuery( "for $event in event_collaborators where $event/collaborator_id = " + curUserID.XQueryLiteral + " and $event/is_public = false() and $event/status_id = 'close' return $event" );
	        aRequests = XQuery (" for $elem in requests where $elem/object_id = " + oElem.id + " and $elem/person_id = " + curUserID.XQueryLiteral + " and $elem/status_id = 'active' return $elem ");
        	oEvent = OpenDoc( UrlFromDocID( iEId ) ).TopElem;

            sReqId = oEvent.default_request_type_id;
            if(sReqId==null || sReqId=="")
            {
		        try
				{
					aRequestTypes = XQuery (" for $elem in request_types where $elem/object_type = 'event' return $elem ");
					oRType = ArrayFirstElem(aRequestTypes);
					sReqId = oRType.id;
				}
				catch(e)
				{
					sReqId = "";
				}
            }

            sCard = sCard + "<pagename>" + Validate(oElem.code) + " " + Validate(oElem.name) + "</pagename>";

            bTutor = oEvent.tutors.ChildByKeyExists( curUserID );
            bPreparator = false;
            try
            {
                aPreparators = oEvent.even_preparations; // even - as in WT!
            }
            catch(e)
            {
                try
                {
                    aPreparators = oEvent.event_preparations;
                }
                catch(x)
                {
                    aPreparators = new Array();
                }
            }
            if(ArrayOptFirstElem(aPreparators) != undefined)
            {
                for(oPreparator in aPreparators)
                {
                    if(Validate(oPreparator.person_id) == curUserID)
                    {
                        bPreparator = true;
                        break;
                    }
                }
            }

            aTutors = oEvent.tutors;
            aCollaborators = oEvent.collaborators;



            bWrite = curUser.access.access_role == "admin" || bTutor || bPreparator;
            bIsCol =  oEvent.collaborators.ChildByKeyExists( curUserID );
            bView = ( bIsCol || bWrite || bPreparator);

            sState = "0";
            if (ArrayOptFirstElem(aRequests) != undefined) sState = "2";
            if (bIsCol || bTutor || bPreparator) sState = "1";

            bCompoundProgram = oElem.compound_program_id!=null;
            bEducationProgram = oElem.education_program_id!=null;
            bEducationMethod = oElem.education_method_id!=null;
            bEducationOrg = oElem.education_org_id!=null;


            sFields = sFields + "<field type=\"id\">eid</field>";
            sFields = sFields + "<field type=\"string\">code</field>";
            sFields = sFields + "<field type=\"string\">name</field>";
            sFields = sFields + "<field type=\"string\">type</field>";
            sFields = sFields + "<field type=\"number\">type_id</field>";

            sFields = sFields + "<field type=\"string\">state_name</field>";
            if(oEvent.desc != "") sFields = sFields + "<field type=\"string\">description</field>";

            sRows = sRows + "<row type=\"string\" field=\"code\">Код:</row>";
            sRows = sRows + "<row type=\"string\" field=\"name\">Наименование:</row>";
            sRows = sRows + "<row type=\"string\" field=\"type_name\">Тип мероприятия:</row>";
            sRows = sRows + "<row type=\"string\" field=\"start_date\">Время начала:</row>";
            sRows = sRows + "<row type=\"string\" field=\"finish_date\">Время окончания:</row>";
            sRows = sRows + "<row type=\"string\" field=\"status_name\">Состояние:</row>";
            sRows = sRows + "<row type=\"string\" field=\"is_open\">Открытое мероприятие:</row>";
            sRows = sRows + "<row type=\"string\" field=\"is_public\">Публичное мероприятие:</row>";
            if(bCompoundProgram) sRows = sRows + "<row type=\"string\" field=\"compound_program_name\">Входит в модульную программу:</row>";
            if(bEducationProgram) sRows = sRows + "<row type=\"string\" field=\"education_program_name\">Входит в учебную программу:</row>";
            if(bEducationMethod) sRows = sRows + "<row type=\"string\" field=\"education_method_name\">Входит в учебную программу:</row>";
            if(bEducationOrg) sRows = sRows + "<row type=\"string\" field=\"education_org_name\">Образовательная организация:</row>";
            if(ArrayOptFirstElem(aPreparators) != undefined) sRows = sRows + "<row type=\"array\" field=\"preparators/item/name\">Ответственные за проведение:</row>";
            if(ArrayOptFirstElem(aTutors) != undefined)  sRows = sRows + "<row type=\"array\" field=\"tutors/item/name\">Преподаватели:</row>";
            if(ArrayOptFirstElem(aCollaborators) != undefined) sRows = sRows + "<row type=\"array\" field=\"collaborators/item/name\">Участники:</row>";
            sRows = sRows + "<row type=\"string\" field=\"state_name\">Мое участие:</row>";


            sData = sData + "<element>";
            sData = sData + "<eid>" + oElem.id + "</eid>";
            sData = sData + "<code>" + Validate(oElem.code) + "</code>";
            sData = sData + "<name>" + Validate(oElem.name) + "</name>";
            sData = sData + "<type_id>" + Validate(oElem.type_id) + "</type_id>";
            try
            {
                sData = sData + "<type_name>" + Validate(oElem.type_id.ForeignElem.name) + "</type_name>";
            }
            catch(e)
            {
                sData = sData + "<type_name>" + sObjectDeleted + "</type_name>";
            }
            sData = sData + "<start_date>" + StrDate(oElem.start_date) + "</start_date>";
            sData = sData + "<finish_date>" + StrDate(oElem.finish_date) + "</finish_date>";
		    sData = sData + "<status_id>" + oElem.status_id + "</status_id>";
		    sData = sData + "<status_name>" + Validate(curLngCommon.event_status_types.GetChildByKey( oElem.status_id ).name) + "</status_name>";
		    if(oElem.is_open)
		    {
		        sData = sData + "<is_open>да (возможна подача запроса на участие)</is_open>";
		    }
		    else
		    {
		        sData = sData + "<is_open>нет (участники определяются только администратором)</is_open>";
		    }
		    if(oElem.is_public)
		    {
		        sData = sData + "<is_public>да (показывается всем сотрудникам)</is_public>";
		    }
		    else
		    {
		        sData = sData + "<is_public>нет (показывается только допущенным сотрудникам)</is_public>";
		    }

            if(bCompoundProgram)
            {
                sData = sData + "<compound_program_id>" + oElem.compound_program_id + "</compound_program_id>";
                try
                {
                    sData = sData + "<compound_program_name>" + Validate(oElem.compound_program_id.ForeignElem.name) + "</compound_program_name>";
                }
                catch(e)
                {
                    sData = sData + "<compound_program_name>" + sObjectDeleted + "</compound_program_name>";
                }
            }
            if(bEducationProgram)
            {
                sData = sData + "<education_program_id>" + oElem.education_program_id + "</education_program_id>";
                try
                {
                    sData = sData + "<education_program_name>" + Validate(oElem.education_program_id.ForeignElem.name) + "</education_program_name>";
                }
                catch(e)
                {
                    sData = sData + "<education_program_name>" + sObjectDeleted + "</education_program_name>";
                }
            }
            if(bEducationMethod)
            {
                sData = sData + "<education_method_id>" + oElem.education_method_id + "</education_method_id>";
                try
                {
                    sData = sData + "<education_method_name>" + Validate(oElem.education_method_id.ForeignElem.name) + "</education_method_name>";
                }
                catch(e)
                {
                    sData = sData + "<education_method_name>" + sObjectDeleted + "</education_method_name>";
                }
            }
            if(bEducationOrg)
            {
                sData = sData + "<education_org_id>" + oElem.education_org_id + "</education_org_id>";
                try
                {
                    sData = sData + "<education_org_name>" + Validate(oElem.education_org_id.ForeignElem.name) + "</education_org_name>";
                }
                catch(e)
                {
                    sData = sData + "<education_org_name>" + sObjectDeleted + "</education_org_name>";
                }
            }

            if(ArrayOptFirstElem(aPreparators) != undefined)
            {
                sData = sData + "<preparators isarray=\"1\">";
                for (oPreparator in aPreparators)
                {
                    sData = sData + "<item>";
                    sData = sData + "<id>" + oPreparator.person_id + "</id>";
                    sData = sData + "<name>" + oPreparator.person_fullname + "</name>";
                    sData = sData + "</item>";
                }
                sData = sData + "</preparators>";
            }

            if(ArrayOptFirstElem(aTutors) != undefined)
            {
                sData = sData + "<tutors isarray=\"1\">";
                for (oTutor in aTutors)
                {
                    sData = sData + "<item>";
                    sData = sData + "<id>" + oTutor.collaborator_id + "</id>";
                    sData = sData + "<name>" + oTutor.person_fullname + "</name>";
                    sData = sData + "</item>";
                }
                sData = sData + "</tutors>";
            }

            if(ArrayOptFirstElem(aCollaborators) != undefined)
            {
                sData = sData + "<collaborators isarray=\"1\">";
                for (oCollaborator in aCollaborators)
                {
                    sData = sData + "<item>";
                    sData = sData + "<id>" + oCollaborator.collaborator_id + "</id>";
                    sData = sData + "<name>" + oCollaborator.person_fullname + "</name>";
                    sData = sData + "</item>";
                }
                sData = sData + "</collaborators>";
            }

            sData = sData + "<state_id>" + sState + "</state_id>";

            if(oElem.is_open && sState=="0")
            {
				if(sReqId != null && sReqId != '')
				{
					sActions = sActions + "<item id=\"request\">";
					sActions = sActions + "<name>Создать запрос</name>";
					sActions = sActions + "<url>layout=form&amp;object_type=request&amp;state=active&amp;filter=all&amp;person=me&amp;menu=my_active_requests&amp;action=request&amp;eid=" + oElem.id + "&amp;req_id=" + sReqId + "</url>";
					sRows = sRows + "<row type=\"action\" control=\"button\">request</row>";
				}
				else
				{
					sActions = sActions + "<item id=\"request\">";
					sActions = sActions + "<info>[DIAGNOSTIC]: Не определена форма запроса для данного типа объекта. Невозможно создать запрос. Пожалуйста, свяжитесь с администратором системы обучения.</info>";
					sRows = sRows + "<row type=\"info\" control=\"info\">request</row>";
				}
				sActions = sActions + "</item>";
            }

            switch(sState)
            {
                case "0":
                    sState = "Не участвую";
                    break;
                case "1":
                    sState = "В числе участвующих";
                    break;
                case "2":
                    sState = "Подан запрос на участие";
                    break;
            }
            sData = sData + "<state_name>" + sState + "</state_name>";

	        sState = "0";
	        sStateName = ""

	        if(ArrayOptFirstElem(aActiveList) != undefined)
	        {
	            sState = "1";
	            sStateName = "Активирован";
	        }
	        if(ArrayOptFirstElem(aRequests) != undefined && sState != "1")
	        {
	            sState = "2";
	            sStateName = "Запрос принят";
	        }
	        if(ArrayOptFirstElem(aArchiveList) != undefined && sState == "0")
	        {
	            sState = "3";
	            sStateName = "В архиве";
            }
            sData = sData + "<state_id>" + sState + "</state_id>";
            sData = sData + "<state_name>" + sStateName + "</state_name>";
            sData = sData + "</element>";


//       	sCard = sCard + oElem.Xml;
//          sCard = sCard + tools_web.get_web_desc( oElem.desc, UrlFromDocID( iEId ), 'course.desc' );
            break;

        case "course":
            aFullList = XQuery( "for $elem in courses where $elem/id = " + iEId + " return $elem" );
            oElem = ArrayFirstElem(aFullList);
            aActiveList = XQuery( "for $elem in active_learnings where $elem/person_id = " + curUserID.XQueryLiteral + " and $elem/course_id = " + iEId + " return $elem" );
            aArchiveList = XQuery( "for $elem in learnings where $elem/person_id = " + curUserID.XQueryLiteral + " and $elem/course_id = " + iEId + " return $elem" );
	        aRequests = XQuery (" for $elem in requests where $elem/object_id = " + oElem.id + " and $elem/person_id = " + curUserID.XQueryLiteral + " and $elem/status_id = 'active' return $elem ");
        	oDoc = OpenDoc( UrlFromDocID( iEId ) ).TopElem;

		    aRequestTypes = XQuery (" for $elem in request_types where $elem/object_type = 'course' return $elem ");
            oRType = ArrayFirstElem(aRequestTypes);
            sReqId = oRType.id;

            sCard = sCard + "<pagename>" + Validate(oElem.code) + " " + Validate(oElem.name) + "</pagename>";

            sFields = sFields + "<field type=\"id\">eid</field>";
            sFields = sFields + "<field type=\"string\">course_code</field>";
            sFields = sFields + "<field type=\"string\">course_name</field>";
            sFields = sFields + "<field type=\"string\">self_enroll</field>";
            sFields = sFields + "<field type=\"number\">state_id</field>";
            sFields = sFields + "<field type=\"string\">state_name</field>";
            if(oDoc.desc != "") sFields = sFields + "<field type=\"string\">description</field>";

            sRows = sRows + "<row type=\"string\" field=\"course_code\">Код:</row>";
            sRows = sRows + "<row type=\"string\" field=\"course_name\">Наименование:</row>";
        	if(oDoc.desc != "") sRows = sRows + "<row type=\"string\" field=\"description\">Подробное описание:</row>";
            sRows = sRows + "<row type=\"string\" field=\"state_name\">Статус:</row>";
            sRows = sRows + "<row type=\"string\" field=\"self_enroll_name\">Самостоятельная активация:</row>";

            sData = sData + "<element>";
            sData = sData + "<eid>" + oElem.id + "</eid>";
            sData = sData + "<course_code>" + Validate(oElem.code) + "</course_code>";
            sData = sData + "<course_name>" + Validate(oElem.name) + "</course_name>";
            sData = sData + "<self_enroll>" + Validate(oElem.yourself_start) + "</self_enroll>";
            if(oElem.yourself_start)
            {
                sData = sData + "<self_enroll_name>Разрешена</self_enroll_name>";
            }
            else
            {
                sData = sData + "<self_enroll_name>Запрещена</self_enroll_name>";
            }
            if(oDoc.desc != "")
            {
                sData = sData + "<description>Открыть</description>";
            }

	        sState = "0";
	        sStateName = ""

	        if(ArrayOptFirstElem(aActiveList) != undefined)
	        {
	            sState = "1";
	            sStateName = "Активирован";
	        }
	        if(ArrayOptFirstElem(aRequests) != undefined && sState != "1")
	        {
	            sState = "2";
	            sStateName = "Запрос принят";
	        }
	        if(ArrayOptFirstElem(aArchiveList) != undefined && sState == "0")
	        {
	            sState = "3";
	            sStateName = "В архиве";
            }
            sData = sData + "<state_id>" + sState + "</state_id>";
            sData = sData + "<state_name>" + sStateName + "</state_name>";
            sData = sData + "</element>";

            if(sState=="0" || sState=="3")
            {
                if(oElem.yourself_start)
                {
                    sActions = sActions + "<item id=\"activate\">";
                    sActions = sActions + "<name>Активировать</name>";
                    sActions = sActions + "<url>layout=list&amp;object_type=course&amp;state=active&amp;filter=all&amp;person=me&amp;menu=my_active_courses&amp;action=activate&amp;eid=" + oElem.id + "</url>";
                    sRows = sRows + "<row type=\"action\" control=\"button\">activate</row>";
                }
                else
                {
                    sActions = sActions + "<item id=\"request\">";
                    sActions = sActions + "<name>Создать запрос</name>";
                    sActions = sActions + "<url>layout=form&amp;object_type=request&amp;state=active&amp;filter=none&amp;person=me&amp;menu=my_active_requests&amp;eid=" + oElem.id + "&amp;req_id=" + sReqId + "</url>";
                    sRows = sRows + "<row type=\"action\" control=\"button\">request</row>";
                }
                sActions = sActions + "</item>";
            }

//       	sCard = sCard + oElem.Xml;
//          sCard = sCard + tools_web.get_web_desc( oElem.desc, UrlFromDocID( iEId ), 'course.desc' );
            break;

        case "test":

            aElements = XQuery( "for $elem in assessments where $elem/id = " + sEId + " return $elem" );
            oElem = ArrayFirstElem( aElements );
            aActiveList = XQuery( "for $elem in active_test_learnings where $elem/person_id = " + curUserID.XQueryLiteral + " and $elem/assessment_id = " + iEId + " return $elem" );
            aArchiveList = XQuery( "for $elem in test_learnings where $elem/person_id = " + curUserID.XQueryLiteral + " and $elem/assessment_id = " + iEId + " return $elem" );
	        aRequests = XQuery (" for $elem in requests where $elem/object_id = " + oElem.id + " and $elem/person_id = " + curUserID.XQueryLiteral + " and $elem/status_id = 'active' return $elem ");

		    try
			{
				aRequestTypes = XQuery (" for $elem in request_types where $elem/object_type = 'assessment' return $elem ");
				oRType = ArrayFirstElem(aRequestTypes);
				sReqId = oRType.id;
			}
			catch(e)
			{
				sReqId = "";
			}

        	oDoc = OpenDoc( UrlFromDocID( iEId ) ).TopElem;

            sCard = sCard + "<pagename>" + Validate(oElem.code) + " " + Validate(oElem.title) + "</pagename>";

            sFields = sFields + "<field type=\"id\">eid</field>";
            sFields = sFields + "<field type=\"string\">test_code</field>";
            sFields = sFields + "<field type=\"string\">test_name</field>";
            sFields = sFields + "<field type=\"number\">state_id</field>";
            sFields = sFields + "<field type=\"string\">state_name</field>";

            sRows = sRows + "<row type=\"string\" field=\"test_code\">Код:</row>";
            sRows = sRows + "<row type=\"string\" field=\"test_name\">Наименование:</row>";
            sRows = sRows + "<row type=\"string\" field=\"state_name\">Статус:</row>";

            sData = sData + "<element>";
            sData = sData + "<eid>" + oElem.id + "</eid>";
            sData = sData + "<test_code>" + Validate(oElem.code) + "</test_code>";
            sData = sData + "<test_name>" + Validate(oElem.title) + "</test_name>";

	        sState = "0";
	        sStateName = ""

	        if(ArrayOptFirstElem(aActiveList) != undefined)
	        {
	            sState = "1";
	            sStateName = "Активирован";
	        }
	        if(ArrayOptFirstElem(aRequests) != undefined && sState != "1")
	        {
	            sState = "2";
	            sStateName = "Запрос принят";
	        }
	        if(ArrayOptFirstElem(aArchiveList) != undefined && sState == "0")
	        {
	            sState = "3";
	            sStateName = "В архиве";
            }
            sData = sData + "<state_id>" + sState + "</state_id>";
            sData = sData + "<state_name>" + sStateName + "</state_name>";
            sData = sData + "</element>";

            if(sState=="0" || sState=="3")
            {

                if(oDoc.is_open)
                {
                    sActions = sActions + "<item id=\"activate\">";
                    sActions = sActions + "<name>Активировать</name>";
                    sActions = sActions + "<url>layout=list&amp;object_type=test&amp;state=active&amp;filter=all&amp;person=me&amp;menu=my_active_tests&amp;action=activate&amp;eid=" + oElem.id + "</url>";
                    sRows = sRows + "<row type=\"action\" control=\"button\">activate</row>";
                }
                else
                {
					if(sReqId != "")
					{
						sActions = sActions + "<item id=\"request\">";
						sActions = sActions + "<name>Создать запрос</name>";
						sActions = sActions + "<url>layout=form&amp;object_type=request&amp;state=active&amp;filter=none&amp;person=me&amp;menu=my_active_requests&amp;eid=" + oElem.id + "&amp;req_id=" + sReqId + "</url>";
						sRows = sRows + "<row type=\"action\" control=\"button\">request</row>";
					}
					else
					{
						sActions = sActions + "<item id=\"request\">";
						sActions = sActions + "<info>[DIAGNOSTIC]: Не определена форма запроса для данного типа объекта. Невозможно создать запрос. Пожалуйста, свяжитесь с администратором системы обучения.</info>";
						sRows = sRows + "<row type=\"info\" control=\"info\">request</row>";
					}
                }
				sActions = sActions + "</item>";
            }

//       	sCard = sCard + oElem.Xml;
//          sCard = sCard + tools_web.get_web_desc( oElem.desc, UrlFromDocID( iEId ), 'course.desc' );
            break;
    }

    sData = sData + "</data>";
    sRows = sRows + "</rows>";
    sFields = sFields + "</fields>";
    sActions = sActions + "</actions>";
    sError = sError + "</error>";

    return sCard + sRows + sData + sFields + sActions + sError;
}


function Launch()
{
    sCard = "";
    sData = "<data>";
    sFields = "<fields>";
    sCols = "<columns>";
    sActions = "<actions>";
    sError = "<error>";
    sInfo = "<info>";
    sRows = "<rows>";

    switch(sObjectType)
    {
        case "course":
		    oLearningDoc = OpenDoc( UrlFromDocID( iEId ) ).TopElem;
		    oCourseDoc = OpenDoc( UrlFromDocID( oLearningDoc.course_id ) ).TopElem;
		    sCard = sCard + "<pagename>" + oLearningDoc.course_code + " " + oLearningDoc.course_name + "</pagename>";

		    sData = sData + "<element type=\"launch\">";
		    sData = sData + "<course_id>" + oLearningDoc.course_id + "</course_id>";
		    sData = sData + "<course_code>" + oLearningDoc.course_code + "</course_code>";
		    sData = sData + "<course_name>" + oLearningDoc.course_name + "</course_name>";
		    try
			{
				sData = sData + "<last_usage_part_code>" + oLearningDoc.last_usage_part_code + "</last_usage_part_code>" ;
			}
			catch(e)
			{}
		    sData = sData + "<last_usage_date>" + oLearningDoc.last_usage_date + "</last_usage_date>";
		    try
			{
				sData = sData + "<is_self_enrolled>" + oLearningDoc.is_self_enrolled + "</is_self_enrolled>";
				sData = sData + "<max_end_date>" + oLearningDoc.max_end_date + "</max_end_date>";
			}
			catch(e)
			{}
		    sData = sData + "<state_id>" + oLearningDoc.state_id + "</state_id>";
		    try
		    {
		        sData = sData + "<state_name>" + oLearningDoc.state_id.ForeignElem.name + "</state_name>";
		    }
		    catch(e)
		    {
		        sData = sData + "<state_name>" + sObjectDeleted + "</state_name>";
		    }
		    sData = sData + "<score>" + oLearningDoc.score + "</score>";

            sInfo = sInfo + "<data><element>";
		    sInfo = sInfo + "<course_id>" + oLearningDoc.course_id + "</course_id>";
		    sInfo = sInfo + "<course_code>" + oLearningDoc.course_code + "</course_code>";
            sRows = sRows + "<row type=\"string\" field=\"course_code\">Код:</row>";
		    sInfo = sInfo + "<course_name>" + oLearningDoc.course_name + "</course_name>";
            sRows = sRows + "<row type=\"string\" field=\"course_name\">Наименование:</row>";
		    try
			{
				sInfo = sInfo + "<last_usage_part_code>" + oLearningDoc.last_usage_part_code + "</last_usage_part_code>" ;
			}
			catch(e)
			{}
		    sInfo = sInfo + "<last_usage_date>" + oLearningDoc.last_usage_date + "</last_usage_date>";
            sRows = sRows + "<row type=\"string\" field=\"last_usage_date\">Последний вход:</row>";
		    try
			{
				sInfo = sInfo + "<is_self_enrolled>" + oLearningDoc.is_self_enrolled + "</is_self_enrolled>";
				sInfo = sInfo + "<max_end_date>" + oLearningDoc.max_end_date + "</max_end_date>";
			}
			catch(e)
			{}
            sRows = sRows + "<row type=\"string\" field=\"max_end_date\">Закончить до:</row>";
		    sInfo = sInfo + "<state_id>" + oLearningDoc.state_id + "</state_id>";
		    try
		    {
		        sInfo = sInfo + "<state_name>" + oLearningDoc.state_id.ForeignElem.name + "</state_name>";
            }
            catch(e)
            {
		        sInfo = sInfo + "<state_name>" + sObjectDeleted + "</state_name>";
            }
            sRows = sRows + "<row type=\"string\" field=\"state_name\">Состояние курса:</row>";
		    sInfo = sInfo + "<score>" + oLearningDoc.score + "</score>";
            sRows = sRows + "<row type=\"string\" field=\"score\">Суммарный балл:</row>";

		    bCanComplete = oCourseDoc.finish_without_mastery_score;
		    if(bCanComplete)
		    {
		        sInfo = sInfo + "<complete_allowed>1</complete_allowed>";
		        sInfo = sInfo + "<complete_action>Возможно до завершения всех модулей</complete_action>";
                sRows = sRows + "<row type=\"string\" field=\"complete_action\">Завершение:</row>";
		        sInfo = sInfo + "</element></data>";
		        sInfo = sInfo + "<actions>"
                sInfo = sInfo + "<item id=\"complete\" type=\"javascript\">";
                sInfo = sInfo + "<name>Завершить курс</name>";
                sInfo = sInfo + "<url>DoSubmit('layout=multilist&amp;object_type=all&amp;state=archive&amp;filter=all&amp;person=me&amp;menu=my_archive_all&amp;eid=" + sEId + "','course_finish', '"+ oLearningDoc.course_id + "', '" + sEId + "', '" + oLearningDoc.course_id + "');</url>";
                sRows = sRows + "<row type=\"action\" control=\"button\">complete</row>";
                sInfo = sInfo + "</item></actions>";
		    }
		    else
		    {
		        sInfo = sInfo + "<complete_allowed>0</complete_allowed>";
		        sInfo = sInfo + "<complete_action>Только по завершению всех модулей</complete_action>";
                sRows = sRows + "<row type=\"string\" field=\"complete_action\">Завершение:</row>";
		        sInfo = sInfo + "</element></data>";
		        if(oLearningDoc.state_id==2)
		        {
		            sInfo = sInfo + "<actions>"
                    sInfo = sInfo + "<item id=\"complete\" type=\"javascript\">";
                    sInfo = sInfo + "<name>Завершить курс</name>";
                    sInfo = sInfo + "<url>DoSubmit('layout=multilist&amp;object_type=all&amp;state=archive&amp;filter=all&amp;person=me&amp;menu=my_archive_all&amp;eid=" + sEId + "','course_finish', '"+ oLearningDoc.course_id + "', '" + sEId + "', '" + oLearningDoc.course_id + "');</url>";
                    sRows = sRows + "<row type=\"action\" control=\"button\">complete</row>";
                    sInfo = sInfo + "</item></actions>";
                }
		    }

		    sData = sData + "<parts>";

            iIndent = 0;
            sPCode = "";
            aParents = new Array();
            sCurParent = "";
			for ( _part in oLearningDoc.parts )
			{

			    sData = sData + "<item><code>" + _part.code + "</code>";
				sData = sData + "<name>" + _part.name + "</name>";
				sData = sData + "<type>" + _part.type + "</type>";

				sPCode = Validate(_part.parent_part_code);

				if(sPCode=="")
				{
				    iIndent = 0;
				}
				else
				{
				    sNCode = sPCode;
				    iIndent = 0;
				    do
				    {
				       iIndent = iIndent + 1;
				       try
				       {
				        oNode = ArrayFind(oLearningDoc.parts, "code==sNCode");
				       }
				       catch(e)
				       {
				        break;
				       }
				       if(oNode.parent_part_code == null) break;
				       sNCode = oNode.parent_part_code;
				       if(sNCode == "") break;
				    }
				    while(sNCode!="");
				}

				sData = sData + "<indent>" + String(iIndent) + "</indent>";
				sData = sData + "<parent_part_code>" + sPCode + "</parent_part_code>";

				if(_part.type=="folder")
				{
				    sData = sData + "<start_usage_date>-</start_usage_date>";
				    sData = sData + "<last_usage_date>-</last_usage_date>";
				    sData = sData + "<score>-</score>";
				    sData = sData + "<url></url>";

				    sData = sData + "<width>0</width>";
				    sData = sData + "<height>0</height>";
				    sData = sData + "<scrolling>0</scrolling>";

				    sData = sData + "<state_id>0</state_id>";
				    sData = sData + "<action>-</action>";
				    sData = sData + "<state_name>-</state_name></item>";
				}
				else
				{
				    try
					{
						sData = sData + "<is_mandatory>" + _part.is_mandatory + "</is_mandatory>";
					}
					catch(e)
					{}
				    sData = sData + "<start_usage_date>" + _part.start_usage_date + "</start_usage_date>";
				    sData = sData + "<last_usage_date>" + _part.last_usage_date + "</last_usage_date>";
				    sData = sData + "<score>" + _part.score + "</score>";

				    sData = sData + "<action>";


					bCompletedPreviousFlag = true;

					try
					{
						oCoursePart = oCourseDoc.parts.GetOptChildByKey( _part.PrimaryKey );
						if(oCoursePart != undefined && oCoursePart.completed_parent_parts.ChildNum != 0)
						{

							iCounter = 0;
							for( oPrevCoursePart in oCoursePart.completed_parent_parts )
							{
								oCurrentPrevLearningPart = oLearningDoc.parts.GetOptChildByKey( oPrevCoursePart.part_code );
								if(oCurrentPrevLearningPart.state_id != 2 && oCurrentPrevLearningPart.state_id != 4)
								{
									if(iCounter==0)
									{
										sData = sData + tools.get_web_str("vlpb_text1");
										sData = sData + "&amp;nbsp;" + tools_web.get_cur_lng_name( oCurrentPrevLearningPart.name );
									}
									else
									{
										sData = sData + ";&amp;nbsp;" + tools_web.get_cur_lng_name( oCurrentPrevLearningPart.name );
									}
									iCounter++;
									bCompletedPreviousFlag = false;
								}
							}
						}
					}
					catch(e)
					{
						alert(e);
					}

					if(bCompletedPreviousFlag)
					{
						switch(_part.state_id)
						{
							case 0:
								sData = sData + "Начать";
								break;
							case 1:
								sData = sData + "Продолжить";
								break;
							case 2:
								sData = sData + "Просмотреть";
								break;
						}
					}
				    sData = sData + "</action>";

					if(bCompletedPreviousFlag)
					{
						sData = sData + "<url>" + "course_launch.html?course_id=" + oLearningDoc.course_id + "\&amp;object_id=" + sEId + "\&amp;sid=" + tools.get_sum_sid( oLearningDoc.course_id ) + "\&amp;part_code=" + _part.code + "</url>";
					}
					else
					{
						sData = sData + "<url/>";
					}

				    try
				    {
					    _course_part = oCourseDoc.parts.GetChildByKey( _part.code );

					    sData = sData + "<max_score>" + _course_part.max_score + "</max_score>";
					    sData = sData + "<mastery_score>" + _course_part.mastery_score + "</mastery_score>";
					    sData = sData + "<desc>" + _course_part.desc + "</desc>";
				    }
				    catch ( e )
				    {
				    }

				    sData = sData + "<width>" + oCourseDoc.Width( _part.code ) + "</width>";
				    sData = sData + "<height>" + oCourseDoc.Height( _part.code ) + "</height>";
				    sData = sData + "<scrolling>" + ( oCourseDoc.DispScrolling( _part.code ) ? '1' : '0' ) + "</scrolling>";

				    sData = sData + "<state_id>" + _part.state_id + "</state_id>";
				    try
				    {
				        sData = sData + "<state_name>" + _part.state_id.ForeignElem.name + "</state_name></item>";
				    }
				    catch(e)
				    {
				        sData = sData + "<state_name>" + sObjectDeleted + "</state_name></item>";
				    }
				}
			}

			sData = sData + "</parts></element>";

            sCols = sCols + "<column type=\"icon\" file=\"\" field=\"type\" indent=\"indent\">-</column>";
            sCols = sCols + "<column type=\"string\" field=\"code\">Код</column>";
            sCols = sCols + "<column type=\"string\" field=\"name\">Наименование</column>";
            sCols = sCols + "<column type=\"string\" field=\"start_usage_date\" depends=\"type\">Начат</column>";
            sCols = sCols + "<column type=\"string\" field=\"last_usage_date\">Последний вход</column>";
            sCols = sCols + "<column type=\"string\" field=\"score\">Баллы</column>";
            sCols = sCols + "<column type=\"string\" field=\"state_name\">Состояние</column>";
            sCols = sCols + "<column type=\"string\" field=\"action\" islaunch=\"url\">-</column>";
            break;

        case "test":

		    oLearningDoc = OpenDoc( UrlFromDocID( iEId ) ).TopElem;
		    oCourseDoc = OpenDoc( UrlFromDocID( oLearningDoc.assessment_id ) ).TopElem;
		    sCard = sCard + "<pagename>" + oCourseDoc.code + " " + oCourseDoc.title + "</pagename>";

		    sData = sData + "<element type=\"launch\">";

            sInfo = sInfo + "<data><element>";

		    sInfo = sInfo + "<course_code>" + oCourseDoc.code + "</course_code>";
            sRows = sRows + "<row type=\"string\" field=\"course_code\">Код:</row>";
		    sInfo = sInfo + "<course_name>" + oCourseDoc.title + "</course_name>";
            sRows = sRows + "<row type=\"string\" field=\"course_name\">Наименование:</row>";
		    sInfo = sInfo + "<last_usage_date>" + oLearningDoc.last_usage_date + "</last_usage_date>";
            sRows = sRows + "<row type=\"string\" field=\"last_usage_date\">Последний вход:</row>";
		    try { sInfo = sInfo + "<is_self_enrolled>" + oLearningDoc.is_self_enrolled + "</is_self_enrolled>";
		    sInfo = sInfo + "<max_end_date>" + oLearningDoc.max_end_date + "</max_end_date>"; } catch(e) {}
            sRows = sRows + "<row type=\"string\" field=\"max_end_date\">Закончить до:</row>";
		    sInfo = sInfo + "<state_id>" + oLearningDoc.state_id + "</state_id>";
		    try
		    {
		        sInfo = sInfo + "<state_name>" + oLearningDoc.state_id.ForeignElem.name + "</state_name>";
            }
            catch(e)
            {
		        sInfo = sInfo + "<state_name>" + sObjectDeleted + "</state_name>";
            }
            sRows = sRows + "<row type=\"string\" field=\"state_name\">Состояние курса:</row>";
		    sInfo = sInfo + "<score>" + oLearningDoc.score + "</score>";
            sRows = sRows + "<row type=\"string\" field=\"score\">Суммарный балл:</row>";

	        sInfo = sInfo + "<complete_allowed>0</complete_allowed>";
	        sInfo = sInfo + "<complete_action>Автоматически по завершению теста</complete_action>";
            sRows = sRows + "<row type=\"string\" field=\"complete_action\">Завершение:</row>";
	        sInfo = sInfo + "</element></data>";




		    sData = sData + "<parts><item>";

		    sData = sData + "<course_id>" + oLearningDoc.assessment_id + "</course_id>";
		    sData = sData + "<code>" + oLearningDoc.code + "</code>";
		    sData = sData + "<name>" + oCourseDoc.title + "</name>";
		    try { sData = sData + "<last_usage_part_code>" + oLearningDoc.last_usage_part_code + "</last_usage_part_code>" ; } catch(e) {}
		    sData = sData + "<start_usage_date>" + oLearningDoc.last_usage_date + "</start_usage_date>";
		    sData = sData + "<last_usage_date>" + oLearningDoc.last_usage_date + "</last_usage_date>";
		    try {
		        sData = sData + "<max_end_date>" + oLearningDoc.max_end_date + "</max_end_date>"; }
		    catch(e) {}
		    sData = sData + "<state_id>" + oLearningDoc.state_id + "</state_id>";
		    try
		    {
		        sData = sData + "<state_name>" + oLearningDoc.state_id.ForeignElem.name + "</state_name>";
		    }
		    catch(e)
		    {
		        sData = sData + "<state_name>" + sObjectDeleted + "</state_name>";
		    }
		    sData = sData + "<score>" + oLearningDoc.score + "</score>";
			sData = sData + "<width>750</width>";
			sData = sData + "<height>530</height>";
			sData = sData + "<scrolling>0</scrolling>";
			sData = sData + "<state_id>" + oLearningDoc.state_id + "</state_id>";
			sData = sData + "<action>";
			switch(oLearningDoc.state_id)
			{
			    case 0:
			        sData = sData + "Начать";
			        break;
			    case 1:
			        sData = sData + "Продолжить";
			        break;
			    case 2:
			        sData = sData + "Просмотреть";
			        break;
			}
			sData = sData + "</action>";
			try
			{
			    sData = sData + "<state_name>" + oLearningDoc.state_id.ForeignElem.name + "</state_name>";
            }
            catch(e)
            {
			    sData = sData + "<state_name>" + sObjectDeleted + "</state_name>";
            }
			sData = sData + "<url>test_launch.html?assessment_id=" + oLearningDoc.assessment_id + "\&amp;object_id=" + sEId + "\&amp;sid=" + tools.get_sum_sid( oLearningDoc.assessment_id ) + "</url>";

			sData = sData + "</item></parts></element>";


            sCols = sCols + "<column type=\"icon\" file=\"test\">-</column>";
            sCols = sCols + "<column type=\"string\" field=\"code\">Код</column>";
            sCols = sCols + "<column type=\"string\" field=\"name\">Наименование</column>";
            sCols = sCols + "<column type=\"string\" field=\"start_usage_date\">Начат</column>";
            sCols = sCols + "<column type=\"string\" field=\"last_usage_date\">Последний вход</column>";
            sCols = sCols + "<column type=\"string\" field=\"score\">Баллы</column>";
            sCols = sCols + "<column type=\"string\" field=\"state_name\">Состояние</column>";
            sCols = sCols + "<column type=\"string\" field=\"action\" islaunch=\"url\">-</column>";
            break;
    }

    sData = sData + "</data>";
    sCols = sCols + "</columns>";
    sInfo = sInfo + "</info>";
    sRows = sRows + "</rows>";
    sFields = sFields + "</fields>";
    sActions = sActions + "</actions>";
    sError = sError + "</error>";

    return sCard + sCols + sRows + sData + sInfo + sFields + sActions + sError;
}

function Review()
{
    sCard = "";
    sData = "<data>";
    sFields = "<fields>";
    sCols = "<columns>";
    sActions = "<actions>";
    sError = "<error>";
    sRows = "<rows>";
    sInfo = "<info>";

    switch(sObjectType)
    {
        case "course":
		    oLearningDoc = OpenDoc( UrlFromDocID( iEId ) ).TopElem;
		    oCourseDoc = OpenDoc( UrlFromDocID( oLearningDoc.course_id ) ).TopElem;
		    sCard = sCard + "<pagename>" + oLearningDoc.course_code + " " + oLearningDoc.course_name + "</pagename>";

		    sData = sData + "<element type=\"launch\">";
		    sData = sData + "<course_id>" + oLearningDoc.course_id + "</course_id>";
		    sData = sData + "<course_code>" + oLearningDoc.course_code + "</course_code>";
		    sData = sData + "<course_name>" + oLearningDoc.course_name + "</course_name>";
		    try { sData = sData + "<last_usage_part_code>" + oLearningDoc.last_usage_part_code + "</last_usage_part_code>" ; } catch(e) {}
		    sData = sData + "<last_usage_date>" + oLearningDoc.last_usage_date + "</last_usage_date>";
		    try { sData = sData + "<is_self_enrolled>" + oLearningDoc.is_self_enrolled + "</is_self_enrolled>";
		    sData = sData + "<max_end_date>" + oLearningDoc.max_end_date + "</max_end_date>"; } catch(e) {}
		    sData = sData + "<state_id>" + oLearningDoc.state_id + "</state_id>";
		    try
		    {
		        sData = sData + "<state_name>" + oLearningDoc.state_id.ForeignElem.name + "</state_name>";
		    }
		    catch(e)
		    {
		        sData = sData + "<state_name>" + sObjectDeleted + "</state_name>";
		    }
		    sData = sData + "<score>" + oLearningDoc.score + "</score>";
            sResponseType = "response_course";
            aResponseTypes = XQuery ( " for $type in response_types where $type/code = 'response_course' return $type " );
            bResponseTypeExists = (ArrayOptFirstElem(aResponseTypes) != undefined);
            if(bResponseTypeExists)
            {
		        oResponseType = ArrayFirstElem (aResponseTypes);
		        sResponseType = oResponseType.id
		    }

            sInfo = sInfo + "<data><element>";
		    sInfo = sInfo + "<course_id>" + oLearningDoc.course_id + "</course_id>";
		    sInfo = sInfo + "<course_code>" + oLearningDoc.course_code + "</course_code>";
            sRows = sRows + "<row type=\"string\" field=\"course_code\">Код:</row>";
		    sInfo = sInfo + "<course_name>" + oLearningDoc.course_name + "</course_name>";
            sRows = sRows + "<row type=\"string\" field=\"course_name\">Наименование:</row>";
		    try { sInfo = sInfo + "<last_usage_part_code>" + oLearningDoc.last_usage_part_code + "</last_usage_part_code>" ; } catch(e) {}
		    sInfo = sInfo + "<last_usage_date>" + oLearningDoc.last_usage_date + "</last_usage_date>";
            sRows = sRows + "<row type=\"string\" field=\"last_usage_date\">Последний вход:</row>";
		    try { sInfo = sInfo + "<is_self_enrolled>" + oLearningDoc.is_self_enrolled + "</is_self_enrolled>";
		    sInfo = sInfo + "<max_end_date>" + oLearningDoc.max_end_date + "</max_end_date>"; } catch(e) {}
            sRows = sRows + "<row type=\"string\" field=\"max_end_date\">Закончить до:</row>";
		    sInfo = sInfo + "<state_id>" + oLearningDoc.state_id + "</state_id>";
		    try
		    {
		        sInfo = sInfo + "<state_name>" + oLearningDoc.state_id.ForeignElem.name + "</state_name>";
            }
            catch(e)
            {
		        sInfo = sInfo + "<state_name>" + sObjectDeleted + "</state_name>";
            }
            sRows = sRows + "<row type=\"string\" field=\"state_name\">Состояние курса:</row>";
		    sInfo = sInfo + "<score>" + oLearningDoc.score + "</score>";
            sRows = sRows + "<row type=\"string\" field=\"score\">Суммарный балл:</row>";

            if(bResponseTypeExists)
            {
		        aResponses = XQuery ( " for $elem in responses where $elem/type = 'course' and $elem/object_id = " + oLearningDoc.course_id + " and $elem/person_id = " + curUserID.XQueryLiteral + " return $elem " );
                bResponse = (ArrayOptFirstElem(aResponses) != undefined);

		        if(!bResponse)
		        {
		            sInfo = sInfo + "<response>Не написан</response>";
                    sRows = sRows + "<row type=\"string\" field=\"response\">Отзыв на курс:</row>";
		            sInfo = sInfo + "</element></data>";
		            sInfo = sInfo + "<actions>"
                    sInfo = sInfo + "<item id=\"response\">";
                    sInfo = sInfo + "<name>Написать отзыв</name>";
                    sInfo = sInfo + "<url>layout=form&amp;object_type=response&amp;resp_id=" + sResponseType + "&amp;state=active&amp;filter=all&amp;person=me&amp;menu=my_active_responses&amp;eid=" + sEId + "</url>";
                    sRows = sRows + "<row type=\"action\" control=\"button\">response</row>";
                    sInfo = sInfo + "</item></actions>";
		        }
		        else
		        {
		            sInfo = sInfo + "<response>Написан</response>";
                    sRows = sRows + "<row type=\"string\" field=\"response\">Отзыв на курс:</row>";
		            sInfo = sInfo + "</element></data>";
		        }
		    }
		    else
		    {
	            sInfo = sInfo + "<response>Форма отзыва не задана</response>";
                sRows = sRows + "<row type=\"string\" field=\"response\">Отзыв на курс:</row>";
	            sInfo = sInfo + "</element></data>";
		    }

		    sData = sData + "<parts>";

			for ( _part in oLearningDoc.parts )
			{

			    sData = sData + "<item><code>" + _part.code + "</code>";
				sData = sData + "<name>" + _part.name + "</name>";
				sData = sData + "<type>" + _part.type + "</type>";
				sData = sData + "<parent_part_code>" + _part.parent_part_code + "</parent_part_code>";
				try { sData = sData + "<is_mandatory>" + _part.is_mandatory + "</is_mandatory>"; } catch(e) {}
				sData = sData + "<start_usage_date>" + _part.start_usage_date + "</start_usage_date>";
				sData = sData + "<last_usage_date>" + _part.last_usage_date + "</last_usage_date>";
				sData = sData + "<score>" + _part.score + "</score>";

				try
				{
					_course_part = oCourseDoc.parts.GetChildByKey( _part.code );

					sData = sData + "<max_score>" + _course_part.max_score + "</max_score>";
					sData = sData + "<mastery_score>" + _course_part.mastery_score + "</mastery_score>";
					sData = sData + "<desc>" + _course_part.desc + "</desc>";
				}
				catch ( e )
				{
				}

				sData = sData + "<width>" + oCourseDoc.Width( _part.code ) + "</width>";
				sData = sData + "<height>" + oCourseDoc.Height( _part.code ) + "</height>";
				sData = sData + "<scrolling>" + ( oCourseDoc.DispScrolling( _part.code ) ? '1' : '0' ) + "</scrolling>";

				sData = sData + "<state_id>" + _part.state_id + "</state_id>";
				try
				{
				    sData = sData + "<state_name>" + _part.state_id.ForeignElem.name + "</state_name></item>";
				}
				catch(e)
				{
				    sData = sData + "<state_name>" + sObjectDeleted + "</state_name></item>";
				}
			}

			sData = sData + "</parts></element>";


            sCols = sCols + "<column type=\"icon\" file=\"lesson\">-</column>";
            sCols = sCols + "<column type=\"string\" field=\"code\">Код</column>";
            sCols = sCols + "<column type=\"string\" field=\"name\">Наименование</column>";
            sCols = sCols + "<column type=\"string\" field=\"start_usage_date\">Начат</column>";
            sCols = sCols + "<column type=\"string\" field=\"last_usage_date\">Последний вход</column>";
            sCols = sCols + "<column type=\"string\" field=\"score\">Баллы</column>";
            sCols = sCols + "<column type=\"string\" field=\"state_name\">Состояние</column>";

            break;

        case "test":

		    oLearningDoc = OpenDoc( UrlFromDocID( iEId ) ).TopElem;
		    oCourseDoc = OpenDoc( UrlFromDocID( oLearningDoc.assessment_id ) ).TopElem;
		    sCard = sCard + "<pagename>" + oCourseDoc.code + " " + oCourseDoc.title + "</pagename>";

            sResponseType = "response_assessment";
		    aResponseTypes = XQuery ( " for $type in response_types where $type/code = 'response_assessment' return $type " );
		    bResponseTypeExists = (ArrayOptFirstElem(aResponseTypes) != undefined);
		    if(bResponseTypeExists)
		    {
		        oResponseType = ArrayFirstElem (aResponseTypes);
		        sResponseType = oResponseType.id
		    }

		    sData = sData + "<element type=\"launch\">";


            sInfo = sInfo + "<data><element>";
		    sInfo = sInfo + "<course_code>" + oCourseDoc.code + "</course_code>";
            sRows = sRows + "<row type=\"string\" field=\"course_code\">Код:</row>";
		    sInfo = sInfo + "<course_name>" + oCourseDoc.title + "</course_name>";
            sRows = sRows + "<row type=\"string\" field=\"course_name\">Наименование:</row>";
		    sInfo = sInfo + "<last_usage_date>" + oLearningDoc.last_usage_date + "</last_usage_date>";
            sRows = sRows + "<row type=\"string\" field=\"last_usage_date\">Последний вход:</row>";
		    try { sInfo = sInfo + "<is_self_enrolled>" + oLearningDoc.is_self_enrolled + "</is_self_enrolled>";
		    sInfo = sInfo + "<max_end_date>" + oLearningDoc.max_end_date + "</max_end_date>"; } catch(e) {}
            sRows = sRows + "<row type=\"string\" field=\"max_end_date\">Закончить до:</row>";
		    sInfo = sInfo + "<state_id>" + oLearningDoc.state_id + "</state_id>";
		    try
		    {
		        sInfo = sInfo + "<state_name>" + oLearningDoc.state_id.ForeignElem.name + "</state_name>";
            }
            catch(e)
            {
		        sInfo = sInfo + "<state_name>" + sObjectDeleted + "</state_name>";
            }
            sRows = sRows + "<row type=\"string\" field=\"state_name\">Состояние курса:</row>";
		    sInfo = sInfo + "<score>" + oLearningDoc.score + "</score>";
            sRows = sRows + "<row type=\"string\" field=\"score\">Суммарный балл:</row>";

            if(bResponseTypeExists)
            {
		        aResponses = XQuery ( " for $elem in responses where $elem/type = 'assessment' and $elem/object_id = " + oLearningDoc.assessment_id + " and $elem/person_id = " + curUserID.XQueryLiteral + " return $elem " );
                bResponse = (ArrayOptFirstElem(aResponses) != undefined);

		        if(!bResponse)
		        {
		            sInfo = sInfo + "<response>Не написан</response>";
                    sRows = sRows + "<row type=\"string\" field=\"response\">Отзыв на тест:</row>";
		            sInfo = sInfo + "</element></data>";
		            sInfo = sInfo + "<actions>"
                    sInfo = sInfo + "<item id=\"response\">";
                    sInfo = sInfo + "<name>Написать отзыв</name>";
                    sInfo = sInfo + "<url>layout=form&amp;object_type=response&amp;resp_id=" + sResponseType + "&amp;state=active&amp;filter=all&amp;person=me&amp;menu=my_active_responses&amp;eid=" + sEId + "</url>";
                    sRows = sRows + "<row type=\"action\" control=\"button\">response</row>";
                    sInfo = sInfo + "</item></actions>";
		        }
		        else
		        {
		            sInfo = sInfo + "<response>Написан</response>";
                    sRows = sRows + "<row type=\"string\" field=\"response\">Отзыв на тест:</row>";
		            sInfo = sInfo + "</element></data>";
		        }
		    }
		    else
		    {
	            sInfo = sInfo + "<response>Форма отзыва не задана</response>";
                sRows = sRows + "<row type=\"string\" field=\"response\">Отзыв на тест:</row>";
	            sInfo = sInfo + "</element></data>";
		    }

		    sData = sData + "<parts><item>";

		    sData = sData + "<course_id>" + oLearningDoc.assessment_id + "</course_id>";
		    sData = sData + "<code>" + oLearningDoc.code + "</code>";
		    sData = sData + "<name>" + oCourseDoc.title + "</name>";
		    try { sData = sData + "<last_usage_part_code>" + oLearningDoc.last_usage_part_code + "</last_usage_part_code>" ; } catch(e) {}
		    sData = sData + "<start_usage_date>" + oLearningDoc.start_usage_date + "</start_usage_date>";
		    sData = sData + "<last_usage_date>" + oLearningDoc.last_usage_date + "</last_usage_date>";
		    try {
		        sData = sData + "<max_end_date>" + oLearningDoc.max_end_date + "</max_end_date>"; }
		    catch(e) {}
		    sData = sData + "<state_id>" + oLearningDoc.state_id + "</state_id>";
		    try
		    {
		        sData = sData + "<state_name>" + oLearningDoc.state_id.ForeignElem.name + "</state_name>";
		    }
		    catch(e)
		    {
		        sData = sData + "<state_name>" + sObjectDeleted + "</state_name>";
		    }
		    sData = sData + "<score>" + oLearningDoc.score + "</score>";
			sData = sData + "<width>750</width>";
			sData = sData + "<height>530</height>";
			sData = sData + "<scrolling>0</scrolling>";
			sData = sData + "<state_id>" + oLearningDoc.state_id + "</state_id>";
			try
			{
			    sData = sData + "<state_name>" + oLearningDoc.state_id.ForeignElem.name + "</state_name>";
			}
			catch(e)
			{
			    sData = sData + "<state_name>" + sObjectDeleted + "</state_name>";
			}
			sData = sData + "</item></parts></element>";


            sCols = sCols + "<column type=\"icon\" file=\"test\">-</column>";
            sCols = sCols + "<column type=\"string\" field=\"code\">Код</column>";
            sCols = sCols + "<column type=\"string\" field=\"name\">Наименование</column>";
            sCols = sCols + "<column type=\"string\" field=\"start_usage_date\">Начат</column>";
            sCols = sCols + "<column type=\"string\" field=\"last_usage_date\">Последний вход</column>";
            sCols = sCols + "<column type=\"string\" field=\"score\">Баллы</column>";
            sCols = sCols + "<column type=\"string\" field=\"state_name\">Состояние</column>";

            break;
    }

    sData = sData + "</data>";
    sCols = sCols + "</columns>";
    sRows = sRows + "</rows>";
    sInfo = sInfo + "</info>";
    sFields = sFields + "</fields>";
    sActions = sActions + "</actions>";
    sError = sError + "</error>";

    return sCard + sCols + sRows + sInfo + sData + sFields + sActions + sError;
}


function Acknowledge()
{
    sCard = "";
    sData = "<data>";
    sFields = "<fields>";
    sRows = "<rows>";
    sActions = "<actions>";
    sError = "<error>";

    switch(sObjectType)
    {
        case "request":
        	oDoc = OpenDoc( UrlFromDocID( iEId ) ).TopElem;
        	curObject = oDoc;
        	aRequestTypes = XQuery (" for $elem in request_types where $elem/id = " + iReqId + " return $elem ");
        	oElem = ArrayFirstElem(aRequestTypes);
        	sObjType = oElem.object_type;
            sName = Validate(oElem.name);
            sCard = sCard + "<pagename>" + sName + "</pagename>";
            sData = sData + "<element>";
		    sData = sData + "<eid>" + sEId + "</eid>";
		    switch(sObjType)
		    {
		        case "course":
		            sId = sEId;
		            try
		            {
		                sData = sData + "<target>" + oDoc.object_id.ForeignElem.code + " " + oDoc.object_id.ForeignElem.name + "</target>";
		            }
		            catch(e)
		            {
		                sData = sData + "<target>" + sObjectDeleted + "</target>";
		            }
		            break;
		        case "assessment":
		            sId = sEId;
		            try
		            {
		                sData = sData + "<target>" + oDoc.object_id.ForeignElem.code + " " + oDoc.object_id.ForeignElem.title + "</target>";
		            }
		            catch(e)
		            {
		                sData = sData + "<target>" + sObjectDeleted + "</target>";
		            }
		            break;
		        case "event":
		            sId = sEId;
		            try
		            {
		                sData = sData + "<target>" + oDoc.object_id.ForeignElem.code + " " + oDoc.object_id.ForeignElem.name + "</target>";
		            }
		            catch(e)
		            {
		                sData = sData + "<target>" + sObjectDeleted + "</target>";
		            }
                    break;
		        case "education_method":
		            sId = sEId;
		            try
		            {
		                sData = sData + "<target>" + oDoc.object_id.ForeignElem.code + " " + oDoc.object_id.ForeignElem.name + "</target>";
		            }
		            catch(e)
		            {
		                sData = sData + "<target>" + sObjectDeleted + "</target>";
		            }
		            break;
		    }
            sRows = sRows + "<row type=\"string\" field=\"target\">Предмет запроса:</row>";

		    aItem  = tools.get_custom_template( "request_type", iReqId, oDoc );
//       	    alert(aItem.Xml);

		    sData = sData + "<eid>" + sEId + "</eid>";
		    sData = sData + "<type_id>" + oDoc.request_type_id + "</type_id>";
		    sData = sData + "<type_name>" + sName + "</type_name>";
		    sData = sData + "<create_date>" + oDoc.create_date + "</create_date>";
		    sData = sData + "<person_name>" + oDoc.person_fullname + "</person_name>";
		    try
		    {
		        sData = sData + "<person_position>" + oDoc.person_id.ForeignElem.position_name + "</person_position>";
		    }
		    catch(e)
		    {
		        sData = sData + "<person_position>" + sObjectDeleted + "</person_position>";
		    }
		    sData = sData + "<person_subdivision>" + oDoc.person_org_name + "</person_subdivision>";

		    sData = sData + "<comment>" + oDoc.comment + "</comment>";

		    aItem  = tools.get_custom_template( "request_type", oDoc.request_type_id, oDoc );
		    aFields = oDoc.custom_elems;
		    if(aItem!=null && aFields!=null)
		    {
		        aInputs = aItem.fields;
    		    for (var i=0;i<ArrayCount(aInputs);i++)
    		    {
		            if(aInputs[i].disp_web)
		            {
                        sData = sData + "<" + aInputs[i].name + ">";
                        try
                        {
                            oItem = ArrayFind(aFields,"name==aInputs[i].name");
                            sData = sData + oItem.value;
                        }
                        catch(e)
                        {
                        }
	                    sData = sData + "</" + aInputs[i].name + ">";
	                    sRows = sRows + "<row type=\"string\" field=\"" + aInputs[i].name + "\">" + aInputs[i].title + "</row>";
		            }
		        }
		    }

            sRows = sRows + "<row type=\"field\" field=\"comment\">Комментарий:</row>";

    	    sWFId = oDoc.workflow_id;
    	    oWFDoc = OpenDoc( UrlFromDocID( Int(sWFId) ) ).TopElem;

            if(eval(oWFDoc.condition_eval_str))
            {

        	    aWFFields = oWFDoc.workflow_fields;

		        if(aWFFields!=null)
		        {
    		        for (oField in aWFFields)
    		        {
	                    sFieldGroup = oField.field_group_id;
	                    try
	                    {
	                        oGroup = ArrayFind(oWFDoc.field_groups, "code == sFieldGroup");
	                    }
	                    catch(e)
	                    {
	                        continue;
	                    }
	                    if(eval(oGroup.write_conditions.condition_eval_str))
	                    {
	                        sData = sData + "<item type=\"field\" id=\"" + oField.name + "\">";
	                        sData = sData + "<type>" + oField.type + "</type>";
	                        sData = sData + "<name>" + oField.name + "</name>";
	                        sRows = sRows + "<row type=\"field\" field=\"" + oField.name + "\">" + oField.title + "</row>";
	                        if(oField.entries!=null)
	                        {
	                           sData = sData +  oField.entries.Xml;
	                        }
	                        sData = sData + "</item>";
	                    }
	                    else
	                    {
	                        if(eval(oGroup.read_conditions.condition_eval_str))
	                        {
                                sData = sData + "<" + oField.name + ">";
                                try
                                {
                                    oItem = ArrayFind(aWFFields,"name==oField.name");
                                    sData = sData + oItem.value;
                                }
                                catch(e)
                                {
                                }
	                            sData = sData + "</" + oField.name + ">";
	                            sRows = sRows + "<row type=\"string\" field=\"" + oField.name + "\">" + oField.title + "</row>";
	                        }
	                        else
	                            continue;
	                    }
    		        }

       	        }

        	    aWFActions = oWFDoc.actions;

    //        	alert(aWFActions.Xml);
		        if(aWFActions!=null)
		        {
    		        for (oAction in aWFActions)
    		        {
	                    if(oAction.is_false) continue;
    //	                alert(eval(oAction.condition_eval_str));
	                    if(!eval(oAction.condition_eval_str)) continue;
                        sActions = sActions + "<item id=\"" + oAction.code + "\" type=\"javascript\">";
                        sActions = sActions + "<name>" + oAction.name + "</name>";
                        sActions = sActions + "<url>DoSubmit('layout=list&amp;object_type=request&amp;state=active&amp;filter=all&amp;person=col&amp;menu=col_requests&amp;eid=" + sEId + "','workflow', '"+ sEId + "', '" + sEId + "', '" + oAction.code + "');</url>";
                        sRows = sRows + "<row type=\"action\" control=\"button\">" + oAction.code + "</row>";
                        sActions = sActions + "</item>";
    		        }

       	        }

       	    }
       	    else
       	    {

    	        aWFFields = oWFDoc.workflow_fields;

	            if(aWFFields!=null)
	            {
		            for (oField in aWFFields)
		            {
                        sFieldGroup = oField.field_group_id;
                        try
                        {
                            oGroup = ArrayFind(oWFDoc.field_groups, "code == sFieldGroup");
                        }
                        catch(e)
                        {
                            continue;
                        }
                        if( (eval(oGroup.read_conditions.condition_eval_str)) )
                        {
                            sData = sData + "<" + oField.name + ">";
                            try
                            {
                                oItem = ArrayFind(aWFFields,"name==oField.name");
                                sData = sData + oItem.value;
                            }
                            catch(e)
                            {
                            }
                            sData = sData + "</" + oField.name + ">";
                            sRows = sRows + "<row type=\"string\" field=\"" + oField.name + "\">" + oField.title + "</row>";
                        }
                        else
                            if( (eval(oGroup.write_conditions.condition_eval_str)) )
                            {
                                sData = sData + "<" + oField.name + ">";
                                try
                                {
                                    oItem = ArrayFind(aWFFields,"name==oField.name");
                                    sData = sData + oItem.value;
                                }
                                catch(e)
                                {
                                }
                                sData = sData + "</" + oField.name + ">";
                                sRows = sRows + "<row type=\"string\" field=\"" + oField.name + "\">" + oField.title + "</row>";
                            }
                            else
                             continue;
		            }
		        }

       	        if(oDoc.is_workflow_init)
       	        {
       	            sWFState = oDoc.workflow_state;
       	            try
       	            {
       	                oWFState = ArrayFind(oWFDoc.states, "code == sWFState");
       	                sWFState = oWFState.name;
       	            }
       	            catch(e)
       	            {}
		            sData = sData + "<wf_state>" + sWFState + "</wf_state>";
                    sRows = sRows + "<row type=\"string\" field=\"wf_state\">Статус документооборота запроса:</row>";
       	        }
       	    }

	        sData = sData + "</element>";
            break;

    }

    sData = sData + "</data>";
    sRows = sRows + "</rows>";
    sFields = sFields + "</fields>";
    sActions = sActions + "</actions>";
    sError = sError + "</error>";

    return sCard + sRows + sData + sFields + sActions + sError
}


function Form()
{
    sCard = "";
    sData = "<data>";
    sFields = "<fields>";
    sRows = "<rows>";
    sActions = "<actions>";
    sError = "<error>";

    switch(sObjectType)
    {
        case "response":
        	oDoc = OpenDoc( UrlFromDocID( iEId ) ).TopElem;
        	aResponses = XQuery (" for $elem in response_types where $elem/id = " + iRespId + " return $elem ");
        	oElem = ArrayFirstElem(aResponses);
        	sObjType = oElem.object_type;
            sName = Validate(oElem.name);
            sCard = sCard + "<pagename>" + sName + "</pagename>";
            sData = sData + "<element>";

		    sData = sData + "<eid>" + sEId + "</eid>";
		    switch(sObjType)
		    {
		        case "course":
		            sId = oDoc.course_id;
		            sData = sData + "<target>" + oDoc.course_code + " " + oDoc.course_name + "</target>";
		            break;
		        case "assessment":
		            sId = oDoc.assessment_id;
		            sData = sData + "<target>" + oDoc.assessment_code + " " + oDoc.assessment_name + "</target>";
		            break;
		        case "event":
		            sId = sEId;
		            sData = sData + "<target>" + oDoc.code + " " + oDoc.name + "</target>";
		            break;
		    }
            sRows = sRows + "<row type=\"string\" field=\"target\">Предмет отзыва:</row>";

		    aItem  = tools.get_custom_template( "response_type", iRespId, oDoc );
		    if(aItem!=null)
		    {
		        aFields = aItem.fields;
    		    for (oField in aFields)
    		    {
		            if(oField.disp_web)
		            {
		                sData = sData + "<item type=\"field\" id=\"" + oField.name + "\">";
		                sData = sData + "<type>" + oField.type + "</type>";
		                sData = sData + "<name>" + oField.name + "</name>";
		                if(oField.is_required)
		                    sData = sData + "<is_mandatory>1</is_mandatory>";
		                sRows = sRows + "<row type=\"field\" field=\"" + oField.name + "\">" + oField.title + "</row>";
		                if(oField.entries!=null)
		                {
		                   sData = sData +  oField.entries.Xml;
		                }
		                sData = sData + "</item>";
		            }
    		    }

       	    }
            sData = sData + "<item type=\"field\" id=\"comment\">";
            sData = sData + "<type>text</type>";
            sData = sData + "<name>comment</name>";
            sData = sData + "</item>";
            sRows = sRows + "<row type=\"field\" field=\"comment\">Комментарий:</row>";

            sActions = sActions + "<item id=\"response\" type=\"javascript\">";
            sActions = sActions + "<name>Отправить отзыв</name>";
            sActions = sActions + "<url>DoSubmit('layout=list&amp;object_type=response&amp;state=active&amp;filter=all&amp;person=me&amp;menu=my_active_responses&amp;action=response&amp;eid=" + sId + "','response', '"+ sId + "', '" + sId + "', '" + sRespId + "');</url>";
            sRows = sRows + "<row type=\"action\" control=\"button\">response</row>";
            sActions = sActions + "</item>";
	        sData = sData + "</element>";
            break;
        case "request":
        	oDoc = OpenDoc( UrlFromDocID( iEId ) ).TopElem;
        	aRequestTypes = XQuery (" for $elem in request_types where $elem/id = " + iReqId + " return $elem ");
        	oElem = ArrayFirstElem(aRequestTypes);
        	sObjType = oElem.object_type;
            sName = Validate(oElem.name);
            sCard = sCard + "<pagename>" + sName + "</pagename>";
            sData = sData + "<element>";
		    sData = sData + "<eid>" + sEId + "</eid>";
		    switch(sObjType)
		    {
		        case "course":
		            sId = sEId;
		            sData = sData + "<target>" + oDoc.code + " " + oDoc.name + "</target>";
		            break;
		        case "assessment":
		            sId = sEId;
		            sData = sData + "<target>" + oDoc.code + " " + oDoc.title + "</target>";
		            break;
		        case "event":
		            sId = sEId;
		            sData = sData + "<target>" + oDoc.code + " " + oDoc.name + "</target>";
		            break;
		        case "education_method":
		            sId = sEId;
		            sData = sData + "<target>" + oDoc.code + " " + oDoc.name + "</target>";
		            break;
		    }
            sRows = sRows + "<row type=\"string\" field=\"target\">Предмет запроса:</row>";

		    aItem  = tools.get_custom_template( "request_type", iReqId, oDoc );
		    if(aItem!=null)
		    {
		        aFields = aItem.fields;
    		    for (oField in aFields)
    		    {
		            if(oField.disp_web)
		            {
		                sData = sData + "<item type=\"field\" id=\"" + oField.name + "\">";
		                sData = sData + "<type>" + oField.type + "</type>";
		                sData = sData + "<name>" + oField.name + "</name>";
		                if(oField.is_required)
		                    sData = sData + "<is_mandatory>1</is_mandatory>";
		                sRows = sRows + "<row type=\"field\" field=\"" + oField.name + "\">" + oField.title + "</row>";
		                if(oField.entries!=null)
		                {
		                   sData = sData +  oField.entries.Xml;
		                }
		                sData = sData + "</item>";
		            }
    		    }

       	    }
            sData = sData + "<item type=\"field\" id=\"comment\">";
            sData = sData + "<type>text</type>";
            sData = sData + "<name>comment</name>";
            sData = sData + "</item>";
            sRows = sRows + "<row type=\"field\" field=\"comment\">Комментарий:</row>";

            sActions = sActions + "<item id=\"response\" type=\"javascript\">";
            sActions = sActions + "<name>Отправить запрос</name>";
            sActions = sActions + "<url>DoSubmit('layout=list&amp;object_type=request&amp;state=active&amp;filter=all&amp;person=me&amp;menu=my_active_requests&amp;action=request&amp;eid=" + sId + "','request', '"+ sId + "', '" + sId + "', '" + sReqId + "');</url>";
            sRows = sRows + "<row type=\"action\" control=\"button\">response</row>";
            sActions = sActions + "</item>";
	        sData = sData + "</element>";
            break;

        case "lector":
        	oDoc = OpenDoc( UrlFromDocID( iEId ) ).TopElem;

            sCard = sCard + "<pagename>" + Validate(oDoc.person_fullname) + "</pagename>";

            sRows = sRows + "<row type=\"string\" field=\"name\">ФИО:</row>";
            sRows = sRows + "<row type=\"string\" field=\"type_name\">Тип:</row>";
            if(oDoc.allow_publication)
            {
                sRows = sRows + "<row type=\"string\" field=\"email\">E-mail:</row>";
                if (oDoc.desc.HasValue) sRows = sRows + "<row type=\"html\" field=\"desc\">Описание:</row>";
            }

            sData = sData + "<element>";
            sData = sData + "<eid>" + oDoc.person_id + "</eid>";

	        sData = sData + "<name>" + oDoc.person_fullname + "</name>";
	        sData = sData + "<type_name>" + curLngCommon.lector_types.GetChildByKey( oDoc.type ).name + "</type_name>";
	        sData = sData + "<open>" + oDoc.allow_publication + "</open>";
	        if ( oDoc.allow_publication )
	        {
	            try {
	                oInfo = oDoc.person_id.ForeignElem;
	                sData = sData + "<email>" + oInfo.email + "</email>";
	                } catch(e) {}
	            if ( oDoc.desc.HasValue )
	            {
	                sData = sData + "<desc><![CDATA[" + tools_web.get_web_desc( oDoc.desc, UrlFromDocID( iEId ), oDoc.Name + '.desc') + "]]></desc>";

	            }
	        }
	        sData = sData + "</element>";
            break;
        case "program":
            sType = "education_method";
            aFullList = XQuery( "for $elem in education_methods where $elem/id = " + iEId + " return $elem" );
            if(ArrayOptFirstElem(aFullList) != undefined)
            {
                aEventList = XQuery( "for $elem in events where $elem/education_method_id = " + iEId + " return $elem" );
                sType = "education_method";
            }
            else
            {
                aFullList = XQuery( "for $elem in compound_programs where $elem/id = " + iEId + " return $elem" );
                if(ArrayOptFirstElem(aFullList) != undefined)
                {
                    aEventList = XQuery( "for $elem in events where $elem/compound_program_id = " + iEId + " return $elem" );
                    sType = "compound_program";
                }
                else
                {
                    aFullList = XQuery( "for $elem in education_programs where $elem/id = " + iEId + " return $elem" );
                    if(ArrayOptFirstElem(aFullList) != undefined)
                    {
                        aEventList = XQuery( "for $elem in events where $elem/education_program_id = " + iEId + " return $elem" );
                        sType = "education_program";
                    }
                    else
                    {
                        break;
                    }
                }
            }

            oElem = ArrayFirstElem(aFullList);
            oDoc = OpenDoc( UrlFromDocID( iEId ) ).TopElem;

            switch(sType)
            {
                case "education_method":
                    sCard = sCard + "<pagename>" + Validate(oElem.code) + " " + Validate(oElem.name) + "</pagename>";

                    sRows = sRows + "<row type=\"string\" field=\"code\">Код:</row>";
                    sRows = sRows + "<row type=\"string\" field=\"name\">Наименование:</row>";
                    sRows = sRows + "<row type=\"string\" field=\"type_name\">Тип программы:</row>";
                    if(oElem.type=="org") sRows = sRows + "<row type=\"string\" field=\"org_name\">Обучающая организация:</row>";

                    sRows = sRows + "<row type=\"string\" field=\"duration\">Продолжительность (часов):</row>";
                    sRows = sRows + "<row type=\"string\" field=\"participants\">Число участников:</row>";
                    sRows = sRows + "<row type=\"string\" field=\"price\">Стоимость:</row>";
                    sRows = sRows + "<row type=\"array\" field=\"lectors/item/name\">Преподаватели:</row>";
                    if(ArrayOptFirstElem(aEventList) != undefined) sRows = sRows + "<row type=\"array\" field=\"events/item/name\">Мероприятия, входящие в программу:</row>";
                    if(oDoc.comment!=null) sRows = sRows + "<row type=\"string\" field=\"comment\">Комментарий:</row>";
                    sRows = sRows + "<row type=\"string\" field=\"state_name\">Мое участие:</row>";
                    if(oDoc.desc!=null) sRows = sRows + "<row type=\"html\" field=\"desc\">Описание:</row>";

                    sData = sData + "<element>";
                    sData = sData + "<eid>" + oElem.id + "</eid>";
                    sData = sData + "<code>" + Validate(oElem.code) + "</code>";
                    sData = sData + "<name>" + Validate(oElem.name) + "</name>";

		            sData = sData + "<type_id>" + oElem.type + "</type_id>";
		            sData = sData + "<type_name>" + Validate(curLngCommon.education_method_types.GetChildByKey( oElem.type ).name) + "</type_name>";

		            if(oElem.type=="org")
		            {
		                sData = sData + "<org_id>" + oDoc.education_org_id + "</org_id>";
		                try
		                {
		                    sData = sData + "<org_name>" + Validate(oDoc.education_org_id.ForeignElem.name) + "</org_name>";
		                }
		                catch(e)
		                {
		                    sData = sData + "<org_name>" + sObjectDeleted + "</org_name>";
		                }
                    }

		            sData = sData + "<duration>" + oElem.duration + "</duration>";
		            sData = sData + "<participants>" + oElem.person_num + "</participants>";
		            sPrice = oElem.cost;
		            sData = sData + "<cost>" + oElem.cost + "</cost>";
		            sData = sData + "<cost_currency>";
    		        try
		            {
			            sPrice = sPrice + " " + Validate( oDoc.currency.ForeignElem.name );
			            sData = sData + Validate( oDoc.currency.ForeignElem.name );
		            }
		            catch ( e )
		            {
		            }
		            sData = sData + "</cost_currency>";
		            sData = sData + "<cost_type>";
		            try
		            {
			            sData = sData + Validate( oDoc.cost_type.ForeignElem.name );
			            sPrice = sPrice + " " + Validate( oDoc.cost_type.ForeignElem.name );
		            }
		            catch ( e )
		            {
		            }
		            sData = sData + "</cost_type>";
                    sData = sData + "<price>" + sPrice + "</price>";
                    sData = sData + "<open_program>" + oElem.is_open + "</open_program>";

                    sData = sData + "<lectors>";
			        for ( _lector in oElem.lectors )
			        {
				        try
				        {
					        _cur_lector = _lector.lector_id.ForeignElem;
					        sData = sData + "<item>";
					        sData = sData + "<id>" + _lector.PrimaryKey + "</id>";
					        sData = sData + "<type>" + Validate(curLngCommon.lector_types.GetChildByKey( _cur_lector.type ).name) + "</type>";
					        sData = sData + "<name>" + _cur_lector.person_fullname + "</name>";
					        sData = sData + "</item>";
				        }
				        catch ( e )
				        {

				        }
			        }
                    sData = sData + "</lectors>";

                    if(ArrayOptFirstElem(aEventList) != undefined)
                    {
                        sData = sData + "<events>";
			            for ( oEvent in aEventList )
			            {
				            try
				            {
					            sData = sData + "<item>";
					            sData = sData + "<id>" + oEvent.id + "</id>";
					            sData = sData + "<name>" + oEvent.name + "</name>";
					            sData = sData + "</item>";
				            }
				            catch ( e )
				            {

				            }
			            }
                        sData = sData + "</events>";
			        }

		            if(oDoc.comment!=null) sData = sData + "<comment>" + oDoc.comment + "</comment>";

		            if(oDoc.desc!=null) sData = sData + "<desc><![CDATA[" + oDoc.desc + "]]></desc>";

		            aRequests = XQuery (" for $elem in requests where $elem/object_id = " + oElem.id + " and $elem/person_id = " + curUserID.XQueryLiteral + " and $elem/status_id = 'active' return $elem ");
                    sState = "0";
                    if(ArrayOptFirstElem(aRequests) != undefined)
                    {
                        sState = "2";
                    }
                    sData = sData + "<state_id>" + sState + "</state_id>";
                    if(oElem.is_open && sState=="0")
                    {
                        sActions = sActions + "<item id=\"request\">";
                        sActions = sActions + "<name>Создать запрос на участие</name>";
                        sActions = sActions + "<url>layout=list&amp;object_type=request&amp;state=active&amp;filter=all&amp;person=me&amp;menu=my_active_requests&amp;action=request&amp;eid=" + oElem.id + "</url>";
                        sRows = sRows + "<row type=\"action\" control=\"button\">request</row>";
                        sActions = sActions + "</item>";
                    }

                    switch(sState)
                    {
                        case "0":
                            sState = "Не участвую";
                            break;
                        case "1":
                            sState = "В числе участвующих";
                            break;
                        case "2":
                            sState = "Подан запрос на участие";
                            break;
                    }
                    sData = sData + "<state_name>" + sState + "</state_name>";


                    sData = sData + "</element>";
                    break;
                case "education_program":
                case "compound_program":
                    sCard = sCard + "<pagename>" + Validate(oElem.code) + " " + Validate(oElem.name) + "</pagename>";

                    sRows = sRows + "<row type=\"string\" field=\"code\">Код:</row>";
                    sRows = sRows + "<row type=\"string\" field=\"name\">Наименование:</row>";
                    sRows = sRows + "<row type=\"string\" field=\"type_name\">Тип программы:</row>";
                    sRows = sRows + "<row type=\"array\" field=\"programs/item/name\">Включает учебные программы:</row>";


                    sData = sData + "<element>";
                    sData = sData + "<eid>" + oElem.id + "</eid>";
                    sData = sData + "<code>" + Validate(oElem.code) + "</code>";
                    sData = sData + "<name>" + Validate(oElem.name) + "</name>";


                    if(sType=="compound_program")
                    {
		                sData = sData + "<type_name>Модульная программа</type_name>";
                        sData = sData + "<programs>";
			            for ( oProgram in oElem.programs )
			            {
				            try
				            {
					            sData = sData + "<item>";
					            sData = sData + "<id>" + oProgram.id + "</id>";
					            sData = sData + "<name>" + oProgram.name + "</name>";
					            sData = sData + "</item>";
				            }
				            catch ( e )
				            {

				            }
			            }
			        }
			        else
			        {
		                sData = sData + "<type_name>Набор программ</type_name>";
                        sData = sData + "<programs>";
			            for ( oProgram in oElem.education_methods )
			            {
				            try
				            {
					            sData = sData + "<item>";
					            sData = sData + "<id>" + oProgram.education_method_id + "</id>";
					            sData = sData + "<name>" + oProgram.education_method_id.ForeignElem.name + "</name>";
					            sData = sData + "</item>";
				            }
				            catch ( e )
				            {

				            }
			            }
			        }
                    sData = sData + "</programs>";
                    sData = sData + "</element>";
                    break;
            }

//       	sCard = sCard + oElem.Xml;
//          sCard = sCard + tools_web.get_web_desc( oElem.desc, UrlFromDocID( iEId ), 'course.desc' );
            break;

        case "event":
            aFullList = XQuery( "for $elem in events where $elem/id = " + iEId + " return $elem" );
            oElem = ArrayFirstElem(aFullList);
            aActiveList = XQuery( "for $event in event_collaborators where $event/collaborator_id = " + curUserID.XQueryLiteral + " and $event/is_public = false() and $event/status_id != 'close' return $event" );
            aPublicList = XQuery( "for $event in events where $event/is_public = true() and $event/status_id != 'close' return $event" );
            aArchiveList = XQuery( "for $event in event_collaborators where $event/collaborator_id = " + curUserID.XQueryLiteral + " and $event/is_public = false() and $event/status_id = 'close' return $event" );
	        aRequests = XQuery (" for $elem in requests where $elem/object_id = " + oElem.id + " and $elem/person_id = " + curUserID.XQueryLiteral + " and $elem/status_id = 'active' return $elem ");
        	oEvent = OpenDoc( UrlFromDocID( iEId ) ).TopElem;

            sCard = sCard + "<pagename>" + Validate(oElem.code) + " " + Validate(oElem.name) + "</pagename>";

            bTutor = oEvent.tutors.ChildByKeyExists( curUserID );
            bPreparator = false;
            try
            {
                aPreparators = oEvent.even_preparations; // even - as used in WT!
            }
            catch(e)
            {
                try
                {
                    aPreparators = oEvent.event_preparations;
                }
                catch(x)
                {
                    aPreparators = new Array();
                }
            }
            if(ArrayOptFirstElem(aPreparators) != undefined)
            {
                for(oPreparator in aPreparators)
                {
                    if(Validate(oPreparator.person_id) == curUserID)
                    {
                        bPreparator = true;
                        break;
                    }
                }
            }

            aTutors = oEvent.tutors;
            aCollaborators = oEvent.collaborators;



            bWrite = curUser.access.access_role == "admin" || bTutor || bPreparator;
            bIsCol =  oEvent.collaborators.ChildByKeyExists( curUserID );
            bView = ( bIsCol || bWrite || bPreparator);

            sState = "0";
            if (ArrayOptFirstElem(aRequests) != undefined) sState = "2";
            if (bIsCol || bTutor || bPreparator) sState = "1";

            bCompoundProgram = oElem.compound_program_id!=null;
            bEducationProgram = oElem.education_program_id!=null;
            bEducationMethod = oElem.education_method_id!=null;
            bEducationOrg = oElem.education_org_id!=null;


            sFields = sFields + "<field type=\"id\">eid</field>";
            sFields = sFields + "<field type=\"string\">code</field>";
            sFields = sFields + "<field type=\"string\">name</field>";
            sFields = sFields + "<field type=\"string\">type</field>";
            sFields = sFields + "<field type=\"number\">type_id</field>";

            sFields = sFields + "<field type=\"string\">state_name</field>";
            if(oEvent.desc != "") sFields = sFields + "<field type=\"string\">description</field>";

            sRows = sRows + "<row type=\"string\" field=\"code\">Код:</row>";
            sRows = sRows + "<row type=\"string\" field=\"name\">Наименование:</row>";
            sRows = sRows + "<row type=\"string\" field=\"type_name\">Тип мероприятия:</row>";
            sRows = sRows + "<row type=\"string\" field=\"start_date\">Время начала:</row>";
            sRows = sRows + "<row type=\"string\" field=\"finish_date\">Время окончания:</row>";
            sRows = sRows + "<row type=\"string\" field=\"status_name\">Состояние:</row>";
            sRows = sRows + "<row type=\"string\" field=\"is_open\">Открытое мероприятие:</row>";
            sRows = sRows + "<row type=\"string\" field=\"is_public\">Публичное мероприятие:</row>";
            if(bCompoundProgram) sRows = sRows + "<row type=\"string\" field=\"compound_program_name\">Входит в модульную программу:</row>";
            if(bEducationProgram) sRows = sRows + "<row type=\"string\" field=\"education_program_name\">Входит в учебную программу:</row>";
            if(bEducationMethod) sRows = sRows + "<row type=\"string\" field=\"education_method_name\">Входит в учебную программу:</row>";
            if(bEducationOrg) sRows = sRows + "<row type=\"string\" field=\"education_org_name\">Образовательная организация:</row>";
            if(ArrayOptFirstElem(aPreparators) != undefined) sRows = sRows + "<row type=\"array\" field=\"preparators/item/name\">Ответственные за проведение:</row>";
            if(ArrayOptFirstElem(aTutors) != undefined)  sRows = sRows + "<row type=\"array\" field=\"tutors/item/name\">Преподаватели:</row>";
            if(ArrayOptFirstElem(aCollaborators) != undefined) sRows = sRows + "<row type=\"array\" field=\"collaborators/item/name\">Участники:</row>";
            sRows = sRows + "<row type=\"string\" field=\"state_name\">Мое участие:</row>";


            sData = sData + "<element>";
            sData = sData + "<eid>" + oElem.id + "</eid>";
            sData = sData + "<code>" + Validate(oElem.code) + "</code>";
            sData = sData + "<name>" + Validate(oElem.name) + "</name>";
            sData = sData + "<type_id>" + Validate(oElem.type_id) + "</type_id>";
            try
            {
                sData = sData + "<type_name>" + Validate(oElem.type_id.ForeignElem.name) + "</type_name>";
            }
            catch(e)
            {
                sData = sData + "<type_name>" + sObjectDeleted + "</type_name>";
            }
            sData = sData + "<start_date>" + StrDate(oElem.start_date) + "</start_date>";
            sData = sData + "<finish_date>" + StrDate(oElem.finish_date) + "</finish_date>";
		    sData = sData + "<status_id>" + oElem.status_id + "</status_id>";
		    try
		    {
		        sData = sData + "<status_name>" + Validate(curLngCommon.event_status_types.GetChildByKey( oElem.status_id ).name) + "</status_name>";
		    }
		    catch(e)
		    {
		        sData = sData + "<status_name>" + sObjectDeleted + "</status_name>";
		    }
		    if(oElem.is_open)
		    {
		        sData = sData + "<is_open>да (возможна подача запроса на участие)</is_open>";
		    }
		    else
		    {
		        sData = sData + "<is_open>нет (участники определяются только администратором)</is_open>";
		    }
		    if(oElem.is_public)
		    {
		        sData = sData + "<is_public>да (показывается всем сотрудникам)</is_public>";
		    }
		    else
		    {
		        sData = sData + "<is_public>нет (показывается только допущенным сотрудникам)</is_public>";
		    }

            if(bCompoundProgram)
            {
                sData = sData + "<compound_program_id>" + oElem.compound_program_id + "</compound_program_id>";
                try
                {
                    sData = sData + "<compound_program_name>" + Validate(oElem.compound_program_id.ForeignElem.name) + "</compound_program_name>";
                }
                catch(e)
                {
                    sData = sData + "<compound_program_name>" + sObjectDeleted + "</compound_program_name>";
                }
            }
            if(bEducationProgram)
            {
                sData = sData + "<education_program_id>" + oElem.education_program_id + "</education_program_id>";
                try
                {
                    sData = sData + "<education_program_name>" + Validate(oElem.education_program_id.ForeignElem.name) + "</education_program_name>";
                }
                catch(e)
                {
                    sData = sData + "<education_program_name>" + sObjectDeleted + "</education_program_name>";
                }
            }
            if(bEducationMethod)
            {
                sData = sData + "<education_method_id>" + oElem.education_method_id + "</education_method_id>";
                try
                {
                    sData = sData + "<education_method_name>" + Validate(oElem.education_method_id.ForeignElem.name) + "</education_method_name>";
                }
                catch(e)
                {
                    sData = sData + "<education_method_name>" + sObjectDeleted + "</education_method_name>";
                }
            }
            if(bEducationOrg)
            {
                sData = sData + "<education_org_id>" + oElem.education_org_id + "</education_org_id>";
                try
                {
                    sData = sData + "<education_org_name>" + Validate(oElem.education_org_id.ForeignElem.name) + "</education_org_name>";
                }
                catch(e)
                {
                    sData = sData + "<education_org_name>" + sObjectDeleted + "</education_org_name>";
                }
            }

            if(ArrayOptFirstElem(aPreparators) != undefined)
            {
                sData = sData + "<preparators isarray=\"1\">";
                for (oPreparator in aPreparators)
                {
                    sData = sData + "<item>";
                    sData = sData + "<id>" + oPreparator.person_id + "</id>";
                    sData = sData + "<name>" + oPreparator.person_fullname + "</name>";
                    sData = sData + "</item>";
                }
                sData = sData + "</preparators>";
            }

            if(ArrayOptFirstElem(aTutors) != undefined)
            {
                sData = sData + "<tutors isarray=\"1\">";
                for (oTutor in aTutors)
                {
                    sData = sData + "<item>";
                    sData = sData + "<id>" + oTutor.collaborator_id + "</id>";
                    sData = sData + "<name>" + oTutor.person_fullname + "</name>";
                    sData = sData + "</item>";
                }
                sData = sData + "</tutors>";
            }

            if(ArrayOptFirstElem(aCollaborators) != undefined)
            {
                sData = sData + "<collaborators isarray=\"1\">";
                for (oCollaborator in aCollaborators)
                {
                    sData = sData + "<item>";
                    sData = sData + "<id>" + oCollaborator.collaborator_id + "</id>";
                    sData = sData + "<name>" + oCollaborator.person_fullname + "</name>";
                    sData = sData + "</item>";
                }
                sData = sData + "</collaborators>";
            }

            sData = sData + "<state_id>" + sState + "</state_id>";
            if(oElem.is_open && sState=="0")
            {
                sActions = sActions + "<item id=\"request\">";
                sActions = sActions + "<name>Создать запрос</name>";
                sActions = sActions + "<url>layout=list&amp;object_type=request&amp;state=active&amp;filter=all&amp;person=me&amp;menu=my_active_requests&amp;action=request&amp;eid=" + oElem.id + "</url>";
                sRows = sRows + "<row type=\"action\" control=\"button\">request</row>";
                sActions = sActions + "</item>";
            }

            switch(sState)
            {
                case "0":
                    sState = "Не участвую";
                    break;
                case "1":
                    sState = "В числе участвующих";
                    break;
                case "2":
                    sState = "Подан запрос на участие";
                    break;
            }
            sData = sData + "<state_name>" + sState + "</state_name>";

            break;

        case "course":
            aFullList = XQuery( "for $elem in courses where $elem/id = " + iEId + " return $elem" );
            oElem = ArrayFirstElem(aFullList);
            aActiveList = XQuery( "for $elem in active_learnings where $elem/person_id = " + curUserID.XQueryLiteral + " and $elem/course_id = " + iEId + " return $elem" );
            aArchiveList = XQuery( "for $elem in learnings where $elem/person_id = " + curUserID.XQueryLiteral + " and $elem/course_id = " + iEId + " return $elem" );
	        aRequests = XQuery (" for $elem in requests where $elem/object_id = " + oElem.id + " and $elem/person_id = " + curUserID.XQueryLiteral + " and $elem/status_id = 'active' return $elem ");
        	oDoc = OpenDoc( UrlFromDocID( iEId ) ).TopElem;

            sCard = sCard + "<pagename>" + Validate(oElem.code) + " " + Validate(oElem.name) + "</pagename>";

            sFields = sFields + "<field type=\"id\">eid</field>";
            sFields = sFields + "<field type=\"string\">course_code</field>";
            sFields = sFields + "<field type=\"string\">course_name</field>";
            sFields = sFields + "<field type=\"string\">self_enroll</field>";
            sFields = sFields + "<field type=\"number\">state_id</field>";
            sFields = sFields + "<field type=\"string\">state_name</field>";
            if(oDoc.desc != "") sFields = sFields + "<field type=\"string\">description</field>";

            sRows = sRows + "<row type=\"string\" field=\"course_code\">Код:</row>";
            sRows = sRows + "<row type=\"string\" field=\"course_name\">Наименование:</row>";
        	if(oDoc.desc != "") sRows = sRows + "<row type=\"string\" field=\"description\">Подробное описание:</row>";
            sRows = sRows + "<row type=\"string\" field=\"state_name\">Статус:</row>";
            sRows = sRows + "<row type=\"string\" field=\"self_enroll_name\">Самостоятельная активация:</row>";

            sData = sData + "<element>";
            sData = sData + "<eid>" + oElem.id + "</eid>";
            sData = sData + "<course_code>" + Validate(oElem.code) + "</course_code>";
            sData = sData + "<course_name>" + Validate(oElem.name) + "</course_name>";
            sData = sData + "<self_enroll>" + Validate(oElem.yourself_start) + "</self_enroll>";
            if(oElem.yourself_start)
            {
                sData = sData + "<self_enroll_name>Разрешена</self_enroll_name>";
            }
            else
            {
                sData = sData + "<self_enroll_name>Запрещена</self_enroll_name>";
            }
            if(oDoc.desc != "")
            {
                sData = sData + "<description>Открыть</description>";
            }

	        sState = "0";
	        sStateName = ""

	        if(ArrayOptFirstElem(aActiveList) != undefined)
	        {
	            sState = "1";
	            sStateName = "Активирован";
	        }
	        if(ArrayOptFirstElem(aRequests) != undefined && sState != "1")
	        {
	            sState = "2";
	            sStateName = "Запрос принят";
	        }
	        if(ArrayOptFirstElem(aArchiveList) != undefined && sState == "0")
	        {
	            sState = "3";
	            sStateName = "В архиве";
            }
            sData = sData + "<state_id>" + sState + "</state_id>";
            sData = sData + "<state_name>" + sStateName + "</state_name>";


            if(sState=="0" || sState=="3")
            {
                if(oElem.yourself_start)
                {
                    sActions = sActions + "<item id=\"activate\">";
                    sActions = sActions + "<name>Активировать</name>";
                    sActions = sActions + "<url>layout=list&amp;object_type=course&amp;state=active&amp;filter=all&amp;person=me&amp;menu=my_active_courses&amp;action=activate&amp;eid=" + oElem.id + "</url>";
                    sRows = sRows + "<row type=\"action\" control=\"button\">activate</row>";
                }
                else
                {
                    aRequestTypes = XQuery (" for $elem in request_types where $elem/code = 'request_course' return $elem ");
                    oRType = ArrayFirstElem( aElements );
                    sReqTypeId = oRType.id;

                    sData = sData + "<comment><![CDATA[<textarea name='comment' class='wsTextArea'></textarea>]]></comment>";
                    sRows = sRows + "<row type=\"html\" field=\"comment\">Комментарий:</row>";
                    sActions = sActions + "<item id=\"request\" type=\"javascript\">";
                    sActions = sActions + "<name>Создать запрос</name>";
                    sActions = sActions + "<url>DoSubmit('layout=list&amp;object_type=request&amp;state=active&amp;filter=all&amp;person=me&amp;menu=my_active_requests&amp;action=request&amp;eid=" + oElem.id + "','request', '"+ sEId + "', '" + sEId + "', '" + sReqTypeId + "');</url>";
                    sRows = sRows + "<row type=\"action\" control=\"button\">request</row>";
                }
                sActions = sActions + "</item>";
            }
            sData = sData + "</element>";

//       	sCard = sCard + oElem.Xml;
//          sCard = sCard + tools_web.get_web_desc( oElem.desc, UrlFromDocID( iEId ), 'course.desc' );
            break;

        case "test":

            aElements = XQuery( "for $elem in assessments where $elem/id = " + sEId + " return $elem" );
            oElem = ArrayFirstElem( aElements );
            aActiveList = XQuery( "for $elem in active_test_learnings where $elem/person_id = " + curUserID.XQueryLiteral + " and $elem/assessment_id = " + iEId + " return $elem" );
            aArchiveList = XQuery( "for $elem in test_learnings where $elem/person_id = " + curUserID.XQueryLiteral + " and $elem/assessment_id = " + iEId + " return $elem" );
	        aRequests = XQuery (" for $elem in requests where $elem/object_id = " + oElem.id + " and $elem/person_id = " + curUserID.XQueryLiteral + " and $elem/status_id = 'active' return $elem ");

        	oDoc = OpenDoc( UrlFromDocID( iEId ) ).TopElem;

        	try
        	{
        	    bOpen = oDoc.is_open;
        	}
        	catch(e)
        	{
        	    bOpen = false;
        	}

            sCard = sCard + "<pagename>" + Validate(oElem.code) + " " + Validate(oElem.title) + "</pagename>";

            sFields = sFields + "<field type=\"id\">eid</field>";
            sFields = sFields + "<field type=\"string\">test_code</field>";
            sFields = sFields + "<field type=\"string\">test_name</field>";
            sFields = sFields + "<field type=\"number\">state_id</field>";
            sFields = sFields + "<field type=\"string\">state_name</field>";

            sRows = sRows + "<row type=\"string\" field=\"test_code\">Код:</row>";
            sRows = sRows + "<row type=\"string\" field=\"test_name\">Наименование:</row>";
            sRows = sRows + "<row type=\"string\" field=\"state_name\">Статус:</row>";

            sData = sData + "<element>";
            sData = sData + "<eid>" + oElem.id + "</eid>";
            sData = sData + "<test_code>" + Validate(oElem.code) + "</test_code>";
            sData = sData + "<test_name>" + Validate(oElem.title) + "</test_name>";

	        sState = "0";
	        sStateName = ""

	        if(ArrayOptFirstElem(aActiveList) != undefined)
	        {
	            sState = "1";
	            sStateName = "Активирован";
	        }
	        if(ArrayOptFirstElem(aRequests) != undefined && sState != "1")
	        {
	            sState = "2";
	            sStateName = "Запрос принят";
	        }
	        if(ArrayOptFirstElem(aArchiveList) != undefined && sState == "0")
			{
	            sState = "3";
	            sStateName = "В архиве";
            }
            sData = sData + "<state_id>" + sState + "</state_id>";
            sData = sData + "<state_name>" + sStateName + "</state_name>";

            if(sState=="0" || sState=="3")
            {
                if(bOpen)
                {
                    sActions = sActions + "<item id=\"activate\">";
                    sActions = sActions + "<name>Активировать</name>";
                    sActions = sActions + "<url>layout=list&amp;object_type=test&amp;state=active&amp;filter=all&amp;person=me&amp;menu=my_active_tests&amp;action=activate&amp;eid=" + oElem.id + "</url>";
                    sRows = sRows + "<row type=\"action\" control=\"button\">activate</row>";
                    sActions = sActions + "</item>";
               }
                else
                {
                    sData = sData + "<comment><![CDATA[<textarea name='comment' class='wsTextArea'></textarea>]]></comment>";
                    sRows = sRows + "<row type=\"html\" field=\"comment\">Комментарий:</row>";
                    sActions = sActions + "<item id=\"request\">";
                    sActions = sActions + "<name>Создать запрос</name>";
                    sActions = sActions + "<url>layout=list&amp;object_type=request&amp;state=active&amp;filter=all&amp;person=me&amp;menu=my_active_requests&amp;action=request&amp;eid=" + oElem.id + "</url>";
                    sRows = sRows + "<row type=\"action\" control=\"button\">request</row>";
                    sActions = sActions + "</item>";
                }
            }
            sData = sData + "</element>";

//       	sCard = sCard + oElem.Xml;
//          sCard = sCard + tools_web.get_web_desc( oElem.desc, UrlFromDocID( iEId ), 'course.desc' );
            break;
    }

    sData = sData + "</data>";
    sRows = sRows + "</rows>";
    sFields = sFields + "</fields>";
    sActions = sActions + "</actions>";
    sError = sError + "</error>";

    return sCard + sRows + sData + sFields + sActions + sError;
}

function Activate()
{
    switch(sObjectType)
    {
        case "test":

	            try
	            {
		            _assessment_id = iEId;
	            }
	            catch ( e )
	            {
		            _assessment_id = Int( sEId );
	            }

	            assessmentDoc = OpenDoc( UrlFromDocID( _assessment_id ) ).TopElem;


	            doc = OpenNewDoc( 'x-local://wtv/wtv_active_test_learning.xmd' );
	            doc.TopElem.person_id = curUserID;
	            doc.TopElem.assessment_id = _assessment_id;
	            doc.TopElem.start_usage_date = Date();
	            tools.common_filling( 'collaborator', doc.TopElem, curUserID, curUser );
	            tools.common_filling( 'assessment', doc.TopElem, _assessment_id, assessmentDoc );

	            if (assessmentDoc.external_type.HasValue) // * BBT *
	            {
		            tools.test_external_type_filling( doc.TopElem, _assessment_id, assessmentDoc );
	            }



	            doc.BindToDb( DefaultDb );
	            doc.Save();
	            break;
            case "course":
                try
                {
                    _course_id = iEId;
                }
                catch ( e )
                {
                    _course_id = Int( sEId );
                }

                try
                {
                    try
                    {
                        curSid = sEId;
                    }
                    catch ( asd )
                    {

                    }

        /*		                if ( ! curAccess ||  ! tools.check_sum_sid( _course_id, curSid ) )
                        throw '_crack_fuck_';

                    if ( ! tools_web.check_access( courseDoc, curUserID, curUser, Session ) )
                        throw '_access_fuck_';*/
                }
                catch ( ehuu )
                {
        //		                Cancel();
                }

                tools.activate_course_to_person( curUserID, _course_id, null, curUser );
                break;
        default: break;
    }

}

function CreatePage()
{
    _response_text.AppendStr( "<page>" );
    _response_text.AppendStr( "<object_type>" + sObjectType + "</object_type>" );
    _response_text.AppendStr( "<state>" + sState + "</state>" );
    _response_text.AppendStr( "<filter>" + sFilter + "</filter>" );
    _response_text.AppendStr( "<person>" + sPerson + "</person>" );

    sArchivePage = "all";
    if(sObjectType == "test") sArchivePage = "test";
    if(sObjectType == "event") sArchivePage = "event";
    if(sAction!="")
    {
        switch(sAction)
        {
            case "activate":
                Activate();
                break;
            case "request":
                break;
        }

    }
//alert(sAction);
    switch(sLayout)
    {
        case "list":
            _response_text.AppendStr( "<layout>" + sLayout + "</layout>" );
            _response_text.AppendStr( "<list>" + List() + "</list>" );

            break;
        case "summary":
            _response_text.AppendStr( "<layout>" + sLayout + "</layout>" );
            _response_text.AppendStr( "<summary>" + Summary() + "</summary>" );
            break;
        case "multilist":
            _response_text.AppendStr( "<layout>" + sLayout + "</layout>" );
            _response_text.AppendStr( "<lists>" + Multilist() + "</lists>" );
            break;
        case "launch":
            try
            {
                _response_text.AppendStr( "<card>" + Launch() + "</card>" );
                _response_text.AppendStr( "<layout>" + sLayout + "</layout>" );
            }
            catch(e)
            {
                _response_text.AppendStr( "<layout>redirect</layout>" );
                _response_text.AppendStr( "<redirect>layout=multilist&amp;object_type=" + sArchivePage + "&amp;state=archive&amp;filter=none&amp;person=me&amp;menu=my_archive_all</redirect>" );
            }
            break;
        case "review":
            _response_text.AppendStr( "<layout>" + sLayout + "</layout>" );
            _response_text.AppendStr( "<card>" + Review() + "</card>" );
            break;
        case "card":
            _response_text.AppendStr( "<layout>" + sLayout + "</layout>" );
            _response_text.AppendStr( "<card>" + Card() + "</card>" );
            break;
        case "form":
            _response_text.AppendStr( "<layout>" + sLayout + "</layout>" );
            _response_text.AppendStr( "<card>" + Form() + "</card>" );
            break;
        case "ack":
            _response_text.AppendStr( "<layout>" + sLayout + "</layout>" );
            _response_text.AppendStr( "<card>" + Acknowledge() + "</card>" );
            break;
    }


    _response_text.AppendStr( "</page>" );
}

function CreateUserInfo()
{
_response_text.AppendStr("<user>");
	_response_text.AppendStr("<personal>");
	    _response_text.AppendStr("<full_name>" + Validate(curUser.fullname) + "</full_name>");
	    _response_text.AppendStr("<last_name>" + Validate(curUser.lastname) + "</last_name>");
	    _response_text.AppendStr("<first_name>" + Validate(curUser.firstname) + "</first_name>");
	    _response_text.AppendStr("<middle_name>" + Validate(curUser.middlename) + "</middle_name>");
	    _response_text.AppendStr("<sex>" + Validate(curUser.sex) + "</sex>");
	    _response_text.AppendStr("<birth_date>" + Validate(curUser.birth_date) + "</birth_date>");
	_response_text.AppendStr("</personal>");

	_response_text.AppendStr("<access>");
   	    _response_text.AppendStr("<access_level>" + Validate(curUser.access.access_level) + "</access_level>");
   	    _response_text.AppendStr("<role_id>" + Validate(curUser.access.access_role) + "</role_id>");
   	    sRoleId = Validate(curUser.access.access_role);
   	    _response_text.AppendStr("<role_name>" + ( curUser.access.access_role.HasValue ? curUser.access.access_role.ForeignElem.name : "" ) + "</role_name>");
   	    _response_text.AppendStr("<group_id>" + Validate(curUser.access.user_group_id) + "</group_id>");
   	    _response_text.AppendStr("<group_name>" + ( curUser.access.user_group_id.HasValue ? curUser.access.user_group_id.ForeignElem.name : "" ) + "</group_name>");
   	    _response_text.AppendStr("<is_arm_admin>" + Validate(curUser.access.is_arm_admin) + "</is_arm_admin>");
   	    _response_text.AppendStr("<web_banned>" + Validate(curUser.access.web_banned) + "</web_banned>");
	_response_text.AppendStr("</access>");

	_response_text.AppendStr("<position>");
	    _response_text.AppendStr("<org_id>" + Validate(curUser.org_id) + "</org_id>");
	    sOrgId = Validate(curUser.org_id);
	    _response_text.AppendStr("<org_name>" + ( curUser.org_id.HasValue ? curUser.org_id.ForeignElem.name : "" ) + "</org_name>");
	    _response_text.AppendStr("<position_id>" + Validate(curUser.position_id) + "</position_id>");
	    try
	    {
	        bBoss = Validate(curUser.position_id.ForeignElem.is_boss);
	        _response_text.AppendStr("<is_boss>" + Validate(curUser.position_id.ForeignElem.is_boss) + "</is_boss>");
	    }
	    catch(e) {}

	    _response_text.AppendStr("<position_name>" + Validate(curUser.position_name) + "</position_name>");
	    _response_text.AppendStr("<position_parent_id>" + Validate(curUser.position_parent_id) + "</position_parent_id>");
	    _response_text.AppendStr("<position_parent_name>" + ( curUser.position_parent_id.HasValue ? curUser.position_parent_id.ForeignElem.name : "" ) + "</position_parent_name>");
   	    _response_text.AppendStr("<is_candidate>" + Validate(curUser.is_candidate) + "</is_candidate>");
   	    _response_text.AppendStr("<is_dismiss>" + Validate(curUser.is_dismiss) + "</is_dismiss>");
	_response_text.AppendStr("</position>");
_response_text.AppendStr("</user>");
}

    bBoss = false;
    sRoleId = "";
    sOrgId = "";

    CreateUserInfo();
    CreateMenu();
    CreatePage();




	if(_error==0) _response_text.AppendStr( "<error><error_code>0</error_code><error_description>No error</error_description></error>" );
	_response_text.AppendStr( "</response>" );

	Response.WriteBinary( _response_text );
%>
