<%
//alert(Request.Url);
	Response.WriteMode = 'single';
	
//	Server.Execute( "include/user_init.html" );
//	curUserID = 6148914691236517121;
//	curUser = OpenDoc( UrlFromDocID( curUserID ) ).TopElem;
	
	curCommand = String( Request.QueryString.command ).toLowerCase();

	_response_text = new Binary;
	_response_text.AssignStr( '<?xml version="1.0" encoding="utf-8"?>' );

//alert( 'curUser = ' + curUser.login )

	switch ( curCommand )
	{
		case 'get_structure':
alert('get_structure')
			_root_id = null;
			try
			{
				if ( Request.QueryString.HasProperty( 'root_id' ) && Request.QueryString.root_id != '' )
					_root_id = Int( Request.QueryString.root_id );
					
				rootDoc = OpenDoc( UrlFromDocID( _root_id ) ).TopElem;
			}
			catch ( ee )
			{
				Response.Write( 'ERROR=701' );
				Cancel();
			}
			
			_depth = 100;
			try
			{
				if ( Request.QueryString.HasProperty( 'depth' ) && Request.QueryString.depth != '' )
				{
					_depth = Int( Request.QueryString.depth );
					if ( _depth < 1 )
						throw 'bad depth';
				}
			}
			catch ( ee )
			{
				Response.Write( 'ERROR=703\nERRORTEXT=Invalid DEPTH' );
				Cancel();
			}
			
			_selection = 'all';
			if ( Request.QueryString.HasProperty( 'selection' ) )
				_selection = ( Request.QueryString.selection == '0' ? 'sub' : 'all' );
			
			_has_width = false	
			if ( Request.QueryString.HasProperty( 'has_width' ) )
				_has_width = ( Request.QueryString.has_width == '1' );
			
			_width = 0;	
			if ( _has_width )
			{
				if ( rootDoc.Name == 'org' )
					_width = ArrayCount( XQuery( "for $elem in collaborators where $elem/org_id = " + _root_id + " return $elem" ) );
					
				if ( rootDoc.Name == 'subdivision' )
					_width = ArrayCount( ArraySelect( XQuery( "CatalogHierSubset('subs'," + _root_id + ")" ), 'basic_collaborator_id.HasValue' ) );
					//_width = ArrayCount( XQuery( "for $elem in positions where $elem/parent_object_id = " + _root_id + " and $elem/basic_collaborator_id != null() return $elem" ) );
			}

			if ( rootDoc.Name == 'org' )
				_response_text.AppendStr( '<nodes id="' + _root_id + '" name="' + XmlAttrEncode(  rootDoc.disp_name ) + '" parent_id="" type="2"' + ( _has_width ? ' width="' + _width + '"' : '' ) + '>' );
			else
				_response_text.AppendStr( '<nodes id="' + _root_id + '" name="' +  XmlAttrEncode(  rootDoc.name ) + '" parent_id="' + ( rootDoc.parent_object_id.HasValue ? rootDoc.parent_object_id : rootDoc.org_id ) + ( rootDoc.Name == 'position' ? '" type="1" is_boss="'+ListElem.is_boss+'" fullname="' + XmlAttrEncode( rootDoc.basic_collaborator_id.sd.fullname ) + '">' : '" type="0"' + ( _has_width ? ' width="' + _width + '">' : '>' ) ) );

			_cur_array = XQuery( "for $elem in subs where $elem/parent_id = " + _root_id + ( _selection != "all" ? " and $elem/type != 'position'" : "" ) + " return $elem" );
			_stop_counter = 0;
			while ( _stop_counter < _depth && ArrayOptFirstElem( _cur_array ) != undefined )
			{
				if ( _has_width )
				{
					for ( ListElem in _cur_array )
						if ( ListElem.type == 'position' )
						{
							_response_text.AppendStr( '<node id="' + ListElem.id + '" parent_id="' + ListElem.parent_id + '" name="' + HtmlEncode( ListElem.name ) + '" is_boss="'+ListElem.is_boss+'" fullname="' + HtmlEncode( ListElem.basic_collaborator_fullname ) + '" type="1"/>' );
						}
						else
						{
							//positionArray = XQuery( "for $elem in positions where $elem/parent_object_id = " + ListElem.id + " and $elem/basic_collaborator_id != null() return $elem" );
							positionArray = ArraySelect( XQuery( "CatalogHierSubset('subs'," + ListElem.id + ")" ), 'basic_collaborator_id.HasValue' );
							_response_text.AppendStr( '<node id="' + ListElem.id + '" parent_id="' + ListElem.parent_id + '" name="' + HtmlEncode( ListElem.name ) + '" width="' + ArrayCount( positionArray ) + '" type="0"/>' );
						}
				}
				else
				{
					for ( ListElem in _cur_array )
						_response_text.AppendStr( '<node id="' + ListElem.id + '" parent_id="' + ListElem.parent_id + '" name="' + HtmlEncode( ListElem.name ) + '"' + ( ListElem.type == 'position' ? ' is_boss="'+ListElem.is_boss+'" fullname="' + HtmlEncode( ListElem.basic_collaborator_fullname ) + '" type="1"/>' : ' type="0"/>' ) );
				}
			
				_ext_array = ArrayExtract( _cur_array, 'id' );
				_cur_array = QueryCatalogByKeys( 'subs', 'parent_id', _ext_array );
				if ( _selection != "all" )
					_cur_array  = ArraySelect( _cur_array, "type != 'position'" );
					
				_stop_counter++;
			}

			_response_text.AppendStr( '</nodes>' );
			break;
			
		case 'get_node_info':
			alert('get_node_info')
			try
			{ 		curNodeID=Request.QueryString.node_id; }
			catch (err)
			{
				Response.Write( 'ERROR! node_id is not defined' );
				Cancel();
			}
			try 
			{
				elemDoc=OpenDoc( UrlFromDocID( Int( curNodeID ) ) ).TopElem;			
			}
			catch (err)
			{
				Response.Write( 'ERROR! node_id is invalid' );
				Cancel();
			}
		
			
			if (elemDoc.Name=='org')
			{
				_response_text.AppendStr( '<dataset id="' + curNodeID + '" type="2">' );
				_response_text.AppendStr( '<name>'+elemDoc.name+'</name>');	
				_response_text.AppendStr( '<disp_name>'+elemDoc.disp_name+'</disp_name>');					
				_response_text.AppendStr( '</dataset>' );
			}
			else
			if (elemDoc.Name=='subdivision')
			{
				_response_text.AppendStr( '<dataset id="' + curNodeID + '" type="0">' );
				_response_text.AppendStr( '<name>'+elemDoc.name+'</name>');	
				_response_text.AppendStr( '<org>'+elemDoc.org_id.ForeignElem.disp_name+'</org>');	
				if (elemDoc.parent_object_id.HasValue)
					_response_text.AppendStr( '<parent_object>'+OpenDoc( UrlFromDocID( elemDoc.parent_object_id ) ).TopElem.name+'</parent_object>');
				else 
					_response_text.AppendStr( '<parent_object> </parent_object>');
				_response_text.AppendStr( '<subordinate_count>'+ArrayCount(tools.get_sub_person_ids_by_subdivision_id( curNodeID ))+'</subordinate_count>');

				bossPositionArray = XQuery( 'for $elem in positions where $elem/parent_object_id = ' + curNodeID + ' and $elem/is_boss = true() return $elem' );
				if ( ArrayCount(bossPositionArray)==0 )
					_response_text.AppendStr( '<boss> </boss>');
				else
					for (_boss_position in bossPositionArray)
					{
						bossPositionDoc=OpenDoc( UrlFromDocID( _boss_position.PrimaryKey ) ).TopElem;
						_response_text.AppendStr( '<boss>'+ OpenDoc( UrlFromDocID( bossPositionDoc.basic_collaborator_id ) ).TopElem.fullname+'</boss>');
						break;
					}
					
				_response_text.AppendStr( '</dataset>' );
				//_response_text.AppendStr( '<boss>'+tools.is_boss_by_subdivision_id( curNodeID )+'</boss>');
			}
			else
			if (elemDoc.Name=='collaborator')
			{
				_response_text.AppendStr( '<dataset id="' + curNodeID + '" type="1">' );
				_response_text.AppendStr( '<fullname> '+elemDoc.fullname+' </fullname>');
				_response_text.AppendStr( '<position>'+elemDoc.position_name+'</position>');
				try
				{
					_response_text.AppendStr( '<is_boss>'+elemDoc.position_id.ForeignElem.is_boss+'</is_boss>');
				}
				catch (err)
				{
					_response_text.AppendStr( '<is_boss> </is_boss>');
				}
				try
				{
					_response_text.AppendStr( '<subdivision>'+elemDoc.position_parent_id.ForeignElem.name +'</subdivision>');
				}
				catch (err)
				{
					_response_text.AppendStr( '<subdivision> </subdivision>');
				}

				_response_text.AppendStr( '<photo_url>'+elemDoc.pict_url+'</photo_url>');
				_response_text.AppendStr( '<hire_date>'+elemDoc.hire_date+'</hire_date>');
				_response_text.AppendStr( '<birth_date>'+elemDoc.birth_date+'</birth_date>');
				_response_text.AppendStr( '<email>'+elemDoc.email+'</email>');
				_response_text.AppendStr( '</dataset>' );
			}
			else
			{
				Response.Write( 'ERROR! node_id is not defined' );
				Cancel();
			}
			
			//_response_text.AppendStr( OpenDoc( UrlFromDocID( Int( Request.QueryString.node_id ) ) ).TopElem.Xml );
			
			break;
			
		case 'list_functions':
alert('list_functions')

			_response_text.AppendStr( '<functions>' );
//			filterArray = XQuery( "for $elem in filters order by $elem/section return $elem" );
			filterArray = ArraySort( lists.filters, 'section', '+' );
			_section_name = null;
			for ( _filter in filterArray )
				try
				{
					filterDoc = OpenDoc( UrlFromDocID( _filter.PrimaryKey ) ).TopElem;
					
					if ( _section_name != filterDoc.section )
					{
						if ( _section_name != null )
							_response_text.AppendStr( '</section>' );
							
						_response_text.AppendStr( '<section name="' + filterDoc.section + '">' );
						_section_name = filterDoc.section;
					}
					
					_response_text.AppendStr( '<function id="' + _filter.PrimaryKey + '" name="' + filterDoc.name + '" selection="1" min="0" max="10"/>' );
				}
				catch ( ee )
				{
				}
			
			if ( _section_name != null )
				_response_text.AppendStr( '</section>' );
				
			_response_text.AppendStr( '</functions>' );				
			break;
			
		case 'get_aggregate_data':
alert('get_aggregate_data')
			_root_id = null;
			try
			{
				if ( Request.QueryString.HasProperty( 'root_id' ) && Request.QueryString.root_id != '' )
					_root_id = Int( Request.QueryString.root_id );
					
				rootDoc = OpenDoc( UrlFromDocID( _root_id ) ).TopElem;
			}
			catch ( ee )
			{
				Response.Write( 'ERROR=701' );
				Cancel();
			}
			
			_depth = 100;
			try
			{
				if ( Request.QueryString.HasProperty( 'depth' ) && Request.QueryString.depth != '' )
				{
					_depth = Int( Request.QueryString.depth );
					if ( _depth < 1 )
						throw 'bad depth';
				}
			}
			catch ( ee )
			{
				Response.Write( 'ERROR=703\nERRORTEXT=Invalid DEPTH' );
				Cancel();
			}
			
			_selection = 'all';
			if ( Request.QueryString.HasProperty( 'selection' ) )
				_selection = ( Request.QueryString.selection == '0' ? 'sub' : 'all' );
			
			_has_width = true;
			_width = 0;	
			if ( _has_width )
			{
				if ( rootDoc.Name == 'org' )
					_width = ArrayCount( XQuery( "for $elem in collaborators where $elem/org_id = " + _root_id + " return $elem" ) );
					
				if ( rootDoc.Name == 'subdivision' )
					_width = ArrayCount( ArraySelect( XQuery( "CatalogHierSubset('subs'," + _root_id + ")" ), 'basic_collaborator_id.HasValue' ) );
					//_width = ArrayCount( XQuery( "for $elem in positions where $elem/parent_object_id = " + _root_id + " and $elem/basic_collaborator_id != null() return $elem" ) );
			}

			if ( rootDoc.Name == 'org' )
				_response_text.AppendStr( '<dataset id="' + _root_id + '" parent_id="" type="2"' + ( _has_width ? ' value="' + _width + '"' : '' ) + '>' );
			else
				_response_text.AppendStr( '<dataset id="' + _root_id + '" parent_id="' + ( rootDoc.parent_object_id.HasValue ? rootDoc.parent_object_id : rootDoc.org_id ) + ( rootDoc.Name == 'position' ? '" type="1">' : '" type="0"' + ( _has_width ? ' value="' + _width + '">' : '>' ) ) );

			_cur_array = XQuery( "for $elem in subs where $elem/parent_id = " + _root_id + ( _selection != "all" ? " and $elem/type != 'position'" : "" ) + " return $elem" );
			_stop_counter = 0;
			while ( _stop_counter < _depth && ArrayCount( _cur_array ) != 0 )
			{
				for ( ListElem in _cur_array )
				{
					//positionArray = XQuery( "for $elem in positions where $elem/parent_object_id = " + ListElem.id + " and $elem/basic_collaborator_id != null() return $elem" );
					positionArray = ArraySelect( XQuery( "CatalogHierSubset('subs'," + ListElem.id + ")" ), 'basic_collaborator_id.HasValue' );
					_response_text.AppendStr( '<data id="' + ListElem.id + '" value="' + ArrayCount( positionArray ) + '"/>' );
				}
			
				_ext_array = ArrayExtract( _cur_array, 'id' );
				_cur_array = QueryCatalogByKeys( 'subs', 'parent_id', _ext_array );
				if ( _selection != "all" )
					_cur_array  = ArraySelect( _cur_array, "type != 'position'" );
					
				_stop_counter++;
			}

			_response_text.AppendStr( '</dataset>' );
			break;
		
// Добавлено Таня Добрынина
		case 'list_person_in_node_id':
			curNodeID=String(Request.QueryString.node_id);
			personIdArray = tools.get_sub_person_ids_by_subdivision_id( curNodeID );
			_response_text.AppendStr( '<dataset>' );
			num=1;
			for (_personID in personIdArray)
			{
				personDoc = OpenDoc( UrlFromDocID( _personID ) ).TopElem;
				_response_text.AppendStr( '<person num="'+num+'" id="'+_personID.PrimaryKey+'" fullname="'+personDoc.fullname+'"/>' );
				num++;
			}
			_response_text.AppendStr( '</dataset>' );
			break;
		
		case 'get_fact':	
alert('get_fact')
		
			if ( Request.QueryString.HasProperty('fact_id') )	
				curFactID=Int(Request.QueryString.fact_id);
			else
			{
				Response.Write( 'ERROR! fact_id is not defined' );
				Cancel();
			}
			if ( Request.Query.HasProperty( "node_id" ) && Request.Query.node_id != "" )
			{
				curNodeID = Int( Request.Query.node_id );
			}
			else 
			{
				Response.Write( 'ERROR! node_id is not defined' );
				Cancel();
			}
			try 
			{
				nodeDoc=OpenDoc( UrlFromDocID( Int( curNodeID ) ) ).TopElem;
				if ( nodeDoc.Name == "position" && nodeDoc.basic_collaborator_id.HasValue)
				{
					curNodeID = nodeDoc.basic_collaborator_id;
					nodeDoc=OpenDoc( UrlFromDocID( Int( curNodeID ) ) ).TopElem;
				}
			}
			catch (err)
			{
				Response.Write( 'ERROR! node_id is invalid' );
				Cancel();
			}
			
			
//Получения факта из list_facts			
			try
			{
				curFact = lists.facts.GetChildByKey( curFactID );
			}
			catch(err)
			{
				Response.Write( 'ERROR! fact_id is invalid' );
				Cancel();
			}
//Получения факта из list_facts
			
			if (curFact.type == 1)
			{
//Определение xQuery-строки ПЕРИОДА
				_queryStringPeriod="";
				if (Request.QueryString.HasProperty( 'period_id' ))
				{
					curPeriodID = Int(Request.QueryString.period_id);
					try
					{
						periodDoc = OpenDoc( UrlFromDocID( curPeriodID ) ).TopElem;
						if ( curFact.columns.ChildByKeyExists('date_start') &&  periodDoc.start_date.HasValue )
						{
							colDateStart = curFact.columns.GetChildByKey('date_start');
							_queryStringPeriod = _queryStringPeriod + " and " + colDateStart.query_name + ">=" + periodDoc.start_date.XQueryLiteral;
						}
						if ( curFact.columns.ChildByKeyExists('date_end') &&  periodDoc.finish_date.HasValue)
						{
							colDateEnd = curFact.columns.GetChildByKey('date_end');
							_queryStringPeriod = _queryStringPeriod + " and " + colDateEnd.query_name + "<=" + periodDoc.finish_date.XQueryLiteral;
						}
					}
					catch ( ee )
					{
						Response.Write( 'ERROR! period_id is invalid' );
						Cancel();
					}	
				}
	//Определение xQuery-строки ПЕРИОДА
	
	//Определение элементов для получения фактов!
					personIdArray = ArraySelectDistinct( tools.get_sub_person_ids_by_subdivision_id( curNodeID ));
					if (ArrayCount( personIdArray )!=0)
					{
						Elems=Array();
						for (_personID in personIdArray)
						{
							try
							{
								personElems=XQuery ("for $elem in " + curFact.catalog + " where $elem/person_id=" + _personID + _queryStringPeriod + " return $elem");
								Elems=ArrayUnion(Elems,personElems);
							}
							catch(err)
							{
							}
						}
					}
					else 
					{
						try
						{
							Elems=XQuery("for $elem in " + curFact.catalog + " where $elem/person_id=" + curNodeID + _queryStringPeriod + " return $elem");
						}
						catch(err)
						{
						}
					}
	//Определение элементов для получения фактов!				
	
	//Вывод данных				
				_response_text.AppendStr( '<dataset node_id="'+curNodeID+'" fact_id="'+curFactID+( Request.QueryString.HasProperty( 'period_id' )? '" period_id="'+curPeriodID : '' )+'">');						
				num=1;
				total_value=0;
				count=0;
				for (_elem in Elems)
				{
					//elemDoc = OpenDoc( UrlFromDocID( _elem.PrimaryKey ) ).TopElem;
					_response_text.AppendStr( '<data num="'+num+'">');
						_response_text.AppendStr( '<fact_id>'+curFactID+'</fact_id>');
						for (_col in curFact.columns)
						{
							with (_elem)
							{
								try 
								{
									field = eval (_col.name);
								}
								catch (err)
								{
									field='Error! Object is removed';
								}
							}
							_response_text.AppendStr( '<'+_col.id+'>'+field+'</'+_col.id+'>');
							if ( _col.id == 'value' && field.HasValue) 
							{
								total_value=total_value+field;
								count++;
							}
						}
						_response_text.AppendStr( '<extra_columns>');
							for (_extra_col in curFact.extra_columns)	
							{
								with (_elem)
								{
									try 
									{
										field = eval (_extra_col.name);
									}
									catch (err)
									{
										field='Error! Object is removed';
									}
								}
								_response_text.AppendStr( '<extra_column id="'+_extra_col.id+'" value="'+field+'"/>');
							}
						_response_text.AppendStr( '</extra_columns>');
						
					_response_text.AppendStr( '</data>');
					num++;
					//if (elemDoc.score.HasValue) total_value=total_value+elemDoc.score;
				}
				_response_text.AppendStr( '<aggregate_dataset>');
					_response_text.AppendStr( '<aggregate_data id="1" name="Количество записей" value="'+ArrayCount(Elems)+'"/>');
					_response_text.AppendStr( '<aggregate_data id="2" name="Средний балл" value="'+( count==0 ? total_value : StrReal(Real( total_value/count),2 )  )+'"/>');
				_response_text.AppendStr( '</aggregate_dataset>' );
				_response_text.AppendStr( '</dataset>' );
			}
			
			if (curFact.type == 2)
			{			
				try
				{	
					_response_text.AppendStr( '<dataset node_id="'+curNodeID+'" fact_id="'+curFactID+'">');
					_response_text.AppendStr( '<data>');
						with (nodeDoc)
						{
							try 
							{
								field = eval (curFact.catalog);
							}
							catch (err)
							{
								field='Error! Object is removed';
							}
						}
						_response_text.AppendStr('<![CDATA['+field+']]>');
					_response_text.AppendStr( '</data>');
					_response_text.AppendStr( '</dataset>');
				}
				catch (err)
				{
					Response.Write( 'ERROR! node_id is invalid' );
					Cancel();
				}
			}
			break;	
		
		case 'list_facts':	
alert('list_facts')
			//_response_text.AppendStr( lists.facts.Xml );
			_response_text.AppendStr('<facts>');
			for ( _fact in lists.facts )
			{
				_response_text.AppendStr('<fact>');
				_response_text.AppendStr('<id>'+_fact.id+'</id>');
				_response_text.AppendStr('<name>'+_fact.name+'</name>');
				_response_text.AppendStr('<type>'+_fact.type+'</type>');								
				_response_text.AppendStr('<extra_columns>');
					for (_extra_col in _fact.extra_columns)
					{
						_response_text.AppendStr('<extra_column id="'+_extra_col.id+'" name="'+_extra_col.title+'"/>');
					}
				_response_text.AppendStr('</extra_columns>');				
				_response_text.AppendStr('</fact>');				
			}
			_response_text.AppendStr('</facts>');
			break;	
		
		case 'list_periods':
alert('list_periods')			
			_response_text.AppendStr( '<periods>' );
			Elems=XQuery("for $elem in budget_periods return $elem");
			for (_elem in Elems)
			{
				elemDoc=OpenDoc( UrlFromDocID( _elem.PrimaryKey ) ).TopElem;
				_response_text.AppendStr( '<period id="'+_elem.PrimaryKey+'" name="'+elemDoc.name+'" start_date="'+elemDoc.start_date+'" end_date="'+elemDoc.finish_date+'"/>' );
			}
			_response_text.AppendStr( '</periods>' );
			break;
		
		case 'period_info':
alert('period_info')		
			_response_text.AppendStr( OpenDoc( UrlFromDocID( Int( Request.QueryString.period_id ) ) ).TopElem.Xml );
			break;
			
						
// Добавлено Таня Добрынина

		default:
			_error = 701;				
			throw 'unknown command';
	}
//alert(_response_text.GetStr())	
	Response.Write( EncodeCharset( _response_text.GetStr(), 'utf-8' ) );
	Cancel();
%>